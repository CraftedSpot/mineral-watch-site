        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Check for credit pack purchase success
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('purchase') === 'success') {
                    // Remove the query parameter from URL without reload
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, '', newUrl);
                    // Show success toast after a brief delay to ensure DOM is ready
                    setTimeout(() => {
                        showToast('Credit pack purchased successfully! Credits have been added to your account.', 'success', 6000);
                    }, 500);
                }

                const res = await fetch('/api/auth/me');
                if (!res.ok) { window.location.href = '/portal/login'; return; }
                currentUser = await res.json();
                document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                document.getElementById('planBadge').textContent = currentUser.plan || 'FREE';
                const limits = planConfigs[currentUser.plan] || { properties: 1, wells: 0 };
                document.getElementById('propLimit').textContent = limits.properties === Infinity ? '∞' : limits.properties;
                document.getElementById('wellLimit').textContent = limits.wells === Infinity ? '∞' : limits.wells;
                
                // Hide upgrade link for Business/Enterprise users
                if (currentUser.plan === 'Enterprise' || currentUser.plan === 'Business') {
                    document.getElementById('upgradeLink').style.display = 'none';
                }

                // Show export buttons for Professional+ users
                if (currentUser.plan === 'Professional' || currentUser.plan === 'Business' || currentUser.plan === 'Enterprise') {
                    document.getElementById('exportPropertiesBtn').style.display = 'inline-flex';
                    document.getElementById('exportWellsBtn').style.display = 'inline-flex';
                }

                // Show Find Matches button for all users
                document.getElementById('findMatchesBtn').style.display = 'inline-flex';

                // Show Documents tab for all users
                console.log('Showing documents tab for all users');
                document.getElementById('documentsTab').style.display = 'flex';
                // Also show document count in plan info
                if (document.getElementById('docCountItem')) {
                    document.getElementById('docCountItem').style.display = 'flex';
                    document.getElementById('docCountDisplay').style.display = 'flex';
                }

                // Show mobile photo upload section only on mobile devices
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    // Show prominent photo upload section above search bar
                    const mobilePhotoSection = document.getElementById('mobilePhotoUploadSection');
                    if (mobilePhotoSection) {
                        mobilePhotoSection.style.display = 'block';
                    }
                }
                
                // Hide add/edit/delete buttons for Viewers
                if (currentUser.role === 'Viewer') {
                    // Hide property add/import buttons
                    const addPropertyBtn = document.getElementById('addPropertyBtn');
                    const bulkUploadBtn = document.getElementById('bulkUploadBtn');
                    if (addPropertyBtn) addPropertyBtn.style.display = 'none';
                    if (bulkUploadBtn) bulkUploadBtn.style.display = 'none';

                    // Hide well add/import buttons
                    const addWellBtn = document.getElementById('addWellBtn');
                    const bulkUploadWellsBtn = document.getElementById('bulkUploadWellsBtn');
                    if (addWellBtn) addWellBtn.style.display = 'none';
                    if (bulkUploadWellsBtn) bulkUploadWellsBtn.style.display = 'none';

                    // Hide bulk action bars (delete buttons)
                    const propertiesBulkActionBar = document.getElementById('propertiesBulkActionBar');
                    const wellsBulkActionBar = document.getElementById('wellsBulkActionBar');
                    const activityBulkActionBar = document.getElementById('activityBulkActionBar');
                    if (propertiesBulkActionBar) propertiesBulkActionBar.style.display = 'none';
                    if (wellsBulkActionBar) wellsBulkActionBar.style.display = 'none';
                    if (activityBulkActionBar) activityBulkActionBar.style.display = 'none';

                    // Hide the dividers between action groups when buttons are hidden
                    document.querySelectorAll('.action-divider').forEach(d => d.style.display = 'none');
                }
                
                await loadAllData();

                // Initialize search/sort controls
                initWellsControls();
                initPropertiesControls();
                initDocumentsControls();
            } catch (err) { console.error('Dashboard init error:', err); window.location.href = '/portal/login'; }

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentTab = tab.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(currentTab + '-tab').classList.add('active');
                    
                    // Load activity data when tab is selected (lazy load)
                    if (currentTab === 'activity') {
                        loadActivity();
                    }
                    // Load documents data when tab is selected (lazy load)
                    if (currentTab === 'documents') {
                        loadDocuments();
                    } else {
                        // Stop polling when leaving documents tab
                        stopDocumentPolling();
                    }
                });
            });
            
            // Tab Visibility API - Auto-refresh when returning to tab
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden && currentTab === 'documents') {
                    // User returned to tab while on documents
                    const hasProcessing = loadedDocuments.some(doc => 
                        doc.status === 'processing' || doc.status === 'pending'
                    );
                    if (hasProcessing) {
                        console.log('[Documents] Tab became visible with processing documents, refreshing...');
                        await loadDocuments();
                    }
                }
            });
            
            // Bulk selection event listeners
            document.addEventListener('change', (e) => {
                // Handle select all checkboxes
                if (e.target.id === 'selectAllProperties') {
                    selectAllItems('properties', e.target.checked);
                } else if (e.target.id === 'selectAllWells') {
                    selectAllItems('wells', e.target.checked);
                }
                // Handle individual checkboxes
                else if (e.target.classList.contains('property-checkbox')) {
                    togglePropertySelection(e.target.dataset.id, e.target.checked);
                } else if (e.target.classList.contains('well-checkbox')) {
                    toggleWellSelection(e.target.dataset.id, e.target.checked);
                } else if (e.target.classList.contains('document-checkbox')) {
                    toggleDocumentSelection(e.target.dataset.id, e.target.checked);
                }
            });
            
            // Add button event listeners inside DOMContentLoaded
            // Well Modal
            document.getElementById('addWellBtn').addEventListener('click', () => { 
                document.getElementById('addWellModal').style.display = 'flex'; 
            });
            
            // Bulk Upload Properties Modal
            const bulkUploadBtn = document.getElementById('bulkUploadBtn');
            console.log('Bulk upload button:', bulkUploadBtn);
            if (bulkUploadBtn) {
                bulkUploadBtn.addEventListener('click', () => {
                    console.log('Import button clicked');
                    openBulkUploadModal();
                });
            } else {
                console.error('Bulk upload button not found!');
            }
            
            // Bulk Upload Wells Modal
            document.getElementById('bulkUploadWellsBtn').addEventListener('click', () => {
                openBulkUploadWellsModal();
            });
            
            // Add Well Modal event listeners
            document.getElementById('addWellModal').addEventListener('click', e => { 
                if (e.target.id === 'addWellModal') closeWellModal(); 
            });
            
            document.getElementById('addWellForm').addEventListener('submit', async e => {
                e.preventDefault();
                const data = { 
                    apiNumber: document.getElementById('apiNumber').value.trim(),
                    notes: document.getElementById('wellNotes').value.trim()
                };
                
                try {
                    document.querySelector('.btn-submit').disabled = true;
                    const res = await fetch('/api/wells/track', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || 'Failed to add well');
                    }
                    
                    const result = await res.json();
                    closeWellModal();
                    showToast('Well added successfully');
                    loadWells();
                    loadActivityStats();
                } catch (err) {
                    showToast('Error: ' + err.message, 'error');
                } finally {
                    document.querySelector('.btn-submit').disabled = false;
                }
            });
        });
        
        async function loadAllData() {
            const promises = [loadProperties(), loadWells(), loadActivity(), loadActivityStats()];

            // Only load documents if the tab is visible (user has access)
            if (document.getElementById('documentsTab') && document.getElementById('documentsTab').style.display !== 'none') {
                promises.push(loadDocuments());
                promises.push(loadUsageStats());
            }

            await Promise.all(promises);
        }

        async function findWellMatches() {
            const btn = document.getElementById('findMatchesBtn');
            btn.disabled = true;
            btn.textContent = 'Matching...';
            try {
                const res = await fetch('/api/match-property-wells', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    const count = data.stats.linksCreated;
                    if (count > 0) {
                        showToast(`Found ${count} new well match${count === 1 ? '' : 'es'}`, 'success');
                        await Promise.all([loadProperties(), loadWells()]);
                    } else {
                        showToast('All properties are already matched', 'success');
                    }
                } else {
                    showToast(data.error || 'Matching failed', 'error');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Find Matches';
            }
        }
