        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Auth: impersonation must run BEFORE any fetch calls
                const actAs = setupImpersonation();

                // Check for credit pack purchase success
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('purchase') === 'success') {
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, '', newUrl);
                    setTimeout(() => {
                        showToast('Credit pack purchased successfully! Credits have been added to your account.', 'success', 6000);
                    }, 500);
                }

                currentUser = await checkAuth();
                if (!currentUser) return;
                showSuperAdminNav();

                // Dashboard-specific: plan badge and limits
                const planBadge = document.getElementById('planBadge');
                planBadge.textContent = currentUser.plan || 'FREE';
                planBadge.style.visibility = 'visible';
                const limits = planConfigs[currentUser.plan] || { properties: 1, wells: 0 };
                document.getElementById('propLimit').textContent = limits.properties === Infinity ? '∞' : limits.properties;
                document.getElementById('wellLimit').textContent = limits.wells === Infinity ? '∞' : limits.wells;

                // Load impersonation banner (overrides currentUser.name/email/plan)
                if (actAs) {
                    await loadImpersonationBanner(actAs);
                    // Re-apply plan badge/limits with impersonated user's plan
                    document.getElementById('planBadge').textContent = currentUser.plan || 'FREE';
                    const targetLimits = planConfigs[currentUser.plan] || planConfigs['Free'] || { properties: 1, wells: 0 };
                    document.getElementById('propLimit').textContent = targetLimits.properties === Infinity ? '∞' : targetLimits.properties;
                    document.getElementById('wellLimit').textContent = targetLimits.wells === Infinity ? '∞' : targetLimits.wells;
                }

                // Hide upgrade link for Business/Enterprise users
                if (currentUser.plan === 'Business' || (currentUser.plan && currentUser.plan.startsWith('Enterprise'))) {
                    document.getElementById('upgradeLink').style.display = 'none';
                }

                // Show export buttons for Professional+ users
                if (currentUser.plan === 'Professional' || currentUser.plan === 'Business' || (currentUser.plan && currentUser.plan.startsWith('Enterprise'))) {
                    document.getElementById('exportPropertiesBtn').style.display = 'inline-flex';
                    document.getElementById('exportWellsBtn').style.display = 'inline-flex';
                }

                // Show Find Matches button for all users
                document.getElementById('findMatchesBtn').style.display = 'inline-flex';

                // Show Documents tab for all users
                console.log('Showing documents tab for all users');
                document.getElementById('documentsTab').style.display = 'flex';
                // Also show document count in plan info
                if (document.getElementById('docCountItem')) {
                    document.getElementById('docCountItem').style.display = 'flex';
                    document.getElementById('docCountDisplay').style.display = 'flex';
                }

                // Show mobile photo upload section only on mobile devices
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    // Show prominent photo upload section above search bar
                    const mobilePhotoSection = document.getElementById('mobilePhotoUploadSection');
                    if (mobilePhotoSection) {
                        mobilePhotoSection.style.display = 'block';
                    }
                }
                
                // Hide add/edit/delete buttons for Viewers
                if (currentUser.role === 'Viewer') {
                    // Hide property add/import buttons
                    const addPropertyBtn = document.getElementById('addPropertyBtn');
                    const bulkUploadBtn = document.getElementById('bulkUploadBtn');
                    if (addPropertyBtn) addPropertyBtn.style.display = 'none';
                    if (bulkUploadBtn) bulkUploadBtn.style.display = 'none';

                    // Hide well add/import buttons
                    const addWellBtn = document.getElementById('addWellBtn');
                    const bulkUploadWellsBtn = document.getElementById('bulkUploadWellsBtn');
                    if (addWellBtn) addWellBtn.style.display = 'none';
                    if (bulkUploadWellsBtn) bulkUploadWellsBtn.style.display = 'none';

                    // Hide bulk action bars (delete buttons)
                    const propertiesBulkActionBar = document.getElementById('propertiesBulkActionBar');
                    const wellsBulkActionBar = document.getElementById('wellsBulkActionBar');
                    const activityBulkActionBar = document.getElementById('activityBulkActionBar');
                    if (propertiesBulkActionBar) propertiesBulkActionBar.style.display = 'none';
                    if (wellsBulkActionBar) wellsBulkActionBar.style.display = 'none';
                    if (activityBulkActionBar) activityBulkActionBar.style.display = 'none';

                    // Hide the dividers between action groups when buttons are hidden
                    document.querySelectorAll('.action-divider').forEach(d => d.style.display = 'none');
                }
                
                await loadAllData();

                // Deferred localStorage cleanup for section geometry cache
                setTimeout(() => {
                    try {
                        const TTL = 7 * 24 * 60 * 60 * 1000;
                        const MAX = 500;
                        const now = Date.now();
                        const entries = [];
                        for (let i = localStorage.length - 1; i >= 0; i--) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith('mw_section_')) {
                                let ts = 0;
                                try { const v = JSON.parse(localStorage.getItem(key)); ts = v && v.t ? v.t : 0; } catch(e) {}
                                entries.push({ key, ts });
                            }
                        }
                        // Evict expired
                        const alive = [];
                        for (const e of entries) {
                            if (e.ts > 0 && (now - e.ts) > TTL) {
                                localStorage.removeItem(e.key);
                            } else {
                                alive.push(e);
                            }
                        }
                        // Cap at 500 — remove oldest first
                        if (alive.length > MAX) {
                            alive.sort((a, b) => a.ts - b.ts);
                            const remove = alive.length - MAX;
                            for (let i = 0; i < remove; i++) {
                                localStorage.removeItem(alive[i].key);
                            }
                        }
                    } catch (e) {}
                }, 0);

                // Initialize search/sort controls
                initWellsControls();
                initPropertiesControls();
                initDocumentsControls();

                // Tab strip scroll fade hint — hide when scrolled to end
                const tabsEl = document.querySelector('.tabs');
                if (tabsEl) {
                    tabsEl.addEventListener('scroll', () => {
                        const atEnd = tabsEl.scrollLeft + tabsEl.clientWidth >= tabsEl.scrollWidth - 4;
                        tabsEl.classList.toggle('scrolled-end', atEnd);
                    });
                }
            } catch (err) {
                console.error('Dashboard init error:', err);
                if (!window.currentUser) {
                    // Auth actually failed — redirect to login
                    window.location.href = '/portal/login';
                } else {
                    // Auth succeeded but something else broke — show error, don't redirect
                    const msg = (err && err.message) ? err.message : String(err);
                    console.error('Post-auth init error (NOT redirecting):', msg);
                    const banner = document.createElement('div');
                    banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;background:#e53e3e;color:#fff;padding:12px 16px;text-align:center;font-size:14px;';
                    banner.textContent = 'Dashboard init error: ' + msg;
                    document.body.prepend(banner);
                }
            }

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', async () => {
                    currentTab = tab.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(currentTab + '-tab').classList.add('active');

                    if (currentTab === 'wells' && !wellsInitialized) {
                        wellsInitialized = true;
                        loadWells().catch(() => { wellsInitialized = false; });
                    }
                    if (currentTab === 'activity' && !activityInitialized) {
                        activityInitialized = true;
                        loadActivity().catch(() => { activityInitialized = false; });
                    }
                    if (currentTab === 'documents') {
                        if (!documentsInitialized) {
                            documentsInitialized = true;
                            Promise.all([loadDocuments(), loadUsageStats()])
                                .catch(() => { documentsInitialized = false; });
                        }
                    } else {
                        stopDocumentPolling();
                    }
                    if (currentTab === 'tools') {
                        if (!wellsInitialized) {
                            wellsInitialized = true;
                            await loadWells().catch(() => { wellsInitialized = false; });
                        }
                        loadTools();
                    }
                });
            });
            
            // Tab Visibility API - Auto-refresh when returning to tab
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden && currentTab === 'documents' && documentsInitialized) {
                    // User returned to tab while on documents
                    const hasProcessing = loadedDocuments.some(doc => 
                        doc.status === 'processing' || doc.status === 'pending'
                    );
                    if (hasProcessing) {
                        console.log('[Documents] Tab became visible with processing documents, refreshing...');
                        await loadDocuments();
                    }
                }
            });
            
            // Bulk selection event listeners
            document.addEventListener('change', (e) => {
                // Handle select all checkboxes
                if (e.target.id === 'selectAllProperties') {
                    selectAllItems('properties', e.target.checked);
                } else if (e.target.id === 'selectAllWells') {
                    selectAllItems('wells', e.target.checked);
                }
                // Handle individual checkboxes
                else if (e.target.classList.contains('property-checkbox')) {
                    togglePropertySelection(e.target.dataset.id, e.target.checked);
                } else if (e.target.classList.contains('well-checkbox')) {
                    toggleWellSelection(e.target.dataset.id, e.target.checked);
                } else if (e.target.classList.contains('document-checkbox')) {
                    toggleDocumentSelection(e.target.dataset.id, e.target.checked);
                }
            });
            
            // Add button event listeners inside DOMContentLoaded
            // Well Modal
            document.getElementById('addWellBtn').addEventListener('click', () => {
                const m = document.getElementById('addWellModal');
                m.style.display = 'flex';
                openModalA11y(m);
            });
            
            // Bulk Upload Properties Modal
            const bulkUploadBtn = document.getElementById('bulkUploadBtn');
            console.log('Bulk upload button:', bulkUploadBtn);
            if (bulkUploadBtn) {
                bulkUploadBtn.addEventListener('click', () => {
                    console.log('Import button clicked');
                    openBulkUploadModal();
                });
            } else {
                console.error('Bulk upload button not found!');
            }
            
            // Bulk Upload Wells Modal
            document.getElementById('bulkUploadWellsBtn').addEventListener('click', () => {
                openBulkUploadWellsModal();
            });
            
            // Add Well Modal event listeners
            document.getElementById('addWellModal').addEventListener('click', e => { 
                if (e.target.id === 'addWellModal') closeWellModal(); 
            });
            
            document.getElementById('addWellForm').addEventListener('submit', async e => {
                e.preventDefault();
                const data = { 
                    apiNumber: document.getElementById('apiNumber').value.trim(),
                    notes: document.getElementById('wellNotes').value.trim()
                };
                
                try {
                    document.querySelector('.btn-submit').disabled = true;
                    const res = await fetch('/api/wells/track', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || 'Failed to add well');
                    }
                    
                    const result = await res.json();
                    closeWellModal();
                    showToast('Well added successfully');
                    loadWells();
                    loadActivityStats();
                } catch (err) {
                    showToast('Error: ' + err.message, 'error');
                } finally {
                    document.querySelector('.btn-submit').disabled = false;
                }
            });
        });
        
        let wellsInitialized = false;
        let activityInitialized = false;
        let documentsInitialized = false;

        async function loadBarCounts() {
            try {
                const res = await fetch('/api/dashboard/counts');
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('wellCount').textContent = data.wells;
                    if (document.getElementById('docCount')) {
                        document.getElementById('docCount').textContent = data.documents;
                    }
                }
            } catch {}
        }

        async function loadAllData() {
            const promises = [loadProperties(), loadActivityStats(), loadBarCounts()];

            // Reload tabs that have already been initialized (for post-mutation refresh)
            if (wellsInitialized) promises.push(loadWells());
            if (activityInitialized) promises.push(loadActivity());
            if (documentsInitialized && document.getElementById('documentsTab') &&
                document.getElementById('documentsTab').style.display !== 'none') {
                promises.push(loadDocuments());
                promises.push(loadUsageStats());
            }

            await Promise.all(promises);
        }

        async function findWellMatches() {
            const wrapper = document.getElementById('findMatchesBtn');
            const btn = wrapper.querySelector('button');
            btn.disabled = true;
            const origText = btn.textContent;
            btn.textContent = 'Matching...';
            try {
                const res = await fetch('/api/match-property-wells', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    const s = data.stats;
                    const count = s.linksCreated;
                    if (count > 0) {
                        // Build detail of new match types
                        const types = Object.entries(s.newMatchesByType || {}).map(([k,v]) => `${v} ${k}`).join(', ');
                        showToast(`Found ${count} new match${count === 1 ? '' : 'es'}: ${types}`, 'success');
                        await Promise.all([loadProperties(), loadWells()]);
                    } else {
                        showToast('All wells matched', 'info');
                    }
                } else {
                    showToast(data.error || 'Matching failed', 'error');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = origText;
            }
        }

        async function discoverAndTrackWells() {
            const wrapper = document.getElementById('findMatchesBtn');
            const btn = wrapper.querySelector('button');
            btn.disabled = true;
            const origText = btn.textContent;
            btn.textContent = 'Discovering...';
            try {
                const res = await fetch('/api/discover-and-track-wells', { method: 'POST' });
                const data = await res.json();
                if (!res.ok) {
                    showToast(data.error || 'Discovery failed', 'error');
                    return;
                }
                if (data.success) {
                    const s = data.stats;
                    if (s.wellsTracked > 0) {
                        let msg = `Discovered ${s.wellsDiscovered} wells, tracked ${s.wellsTracked} new, created ${s.linksCreated} links`;
                        if (s.wellsSkipped > 0) msg += ` (${s.wellsSkipped} already tracked)`;
                        showToast(msg, 'success', 6000);
                        await loadAllData();
                    } else if (s.wellsOverLimit > 0) {
                        showToast(`Found ${s.wellsDiscovered} wells but no slots remaining on your plan. Upgrade to track more.`, 'warning', 6000);
                    } else if (s.wellsSkipped > 0) {
                        showToast(`All ${s.wellsSkipped} discovered wells are already tracked.`, 'info');
                    } else {
                        showToast(data.message || 'No producing wells found at your property locations.', 'info');
                    }
                } else {
                    showToast(data.error || 'Discovery failed', 'error');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = origText;
            }
        }


