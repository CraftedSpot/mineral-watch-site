        // Shared Document Detail & Viewer Functions
        // Used by both map and dashboard for document type formatting,
        // field value formatting, document viewing (PDF/image/TIFF),
        // and document detail content rendering.

        // Document viewer state
        const _docViewerState = {
            docId: null, blobUrl: null, filename: null, contentType: null,
            // Image viewer transform state
            zoom: 1, panX: 0, panY: 0, rotation: 0,
            isDragging: false, dragStartX: 0, dragStartY: 0, panStartX: 0, panStartY: 0,
            lastTouchDist: 0, lastTouchCenterX: 0, lastTouchCenterY: 0,
            _keyHandler: null, _wheelHandler: null
        };

        /**
         * Format document type for display (snake_case → readable label).
         */
        function formatDocType(docType) {
            if (!docType) return 'Unknown';
            const typeMap = {
                'pooling_order': 'Pooling Order',
                'spacing_order': 'Spacing Order',
                'increased_density': 'Increased Density Order',
                'location_exception': 'Location Exception',
                'multiunit_horizontal': 'Multi-Unit Horizontal Order',
                'well_proposal': 'Well Proposal',
                'oil_gas_lease': 'Oil & Gas Lease',
                'multi_document': 'Multi-Document PDF',
                'other': 'Other Document'
            };
            if (typeMap[docType]) return typeMap[docType];
            return docType.split('_').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
        }

        /**
         * Format a value for display in document detail.
         * Handles arrays, objects, and primitives.
         * Uses shared helpers: isSectionsArray, condenseSections, formatSnakeCaseValue, formatFieldName.
         */
        function formatFieldValue(value) {
            if (value === null || value === undefined || value === '') return null;
            if (Array.isArray(value)) {
                if (value.length === 0) return null;
                if (typeof value[0] === 'object') {
                    if (isSectionsArray(value)) {
                        return condenseSections(value);
                    }
                    return value.map(v => v.name || v.formation || v.description || v.option_type || JSON.stringify(v)).join(', ');
                }
                return value.join(', ');
            }
            if (typeof value === 'object') {
                if (value.sections && Array.isArray(value.sections) && isSectionsArray(value.sections)) {
                    return condenseSections(value.sections);
                }
                const entries = Object.entries(value).filter(([k, v]) => v !== null && v !== undefined && v !== '');
                if (entries.length === 0) return null;
                return entries.map(([k, v]) => {
                    let displayV;
                    if (typeof v === 'string') {
                        displayV = formatSnakeCaseValue(v);
                    } else if (typeof v === 'object') {
                        displayV = formatFieldValue(v);
                    } else {
                        displayV = String(v);
                    }
                    return `${formatFieldName(k)}: ${displayV}`;
                }).join(', ');
            }
            if (typeof value === 'string') {
                return formatSnakeCaseValue(value);
            }
            return String(value);
        }

        /**
         * Open document viewer modal for PDF/image/TIFF display.
         * ctx = { container, titleEl, modal, zIndex, rotation }
         */
        async function openDocumentViewer(docId, filename, contentType, ctx) {
            console.log('Opening document viewer:', docId, filename, 'type:', contentType);
            _docViewerState.docId = docId;
            _docViewerState.filename = filename;
            _docViewerState.contentType = contentType || 'application/pdf';

            const modal = ctx.modal || document.getElementById('documentViewModal');
            const container = ctx.container;
            const titleEl = ctx.titleEl || document.getElementById('documentViewTitle');
            const rotation = ctx.rotation || 0;

            titleEl.textContent = filename || 'Document Viewer';
            modal.style.display = 'flex';
            if (ctx.zIndex) modal.style.zIndex = ctx.zIndex;

            const isImage = contentType && (contentType.startsWith('image/jpeg') || contentType.startsWith('image/png'));
            const isTiff = contentType && contentType.startsWith('image/tiff');

            if (isTiff) {
                container.innerHTML = `
                    <div style="color: white; text-align: center; padding: 50px;">
                        <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 20px; opacity: 0.6;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <p style="font-size: 16px; margin-bottom: 8px;">TIFF files cannot be previewed in browser</p>
                        <p style="opacity: 0.7; margin-bottom: 20px;">Download to view in an image editor</p>
                        <button onclick="downloadViewerDocument()" style="background: #3B82F6; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px;">
                            Download TIFF
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `<div style="color: white; text-align: center; padding: 50px;">Loading ${isImage ? 'image' : 'document'}...</div>`;

            try {
                const response = await fetch(`/api/documents/${docId}/download?view=true`);
                if (!response.ok) throw new Error('Failed to load file');

                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);

                if (isImage) {
                    // Reset viewer state
                    _docViewerState.zoom = 1;
                    _docViewerState.panX = 0;
                    _docViewerState.panY = 0;
                    _docViewerState.rotation = rotation || 0;
                    _docViewerState.isDragging = false;

                    container.innerHTML = `
                        <div id="imageViewerWrapper" style="width: 100%; height: 100%; overflow: hidden; position: relative; cursor: default; touch-action: none;">
                            <div id="imageViewerContent" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; transform-origin: center center;">
                                <img id="viewerImage" src="${objectUrl}" alt="${escapeHtml(filename || 'Document')}" style="max-width: 100%; max-height: 100%; object-fit: contain; user-select: none; -webkit-user-drag: none; pointer-events: none;"/>
                            </div>
                            <div id="imageViewerToolbar" style="position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.75); border-radius: 8px; padding: 6px 10px; z-index: 10;">
                                <button onclick="_imgZoomOut()" title="Zoom out (-)" style="background: none; border: none; color: white; cursor: pointer; padding: 6px; border-radius: 4px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='none'">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8" stroke-width="2"/><path d="M21 21l-4.35-4.35" stroke-width="2" stroke-linecap="round"/><path d="M8 11h6" stroke-width="2" stroke-linecap="round"/></svg>
                                </button>
                                <span id="zoomIndicator" style="color: white; font-size: 12px; min-width: 42px; text-align: center; font-variant-numeric: tabular-nums; user-select: none;">100%</span>
                                <button onclick="_imgZoomIn()" title="Zoom in (+)" style="background: none; border: none; color: white; cursor: pointer; padding: 6px; border-radius: 4px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='none'">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8" stroke-width="2"/><path d="M21 21l-4.35-4.35" stroke-width="2" stroke-linecap="round"/><path d="M11 8v6M8 11h6" stroke-width="2" stroke-linecap="round"/></svg>
                                </button>
                                <button onclick="_imgResetZoom()" title="Fit to view (0)" style="background: none; border: none; color: white; cursor: pointer; padding: 6px; border-radius: 4px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='none'">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"/></svg>
                                </button>
                                <div style="width: 1px; height: 20px; background: rgba(255,255,255,0.3); margin: 0 4px;"></div>
                                <button onclick="_imgRotate(-90)" title="Rotate left (Shift+R)" style="background: none; border: none; color: white; cursor: pointer; padding: 6px; border-radius: 4px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='none'">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                                </button>
                                <button onclick="_imgRotate(90)" title="Rotate right (R)" style="background: none; border: none; color: white; cursor: pointer; padding: 6px; border-radius: 4px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='none'">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10H11a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/></svg>
                                </button>
                            </div>
                        </div>
                    `;

                    // Apply initial transform (for pre-existing rotation)
                    _updateImageTransform();

                    // Attach event listeners
                    const wrapper = document.getElementById('imageViewerWrapper');
                    _docViewerState._wheelHandler = function(e) { _imgHandleWheel(e); };
                    wrapper.addEventListener('wheel', _docViewerState._wheelHandler, { passive: false });
                    wrapper.addEventListener('mousedown', _imgHandleMouseDown);
                    wrapper.addEventListener('mousemove', _imgHandleMouseMove);
                    wrapper.addEventListener('mouseup', _imgHandleMouseUp);
                    wrapper.addEventListener('mouseleave', _imgHandleMouseUp);
                    wrapper.addEventListener('touchstart', _imgHandleTouchStart, { passive: false });
                    wrapper.addEventListener('touchmove', _imgHandleTouchMove, { passive: false });
                    wrapper.addEventListener('touchend', _imgHandleTouchEnd);

                    _docViewerState._keyHandler = function(e) { _imgHandleKeyDown(e); };
                    document.addEventListener('keydown', _docViewerState._keyHandler);
                } else {
                    container.innerHTML = `
                        <iframe
                            src="${objectUrl}"
                            style="width: 100%; height: 100%; border: none;"
                            title="${escapeHtml(filename || 'Document')}"
                        ></iframe>
                    `;
                }

                _docViewerState.blobUrl = objectUrl;
            } catch (error) {
                console.error('Error loading file:', error);
                container.innerHTML = `
                    <div style="color: white; text-align: center; padding: 50px;">
                        <p>Unable to display file in browser</p>
                        <p style="margin-top: 20px;">
                            <button onclick="downloadViewerDocument()" style="background: #3B82F6; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer;">
                                Download File
                            </button>
                        </p>
                    </div>
                `;
            }
        }

        // ── Image Viewer Controls ──────────────────────────────────────

        function _updateImageTransform() {
            const el = document.getElementById('imageViewerContent');
            if (!el) return;
            const s = _docViewerState;
            // Order: translate (screen-space pan) then rotate then scale
            el.style.transform = `scale(${s.zoom}) translate(${s.panX}px, ${s.panY}px) rotate(${s.rotation}deg)`;
            const indicator = document.getElementById('zoomIndicator');
            if (indicator) indicator.textContent = Math.round(s.zoom * 100) + '%';
            const wrapper = document.getElementById('imageViewerWrapper');
            if (wrapper) wrapper.style.cursor = s.zoom > 1 ? 'grab' : 'default';
        }

        function _imgZoomIn() {
            _docViewerState.zoom = Math.min(5, _docViewerState.zoom * 1.25);
            if (_docViewerState.zoom <= 1.01) { _docViewerState.panX = 0; _docViewerState.panY = 0; }
            _updateImageTransform();
        }

        function _imgZoomOut() {
            _docViewerState.zoom = Math.max(0.25, _docViewerState.zoom / 1.25);
            if (_docViewerState.zoom <= 1.01) { _docViewerState.panX = 0; _docViewerState.panY = 0; }
            _updateImageTransform();
        }

        function _imgResetZoom() {
            _docViewerState.zoom = 1;
            _docViewerState.panX = 0;
            _docViewerState.panY = 0;
            _updateImageTransform();
        }

        function _imgRotate(deg) {
            _docViewerState.rotation = (_docViewerState.rotation + deg + 360) % 360;
            _docViewerState.zoom = 1;
            _docViewerState.panX = 0;
            _docViewerState.panY = 0;
            _updateImageTransform();
        }

        function _imgHandleWheel(e) {
            e.preventDefault();
            const s = _docViewerState;
            if (e.deltaY < 0) {
                s.zoom = Math.min(5, s.zoom * 1.15);
            } else {
                s.zoom = Math.max(0.25, s.zoom / 1.15);
            }
            if (s.zoom <= 1.01) { s.panX = 0; s.panY = 0; }
            _updateImageTransform();
        }

        function _imgHandleMouseDown(e) {
            if (_docViewerState.zoom <= 1.01) return;
            e.preventDefault();
            _docViewerState.isDragging = true;
            _docViewerState.dragStartX = e.clientX;
            _docViewerState.dragStartY = e.clientY;
            _docViewerState.panStartX = _docViewerState.panX;
            _docViewerState.panStartY = _docViewerState.panY;
            const wrapper = document.getElementById('imageViewerWrapper');
            if (wrapper) wrapper.style.cursor = 'grabbing';
        }

        function _imgHandleMouseMove(e) {
            if (!_docViewerState.isDragging) return;
            e.preventDefault();
            const dx = (e.clientX - _docViewerState.dragStartX) / _docViewerState.zoom;
            const dy = (e.clientY - _docViewerState.dragStartY) / _docViewerState.zoom;
            _docViewerState.panX = _docViewerState.panStartX + dx;
            _docViewerState.panY = _docViewerState.panStartY + dy;
            _updateImageTransform();
        }

        function _imgHandleMouseUp() {
            if (!_docViewerState.isDragging) return;
            _docViewerState.isDragging = false;
            const wrapper = document.getElementById('imageViewerWrapper');
            if (wrapper) wrapper.style.cursor = _docViewerState.zoom > 1 ? 'grab' : 'default';
        }

        function _imgHandleTouchStart(e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                _docViewerState.lastTouchDist = Math.hypot(dx, dy);
                _docViewerState.lastTouchCenterX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                _docViewerState.lastTouchCenterY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            } else if (e.touches.length === 1 && _docViewerState.zoom > 1.01) {
                e.preventDefault();
                _docViewerState.isDragging = true;
                _docViewerState.dragStartX = e.touches[0].clientX;
                _docViewerState.dragStartY = e.touches[0].clientY;
                _docViewerState.panStartX = _docViewerState.panX;
                _docViewerState.panStartY = _docViewerState.panY;
            }
        }

        function _imgHandleTouchMove(e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const dist = Math.hypot(dx, dy);
                if (_docViewerState.lastTouchDist > 0) {
                    const scale = dist / _docViewerState.lastTouchDist;
                    _docViewerState.zoom = Math.min(5, Math.max(0.25, _docViewerState.zoom * scale));
                    if (_docViewerState.zoom <= 1.01) { _docViewerState.panX = 0; _docViewerState.panY = 0; }
                    _updateImageTransform();
                }
                _docViewerState.lastTouchDist = dist;
            } else if (e.touches.length === 1 && _docViewerState.isDragging) {
                e.preventDefault();
                const dx = (e.touches[0].clientX - _docViewerState.dragStartX) / _docViewerState.zoom;
                const dy = (e.touches[0].clientY - _docViewerState.dragStartY) / _docViewerState.zoom;
                _docViewerState.panX = _docViewerState.panStartX + dx;
                _docViewerState.panY = _docViewerState.panStartY + dy;
                _updateImageTransform();
            }
        }

        function _imgHandleTouchEnd(e) {
            if (e.touches.length < 2) _docViewerState.lastTouchDist = 0;
            if (e.touches.length === 0) _docViewerState.isDragging = false;
        }

        function _imgHandleKeyDown(e) {
            const modal = document.getElementById('documentViewModal');
            if (!modal || modal.style.display === 'none') return;
            const el = document.getElementById('imageViewerContent');
            if (!el) return;

            switch (e.key) {
                case '+': case '=': e.preventDefault(); _imgZoomIn(); break;
                case '-': case '_': e.preventDefault(); _imgZoomOut(); break;
                case '0': e.preventDefault(); _imgResetZoom(); break;
                case 'r': e.preventDefault(); _imgRotate(e.shiftKey ? -90 : 90); break;
                case 'R': e.preventDefault(); _imgRotate(-90); break;
                case 'ArrowLeft':
                    if (_docViewerState.zoom > 1.01) { e.preventDefault(); _docViewerState.panX += 50 / _docViewerState.zoom; _updateImageTransform(); }
                    break;
                case 'ArrowRight':
                    if (_docViewerState.zoom > 1.01) { e.preventDefault(); _docViewerState.panX -= 50 / _docViewerState.zoom; _updateImageTransform(); }
                    break;
                case 'ArrowUp':
                    if (_docViewerState.zoom > 1.01) { e.preventDefault(); _docViewerState.panY += 50 / _docViewerState.zoom; _updateImageTransform(); }
                    break;
                case 'ArrowDown':
                    if (_docViewerState.zoom > 1.01) { e.preventDefault(); _docViewerState.panY -= 50 / _docViewerState.zoom; _updateImageTransform(); }
                    break;
            }
        }

        // Make toolbar button handlers globally accessible
        window._imgZoomIn = _imgZoomIn;
        window._imgZoomOut = _imgZoomOut;
        window._imgResetZoom = _imgResetZoom;
        window._imgRotate = _imgRotate;

        // ── End Image Viewer Controls ─────────────────────────────────

        /**
         * Close document viewer and clean up blob URL.
         * ctx = { container, modal, resetZIndex }
         */
        function closeDocumentViewerShared(ctx) {
            const modal = (ctx && ctx.modal) || document.getElementById('documentViewModal');
            const container = (ctx && ctx.container) || document.getElementById('pdfViewerContainer');

            modal.style.display = 'none';
            if (ctx && ctx.resetZIndex) {
                modal.style.zIndex = '2000';
            }

            // Clean up image viewer event listeners
            if (_docViewerState._keyHandler) {
                document.removeEventListener('keydown', _docViewerState._keyHandler);
                _docViewerState._keyHandler = null;
            }
            if (_docViewerState._wheelHandler) {
                const wrapper = document.getElementById('imageViewerWrapper');
                if (wrapper) wrapper.removeEventListener('wheel', _docViewerState._wheelHandler);
                _docViewerState._wheelHandler = null;
            }
            // Reset viewer state
            _docViewerState.zoom = 1;
            _docViewerState.panX = 0;
            _docViewerState.panY = 0;
            _docViewerState.rotation = 0;
            _docViewerState.isDragging = false;

            if (_docViewerState.blobUrl) {
                URL.revokeObjectURL(_docViewerState.blobUrl);
                _docViewerState.blobUrl = null;
            }
            container.innerHTML = '';
        }

        /**
         * Download the currently viewed document.
         */
        function downloadViewerDocument() {
            if (_docViewerState.docId) {
                window.location.href = `/api/documents/${_docViewerState.docId}/download`;
            }
        }

        /**
         * Print document summary in new tab.
         */
        function printDocSummary(docId) {
            const id = docId || _docViewerState.docId;
            if (id) {
                window.open(`/print/document?id=${id}`, '_blank');
            }
        }

        /**
         * Render document detail content body.
         * Returns HTML string with: status/type row, key takeaway, detailed analysis,
         * election options, extracted fields grid, or no-data state.
         * Used by map's simpler detail modal. Dashboard uses its own renderExtractedData.
         */
        function renderDocDetailContent(doc) {
            let content = '';

            // Status + Type row
            const statusColor = doc.status === 'complete' ? '#1D6F5C' :
                               doc.status === 'failed' ? '#DC2626' :
                               doc.status === 'manual_review' ? '#D97706' : '#F59E0B';
            const statusText = doc.status === 'complete' ? 'Complete' :
                              doc.status === 'failed' ? 'Failed' :
                              doc.status === 'manual_review' ? 'Needs Review' : 'Processing';

            content += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">';
            content += `
                <div style="background: #f9fafb; padding: 12px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Status</div>
                    <div style="font-weight: 600; color: ${statusColor};">${statusText}</div>
                </div>`;

            if (doc.category || doc.doc_type) {
                content += `
                <div style="background: #f9fafb; padding: 12px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Document Type</div>
                    <div style="font-weight: 500; color: var(--oil-navy);">${formatDocType(doc.category || doc.doc_type)}</div>
                </div>`;
            }
            content += '</div>';

            // Parse extracted data if available
            if (doc.extracted_data) {
                try {
                    const extractedData = typeof doc.extracted_data === 'string' ? JSON.parse(doc.extracted_data) : doc.extracted_data;
                    const docType = extractedData.doc_type || doc.doc_type;

                    // Processor error
                    if (extractedData.error) {
                        content += '<div style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 8px; padding: 16px; margin-bottom: 20px;">';
                        content += `<h4 style="margin: 0 0 8px 0; color: #B91C1C; font-size: 14px; font-weight: 600;">Error: ${escapeHtml(extractedData.error)}</h4>`;
                        content += '<p style="margin: 0; color: #7F1D1D; font-size: 13px;">The document processor encountered an error. Please try re-analyzing the document.</p>';
                        content += '</div>';
                    }

                    // Key Takeaway (prominent, open by default)
                    if (extractedData.key_takeaway) {
                        const cleanedTakeaway = String(extractedData.key_takeaway).trim()
                            .replace(/^#{1,6}\s*/gm, '').replace(/^---+$/gm, '').replace(/\*\*([^*]+)\*\*/g, '$1').replace(/\*\*/g, '').replace(/^\s+/gm, '').replace(/\t/g, ' ').replace(/\n{3,}/g, '\n\n');
                        content += `<div style="margin-bottom: 16px;">
                            <details open style="border: 1px solid #d1fae5; border-radius: 8px; overflow: hidden;">
                                <summary style="padding: 12px 16px; background: #ecfdf5; cursor: pointer; font-weight: 600; font-size: 14px; color: #065f46; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 10px; transition: transform 0.2s;">&#9654;</span>
                                    Key Takeaway
                                </summary>
                                <div style="padding: 12px 16px; font-size: 13px; line-height: 1.6; color: #1a1a2e; white-space: pre-wrap;">${escapeHtml(cleanedTakeaway)}</div>
                            </details>
                        </div>`;
                    }

                    // Detailed Analysis (collapsible, closed by default)
                    const analysisText = extractedData.ai_observations || extractedData.detailed_analysis || extractedData.observations;
                    if (analysisText) {
                        const cleanedAnalysis = String(analysisText).trim().replace(/^\s+/gm, '').replace(/\t/g, ' ');
                        content += `<div style="margin-bottom: 20px;">
                            <details style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                                <summary style="padding: 12px 16px; background: #f9fafb; cursor: pointer; font-weight: 600; font-size: 14px; color: var(--oil-navy); display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 10px; transition: transform 0.2s;">&#9654;</span>
                                    View Detailed Analysis
                                    <span style="font-size: 12px; color: #9ca3af; font-weight: 400; margin-left: auto;">Click to expand</span>
                                </summary>
                                <div style="padding: 12px 16px; font-size: 13px; line-height: 1.6; color: #4b5563;">${formatAnalysisText(cleanedAnalysis)}</div>
                            </details>
                        </div>`;
                    }

                    // Election Options
                    if (extractedData.election_options && Array.isArray(extractedData.election_options) && extractedData.election_options.length > 0) {
                        content += '<div style="border-top: 1px solid #e5e7eb; padding-top: 16px; margin-bottom: 16px;">';
                        content += '<h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--oil-navy);">Election Options</h4>';
                        content += '<div style="display: flex; flex-direction: column; gap: 8px;">';

                        extractedData.election_options.forEach((option, idx) => {
                            const optType = (option.option_type || option.type || 'unknown').toLowerCase();
                            let bgColor = '#f3f4f6', borderColor = '#d1d5db';

                            if (optType === 'participate') { bgColor = '#eff6ff'; borderColor = '#3b82f6'; }
                            else if (optType.includes('cash')) { bgColor = '#fef3c7'; borderColor = '#f59e0b'; }
                            else if (optType === 'non_consent') { bgColor = '#fee2e2'; borderColor = '#ef4444'; }

                            content += `
                                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 6px; padding: 10px 12px;">
                                    <div style="font-weight: 600; color: var(--oil-navy); margin-bottom: 4px;">${formatFieldName(option.option_type || option.type || 'Option ' + (idx + 1))}</div>
                                    ${option.description ? `<div style="font-size: 13px; color: #4b5563;">${escapeHtml(option.description)}</div>` : ''}
                                    ${option.bonus_per_acre ? `<div style="font-size: 13px; color: #4b5563; margin-top: 4px;">Bonus: $${option.bonus_per_acre}/acre</div>` : ''}
                                    ${option.royalty_rate ? `<div style="font-size: 13px; color: #4b5563;">Royalty: ${option.royalty_rate}</div>` : ''}
                                </div>`;
                        });

                        content += '</div></div>';
                    }

                    // Extracted Fields Grid (simple 2-column layout using shared display config)
                    const displayFields = Object.entries(extractedData).filter(([key, val]) => {
                        if (!shouldDisplayField(key, docType)) return false;
                        if (val === null || val === undefined || val === '') return false;
                        if (Array.isArray(val) && val.length > 0 && typeof val[0] === 'object' && key !== 'formations') return false;
                        return true;
                    });

                    if (displayFields.length > 0) {
                        content += '<div style="border-top: 1px solid #e5e7eb; padding-top: 16px;">';
                        content += '<h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--oil-navy);">Extracted Information</h4>';
                        content += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">';

                        displayFields.forEach(([key, value]) => {
                            let displayVal;
                            if (key === 'legal_description' && typeof value === 'object') {
                                displayVal = condenseLegal(value);
                            } else {
                                displayVal = formatFieldValue(value);
                            }
                            if (!displayVal) return;
                            displayVal = cleanFieldValue(displayVal);
                            if (key === 'unit_size_acres') displayVal += ' acres';
                            if (key === 'election_deadline_days') displayVal += ' days';

                            content += `
                                <div style="background: #f9fafb; padding: 10px 12px; border-radius: 6px;">
                                    <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px; text-transform: uppercase;">${formatFieldName(key)}</div>
                                    <div style="font-size: 14px; color: var(--oil-navy); white-space: pre-line;">${escapeHtml(displayVal)}</div>
                                </div>`;
                        });

                        content += '</div></div>';
                    }

                } catch (e) {
                    console.error('Error parsing extracted data:', e);
                    content += '<div style="padding: 16px; color: #DC2626;">Error displaying extracted data</div>';
                }
            } else {
                // No extracted data — show processing or pending state
                content += '<div style="text-align: center; padding: 40px 20px; background: #f9fafb; border-radius: 8px; margin: 20px 0;">';
                content += '<svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 16px; display: block; opacity: 0.3;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>';
                if (doc.status === 'failed') {
                    content += '<p style="margin: 0; color: #DC2626; font-size: 14px; font-weight: 500;">Document processing failed</p>';
                    content += '<p style="margin: 8px 0 0; color: #6b7280; font-size: 13px;">You can try re-analyzing or view the original document.</p>';
                } else if (doc.status === 'processing' || doc.status === 'pending') {
                    content += '<p style="margin: 0; color: #6b7280; font-size: 14px;">Document is still being processed...</p>';
                } else {
                    content += '<p style="margin: 0; color: #6b7280; font-size: 14px;">No extracted data available for this document.</p>';
                }
                content += '</div>';
            }

            return content;
        }
