        

        // Initialize map centered on Oklahoma
        const map = L.map('map').setView([35.5, -97.5], 7);
        
        // Force popup pane to have high z-index
        // Leaflet uses 'popupPane' by default for popups
        setTimeout(() => {
            const popupPane = map.getPane('popupPane');
            if (popupPane) {
                popupPane.style.zIndex = '1500';
                popupPane.style.position = 'relative';
            }
        }, 100);
        
        // Basemap layers â€” light (default) and dark mode
        const lightBase = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 19
        }).addTo(map);

        const lightRef = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}', {
            attribution: '',
            maxZoom: 19,
            opacity: 0.8
        }).addTo(map);

        const darkBase = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
            maxZoom: 20,
            subdomains: 'abcd'
        });

        let mapDarkMode = localStorage.getItem('mw_map_dark') !== '0';

        function toggleMapDarkMode() {
            mapDarkMode = !mapDarkMode;
            localStorage.setItem('mw_map_dark', mapDarkMode ? '1' : '0');
            applyMapDarkMode();
        }

        function applyMapDarkMode() {
            const btn = document.getElementById('darkModeBtn');
            if (mapDarkMode) {
                map.removeLayer(lightBase);
                map.removeLayer(lightRef);
                if (!map.hasLayer(darkBase)) darkBase.addTo(map);
                darkBase.bringToBack();
                document.getElementById('map').classList.add('map-dark');
                document.querySelector('.map-container').classList.add('map-dark');
                if (btn) btn.textContent = 'ðŸŒ™';
            } else {
                map.removeLayer(darkBase);
                if (!map.hasLayer(lightBase)) lightBase.addTo(map);
                if (!map.hasLayer(lightRef)) lightRef.addTo(map);
                lightBase.bringToBack();
                document.getElementById('map').classList.remove('map-dark');
                document.querySelector('.map-container').classList.remove('map-dark');
                if (btn) btn.textContent = 'â˜€ï¸';
            }
            // Restyle county boundaries for dark/light (guard: may not be loaded yet)
            try {
                if (typeof countyLayer !== 'undefined' && countyLayer) {
                    countyLayer.setStyle({
                        color: mapDarkMode ? 'rgba(255,255,255,0.6)' : '#1C2B36',
                        weight: mapDarkMode ? 1.5 : 3,
                        opacity: mapDarkMode ? 0.5 : 0.8,
                        fillOpacity: 0,
                        fillColor: 'transparent'
                    });
                }
                if (typeof createCountyLabels === 'function') {
                    createCountyLabels();
                }
            } catch (e) { /* counties not loaded yet â€” will pick up dark mode when they load */ }
            // Re-render section labels so they pick up dark/light colors
            try {
                if (typeof updateSectionLines === 'function') {
                    sectionBounds = null; // Force refresh
                    updateSectionLines();
                }
            } catch (e) { /* section lines not loaded yet */ }
            // Toggle legend dark mode
            const legend = document.getElementById('legendStrip');
            if (legend) {
                if (mapDarkMode) legend.classList.add('legend-dark');
                else legend.classList.remove('legend-dark');
            }
        }

        // Dark mode toggle â€” Leaflet control next to zoom buttons
        const DarkModeControl = L.Control.extend({
            options: { position: 'topleft' },
            onAdd: function() {
                const container = L.DomUtil.create('div', 'leaflet-control-darkmode leaflet-bar');
                const link = L.DomUtil.create('a', '', container);
                link.id = 'darkModeBtn';
                link.href = '#';
                link.title = 'Toggle dark mode';
                link.textContent = mapDarkMode ? '\uD83C\uDF19' : '\u2600\uFE0F';
                L.DomEvent.disableClickPropagation(container);
                L.DomEvent.on(link, 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    toggleMapDarkMode();
                });
                return container;
            }
        });
        map.addControl(new DarkModeControl());

        // Apply saved preference on load
        if (mapDarkMode) applyMapDarkMode();

        // Fullscreen toggle â€” Leaflet control next to zoom buttons
        let mapFullscreen = false;
        const FullscreenControl = L.Control.extend({
            options: { position: 'topleft' },
            onAdd: function() {
                const container = L.DomUtil.create('div', 'leaflet-control-fullscreen leaflet-bar');
                const link = L.DomUtil.create('a', '', container);
                link.id = 'fullscreenBtn';
                link.href = '#';
                link.title = 'Toggle fullscreen';
                link.textContent = '\u26F6';
                L.DomEvent.disableClickPropagation(container);
                L.DomEvent.on(link, 'click', function(e) {
                    L.DomEvent.preventDefault(e);
                    toggleMapFullscreen();
                });
                return container;
            }
        });
        map.addControl(new FullscreenControl());

        function toggleMapFullscreen() {
            const container = document.querySelector('.map-container');
            const btn = document.getElementById('fullscreenBtn');
            const searchBox = document.querySelector('.map-search-container');
            const pageHeader = document.querySelector('.page-header');
            if (!container) return;

            mapFullscreen = !mapFullscreen;
            if (mapFullscreen) {
                container.classList.add('map-fullscreen');
                if (btn) btn.textContent = '\u2715';
                document.body.style.overflow = 'hidden';
                // Move search into the map container
                if (searchBox) container.appendChild(searchBox);
            } else {
                container.classList.remove('map-fullscreen');
                if (btn) btn.textContent = '\u26F6';
                document.body.style.overflow = '';
                // Move search back to page header
                if (searchBox && pageHeader) {
                    const h1 = pageHeader.querySelector('h1');
                    if (h1) h1.after(searchBox);
                }
            }
            setTimeout(() => map.invalidateSize(), 50);
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && mapFullscreen) {
                toggleMapFullscreen();
            }
        });
        
        
        // Map click handler for location identification - DISABLED
        // (Was showing unreadable info in top-right corner)
        /*
        map.on('click', async function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            // Only identify if clicked within Oklahoma bounds (roughly)
            if (lat < 33.6 || lat > 37.0 || lon < -103.0 || lon > -94.4) {
                return; // Outside Oklahoma
            }
            
            try {
                updateStatus('Identifying location...');
                const location = await identifyLocation(lat, lon);
                
                if (location) {
                    createLocationInfoBox(
                        location.county, 
                        location.township, 
                        location.range, 
                        location.section,
                        location.meridian,
                        lat, 
                        lon
                    );
                    updateStatus('Map ready');
                } else {
                    updateStatus('Location not found');
                    setTimeout(() => updateStatus('Map ready'), 2000);
                }
            } catch (error) {
                console.error('Error identifying location:', error);
                updateStatus('Location identification failed');
                setTimeout(() => updateStatus('Map ready'), 2000);
            }
        });
        */
        
        // Add zoom/move handlers for section lines
        map.on('zoomend moveend', updateSectionLines);

        // Layer variables
        let countyLayer;
        let townshipLayer;
        let countyLabelsLayer = L.layerGroup();
        let propertiesLayer = L.featureGroup();
        let wellsLayer = null; // Will be initialized as MarkerClusterGroup in loadTrackedWells
        // Lateral paths are now integrated into well rendering
        let permitsLayer = L.featureGroup();
        let completionsLayer = L.featureGroup();
        let sectionLayer = L.featureGroup();
        let sectionLabelsLayer = L.layerGroup();  // For section number labels from OCC API
        let nearbyWellsLayer = null; // Initialize later after map is ready
        let nearbyLateralsLayer = L.featureGroup(); // Separate layer for nearby well laterals (zoom-gated)
        let lateralsLayer = L.featureGroup(); // Layer for horizontal well laterals
        let activityHeatmapLayer = null; // Will be created as heat layer
        let poolingRateLayer = null; // Choropleth: pooling bonus rates by township
        let poolingRateByTwp = {}; // Lookup: "09N-05W" -> { avg_bonus, order_count, ... }
        let permitHeatmapLayer = null; // Separate heat layer for permits
        let completionHeatmapLayer = null; // Separate heat layer for completions
        // OCC Application heatmap layers
        let poolingHeatmapLayer = null;
        let densityHeatmapLayer = null;
        let spacingHeatmapLayer = null;
        let horizontalHeatmapLayer = null;
        let countyProductionData = null; // Cached county production data for choropleth
        let currentProductionType = null; // 'oil' or 'gas'
        let showSectionNumbers = true;  // Default to showing section numbers
        let showActivityHeatmap = true; // Default to on for heatmap
        let locationInfoBox;
        
        // Define proximity radius for individual markers (in miles)
        const ACTIVITY_PROXIMITY_RADIUS = 5; // 5 miles around properties
        
        // Property loading state
        let userProperties = [];
        let geometryCache = {};
        let sectionCache = {};
        let sectionBounds = null;
        let wellsById = {};  // Lookup for wells by Airtable record ID
        
        // For search functionality
        let propertyMarkers = {};
        let wellMarkers = {};
        let trackedWells = [];
        
        // OCC API Configuration
        const OCC_API_BASE = 'https://gis.occ.ok.gov/server/rest/services/Hosted/STR/FeatureServer';
        const OCC_PROXY = '/api/occ-proxy';
        const SECTION_LAYER = 226; // OK_SEC layer
        
        // Property status colors
        const STATUS_COLORS = {
            active: '#22C55E',   // Green - permits nearby
            recent: '#F59E0B',   // Yellow - activity in last 30 days  
            quiet: '#3B82F6',    // Blue - no recent activity
            default: '#8B5CF6'   // Purple - default
        };
        
        // Well status colors
        const WELL_STATUS_COLORS = {
            'AC': '#22C55E',     // Active - Green
            'PA': '#6B7280',     // Plugged & Abandoned - Gray
            'ND': '#F97316',     // New Drill - Orange
            'SI': '#3B82F6',     // Shut In - Blue
            'TA': '#DC2626',     // Temp Abandoned - Red
            default: '#8B5CF6'   // Default - Purple
        };
        
        // Top operator colors
        const OPERATOR_COLORS = {
            'DEVON': '#1E40AF',              // Blue
            'CONTINENTAL': '#DC2626',        // Red
            'MEWBOURNE': '#059669',          // Green
            'MARATHON': '#7C3AED',           // Purple
            'EOG': '#F59E0B',               // Amber
            'OVINTIV': '#0891B2',           // Cyan
            'CIMAREX': '#EC4899',           // Pink
            'GULFPORT': '#84CC16',          // Lime
            'CITIZENS': '#F97316',          // Orange
            'CHESAPEAKE': '#06B6D4',        // Sky
            default: '#6B7280'              // Gray
        };
        
        // Authentication: checkAuth(), logout(), setupImpersonation(), loadImpersonationBanner()
        // are provided by shared-auth.txt (loaded before this module)

        // Update status
        function updateStatus(message) {
            // Log to console only - no UI updates
            console.log('Status:', message);
        }
        
        function showLoading(message = 'Loading map data...', subtext = '') {
            const loadingEl = document.getElementById('mapLoading');
            if (loadingEl) {
                loadingEl.style.display = 'flex';
                const textEl = loadingEl.querySelector('.loading-text');
                const subtextEl = loadingEl.querySelector('.loading-subtext');
                if (textEl) textEl.textContent = message;
                if (subtextEl) {
                    subtextEl.textContent = subtext;
                    subtextEl.style.display = subtext ? 'block' : 'none';
                }
            }
        }
        
        function hideLoading() {
            const loadingEl = document.getElementById('mapLoading');
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
        }
