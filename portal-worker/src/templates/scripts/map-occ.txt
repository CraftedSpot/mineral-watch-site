        // ============================================
        // OCC Filings Functions for Map Modal
        // (processOccFiling, renderOccFiling, checkAnalyzedFilings,
        //  updateOccButtonState, startOccDocumentPolling, stopAllOccPolling
        //  are provided by shared-occ-filings.txt)
        // ============================================

        // Toggle OCC filings accordion
        function toggleMapOccFilings() {
            const content = document.getElementById('map-occ-content');
            const arrow = document.getElementById('map-occ-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // getMatchReasonStyle() and getMatchReasonLabel() are now defined in shared utilities at top of script

        async function mapUnlinkProperty(linkId, wellId) {
            if (!confirm('Remove this property link?')) return;
            try {
                const res = await fetch(`/api/property-well-link/${linkId}`, { method: 'DELETE', credentials: 'include' });
                if (res.ok) expandWellCard(wellId, true);
                else showMapToast('Failed to unlink', 'error');
            } catch (e) { showMapToast('Error: ' + e.message, 'error'); }
        }
        async function mapRelinkProperty(linkId, wellId) {
            try {
                const res = await fetch(`/api/property-well-link/${linkId}`, { method: 'PATCH', credentials: 'include' });
                if (res.ok) expandWellCard(wellId, true);
                else showMapToast('Failed to relink', 'error');
            } catch (e) { showMapToast('Error: ' + e.message, 'error'); }
        }

        // Toggle linked properties accordion
        function toggleMapLinkedProperties() {
            const content = document.getElementById('map-linked-props-content');
            const arrow = document.getElementById('map-linked-props-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Toggle linked documents accordion
        function toggleMapLinkedDocs() {
            const content = document.getElementById('map-linked-docs-content');
            const arrow = document.getElementById('map-linked-docs-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Toggle Well Records accordion
        function toggleMapWellRecords() {
            const content = document.getElementById('map-well-records-content');
            const arrow = document.getElementById('map-well-records-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Toggle Drilling Permits accordion
        function toggleMapDrillingPermits() {
            const content = document.getElementById('map-drilling-permits-content');
            const arrow = document.getElementById('map-drilling-permits-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // ============================================
        // Well Records (Completion Reports)
        // loadCompletionReports, renderCompletionReport, analyzeCompletionReport,
        // _startCompletionPolling are provided by shared-completion-reports.txt
        // ============================================

        // Thin wrapper: calls shared loadCompletionReports with map-specific element IDs
        function loadMapCompletionReports(apiNumber) {
            loadCompletionReports(apiNumber, {
                container: document.getElementById('wellModalCompletionReports'),
                countBadge: document.getElementById('wellModalWellRecordsCount')
            });
        }

        // Simple toast notification for map modal
        function showMapToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                font-weight: 500;
                z-index: 1000002;
                animation: fadeIn 0.3s ease;
                ${type === 'success' ? 'background: #10b981;' : type === 'error' ? 'background: #ef4444;' : 'background: #3b82f6;'}
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============================================
        // Drilling Permits
        // loadDrillingPermits, renderDrillingPermit, analyzeDrillingPermit,
        // _startPermitPolling, _permitCache are provided by shared-drilling-permits.txt
        // ============================================

        // Thin wrapper: calls shared loadDrillingPermits with map-specific element IDs
        function loadMapDrillingPermits(apiNumber) {
            loadDrillingPermits(apiNumber, {
                container: document.getElementById('wellModalDrillingPermits'),
                countBadge: document.getElementById('wellModalDrillingPermitsCount')
            });
        }

        // Load OTC production summary for a well (uses shared renderer)
        async function loadMapOTCProduction(apiNumber) {
            console.log('[MapOTCProduction] Loading for API:', apiNumber);
            loadOTCProduction(apiNumber, {
                container: document.getElementById('wellModalOTCContent'),
                statusBadge: document.getElementById('wellModalOTCStatus'),
                section: document.getElementById('wellModalOTCProduction')
            });
        }

        // Thin wrapper: calls shared loadOccFilingsShared with map-specific element IDs
        function loadMapOccFilings(section, township, range, meridian = 'IM') {
            loadOccFilingsShared(
                { section, township, range, meridian, type: 'property' },
                {
                    directContainer: document.getElementById('map-occ-direct'),
                    adjacentContainer: document.getElementById('map-occ-adjacent'),
                    adjacentWrapper: document.getElementById('map-occ-adjacent-wrapper'),
                    emptyEl: document.getElementById('map-occ-empty'),
                    countBadge: document.getElementById('map-occ-count'),
                    adjacentCountBadge: document.getElementById('map-occ-adjacent-count')
                }
            );
        }

        // Track well from modal
        async function trackWellFromModal() {
            const apiNumber = document.getElementById('wellModalApiNumber').value;
            const wellName = document.getElementById('wellModalTitle').textContent;
            const trackBtn = document.getElementById('wellModalTrackBtn');

            if (!apiNumber || apiNumber === 'Unknown') {
                showToast('Cannot track well: missing API number', 'error');
                return;
            }

            trackBtn.disabled = true;
            trackBtn.textContent = 'Adding...';

            try {
                await trackWell(apiNumber, wellName);
                trackBtn.textContent = 'âœ“ Tracked';
                trackBtn.style.background = '#10b981';
                document.getElementById('wellModalIsTracked').value = '1';
                showToast('Well added to your tracked wells!', 'success');
            } catch (error) {
                console.error('Error tracking well:', error);
                trackBtn.disabled = false;
                trackBtn.textContent = '+ Track Well';
                showToast('Failed to track well: ' + error.message, 'error');
            }
        }

