        // =============================================
        // DEDUCTION REPORT VIEWER — Command Center Layout
        // =============================================

        // Track which report is currently displayed for print functionality
        let currentReportType = null; // 'deduction-audit' | 'production-decline' | 'pooling' | etc.

        // History API: allow browser back button to close reports
        let intelViewOpen = null; // 'report' | 'directory' | null
        window.addEventListener('popstate', function(e) {
            if (e.state && e.state.intelView === 'home') {
                if (intelViewOpen === 'report') {
                    closeReport(true);
                } else if (intelViewOpen === 'directory') {
                    closeOperatorDirectory(true);
                }
            }
        });
        // Push initial state so we have a "home" entry
        if (!history.state || !history.state.intelView) {
            history.replaceState({ intelView: 'home' }, '');
        }

        // Global print function that opens the dedicated print page
        function openPrintSummary() {
            if (!currentReportType) {
                console.warn('No report type set for printing');
                return;
            }

            const printUrls = {
                'deduction-audit': '/print/intelligence/deduction-audit',
                'production-decline': '/print/intelligence/production-decline',
                'shut-in-detector': '/print/intelligence/shut-in-detector',
                'pooling': '/print/intelligence/pooling'
            };

            let printUrl = printUrls[currentReportType];
            if (printUrl) {
                // Pass current tab (and sub-view for reports that have them)
                const params = new URLSearchParams();
                if (currentReportType === 'deduction-audit') {
                    params.set('tab', deductionCurrentTab);
                } else if (currentReportType === 'production-decline') {
                    params.set('tab', declineCurrentTab);
                    if (declineCurrentTab === 'research') {
                        params.set('view', declineResearchView || 'decliners');
                    }
                } else if (currentReportType === 'shut-in-detector') {
                    params.set('tab', shutInCurrentTab);
                    if (shutInCurrentTab === 'research') {
                        params.set('view', shutInResearchView || 'byCount');
                    }
                } else if (currentReportType === 'pooling') {
                    params.set('tab', poolingCurrentTab);
                }
                printUrl += '?' + params.toString();
                window.open(printUrl, '_blank');
            } else {
                // Fallback for reports without dedicated print pages
                window.print();
            }
        }

        const PRODUCT_NAMES = {
            '1': 'Oil', '3': 'NGL / Condensate',
            '5': 'Residue Gas', '6': 'Casinghead Gas'
        };

        const MONTH_ABBR = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

        function formatReportMonth(yyyymm) {
            if (!yyyymm || yyyymm.length < 6) return yyyymm || '';
            const year = yyyymm.substring(0, 4);
            const month = parseInt(yyyymm.substring(4, 6), 10);
            return MONTH_ABBR[month - 1] + ' ' + year;
        }

        function formatCurrencyFull(amount) {
            if (amount == null) return '—';
            return '$' + Math.round(amount).toLocaleString('en-US');
        }

        function deductionClass(pct) {
            if (pct >= 50) return 'value-danger';
            if (pct >= 25) return 'value-warning';
            return '';
        }

        function cleanCountyName(county) {
            if (!county) return '';
            // Strip "043-" style prefix if present
            return county.replace(/^\d{3}-/, '');
        }

        function gasProfileBadge(profile, isOperatorLevel) {
            if (!profile) return '';
            const labelMap = isOperatorLevel
                ? { 'Primarily Lean Gas': 'Lean Gas', 'Primarily Rich Gas': 'Rich Gas', 'Mixed Portfolio': 'Mixed' }
                : { lean: 'Lean Gas', rich: 'Rich Gas', mixed: 'Mixed' };
            const classMap = isOperatorLevel
                ? { 'Primarily Lean Gas': 'lean', 'Primarily Rich Gas': 'rich', 'Mixed Portfolio': 'mixed' }
                : { lean: 'lean', rich: 'rich', mixed: 'mixed' };
            const titleMap = {
                lean: 'Lean/dry gas profile (GOR > 15,000) — low NGL recovery expected',
                rich: 'Rich/wet gas profile (GOR < 3,000) — NGL recovery expected',
                mixed: 'Mixed gas profile (GOR 3,000–15,000) — transitional'
            };
            const label = labelMap[profile] || profile;
            const cls = classMap[profile] || 'mixed';
            const title = titleMap[cls] || '';
            return ' <span class="gas-profile-badge gas-profile-' + cls + '" title="' + title + '">' + label + '</span>';
        }

        let expandedWells = new Set();
        let lastReportData = null;

        // =============================================
        // SORTABLE TABLE — Reusable Pattern
        // =============================================

        // Column definitions: key, label, type, sticky class (optional), print-hide (optional)
        // Ordered by importance: identifiers first, then key metrics, then context
        const FLAGGED_WELLS_COLUMNS = [
            { key: 'well_name', label: 'Well', type: 'string', sticky: 'sticky sticky-well', hasExpand: true },
            { key: 'operator', label: 'Operator', type: 'string', sticky: 'sticky sticky-operator' },
            { key: 'agg_deduction_pct', label: 'Ded %', type: 'percent', title: 'Aggregate deduction rate across all products' },
            { key: '_pcrr', label: 'PCRR %', type: 'pcrr', title: 'Post-Production Cost Recovery Ratio: NGL ÷ Deductions. Over 100% is favorable.' },
            { key: '_net_return', label: 'Net Return', type: 'currency', title: 'NGL Returned minus Deductions' },
            { key: 'variance_points', label: 'Variance', type: 'variance', title: 'Points above county average' },
            { key: 'county', label: 'County', type: 'string', transform: cleanCountyName },
            { key: 'county_avg_pct', label: 'County Avg', type: 'percent' },
            { key: 'total_gross', label: 'Total Gross', type: 'currency' },
            { key: '_residue_deductions', label: 'Deductions', type: 'currency', title: 'Product 5 - Residue Gas processing fees' },
            { key: '_ngl_returned', label: 'NGL Returned', type: 'currency', title: 'Product 6 - Value returned from plant' }
        ];

        let currentSort = { key: 'agg_deduction_pct', dir: 'desc' }; // Default sort

        // Helper to extract PCRR metrics from well products
        function getWellPcrrMetrics(well) {
            const prod5 = well.products.find(p => p.product_code === '5');
            const prod6 = well.products.find(p => p.product_code === '6');
            const residueDeductions = prod5 ? prod5.market_deduction : 0;
            const nglReturned = prod6 ? prod6.gross_value : 0;
            const netReturn = nglReturned - residueDeductions;
            const pcrr = residueDeductions > 0 ? Math.round((nglReturned / residueDeductions) * 1000) / 10 : null;
            return { residueDeductions, nglReturned, netReturn, pcrr };
        }

        function sortData(data, key, dir) {
            return [...data].sort((a, b) => {
                let aVal = a[key];
                let bVal = b[key];

                // Handle computed columns
                if (key === '_residue_deductions') {
                    aVal = getWellPcrrMetrics(a).residueDeductions;
                    bVal = getWellPcrrMetrics(b).residueDeductions;
                } else if (key === '_ngl_returned') {
                    aVal = getWellPcrrMetrics(a).nglReturned;
                    bVal = getWellPcrrMetrics(b).nglReturned;
                } else if (key === '_net_return') {
                    aVal = getWellPcrrMetrics(a).netReturn;
                    bVal = getWellPcrrMetrics(b).netReturn;
                } else if (key === '_pcrr') {
                    aVal = getWellPcrrMetrics(a).pcrr;
                    bVal = getWellPcrrMetrics(b).pcrr;
                }

                // Handle nulls
                if (aVal == null && bVal == null) return 0;
                if (aVal == null) return dir === 'asc' ? 1 : -1;
                if (bVal == null) return dir === 'asc' ? -1 : 1;

                // String comparison
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    return dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }

                // Numeric comparison
                return dir === 'asc' ? aVal - bVal : bVal - aVal;
            });
        }

        function handleSort(key) {
            // Toggle direction if same column, otherwise default to desc for numbers, asc for strings
            if (currentSort.key === key) {
                currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                const col = FLAGGED_WELLS_COLUMNS.find(c => c.key === key);
                currentSort = { key, dir: col && col.type === 'string' ? 'asc' : 'desc' };
            }
            renderFlaggedWellsTable();
        }

        function renderSortArrow(key) {
            if (currentSort.key !== key) {
                return '<span class="sort-arrows"><span class="sort-arrow">▲</span><span class="sort-arrow">▼</span></span>';
            }
            return currentSort.dir === 'asc'
                ? '<span class="sort-arrows"><span class="sort-arrow active">▲</span><span class="sort-arrow">▼</span></span>'
                : '<span class="sort-arrows"><span class="sort-arrow">▲</span><span class="sort-arrow active">▼</span></span>';
        }

        function renderTableHeader() {
            return FLAGGED_WELLS_COLUMNS.map(col => {
                const classes = [col.sticky, col.printHide ? 'print-hide' : '', 'sortable'].filter(Boolean).join(' ');
                const titleAttr = col.title ? ` title="${escapeHtml(col.title)}"` : '';
                return `<th class="${classes}"${titleAttr} onclick="handleSort('${col.key}')">${escapeHtml(col.label)}${renderSortArrow(col.key)}</th>`;
            }).join('');
        }

        function renderFlaggedWellsTable() {
            if (!lastReportData || !lastReportData.flaggedWells) return;

            const sorted = sortData(lastReportData.flaggedWells, currentSort.key, currentSort.dir);

            // Update header arrows
            const thead = document.querySelector('#flaggedWellsBody')?.closest('table')?.querySelector('thead tr');
            if (thead) {
                thead.innerHTML = renderTableHeader();
            }

            // Render body
            const tbody = document.getElementById('flaggedWellsBody');
            if (!tbody) return;

            let html = '';
            for (const well of sorted) {
                html += renderWellRow(well);
            }
            tbody.innerHTML = html;

            // Restore expanded state
            for (const api of expandedWells) {
                const detailRow = document.getElementById('detail-' + api);
                const expandIcon = document.getElementById('expand-' + api);
                if (detailRow) detailRow.style.display = 'table-row';
                if (expandIcon) expandIcon.className = 'expand-icon open';
            }
        }

        function renderWellRow(well) {
            const countyAvg = well.county_avg_pct != null ? well.county_avg_pct + '%' : '—';
            const variance = well.variance_points != null ? '+' + well.variance_points + ' pts' : '—';

            // Context-aware styling:
            // - lean_gas_expected: suppress warning colors (high deductions are normal)
            // - oil_only_verify: informational indicator, not a warning
            const isContextual = well.lean_gas_expected || well.oil_only_verify;
            const pctClass = isContextual ? '' : deductionClass(well.agg_deduction_pct);
            const priorityClass = isContextual ? 'priority-info'
                : well.agg_deduction_pct > 50 ? 'priority-high' : 'priority-medium';

            // PCRR metrics
            const metrics = getWellPcrrMetrics(well);
            const pcrrClass = isContextual ? ''
                : metrics.pcrr == null ? ''
                : metrics.pcrr >= 100 ? 'value-success'
                : metrics.pcrr >= 30 ? '' : 'value-warning';
            const netReturnClass = isContextual ? ''
                : metrics.netReturn >= 0 ? 'value-success'
                : metrics.netReturn > -10000 ? '' : 'value-danger';

            // Context badge for lean gas / oil-only wells
            let contextBadge = '';
            if (well.lean_gas_expected) {
                contextBadge = ' <span class="context-badge expected" title="Lean gas well — high deductions are expected due to gas composition">Expected</span>';
            } else if (well.oil_only_verify) {
                contextBadge = ' <span class="context-badge verify" title="Oil-only well with elevated deductions — verify production data">&#8505; Verify</span>';
            }

            // Variance color: red >15pts, orange >8pts
            const varianceClass = !isContextual && well.variance_points != null
                ? (well.variance_points > 15 ? 'value-danger' : well.variance_points > 8 ? 'value-warning' : '')
                : '';

            // Operator cell — two-line layout: name on top, badges below
            const opNameHtml = well.operator_number
                ? `<span class="op-name" onclick="event.stopPropagation(); openOperatorDetail('${escapeHtml(well.operator_number)}')" title="${escapeHtml(well.operator || '')}">${escapeHtml(well.operator || '—')}</span>`
                : escapeHtml(well.operator || '—');
            const affBadge = well.is_affiliated ? '<span class="affiliated-badge" style="font-size: 0.6rem; padding: 0.1rem 0.35rem;">Affiliated</span>' : '';
            const gorBadge = gasProfileBadge(well.gas_profile, false);
            const hasBadges = affBadge || gorBadge;

            return `
                <tr class="well-row ${priorityClass}" onclick="toggleWellDetail('${well.api_number}')">
                    <td class="sticky sticky-well"><span class="expand-icon" id="expand-${well.api_number}">&#9654;</span>${escapeHtml(well.well_name)}${contextBadge}</td>
                    <td class="sticky sticky-operator"><div class="op-cell"><div class="op-name-line">${opNameHtml}</div>${hasBadges ? `<div class="op-badges">${affBadge}${gorBadge}</div>` : ''}</div></td>
                    <td class="${pctClass}">${well.agg_deduction_pct}%</td>
                    <td class="${pcrrClass}">${metrics.pcrr != null ? metrics.pcrr + '%' : '—'}</td>
                    <td class="${netReturnClass}">${formatCurrencyFull(metrics.netReturn)}</td>
                    <td class="${varianceClass}">${variance}</td>
                    <td>${escapeHtml(cleanCountyName(well.county))}</td>
                    <td>${countyAvg}</td>
                    <td>${formatCurrencyFull(well.total_gross)}</td>
                    <td>${formatCurrencyFull(metrics.residueDeductions)}</td>
                    <td>${formatCurrencyFull(metrics.nglReturned)}</td>
                </tr>
                <tr class="well-detail-row" id="detail-${well.api_number}" style="display: none;">
                    <td colspan="11">${buildWellDetail(well)}</td>
                </tr>
            `;
        }

        let deductionCurrentTab = 'properties';
        let deductionResearchLoaded = false;
        let lastOperatorData = null;
        let deductionInitialTab = null;
        let marketsSort = { key: 'deduction_ratio', dir: 'desc' };
        let marketsOperators = [];

        async function loadDeductionReport(initialTab) {
            // Push history so back button returns to intelligence home
            history.pushState({ intelView: 'report' }, '');
            intelViewOpen = 'report';
            // Set report type for print functionality
            currentReportType = 'deduction-audit';
            deductionResearchLoaded = false;
            deductionInitialTab = initialTab || 'properties';

            // Show report viewer, hide main page content
            const main = document.querySelector('main');
            const hero = document.querySelector('.intel-hero');
            const viewer = document.getElementById('reportViewer');
            if (main) main.style.display = 'none';
            if (hero) hero.style.display = 'none';
            viewer.style.display = 'block';
            window.scrollTo(0, 0);

            // Update header for deduction report
            document.getElementById('reportBreadcrumb').textContent = 'Residue Gas Deduction Audit';
            document.getElementById('reportTitle').textContent = 'Residue Gas Deduction Audit Report';
            document.getElementById('reportContent').innerHTML = '<div class="report-loading">Analyzing deduction data across your portfolio...</div>';
            document.getElementById('reportSubtitle').textContent = 'Loading...';
            document.getElementById('reportStatus').textContent = '';
            document.getElementById('reportStatus').className = 'report-status';
            document.getElementById('reportMeta').textContent = '';

            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 20000);

                // Fetch deduction report and operator comparison in parallel
                const [deductionResponse, operatorResponse] = await Promise.all([
                    fetch('/api/intelligence/deduction-report', {
                        credentials: 'include',
                        signal: controller.signal
                    }),
                    fetch('/api/intelligence/operator-comparison', {
                        credentials: 'include',
                        signal: controller.signal
                    })
                ]);

                if (!deductionResponse.ok) {
                    throw new Error('Deduction API returned ' + deductionResponse.status);
                }

                const data = await deductionResponse.json();
                let operatorData = null;
                if (operatorResponse.ok) {
                    operatorData = await operatorResponse.json();
                }

                renderDeductionReport(data, operatorData);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Deduction report request timed out');
                } else {
                    console.error('Failed to load deduction report:', error);
                }
                document.getElementById('reportContent').innerHTML = `
                    <div class="report-error">
                        <p>Could not load the deduction report. Please try again.</p>
                        <button class="btn btn-primary" onclick="loadDeductionReport()">Retry</button>
                        <button class="btn btn-ghost" onclick="closeReport()" style="margin-left: 0.5rem;">Back</button>
                    </div>
                `;
            }
        }

        function renderDeductionReport(data, operatorData) {
            const { flaggedWells, portfolio, statewide, summary } = data;
            lastReportData = data;
            lastOperatorData = operatorData;
            expandedWells = new Set();

            // Header
            const counties = [...new Set(flaggedWells.map(w => w.county).filter(Boolean))];
            const highDeductionWells = flaggedWells.filter(w => w.agg_deduction_pct > 50);
            document.getElementById('reportSubtitle').textContent = flaggedWells.length > 0
                ? `${flaggedWells.length} wells analyzed across ${counties.length || '—'} count${counties.length !== 1 ? 'ies' : 'y'}`
                : 'Portfolio deduction analysis';

            if (highDeductionWells.length === 0) {
                document.getElementById('reportStatus').textContent = '';
                document.getElementById('reportStatus').className = 'report-status';
            } else {
                document.getElementById('reportStatus').innerHTML = `${highDeductionWells.length} high`;
                document.getElementById('reportStatus').className = 'report-status neutral';
            }

            const latestFormatted = summary.latest_month ? formatReportMonth(summary.latest_month) : 'N/A';
            document.getElementById('reportMeta').innerHTML = 'Generated ' + new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) + ' · Data through ' + latestFormatted +
                '<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">OTC financial records are typically available with a 2-3 month delay</div>';

            let html = '';

            // HUD Metrics Bar (above tabs)
            const statewideText = statewide && statewide.avg_deduction_pct != null
                ? `vs ${statewide.avg_deduction_pct}% statewide`
                : 'Deduction rate';
            html += `
                <div class="hud-metrics">
                    <div class="hud-badge">
                        <div class="hud-badge-value">${portfolio.avg_deduction_pct}%</div>
                        <div class="hud-badge-content">
                            <div class="hud-badge-label">Portfolio Avg</div>
                            <div class="hud-badge-status">${statewideText}</div>
                        </div>
                    </div>
                    <div class="hud-badge">
                        <div class="hud-badge-value">${highDeductionWells.length}</div>
                        <div class="hud-badge-content">
                            <div class="hud-badge-label">High (&gt;50%)</div>
                            <div class="hud-badge-status">${summary.flagged_count} total shown</div>
                        </div>
                    </div>
                    <div class="hud-badge">
                        <div class="hud-badge-value">${portfolio.total_wells_analyzed}</div>
                        <div class="hud-badge-content">
                            <div class="hud-badge-label">Wells Analyzed</div>
                            <div class="hud-badge-status">${summary.analysis_period}</div>
                        </div>
                    </div>
                </div>
            `;

            // Tab Navigation
            const operatorCount = operatorData && operatorData.operators ? operatorData.operators.length : 0;
            const initialTab = deductionInitialTab || 'properties';
            html += `
                <div class="pooling-tabs">
                    <button class="pooling-tab ${initialTab === 'properties' ? 'active' : ''}" data-tab="properties" onclick="switchDeductionTab('properties')">
                        My Portfolio <span class="tab-badge">${summary.flagged_count || 0}</span>
                    </button>
                    <button class="pooling-tab ${initialTab === 'markets' ? 'active' : ''}" data-tab="markets" onclick="switchDeductionTab('markets')">
                        My Markets <span class="tab-badge">${operatorCount}</span>
                    </button>
                    <button class="pooling-tab ${initialTab === 'research' ? 'active' : ''}" data-tab="research" onclick="switchDeductionTab('research')">
                        Market Research
                    </button>
                </div>
            `;

            // Tab Content Panels
            html += `<div id="deduction-tab-contents">`;

            // TAB 1: MY PROPERTIES
            html += `<div id="deduction-tab-properties" class="pooling-tab-content ${initialTab === 'properties' ? 'active' : ''}" style="${initialTab !== 'properties' ? 'display:none;' : ''}">`;
            html += renderDeductionPropertiesTab(data);
            html += `</div>`;

            // TAB 2: MY MARKETS
            html += `<div id="deduction-tab-markets" class="pooling-tab-content ${initialTab === 'markets' ? 'active' : ''}" style="${initialTab !== 'markets' ? 'display:none;' : ''}">`;
            html += renderDeductionMarketsTab(operatorData);
            html += `</div>`;

            // TAB 3: MARKET RESEARCH (lazy-loaded)
            html += `<div id="deduction-tab-research" class="pooling-tab-content ${initialTab === 'research' ? 'active' : ''}" style="${initialTab !== 'research' ? 'display:none;' : ''}">`;
            html += '<div id="deduction-research-content"><div class="report-loading">Loading market research data...</div></div>';
            html += `</div>`;

            html += `</div>`; // Close tab contents

            // Footer
            html += `
                <div class="report-footer">
                    <p>
                        Data sourced from Oklahoma Tax Commission gross production reports.
                        <br>Analysis date: ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                    </p>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
            deductionCurrentTab = initialTab;

            // Render the sortable markets table
            renderMarketsTable();

            // If starting on Market Research tab, trigger lazy load
            if (initialTab === 'research') {
                loadDeductionResearch();
            }
        }

        function renderDeductionPropertiesTab(data) {
            const { flaggedWells, portfolio, statewide, summary } = data;
            const highDeductionWells = flaggedWells.filter(w => w.agg_deduction_pct > 50);

            if (flaggedWells.length === 0) {
                const emptyStatewideText = statewide && statewide.avg_deduction_pct != null
                    ? `vs ${statewide.avg_deduction_pct}% statewide`
                    : 'Deduction rate';
                return `
                    <div class="report-summary-card">
                        <h2 class="report-summary-title">Summary</h2>
                        <p class="report-summary-text">
                            <strong>${portfolio.total_wells_analyzed} wells</strong> with OTC financial data were analyzed
                            over the past ${summary.analysis_period}. No wells exceeded the 25% aggregate deduction threshold.
                            Your portfolio average is <strong>${portfolio.avg_deduction_pct}%</strong> (${emptyStatewideText}).
                        </p>
                    </div>
                `;
            }

            const worstWell = flaggedWells[0];
            let html = '';

            // Executive Summary
            const latestMonth = summary.latest_month || '';
            const latestDate = latestMonth ? formatReportMonth(latestMonth) : '';

            html += `
                <div class="report-summary-card">
                    <h2 class="report-summary-title">Summary</h2>
                    <p class="report-meta-line print-only">Analysis Period: ${summary.analysis_period}${latestDate ? ' (through ' + latestDate + ')' : ''}</p>
                    <p class="report-summary-text">
                        Based on analysis of <strong>${portfolio.total_wells_analyzed}</strong> wells with OTC financial records<sup class="print-only">1</sup><span class="info-icon screen-only" title="All wells with financial data are analyzed. Each well is classified by its Gas-Oil Ratio (GOR) to provide context — lean gas wells with high deductions are marked as expected, while oil-only wells are flagged for data verification.">ⓘ</span>,
                        <strong>${summary.flagged_count} well${summary.flagged_count !== 1 ? 's' : ''}</strong>
                        ha${summary.flagged_count !== 1 ? 've' : 's'} aggregate deductions above 25%.
                        Of these, <strong>${highDeductionWells.length}</strong> exceed 50%.
                        The highest rate is <strong>${summary.worst_deduction_pct}%</strong> on ${escapeHtml(worstWell.well_name)}.
                        Your portfolio average is <strong>${portfolio.avg_deduction_pct}%</strong>.
                    </p>
                    <p class="report-footnote print-only"><sup>1</sup> All wells with OTC financial data are included. Gas-Oil Ratio (GOR) classification provides context for single-product wells.</p>
                </div>
            `;

            // Comparison Bar Chart
            const worstPct = summary.worst_deduction_pct;
            const portfolioPct = portfolio.avg_deduction_pct;
            const countyAvgPct = worstWell.county_avg_pct;
            const maxPct = Math.max(worstPct, portfolioPct, countyAvgPct || 0, 10);

            html += `
                <div class="chart-section">
                    <h3 class="chart-title">Deduction Rate Comparison</h3>
                    <div class="bar-chart">
                        <div class="bar-row">
                            <div class="bar-label">${escapeHtml(worstWell.well_name)}</div>
                            <div class="bar-container">
                                <div class="bar-fill bar-flagged" style="width: ${Math.round((worstPct / maxPct) * 100)}%;">
                                    <span class="bar-value">${worstPct}%</span>
                                </div>
                            </div>
                        </div>
                        ${countyAvgPct != null ? `
                        <div class="bar-row">
                            <div class="bar-label">${escapeHtml(cleanCountyName(worstWell.county))} County Avg</div>
                            <div class="bar-container">
                                <div class="bar-fill bar-county" style="width: ${Math.max(Math.round((countyAvgPct / maxPct) * 100), 8)}%;">
                                    <span class="bar-value">${countyAvgPct}%</span>
                                </div>
                            </div>
                        </div>` : ''}
                        <div class="bar-row">
                            <div class="bar-label">Portfolio Average</div>
                            <div class="bar-container">
                                <div class="bar-fill bar-portfolio" style="width: ${Math.max(Math.round((portfolioPct / maxPct) * 100), 8)}%;">
                                    <span class="bar-value">${portfolioPct}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Print-only Summary Table
            const topOffenders = flaggedWells.slice(0, 10);
            html += `
                <div class="print-summary-table">
                    <h3 class="chart-title">Wells by Deduction Rate</h3>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Well</th>
                                <th>Operator</th>
                                <th>County</th>
                                <th>Deduction %</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topOffenders.map(well => `
                                <tr>
                                    <td>${escapeHtml(well.well_name)}</td>
                                    <td>${escapeHtml(well.operator || '—')}</td>
                                    <td>${escapeHtml(cleanCountyName(well.county))}</td>
                                    <td class="${deductionClass(well.agg_deduction_pct)}">${well.agg_deduction_pct}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${flaggedWells.length > 10 ? `<p class="summary-note">+ ${flaggedWells.length - 10} more wells. See full data export for details.</p>` : ''}
                </div>
            `;

            // Per-Well Breakdown Table
            currentSort = { key: 'agg_deduction_pct', dir: 'desc' };
            html += `
                <div class="report-data-section screen-only">
                    <div class="report-data-header">
                        <h3 class="report-data-title">Wells Above 25%</h3>
                        <div class="report-data-actions">
                            <button class="btn btn-ghost" id="expandAllBtn" onclick="toggleExpandAll()" style="font-size: 0.8rem;">Expand All</button>
                            <button class="btn btn-secondary" onclick="exportDeductionCsv()" style="font-size: 0.8rem;">Export CSV</button>
                        </div>
                    </div>
                    <div class="table-scroll-container">
                        <table class="report-data-table">
                            <thead>
                                <tr>${renderTableHeader()}</tr>
                            </thead>
                            <tbody id="flaggedWellsBody">
                                ${flaggedWells.map(well => renderWellRow(well)).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Recommendation Card
            html += `
                <div class="recommendation-card">
                    <h3 class="recommendation-title">Recommended Action</h3>
                    <p class="recommendation-text">
                        Your lease may contain a "market enhancement" or "no deductions" clause that restricts these costs.
                        We recommend reviewing your lease terms and, if warranted, sending a formal inquiry to the operator
                        requesting an itemized breakdown of deductions and citing specific lease provisions.
                    </p>
                    <div class="recommendation-actions">
                        <button class="btn btn-outline-white" onclick="showToast('Lease upload coming in a future update', 'info')">Upload Lease for Review</button>
                    </div>
                </div>
            `;

            html += `
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 1.5rem; line-height: 1.6; max-width: 900px;">
                    <strong style="color: var(--text-secondary);">&#9432; About gas profile classifications</strong><br>
                    Each well is classified by its Gas-Oil Ratio (GOR) using lifetime production volumes:
                    <strong>Lean Gas</strong> (GOR &gt; 15,000 or pure gas) = low NGL expected;
                    <strong>Rich Gas</strong> (GOR &lt; 3,000) = NGL recovery expected;
                    <strong>Mixed</strong> = transitional.
                    Wells tagged &ldquo;Lean Gas&rdquo; may legitimately show high deductions with low NGL returns &mdash; this reflects gas composition, not processing inefficiency.
                    Wells tagged &ldquo;Rich Gas&rdquo; with low NGL returns may warrant review of your lease terms and operator reporting.
                </div>
            `;

            return html;
        }

        function renderDeductionMarketsTab(operatorData) {
            if (!operatorData || !operatorData.operators || operatorData.operators.length === 0) {
                return `
                    <div class="report-summary-card">
                        <h2 class="report-summary-title">No Operator Data</h2>
                        <p class="report-summary-text">
                            We couldn't find operator data for your wells. This may happen if your wells haven't been
                            linked to OTC production records yet.
                        </p>
                    </div>
                `;
            }

            const { operators, statewide, analysis_period } = operatorData;
            const criticalOps = operators.filter(op => op.deduction_ratio > 40 && op.your_wells > 20);
            const statewideAvg = statewide ? statewide.deduction_ratio : null;

            let html = '';

            // Statewide context HUD
            if (statewide) {
                html += `
                    <div class="hud-metrics" style="margin-top: 0.5rem;">
                        <div class="hud-badge">
                            <div class="hud-badge-value">${statewide.deduction_ratio}%</div>
                            <div class="hud-badge-content">
                                <div class="hud-badge-label">Statewide Deduction Ratio</div>
                                <div class="hud-badge-status">Median baseline</div>
                            </div>
                        </div>
                        <div class="hud-badge">
                            <div class="hud-badge-value">${statewide.ngl_recovery_ratio != null ? statewide.ngl_recovery_ratio + '%' : '—'}</div>
                            <div class="hud-badge-content">
                                <div class="hud-badge-label">Statewide NGL Recovery</div>
                                <div class="hud-badge-status">Liquids vs deductions</div>
                            </div>
                        </div>
                        <div class="hud-badge">
                            <div class="hud-badge-value">${operators.length}</div>
                            <div class="hud-badge-content">
                                <div class="hud-badge-label">Your Operators</div>
                                <div class="hud-badge-status">In this report</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Critical operator callout
            if (criticalOps.length > 0) {
                const calloutItems = criticalOps.map(op => {
                    const aboveAvg = statewideAvg != null ? ` — significantly above the statewide average of ${statewideAvg}%` : '';
                    const netReturn = (op.liquids_returned || 0) - (op.residue_deductions || 0);
                    const pcrr = op.residue_deductions > 0 ? Math.round((op.liquids_returned / op.residue_deductions) * 1000) / 10 : null;
                    const dollarDetail = op.residue_deductions > 0
                        ? `. Across all their wells, deductions totaled ${formatCurrencyShort(op.residue_deductions)} with ${formatCurrencyShort(op.liquids_returned)} in NGL returned${pcrr != null ? ` (${pcrr}% PCRR)` : ''}`
                        : '';
                    return `<strong>${escapeHtml(op.operator_name)}</strong> manages ${op.your_wells} of your wells with a ${op.deduction_ratio}% deduction ratio${aboveAvg}${dollarDetail}`;
                }).join('. ');
                const anyAffiliated = criticalOps.some(op => op.is_affiliated);
                const affiliatedSentence = anyAffiliated
                    ? ' ' + criticalOps.filter(op => op.is_affiliated).map(op => `${escapeHtml(op.operator_name)} pays processing deductions to affiliated companies.`).join(' ')
                    : '';

                html += `
                    <div class="report-summary-card" style="border-left: 4px solid var(--danger-red); background: var(--danger-red-light);">
                        <h2 class="report-summary-title" style="color: var(--danger-red);">High-Impact Operator${criticalOps.length > 1 ? 's' : ''} Detected</h2>
                        <p class="report-summary-text">
                            ${calloutItems}. Operators with high deduction ratios across a large number of your wells have an outsized impact on your net revenue. Consider reviewing these deductions closely.${affiliatedSentence}
                        </p>
                    </div>
                `;
            }

            // Explanation card
            html += `
                <div class="report-summary-card">
                    <h2 class="report-summary-title">About This Data</h2>
                    <p class="report-summary-text">
                        This report shows deduction ratios and NGL recovery ratios for operators associated with your wells.
                        <strong>Deduction Ratio</strong> = Residue Gas deductions as a percentage of total gross value.
                        <strong>NGL Recovery Ratio</strong> = NGL/Casinghead value returned as a percentage of Residue Gas deductions.
                        Higher NGL recovery means more value returned relative to processing costs.
                        NGL Recovery Ratios above 100% indicate the operator is returning more NGL value than they are deducting in processing costs, which is a positive outcome.
                    </p>
                </div>
            `;

            // Store operators for sorting and build critical set
            marketsOperators = operators;
            const criticalOpNames = new Set(criticalOps.map(op => op.operator_name));

            // Operator table — container for sortable re-rendering
            html += `
                <div class="report-data-section">
                    <div class="report-data-header">
                        <h3 class="report-data-title">Your Operators</h3>
                        <div class="report-data-actions">
                            <button class="btn btn-secondary" onclick="exportOperatorCsv()" style="font-size: 0.8rem;">Export Data</button>
                        </div>
                    </div>
                    <div id="marketsOperatorTable"></div>
                    ${statewide ? `<p class="table-footnote">Statewide median: ${statewide.deduction_ratio}% deduction ratio, ${statewide.ngl_recovery_ratio != null ? statewide.ngl_recovery_ratio + '%' : '—'} NGL recovery</p>` : ''}
                </div>
            `;

            html += `
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 1.5rem; line-height: 1.6; max-width: 900px;">
                    <strong style="color: var(--text-secondary);">&#9432; About gas profile classifications</strong><br>
                    Each operator is classified by the Gas-Oil Ratio (GOR) of their well portfolio:
                    <strong>Lean Gas</strong> (&gt;70% of wells GOR &gt; 15,000) = low NGL expected;
                    <strong>Rich Gas</strong> (&gt;70% of wells GOR &lt; 3,000) = NGL recovery expected;
                    <strong>Mixed</strong> = transitional portfolio.
                    Operators tagged &ldquo;Primarily Lean Gas&rdquo; may legitimately show high deductions with low PCRR.
                    Operators tagged &ldquo;Primarily Rich Gas&rdquo; with low PCRR may warrant closer review.
                </div>
            `;

            return html;
        }

        function marketsSortArrow(key) {
            if (marketsSort.key !== key) return '';
            return marketsSort.dir === 'asc' ? ' &#9650;' : ' &#9660;';
        }

        function sortMarketsTable(key) {
            if (marketsSort.key === key) {
                marketsSort.dir = marketsSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                marketsSort.key = key;
                marketsSort.dir = key === 'operator_name' ? 'asc' : 'desc';
            }
            renderMarketsTable();
        }

        function renderMarketsTable() {
            const container = document.getElementById('marketsOperatorTable');
            if (!container || !marketsOperators || marketsOperators.length === 0) return;

            const criticalOps = marketsOperators.filter(op => op.deduction_ratio > 40 && op.your_wells > 20);
            const criticalOpNames = new Set(criticalOps.map(op => op.operator_name));

            const sorted = [...marketsOperators].sort((a, b) => {
                const dir = marketsSort.dir === 'asc' ? 1 : -1;
                const key = marketsSort.key;
                if (key === 'operator_name') return dir * (a.operator_name || '').localeCompare(b.operator_name || '');
                if (key === 'affiliated') return dir * ((a.is_affiliated ? 1 : 0) - (b.is_affiliated ? 1 : 0));
                let aVal, bVal;
                if (key === '_net_return') {
                    aVal = (a.liquids_returned || 0) - (a.residue_deductions || 0);
                    bVal = (b.liquids_returned || 0) - (b.residue_deductions || 0);
                } else if (key === '_pcrr') {
                    aVal = a.residue_deductions > 0 ? (a.liquids_returned / a.residue_deductions) * 100 : -Infinity;
                    bVal = b.residue_deductions > 0 ? (b.liquids_returned / b.residue_deductions) * 100 : -Infinity;
                } else {
                    aVal = a[key] ?? -Infinity;
                    bVal = b[key] ?? -Infinity;
                }
                return dir * (aVal - bVal);
            });

            let html = `
                <div class="table-scroll-container">
                    <table class="report-data-table" style="min-width: 1000px;">
                        <thead>
                            <tr>
                                <th class="sticky sticky-well sortable" onclick="sortMarketsTable('operator_name')">Operator${marketsSortArrow('operator_name')}</th>
                                <th class="sortable" onclick="sortMarketsTable('affiliated')">Affiliated${marketsSortArrow('affiliated')}</th>
                                <th class="sortable text-right" onclick="sortMarketsTable('your_wells')" style="white-space: nowrap;">Your<br>Wells${marketsSortArrow('your_wells')}</th>
                                <th class="sortable text-right" onclick="sortMarketsTable('total_wells')" style="white-space: nowrap;">Total<br>Wells${marketsSortArrow('total_wells')}</th>
                                <th class="sortable text-right" onclick="sortMarketsTable('total_gross')" style="white-space: nowrap;">Total<br>Gross${marketsSortArrow('total_gross')}</th>
                                <th class="sortable text-right" onclick="sortMarketsTable('residue_deductions')">Deductions${marketsSortArrow('residue_deductions')}</th>
                                <th class="sortable text-right" onclick="sortMarketsTable('deduction_ratio')" style="white-space: nowrap;">Ded %${marketsSortArrow('deduction_ratio')}</th>
                                <th class="sortable text-right" onclick="sortMarketsTable('liquids_returned')" style="white-space: nowrap;">NGL<br>Returned${marketsSortArrow('liquids_returned')}</th>
                                <th class="sortable text-right" onclick="sortMarketsTable('_net_return')" style="white-space: nowrap;">Net<br>Return${marketsSortArrow('_net_return')}</th>
                                <th class="sortable text-right" onclick="sortMarketsTable('_pcrr')">PCRR${marketsSortArrow('_pcrr')}</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sorted.forEach(op => {
                const isCritical = criticalOpNames.has(op.operator_name);
                const badge = isCritical ? ' <span class="status-badge status-critical" style="font-size: 0.6rem; padding: 0.15rem 0.4rem; margin-left: 0.5rem;">High Impact</span>' : '';
                const affiliatedBadge = op.is_affiliated
                    ? '<span class="affiliated-badge" style="font-size: 0.6rem; padding: 0.1rem 0.35rem;">Affiliated</span>'
                    : '<span class="third-party-badge" style="font-size: 0.6rem; padding: 0.1rem 0.35rem;">Third Party</span>';
                const netReturn = (op.liquids_returned || 0) - (op.residue_deductions || 0);
                const pcrr = op.residue_deductions > 0
                    ? Math.round((op.liquids_returned / op.residue_deductions) * 1000) / 10
                    : null;
                const sideIndicator = netReturn <= -5000000
                    ? 'box-shadow: inset 4px 0 0 var(--danger-red);'
                    : netReturn <= -1000000
                    ? 'box-shadow: inset 4px 0 0 var(--warning-amber);'
                    : '';
                const returnColor = netReturn <= -5000000 ? 'color: #ef4444;'
                    : netReturn <= -1000000 ? 'color: #f97316;'
                    : '';
                const pcrrClass = pcrr == null ? ''
                    : pcrr >= 100 ? 'value-success'
                    : pcrr >= 30 ? '' : 'value-danger';
                html += `
                    <tr>
                        <td class="sticky sticky-well" style="${sideIndicator}">
                            <div class="op-name" style="cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" onclick="openOperatorDetail('${escapeHtml(op.operator_number)}')" title="${escapeHtml(op.operator_name)}">${escapeHtml(op.operator_name)}${badge}</div>
                            <div class="op-meta">#${escapeHtml(op.operator_number)}${gasProfileBadge(op.gas_profile, true)}</div>
                        </td>
                        <td>${affiliatedBadge}</td>
                        <td class="text-right">${op.your_wells}</td>
                        <td class="text-right">${op.total_wells.toLocaleString()}</td>
                        <td class="text-right">${formatCurrencyShort(op.total_gross)}</td>
                        <td class="text-right">${formatCurrencyShort(op.residue_deductions)}</td>
                        <td class="text-right ${op.deduction_ratio > 40 ? 'value-danger' : ''}">${op.deduction_ratio}%</td>
                        <td class="text-right">${formatCurrencyShort(op.liquids_returned)}</td>
                        <td class="text-right" style="${returnColor} font-weight: 600;">${formatCurrencyShort(netReturn)}</td>
                        <td class="text-right ${pcrrClass}">${pcrr != null ? pcrr + '%' : '—'}</td>
                    </tr>`;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function switchDeductionTab(tab) {
            deductionCurrentTab = tab;
            document.querySelectorAll('.pooling-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            document.querySelectorAll('.pooling-tab-content').forEach(content => {
                content.style.display = content.id === 'deduction-tab-' + tab ? 'block' : 'none';
            });
            // Lazy-load Market Research on first visit
            if (tab === 'research' && !deductionResearchLoaded) {
                loadDeductionResearch();
            }
        }

        async function loadDeductionResearch() {
            deductionResearchLoaded = true;
            const container = document.getElementById('deduction-research-content');
            if (!container) return;
            container.innerHTML = '<div class="report-loading">Loading market research data...</div>';

            try {
                const [researchResponse, efficiencyResponse] = await Promise.all([
                    fetch('/api/intelligence/deduction-research', { credentials: 'include' }),
                    fetch('/api/operators/efficiency?limit=1000&min_wells=20', { credentials: 'include' })
                ]);

                let researchData = null;
                if (researchResponse.ok) {
                    researchData = await researchResponse.json();
                }

                let efficiencyData = null;
                if (efficiencyResponse.ok) {
                    efficiencyData = await efficiencyResponse.json();
                }

                container.innerHTML = renderDeductionResearchContent(researchData, efficiencyData);
                setupInlineEfficiency(efficiencyData);
            } catch (error) {
                console.error('Failed to load deduction research:', error);
                container.innerHTML = `
                    <div class="report-error">
                        <p>Could not load market research data. Please try again.</p>
                        <button class="btn btn-primary" onclick="loadDeductionResearch()">Retry</button>
                    </div>
                `;
            }
        }

        let inlineEfficiencyOperators = [];
        let inlineEfficiencyAll = [];
        let inlineEfficiencySort = { key: 'well_count', dir: 'desc' };
        let inlineEfficiencySearch = '';

        function renderDeductionResearchContent(researchData, efficiencyData) {
            let html = '';

            // Section 1: Breakdown Cards
            html += `
                <p class="pooling-tab-intro">
                    Statewide deduction and efficiency intelligence from OTC financial data.
                </p>
                <div class="pooling-insight-cards">
            `;

            // Top Deduction Counties
            const topCounties = researchData ? researchData.topDeductionCounties || [] : [];
            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Highest Deduction Counties</div>
                    ${topCounties.length > 0 ? topCounties.map(c => `
                        <div class="insight-top-item">
                            <span class="insight-item-name">${escapeHtml(c.county)}</span>
                            <span class="insight-item-val">${c.avg_deduction_pct}%<span class="insight-item-sub">${c.well_count} wells</span></span>
                        </div>
                    `).join('') : '<div class="pooling-empty">No data</div>'}
                </div>
            `;

            // Top PCRR Operators
            const topPcrr = researchData ? researchData.topPcrrOperators || [] : [];
            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Most Efficient Operators (PCRR)</div>
                    ${topPcrr.length > 0 ? topPcrr.map(op => `
                        <div class="insight-top-item">
                            <span class="insight-item-name">${escapeHtml(op.operator_name)}</span>
                            <span class="insight-item-val">${op.pcrr}%<span class="insight-item-sub">${op.well_count} wells</span></span>
                        </div>
                    `).join('') : '<div class="pooling-empty">No data</div>'}
                </div>
            `;

            // Top Net Return Operators
            const topReturn = researchData ? researchData.topNetReturnOperators || [] : [];
            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Highest Net Return</div>
                    ${topReturn.length > 0 ? topReturn.map(op => `
                        <div class="insight-top-item">
                            <span class="insight-item-name">${escapeHtml(op.operator_name)}</span>
                            <span class="insight-item-val">${formatCurrencyShort(op.net_value_return)}<span class="insight-item-sub">${op.well_count} wells</span></span>
                        </div>
                    `).join('') : '<div class="pooling-empty">No data</div>'}
                </div>
            `;

            html += `</div>`;

            // Section Divider
            html += `
                <div style="margin: 2rem 0 1.5rem; border-top: 2px solid var(--border); padding-top: 1.5rem;">
                    <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--oil-navy); margin-bottom: 0.25rem;">Operator Efficiency Index</h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">Compare deduction efficiency across Oklahoma operators with 20+ wells</p>
                </div>
            `;

            // Efficiency Index toolbar
            html += `
                <div class="pooling-toolbar" style="margin-bottom: 1rem;">
                    <div class="pooling-search-box">
                        <span class="search-icon">&#8981;</span>
                        <input type="text" id="inlineEfficiencySearch" placeholder="Search operators..." oninput="filterInlineEfficiency()">
                    </div>
                    <div class="pooling-filter-group">
                        <label class="filter-label">Min Wells</label>
                        <select id="inlineEfficiencyMinWells" class="pooling-filter-select" onchange="filterInlineEfficiency()">
                            <option value="5">5+ wells</option>
                            <option value="10">10+ wells</option>
                            <option value="20" selected>20+ wells</option>
                            <option value="50">50+ wells</option>
                        </select>
                    </div>
                    <button class="pooling-btn-export" onclick="exportInlineEfficiencyCsv()">&#10516; Export CSV</button>
                </div>
            `;

            // Efficiency table container
            html += `<div id="inlineEfficiencyTable"></div>`;

            return html;
        }

        function setupInlineEfficiency(efficiencyData) {
            if (!efficiencyData || !efficiencyData.operators) {
                document.getElementById('inlineEfficiencyTable').innerHTML = '<div class="pooling-empty">No efficiency data available</div>';
                return;
            }
            inlineEfficiencyAll = efficiencyData.operators;
            inlineEfficiencyOperators = [...inlineEfficiencyAll];
            // Populate allEfficiencyOperators so openOperatorDetail() can find names
            if (typeof allEfficiencyOperators !== 'undefined') {
                allEfficiencyOperators = inlineEfficiencyAll;
            }
            inlineEfficiencySort = { key: 'well_count', dir: 'desc' };
            inlineEfficiencySearch = '';
            renderInlineEfficiencyTable();
        }

        function filterInlineEfficiency() {
            const search = (document.getElementById('inlineEfficiencySearch')?.value || '').trim().toLowerCase();
            const minWells = parseInt(document.getElementById('inlineEfficiencyMinWells')?.value || '20');
            inlineEfficiencySearch = search;

            inlineEfficiencyOperators = inlineEfficiencyAll.filter(op => {
                if (op.well_count < minWells) return false;
                if (search && !op.operator_name.toLowerCase().includes(search) && !op.operator_number.includes(search)) return false;
                return true;
            });
            renderInlineEfficiencyTable();
        }

        function sortInlineEfficiency(key) {
            if (inlineEfficiencySort.key === key) {
                inlineEfficiencySort.dir = inlineEfficiencySort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                inlineEfficiencySort.key = key;
                inlineEfficiencySort.dir = key === 'name' ? 'asc' : 'desc';
            }
            renderInlineEfficiencyTable();
        }

        function renderInlineEfficiencySortArrow(key) {
            if (inlineEfficiencySort.key !== key) return '';
            return inlineEfficiencySort.dir === 'asc' ? ' &#9650;' : ' &#9660;';
        }

        function renderInlineEfficiencyTable() {
            const container = document.getElementById('inlineEfficiencyTable');
            if (!container) return;

            if (!inlineEfficiencyOperators || inlineEfficiencyOperators.length === 0) {
                container.innerHTML = '<div class="pooling-empty">' + (inlineEfficiencySearch ? 'No operators match your search' : 'No operators found') + '</div>';
                return;
            }

            // Affiliated stats banner — aggregate per-dollar NGL return
            const affiliatedOps = inlineEfficiencyOperators.filter(op => op.is_affiliated);
            const thirdPartyOps = inlineEfficiencyOperators.filter(op => !op.is_affiliated && op.primary_purchaser_id);
            const affCount = affiliatedOps.length;
            const totalCount = inlineEfficiencyOperators.length;
            let bannerHtml = '';
            if (affCount > 0) {
                const affTotalDed = affiliatedOps.reduce((sum, op) => sum + Math.abs(op.residue_deductions || 0), 0);
                const affTotalNgl = affiliatedOps.reduce((sum, op) => sum + (op.pcrr_value || 0), 0);
                const tpTotalDed = thirdPartyOps.reduce((sum, op) => sum + Math.abs(op.residue_deductions || 0), 0);
                const tpTotalNgl = thirdPartyOps.reduce((sum, op) => sum + (op.pcrr_value || 0), 0);
                const affPerDollar = affTotalDed > 0 ? (affTotalNgl / affTotalDed).toFixed(2) : null;
                const tpPerDollar = tpTotalDed > 0 ? (tpTotalNgl / tpTotalDed).toFixed(2) : null;
                const pct = Math.round(affCount / totalCount * 100);
                const comparisonText = affPerDollar != null && tpPerDollar != null
                    ? ` Affiliated operators return <strong>$${affPerDollar}</strong> in NGL value per $1 deducted. Third-party operators return <strong>$${tpPerDollar}</strong>.`
                    : '';
                bannerHtml = `
                    <div style="background: #fffbeb; border: 1px solid #fde68a; border-radius: 8px; padding: 0.875rem 1.25rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
                        <div style="font-size: 1.5rem; line-height: 1;">&#9888;</div>
                        <div style="font-size: 0.875rem; color: #92400e;">
                            <strong>${affCount} of ${totalCount} operators (${pct}%)</strong> pay processing deductions to affiliated companies.${comparisonText}
                        </div>
                    </div>
                `;
            }

            // Sort
            const sorted = [...inlineEfficiencyOperators].sort((a, b) => {
                const key = inlineEfficiencySort.key;
                const dir = inlineEfficiencySort.dir === 'asc' ? 1 : -1;
                if (key === 'name') return dir * (a.operator_name || '').localeCompare(b.operator_name || '');
                if (key === 'primary_county') return dir * (a.primary_county || '').localeCompare(b.primary_county || '');
                if (key === 'affiliated') return dir * ((a.is_affiliated ? 1 : 0) - (b.is_affiliated ? 1 : 0));
                const aVal = a[key] ?? -Infinity;
                const bVal = b[key] ?? -Infinity;
                return dir * (aVal - bVal);
            });

            const countHtml = inlineEfficiencySearch
                ? `<div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem;">Showing ${inlineEfficiencyOperators.length} of ${inlineEfficiencyAll.length} operators</div>`
                : `<div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem;">${inlineEfficiencyOperators.length} operators</div>`;

            let html = bannerHtml + countHtml + `
                <div class="table-scroll-container">
                    <table class="report-data-table efficiency-table" style="min-width: 1000px;">
                        <thead>
                            <tr>
                                <th class="sticky sortable" style="left: 0; min-width: 200px; max-width: 200px; z-index: 2; background: var(--paper);" onclick="sortInlineEfficiency('name')">Operator${renderInlineEfficiencySortArrow('name')}</th>
                                <th class="sortable" onclick="sortInlineEfficiency('affiliated')">Affiliated${renderInlineEfficiencySortArrow('affiliated')}</th>
                                <th class="text-right sortable" onclick="sortInlineEfficiency('well_count')">Wells${renderInlineEfficiencySortArrow('well_count')}</th>
                                <th class="text-right sortable" onclick="sortInlineEfficiency('deduction_pct')">Ded %${renderInlineEfficiencySortArrow('deduction_pct')}</th>
                                <th class="text-right sortable" onclick="sortInlineEfficiency('pcrr_value')">NGL Returned${renderInlineEfficiencySortArrow('pcrr_value')}</th>
                                <th class="text-right sortable" onclick="sortInlineEfficiency('net_value_return')">Net Return${renderInlineEfficiencySortArrow('net_value_return')}</th>
                                <th class="text-right sortable" onclick="sortInlineEfficiency('pcrr')">PCRR${renderInlineEfficiencySortArrow('pcrr')}</th>
                                <th class="text-right sortable" onclick="sortInlineEfficiency('total_gross')">Total Gross${renderInlineEfficiencySortArrow('total_gross')}</th>
                                <th class="text-right sortable" onclick="sortInlineEfficiency('residue_deductions')">Deductions${renderInlineEfficiencySortArrow('residue_deductions')}</th>
                                <th class="sortable" onclick="sortInlineEfficiency('primary_county')">County${renderInlineEfficiencySortArrow('primary_county')}</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sorted.forEach(op => {
                const pcrrClass = op.pcrr == null ? ''
                    : op.pcrr >= 100 ? 'value-success'
                    : op.pcrr >= 30 ? '' : 'value-danger';
                const returnColor = op.net_value_return == null ? ''
                    : op.net_value_return <= -5000000 ? 'color: #ef4444;'
                    : op.net_value_return <= -1000000 ? 'color: #f97316;'
                    : '';
                const deductPctClass = op.deduction_pct != null && op.deduction_pct > 40 ? 'value-danger' : '';
                // Side indicator on sticky column based on net return severity
                const sideIndicator = op.net_value_return != null && op.net_value_return <= -5000000
                    ? 'box-shadow: inset 4px 0 0 var(--danger-red);'
                    : op.net_value_return != null && op.net_value_return <= -1000000
                    ? 'box-shadow: inset 4px 0 0 var(--warning-amber);'
                    : '';
                const affiliatedBadge = op.is_affiliated
                    ? '<span class="affiliated-badge" title="Operator pays deductions to their own affiliated company">Affiliated</span>'
                    : (op.primary_purchaser_name ? '<span class="third-party-badge">Third Party</span>' : '—');

                html += `
                    <tr>
                        <td class="sticky" style="left: 0; min-width: 200px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; background: white; z-index: 1; ${sideIndicator}">
                            <div class="op-name" style="cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" onclick="openOperatorDetail('${escapeHtml(op.operator_number)}')" title="${escapeHtml(op.operator_name)}">${escapeHtml(op.operator_name)}</div>
                            <div class="op-meta">#${escapeHtml(op.operator_number)}${gasProfileBadge(op.gas_profile, true)}</div>
                        </td>
                        <td>${affiliatedBadge}</td>
                        <td class="text-right">${op.well_count.toLocaleString()}</td>
                        <td class="text-right ${deductPctClass}">${op.deduction_pct != null ? op.deduction_pct + '%' : '—'}</td>
                        <td class="text-right">${formatCurrencyShort(op.pcrr_value)}</td>
                        <td class="text-right" style="${returnColor} font-weight: 600;">${formatCurrencyShort(op.net_value_return)}</td>
                        <td class="text-right ${pcrrClass}">${op.pcrr != null ? op.pcrr + '%' : 'N/A'}${op.gas_profile && op.gas_profile.includes('Rich') && op.pcrr != null && op.pcrr < 50 && op.deduction_pct > 10 ? ' <span title="Rich gas operator with significant deductions but low NGL recovery — may warrant review" style="cursor: help; color: var(--danger-red);">&#9888;</span>' : ''}</td>
                        <td class="text-right">${formatCurrencyShort(op.total_gross)}</td>
                        <td class="text-right">${formatCurrencyShort(op.residue_deductions)}</td>
                        <td>${escapeHtml(op.primary_county || '—')}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            html += `<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 1rem; line-height: 1.6; max-width: 900px;">
                <strong style="color: var(--text-secondary);">&#9432; Methodology &amp; context</strong><br>
                Data sourced from Oklahoma Tax Commission gross production reports, most recent 6-month window. &ldquo;Affiliated&rdquo; indicates the operator&rsquo;s company ID matches the purchaser ID on their wells&rsquo; residue gas deduction records. PCRR (Processing Cost Recovery Ratio) measures NGL value returned as a percentage of processing deductions taken.
                <br><br>
                <strong>Gas profile classifications</strong> use lifetime Gas-Oil Ratio (GOR) from OTC production records:
                <strong>Lean Gas</strong> (&gt;70% of wells GOR &gt; 15,000 or pure gas) = low NGL expected;
                <strong>Rich Gas</strong> (&gt;70% of wells GOR &lt; 3,000) = NGL recovery expected;
                <strong>Mixed</strong> = transitional portfolio.
                Operators tagged &ldquo;Primarily Lean Gas&rdquo; may legitimately show high deductions with low PCRR.
                Operators tagged &ldquo;Primarily Rich Gas&rdquo; with low PCRR (&lt; 50%) are flagged with &#9888; as NGL recovery may warrant review.
            </div>`;
            container.innerHTML = html;
        }

        function formatCurrencyShort(val) {
            if (val == null) return '—';
            const abs = Math.abs(val);
            const sign = val < 0 ? '-' : '';
            if (abs >= 1000000) return sign + '$' + (abs / 1000000).toFixed(1) + 'M';
            if (abs >= 1000) return sign + '$' + (abs / 1000).toFixed(0) + 'K';
            return sign + '$' + abs.toLocaleString();
        }

        function exportInlineEfficiencyCsv() {
            if (!inlineEfficiencyOperators || inlineEfficiencyOperators.length === 0) {
                showToast('No data to export', 'error');
                return;
            }
            const rows = [[
                'Operator',
                'Operator Number',
                'Affiliated',
                'Gas Profile',
                'Wells',
                'Deduction %',
                'NGL Returned',
                'Net Return',
                'PCRR %',
                'Total Gross',
                'Deductions',
                'County',
                'Status',
                'Affiliated Purchaser Name',
                'Affiliated Deduction $',
                'Affiliated Deduction %'
            ].join(',')];
            for (const op of inlineEfficiencyOperators) {
                const affDed = op.is_affiliated ? op.residue_deductions : 0;
                const affPct = op.is_affiliated ? (op.deduction_pct != null ? op.deduction_pct : '') : 0;
                rows.push([
                    csvEscape(op.operator_name),
                    op.operator_number,
                    op.is_affiliated ? 'Yes' : (op.primary_purchaser_id ? 'No' : ''),
                    csvEscape(op.gas_profile || ''),
                    op.well_count,
                    op.deduction_pct != null ? op.deduction_pct : '',
                    op.pcrr_value,
                    op.net_value_return,
                    op.pcrr != null ? op.pcrr : '',
                    op.total_gross,
                    op.residue_deductions,
                    csvEscape(op.primary_county || ''),
                    op.status || '',
                    csvEscape(op.is_affiliated ? (op.primary_purchaser_name || '') : ''),
                    affDed,
                    affPct
                ].join(','));
            }
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'operator-efficiency-' + new Date().toISOString().substring(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        function buildWellDetail(well) {
            let html = '<div class="well-detail-content">';

            // Purchaser info (vertical integration indicator)
            if (well.purchaser_name) {
                const affiliatedBadge = well.is_affiliated
                    ? '<span class="affiliated-badge" title="The gas purchaser is the same entity as the operator">Affiliated</span>'
                    : '<span class="third-party-badge" title="Third-party purchaser">Third Party</span>';
                html += '<div class="purchaser-info">';
                html += '<span class="purchaser-label">Gas Purchaser:</span> ';
                html += '<span class="purchaser-name">' + escapeHtml(well.purchaser_name) + '</span> ';
                html += affiliatedBadge;
                if (well.is_affiliated) {
                    html += '<div class="affiliated-note">This well\'s gas is sold to an entity with the same ID as the operator, which may indicate vertical integration.</div>';
                }
                html += '</div>';
            }

            // Product breakdown
            html += '<h5>Product Breakdown (' + escapeHtml(well.well_name) + ')</h5>';
            html += '<table class="detail-table"><thead><tr><th>Product</th><th>Gross Value</th><th>Deductions</th><th>Rate</th></tr></thead><tbody>';
            for (const p of well.products) {
                const pctClass = deductionClass(p.deduction_pct);
                html += '<tr>';
                html += '<td>' + escapeHtml(p.product_name) + '</td>';
                html += '<td>' + formatCurrencyFull(p.gross_value) + '</td>';
                html += '<td>' + formatCurrencyFull(p.market_deduction) + '</td>';
                html += '<td class="' + pctClass + '">' + p.deduction_pct + '%</td>';
                html += '</tr>';
            }
            html += '</tbody></table>';

            // Residue gas note
            if (well.residueGasNote) {
                html += '<div class="residue-gas-note"><strong>Note:</strong> This well\'s Residue Gas shows high deductions. This is typical when natural gas is processed — the valuable NGLs are extracted and reported separately as Casinghead Gas. The aggregate rate across all products reflects the true economic impact.</div>';
            }

            // GOR context note for lean gas wells
            if (well.gas_profile === 'lean') {
                const hasNoNgl = !well.products || !well.products.some(p => (p.product_code === '3' || p.product_code === '6') && p.gross_value > 100);
                if (hasNoNgl) {
                    html += '<div class="residue-gas-note" style="border-left-color: #94a3b8;"><strong>Lean Gas Well:</strong> This well produces primarily lean/dry gas (GOR > 15,000 MCF/BBL). Low or zero NGL returns are typical for this gas composition. Deductions reflect processing costs to meet pipeline specifications, not necessarily poor economics.</div>';
                }
            } else if (well.gas_profile === 'rich') {
                const hasLowNgl = !well.products || !well.products.some(p => (p.product_code === '3' || p.product_code === '6') && p.gross_value > 500);
                if (hasLowNgl) {
                    html += '<div class="residue-gas-note" style="border-left-color: #ef4444;"><strong>&#9888; Rich Gas Well:</strong> This well produces rich/wet gas (GOR < 3,000 MCF/BBL) where NGL recovery is expected. Low NGL returns with high deductions may warrant review of your lease terms and operator reporting.</div>';
                }
            }

            // Oil-only well context note
            if (well.oil_only_verify) {
                html += '<div class="residue-gas-note" style="border-left-color: #2563eb;"><strong>&#8505; Oil-Only Well:</strong> This well shows only oil production with elevated deductions. Oil wells typically have minimal processing deductions. This may indicate a data reporting anomaly — verify production data with your operator or check-stub detail.</div>';
            }

            // Monthly trend
            if (well.monthly && well.monthly.length > 0) {
                html += '<h5>Monthly Trend</h5>';
                html += '<table class="detail-table"><thead><tr><th>Month</th><th>Gross</th><th>Deductions</th><th>Rate</th><th>Net</th></tr></thead><tbody>';
                for (const m of well.monthly) {
                    const pctClass = deductionClass(m.deduction_pct);
                    html += '<tr>';
                    html += '<td>' + formatReportMonth(m.year_month) + '</td>';
                    html += '<td>' + formatCurrencyFull(m.gross_value) + '</td>';
                    html += '<td>' + formatCurrencyFull(m.market_deduction) + '</td>';
                    html += '<td class="' + pctClass + '">' + m.deduction_pct + '%</td>';
                    html += '<td>' + formatCurrencyFull(m.net_value) + '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table>';
            }

            html += '</div>';
            return html;
        }

        function toggleWellDetail(apiNumber) {
            const detailRow = document.getElementById('detail-' + apiNumber);
            const expandIcon = document.getElementById('expand-' + apiNumber);
            if (!detailRow) return;

            if (expandedWells.has(apiNumber)) {
                detailRow.style.display = 'none';
                if (expandIcon) expandIcon.className = 'expand-icon';
                expandedWells.delete(apiNumber);
            } else {
                detailRow.style.display = 'table-row';
                if (expandIcon) expandIcon.className = 'expand-icon open';
                expandedWells.add(apiNumber);
            }
            updateExpandAllBtn();
        }

        function toggleExpandAll() {
            const detailRows = document.querySelectorAll('.well-detail-row');
            const expandIcons = document.querySelectorAll('.expand-icon');
            const allExpanded = expandedWells.size === detailRows.length;

            if (allExpanded) {
                // Collapse all
                detailRows.forEach(row => { row.style.display = 'none'; });
                expandIcons.forEach(icon => { icon.className = 'expand-icon'; });
                expandedWells.clear();
            } else {
                // Expand all
                detailRows.forEach(row => { row.style.display = 'table-row'; });
                expandIcons.forEach(icon => { icon.className = 'expand-icon open'; });
                if (lastReportData) {
                    lastReportData.flaggedWells.forEach(w => expandedWells.add(w.api_number));
                }
            }
            updateExpandAllBtn();
        }

        function updateExpandAllBtn() {
            const btn = document.getElementById('expandAllBtn');
            const detailRows = document.querySelectorAll('.well-detail-row');
            if (btn) {
                btn.textContent = expandedWells.size === detailRows.length ? 'Collapse All' : 'Expand All';
            }
        }

        function closeReport(fromPopstate) {
            const main = document.querySelector('main');
            const hero = document.querySelector('.intel-hero');
            const viewer = document.getElementById('reportViewer');
            if (main) main.style.display = '';
            if (hero) hero.style.display = '';
            viewer.style.display = 'none';
            intelViewOpen = null;
            if (!fromPopstate) history.back();
            window.scrollTo(0, 0);
        }

        function exportDeductionCsv() {
            if (!lastReportData || !lastReportData.flaggedWells) {
                showToast('No report data to export', 'error');
                return;
            }

            const rows = [];

            // Ultra-flattened header: one row per well
            // Ordered by importance: identifiers, key metrics, summary, then details
            rows.push([
                // Identifiers (1-5)
                'Well Name', 'Operator', 'API Number', 'County', 'Status',
                // Key Metrics (6-10)
                'Deduction %', 'PCRR %', 'Net Return', 'Variance Points', 'County Avg %',
                // Purchaser Info (11-13)
                'Gas Purchaser', 'Purchaser ID', 'Affiliated',
                // Summary (14-16)
                'Total Gross', 'Deductions (Residue)', 'NGL Returned',
                // Current Month Snapshot (17-20)
                'Latest Month', 'Month Gross', 'Month Deductions', 'Month Net',
                // 6-Month Product Breakdown (21-28)
                '6M Oil Gross', '6M Oil Deductions',
                '6M Residue Gas Gross', '6M Residue Gas Deductions',
                '6M Casinghead Gas Gross', '6M Casinghead Gas Deductions',
                '6M NGL Gross', '6M NGL Deductions',
                // Legacy Totals (29-30)
                '6M Total Deductions', '6M Total Net'
            ].join(','));

            for (const well of lastReportData.flaggedWells) {
                const status = well.variance_points != null && well.variance_points > 15
                    ? 'High Priority'
                    : 'Above Average';

                // Get latest month data
                const latestMonth = well.monthly && well.monthly.length > 0 ? well.monthly[0] : null;

                // Extract product values
                const oil = well.products.find(p => p.product_code === '1') || { gross_value: 0, market_deduction: 0 };
                const residueGas = well.products.find(p => p.product_code === '5') || { gross_value: 0, market_deduction: 0 };
                const casingheadGas = well.products.find(p => p.product_code === '6') || { gross_value: 0, market_deduction: 0 };
                const ngl = well.products.find(p => p.product_code === '3') || { gross_value: 0, market_deduction: 0 };

                // PCRR metrics
                const pcrrMetrics = getWellPcrrMetrics(well);

                rows.push([
                    // Identifiers
                    csvEscape(well.well_name),
                    csvEscape(well.operator || ''),
                    well.api_number,
                    csvEscape(cleanCountyName(well.county)),
                    status,
                    // Key Metrics
                    well.agg_deduction_pct + '%',
                    pcrrMetrics.pcrr != null ? pcrrMetrics.pcrr + '%' : '',
                    pcrrMetrics.netReturn,
                    well.variance_points != null ? well.variance_points : '',
                    well.county_avg_pct != null ? well.county_avg_pct + '%' : '',
                    // Purchaser Info
                    csvEscape(well.purchaser_name || ''),
                    well.purchaser_id || '',
                    well.is_affiliated ? 'Yes' : (well.purchaser_id ? 'No' : ''),
                    // Summary
                    well.total_gross,
                    pcrrMetrics.residueDeductions,
                    pcrrMetrics.nglReturned,
                    // Current Month Snapshot
                    latestMonth ? formatReportMonth(latestMonth.year_month) : '',
                    latestMonth ? latestMonth.gross_value : '',
                    latestMonth ? latestMonth.market_deduction : '',
                    latestMonth ? latestMonth.net_value : '',
                    // 6-Month Product Breakdown
                    oil.gross_value || '',
                    oil.market_deduction || '',
                    residueGas.gross_value || '',
                    residueGas.market_deduction || '',
                    casingheadGas.gross_value || '',
                    casingheadGas.market_deduction || '',
                    ngl.gross_value || '',
                    ngl.market_deduction || '',
                    // Legacy Totals
                    well.total_deductions,
                    well.total_net
                ].join(','));
            }

            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'residue-gas-deduction-audit-' + new Date().toISOString().substring(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        function csvEscape(str) {
            if (!str) return '';
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        function exportOperatorCsv() {
            if (!lastOperatorData || !lastOperatorData.operators) {
                showToast('No operator data to export', 'error');
                return;
            }

            const rows = [];
            rows.push([
                'Operator',
                'Affiliated',
                'Gas Profile',
                'Your Wells',
                'Total Wells',
                'Total Gross',
                'Deductions',
                'Deduction %',
                'NGL Returned',
                'Net Return',
                'PCRR %',
                'NGL Recovery %',
                'Operator Number'
            ].join(','));

            for (const op of lastOperatorData.operators) {
                const netReturn = (op.liquids_returned || 0) - (op.residue_deductions || 0);
                const pcrr = op.residue_deductions > 0
                    ? Math.round((op.liquids_returned / op.residue_deductions) * 1000) / 10
                    : '';
                rows.push([
                    csvEscape(op.operator_name),
                    op.is_affiliated ? 'Yes' : 'No',
                    csvEscape(op.gas_profile || ''),
                    op.your_wells,
                    op.total_wells,
                    op.total_gross,
                    op.residue_deductions,
                    op.deduction_ratio,
                    op.liquids_returned,
                    Math.round(netReturn),
                    pcrr,
                    op.ngl_recovery_ratio != null ? op.ngl_recovery_ratio : '',
                    op.operator_number || ''
                ].join(','));
            }

            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'operator-comparison-' + new Date().toISOString().substring(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        // =============================================
        // POOLING RATE COMPARISON REPORT — Redesigned
        // =============================================

        let lastPoolingData = null;
        let poolingExpandedProperties = new Set();
        let poolingCurrentTab = 'properties';
        let poolingSearchTerm = '';
        let poolingSortKey = 'orderCount';
        let poolingSortDir = 'desc';
        let poolingCountyFilter = '';
        let poolingDistanceFilter = '';
        let poolingTableSort = { key: 'orderDate', dir: 'desc' };

        async function loadPoolingReport(forceRefresh = false) {
            // Push history so back button returns to intelligence home
            history.pushState({ intelView: 'report' }, '');
            intelViewOpen = 'report';
            // Show report viewer, hide main page content
            const main = document.querySelector('main');
            const hero = document.querySelector('.intel-hero');
            const viewer = document.getElementById('reportViewer');
            if (main) main.style.display = 'none';
            if (hero) hero.style.display = 'none';
            viewer.style.display = 'block';
            window.scrollTo(0, 0);

            // Update header for pooling report
            document.getElementById('reportBreadcrumb').textContent = 'Pooling Rate Comparison';
            document.getElementById('reportTitle').textContent = 'Pooling Rate Comparison';
            document.getElementById('reportContent').innerHTML = '<div class="report-loading">Searching for pooling orders near your properties...</div>';
            document.getElementById('reportSubtitle').textContent = 'Loading...';
            document.getElementById('reportStatus').textContent = '';
            document.getElementById('reportStatus').className = 'report-status';
            document.getElementById('reportMeta').textContent = '';

            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 20000);

                const url = forceRefresh ? '/api/intelligence/pooling-report?refresh=1' : '/api/intelligence/pooling-report';
                const response = await fetch(url, {
                    credentials: 'include',
                    signal: controller.signal
                });

                if (!response.ok) {
                    throw new Error('API returned ' + response.status);
                }

                const data = await response.json();
                renderPoolingReport(data);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Pooling report request timed out');
                } else {
                    console.error('Failed to load pooling report:', error);
                }
                document.getElementById('reportContent').innerHTML = `
                    <div class="report-error">
                        <p>Could not load pooling data. Please try again.</p>
                        <button class="btn btn-primary" onclick="loadPoolingReport()">Retry</button>
                        <button class="btn btn-ghost" onclick="closeReport()" style="margin-left: 0.5rem;">Back</button>
                    </div>
                `;
            }
        }

        // Parse formations JSON and extract names
        function parseFormations(formations) {
            if (!formations) return [];
            if (Array.isArray(formations)) {
                return formations.map(f => {
                    if (typeof f === 'string') return f;
                    if (f && typeof f === 'object' && f.name) return f.name;
                    return null;
                }).filter(Boolean);
            }
            if (typeof formations === 'string') {
                try {
                    const parsed = JSON.parse(formations);
                    return parseFormations(parsed);
                } catch (e) {
                    return [formations];
                }
            }
            return [];
        }

        function renderPoolingReport(data) {
            const { summary, byProperty, countyAverages, marketResearch } = data;
            lastPoolingData = data;
            poolingExpandedProperties = new Set();
            poolingCurrentTab = 'properties';
            poolingSearchTerm = '';
            poolingCountyFilter = '';
            poolingDistanceFilter = '';

            // Header subtitle
            document.getElementById('reportSubtitle').textContent = summary.totalNearbyOrders > 0
                ? 'Bonus rates and royalty options from OCC pooling orders near your properties'
                : 'No recent pooling orders found nearby';

            document.getElementById('reportStatus').textContent = '';
            const dateRange = summary.dateRange;
            const metaText = dateRange && dateRange.earliest && dateRange.latest
                ? `${formatPoolingDate(dateRange.earliest)} – ${formatPoolingDate(dateRange.latest)} · Updated daily`
                : 'Data from OCC pooling docket';
            document.getElementById('reportMeta').innerHTML = `${metaText} <button class="btn-refresh-small" onclick="loadPoolingReport(true)" title="Refresh data">↻</button>` +
                '<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Sourced from OCC pooling docket, updated daily</div>';

            if (summary.totalNearbyOrders === 0) {
                document.getElementById('reportContent').innerHTML = `
                    <div class="hud-metrics">
                        <div class="hud-badge">
                            <div class="hud-badge-value">0</div>
                            <div class="hud-badge-content">
                                <div class="hud-badge-label">Nearby Orders</div>
                                <div class="hud-badge-status">None found</div>
                            </div>
                        </div>
                        <div class="hud-badge">
                            <div class="hud-badge-value">${byProperty.length}</div>
                            <div class="hud-badge-content">
                                <div class="hud-badge-label">Properties Searched</div>
                                <div class="hud-badge-status">Within 2 townships</div>
                            </div>
                        </div>
                    </div>
                    <div class="report-summary-card">
                        <h2 class="report-summary-title">No Recent Pooling Activity</h2>
                        <p class="report-summary-text">
                            We searched for pooling orders within 2 townships of your ${byProperty.length} properties
                            and found no recent filings. This data is updated as new orders are published by the OCC.
                        </p>
                    </div>
                    <div class="report-footer">
                        <p>Data sourced from Oklahoma Corporation Commission pooling docket.</p>
                    </div>
                `;
                return;
            }

            let html = '';

            // HUD Metrics Bar (4 columns)
            const bonusRange = summary.bonusRange;
            const bonusRangeText = bonusRange && bonusRange.min != null && bonusRange.max != null
                ? `Range: $${bonusRange.min.toLocaleString()} – $${bonusRange.max.toLocaleString()}`
                : '';
            const topOp = summary.topOperators && summary.topOperators[0] ? summary.topOperators[0].name : '';
            const topOpShort = topOp.length > 20 ? topOp.substring(0, 20) + '...' : topOp;

            html += `
                <div class="hud-metrics pooling-hud">
                    <div class="hud-badge">
                        <div class="hud-badge-value">${summary.totalNearbyOrders}</div>
                        <div class="hud-badge-content">
                            <div class="hud-badge-label">Nearby Orders</div>
                            <div class="hud-badge-status">Within 2 townships of your properties</div>
                        </div>
                    </div>
                    <div class="hud-badge">
                        <div class="hud-badge-value pooling-amber">${summary.avgBonusPerAcre != null ? '$' + Math.round(summary.avgBonusPerAcre).toLocaleString() : '—'}</div>
                        <div class="hud-badge-content">
                            <div class="hud-badge-label">Avg Bonus / Acre</div>
                            <div class="hud-badge-status">${bonusRangeText}</div>
                        </div>
                    </div>
                    <div class="hud-badge">
                        <div class="hud-badge-value pooling-emerald">${summary.topOperators ? summary.topOperators.length : '—'}</div>
                        <div class="hud-badge-content">
                            <div class="hud-badge-label">Active Operators</div>
                            <div class="hud-badge-status">${topOpShort ? escapeHtml(topOpShort) + ' is most active' : 'In your area'}</div>
                        </div>
                    </div>
                    <div class="hud-badge">
                        <div class="hud-badge-value pooling-blue">${summary.countyCount || countyAverages.length}</div>
                        <div class="hud-badge-content">
                            <div class="hud-badge-label">Your Counties</div>
                            <div class="hud-badge-status">${countyAverages[0] ? escapeHtml(countyAverages[0].county) + ' leads with ' + countyAverages[0].orderCount + ' orders' : ''}</div>
                        </div>
                    </div>
                </div>
            `;

            // Section Tabs
            const propertiesWithOrders = byProperty.filter(p => p.nearbyOrders && p.nearbyOrders.length > 0);
            html += `
                <div class="pooling-tabs">
                    <button class="pooling-tab active" data-tab="properties" onclick="switchPoolingTab('properties')">
                        My Portfolio <span class="tab-badge">${propertiesWithOrders.length}</span>
                    </button>
                    <button class="pooling-tab" data-tab="markets" onclick="switchPoolingTab('markets')">
                        My Markets <span class="tab-badge">${countyAverages.length}</span>
                    </button>
                    <button class="pooling-tab" data-tab="research" onclick="switchPoolingTab('research')">
                        Market Research
                    </button>
                </div>
            `;

            // Tab Contents Container
            html += `<div id="pooling-tab-contents">`;

            // TAB 1: MY PROPERTIES
            html += `<div id="pooling-tab-properties" class="pooling-tab-content active">`;
            html += renderPoolingPropertiesTab(summary, propertiesWithOrders, countyAverages);
            html += `</div>`;

            // TAB 2: MY MARKETS
            html += `<div id="pooling-tab-markets" class="pooling-tab-content" style="display:none;">`;
            html += renderPoolingMarketsTab(countyAverages);
            html += `</div>`;

            // TAB 3: MARKET RESEARCH
            html += `<div id="pooling-tab-research" class="pooling-tab-content" style="display:none;">`;
            html += renderPoolingResearchTab(marketResearch);
            html += `</div>`;

            html += `</div>`; // Close tab contents

            // Footer
            html += `
                <div class="report-footer">
                    Data sourced from Oklahoma Corporation Commission pooling docket.<br>
                    Showing orders filed within the past 12 months. · Updated daily.
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;

            // Setup event listeners
            setupPoolingFilters();
        }

        function renderPoolingPropertiesTab(summary, propertiesWithOrders, countyAverages) {
            let html = '';

            // Royalty Summary Strip
            const royaltyOpts = summary.royaltyOptions || {};
            const royaltyKeys = Object.keys(royaltyOpts).sort((a, b) => royaltyOpts[b] - royaltyOpts[a]);
            if (royaltyKeys.length > 0) {
                html += `
                    <div class="pooling-royalty-summary">
                        <div class="pooling-summary-label">Royalty Options in Your Area</div>
                        <div class="pooling-royalty-chips">
                            ${royaltyKeys.map((k, i) => `
                                <span class="pooling-royalty-chip ${i === 0 ? 'primary' : 'secondary'}">
                                    ${escapeHtml(k)} <span class="chip-count">${royaltyOpts[k]} order${royaltyOpts[k] !== 1 ? 's' : ''}</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Active Operators Bar
            if (summary.topOperators && summary.topOperators.length > 0) {
                html += `
                    <div class="pooling-operators-bar">
                        <span class="pooling-summary-label">Active Operators</span>
                        ${summary.topOperators.slice(0, 5).map(op => `
                            <span class="pooling-operator-chip">
                                ${escapeHtml(op.name)} <span class="chip-count">${op.orderCount}</span>
                            </span>
                        `).join('')}
                    </div>
                `;
            }

            // Toolbar
            const counties = [...new Set(propertiesWithOrders.map(p => p.county).filter(Boolean))].sort();
            html += `
                <div class="pooling-toolbar">
                    <div class="pooling-search-box">
                        <span class="search-icon">⌕</span>
                        <input type="text" id="poolingSearch" placeholder="Search properties, operators..." oninput="filterPoolingProperties()">
                    </div>
                    <div class="pooling-filter-group">
                        <label class="filter-label">Sort</label>
                        <select id="poolingSort" class="pooling-filter-select" onchange="sortPoolingProperties()">
                            <option value="orderCount-desc">Most Nearby Orders</option>
                            <option value="avgBonus-desc">Highest Avg Bonus</option>
                            <option value="propertyName-asc">By Name</option>
                            <option value="county-asc">By County</option>
                        </select>
                    </div>
                    <div class="pooling-filter-group">
                        <label class="filter-label">County</label>
                        <select id="poolingCounty" class="pooling-filter-select" onchange="filterPoolingProperties()">
                            <option value="">All Counties</option>
                            ${counties.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="pooling-filter-group">
                        <label class="filter-label">Distance</label>
                        <select id="poolingDistance" class="pooling-filter-select" onchange="filterPoolingProperties()">
                            <option value="">All Distances</option>
                            <option value="same">Same Section</option>
                            <option value="adjacent">Adjacent</option>
                            <option value="within2">Within 2 Twp</option>
                        </select>
                    </div>
                    <button class="pooling-btn-export" onclick="exportPoolingCsv()">⤓ Export CSV</button>
                </div>
            `;

            // Property Accordions
            html += `<div id="pooling-properties-list">`;
            html += renderPoolingPropertyList(propertiesWithOrders);
            html += `</div>`;

            return html;
        }

        function renderPoolingPropertyList(properties) {
            if (!properties || properties.length === 0) {
                return '<div class="pooling-empty">No properties match your filters</div>';
            }

            let html = '';

            // Show ALL properties (no limit), all collapsed by default
            for (const prop of properties) {
                const propId = (prop.propertyId || prop.propertyName).replace(/[^a-zA-Z0-9]/g, '-');
                const sameSection = prop.sameSectionCount || 0;
                const adjacent = prop.adjacentCount || 0;

                // Calculate avgBonus from orders if not provided
                let avgBonus = prop.avgBonus;
                if (avgBonus == null && prop.nearbyOrders && prop.nearbyOrders.length > 0) {
                    const bonuses = [];
                    for (const order of prop.nearbyOrders) {
                        if (order.electionOptions) {
                            for (const opt of order.electionOptions) {
                                if (opt.bonusPerAcre != null && opt.bonusPerAcre > 0) {
                                    bonuses.push(opt.bonusPerAcre);
                                }
                            }
                        }
                    }
                    if (bonuses.length > 0) {
                        avgBonus = Math.round(bonuses.reduce((a, b) => a + b, 0) / bonuses.length);
                    }
                }

                html += `
                    <div class="pooling-property-group" id="prop-group-${propId}">
                        <div class="pooling-property-header" onclick="togglePoolingProperty('${propId}')">
                            <div class="pooling-header-left">
                                <span class="expand-chevron" id="pooling-chevron-${propId}">▶</span>
                                <span class="pooling-prop-name">${escapeHtml(prop.propertyName)}</span>
                                <span class="pooling-prop-location">${escapeHtml(prop.county || '')}</span>
                            </div>
                            <div class="pooling-header-right">
                                <div class="pooling-prop-stat">
                                    <div class="pooling-stat-value">${prop.orderCount || prop.nearbyOrders.length}</div>
                                    <div class="pooling-stat-label">Orders</div>
                                </div>
                                <div class="pooling-prop-stat">
                                    <div class="pooling-stat-value pooling-amber">${avgBonus != null ? '$' + avgBonus.toLocaleString() : '—'}</div>
                                    <div class="pooling-stat-label">Avg Bonus</div>
                                </div>
                                ${sameSection > 0 ? `<span class="pooling-distance-badge same-section">${sameSection} same section</span>` : ''}
                                ${adjacent > 0 ? `<span class="pooling-distance-badge adjacent">${adjacent} adjacent</span>` : ''}
                            </div>
                        </div>
                        <div class="pooling-property-content" id="pooling-content-${propId}" style="display: none;">
                            ${renderPoolingOrdersTable(prop.nearbyOrders, propId)}
                        </div>
                    </div>
                `;
            }

            return html;
        }

        function renderPoolingOrdersTable(orders, propId) {
            if (!orders || orders.length === 0) return '<div class="pooling-empty">No orders</div>';

            const sortedOrders = [...orders].sort((a, b) => {
                const key = poolingTableSort.key;
                const dir = poolingTableSort.dir;
                let aVal = a[key];
                let bVal = b[key];
                if (key === 'maxBonus') {
                    aVal = getMaxBonus(a);
                    bVal = getMaxBonus(b);
                }
                if (aVal == null) return dir === 'asc' ? 1 : -1;
                if (bVal == null) return dir === 'asc' ? -1 : 1;
                if (typeof aVal === 'string') {
                    return dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return dir === 'asc' ? aVal - bVal : bVal - aVal;
            });

            return `
                <table class="pooling-orders-table">
                    <thead>
                        <tr>
                            <th class="sortable ${poolingTableSort.key === 'orderDate' ? 'sorted ' + poolingTableSort.dir : ''}" onclick="sortPoolingTable('orderDate', '${propId}')">Date <span class="sort-chevron">▲</span></th>
                            <th class="sortable ${poolingTableSort.key === 'operator' ? 'sorted ' + poolingTableSort.dir : ''}" onclick="sortPoolingTable('operator', '${propId}')">Operator <span class="sort-chevron">▲</span></th>
                            <th>Formation</th>
                            <th>Location</th>
                            <th class="sortable ${poolingTableSort.key === 'maxBonus' ? 'sorted ' + poolingTableSort.dir : ''}" onclick="sortPoolingTable('maxBonus', '${propId}')">Bonus Range <span class="sort-chevron">▲</span></th>
                            <th>Royalty Range</th>
                            <th class="sortable ${poolingTableSort.key === 'distanceTier' ? 'sorted ' + poolingTableSort.dir : ''}" onclick="sortPoolingTable('distanceTier', '${propId}')">Distance <span class="sort-chevron">▲</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedOrders.map(order => renderPoolingOrderRow(order)).join('')}
                    </tbody>
                </table>
            `;
        }

        function getMaxBonus(order) {
            let maxBonus = null;
            if (order.electionOptions) {
                for (const opt of order.electionOptions) {
                    if (opt.bonusPerAcre != null && (maxBonus === null || opt.bonusPerAcre > maxBonus)) {
                        maxBonus = opt.bonusPerAcre;
                    }
                }
            }
            return maxBonus;
        }

        function renderPoolingOrderRow(order) {
            // Parse formations properly
            const formationNames = parseFormations(order.formations);
            const formationTags = formationNames.length > 0
                ? formationNames.slice(0, 2).map(f => `<span class="formation-tag">${escapeHtml(f)}</span>`).join('')
                : '—';

            const location = `${order.township}-${order.range}-${order.section}`;

            // Get bonus range and royalty range (excluding $0/null for bonus — those are participate/royalty-only)
            let minBonus = null;
            let maxBonus = null;
            let royaltyFractions = [];
            let hasOnlyRoyaltyOptions = true;
            if (order.electionOptions && order.electionOptions.length > 0) {
                for (const opt of order.electionOptions) {
                    // Only count positive bonus amounts (exclude $0 and participate options)
                    if (opt.bonusPerAcre != null && opt.bonusPerAcre > 0) {
                        hasOnlyRoyaltyOptions = false;
                        if (minBonus === null || opt.bonusPerAcre < minBonus) minBonus = opt.bonusPerAcre;
                        if (maxBonus === null || opt.bonusPerAcre > maxBonus) maxBonus = opt.bonusPerAcre;
                    }
                    // Only count royalty fractions (exclude WI/participate options without royalty)
                    if (opt.royaltyFraction && opt.optionType !== 'participate') {
                        royaltyFractions.push(opt.royaltyFraction);
                    }
                }
            }

            // Parse royalty fractions to get min/max
            const parseRoyalty = (frac) => {
                if (!frac) return null;
                const match = frac.match(/(\d+)\/(\d+)/);
                if (match) return parseFloat(match[1]) / parseFloat(match[2]);
                return null;
            };
            const royaltyDecimals = royaltyFractions.map(parseRoyalty).filter(v => v !== null);
            const minRoyalty = royaltyDecimals.length > 0 ? Math.min(...royaltyDecimals) : null;
            const maxRoyalty = royaltyDecimals.length > 0 ? Math.max(...royaltyDecimals) : null;
            const minRoyaltyFrac = royaltyFractions.find(f => parseRoyalty(f) === minRoyalty) || null;
            const maxRoyaltyFrac = royaltyFractions.find(f => parseRoyalty(f) === maxRoyalty) || null;

            // Format bonus range
            let bonusRangeHtml = '—';
            if (hasOnlyRoyaltyOptions && order.electionOptions?.length > 0) {
                bonusRangeHtml = '<span class="royalty-only-label">Royalty Only</span>';
            } else if (minBonus !== null && maxBonus !== null) {
                if (minBonus === maxBonus) {
                    bonusRangeHtml = `$${maxBonus.toLocaleString()}/ac`;
                } else {
                    bonusRangeHtml = `$${minBonus.toLocaleString()}–$${maxBonus.toLocaleString()}/ac`;
                }
            } else if (maxBonus !== null) {
                bonusRangeHtml = `$${maxBonus.toLocaleString()}/ac`;
            }

            // Format royalty range
            let royaltyRangeHtml = '—';
            if (minRoyaltyFrac && maxRoyaltyFrac) {
                if (minRoyaltyFrac === maxRoyaltyFrac) {
                    royaltyRangeHtml = minRoyaltyFrac;
                } else {
                    royaltyRangeHtml = `${minRoyaltyFrac}–${maxRoyaltyFrac}`;
                }
            }

            // Bonus color class (based on max)
            const bonusClass = maxBonus >= 1500 ? 'bonus-high' : maxBonus >= 500 ? 'bonus-mid' : maxBonus > 0 ? 'bonus-low' : '';

            // Distance badge class
            const distClass = order.distanceDescription === 'Same section' ? 'same-section'
                : order.distanceDescription === 'Adjacent' ? 'adjacent' : 'within-2';

            // Generate unique row ID for expandable functionality
            const rowId = 'pooling-row-' + (order.orderId || order.id || Math.random().toString(36).substr(2, 9));

            return `
                <tr class="pooling-order-row expandable-row" onclick="togglePoolingRowExpand('${rowId}', this)">
                    <td>${formatPoolingDate(order.orderDate)}</td>
                    <td>${order.operator && order.operator !== '—'
                        ? `<span class="operator-name" style="color:#5b21b6;cursor:pointer;text-decoration:underline;" onclick="event.stopPropagation(); lookupOperatorDetail('${escapeAttr(order.operator)}')">${escapeHtml(order.operator)}</span>`
                        : `<span class="operator-name">—</span>`}</td>
                    <td>${formationTags}</td>
                    <td><span class="location-mono">${escapeHtml(location)}</span></td>
                    <td><span class="bonus-amount ${bonusClass}">${bonusRangeHtml}</span></td>
                    <td><span class="royalty-range">${royaltyRangeHtml}</span></td>
                    <td><span class="pooling-distance-badge ${distClass}">${escapeHtml(order.distanceDescription || '—')}</span></td>
                </tr>
                <tr class="pooling-expand-row" id="${rowId}" style="display: none;">
                    <td colspan="7">
                        <div class="pooling-options-detail">
                            <div class="comp-order-meta">
                                <span class="comp-meta-item"><strong>Operator:</strong> ${order.operator && order.operator !== '—'
                                    ? `<span style="color:#5b21b6;cursor:pointer;text-decoration:underline;" onclick="event.stopPropagation(); lookupOperatorDetail('${escapeAttr(order.operator)}')">${escapeHtml(order.operator)}</span>`
                                    : '—'}</span>
                                <span class="comp-meta-item"><strong>Case:</strong> ${escapeHtml(order.caseNumber || '—')}</span>
                                <span class="comp-meta-item"><strong>Order Date:</strong> ${formatPoolingDate(order.orderDate)}</span>
                            </div>
                            ${renderElectionOptionsTable(order.electionOptions)}
                        </div>
                    </td>
                </tr>
            `;
        }

        function renderElectionOptionsTable(options) {
            if (!options || options.length === 0) {
                return '<p class="no-options-msg">No election options available</p>';
            }

            let html = `
                <table class="election-options-table">
                    <thead>
                        <tr>
                            <th>Option</th>
                            <th>Type</th>
                            <th>Bonus/Acre</th>
                            <th>Royalty</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const opt of options) {
                const optType = opt.optionType ? opt.optionType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : '—';
                const bonus = opt.bonusPerAcre != null && opt.bonusPerAcre > 0 ? '$' + opt.bonusPerAcre.toLocaleString() : '—';
                const royalty = opt.royaltyFraction || (opt.optionType === 'participate' ? 'WI' : '—');

                html += `
                    <tr>
                        <td><span class="option-number">${opt.optionNumber || '—'}</span></td>
                        <td><span class="option-type">${escapeHtml(optType)}</span></td>
                        <td><span class="option-bonus">${bonus}</span></td>
                        <td><span class="option-royalty">${escapeHtml(royalty)}</span></td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            return html;
        }

        function togglePoolingRowExpand(rowId, clickedRow) {
            const expandRow = document.getElementById(rowId);
            if (!expandRow) return;

            const isExpanded = expandRow.style.display !== 'none';
            expandRow.style.display = isExpanded ? 'none' : 'table-row';
            clickedRow.classList.toggle('expanded', !isExpanded);
        }

        function renderPoolingMarketsTab(countyAverages) {
            if (!countyAverages || countyAverages.length === 0) {
                return '<div class="pooling-empty">No county data available</div>';
            }

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <p class="pooling-tab-intro" style="margin-bottom: 0;">
                        Average bonus rates and formation activity in counties where you own mineral rights.
                        Use this to benchmark offers you receive against local market conditions.
                    </p>
                    <button class="pooling-btn-export" onclick="exportPoolingMarketsCsv()" style="flex-shrink: 0; margin-left: 1rem;">⤓ Export CSV</button>
                </div>
                <div class="pooling-markets-grid">
            `;

            // Find global min/max for bonus range visualization
            const allBonuses = countyAverages.flatMap(ca => [ca.minBonus, ca.maxBonus]).filter(b => b != null);
            const globalMin = Math.min(...allBonuses, 0);
            const globalMax = Math.max(...allBonuses, 100);

            for (const ca of countyAverages) {
                const formationTags = (ca.formations || []).slice(0, 3).map(f =>
                    `<span class="formation-tag">${escapeHtml(f)}</span>`
                ).join('');

                // Bonus range bar positioning
                const rangeStart = ca.minBonus != null ? ((ca.minBonus - globalMin) / (globalMax - globalMin) * 100) : 0;
                const rangeWidth = ca.minBonus != null && ca.maxBonus != null
                    ? ((ca.maxBonus - ca.minBonus) / (globalMax - globalMin) * 100) : 0;
                const avgPosition = ca.avgBonus != null ? ((ca.avgBonus - globalMin) / (globalMax - globalMin) * 100) : 50;

                html += `
                    <div class="pooling-market-card">
                        <div class="market-card-header">
                            <span class="market-county">${escapeHtml(ca.county)}</span>
                            <span class="market-order-count">${ca.orderCount} order${ca.orderCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="market-card-body">
                            <div class="market-stat-row">
                                <span class="market-stat-name">Avg Bonus/Acre</span>
                                <span class="market-stat-val">${ca.avgBonus != null ? '$' + ca.avgBonus.toLocaleString() : '—'}</span>
                            </div>
                            ${ca.minBonus != null && ca.maxBonus != null ? `
                            <div class="bonus-range-bar">
                                <div class="bonus-range-fill" style="left:${Math.max(rangeStart, 5)}%;width:${Math.max(rangeWidth, 10)}%;"></div>
                                <div class="bonus-avg-marker" style="left:${avgPosition}%;"></div>
                            </div>
                            <div class="bonus-range-labels">
                                <span class="bonus-range-label">$${ca.minBonus.toLocaleString()}</span>
                                <span class="bonus-range-label">$${ca.maxBonus.toLocaleString()}</span>
                            </div>
                            ` : ''}
                            <div class="market-stat-row">
                                <span class="market-stat-name">Most Active Operator</span>
                                <span class="market-stat-val market-operator">${escapeHtml(ca.mostActiveOperator || '—')}</span>
                            </div>
                            <div class="market-stat-row">
                                <span class="market-stat-name">Dominant Royalty</span>
                                <span class="market-stat-val">${escapeHtml(ca.dominantRoyalty || '—')}</span>
                            </div>
                            ${formationTags ? `
                            <div class="market-formations">
                                <div class="market-formations-label">Active Formations</div>
                                <div class="market-formation-list">${formationTags}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            html += `</div>`;
            return html;
        }

        function renderPoolingResearchTab(marketResearch) {
            const research = marketResearch || {};
            const topFormations = research.topFormations || [];
            const topPayingOperators = research.topPayingOperators || [];
            const hottestCounties = research.hottestCounties || [];

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <p class="pooling-tab-intro" style="margin-bottom: 0;">
                        Statewide pooling market intelligence from OCC orders. Identify formation premiums,
                        top-paying operators, and market trends across Oklahoma.
                    </p>
                    <button class="pooling-btn-export" onclick="exportPoolingResearchCsv()" style="flex-shrink: 0; margin-left: 1rem;">⤓ Export CSV</button>
                </div>
                <div class="pooling-insight-cards">
            `;

            // Top Formations
            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Highest-Paying Formations</div>
                    ${topFormations.length > 0 ? topFormations.map(f => `
                        <div class="insight-top-item">
                            <span class="insight-item-name">${escapeHtml(f.name)}</span>
                            <span class="insight-item-val">$${f.avgBonus.toLocaleString()}<span class="insight-item-sub">avg</span></span>
                        </div>
                    `).join('') : '<div class="pooling-empty">No data</div>'}
                </div>
            `;

            // Top Paying Operators
            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Top-Paying Operators</div>
                    ${topPayingOperators.length > 0 ? topPayingOperators.map(op => `
                        <div class="insight-top-item">
                            <span class="insight-item-name">${escapeHtml(op.name)}</span>
                            <span class="insight-item-val">$${op.avgBonus.toLocaleString()}<span class="insight-item-sub">avg</span></span>
                        </div>
                    `).join('') : '<div class="pooling-empty">No data</div>'}
                </div>
            `;

            // Hottest Counties
            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Hottest Counties (Last 90 Days)</div>
                    ${hottestCounties.length > 0 ? hottestCounties.map(c => `
                        <div class="insight-top-item">
                            <span class="insight-item-name">${escapeHtml(c.county)}</span>
                            <span class="insight-item-val">${c.orderCount}<span class="insight-item-sub">orders</span></span>
                        </div>
                    `).join('') : '<div class="pooling-empty">No recent activity</div>'}
                </div>
            `;

            html += `</div>`;

            return html;
        }

        function switchPoolingTab(tab) {
            poolingCurrentTab = tab;
            document.querySelectorAll('.pooling-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            document.querySelectorAll('.pooling-tab-content').forEach(content => {
                content.style.display = content.id === 'pooling-tab-' + tab ? 'block' : 'none';
            });
        }

        function setupPoolingFilters() {
            // Already handled by inline event handlers
        }

        function filterPoolingProperties() {
            if (!lastPoolingData) return;

            const search = (document.getElementById('poolingSearch')?.value || '').toLowerCase();
            const county = document.getElementById('poolingCounty')?.value || '';
            const distance = document.getElementById('poolingDistance')?.value || '';

            let filtered = lastPoolingData.byProperty.filter(p => p.nearbyOrders && p.nearbyOrders.length > 0);

            if (search) {
                // Strip dashes from search so "16-11" matches "16N-11W-10"
                const searchNoDash = search.replace(/-/g, '');
                filtered = filtered.filter(p => {
                    const propName = p.propertyName.toLowerCase();
                    const propNameNoDash = propName.replace(/-/g, '');
                    const propMatch = propName.includes(search) ||
                        propNameNoDash.includes(searchNoDash) ||
                        (p.county || '').toLowerCase().includes(search);
                    const orderMatch = p.nearbyOrders.some(o => {
                        const loc = ((o.township || '') + '-' + (o.range || '') + '-' + (o.section || '')).toLowerCase();
                        const locNoDash = loc.replace(/-/g, '');
                        return (o.operator || '').toLowerCase().includes(search) ||
                            loc.includes(search) ||
                            locNoDash.includes(searchNoDash) ||
                            parseFormations(o.formations).some(f => f.toLowerCase().includes(search));
                    });
                    return propMatch || orderMatch;
                });
            }

            if (county) {
                filtered = filtered.filter(p => p.county === county);
            }

            if (distance) {
                filtered = filtered.filter(p => {
                    if (distance === 'same') return (p.sameSectionCount || 0) > 0;
                    if (distance === 'adjacent') return (p.adjacentCount || 0) > 0;
                    return true;
                });
            }

            // Apply sort
            const sortVal = document.getElementById('poolingSort')?.value || 'orderCount-desc';
            const [sortKey, sortDir] = sortVal.split('-');
            filtered.sort((a, b) => {
                let aVal = a[sortKey] ?? a.nearbyOrders?.length ?? 0;
                let bVal = b[sortKey] ?? b.nearbyOrders?.length ?? 0;
                if (typeof aVal === 'string') {
                    return sortDir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return sortDir === 'asc' ? aVal - bVal : bVal - aVal;
            });

            document.getElementById('pooling-properties-list').innerHTML = renderPoolingPropertyList(filtered);
        }

        function sortPoolingProperties() {
            filterPoolingProperties();
        }

        function sortPoolingTable(key, propId) {
            if (poolingTableSort.key === key) {
                poolingTableSort.dir = poolingTableSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                poolingTableSort = { key, dir: key === 'orderDate' || key === 'maxBonus' ? 'desc' : 'asc' };
            }
            // Re-render the specific property's table
            const prop = lastPoolingData?.byProperty?.find(p =>
                (p.propertyId || p.propertyName).replace(/[^a-zA-Z0-9]/g, '-') === propId
            );
            if (prop) {
                const contentEl = document.getElementById('pooling-content-' + propId);
                if (contentEl) {
                    contentEl.innerHTML = renderPoolingOrdersTable(prop.nearbyOrders, propId);
                }
            }
        }

        function showAllPoolingProperties() {
            if (!lastPoolingData) return;
            const filtered = lastPoolingData.byProperty.filter(p => p.nearbyOrders && p.nearbyOrders.length > 0);
            // Use renderPoolingPropertyList which has the avgBonus calculation fix
            document.getElementById('pooling-properties-list').innerHTML = renderPoolingPropertyList(filtered);
        }

        function formatPoolingDate(dateStr) {
            if (!dateStr) return '—';
            try {
                const d = new Date(dateStr);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        }

        function togglePoolingProperty(propId) {
            const content = document.getElementById('pooling-content-' + propId);
            const chevron = document.getElementById('pooling-chevron-' + propId);
            const group = document.getElementById('prop-group-' + propId);
            if (!content) return;

            if (poolingExpandedProperties.has(propId)) {
                content.style.display = 'none';
                if (chevron) chevron.style.transform = '';
                if (group) group.classList.remove('open');
                poolingExpandedProperties.delete(propId);
            } else {
                content.style.display = 'block';
                if (chevron) chevron.style.transform = 'rotate(90deg)';
                if (group) group.classList.add('open');
                poolingExpandedProperties.add(propId);
            }
        }

        function exportPoolingCsv() {
            if (!lastPoolingData || !lastPoolingData.byProperty) {
                showToast('No pooling data to export', 'error');
                return;
            }

            const rows = [];
            rows.push([
                'Property',
                'Property County',
                'Order Date',
                'Operator',
                'Formation',
                'Order Location',
                'Distance',
                'Max Bonus/Acre',
                'Royalty Options',
                'Case Number',
                'Response Deadline'
            ].join(','));

            for (const prop of lastPoolingData.byProperty) {
                if (!prop.nearbyOrders) continue;
                for (const order of prop.nearbyOrders) {
                    let maxBonus = null;
                    let royaltyOpts = [];
                    if (order.electionOptions && order.electionOptions.length > 0) {
                        for (const opt of order.electionOptions) {
                            if (opt.bonusPerAcre != null && (maxBonus === null || opt.bonusPerAcre > maxBonus)) {
                                maxBonus = opt.bonusPerAcre;
                            }
                            if (opt.royaltyFraction) {
                                royaltyOpts.push(opt.royaltyFraction);
                            }
                        }
                    }
                    const formationNames = parseFormations(order.formations);

                    rows.push([
                        csvEscape(prop.propertyName),
                        csvEscape(prop.county || ''),
                        order.orderDate || '',
                        csvEscape(order.operator || ''),
                        csvEscape(formationNames.join('; ')),
                        `${order.township}-${order.range}-${order.section}`,
                        csvEscape(order.distanceDescription || ''),
                        maxBonus != null ? maxBonus : '',
                        csvEscape([...new Set(royaltyOpts)].join('; ')),
                        csvEscape(order.caseNumber || ''),
                        order.responseDeadline || ''
                    ].join(','));
                }
            }

            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pooling-rates-' + new Date().toISOString().substring(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        function exportPoolingMarketsCsv() {
            if (!lastPoolingData || !lastPoolingData.countyAverages) {
                showToast('No market data to export', 'error');
                return;
            }
            const rows = [];
            rows.push(['County', 'Orders', 'Avg Bonus/Acre', 'Min Bonus', 'Max Bonus', 'Most Active Operator', 'Dominant Royalty', 'Formations'].join(','));
            for (const ca of lastPoolingData.countyAverages) {
                rows.push([
                    csvEscape(ca.county),
                    ca.orderCount || 0,
                    ca.avgBonus != null ? ca.avgBonus : '',
                    ca.minBonus != null ? ca.minBonus : '',
                    ca.maxBonus != null ? ca.maxBonus : '',
                    csvEscape(ca.mostActiveOperator || ''),
                    csvEscape(ca.dominantRoyalty || ''),
                    csvEscape((ca.formations || []).join('; '))
                ].join(','));
            }
            const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pooling-markets-' + new Date().toISOString().substring(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        function exportPoolingResearchCsv() {
            if (!lastPoolingData || !lastPoolingData.marketResearch) {
                showToast('No research data to export', 'error');
                return;
            }
            const research = lastPoolingData.marketResearch;
            const rows = [];
            rows.push(['Category', 'Name', 'Value', 'Detail'].join(','));
            for (const f of (research.topFormations || [])) {
                rows.push(['Top Formation', csvEscape(f.name), f.avgBonus, 'Avg Bonus/Acre'].join(','));
            }
            for (const op of (research.topPayingOperators || [])) {
                rows.push(['Top Operator', csvEscape(op.name), op.avgBonus, op.orderCount + ' orders'].join(','));
            }
            for (const c of (research.hottestCounties || [])) {
                rows.push(['Hottest County', csvEscape(c.county), c.orderCount, 'orders (last 90 days)'].join(','));
            }
            const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pooling-research-' + new Date().toISOString().substring(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        // =============================================
        // PRODUCTION DECLINE REPORT
        // =============================================

        let lastDeclineData = null;
        let declineVirtualTable = null;
        let declineSearchTerm = '';
        let declineCountyFilter = '';
        let declineStatusFilter = '';
        let declineCurrentTab = 'properties';
        let lastDeclineResearchData = null;
        let declineResearchCountySort = 'rate';
        let declineResearchView = 'decliners';

        async function loadProductionDeclineReport(forceRefresh = false) {
            // Push history so back button returns to intelligence home
            history.pushState({ intelView: 'report' }, '');
            intelViewOpen = 'report';
            // Set report type for print functionality
            currentReportType = 'production-decline';

            // Show report viewer, hide main page content
            const main = document.querySelector('main');
            const hero = document.querySelector('.intel-hero');
            const viewer = document.getElementById('reportViewer');
            if (main) main.style.display = 'none';
            if (hero) hero.style.display = 'none';
            viewer.style.display = 'block';
            window.scrollTo(0, 0);

            // Update header for decline report
            document.getElementById('reportBreadcrumb').textContent = 'Production Decline Analysis';
            document.getElementById('reportTitle').textContent = 'Production Decline Analysis';
            document.getElementById('reportContent').innerHTML = '<div class="report-loading">Analyzing production trends for your wells...</div>';
            document.getElementById('reportSubtitle').textContent = 'Loading...';
            document.getElementById('reportStatus').textContent = '';
            document.getElementById('reportStatus').className = 'report-status';
            document.getElementById('reportMeta').textContent = '';

            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 30000);

                const url = forceRefresh ? '/api/intelligence/production-decline?bust=1' : '/api/intelligence/production-decline';
                const response = await fetch(url, {
                    credentials: 'include',
                    signal: controller.signal
                });

                if (!response.ok) {
                    throw new Error('API returned ' + response.status);
                }

                const data = await response.json();
                renderProductionDeclineReport(data);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Production decline request timed out');
                } else {
                    console.error('Failed to load production decline report:', error);
                }
                document.getElementById('reportContent').innerHTML = `
                    <div class="report-error">
                        <p>Could not load production data. Please try again.</p>
                        <button class="btn btn-primary" onclick="loadProductionDeclineReport(true)">Retry</button>
                        <button class="btn btn-ghost" onclick="closeReport()" style="margin-left: 0.5rem;">Back</button>
                    </div>
                `;
            }
        }

        function formatDeclineMonth(yyyymm, short = false) {
            if (!yyyymm) return '—';
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const year = yyyymm.substring(0, 4);
            const month = parseInt(yyyymm.substring(4, 6), 10);
            if (short) {
                return `${monthNames[month - 1]} '${year.substring(2)}`;
            }
            return `${monthNames[month - 1]} ${year}`;
        }

        function formatDeclineYoY(pct) {
            if (pct === null || pct === undefined) return '<span class="yoy-neutral">—</span>';
            const sign = pct >= 0 ? '+' : '';
            let colorClass = 'yoy-neutral';
            if (pct > 0) colorClass = 'yoy-positive';
            else if (pct <= -20) colorClass = 'yoy-negative';
            else if (pct < 0) colorClass = 'yoy-warning';
            return `<span class="${colorClass}">${sign}${pct}%</span>`;
        }

        function renderProductionDeclineReport(data) {
            lastDeclineData = data;
            declineSearchTerm = '';
            declineCountyFilter = '';
            declineStatusFilter = '';
            declineCurrentTab = 'properties';

            const { latestDataMonth, summary, wells } = data;

            // Update header
            document.getElementById('reportSubtitle').textContent = `Production through ${formatDeclineMonth(latestDataMonth)}`;
            document.getElementById('reportMeta').innerHTML = `${summary.totalWells} wells analyzed` +
                '<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">OTC production data is typically available with a 2-3 month delay</div>';

            // Get unique counties for filter
            const counties = [...new Set(wells.map(w => w.county).filter(Boolean))].sort();
            const monthlyTotals = data.monthlyTotals || [];

            // Decline subtitle text
            const declineColor = summary.wellsSteepDecline > 0 ? 'pooling-red' : (summary.wellsInDecline > 0 ? 'pooling-amber' : '');
            const declineSubtext = summary.wellsSteepDecline > 0
                ? `${summary.wellsSteepDecline} steep (>20% YoY)`
                : (summary.wellsInDecline > 0 ? 'Modest decline rates' : 'Portfolio holding steady');

            // Build report content with tabs
            const html = `
                <div class="pooling-report-container">
                    <!-- HUD Metrics Bar (matches pooling report pattern) -->
                    <div class="hud-metrics pooling-hud">
                        <div class="hud-badge">
                            <div class="hud-badge-value">${summary.activeWells}</div>
                            <div class="hud-badge-content">
                                <div class="hud-badge-label">Active Wells</div>
                                <div class="hud-badge-status">${summary.idleWells} idle</div>
                            </div>
                        </div>
                        <div class="hud-badge">
                            <div class="hud-badge-value pooling-amber">${Math.round(summary.portfolioOilBBL / 1000)}K</div>
                            <div class="hud-badge-content">
                                <div class="hud-badge-label">Oil (BBL)</div>
                                <div class="hud-badge-status">${formatDeclineMonth(latestDataMonth)} production</div>
                            </div>
                        </div>
                        <div class="hud-badge">
                            <div class="hud-badge-value pooling-emerald">${Math.round(summary.portfolioGasMCF / 1000)}K</div>
                            <div class="hud-badge-content">
                                <div class="hud-badge-label">Gas (MCF)</div>
                                <div class="hud-badge-status">${formatDeclineMonth(latestDataMonth)} production</div>
                            </div>
                        </div>
                        <div class="hud-badge">
                            <div class="hud-badge-value ${declineColor}">${summary.wellsInDecline}</div>
                            <div class="hud-badge-content">
                                <div class="hud-badge-label">Wells Declining</div>
                                <div class="hud-badge-status">${declineSubtext}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Portfolio Trend Chart -->
                    <div class="decline-trend-section">
                        <div class="decline-trend-header">
                            <span class="decline-trend-title">Portfolio Production Trend</span>
                            <span class="decline-trend-subtitle">Total BOE (last 18 months)</span>
                        </div>
                        <canvas id="declineTrendChart" height="120"></canvas>
                    </div>

                    <!-- Tabs -->
                    <div class="pooling-tabs">
                        <button class="pooling-tab active" data-tab="properties" onclick="switchDeclineTab('properties')">
                            My Portfolio <span class="tab-badge">${summary.totalWells}</span>
                        </button>
                        <button class="pooling-tab" data-tab="markets" onclick="switchDeclineTab('markets')">
                            My Markets
                        </button>
                        <button class="pooling-tab" data-tab="research" onclick="switchDeclineTab('research')">
                            Market Research
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div id="declineTabContent">
                        ${renderDeclinePropertiesTab(wells, counties)}
                    </div>

                    <!-- Print Summary (hidden on screen, shown when printing) -->
                    ${renderDeclinePrintSummary(wells, latestDataMonth)}
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;

            // Initialize VirtualTable after DOM is ready
            setTimeout(() => initDeclineVirtualTable(wells), 0);

            // Draw trend chart
            setTimeout(() => drawDeclineTrendChart(monthlyTotals), 50);
        }

        function renderDeclinePropertiesTab(wells, counties) {
            return `
                <!-- Toolbar (matches pooling report pattern) -->
                <div class="pooling-toolbar">
                    <div class="pooling-search-box">
                        <span class="search-icon">⌕</span>
                        <input type="text" id="declineSearch" placeholder="Search wells, operators..." oninput="filterDeclineWells()">
                    </div>
                    <div class="pooling-filter-group">
                        <label class="filter-label">Sort</label>
                        <select id="declineSortFilter" class="pooling-filter-select" onchange="sortDeclineWells()">
                            <option value="yoy-asc">Steepest Decline</option>
                            <option value="oil-desc">Highest Oil</option>
                            <option value="gas-desc">Highest Gas</option>
                            <option value="name-asc">By Name</option>
                            <option value="operator-asc">By Operator</option>
                        </select>
                    </div>
                    <div class="pooling-filter-group">
                        <label class="filter-label">County</label>
                        <select id="declineCountyFilter" class="pooling-filter-select" onchange="filterDeclineWells()">
                            <option value="">All Counties</option>
                            ${counties.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="pooling-filter-group">
                        <label class="filter-label">Status</label>
                        <select id="declineStatusFilter" class="pooling-filter-select" onchange="filterDeclineWells()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="idle">Idle</option>
                        </select>
                    </div>
                    <button class="pooling-btn-export" onclick="exportDeclineCsv()">⤓ Export CSV</button>
                </div>

                <!-- Wells Table -->
                <div id="declineTableContainer" class="vt-container" style="min-height: 400px;"></div>

                <div style="display: flex; justify-content: space-between; align-items: baseline; margin-top: 0.5rem;">
                    <div class="vt-row-count" style="margin: 0;">
                        Showing <span id="declineShownCount">${wells.length}</span> of ${wells.length} wells
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); font-style: italic;">
                        YoY calculated using 24-month production history
                    </div>
                </div>
            `;
        }

        function initDeclineVirtualTable(wells) {
            const container = document.getElementById('declineTableContainer');
            if (!container) return;

            // Destroy previous instance if exists
            if (declineVirtualTable) {
                declineVirtualTable.destroy();
            }

            // Store well data for click-through modal
            storeWellData(wells);

            // Add row class based on status for left border indicator
            const wellsWithRowClass = wells.map(w => ({
                ...w,
                _rowClass: w.status === 'active' ? 'status-active' : 'status-idle'
            }));

            declineVirtualTable = new VirtualTable({
                container: container,
                rowHeight: 52,
                maxHeight: 550,
                data: wellsWithRowClass,
                defaultSort: 'yoyChangePct',
                defaultSortDir: 'asc',

                columns: [
                    {
                        key: 'wellName',
                        label: 'Well Name',
                        width: '25%',
                        sortable: true,
                        render: (val, row) => `<span class="vt-well-link" onclick="showWellInfoById('${row.clientWellId || row.apiNumber}')">${escapeHtml(val)}</span>`
                    },
                    {
                        key: 'operator',
                        label: 'Operator',
                        width: '19%',
                        sortable: true,
                        className: 'vt-hide-mobile'
                    },
                    {
                        key: 'county',
                        label: 'County',
                        width: '11%',
                        sortable: true
                    },
                    {
                        key: 'isHorizontal',
                        label: 'Type',
                        width: '7%',
                        sortable: true,
                        render: (val) => val ? '<span class="vt-type-badge horiz">H</span>' : '<span class="vt-type-badge vert">V</span>'
                    },
                    {
                        key: 'lastReportedMonth',
                        label: 'Last Rpt',
                        width: '11%',
                        sortable: true,
                        className: 'numeric',
                        render: (val) => formatDeclineMonth(val, true)
                    },
                    {
                        key: 'recentOilBBL',
                        label: 'Oil',
                        width: '10%',
                        sortable: true,
                        className: 'numeric',
                        render: (val) => val ? val.toLocaleString() : '—'
                    },
                    {
                        key: 'recentGasMCF',
                        label: 'Gas',
                        width: '10%',
                        sortable: true,
                        className: 'numeric vt-hide-mobile',
                        render: (val) => val ? val.toLocaleString() : '—'
                    },
                    {
                        key: 'yoyChangePct',
                        label: 'YoY',
                        width: '7%',
                        sortable: true,
                        className: 'numeric',
                        render: (val) => formatDeclineYoY(val)
                    }
                ],

                onSort: (key, dir) => {
                    console.log(`Sorted by ${key} ${dir}`);
                }
            });

            // Click handler for well name links
            container.addEventListener('click', (e) => {
                const link = e.target.closest('.vt-well-link');
                if (link) {
                    e.stopPropagation();
                }
            });
        }

        function filterDeclineWells() {
            if (!lastDeclineData || !declineVirtualTable) return;

            const search = document.getElementById('declineSearch')?.value.toLowerCase() || '';
            const county = document.getElementById('declineCountyFilter')?.value || '';
            const status = document.getElementById('declineStatusFilter')?.value || '';

            declineVirtualTable.filter(well => {
                // County filter
                if (county && well.county !== county) return false;

                // Status filter
                if (status && well.status !== status) return false;

                // Search filter
                if (search) {
                    const searchFields = [
                        well.wellName,
                        well.operator,
                        well.county,
                        well.formation,
                        well.apiNumber
                    ].filter(Boolean).map(s => s.toLowerCase());

                    if (!searchFields.some(f => f.includes(search))) return false;
                }

                return true;
            });

            // Update count
            const shownCount = document.getElementById('declineShownCount');
            if (shownCount) {
                shownCount.textContent = declineVirtualTable.filteredData.length;
            }
        }

        function sortDeclineWells() {
            if (!declineVirtualTable) return;
            const sortVal = document.getElementById('declineSortFilter')?.value || 'yoy-asc';
            const [key, dir] = sortVal.split('-');

            const sortKeyMap = {
                'yoy': 'yoyChangePct',
                'oil': 'recentOilBBL',
                'gas': 'recentGasMCF',
                'name': 'wellName',
                'operator': 'operator'
            };

            const sortKey = sortKeyMap[key] || 'yoyChangePct';
            declineVirtualTable.sortKey = sortKey;
            declineVirtualTable.sortDir = dir;
            declineVirtualTable.sortData();
        }

        let lastMarketsData = null;
        let declineMarketSort = 'performance'; // 'performance' | 'name'
        let declineMarketView = 'priority'; // 'priority' | 'counties'

        function switchDeclineTab(tab) {
            declineCurrentTab = tab;

            // Update tab buttons
            document.querySelectorAll('.pooling-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.pooling-tab[data-tab="${tab}"]`)?.classList.add('active');

            const content = document.getElementById('declineTabContent');
            if (!content || !lastDeclineData) return;

            if (tab === 'properties') {
                const counties = [...new Set(lastDeclineData.wells.map(w => w.county).filter(Boolean))].sort();
                content.innerHTML = renderDeclinePropertiesTab(lastDeclineData.wells, counties);
                setTimeout(() => initDeclineVirtualTable(lastDeclineData.wells), 0);
            } else if (tab === 'markets') {
                // Show loading state
                content.innerHTML = `
                    <div style="padding: 3rem; text-align: center; color: var(--text-muted);">
                        <div class="spinner-border" role="status" style="width: 2rem; height: 2rem; margin-bottom: 1rem;"></div>
                        <div style="font-size: 1rem;">Loading county benchmarks...</div>
                    </div>
                `;
                // Fetch markets data
                fetchDeclineMarkets();
            } else if (tab === 'research') {
                if (lastDeclineResearchData) {
                    content.innerHTML = renderDeclineResearchTab(lastDeclineResearchData);
                } else {
                    content.innerHTML = `
                        <div style="padding: 3rem; text-align: center; color: var(--text-muted);">
                            <div class="spinner-border" role="status" style="width: 2rem; height: 2rem; margin-bottom: 1rem;"></div>
                            <div style="font-size: 1rem;">Loading statewide decline data...</div>
                        </div>
                    `;
                    fetchDeclineResearch();
                }
            }
        }

        async function fetchDeclineMarkets() {
            try {
                const res = await fetch('/api/intelligence/production-decline/markets');
                if (!res.ok) throw new Error('Failed to fetch markets data');
                const data = await res.json();
                lastMarketsData = data;

                // Update tab badge with county count
                const marketsTab = document.querySelector('.pooling-tab[data-tab="markets"]');
                if (marketsTab && data.counties) {
                    const badge = marketsTab.querySelector('.tab-badge');
                    if (badge) {
                        badge.textContent = data.counties.length;
                    } else {
                        marketsTab.innerHTML = `My Markets <span class="tab-badge">${data.counties.length}</span>`;
                    }
                }

                const content = document.getElementById('declineTabContent');
                if (content && declineCurrentTab === 'markets') {
                    content.innerHTML = renderDeclineMarketsTab(data);
                }
            } catch (err) {
                console.error('Failed to load markets:', err);
                const content = document.getElementById('declineTabContent');
                if (content && declineCurrentTab === 'markets') {
                    content.innerHTML = `
                        <div style="padding: 3rem; text-align: center; color: var(--text-danger);">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">⚠️</div>
                            <div>Failed to load county benchmarks. Please try again.</div>
                        </div>
                    `;
                }
            }
        }

        function sortDeclineMarkets(sortType) {
            declineMarketSort = sortType;
            if (lastMarketsData) {
                const content = document.getElementById('declineTabContent');
                if (content) content.innerHTML = renderDeclineMarketsTab(lastMarketsData);
            }
        }

        function switchDeclineMarketView(view) {
            declineMarketView = view;
            document.querySelectorAll('.decline-market-view').forEach(el => el.style.display = 'none');
            const active = document.getElementById('declineMarket_' + view);
            if (active) active.style.display = '';
            document.querySelectorAll('.decline-market-toggle .toggle-btn').forEach(b => {
                const isActive = b.dataset.view === view;
                b.classList.toggle('active', isActive);
                b.style.background = isActive ? 'var(--oil-navy)' : 'transparent';
                b.style.color = isActive ? 'white' : 'var(--slate-blue)';
            });
        }

        function renderDeclineMarketsTab(data) {
            const counties = data.counties || [];
            if (counties.length === 0) {
                return '<div class="pooling-empty" style="padding: 3rem; text-align: center; color: var(--text-muted);">No county data available</div>';
            }

            // Sort counties based on current sort mode
            if (declineMarketSort === 'name') {
                counties.sort((a, b) => a.county.localeCompare(b.county));
            } else if (declineMarketSort === 'wells') {
                counties.sort((a, b) => b.userWellCount - a.userWellCount);
            } else {
                // Performance: best delta first (descending), nulls at end
                counties.sort((a, b) => {
                    const da = a.userVsCountyDelta;
                    const db = b.userVsCountyDelta;
                    if (da == null && db == null) return 0;
                    if (da == null) return 1;
                    if (db == null) return -1;
                    return db - da;
                });
            }

            // Compute summary stats and risk scores for chart
            let outperforming = 0, tracking = 0, underperforming = 0, inactive = 0;
            let bestCounty = null, worstCounty = null;
            let bestDelta = -Infinity, worstDelta = Infinity;
            const riskScores = [];

            for (const ca of counties) {
                const allInactive = ca.userWellCount > 0 && ca.userMedianYoyPct === null && ca.userAvgYoyPct === null;
                if (allInactive) {
                    inactive++;
                } else if (ca.userVsCountyDelta == null) {
                    // no comparison
                } else if (ca.userVsCountyDelta > 5) {
                    outperforming++;
                    if (ca.userVsCountyDelta > bestDelta) { bestDelta = ca.userVsCountyDelta; bestCounty = ca.county; }
                } else if (ca.userVsCountyDelta < -5) {
                    underperforming++;
                    if (ca.userVsCountyDelta < worstDelta) { worstDelta = ca.userVsCountyDelta; worstCounty = ca.county; }
                } else {
                    tracking++;
                }

                // Risk score = well count * negative delta (higher = more risk)
                // Positive delta = outperforming (green, shown as negative risk)
                if (ca.userVsCountyDelta != null && !allInactive) {
                    riskScores.push({
                        county: ca.county,
                        score: Math.round(-ca.userVsCountyDelta * ca.userWellCount),
                        delta: ca.userVsCountyDelta,
                        wells: ca.userWellCount
                    });
                }
            }

            // Build summary insight bar
            const summaryParts = [];
            if (outperforming > 0) summaryParts.push(`<span class="decline-summary-pill pill-positive">${outperforming} outperforming</span>`);
            if (tracking > 0) summaryParts.push(`<span class="decline-summary-pill pill-neutral">${tracking} tracking</span>`);
            if (underperforming > 0) summaryParts.push(`<span class="decline-summary-pill pill-negative">${underperforming} underperforming</span>`);
            if (inactive > 0) summaryParts.push(`<span class="decline-summary-pill pill-inactive">${inactive} inactive</span>`);
            if (bestCounty) summaryParts.push(`<span class="decline-summary-detail">Best: ${escapeHtml(bestCounty)} (+${bestDelta.toFixed(0)}%)</span>`);
            if (worstCounty) summaryParts.push(`<span class="decline-summary-detail">Needs attention: ${escapeHtml(worstCounty)} (${worstDelta.toFixed(0)}%)</span>`);

            // Build risk score bar chart
            let riskChartHtml = '';
            if (riskScores.length > 1) {
                riskScores.sort((a, b) => b.score - a.score); // Highest risk first
                const maxAbsScore = Math.max(...riskScores.map(r => Math.abs(r.score)), 1);

                const bars = riskScores.map(r => {
                    const pct = Math.abs(r.score) / maxAbsScore * 100;
                    const isRisk = r.score > 0;
                    const barColor = r.score > 0 ? '#dc2626' : (r.score < 0 ? '#059669' : '#d97706');
                    const label = r.score >= 0 ? r.score : r.score;
                    return `
                        <div class="risk-bar-row">
                            <div class="risk-bar-label">${escapeHtml(r.county)}</div>
                            <div class="risk-bar-track">
                                <div class="risk-bar-center"></div>
                                ${r.score >= 0 ? `
                                    <div class="risk-bar-fill risk-bar-right" style="width: ${pct/2}%; background: ${barColor};"></div>
                                ` : `
                                    <div class="risk-bar-fill risk-bar-left" style="width: ${pct/2}%; background: ${barColor};"></div>
                                `}
                            </div>
                            <div class="risk-bar-value" style="color: ${barColor}">${label}</div>
                        </div>
                    `;
                }).join('');

                riskChartHtml = `
                    <div class="risk-chart-container">
                        <div class="risk-chart-title">Asset Intervention Priority (Risk Score)</div>
                        <div class="risk-chart-subtitle">Wells x Performance Gap — higher scores indicate more portfolio impact</div>
                        <div class="risk-chart-bars">${bars}</div>
                    </div>
                `;
            }

            // Build narrative summary paragraph
            const activeCounties = outperforming + tracking + underperforming;
            let narrativeParts = [];
            if (activeCounties > 0) {
                narrativeParts.push(`Across your ${activeCounties} active count${activeCounties !== 1 ? 'ies' : 'y'}`);
                const segments = [];
                if (outperforming > 0) segments.push(`${outperforming} ${outperforming === 1 ? 'is' : 'are'} outperforming county medians`);
                if (tracking > 0) segments.push(`${tracking} ${tracking === 1 ? 'is' : 'are'} tracking`);
                if (underperforming > 0) segments.push(`${underperforming} ${underperforming === 1 ? 'is' : 'are'} underperforming`);
                narrativeParts.push(segments.join(', '));
            }
            let narrativeExtra = [];
            if (bestCounty) narrativeExtra.push(`Your strongest market is ${bestCounty} (+${bestDelta.toFixed(0)}% vs county median)`);
            if (worstCounty) narrativeExtra.push(`the area needing the most attention is ${worstCounty} (${worstDelta.toFixed(0)}%)`);

            let narrativeHtml = '';
            if (narrativeParts.length > 0) {
                const mainSentence = narrativeParts[0] + ', ' + narrativeParts[1] + '.';
                const extraSentence = narrativeExtra.length > 0 ? ' ' + narrativeExtra.join(' and ') + '.' : '';
                narrativeHtml = `<p class="decline-narrative">${mainSentence}${extraSentence} Counties are sorted by performance gap — start at the top to identify wells that may need investigation.</p>`;
            }

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <p class="pooling-tab-intro" style="margin-bottom: 0;">
                        Compare your active wells' year-over-year production change against active county-wide benchmarks.
                    </p>
                    <button class="pooling-btn-export" onclick="exportDeclineMarketsCsv()" style="flex-shrink: 0; margin-left: 1rem;">⤓ Export CSV</button>
                </div>

                <div class="decline-summary-bar">${summaryParts.join(' <span class="decline-summary-sep">&middot;</span> ')}</div>

                <div class="decline-market-toggle" style="display: inline-flex; background: #f1f5f9; border-radius: 8px; padding: 3px; margin: 1rem 0 1.5rem;">
                    <button class="toggle-btn ${declineMarketView === 'priority' ? 'active' : ''}" data-view="priority" onclick="switchDeclineMarketView('priority')" style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; background: ${declineMarketView === 'priority' ? 'var(--oil-navy)' : 'transparent'}; color: ${declineMarketView === 'priority' ? 'white' : 'var(--slate-blue)'};">Intervention Priority</button>
                    <button class="toggle-btn ${declineMarketView === 'counties' ? 'active' : ''}" data-view="counties" onclick="switchDeclineMarketView('counties')" style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; background: ${declineMarketView === 'counties' ? 'var(--oil-navy)' : 'transparent'}; color: ${declineMarketView === 'counties' ? 'white' : 'var(--slate-blue)'};">County Benchmarks</button>
                </div>

                <div id="declineMarket_priority" class="decline-market-view" style="${declineMarketView !== 'priority' ? 'display:none;' : ''}">
                    ${narrativeHtml}
                    ${riskChartHtml}
                </div>

                <div id="declineMarket_counties" class="decline-market-view" style="${declineMarketView !== 'counties' ? 'display:none;' : ''}">
                    <div class="decline-sort-controls">
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Sort by:</span>
                        <button class="decline-sort-btn ${declineMarketSort === 'performance' ? 'active' : ''}" onclick="sortDeclineMarkets('performance')">Performance</button>
                        <button class="decline-sort-btn ${declineMarketSort === 'wells' ? 'active' : ''}" onclick="sortDeclineMarkets('wells')">Well Count</button>
                        <button class="decline-sort-btn ${declineMarketSort === 'name' ? 'active' : ''}" onclick="sortDeclineMarkets('name')">Name</button>
                    </div>
                    <div class="pooling-markets-grid">
            `;

            for (const ca of counties) {
                // Check if user's wells are all inactive (no recent production)
                const userWellsAllInactive = ca.userWellCount > 0 && ca.userMedianYoyPct === null && ca.userAvgYoyPct === null;

                // Delta indicator: user median vs county median (positive = outperforming)
                let deltaClass = 'neutral';
                let deltaIcon = '—';
                let deltaText = 'No comparison';

                if (userWellsAllInactive) {
                    deltaClass = 'inactive';
                    deltaIcon = '⏸';
                    deltaText = 'No recent production (2+ years)';
                } else if (ca.userVsCountyDelta != null) {
                    if (ca.userVsCountyDelta > 5) {
                        deltaClass = 'positive';
                        deltaIcon = '▲';
                        deltaText = `Outperforming county median by ${Math.abs(ca.userVsCountyDelta).toFixed(1)}%`;
                    } else if (ca.userVsCountyDelta < -5) {
                        deltaClass = 'negative';
                        deltaIcon = '▼';
                        deltaText = `Underperforming county median by ${Math.abs(ca.userVsCountyDelta).toFixed(1)}%`;
                    } else {
                        deltaClass = 'neutral';
                        deltaIcon = '≈';
                        deltaText = 'Performing to county median';
                    }
                }

                // Formation tags (top 3)
                const formationTags = (ca.topFormations || []).slice(0, 3).map(f => {
                    const yoyStr = f.avgYoY != null ? (f.avgYoY >= 0 ? '+' : '') + f.avgYoY.toFixed(0) + '%' : '—';
                    const yoyClass = f.avgYoY == null ? '' : (f.avgYoY >= 0 ? 'formation-positive' : (f.avgYoY < -20 ? 'formation-negative' : 'formation-amber'));
                    return `<span class="formation-tag ${yoyClass}">${escapeHtml(f.formation)} <small>${yoyStr}</small></span>`;
                }).join('');

                // User wells YoY display (show median, mean in tooltip)
                const userYoYDisplay = userWellsAllInactive
                    ? '<span class="market-stat-val inactive-note">Inactive</span>'
                    : `<span class="market-stat-val ${formatYoYClass(ca.userMedianYoyPct)}" title="Mean: ${formatYoYValue(ca.userAvgYoyPct)}">${formatYoYValue(ca.userMedianYoyPct)}</span>`;

                html += `
                    <div class="pooling-market-card decline-market-card ${userWellsAllInactive ? 'inactive-wells' : ''}">
                        <div class="market-card-header">
                            <span class="market-county">${escapeHtml(ca.county)}</span>
                            <span class="market-order-count">${ca.userWellCount} well${ca.userWellCount !== 1 ? 's' : ''}${userWellsAllInactive ? ' (inactive)' : ''}</span>
                        </div>
                        <div class="market-card-body">
                            <!-- Delta indicator -->
                            <div class="decline-delta-row delta-${deltaClass}">
                                <span class="delta-icon">${deltaIcon}</span>
                                <span class="delta-text">${deltaText}</span>
                            </div>

                            <div class="market-stat-row">
                                <span class="market-stat-name">Your Wells YoY Change</span>
                                ${userYoYDisplay}
                            </div>
                            <div class="market-stat-row">
                                <span class="market-stat-name" title="Mean: ${formatYoYValue(ca.avgYoyChangePct)}">County Median YoY Change</span>
                                <span class="market-stat-val ${formatYoYClass(ca.medianYoyChangePct)}">${formatYoYValue(ca.medianYoyChangePct)}</span>
                            </div>
                            ${ca.weightedAvgYoyPct != null ? `<div class="market-stat-row">
                                <span class="market-stat-name">County Weighted Avg YoY (by BOE)</span>
                                <span class="market-stat-val ${formatYoYClass(ca.weightedAvgYoyPct)}">${formatYoYValue(ca.weightedAvgYoyPct)}</span>
                            </div>` : ''}
                            <div class="market-stat-row subtle">
                                <span class="market-stat-name">County Wells</span>
                                <span class="market-stat-val">${ca.activeWells} active / ${ca.idleWells} idle</span>
                            </div>

                            ${formationTags ? `
                            <div class="market-formations">
                                <div class="market-formations-label">Top Formations</div>
                                <div class="market-formation-list">${formationTags}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            html += `</div></div>
                <div style="font-size: 0.75rem; color: var(--text-muted); font-style: italic; margin-top: 1rem; text-align: right;">
                    YoY based on active wells only (produced within 3 months of data horizon). Wells below 50 BOE/yr excluded. Hover labels for mean values.
                </div>
            `;
            return html;
        }

        function formatYoYValue(val) {
            if (val == null) return '—';
            const sign = val >= 0 ? '+' : '';
            return sign + val.toFixed(1) + '%';
        }

        function formatYoYClass(val) {
            if (val == null) return '';
            if (val >= 0) return 'yoy-positive';
            if (val > -20) return 'yoy-amber';
            return 'yoy-negative';
        }

        function exportDeclineCsv() {
            if (!lastDeclineData) return;

            const wells = lastDeclineData.wells;
            const rows = [
                ['Well Name', 'API Number', 'Operator', 'County', 'Formation', 'Type', 'Last Reported', 'Oil (BBL)', 'Gas (MCF)', 'BOE', 'YoY Change %', 'Status'].join(',')
            ];

            for (const w of wells) {
                rows.push([
                    csvEscape(w.wellName),
                    csvEscape(w.apiNumber),
                    csvEscape(w.operator),
                    csvEscape(w.county),
                    csvEscape(w.formation),
                    w.isHorizontal ? 'Horizontal' : 'Vertical',
                    w.lastReportedMonth || '',
                    w.recentOilBBL || 0,
                    w.recentGasMCF || 0,
                    w.recentBOE || 0,
                    w.yoyChangePct !== null ? w.yoyChangePct : '',
                    w.status
                ].join(','));
            }

            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'production-decline-' + new Date().toISOString().substring(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        function exportDeclineMarketsCsv() {
            if (!lastDeclineMarketsData || !lastDeclineMarketsData.counties) {
                showToast('No market data to export', 'error');
                return;
            }
            const rows = [];
            rows.push(['County', 'Your Wells', 'Your Median YoY %', 'Your Avg YoY %', 'County Median YoY %', 'Delta vs County', 'Active Wells', 'Idle Wells', 'Top Formations'].join(','));
            for (const ca of lastDeclineMarketsData.counties) {
                rows.push([
                    csvEscape(ca.county),
                    ca.userWellCount || 0,
                    ca.userMedianYoyPct != null ? ca.userMedianYoyPct : '',
                    ca.userAvgYoyPct != null ? ca.userAvgYoyPct : '',
                    ca.countyMedianYoyPct != null ? ca.countyMedianYoyPct : '',
                    ca.userVsCountyDelta != null ? ca.userVsCountyDelta : '',
                    ca.activeWells || 0,
                    ca.idleWells || 0,
                    csvEscape((ca.topFormations || []).join('; '))
                ].join(','));
            }
            const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'decline-markets-' + new Date().toISOString().substring(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        function exportDeclineResearchCsv() {
            if (!lastDeclineResearchData) {
                showToast('No research data to export', 'error');
                return;
            }
            const rows = [];
            // Export all three sections: decliners, growers, counties
            rows.push(['Section', 'Rank', 'Name', 'Active Wells', 'Avg Decline %'].join(','));
            const decliners = lastDeclineResearchData.operatorsByDecline || [];
            for (let i = 0; i < decliners.length; i++) {
                rows.push(['Steepest Decliners', i + 1, csvEscape(decliners[i].operator), decliners[i].activeWells, decliners[i].avgDecline].join(','));
            }
            const growers = lastDeclineResearchData.operatorsByGrowth || [];
            for (let i = 0; i < growers.length; i++) {
                rows.push(['Top Growers', i + 1, csvEscape(growers[i].operator), growers[i].activeWells, growers[i].avgDecline].join(','));
            }
            rows.push([]);
            rows.push(['County', 'Active Wells', 'Avg Decline %', 'Declining Wells', 'Growing Wells'].join(','));
            for (const c of (lastDeclineResearchData.counties || [])) {
                rows.push([csvEscape(c.county), c.activeWells, c.avgDecline, c.decliningWells, c.growingWells].join(','));
            }
            const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'decline-research-' + new Date().toISOString().substring(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        // =============================================
        // TREND CHART
        // =============================================

        function drawDeclineTrendChart(monthlyTotals) {
            const canvas = document.getElementById('declineTrendChart');
            if (!canvas) {
                console.warn('Decline trend canvas not found');
                return;
            }
            if (!monthlyTotals || monthlyTotals.length === 0) {
                console.warn('No monthly totals data for chart', monthlyTotals);
                return;
            }

            console.log('Drawing trend chart with', monthlyTotals.length, 'months');

            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;

            // Get container width, fallback to 800 if not rendered yet
            const container = canvas.parentElement;
            const containerWidth = container ? container.clientWidth : 800;
            const width = Math.max(containerWidth - 20, 280); // responsive — scale down on mobile
            const height = 120;

            // Set canvas size for high DPI
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            ctx.scale(dpr, dpr);
            const isMobile = width < 400;
            const padding = { top: 20, right: isMobile ? 10 : 20, bottom: 30, left: isMobile ? 40 : 60 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Get data range
            const values = monthlyTotals.map(m => m.totalBOE);
            const maxVal = Math.max(...values) * 1.1;
            const minVal = Math.min(...values) * 0.9;
            const range = maxVal - minVal || 1;

            // Draw grid lines
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight * i / 4);
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
            }

            // Draw Y-axis labels
            ctx.fillStyle = '#6b7280';
            ctx.font = '10px system-ui, sans-serif';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                const val = maxVal - (range * i / 4);
                const y = padding.top + (chartHeight * i / 4);
                ctx.fillText(formatChartNumber(val), padding.left - 8, y + 3);
            }

            // Calculate points
            const points = [];
            monthlyTotals.forEach((m, i) => {
                const x = padding.left + (chartWidth * i / (monthlyTotals.length - 1 || 1));
                const y = padding.top + chartHeight - ((m.totalBOE - minVal) / range * chartHeight);
                points.push({ x, y, data: m });
            });

            // Calculate 3-month moving average for smoothing/trend line
            const trendPoints = values.map((_, i) => {
                const start = Math.max(0, i - 1);
                const end = Math.min(values.length, i + 2);
                const window = values.slice(start, end);
                const avg = window.reduce((sum, v) => sum + v, 0) / window.length;
                const x = padding.left + (chartWidth * i / (monthlyTotals.length - 1 || 1));
                const y = padding.top + chartHeight - ((avg - minVal) / range * chartHeight);
                return { x, y };
            });

            // Draw smoothing/trend line FIRST (behind main line) - thicker, semi-transparent
            ctx.strokeStyle = 'rgba(13, 148, 136, 0.25)';
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();
            trendPoints.forEach((p, i) => {
                if (i === 0) ctx.moveTo(p.x, p.y);
                else ctx.lineTo(p.x, p.y);
            });
            ctx.stroke();

            // Draw main line on top
            ctx.strokeStyle = '#0d9488';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();
            points.forEach((p, i) => {
                if (i === 0) ctx.moveTo(p.x, p.y);
                else ctx.lineTo(p.x, p.y);
            });
            ctx.stroke();

            // Draw points
            ctx.fillStyle = '#0d9488';
            points.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw X-axis labels (every 2-3 months to avoid crowding)
            ctx.fillStyle = '#6b7280';
            ctx.font = '10px system-ui, sans-serif';
            ctx.textAlign = 'center';
            const labelInterval = monthlyTotals.length <= 6 ? 1 : (monthlyTotals.length <= 12 ? 2 : 3);
            monthlyTotals.forEach((m, i) => {
                if (i % labelInterval === 0 || i === monthlyTotals.length - 1) {
                    const x = padding.left + (chartWidth * i / (monthlyTotals.length - 1 || 1));
                    ctx.fillText(formatDeclineMonth(m.yearMonth, true), x, height - 8);
                }
            });
        }

        function formatChartNumber(val) {
            if (val >= 1000000) return (val / 1000000).toFixed(1) + 'M';
            if (val >= 1000) return Math.round(val / 1000) + 'K';
            return Math.round(val).toString();
        }

        // =============================================
        // PRINT SUMMARY
        // =============================================

        function renderDeclinePrintSummary(wells, latestDataMonth) {
            // Get top declining wells (active only, top 10)
            const topDeclining = wells
                .filter(w => w.status === 'active' && w.yoyChangePct !== null && w.yoyChangePct < 0)
                .sort((a, b) => a.yoyChangePct - b.yoyChangePct)
                .slice(0, 10);

            // Get idle wells count
            const idleCount = wells.filter(w => w.status === 'idle').length;

            return `
                <div class="print-summary-table decline-print-summary">
                    <h3 class="chart-title">Top Declining Wells</h3>
                    <p class="summary-note">Production through ${formatDeclineMonth(latestDataMonth)}</p>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Well Name</th>
                                <th>Operator</th>
                                <th>County</th>
                                <th style="text-align: right;">Oil (BBL)</th>
                                <th style="text-align: right;">Gas (MCF)</th>
                                <th style="text-align: right;">YoY</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topDeclining.map(w => `
                            <tr>
                                <td>${escapeHtml(w.wellName)}</td>
                                <td>${escapeHtml(w.operator)}</td>
                                <td>${escapeHtml(w.county)}</td>
                                <td style="text-align: right;">${w.recentOilBBL ? w.recentOilBBL.toLocaleString() : '—'}</td>
                                <td style="text-align: right;">${w.recentGasMCF ? w.recentGasMCF.toLocaleString() : '—'}</td>
                                <td style="text-align: right; color: ${w.yoyChangePct <= -20 ? '#dc2626' : '#d97706'}; font-weight: 600;">${w.yoyChangePct}%</td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${idleCount > 0 ? `<p class="summary-note" style="margin-top: 1rem;">${idleCount} idle well${idleCount !== 1 ? 's' : ''} not shown (no recent production)</p>` : ''}
                </div>
            `;
        }

        // printDeclineSummary() removed - now using global openPrintSummary() function

        // =============================================
        // CROSS-REPORT NAVIGATION HELPERS
        // =============================================

        // Store well data for click-through from VirtualTable rows
        let _wellDataMap = {};
        function storeWellData(wells) {
            _wellDataMap = {};
            for (const w of wells) {
                _wellDataMap[w.clientWellId || w.apiNumber] = w;
            }
        }
        function showWellInfoById(id) {
            const w = _wellDataMap[id];
            if (w) openWellDetailByApi(w.api_number || w.apiNumber, {
                wellName: w.well_name || w.wellName,
                operator: w.operator,
                operatorNumber: w.operator_number || w.operatorNumber,
                county: w.county,
                wellType: w.well_type || w.wellType || w.formation,
                status: w.well_status || w.status,
                clientWellId: w.clientWellId || null
            });
        }

        // showWellInfo() removed — replaced by shared openWellDetailByApi() module

        // Look up operator by name and open the operator detail modal
        async function lookupOperatorDetail(operatorName) {
            if (!operatorName || operatorName === 'Unknown') return;

            // The operator modal and openOperatorDetail() are defined in intelligence-operators.txt
            // But openOperatorDetail needs an operator_number. Use the operator-lookup endpoint.
            try {
                showToast('Loading operator details...', '', 5000);
                const response = await fetch('/api/operators/lookup?name=' + encodeURIComponent(operatorName), { credentials: 'include' });
                if (!response.ok) throw new Error('API error');
                const data = await response.json();
                if (data.operator_number) {
                    openOperatorDetail(data.operator_number);
                } else {
                    showToast('Operator not found in directory', 'error');
                }
            } catch (err) {
                console.error('[Operator Lookup] Error:', err);
                showToast('Could not load operator details', 'error');
            }
        }

        // Risk flag descriptions for tooltips
        const RISK_FLAG_DESCRIPTIONS = {
            'HBP Risk': 'Well first produced within 5 years — extended idle may jeopardize Held By Production status',
            'Sudden Stop': 'Well averaged >50 BOE/month before going idle — unexpected shutdown worth investigating',
            'Operator Pattern': 'More than half of this operator\'s wells in your portfolio are idle'
        };

        // =============================================
        // PRODUCTION DECLINE — MARKET RESEARCH TAB
        // =============================================

        async function fetchDeclineResearch() {
            try {
                const response = await fetch('/api/intelligence/production-decline/research', { credentials: 'include' });
                const data = await response.json();

                if (data.error) {
                    console.error('Decline research error:', data.error);
                    const content = document.getElementById('declineTabContent');
                    if (content) {
                        content.innerHTML = `
                            <div class="report-error">
                                <p>Could not load market research data. Please try again.</p>
                                <button class="btn btn-primary" onclick="fetchDeclineResearch()">Retry</button>
                            </div>
                        `;
                    }
                    return;
                }

                lastDeclineResearchData = data;
                const content = document.getElementById('declineTabContent');
                if (content && declineCurrentTab === 'research') {
                    content.innerHTML = renderDeclineResearchTab(data);
                }
            } catch (error) {
                console.error('Failed to fetch decline research:', error);
                const content = document.getElementById('declineTabContent');
                if (content) {
                    content.innerHTML = `
                        <div class="report-error">
                            <p>Could not load market research data. Please try again.</p>
                            <button class="btn btn-primary" onclick="fetchDeclineResearch()">Retry</button>
                        </div>
                    `;
                }
            }
        }

        function getDeclineColor(rate) {
            if (rate > -10) return '#10b981';   // Green — outperforming the basin
            if (rate > -35) return '#f59e0b';   // Amber — normal basin decline range
            if (rate > -60) return '#f97316';   // Orange — significantly underperforming
            return '#ef4444';                    // Red — alarming decline
        }

        function switchDeclineResearchView(view) {
            declineResearchView = view;
            document.querySelectorAll('.decline-research-view').forEach(el => el.style.display = 'none');
            const active = document.getElementById('declineResearch_' + view);
            if (active) active.style.display = '';
            document.querySelectorAll('.decline-research-toggle .toggle-btn').forEach(b => {
                const isActive = b.dataset.view === view;
                b.classList.toggle('active', isActive);
                b.style.background = isActive ? 'var(--oil-navy)' : 'transparent';
                b.style.color = isActive ? 'white' : 'var(--slate-blue)';
            });
        }

        function sortDeclineResearchCounties(sortType) {
            declineResearchCountySort = sortType;
            if (lastDeclineResearchData) {
                const container = document.getElementById('declineResearchCounties');
                if (container) {
                    container.innerHTML = renderDeclineResearchCountyCards(lastDeclineResearchData.counties);
                }
                document.querySelectorAll('.decline-research-sort .sort-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.sort === sortType);
                    b.style.background = b.dataset.sort === sortType ? 'var(--oil-navy)' : 'white';
                    b.style.color = b.dataset.sort === sortType ? 'white' : 'var(--slate-blue)';
                });
            }
        }

        function renderDeclineResearchTab(data) {
            const { summary, operatorsByDecline, operatorsByGrowth, counties } = data;
            const horizonLabel = formatHorizonMonth(summary.dataHorizon);
            let html = '';

            html += `<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                <p class="pooling-tab-intro" style="margin-bottom: 0;">
                    Statewide production decline intelligence using BOE-equivalent year-over-year analysis.
                </p>
                <button class="pooling-btn-export" onclick="exportDeclineResearchCsv()" style="flex-shrink: 0; margin-left: 1rem;">⤓ Export CSV</button>
            </div>`;

            // HUD Summary Cards
            html += `<div class="pooling-insight-cards">`;

            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Statewide Avg Decline</div>
                    <div style="font-size: 2rem; font-weight: 700; color: ${getDeclineColor(summary.avgDecline)}; margin: 0.5rem 0;">
                        ${summary.avgDecline}%
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                        BOE year-over-year across ${summary.activePuns.toLocaleString()} active PUNs
                    </div>
                </div>
            `;

            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Steep Decline (>25%)</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #f97316; margin: 0.5rem 0;">
                        ${summary.steepDecline.toLocaleString()}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                        Wells losing more than 25% production YoY
                    </div>
                </div>
            `;

            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Growing Production</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #10b981; margin: 0.5rem 0;">
                        ${summary.growingWells.toLocaleString()}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                        Wells with >5% YoY growth (${summary.flatWells.toLocaleString()} flat)
                    </div>
                </div>
            `;

            html += `</div>`;

            html += `
                <div style="font-size: 0.75rem; color: var(--text-muted); margin: 1rem 0 1.5rem; font-style: italic;">
                    Data as of ${horizonLabel}. Decline = BOE year-over-year change comparing 3-month windows.
                    Active wells only (produced within 3 months of data horizon). Min 20 wells per operator.
                    Operators listed as "OTC/OCC NOT ASSIGNED" are excluded from rankings.
                </div>
            `;

            // Segmented control
            html += `
                <div class="decline-research-toggle" style="display: inline-flex; background: #f1f5f9; border-radius: 8px; padding: 3px; margin-bottom: 1.5rem;">
                    <button class="toggle-btn ${declineResearchView === 'decliners' ? 'active' : ''}" data-view="decliners" onclick="switchDeclineResearchView('decliners')" style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; background: ${declineResearchView === 'decliners' ? 'var(--oil-navy)' : 'transparent'}; color: ${declineResearchView === 'decliners' ? 'white' : 'var(--slate-blue)'};">Steepest Decliners</button>
                    <button class="toggle-btn ${declineResearchView === 'growers' ? 'active' : ''}" data-view="growers" onclick="switchDeclineResearchView('growers')" style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; background: ${declineResearchView === 'growers' ? 'var(--oil-navy)' : 'transparent'}; color: ${declineResearchView === 'growers' ? 'white' : 'var(--slate-blue)'};">Top Growers</button>
                    <button class="toggle-btn ${declineResearchView === 'counties' ? 'active' : ''}" data-view="counties" onclick="switchDeclineResearchView('counties')" style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; background: ${declineResearchView === 'counties' ? 'var(--oil-navy)' : 'transparent'}; color: ${declineResearchView === 'counties' ? 'white' : 'var(--slate-blue)'};">County Trends</button>
                </div>
            `;

            // View: Steepest Decliners
            html += `<div id="declineResearch_decliners" class="decline-research-view" style="${declineResearchView !== 'decliners' ? 'display:none;' : ''}">
                <div style="margin-bottom: 1rem;">
                    <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--oil-navy); margin-bottom: 0.25rem;">Steepest Declining Operators</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">Operators with steepest average production decline (minimum 20 active wells)</p>
                </div>
                ${renderDeclineOperatorTable(operatorsByDecline)}
            </div>`;

            // View: Top Growers
            html += `<div id="declineResearch_growers" class="decline-research-view" style="${declineResearchView !== 'growers' ? 'display:none;' : ''}">
                <div style="margin-bottom: 1rem;">
                    <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--oil-navy); margin-bottom: 0.25rem;">Top Growing Operators</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">Operators maintaining or growing production (minimum 20 active wells)</p>
                </div>
                ${renderDeclineOperatorTable(operatorsByGrowth)}
            </div>`;

            // View: County Trends
            html += `<div id="declineResearch_counties" class="decline-research-view" style="${declineResearchView !== 'counties' ? 'display:none;' : ''}">
                <div style="margin-bottom: 1rem;">
                    <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--oil-navy); margin-bottom: 0.25rem;">County Production Trends</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">Average decline rates across Oklahoma counties (minimum 10 active wells)</p>
                </div>
                <div class="decline-research-sort" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="sort-btn ${declineResearchCountySort === 'rate' ? 'active' : ''}" data-sort="rate" onclick="sortDeclineResearchCounties('rate')" style="padding: 0.375rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: ${declineResearchCountySort === 'rate' ? 'var(--oil-navy)' : 'white'}; color: ${declineResearchCountySort === 'rate' ? 'white' : 'var(--slate-blue)'};">Decline Rate</button>
                    <button class="sort-btn ${declineResearchCountySort === 'count' ? 'active' : ''}" data-sort="count" onclick="sortDeclineResearchCounties('count')" style="padding: 0.375rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: ${declineResearchCountySort === 'count' ? 'var(--oil-navy)' : 'white'}; color: ${declineResearchCountySort === 'count' ? 'white' : 'var(--slate-blue)'};">Well Count</button>
                    <button class="sort-btn ${declineResearchCountySort === 'name' ? 'active' : ''}" data-sort="name" onclick="sortDeclineResearchCounties('name')" style="padding: 0.375rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: ${declineResearchCountySort === 'name' ? 'var(--oil-navy)' : 'white'}; color: ${declineResearchCountySort === 'name' ? 'white' : 'var(--slate-blue)'};">Name</button>
                </div>
                <div id="declineResearchCounties">${renderDeclineResearchCountyCards(counties)}</div>
            </div>`;

            return html;
        }

        function renderDeclineOperatorTable(operators) {
            if (!operators || operators.length === 0) {
                return '<div class="pooling-empty">No operator data available</div>';
            }

            let html = `<div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border); text-align: left;">
                            <th style="padding: 0.5rem 0.75rem; font-weight: 600; color: var(--oil-navy);">Operator</th>
                            <th style="padding: 0.5rem 0.75rem; font-weight: 600; color: var(--oil-navy); text-align: right;">Active Wells</th>
                            <th style="padding: 0.5rem 0.75rem; font-weight: 600; color: var(--oil-navy); text-align: right; min-width: 140px;">Avg Decline (YoY)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const op of operators) {
                const rateColor = getDeclineColor(op.avgDecline);
                // Map decline to bar width: -100% = full bar left, +50% = full bar right
                // Normalize around 0: negative = red bar, positive = green bar
                const barPct = Math.min(Math.abs(op.avgDecline), 100);
                const sign = op.avgDecline >= 0 ? '+' : '';
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.5rem 0.75rem; font-weight: 500; color: var(--oil-navy); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(op.operator)}">${op.operatorNumber ? `<span class="vt-well-link" onclick="openOperatorDetail('${escapeAttr(op.operatorNumber)}')">${escapeHtml(op.operator)}</span>` : escapeHtml(op.operator)}</td>
                        <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--slate-blue);">${op.activeWells.toLocaleString()}</td>
                        <td style="padding: 0.5rem 0.75rem; text-align: right;">
                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem;">
                                <div style="width: 60px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                    <div style="width: ${barPct}%; height: 100%; background: ${rateColor}; border-radius: 3px;"></div>
                                </div>
                                <span style="font-weight: 600; color: ${rateColor}; min-width: 50px; text-align: right;">${sign}${op.avgDecline}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            }

            html += `</tbody></table></div>`;
            return html;
        }

        function renderDeclineResearchCountyCards(counties) {
            if (!counties || counties.length === 0) {
                return '<div class="pooling-empty">No county data available</div>';
            }

            let sorted = [...counties];
            if (declineResearchCountySort === 'rate') {
                sorted.sort((a, b) => a.avgDecline - b.avgDecline);
            } else if (declineResearchCountySort === 'count') {
                sorted.sort((a, b) => b.activeWells - a.activeWells);
            } else if (declineResearchCountySort === 'name') {
                sorted.sort((a, b) => (a.county || '').localeCompare(b.county || ''));
            }

            let html = '<div class="pooling-insight-cards" style="grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));">';

            for (const c of sorted) {
                const rateColor = getDeclineColor(c.avgDecline);
                const sign = c.avgDecline >= 0 ? '+' : '';
                const totalWells = c.decliningWells + c.growingWells;
                const growPct = totalWells > 0 ? Math.round(100 * c.growingWells / totalWells) : 0;
                html += `
                    <div class="pooling-insight-card" style="padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div class="insight-card-title" style="margin-bottom: 0;">${escapeHtml(c.county)}</div>
                            <span style="font-size: 1.1rem; font-weight: 700; color: ${rateColor};">${sign}${c.avgDecline}%</span>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--slate-blue); margin-bottom: 0.5rem;">
                            ${c.activeWells.toLocaleString()} active wells
                        </div>
                        <div style="margin-bottom: 0.25rem;">
                            <div style="display: flex; height: 4px; border-radius: 2px; overflow: hidden; background: #fee2e2;">
                                <div style="width: ${growPct}%; background: #bbf7d0;"></div>
                            </div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); display: flex; justify-content: space-between;">
                            <span>${c.growingWells} growing</span>
                            <span>${c.decliningWells} declining</span>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // =============================================
        // SHUT-IN DETECTOR
        // =============================================
        let lastShutInData = null;
        let shutInVirtualTable = null;
        let shutInCurrentTab = 'properties';
        let lastShutInMarketsData = null;
        let lastShutInResearchData = null;
        let shutInMarketSort = 'performance';
        let shutInResearchCountySort = 'rate';
        let shutInResearchView = 'byCount';

        async function loadShutInDetectorReport(forceRefresh = false) {
            // Push history so back button returns to intelligence home
            history.pushState({ intelView: 'report' }, '');
            intelViewOpen = 'report';
            currentReportType = 'shut-in-detector';
            shutInCurrentTab = 'properties';
            lastShutInMarketsData = null;

            const main = document.querySelector('main');
            const hero = document.querySelector('.intel-hero');
            const viewer = document.getElementById('reportViewer');
            if (main) main.style.display = 'none';
            if (hero) hero.style.display = 'none';
            viewer.style.display = 'block';
            window.scrollTo(0, 0);

            document.getElementById('reportBreadcrumb').textContent = 'Shut-In Detector';
            document.getElementById('reportTitle').textContent = 'Shut-In Detector';
            document.getElementById('reportContent').innerHTML = '<div class="report-loading">Scanning your portfolio for idle and shut-in wells...</div>';
            document.getElementById('reportSubtitle').textContent = 'Loading...';
            document.getElementById('reportStatus').textContent = '';
            document.getElementById('reportStatus').className = 'report-status';
            document.getElementById('reportMeta').textContent = '';

            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 30000);

                const url = forceRefresh ? '/api/intelligence/shut-in-detector?bust=1' : '/api/intelligence/shut-in-detector';
                const response = await fetch(url, {
                    credentials: 'include',
                    signal: controller.signal
                });

                if (!response.ok) {
                    throw new Error('API returned ' + response.status);
                }

                const data = await response.json();
                renderShutInDetector(data);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Shut-in detector request timed out');
                } else {
                    console.error('Failed to load shut-in detector:', error);
                }
                document.getElementById('reportContent').innerHTML = `
                    <div class="report-error">
                        <p>Could not load shut-in analysis. Please try again.</p>
                        <button class="btn btn-primary" onclick="loadShutInDetectorReport(true)">Retry</button>
                        <button class="btn btn-ghost" onclick="closeReport()" style="margin-left: 0.5rem;">Back</button>
                    </div>
                `;
            }
        }

        function shutInStatusLabel(status) {
            switch (status) {
                case 'recently_idle': return 'Idle';
                case 'extended_idle': return 'Extended Idle';
                case 'no_recent_production': return 'Long-Term Idle';
                case 'no_data': return 'No Data';
                default: return status;
            }
        }

        function shutInStatusBadgeClass(status) {
            switch (status) {
                case 'recently_idle': return 'shutin-badge-warning';
                case 'extended_idle': return 'shutin-badge-danger';
                case 'no_recent_production': return 'shutin-badge-critical';
                case 'no_data': return 'shutin-badge-neutral';
                default: return '';
            }
        }

        function renderShutInDonut(total, recentlyIdle, extendedIdle, noRecentProd, hbpRisk) {
            if (total === 0) return '';

            const r = 60;
            const stroke = 22;
            const cx = 80;
            const cy = 80;
            const circumference = 2 * Math.PI * r;

            const segments = [
                { label: 'Idle (3-6 mo)', count: recentlyIdle, color: '#f59e0b' },
                { label: 'Extended Idle (6-12 mo)', count: extendedIdle, color: '#f97316' },
                { label: 'Long-Term Idle (12+ mo)', count: noRecentProd, color: '#ef4444' }
            ].filter(s => s.count > 0);

            let offset = 0;
            const arcs = segments.map(seg => {
                const pct = seg.count / total;
                const len = pct * circumference;
                const arc = `<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${seg.color}" stroke-width="${stroke}" stroke-dasharray="${len} ${circumference - len}" stroke-dashoffset="${-offset}" transform="rotate(-90 ${cx} ${cy})"/>`;
                offset += len;
                return arc;
            });

            const legendItems = segments.map(seg => {
                const pct = Math.round((seg.count / total) * 100);
                return `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <span style="width: 10px; height: 10px; border-radius: 2px; background: ${seg.color}; flex-shrink: 0;"></span>
                    <span style="font-size: 0.8rem; color: var(--slate-blue);">${seg.label}</span>
                    <span style="font-size: 0.8rem; font-weight: 600; color: var(--oil-navy); margin-left: auto;">${seg.count}</span>
                    <span style="font-size: 0.75rem; color: var(--text-muted); width: 36px; text-align: right;">${pct}%</span>
                </div>`;
            }).join('');

            const hbpNote = hbpRisk > 0
                ? `<div style="margin-top: 10px; font-size: 0.75rem; color: #dc2626; display: flex; align-items: center; gap: 6px;">
                    <span style="width: 6px; height: 6px; border-radius: 50%; background: #dc2626; flex-shrink: 0;"></span>
                    ${hbpRisk} well${hbpRisk !== 1 ? 's' : ''} flagged for potential HBP risk
                  </div>`
                : '';

            return `<div style="display: flex; align-items: center; gap: 2rem; padding: 1rem 0; border-bottom: 1px solid var(--border-color, #e2e8f0);">
                <div style="flex-shrink: 0; position: relative; width: 160px; height: 160px;">
                    <svg width="160" height="160" viewBox="0 0 160 160">
                        <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="#f1f5f9" stroke-width="${stroke}"/>
                        ${arcs.join('')}
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--oil-navy, #1C2B36); line-height: 1;">${total}</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted, #64748b); margin-top: 2px;">idle wells</div>
                    </div>
                </div>
                <div style="flex: 1; min-width: 0;">
                    ${legendItems}
                    ${hbpNote}
                </div>
            </div>`;
        }

        function classifyNoDataWell(well) {
            if (well.taxPeriodActive === false) return 'ceased';
            if (well.taxPeriodActive === true) return 'pre_data';
            return 'unlinked';
        }

        function noDataSubLabel(well) {
            const type = classifyNoDataWell(well);
            if (type === 'ceased') {
                const endDate = well.taxPeriodEnd;
                const year = endDate ? endDate.substring(0, 4) : '';
                return year ? 'Ceased (' + year + ')' : 'Ceased';
            }
            if (type === 'pre_data') {
                const start = well.taxPeriodStart;
                const year = start ? start.substring(0, 4) : '';
                return year ? 'No Production Data (est. ' + year + ')' : 'No Production Data';
            }
            return 'No OTC Link';
        }

        function renderNoDataSection(noDataWells) {
            if (noDataWells.length === 0) return '';
            const ceased = noDataWells.filter(w => classifyNoDataWell(w) === 'ceased');
            const preData = noDataWells.filter(w => classifyNoDataWell(w) === 'pre_data');
            const unlinked = noDataWells.filter(w => classifyNoDataWell(w) === 'unlinked');

            const pill = (label, count, color) => count > 0 ? `<span style="display:inline-flex;align-items:center;gap:4px;font-size:0.75rem;padding:2px 8px;border-radius:10px;background:${color};color:white;">${count} ${label}</span>` : '';

            const rows = noDataWells.map(w => {
                const type = classifyNoDataWell(w);
                const badgeColor = type === 'ceased' ? '#64748b' : type === 'pre_data' ? '#8b5cf6' : '#94a3b8';
                const label = noDataSubLabel(w);
                return `<tr style="border-bottom:1px solid #f1f5f9;">
                    <td style="padding:8px 10px;font-size:0.82rem;"><span class="vt-well-link" onclick="showWellInfoById('${w.clientWellId || w.apiNumber}')">${escapeHtml(w.wellName)}</span></td>
                    <td style="padding:8px 10px;font-size:0.82rem;" class="vt-hide-mobile">${w.operator !== 'Unknown' ? '<span class="vt-well-link" onclick="' + (w.operatorNumber ? "openOperatorDetail('" + escapeAttr(w.operatorNumber) + "')" : "lookupOperatorDetail('" + escapeAttr(w.operator) + "')") + '">' + escapeHtml(w.operator) + '</span>' : escapeHtml(w.operator)}</td>
                    <td style="padding:8px 10px;font-size:0.82rem;">${escapeHtml(w.county)}</td>
                    <td style="padding:8px 10px;"><span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.7rem;font-weight:600;background:${badgeColor};color:white;">${escapeHtml(label)}</span></td>
                    <td style="padding:8px 10px;font-size:0.82rem;color:var(--text-muted);">${w.riskFlags.length > 0 ? w.riskFlags.map(f => { let cls = 'risk-pill'; if (f === 'HBP Risk') cls += ' risk-hbp'; else if (f === 'Sudden Stop') cls += ' risk-sudden'; else if (f === 'Operator Pattern') cls += ' risk-operator'; return '<span class="' + cls + '">' + escapeHtml(f) + '</span>'; }).join(' ') : '—'}</td>
                </tr>`;
            }).join('');

            return `<div style="margin-top:1.5rem;border:1px solid #e2e8f0;border-radius:10px;overflow:hidden;">
                <div onclick="this.parentElement.querySelector('.nodata-body').style.display = this.parentElement.querySelector('.nodata-body').style.display === 'none' ? 'block' : 'none'; this.querySelector('.nodata-chevron').style.transform = this.parentElement.querySelector('.nodata-body').style.display === 'none' ? '' : 'rotate(90deg)'" style="background:#f8fafc;padding:12px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;user-select:none;">
                    <span class="nodata-chevron" style="font-size:0.7rem;color:var(--text-muted);transition:transform 0.15s;">&#9654;</span>
                    <span style="font-size:0.85rem;font-weight:600;color:var(--oil-navy);">Historical / No OTC Data</span>
                    <span style="font-size:0.75rem;color:var(--text-muted);">${noDataWells.length} well${noDataWells.length !== 1 ? 's' : ''}</span>
                    <div style="margin-left:auto;display:flex;gap:6px;">
                        ${pill('Ceased', ceased.length, '#64748b')}
                        ${pill('No Prod Data', preData.length, '#8b5cf6')}
                        ${pill('No OTC Link', unlinked.length, '#94a3b8')}
                    </div>
                </div>
                <div class="nodata-body" style="display:none;">
                    <div style="padding:10px 16px 6px;font-size:0.75rem;color:var(--text-muted);line-height:1.5;">
                        These wells have no production data in the OTC reporting window (2017-present).
                        <strong>Ceased</strong> = all OTC tax periods ended.
                        <strong>No Production Data</strong> = OTC tax period still registered but no reported production.
                        <strong>No OTC Link</strong> = well has no valid PUN link to OTC data.
                    </div>
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f8fafc;border-bottom:1px solid #e2e8f0;">
                                <th style="padding:8px 10px;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.3px;color:var(--text-muted);text-align:left;">Well Name</th>
                                <th style="padding:8px 10px;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.3px;color:var(--text-muted);text-align:left;" class="vt-hide-mobile">Operator</th>
                                <th style="padding:8px 10px;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.3px;color:var(--text-muted);text-align:left;">County</th>
                                <th style="padding:8px 10px;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.3px;color:var(--text-muted);text-align:left;">Status</th>
                                <th style="padding:8px 10px;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.3px;color:var(--text-muted);text-align:left;">Risk Flags</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            </div>`;
        }

        function renderShutInDetector(data) {
            lastShutInData = data;
            const { summary, wells } = data;

            // Separate idle wells from no-data wells
            const idleWells = wells.filter(w => w.status !== 'no_data');
            const noDataWells = wells.filter(w => w.status === 'no_data');
            const idleCount = idleWells.length;

            // Update header
            document.getElementById('reportSubtitle').textContent = 'Wells with no reported production in 3+ months';
            document.getElementById('reportMeta').innerHTML = `${idleCount} idle well${idleCount !== 1 ? 's' : ''} detected` +
                (noDataWells.length > 0 ? ` · ${noDataWells.length} with no OTC data` : '') +
                '<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Based on OTC production data, updated daily at 8am CT</div>';

            if (idleCount === 0 && noDataWells.length === 0) {
                document.getElementById('reportContent').innerHTML = `
                    <div class="report-empty-state" style="text-align: center; padding: 3rem 1.5rem;">
                        <div style="font-size: 2.5rem; margin-bottom: 1rem;">&#10003;</div>
                        <h3 style="font-size: 1.1rem; color: var(--oil-navy); margin-bottom: 0.5rem;">All Clear</h3>
                        <p style="color: var(--slate-blue); font-size: 0.9rem;">All wells in your portfolio are actively producing. No shut-in wells detected.</p>
                    </div>
                `;
                return;
            }

            // Get unique counties for filters (from idle wells only)
            const counties = [...new Set(idleWells.map(w => w.county).filter(Boolean))].sort();

            // Donut chart handles the full summary — no separate cards needed

            // Toolbar (no No Data filter needed — they're in their own section)
            const toolbarHtml = `
                <div class="shutin-toolbar">
                    <div class="shutin-filters">
                        <select id="shutinStatusFilter" onchange="filterShutInWells()" class="shutin-select">
                            <option value="">All Status</option>
                            <option value="recently_idle">Idle (3-6mo)</option>
                            <option value="extended_idle">Extended Idle (6-12mo)</option>
                            <option value="no_recent_production">Long-Term Idle (12+mo)</option>
                        </select>
                        <select id="shutinRiskFilter" onchange="filterShutInWells()" class="shutin-select">
                            <option value="">All Risk Flags</option>
                            <option value="HBP Risk">HBP Risk</option>
                            <option value="Sudden Stop">Sudden Stop</option>
                            <option value="Operator Pattern">Operator Pattern</option>
                        </select>
                        <select id="shutinCountyFilter" onchange="filterShutInWells()" class="shutin-select">
                            <option value="">All Counties</option>
                            ${counties.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}
                        </select>
                    </div>
                    <button class="pooling-btn-export" onclick="exportShutInCsv()">&#10515; Export CSV</button>
                </div>
            `;

            // Donut chart — only idle wells (not no data)
            const recentCount = idleWells.filter(w => w.status === 'recently_idle').length;
            const extendedCount = idleWells.filter(w => w.status === 'extended_idle').length;
            const noRecentCount = idleWells.filter(w => w.status === 'no_recent_production').length;
            const donutHtml = idleCount > 0 ? renderShutInDonut(idleCount, recentCount, extendedCount, noRecentCount, summary.hbpRisk) : '';

            // Tab bar
            const tabHtml = `
                <div class="pooling-tabs" id="shutInTabs">
                    <button class="pooling-tab active" data-tab="properties" onclick="switchShutInTab('properties')">
                        My Portfolio <span class="tab-badge">${idleCount}</span>
                    </button>
                    <button class="pooling-tab" data-tab="markets" onclick="switchShutInTab('markets')">
                        My Markets <span class="tab-badge" id="shutInMarketsCountBadge">&ndash;</span>
                    </button>
                    <button class="pooling-tab" data-tab="research" onclick="switchShutInTab('research')">
                        Market Research
                    </button>
                </div>
            `;

            // No data section (collapsible)
            const noDataHtml = renderNoDataSection(noDataWells);

            // Properties tab content (rendered inline on first load)
            const propertiesHtml = `
                ${toolbarHtml}
                <div id="shutinTableContainer" style="margin-top: 0.75rem;"></div>
                ${noDataHtml}
                <div class="about-data-card" style="margin-top: 1.5rem;">
                    <h4 style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--oil-navy);">About This Report</h4>
                    <ul style="font-size: 0.8rem; color: var(--slate-blue); line-height: 1.6; padding-left: 1.25rem;">
                        <li><strong>Idle (3-6mo)</strong> — Well has not reported production in 3-6 months. May be undergoing workover or temporary shut-in.</li>
                        <li><strong>Extended Idle (6-12mo)</strong> — No production for 6-12 months. Monitor for potential plugging or lease issues.</li>
                        <li><strong>Long-Term Idle (12+mo)</strong> — Idle for over a year. Consider lease review and HBP implications.</li>
                        <li><strong>HBP Risk</strong> — Well first produced within 5 years. Extended idle may jeopardize Held By Production status.</li>
                        <li><strong>Sudden Stop</strong> — Well averaged &gt;50 BOE/month before going idle. Unexpected shutdown worth investigating.</li>
                        <li><strong>Operator Pattern</strong> — More than half of this operator's wells in your portfolio are idle.</li>
                    </ul>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = `
                ${donutHtml}
                ${tabHtml}
                <div id="shutInTabContent">
                    ${propertiesHtml}
                </div>
            `;

            // Only init the VirtualTable with idle wells (not no data)
            initShutInVirtualTable(idleWells);
        }

        function initShutInVirtualTable(wells) {
            const container = document.getElementById('shutinTableContainer');
            if (!container) return;

            if (shutInVirtualTable) {
                shutInVirtualTable.destroy();
            }

            // Assign sort priority and status severity for proper column sorting
            const STATUS_SEVERITY = { 'no_recent_production': 0, 'extended_idle': 1, 'recently_idle': 2 };
            const wellsWithMeta = wells.map(w => {
                let priority = 3;
                if (w.riskFlags.includes('HBP Risk')) priority = 0;
                else if (w.riskFlags.includes('Sudden Stop')) priority = 1;
                else if (w.riskFlags.includes('Operator Pattern')) priority = 2;

                let rowClass = '';
                if (w.riskFlags.includes('HBP Risk')) rowClass = 'shutin-row-hbp';
                else if (w.riskFlags.includes('Sudden Stop')) rowClass = 'shutin-row-sudden';
                else if (w.riskFlags.includes('Operator Pattern')) rowClass = 'shutin-row-operator';

                return { ...w, _sortPriority: priority, _statusSeverity: STATUS_SEVERITY[w.status] ?? 1, _rowClass: rowClass };
            });

            // Store well data for click-through modal
            storeWellData(wellsWithMeta);

            // Default sort: risk priority ASC, then months idle DESC
            wellsWithMeta.sort((a, b) => {
                if (a._sortPriority !== b._sortPriority) return a._sortPriority - b._sortPriority;
                return b.monthsIdle - a.monthsIdle;
            });

            shutInVirtualTable = new VirtualTable({
                container: container,
                rowHeight: 52,
                maxHeight: 550,
                data: wellsWithMeta,
                defaultSort: '_sortPriority',
                defaultSortDir: 'asc',

                columns: [
                    {
                        key: 'wellName',
                        label: 'Well Name',
                        width: '22%',
                        sortable: true,
                        render: (val, row) => `<span class="vt-well-link" onclick="showWellInfoById('${row.clientWellId || row.apiNumber}')">${escapeHtml(val)}</span>`
                    },
                    {
                        key: 'operator',
                        label: 'Operator',
                        width: '18%',
                        sortable: true,
                        className: 'vt-hide-mobile',
                        render: (val, row) => val && val !== 'Unknown' ? `<span class="vt-well-link" onclick="${row.operatorNumber ? `openOperatorDetail('${escapeAttr(row.operatorNumber)}')` : `lookupOperatorDetail('${escapeAttr(val)}')`}">${escapeHtml(val)}</span>` : escapeHtml(val || '—')
                    },
                    {
                        key: 'county',
                        label: 'County',
                        width: '11%',
                        sortable: true
                    },
                    {
                        key: '_statusSeverity',
                        label: 'Status',
                        width: '13%',
                        sortable: true,
                        render: (val, row) => `<span class="shutin-status-badge ${shutInStatusBadgeClass(row.status)}">${shutInStatusLabel(row.status)}</span>`
                    },
                    {
                        key: 'monthsIdle',
                        label: 'Mo. Idle',
                        width: '8%',
                        sortable: true,
                        className: 'numeric',
                        render: (val) => val >= 999 ? '—' : val
                    },
                    {
                        key: 'lastProdMonth',
                        label: 'Last Prod',
                        width: '10%',
                        sortable: true,
                        className: 'numeric',
                        render: (val, row) => {
                            if (val) return formatDeclineMonth(val, true);
                            if (row.taxPeriodStart) return '<span style="color:var(--text-muted);" title="Tax period start date (no OTC production data)">Since ' + row.taxPeriodStart.substring(0, 4) + '</span>';
                            return '<span style="color:var(--text-muted);">—</span>';
                        }
                    },
                    {
                        key: 'riskFlags',
                        label: 'Risk Flags',
                        width: '18%',
                        sortable: false,
                        render: (val) => {
                            if (!val || val.length === 0) return '<span style="color: var(--text-muted);">—</span>';
                            const SHORT_LABELS = { 'HBP Risk': 'HBP Risk', 'Sudden Stop': 'Sudden Stop', 'Operator Pattern': 'Op Pattern' };
                            return val.map(flag => {
                                let cls = 'risk-pill';
                                if (flag === 'HBP Risk') cls += ' risk-hbp';
                                else if (flag === 'Sudden Stop') cls += ' risk-sudden';
                                else if (flag === 'Operator Pattern') cls += ' risk-operator';
                                const desc = RISK_FLAG_DESCRIPTIONS[flag] || flag;
                                return `<span class="${cls}" title="${escapeHtml(desc)}">${escapeHtml(SHORT_LABELS[flag] || flag)}</span>`;
                            }).join(' ');
                        }
                    }
                ],

                onSort: (key, dir) => {
                    console.log(`Shut-in sorted by ${key} ${dir}`);
                }
            });

            container.addEventListener('click', (e) => {
                const link = e.target.closest('.vt-well-link');
                if (link) e.stopPropagation();
            });
        }

        function filterShutInWells() {
            if (!lastShutInData || !shutInVirtualTable) return;

            const statusFilter = document.getElementById('shutinStatusFilter')?.value || '';
            const riskFilter = document.getElementById('shutinRiskFilter')?.value || '';
            const countyFilter = document.getElementById('shutinCountyFilter')?.value || '';

            shutInVirtualTable.filter(well => {
                if (statusFilter && well.status !== statusFilter) return false;
                if (riskFilter && !well.riskFlags.includes(riskFilter)) return false;
                if (countyFilter && well.county !== countyFilter) return false;
                return true;
            });
        }

        function exportShutInCsv() {
            if (!lastShutInData) return;

            const wells = lastShutInData.wells;
            const rows = [
                ['Well Name', 'API Number', 'Operator', 'County', 'Status', 'Months Idle', 'Last Production', 'Risk Flags'].join(',')
            ];

            for (const w of wells) {
                rows.push([
                    csvEscape(w.wellName),
                    csvEscape(w.apiNumber),
                    csvEscape(w.operator),
                    csvEscape(w.county),
                    w.status === 'no_data' ? noDataSubLabel(w) : shutInStatusLabel(w.status),
                    w.monthsIdle >= 999 ? '' : w.monthsIdle,
                    w.lastProdMonth || (w.taxPeriodStart ? 'Since ' + w.taxPeriodStart.substring(0, 4) : ''),
                    csvEscape(w.riskFlags.join('; '))
                ].join(','));
            }

            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'shut-in-detector-' + new Date().toISOString().substring(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        function exportShutInMarketsCsv() {
            if (!lastShutInMarketsData || !lastShutInMarketsData.counties) {
                showToast('No market data to export', 'error');
                return;
            }
            const rows = [];
            rows.push(['County', 'Your Wells', 'Your Idle Wells', 'Your Idle Rate %', 'County Idle Rate %', 'Delta vs County', 'County Total Wells', 'County Idle Wells'].join(','));
            for (const ca of lastShutInMarketsData.counties) {
                rows.push([
                    csvEscape(ca.county),
                    ca.userWellCount || 0,
                    ca.userIdleWells || 0,
                    ca.userIdleRate != null ? ca.userIdleRate.toFixed(1) : '',
                    ca.idleRate != null ? ca.idleRate.toFixed(1) : '',
                    ca.userVsCountyDelta != null ? ca.userVsCountyDelta.toFixed(1) : '',
                    ca.totalWells || 0,
                    ca.idleWells || 0
                ].join(','));
            }
            const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'shut-in-markets-' + new Date().toISOString().substring(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        function exportShutInResearchCsv() {
            if (!lastShutInResearchData) {
                showToast('No research data to export', 'error');
                return;
            }
            const rows = [];
            rows.push(['Section', 'Rank', 'Name', 'Total Wells', 'Idle Wells', 'Idle Rate %'].join(','));
            const byCount = lastShutInResearchData.operatorsByCount || [];
            for (let i = 0; i < byCount.length; i++) {
                rows.push(['Most Idle Wells', i + 1, csvEscape(byCount[i].operator), byCount[i].totalWells, byCount[i].idleWells, byCount[i].idleRatePct].join(','));
            }
            const byRate = lastShutInResearchData.operatorsByRate || [];
            for (let i = 0; i < byRate.length; i++) {
                rows.push(['Highest Idle Rate', i + 1, csvEscape(byRate[i].operator), byRate[i].totalWells, byRate[i].idleWells, byRate[i].idleRatePct].join(','));
            }
            rows.push([]);
            rows.push(['County', 'Total Wells', 'Idle Wells', 'Idle Rate %', 'Top Idle Operator'].join(','));
            for (const c of (lastShutInResearchData.counties || [])) {
                const countyName = (c.county || '').replace(/^\d{3}-/, '');
                rows.push([csvEscape(countyName), c.totalWells, c.idleWells, c.idleRatePct, csvEscape(c.topIdleOperator || '')].join(','));
            }
            const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'shut-in-research-' + new Date().toISOString().substring(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV downloaded', 'success');
        }

        // =============================================
        // SHUT-IN DETECTOR — MY MARKETS TAB
        // =============================================

        function switchShutInTab(tab) {
            shutInCurrentTab = tab;

            // Update tab buttons (scope to shutInTabs to avoid collision with decline tabs)
            const tabContainer = document.getElementById('shutInTabs');
            if (tabContainer) {
                tabContainer.querySelectorAll('.pooling-tab').forEach(t => t.classList.remove('active'));
                tabContainer.querySelector(`.pooling-tab[data-tab="${tab}"]`)?.classList.add('active');
            }

            const content = document.getElementById('shutInTabContent');
            if (!content || !lastShutInData) return;

            if (tab === 'properties') {
                const { wells } = lastShutInData;
                const idleWells = wells.filter(w => w.status !== 'no_data');
                const noDataWells = wells.filter(w => w.status === 'no_data');
                const counties = [...new Set(idleWells.map(w => w.county).filter(Boolean))].sort();
                content.innerHTML = renderShutInPropertiesContent(idleWells, counties, noDataWells);
                setTimeout(() => initShutInVirtualTable(idleWells), 0);
            } else if (tab === 'markets') {
                if (lastShutInMarketsData) {
                    content.innerHTML = renderShutInMarketsTab(lastShutInMarketsData);
                } else {
                    content.innerHTML = `
                        <div style="padding: 3rem; text-align: center; color: var(--text-muted);">
                            <div class="report-loading">Loading county benchmarks...</div>
                        </div>
                    `;
                    fetchShutInMarkets();
                }
            } else if (tab === 'research') {
                if (lastShutInResearchData) {
                    content.innerHTML = renderShutInResearchTab(lastShutInResearchData);
                } else {
                    content.innerHTML = `
                        <div style="padding: 3rem; text-align: center; color: var(--text-muted);">
                            <div class="report-loading">Loading statewide idle data...</div>
                        </div>
                    `;
                    fetchShutInResearch();
                }
            }
        }

        function renderShutInPropertiesContent(wells, counties, noDataWells) {
            if (!counties) {
                counties = [...new Set(wells.map(w => w.county).filter(Boolean))].sort();
            }
            if (!noDataWells && lastShutInData) {
                noDataWells = lastShutInData.wells.filter(w => w.status === 'no_data');
            }
            const noDataHtml = noDataWells ? renderNoDataSection(noDataWells) : '';
            return `
                <div class="shutin-toolbar">
                    <div class="shutin-filters">
                        <select id="shutinStatusFilter" onchange="filterShutInWells()" class="shutin-select">
                            <option value="">All Status</option>
                            <option value="recently_idle">Idle (3-6mo)</option>
                            <option value="extended_idle">Extended Idle (6-12mo)</option>
                            <option value="no_recent_production">Long-Term Idle (12+mo)</option>
                        </select>
                        <select id="shutinRiskFilter" onchange="filterShutInWells()" class="shutin-select">
                            <option value="">All Risk Flags</option>
                            <option value="HBP Risk">HBP Risk</option>
                            <option value="Sudden Stop">Sudden Stop</option>
                            <option value="Operator Pattern">Operator Pattern</option>
                        </select>
                        <select id="shutinCountyFilter" onchange="filterShutInWells()" class="shutin-select">
                            <option value="">All Counties</option>
                            ${counties.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}
                        </select>
                    </div>
                    <button class="pooling-btn-export" onclick="exportShutInCsv()">&#10515; Export CSV</button>
                </div>
                <div id="shutinTableContainer" style="margin-top: 0.75rem;"></div>
                ${noDataHtml}
                <div class="about-data-card" style="margin-top: 1.5rem;">
                    <h4 style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--oil-navy);">About This Report</h4>
                    <ul style="font-size: 0.8rem; color: var(--slate-blue); line-height: 1.6; padding-left: 1.25rem;">
                        <li><strong>Idle (3-6mo)</strong> — Well has not reported production in 3-6 months. May be undergoing workover or temporary shut-in.</li>
                        <li><strong>Extended Idle (6-12mo)</strong> — No production for 6-12 months. Monitor for potential plugging or lease issues.</li>
                        <li><strong>Long-Term Idle (12+mo)</strong> — Idle for over a year. Consider lease review and HBP implications.</li>
                        <li><strong>HBP Risk</strong> — Well first produced within 5 years. Extended idle may jeopardize Held By Production status.</li>
                        <li><strong>Sudden Stop</strong> — Well averaged &gt;50 BOE/month before going idle. Unexpected shutdown worth investigating.</li>
                        <li><strong>Operator Pattern</strong> — More than half of this operator's wells in your portfolio are idle.</li>
                    </ul>
                </div>
            `;
        }

        async function fetchShutInMarkets() {
            try {
                const res = await fetch('/api/intelligence/shut-in-detector/markets', { credentials: 'include' });
                if (!res.ok) throw new Error('Failed to fetch markets data');
                const data = await res.json();
                lastShutInMarketsData = data;

                // Update badge with county count
                const badge = document.getElementById('shutInMarketsCountBadge');
                if (badge && data.counties) {
                    badge.textContent = data.counties.length;
                }

                const content = document.getElementById('shutInTabContent');
                if (content && shutInCurrentTab === 'markets') {
                    content.innerHTML = renderShutInMarketsTab(data);
                }
            } catch (err) {
                console.error('Failed to load shut-in markets:', err);
                const content = document.getElementById('shutInTabContent');
                if (content && shutInCurrentTab === 'markets') {
                    content.innerHTML = `
                        <div style="padding: 3rem; text-align: center; color: var(--text-danger);">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">&#9888;</div>
                            <div>Failed to load county benchmarks. Please try again.</div>
                        </div>
                    `;
                }
            }
        }

        function sortShutInMarkets(sortType) {
            shutInMarketSort = sortType;
            if (lastShutInMarketsData) {
                const content = document.getElementById('shutInTabContent');
                if (content) content.innerHTML = renderShutInMarketsTab(lastShutInMarketsData);
            }
        }

        function renderShutInMarketsTab(data) {
            const counties = data.counties || [];
            if (counties.length === 0) {
                return '<div class="pooling-empty" style="padding: 3rem; text-align: center; color: var(--text-muted);">No county data available</div>';
            }

            // Sort counties based on current mode
            if (shutInMarketSort === 'name') {
                counties.sort((a, b) => a.county.localeCompare(b.county));
            } else if (shutInMarketSort === 'wells') {
                counties.sort((a, b) => b.userWellCount - a.userWellCount);
            } else {
                // Performance: best delta first (lowest idle rate delta = healthiest)
                counties.sort((a, b) => {
                    const da = a.userVsCountyDelta;
                    const db = b.userVsCountyDelta;
                    if (da == null && db == null) return 0;
                    if (da == null) return 1;
                    if (db == null) return -1;
                    return da - db; // Lower = healthier
                });
            }

            // Compute summary stats
            let healthier = 0, tracking = 0, concern = 0;
            for (const ca of counties) {
                if (ca.userVsCountyDelta == null) continue;
                if (ca.userVsCountyDelta < -5) healthier++;
                else if (ca.userVsCountyDelta > 5) concern++;
                else tracking++;
            }

            const summaryParts = [];
            if (healthier > 0) summaryParts.push(`<span class="decline-summary-pill pill-positive">${healthier} healthier</span>`);
            if (tracking > 0) summaryParts.push(`<span class="decline-summary-pill pill-neutral">${tracking} tracking</span>`);
            if (concern > 0) summaryParts.push(`<span class="decline-summary-pill pill-negative">${concern} concern</span>`);

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <p class="pooling-tab-intro" style="margin-bottom: 0;">
                        Compare your wells' idle rates against county-wide statistics. See which operators are shutting in the most wells.
                    </p>
                    <button class="pooling-btn-export" onclick="exportShutInMarketsCsv()" style="flex-shrink: 0; margin-left: 1rem;">⤓ Export CSV</button>
                </div>

                <div class="decline-summary-bar">${summaryParts.join(' <span class="decline-summary-sep">&middot;</span> ')}</div>

                <div class="decline-sort-controls">
                    <span style="font-size: 0.8rem; color: var(--text-muted);">Sort by:</span>
                    <button class="decline-sort-btn ${shutInMarketSort === 'performance' ? 'active' : ''}" onclick="sortShutInMarkets('performance')">Performance</button>
                    <button class="decline-sort-btn ${shutInMarketSort === 'wells' ? 'active' : ''}" onclick="sortShutInMarkets('wells')">Well Count</button>
                    <button class="decline-sort-btn ${shutInMarketSort === 'name' ? 'active' : ''}" onclick="sortShutInMarkets('name')">Name</button>
                </div>

                <div class="pooling-markets-grid">
            `;

            for (const ca of counties) {
                // Delta indicator — inverted from production decline:
                // positive delta = user has MORE idle wells = BAD
                let deltaClass = 'neutral';
                let deltaIcon = '&mdash;';
                let deltaText = 'No comparison';

                if (ca.userVsCountyDelta != null) {
                    if (ca.userVsCountyDelta < -5) {
                        deltaClass = 'positive';
                        deltaIcon = '&#9660;'; // ▼
                        deltaText = `Healthier: ${Math.abs(ca.userVsCountyDelta).toFixed(1)}% lower idle rate`;
                    } else if (ca.userVsCountyDelta > 5) {
                        deltaClass = 'negative';
                        deltaIcon = '&#9650;'; // ▲
                        deltaText = `Concern: ${ca.userVsCountyDelta.toFixed(1)}% higher idle rate`;
                    } else {
                        deltaClass = 'neutral';
                        deltaIcon = '&asymp;'; // ≈
                        deltaText = 'Tracking county idle rate';
                    }
                }

                // Operator breakdown tags (top 5)
                const operatorTags = (ca.topOperators || []).slice(0, 5).map(op => {
                    const opClass = op.idleRate > 60 ? 'formation-negative' : (op.idleRate > 40 ? 'formation-amber' : 'formation-positive');
                    return `<span class="formation-tag ${opClass}">${escapeHtml(op.operator)} <small>${op.idleWells}/${op.totalWells} idle (${op.idleRate.toFixed(0)}%)</small></span>`;
                }).join('');

                html += `
                    <div class="pooling-market-card decline-market-card">
                        <div class="market-card-header">
                            <span class="market-county">${escapeHtml(ca.county)}</span>
                            <span class="market-order-count">${ca.userWellCount} well${ca.userWellCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="market-card-body">
                            <div class="decline-delta-row delta-${deltaClass}">
                                <span class="delta-icon">${deltaIcon}</span>
                                <span class="delta-text">${deltaText}</span>
                            </div>

                            <div class="market-stat-row">
                                <span class="market-stat-name">Your Idle Rate</span>
                                <span class="market-stat-val">${ca.userIdleRate.toFixed(1)}% (${ca.userIdleWells}/${ca.userWellCount})</span>
                            </div>
                            <div class="market-stat-row">
                                <span class="market-stat-name">County Idle Rate</span>
                                <span class="market-stat-val">${ca.idleRate.toFixed(1)}% (${ca.idleWells}/${ca.totalWells})</span>
                            </div>

                            ${operatorTags ? `
                            <div class="market-formations">
                                <div class="market-formations-label">Top Operators by Idle Wells</div>
                                <div class="market-formation-list">${operatorTags}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            html += `</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); font-style: italic; margin-top: 1rem; text-align: right;">
                    Idle = no production in 3+ months. Includes wells with no reported production in available OTC data. Updated daily at 8am CT.
                </div>
            `;
            return html;
        }

        // =============================================
        // SHUT-IN DETECTOR — MARKET RESEARCH TAB
        // =============================================

        async function fetchShutInResearch() {
            try {
                const response = await fetch('/api/intelligence/shut-in-detector/research', { credentials: 'include' });
                const data = await response.json();

                if (data.error) {
                    console.error('Shut-in research error:', data.error);
                    const content = document.getElementById('shutInTabContent');
                    if (content) {
                        content.innerHTML = `
                            <div class="report-error">
                                <p>Could not load market research data. Please try again.</p>
                                <button class="btn btn-primary" onclick="fetchShutInResearch()">Retry</button>
                            </div>
                        `;
                    }
                    return;
                }

                lastShutInResearchData = data;
                const content = document.getElementById('shutInTabContent');
                if (content && shutInCurrentTab === 'research') {
                    content.innerHTML = renderShutInResearchTab(data);
                }
            } catch (error) {
                console.error('Failed to fetch shut-in research:', error);
                const content = document.getElementById('shutInTabContent');
                if (content) {
                    content.innerHTML = `
                        <div class="report-error">
                            <p>Could not load market research data. Please try again.</p>
                            <button class="btn btn-primary" onclick="fetchShutInResearch()">Retry</button>
                        </div>
                    `;
                }
            }
        }

        function formatHorizonMonth(ym) {
            if (!ym || ym.length < 6) return 'Unknown';
            const year = ym.substring(0, 4);
            const month = parseInt(ym.substring(4, 6));
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return months[month - 1] + ' ' + year;
        }

        function getIdleRateColor(rate) {
            if (rate < 20) return '#10b981';
            if (rate < 50) return '#f59e0b';
            if (rate < 75) return '#f97316';
            return '#ef4444';
        }

        function sortShutInResearchCounties(sortType) {
            shutInResearchCountySort = sortType;
            if (lastShutInResearchData) {
                const container = document.getElementById('shutInResearchCounties');
                if (container) {
                    container.innerHTML = renderShutInResearchCountyCards(lastShutInResearchData.counties);
                }
                document.querySelectorAll('.shutin-research-sort .sort-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.sort === sortType);
                    b.style.background = b.dataset.sort === sortType ? 'var(--oil-navy)' : 'white';
                    b.style.color = b.dataset.sort === sortType ? 'white' : 'var(--slate-blue)';
                });
            }
        }

        function switchShutInResearchView(view) {
            shutInResearchView = view;
            document.querySelectorAll('.shutin-research-view').forEach(el => el.style.display = 'none');
            const active = document.getElementById('shutinResearch_' + view);
            if (active) active.style.display = '';
            document.querySelectorAll('.shutin-research-toggle .toggle-btn').forEach(b => {
                const isActive = b.dataset.view === view;
                b.classList.toggle('active', isActive);
                b.style.background = isActive ? 'var(--oil-navy)' : 'transparent';
                b.style.color = isActive ? 'white' : 'var(--slate-blue)';
            });
        }

        function renderShutInResearchTab(data) {
            const { summary, operatorsByCount, operatorsByRate, counties } = data;
            const horizonLabel = formatHorizonMonth(summary.dataHorizon);
            let html = '';

            html += `<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                <p class="pooling-tab-intro" style="margin-bottom: 0;">
                    Statewide shut-in and idle well intelligence from OTC production data.
                </p>
                <button class="pooling-btn-export" onclick="exportShutInResearchCsv()" style="flex-shrink: 0; margin-left: 1rem;">⤓ Export CSV</button>
            </div>`;

            // HUD Summary Cards
            html += `<div class="pooling-insight-cards">`;

            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Statewide Idle Rate</div>
                    <div style="font-size: 2rem; font-weight: 700; color: ${getIdleRateColor(summary.idleRatePct)}; margin: 0.5rem 0;">
                        ${summary.idleRatePct}%
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                        ${summary.idlePuns.toLocaleString()} of ${summary.totalPuns.toLocaleString()} PUNs idle (3+ months)
                    </div>
                </div>
            `;

            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Recently Gone Idle</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #f59e0b; margin: 0.5rem 0;">
                        ${summary.newlyIdle6mo.toLocaleString()}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                        Went idle within 6 months of ${horizonLabel}
                    </div>
                </div>
            `;

            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Long-Term Idle</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #6b7280; margin: 0.5rem 0;">
                        ${summary.longTermIdle.toLocaleString()}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                        No production for 12+ months
                    </div>
                </div>
            `;

            html += `</div>`;

            html += `
                <div style="font-size: 0.75rem; color: var(--text-muted); margin: 1rem 0 1.5rem; font-style: italic;">
                    Data as of ${horizonLabel}. Of ${(summary.totalPuns + summary.unassignedWells).toLocaleString()} total wells tracked,
                    ${summary.unassignedWells.toLocaleString()} have no assigned operator in OCC records and are excluded from operator rankings.
                </div>
            `;

            // Segmented control
            html += `
                <div class="shutin-research-toggle" style="display: inline-flex; background: #f1f5f9; border-radius: 8px; padding: 3px; margin-bottom: 1.5rem;">
                    <button class="toggle-btn ${shutInResearchView === 'byCount' ? 'active' : ''}" data-view="byCount" onclick="switchShutInResearchView('byCount')" style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; background: ${shutInResearchView === 'byCount' ? 'var(--oil-navy)' : 'transparent'}; color: ${shutInResearchView === 'byCount' ? 'white' : 'var(--slate-blue)'};">Most Idle Wells</button>
                    <button class="toggle-btn ${shutInResearchView === 'byRate' ? 'active' : ''}" data-view="byRate" onclick="switchShutInResearchView('byRate')" style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; background: ${shutInResearchView === 'byRate' ? 'var(--oil-navy)' : 'transparent'}; color: ${shutInResearchView === 'byRate' ? 'white' : 'var(--slate-blue)'};">Highest Idle Rate</button>
                    <button class="toggle-btn ${shutInResearchView === 'counties' ? 'active' : ''}" data-view="counties" onclick="switchShutInResearchView('counties')" style="padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; background: ${shutInResearchView === 'counties' ? 'var(--oil-navy)' : 'transparent'}; color: ${shutInResearchView === 'counties' ? 'white' : 'var(--slate-blue)'};">County Idle Rates</button>
                </div>
            `;

            // View: Operators by Count
            html += `<div id="shutinResearch_byCount" class="shutin-research-view" style="${shutInResearchView !== 'byCount' ? 'display:none;' : ''}">
                <div style="margin-bottom: 1rem;">
                    <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--oil-navy); margin-bottom: 0.25rem;">Top Operators by Idle Well Count</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">Operators with the most non-producing wells (minimum 50 wells)</p>
                </div>
                ${renderShutInOperatorTable(operatorsByCount)}
            </div>`;

            // View: Operators by Rate
            html += `<div id="shutinResearch_byRate" class="shutin-research-view" style="${shutInResearchView !== 'byRate' ? 'display:none;' : ''}">
                <div style="margin-bottom: 1rem;">
                    <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--oil-navy); margin-bottom: 0.25rem;">Highest Idle Rate by Operator</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">Operators with highest percentage of idle wells (minimum 50 wells)</p>
                </div>
                ${renderShutInOperatorTable(operatorsByRate)}
            </div>`;

            // View: County Idle Rates
            html += `<div id="shutinResearch_counties" class="shutin-research-view" style="${shutInResearchView !== 'counties' ? 'display:none;' : ''}">
                <div style="margin-bottom: 1rem;">
                    <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--oil-navy); margin-bottom: 0.25rem;">County Idle Rates</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">Idle well rates across Oklahoma counties (minimum 10 wells)</p>
                </div>
                <div class="shutin-research-sort" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="sort-btn ${shutInResearchCountySort === 'rate' ? 'active' : ''}" data-sort="rate" onclick="sortShutInResearchCounties('rate')" style="padding: 0.375rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: ${shutInResearchCountySort === 'rate' ? 'var(--oil-navy)' : 'white'}; color: ${shutInResearchCountySort === 'rate' ? 'white' : 'var(--slate-blue)'};">Idle Rate</button>
                    <button class="sort-btn ${shutInResearchCountySort === 'count' ? 'active' : ''}" data-sort="count" onclick="sortShutInResearchCounties('count')" style="padding: 0.375rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: ${shutInResearchCountySort === 'count' ? 'var(--oil-navy)' : 'white'}; color: ${shutInResearchCountySort === 'count' ? 'white' : 'var(--slate-blue)'};">Well Count</button>
                    <button class="sort-btn ${shutInResearchCountySort === 'name' ? 'active' : ''}" data-sort="name" onclick="sortShutInResearchCounties('name')" style="padding: 0.375rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: ${shutInResearchCountySort === 'name' ? 'var(--oil-navy)' : 'white'}; color: ${shutInResearchCountySort === 'name' ? 'white' : 'var(--slate-blue)'};">Name</button>
                </div>
                <div id="shutInResearchCounties">${renderShutInResearchCountyCards(counties)}</div>
            </div>`;

            return html;
        }

        function getIdleTrend(recentlyIdle, totalIdle) {
            if (!totalIdle || totalIdle === 0) return { label: '—', color: '#6b7280', arrow: '' };
            const ratio = recentlyIdle / totalIdle;
            if (ratio >= 0.30) return { label: recentlyIdle + ' new', color: '#dc2626', arrow: '↑' };
            if (ratio >= 0.15) return { label: recentlyIdle + ' new', color: '#d97706', arrow: '↗' };
            return { label: 'Stable', color: '#059669', arrow: '→' };
        }

        function renderShutInOperatorTable(operators) {
            if (!operators || operators.length === 0) {
                return '<div class="pooling-empty">No operator data available</div>';
            }

            let html = `<div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border); text-align: left;">
                            <th style="padding: 0.5rem 0.75rem; font-weight: 600; color: var(--oil-navy);">Operator</th>
                            <th style="padding: 0.5rem 0.75rem; font-weight: 600; color: var(--oil-navy); text-align: right;">Total</th>
                            <th style="padding: 0.5rem 0.75rem; font-weight: 600; color: var(--oil-navy); text-align: right;">Idle</th>
                            <th style="padding: 0.5rem 0.75rem; font-weight: 600; color: var(--oil-navy); text-align: right;">Recently Idle</th>
                            <th style="padding: 0.5rem 0.75rem; font-weight: 600; color: var(--oil-navy); text-align: center;">Trend</th>
                            <th style="padding: 0.5rem 0.75rem; font-weight: 600; color: var(--oil-navy); text-align: right; min-width: 120px;">Idle Rate</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const op of operators) {
                const rateColor = getIdleRateColor(op.idleRatePct);
                const barWidth = Math.min(op.idleRatePct, 100);
                const trend = getIdleTrend(op.recentlyIdle || 0, op.idleWells);
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.5rem 0.75rem; font-weight: 500; color: var(--oil-navy); max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(op.operator)}">${op.operatorNumber ? `<span class="vt-well-link" onclick="openOperatorDetail('${escapeAttr(op.operatorNumber)}')">${escapeHtml(op.operator)}</span>` : escapeHtml(op.operator)}</td>
                        <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--slate-blue);">${op.totalWells.toLocaleString()}</td>
                        <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--slate-blue);">${op.idleWells.toLocaleString()}</td>
                        <td style="padding: 0.5rem 0.75rem; text-align: right; color: var(--slate-blue);">${(op.recentlyIdle || 0).toLocaleString()}</td>
                        <td style="padding: 0.5rem 0.75rem; text-align: center;">
                            <span style="font-weight: 600; color: ${trend.color}; font-size: 0.85rem;" title="${op.recentlyIdle || 0} wells went idle in last 3-6 months (${op.idleWells ? Math.round((op.recentlyIdle || 0) / op.idleWells * 100) : 0}% of total idle)">${trend.arrow} ${trend.label}</span>
                        </td>
                        <td style="padding: 0.5rem 0.75rem; text-align: right;">
                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem;">
                                <div style="width: 60px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                    <div style="width: ${barWidth}%; height: 100%; background: ${rateColor}; border-radius: 3px;"></div>
                                </div>
                                <span style="font-weight: 600; color: ${rateColor}; min-width: 40px; text-align: right;">${op.idleRatePct}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            }

            html += `</tbody></table></div>`;
            return html;
        }

        function renderShutInResearchCountyCards(counties) {
            if (!counties || counties.length === 0) {
                return '<div class="pooling-empty">No county data available</div>';
            }

            let sorted = [...counties];
            if (shutInResearchCountySort === 'rate') {
                sorted.sort((a, b) => b.idleRatePct - a.idleRatePct);
            } else if (shutInResearchCountySort === 'count') {
                sorted.sort((a, b) => b.totalWells - a.totalWells);
            } else if (shutInResearchCountySort === 'name') {
                sorted.sort((a, b) => (a.county || '').localeCompare(b.county || ''));
            }

            let html = '<div class="pooling-insight-cards" style="grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));">';

            for (const c of sorted) {
                const rateColor = getIdleRateColor(c.idleRatePct);
                const countyName = (c.county || '').replace(/^\d{3}-/, '');
                const activeWells = c.totalWells - c.idleWells;
                const activePct = c.totalWells > 0 ? Math.round((activeWells / c.totalWells) * 100) : 100;
                const idlePct = 100 - activePct;
                html += `
                    <div class="pooling-insight-card" style="padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div class="insight-card-title" style="margin-bottom: 0;">${escapeHtml(countyName)}</div>
                            <span style="font-size: 1.1rem; font-weight: 700; color: ${rateColor};">${c.idleRatePct}%</span>
                        </div>
                        <div style="display: flex; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 0.5rem;" title="${activeWells.toLocaleString()} active, ${c.idleWells.toLocaleString()} idle">
                            <div style="width: ${activePct}%; background: #059669; transition: width 0.3s;"></div>
                            <div style="width: ${idlePct}%; background: ${rateColor}; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--slate-blue); margin-bottom: 0.5rem;">
                            ${c.idleWells.toLocaleString()} idle of ${c.totalWells.toLocaleString()} wells
                        </div>
                        ${c.topIdleOperator ? `
                            <div style="font-size: 0.7rem; color: var(--text-muted); border-top: 1px solid var(--border); padding-top: 0.375rem; margin-top: 0.25rem;">
                                Top idle: ${c.topIdleOperatorNumber ? `<span class="vt-well-link" onclick="openOperatorDetail('${escapeAttr(c.topIdleOperatorNumber)}')">${escapeHtml(c.topIdleOperator)}</span>` : escapeHtml(c.topIdleOperator)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // =============================================
        // OCC FILING ACTIVITY REPORT
        // =============================================

        let lastOccFilingData = null;
        let occFilingCurrentTab = 'properties';
        let occFilingExpandedProperties = new Set();
        let occFilingSearchTerm = '';
        let occFilingCountyFilter = '';
        let occFilingDistanceFilter = '';
        let occFilingSortKey = 'filingCount';

        async function loadOccFilingReport(forceRefresh = false) {
            history.pushState({ intelView: 'report' }, '');
            intelViewOpen = 'report';
            const main = document.querySelector('main');
            const hero = document.querySelector('.intel-hero');
            const viewer = document.getElementById('reportViewer');
            if (main) main.style.display = 'none';
            if (hero) hero.style.display = 'none';
            viewer.style.display = 'block';
            window.scrollTo(0, 0);

            currentReportType = 'occ-filing-activity';
            document.getElementById('reportBreadcrumb').textContent = 'OCC Filing Activity';
            document.getElementById('reportTitle').textContent = 'OCC Filing Activity';
            document.getElementById('reportContent').innerHTML = '<div class="report-loading">Searching for OCC filings near your properties...</div>';
            document.getElementById('reportSubtitle').textContent = 'Loading...';
            document.getElementById('reportStatus').textContent = '';
            document.getElementById('reportStatus').className = 'report-status';
            document.getElementById('reportMeta').textContent = '';

            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 20000);

                const url = forceRefresh ? '/api/intelligence/occ-filing-activity?refresh=1' : '/api/intelligence/occ-filing-activity';
                const response = await fetch(url, {
                    credentials: 'include',
                    signal: controller.signal
                });

                if (!response.ok) {
                    throw new Error('API returned ' + response.status);
                }

                const data = await response.json();
                renderOccFilingReport(data);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('OCC filing report request timed out');
                } else {
                    console.error('Failed to load OCC filing report:', error);
                }
                document.getElementById('reportContent').innerHTML = `
                    <div class="report-error">
                        <p>Could not load OCC filing data. Please try again.</p>
                        <button class="btn btn-primary" onclick="loadOccFilingReport()">Retry</button>
                        <button class="btn btn-ghost" onclick="closeReport()" style="margin-left: 0.5rem;">Back</button>
                    </div>
                `;
            }
        }

        function formatReliefType(type) {
            if (!type) return 'OCC Filing';
            const map = {
                'POOLING': 'Pooling',
                'SPACING': 'Spacing',
                'INCREASED DENSITY': 'Increased Density',
                'LOCATION EXCEPTION': 'Location Exception',
                'CHANGE OF OPERATOR': 'Change of Operator',
                'MULTI-UNIT HORIZONTAL': 'Multi-Unit Horizontal',
                'HORIZONTAL WELL': 'Horizontal Well',
                'WELL TRANSFER': 'Well Transfer',
                'DISSOLUTION': 'Unit Dissolution',
                'VACUUM': 'Vacuum Order',
                'DISPOSAL WELL': 'Disposal Well',
                'INCREASED WELL DENSITY': 'Increased Well Density'
            };
            const upper = type.toUpperCase();
            if (map[upper]) return map[upper];
            for (const [key, label] of Object.entries(map)) {
                if (upper.includes(key)) return label;
            }
            return type.replace(/\b\w/g, c => c.toUpperCase()) || 'OCC Filing';
        }

        function reliefBadgeClass(type) {
            if (!type) return 'type-permit';
            const upper = type.toUpperCase();
            if (upper.includes('POOLING')) return 'type-pooling';
            if (upper.includes('SPACING') || upper.includes('DENSITY') || upper.includes('HORIZONTAL') || upper.includes('MULTI-UNIT')) return 'type-spacing';
            if (upper.includes('COMPLETION')) return 'type-completion';
            return 'type-permit';
        }

        function distanceBadgeStyle(tier) {
            if (tier === 0) return 'background: var(--red-dirt, #c0392b); color: #fff;';
            if (tier === 1) return 'background: #f59e0b; color: #fff;';
            return 'background: #94a3b8; color: #fff;';
        }

        function formatOccDate(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr + 'T00:00:00');
                return MONTH_ABBR[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
            } catch (e) { return dateStr; }
        }

        function formatOccDateShort(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr + 'T00:00:00');
                return MONTH_ABBR[d.getMonth()] + ' ' + d.getDate();
            } catch (e) { return dateStr; }
        }

        function renderOccFilingReport(data) {
            const { summary, byProperty, byCounty, marketResearch } = data;
            lastOccFilingData = data;
            occFilingExpandedProperties = new Set();
            occFilingCurrentTab = 'properties';
            occFilingSearchTerm = '';
            occFilingCountyFilter = '';
            occFilingDistanceFilter = '';

            // Header
            document.getElementById('reportSubtitle').textContent = summary.totalFilings > 0
                ? 'OCC filings on and near your mineral interest sections'
                : 'No recent OCC filings found nearby';

            document.getElementById('reportStatus').textContent = '';
            const dateRange = summary.dateRange;
            const metaText = dateRange && dateRange.earliest && dateRange.latest
                ? `${formatOccDate(dateRange.earliest)} \u2013 ${formatOccDate(dateRange.latest)} \u00b7 Updated daily`
                : 'Data from OCC docket entries';
            document.getElementById('reportMeta').innerHTML = `${metaText} <button class="btn-refresh-small" onclick="loadOccFilingReport(true)" title="Refresh data">\u21bb</button>` +
                '<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Sourced from Oklahoma Corporation Commission, updated daily</div>';

            if (summary.totalFilings === 0) {
                document.getElementById('reportContent').innerHTML = `
                    <div class="hud-metrics">
                        <div class="hud-badge">
                            <div class="hud-badge-value">0</div>
                            <div class="hud-badge-content">
                                <div class="hud-badge-label">Nearby Filings</div>
                                <div class="hud-badge-status">None found</div>
                            </div>
                        </div>
                    </div>
                    <div class="report-summary-card">
                        <h2 class="report-summary-title">No Recent OCC Filing Activity</h2>
                        <p class="report-summary-text">
                            We searched for OCC filings within 2 townships of your properties
                            and found no activity in the last 12 months.
                        </p>
                    </div>
                    <div class="report-footer">
                        <p>Data sourced from Oklahoma Corporation Commission docket.</p>
                    </div>
                `;
                return;
            }

            let html = '';

            // HUD Metrics (4 badges)
            const uniqueApplicants = new Set();
            for (const p of byProperty) {
                for (const f of p.filings) {
                    if (f.applicant) uniqueApplicants.add(f.applicant);
                }
            }
            const topApplicant = summary.topApplicants && summary.topApplicants[0] ? summary.topApplicants[0].name : '';
            const topApplicantShort = topApplicant.length > 20 ? topApplicant.substring(0, 20) + '...' : topApplicant;

            html += `
                <div class="hud-metrics pooling-hud">
                    <div class="hud-badge">
                        <div class="hud-badge-value">${summary.totalFilings}</div>
                        <div class="hud-badge-content">
                            <div class="hud-badge-label">Total Filings</div>
                            <div class="hud-badge-status">Within 2 townships of your properties</div>
                        </div>
                    </div>
                    <div class="hud-badge">
                        <div class="hud-badge-value" style="color: var(--red-dirt, #c0392b);">${summary.sameSectionFilings}</div>
                        <div class="hud-badge-content">
                            <div class="hud-badge-label">On Your Sections</div>
                            <div class="hud-badge-status">${summary.sameSectionFilings > 0 ? 'Direct section matches' : 'None on exact sections'}</div>
                        </div>
                    </div>
                    <div class="hud-badge">
                        <div class="hud-badge-value pooling-emerald">${uniqueApplicants.size}</div>
                        <div class="hud-badge-content">
                            <div class="hud-badge-label">Active Operators</div>
                            <div class="hud-badge-status">${topApplicantShort ? escapeHtml(topApplicantShort) + ' is most active' : 'In your area'}</div>
                        </div>
                    </div>
                    <div class="hud-badge">
                        <div class="hud-badge-value pooling-blue">${summary.propertiesWithActivity}</div>
                        <div class="hud-badge-content">
                            <div class="hud-badge-label">Properties with Activity</div>
                            <div class="hud-badge-status">${byProperty.length > 0 ? escapeHtml(byProperty[0].county || '') + ' leads' : ''}</div>
                        </div>
                    </div>
                </div>
            `;

            // Tabs
            html += `
                <div class="pooling-tabs">
                    <button class="pooling-tab active" data-tab="properties" onclick="switchOccFilingTab('properties')">
                        My Properties <span class="tab-badge">${byProperty.length}</span>
                    </button>
                    <button class="pooling-tab" data-tab="markets" onclick="switchOccFilingTab('markets')">
                        My Markets <span class="tab-badge">${byCounty.length}</span>
                    </button>
                    <button class="pooling-tab" data-tab="research" onclick="switchOccFilingTab('research')">
                        Market Research
                    </button>
                </div>
            `;

            html += `<div id="occFiling-tab-contents">`;

            // TAB 1: MY PROPERTIES
            html += `<div id="occFiling-tab-properties" class="pooling-tab-content active">`;
            html += renderOccFilingPropertiesTab(summary, byProperty, byCounty);
            html += `</div>`;

            // TAB 2: MY MARKETS
            html += `<div id="occFiling-tab-markets" class="pooling-tab-content" style="display:none;">`;
            html += renderOccFilingMarketsTab(byCounty);
            html += `</div>`;

            // TAB 3: MARKET RESEARCH
            html += `<div id="occFiling-tab-research" class="pooling-tab-content" style="display:none;">`;
            html += renderOccFilingResearchTab(marketResearch);
            html += `</div>`;

            html += `</div>`;

            html += `
                <div class="report-footer">
                    Data sourced from Oklahoma Corporation Commission docket entries.<br>
                    Showing filings from the past 12 months. \u00b7 Updated daily.
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
        }

        function renderOccFilingPropertiesTab(summary, byProperty, byCounty) {
            let html = '';

            // Filing type summary strip
            const filingTypes = summary.filingTypes || {};
            const typeKeys = Object.keys(filingTypes).sort((a, b) => filingTypes[b] - filingTypes[a]);
            if (typeKeys.length > 0) {
                html += `
                    <div class="pooling-royalty-summary">
                        <div class="pooling-summary-label">Filing Types in Your Area</div>
                        <div class="pooling-royalty-chips">
                            ${typeKeys.slice(0, 6).map((k, i) => `
                                <span class="pooling-royalty-chip ${i === 0 ? 'primary' : 'secondary'}">
                                    ${escapeHtml(formatReliefType(k))} <span class="chip-count">${filingTypes[k]}</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Active operators bar
            if (summary.topApplicants && summary.topApplicants.length > 0) {
                html += `
                    <div class="pooling-operators-bar">
                        <span class="pooling-summary-label">Most Active Filers</span>
                        ${summary.topApplicants.slice(0, 5).map(op => `
                            <span class="pooling-operator-chip">
                                ${escapeHtml(op.name)} <span class="chip-count">${op.count}</span>
                            </span>
                        `).join('')}
                    </div>
                `;
            }

            // Toolbar
            const counties = [...new Set(byProperty.map(p => p.county).filter(Boolean))].sort();
            html += `
                <div class="pooling-toolbar">
                    <div class="pooling-search-box">
                        <span class="search-icon">\u2315</span>
                        <input type="text" id="occFilingSearch" placeholder="Search applicants, case #..." oninput="filterOccFilingProperties()">
                    </div>
                    <div class="pooling-filter-group">
                        <label class="filter-label">Sort</label>
                        <select id="occFilingSort" class="pooling-filter-select" onchange="filterOccFilingProperties()">
                            <option value="filingCount-desc">Most Filings</option>
                            <option value="sameSectionCount-desc">Most On-Section</option>
                            <option value="propertyName-asc">By Name</option>
                            <option value="county-asc">By County</option>
                        </select>
                    </div>
                    <div class="pooling-filter-group">
                        <label class="filter-label">County</label>
                        <select id="occFilingCounty" class="pooling-filter-select" onchange="filterOccFilingProperties()">
                            <option value="">All Counties</option>
                            ${counties.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="pooling-filter-group">
                        <label class="filter-label">Distance</label>
                        <select id="occFilingDistance" class="pooling-filter-select" onchange="filterOccFilingProperties()">
                            <option value="">All Distances</option>
                            <option value="same">Same Section Only</option>
                            <option value="adjacent">Adjacent</option>
                        </select>
                    </div>
                    <button class="pooling-btn-export" onclick="exportOccFilingCsv()">\u2913 Export CSV</button>
                </div>
            `;

            html += `<div id="occFiling-properties-list">`;
            html += renderOccFilingPropertyList(byProperty);
            html += `</div>`;

            return html;
        }

        function renderOccFilingPropertyList(properties) {
            if (!properties || properties.length === 0) {
                return '<div class="pooling-empty">No properties match your filters</div>';
            }

            let html = '';

            for (const prop of properties) {
                const propId = (prop.propertyId || prop.propertyName).replace(/[^a-zA-Z0-9]/g, '-');
                const sameSection = prop.sameSectionCount || 0;
                const isExpanded = occFilingExpandedProperties.has(propId);

                html += `
                    <div class="pooling-property-group" id="occ-prop-group-${propId}">
                        <div class="pooling-property-header" onclick="toggleOccFilingProperty('${propId}')">
                            <div class="pooling-header-left">
                                <span class="expand-chevron" id="occ-chevron-${propId}">${isExpanded ? '\u25BC' : '\u25B6'}</span>
                                <span class="pooling-prop-name">${escapeHtml(prop.propertyName)}</span>
                                <span class="pooling-prop-location">${escapeHtml(prop.county || '')}</span>
                            </div>
                            <div class="pooling-header-right">
                                <div class="pooling-prop-stat">
                                    <div class="pooling-stat-value">${prop.filingCount}</div>
                                    <div class="pooling-stat-label">Filings</div>
                                </div>
                                <div class="pooling-prop-stat">
                                    <div class="pooling-stat-value" style="${sameSection > 0 ? 'color: var(--red-dirt, #c0392b);' : ''}">${sameSection}</div>
                                    <div class="pooling-stat-label">On Section</div>
                                </div>
                            </div>
                        </div>
                        <div class="pooling-property-content" id="occ-content-${propId}" style="display:${isExpanded ? 'block' : 'none'};">
                            ${renderOccFilingTable(prop.filings, propId)}
                        </div>
                    </div>
                `;
            }

            return html;
        }

        function renderOccFilingTable(filings, propId) {
            if (!filings || filings.length === 0) {
                return '<p class="pooling-empty">No filings</p>';
            }

            let html = `
                <div style="overflow-x: auto;">
                <table class="pooling-orders-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Applicant</th>
                            <th>Case #</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Distance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const f of filings) {
                const reliefLabel = formatReliefType(f.reliefType);
                const badgeClass = reliefBadgeClass(f.reliefType);
                const distStyle = distanceBadgeStyle(f.distanceTier);
                const caseLink = f.sourceUrl
                    ? `<a href="${escapeHtml(f.sourceUrl)}" target="_blank" rel="noopener" class="vt-well-link">${escapeHtml(f.caseNumber || '\u2014')}</a>`
                    : escapeHtml(f.caseNumber || '\u2014');
                const location = f.section && f.township && f.range
                    ? `${f.section}-${f.township}-${f.range}`
                    : '\u2014';

                html += `
                    <tr>
                        <td style="white-space: nowrap;">${formatOccDateShort(f.docketDate)}</td>
                        <td><span class="filing-type-badge ${badgeClass}">${escapeHtml(reliefLabel)}</span></td>
                        <td>${escapeHtml(f.applicant || '\u2014')}</td>
                        <td>${caseLink}</td>
                        <td style="white-space: nowrap;">${escapeHtml(location)}</td>
                        <td>${escapeHtml(f.status || '\u2014')}</td>
                        <td><span class="distance-badge" style="${distStyle} padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; white-space: nowrap;">${escapeHtml(f.distanceDescription)}</span></td>
                    </tr>
                `;
            }

            html += '</tbody></table></div>';
            return html;
        }

        function toggleOccFilingProperty(propId) {
            const content = document.getElementById('occ-content-' + propId);
            const chevron = document.getElementById('occ-chevron-' + propId);
            if (!content) return;

            const isExpanded = content.style.display !== 'none';
            content.style.display = isExpanded ? 'none' : 'block';
            if (chevron) chevron.textContent = isExpanded ? '\u25B6' : '\u25BC';

            if (isExpanded) {
                occFilingExpandedProperties.delete(propId);
            } else {
                occFilingExpandedProperties.add(propId);
            }
        }

        function switchOccFilingTab(tab) {
            occFilingCurrentTab = tab;
            // Update the tab buttons
            const tabButtons = document.querySelectorAll('.pooling-tabs .pooling-tab');
            tabButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            document.querySelectorAll('#occFiling-tab-contents .pooling-tab-content').forEach(content => {
                content.style.display = content.id === 'occFiling-tab-' + tab ? 'block' : 'none';
            });
        }

        function filterOccFilingProperties() {
            if (!lastOccFilingData) return;

            const search = (document.getElementById('occFilingSearch')?.value || '').toLowerCase();
            const county = document.getElementById('occFilingCounty')?.value || '';
            const distance = document.getElementById('occFilingDistance')?.value || '';

            let filtered = [...lastOccFilingData.byProperty];

            if (search) {
                filtered = filtered.filter(p => {
                    const propMatch = p.propertyName.toLowerCase().includes(search) ||
                        (p.county || '').toLowerCase().includes(search);
                    const filingMatch = p.filings.some(f =>
                        (f.applicant || '').toLowerCase().includes(search) ||
                        (f.caseNumber || '').toLowerCase().includes(search) ||
                        (f.reliefType || '').toLowerCase().includes(search)
                    );
                    return propMatch || filingMatch;
                });
            }

            if (county) {
                filtered = filtered.filter(p => p.county === county);
            }

            if (distance === 'same') {
                filtered = filtered.filter(p => (p.sameSectionCount || 0) > 0);
            } else if (distance === 'adjacent') {
                filtered = filtered.filter(p =>
                    p.filings.some(f => f.distanceTier <= 1)
                );
            }

            // Sort
            const sortVal = document.getElementById('occFilingSort')?.value || 'filingCount-desc';
            const [sortKey, sortDir] = sortVal.split('-');
            filtered.sort((a, b) => {
                let aVal = a[sortKey] ?? 0;
                let bVal = b[sortKey] ?? 0;
                if (typeof aVal === 'string') {
                    return sortDir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return sortDir === 'asc' ? aVal - bVal : bVal - aVal;
            });

            document.getElementById('occFiling-properties-list').innerHTML = renderOccFilingPropertyList(filtered);
        }

        function renderOccFilingMarketsTab(byCounty) {
            if (!byCounty || byCounty.length === 0) {
                return '<div class="pooling-empty">No county data available</div>';
            }

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <p class="pooling-tab-intro" style="margin-bottom: 0;">
                        OCC filing activity in counties where you own mineral rights.
                        See which operators are most active and what types of filings dominate.
                    </p>
                </div>
                <div class="pooling-markets-grid">
            `;

            for (const county of byCounty) {
                const topFilers = (county.topApplicants || []).slice(0, 3);
                const filingTypes = county.filingTypes || {};
                const typeKeys = Object.keys(filingTypes).sort((a, b) => filingTypes[b] - filingTypes[a]).slice(0, 4);

                html += `
                    <div class="pooling-market-card">
                        <div class="market-card-header">
                            <span class="market-county">${escapeHtml(county.county)}</span>
                            <span class="market-order-count">${county.filingCount} filing${county.filingCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="market-card-body">
                            ${topFilers.length > 0 ? `
                                <div style="margin-bottom: 0.75rem;">
                                    <div class="market-stat-name" style="margin-bottom: 0.25rem;">Top Filers</div>
                                    ${topFilers.map(f => `
                                        <div class="insight-top-item" style="padding: 0.25rem 0;">
                                            <span class="insight-item-name" style="font-size: 0.85rem;">${escapeHtml(f.name)}</span>
                                            <span class="insight-item-val" style="font-size: 0.85rem;">${f.count}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${typeKeys.length > 0 ? `
                                <div>
                                    <div class="market-stat-name" style="margin-bottom: 0.25rem;">Filing Types</div>
                                    ${typeKeys.map(k => `
                                        <div class="insight-top-item" style="padding: 0.25rem 0;">
                                            <span class="insight-item-name" style="font-size: 0.85rem;">${escapeHtml(formatReliefType(k))}</span>
                                            <span class="insight-item-val" style="font-size: 0.85rem;">${filingTypes[k]}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${county.latestDate ? `
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; border-top: 1px solid var(--border); padding-top: 0.375rem;">
                                    Latest: ${formatOccDateShort(county.latestDate)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        function renderOccFilingResearchTab(marketResearch) {
            if (!marketResearch) {
                return '<div class="pooling-empty">No statewide data available</div>';
            }

            const hottestCounties = marketResearch.hottestCounties || [];
            const topFilers = marketResearch.topFilers || [];
            const filingTypeBreakdown = marketResearch.filingTypeBreakdown || {};
            const totalStatewide = marketResearch.totalStatewideFilings90d || 0;
            const typeKeys = Object.keys(filingTypeBreakdown).sort((a, b) => filingTypeBreakdown[b] - filingTypeBreakdown[a]);

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <p class="pooling-tab-intro" style="margin-bottom: 0;">
                        Statewide OCC filing activity over the last 90 days.
                        ${totalStatewide > 0 ? `<strong>${totalStatewide.toLocaleString()}</strong> total filings across Oklahoma.` : ''}
                    </p>
                    <button class="pooling-btn-export" onclick="exportOccFilingResearchCsv()" style="flex-shrink: 0; margin-left: 1rem;">\u2913 Export CSV</button>
                </div>
                <div class="pooling-insight-cards">
            `;

            // Hottest Counties
            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Hottest Counties (90 Days)</div>
                    ${hottestCounties.length > 0 ? hottestCounties.map(c => `
                        <div class="insight-top-item">
                            <span class="insight-item-name">${escapeHtml(c.county)}</span>
                            <span class="insight-item-val">${c.count}<span class="insight-item-sub">filings</span></span>
                        </div>
                    `).join('') : '<div class="pooling-empty">No data</div>'}
                </div>
            `;

            // Most Active Filers
            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Most Active Filers</div>
                    ${topFilers.length > 0 ? topFilers.map(f => `
                        <div class="insight-top-item">
                            <span class="insight-item-name">${escapeHtml(f.applicant)}</span>
                            <span class="insight-item-val">${f.count}<span class="insight-item-sub">filings</span></span>
                        </div>
                    `).join('') : '<div class="pooling-empty">No data</div>'}
                </div>
            `;

            // Filing Type Breakdown
            html += `
                <div class="pooling-insight-card">
                    <div class="insight-card-title">Filing Type Breakdown</div>
                    ${typeKeys.length > 0 ? typeKeys.slice(0, 10).map(k => {
                        const pct = totalStatewide > 0 ? Math.round(filingTypeBreakdown[k] / totalStatewide * 100) : 0;
                        return `
                            <div class="insight-top-item">
                                <span class="insight-item-name">${escapeHtml(formatReliefType(k))}</span>
                                <span class="insight-item-val">${filingTypeBreakdown[k]}<span class="insight-item-sub">${pct}%</span></span>
                            </div>
                        `;
                    }).join('') : '<div class="pooling-empty">No data</div>'}
                </div>
            `;

            html += '</div>';
            return html;
        }

        function exportOccFilingCsv() {
            if (!lastOccFilingData || !lastOccFilingData.byProperty) {
                showToast('No data to export', 'error');
                return;
            }

            const rows = [];
            rows.push(['Property', 'Section', 'Township', 'Range', 'County', 'Date', 'Type', 'Applicant', 'Case #', 'Status', 'Filing Location', 'Distance', 'Source URL']);

            for (const prop of lastOccFilingData.byProperty) {
                for (const f of prop.filings) {
                    const location = f.section && f.township && f.range
                        ? `${f.section}-${f.township}-${f.range}` : '';
                    rows.push([
                        prop.propertyName,
                        prop.section,
                        prop.township,
                        prop.range,
                        prop.county || '',
                        f.docketDate || '',
                        formatReliefType(f.reliefType),
                        f.applicant || '',
                        f.caseNumber || '',
                        f.status || '',
                        location,
                        f.distanceDescription || '',
                        f.sourceUrl || ''
                    ]);
                }
            }

            const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'occ-filing-activity-' + new Date().toISOString().slice(0, 10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportOccFilingResearchCsv() {
            if (!lastOccFilingData || !lastOccFilingData.marketResearch) {
                showToast('No data to export', 'error');
                return;
            }

            const mr = lastOccFilingData.marketResearch;
            const rows = [];
            rows.push(['Category', 'Name', 'Count']);

            for (const c of (mr.hottestCounties || [])) {
                rows.push(['Hottest County', c.county, c.count]);
            }
            for (const f of (mr.topFilers || [])) {
                rows.push(['Top Filer', f.applicant, f.count]);
            }
            for (const [type, count] of Object.entries(mr.filingTypeBreakdown || {})) {
                rows.push(['Filing Type', formatReliefType(type), count]);
            }

            const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'occ-filing-research-' + new Date().toISOString().slice(0, 10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // =============================================
        // WELL RISK PROFILE REPORT
        // =============================================

        let lastWellRiskData = null;
        let riskCurrentTab = 'overview';

        async function loadWellRiskProfileReport(forceRefresh = false) {
            history.pushState({ intelView: 'report' }, '');
            intelViewOpen = 'report';
            currentReportType = 'well-risk-profile';
            riskCurrentTab = 'overview';

            const main = document.querySelector('main');
            const hero = document.querySelector('.intel-hero');
            const viewer = document.getElementById('reportViewer');
            if (main) main.style.display = 'none';
            if (hero) hero.style.display = 'none';
            viewer.style.display = 'block';
            window.scrollTo(0, 0);

            document.getElementById('reportBreadcrumb').textContent = 'Well Risk Profile';
            document.getElementById('reportTitle').textContent = 'Well Risk Profile';
            document.getElementById('reportContent').innerHTML = '<div class="report-loading">Analyzing breakeven economics for your wells...</div>';
            document.getElementById('reportSubtitle').textContent = 'Loading...';
            document.getElementById('reportStatus').textContent = '';
            document.getElementById('reportStatus').className = 'report-status';
            document.getElementById('reportMeta').textContent = '';

            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 20000);

                const url = forceRefresh ? '/api/intelligence/well-risk-profile?refresh=1' : '/api/intelligence/well-risk-profile';
                const response = await fetch(url, {
                    credentials: 'include',
                    signal: controller.signal
                });

                if (!response.ok) throw new Error('API returned ' + response.status);

                const data = await response.json();
                lastWellRiskData = data;
                renderWellRiskProfileReport(data);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Well risk profile request timed out');
                } else {
                    console.error('Failed to load well risk profile:', error);
                }
                document.getElementById('reportContent').innerHTML = `
                    <div class="report-error">
                        <p>Could not load risk profile data. Please try again.</p>
                        <button class="btn btn-primary" onclick="loadWellRiskProfileReport(true)">Retry</button>
                        <button class="btn btn-ghost" onclick="closeReport()" style="margin-left: 0.5rem;">Back</button>
                    </div>
                `;
            }
        }

        function riskLevelLabel(level) {
            switch (level) {
                case 'comfortable': return 'Comfortable';
                case 'adequate': return 'Adequate';
                case 'tight': return 'Tight';
                case 'at_risk': return 'At Risk';
                default: return level;
            }
        }

        function riskLevelBadgeStyle(level) {
            switch (level) {
                case 'comfortable': return 'background: #d1fae5; color: #065f46;';
                case 'adequate': return 'background: #ccfbf1; color: #0f766e;';
                case 'tight': return 'background: #fef3c7; color: #92400e;';
                case 'at_risk': return 'background: #fee2e2; color: #991b1b;';
                default: return 'background: #f3f4f6; color: #374151;';
            }
        }

        function riskLevelColor(level) {
            switch (level) {
                case 'comfortable': return '#10b981';
                case 'adequate': return '#14b8a6';
                case 'tight': return '#f59e0b';
                case 'at_risk': return '#ef4444';
                default: return '#9ca3af';
            }
        }

        function renderWellRiskProfileReport(data) {
            const { wtiPrice, henryHubPrice, summary, wells, byProfile, byFormation } = data;

            // Header badges
            const netBackStr = summary.portfolioNetBack ? ' (net-back $' + summary.portfolioNetBack.toFixed(2) + ')' : '';
            document.getElementById('reportSubtitle').textContent =
                summary.totalWells + ' wells analyzed at $' + wtiPrice.price.toFixed(2) + '/bbl WTI' + netBackStr;

            const statusEl = document.getElementById('reportStatus');
            if (summary.atRiskCount > 0) {
                statusEl.textContent = summary.atRiskCount + ' at risk';
                statusEl.className = 'report-status report-status-danger';
            } else if (summary.tightCount > 0) {
                statusEl.textContent = 'All above breakeven';
                statusEl.className = 'report-status report-status-warning';
            } else {
                statusEl.textContent = 'Portfolio healthy';
                statusEl.className = 'report-status report-status-success';
            }

            document.getElementById('reportMeta').textContent =
                'Profile coverage: ' + summary.coverageRate + '%';

            // WTI Price Banner
            const priceDate = wtiPrice.date ? new Date(wtiPrice.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Unknown';
            let priceBanner = `
                <div style="background: linear-gradient(135deg, #1e3a5f, #0f172a); color: #fff; padding: 1rem 1.25rem; border-radius: 10px; margin-bottom: 1.25rem; display: flex; flex-wrap: wrap; align-items: center; gap: 1.5rem;">
                    <div>
                        <div style="font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">WTI Crude</div>
                        <div style="font-size: 1.5rem; font-weight: 700;">$${wtiPrice.price.toFixed(2)}<span style="font-size: 0.875rem; font-weight: 400; color: #94a3b8;">/bbl</span></div>
                    </div>`;
            if (henryHubPrice) {
                priceBanner += `
                    <div style="border-left: 1px solid rgba(255,255,255,0.2); padding-left: 1.5rem;">
                        <div style="font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">Henry Hub</div>
                        <div style="font-size: 1.5rem; font-weight: 700;">$${henryHubPrice.price.toFixed(2)}<span style="font-size: 0.875rem; font-weight: 400; color: #94a3b8;">/MCF</span></div>
                    </div>`;
            }
            priceBanner += `
                    <div style="margin-left: auto; font-size: 0.75rem; color: #64748b;">${priceDate} &middot; ${wtiPrice.source || 'OilPriceAPI'}</div>
                </div>`;

            // HUD Metrics
            const hudBadges = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1.25rem;">
                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 1rem; text-align: center;">
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">${summary.totalWells}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Total Wells</div>
                    </div>
                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 1rem; text-align: center;">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #ef4444;">${summary.atRiskCount}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">At Risk</div>
                    </div>
                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 1rem; text-align: center;">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #f59e0b;">${summary.tightCount}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Tight</div>
                    </div>
                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 1rem; text-align: center;">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #10b981;">${summary.comfortableCount + summary.adequateCount}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Comfortable</div>
                    </div>
                </div>`;

            // Tabs
            const tabs = `
                <div id="riskTabs" style="display: flex; gap: 0; border-bottom: 1px solid var(--border-subtle); margin-bottom: 1.25rem;">
                    <button class="pooling-tab active" data-tab="overview" onclick="switchRiskTab('overview')" style="padding: 0.625rem 1.25rem;">Risk Overview</button>
                    <button class="pooling-tab" data-tab="formation" onclick="switchRiskTab('formation')" style="padding: 0.625rem 1.25rem;">By Formation</button>
                    <button class="pooling-tab" data-tab="methodology" onclick="switchRiskTab('methodology')" style="padding: 0.625rem 1.25rem;">Methodology</button>
                </div>
                <div id="riskTabContent"></div>`;

            document.getElementById('reportContent').innerHTML = priceBanner + hudBadges + tabs;
            switchRiskTab('overview');
        }

        function switchRiskTab(tab) {
            riskCurrentTab = tab;

            const tabContainer = document.getElementById('riskTabs');
            if (tabContainer) {
                tabContainer.querySelectorAll('.pooling-tab').forEach(t => t.classList.remove('active'));
                tabContainer.querySelector('.pooling-tab[data-tab="' + tab + '"]')?.classList.add('active');
            }

            const content = document.getElementById('riskTabContent');
            if (!content || !lastWellRiskData) return;

            if (tab === 'overview') {
                content.innerHTML = renderRiskOverviewTab(lastWellRiskData);
            } else if (tab === 'formation') {
                content.innerHTML = renderRiskFormationTab(lastWellRiskData);
            } else if (tab === 'methodology') {
                content.innerHTML = renderRiskMethodologyTab(lastWellRiskData);
            }
        }

        // ---- RISK OVERVIEW TAB ----

        // Sort state for click-to-sort headers
        let riskSortCol = 'stressed';
        let riskSortDir = 'asc';

        function onRiskHeaderSort(col) {
            if (riskSortCol === col) {
                riskSortDir = riskSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                riskSortCol = col;
                riskSortDir = (col === 'name' || col === 'formation') ? 'asc' : 'asc';
            }
            renderRiskTable();
        }

        function renderRiskOverviewTab(data) {
            const { wells, summary } = data;
            const wti = data.wtiPrice.price;

            // Build filter options
            const counties = [...new Set(wells.map(w => w.county).filter(Boolean))].sort();
            const riskLevels = ['all', 'at_risk', 'tight', 'adequate', 'comfortable'];

            const deductionNote = summary.wellsWithDeductionData > 0
                ? '<span style="font-size: 0.75rem; color: var(--text-muted); margin-left: 0.5rem;">' + summary.wellsWithDeductionData + ' wells with OTC deduction data (avg ' + (summary.avgDiscountPct || 20).toFixed(1) + '% discount)</span>'
                : '';

            let html = `
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; align-items: center;">
                    <input type="text" id="riskSearchInput" placeholder="Search well or operator..." oninput="filterRiskTable()"
                        style="flex: 1; min-width: 180px; padding: 0.5rem 0.75rem; border: 1px solid var(--border-subtle); border-radius: 6px; background: var(--bg-card); color: var(--text-primary); font-size: 0.8125rem;">
                    <select id="riskCountyFilter" onchange="filterRiskTable()"
                        style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-subtle); border-radius: 6px; background: var(--bg-card); color: var(--text-primary); font-size: 0.8125rem;">
                        <option value="">All Counties</option>
                        ${counties.map(c => '<option value="' + c + '">' + c + '</option>').join('')}
                    </select>
                    <select id="riskLevelFilter" onchange="filterRiskTable()"
                        style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-subtle); border-radius: 6px; background: var(--bg-card); color: var(--text-primary); font-size: 0.8125rem;">
                        ${riskLevels.map(l => '<option value="' + l + '">' + (l === 'all' ? 'All Risk Levels' : riskLevelLabel(l)) + '</option>').join('')}
                    </select>
                    <button onclick="exportWellRiskCsv()" style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-subtle); border-radius: 6px; background: var(--bg-card); color: var(--text-primary); font-size: 0.8125rem; cursor: pointer;" title="Export CSV">CSV</button>
                    <button onclick="loadWellRiskProfileReport(true)" style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-subtle); border-radius: 6px; background: var(--bg-card); color: var(--text-primary); font-size: 0.8125rem; cursor: pointer;" title="Refresh data">Refresh</button>
                    ${deductionNote}
                </div>
                <div id="riskTableContainer"></div>`;

            // Render table after DOM is ready
            setTimeout(() => renderRiskTable(), 0);

            return html;
        }

        function filterRiskTable() {
            renderRiskTable();
        }

        function renderRiskTable() {
            if (!lastWellRiskData) return;
            const container = document.getElementById('riskTableContainer');
            if (!container) return;

            const wti = lastWellRiskData.wtiPrice.price;
            let wells = [...lastWellRiskData.wells];

            // Apply filters
            const search = (document.getElementById('riskSearchInput')?.value || '').toLowerCase();
            const county = document.getElementById('riskCountyFilter')?.value || '';
            const level = document.getElementById('riskLevelFilter')?.value || 'all';

            if (search) {
                wells = wells.filter(w =>
                    (w.wellName || '').toLowerCase().includes(search) ||
                    (w.operator || '').toLowerCase().includes(search) ||
                    (w.apiNumber || '').includes(search)
                );
            }
            if (county) wells = wells.filter(w => w.county === county);
            if (level !== 'all') wells = wells.filter(w => w.riskLevel === level);

            // Click-to-sort
            const riskOrder = { at_risk: 0, tight: 1, adequate: 2, comfortable: 3 };
            const dir = riskSortDir === 'asc' ? 1 : -1;
            switch (riskSortCol) {
                case 'name':
                    wells.sort((a, b) => dir * (a.wellName || '').localeCompare(b.wellName || ''));
                    break;
                case 'formation':
                    wells.sort((a, b) => dir * (a.formationGroup || 'ZZZ').localeCompare(b.formationGroup || 'ZZZ'));
                    break;
                case 'breakeven':
                    wells.sort((a, b) => dir * ((a.halfCycleBreakeven ?? 999) - (b.halfCycleBreakeven ?? 999)));
                    break;
                case 'deductions':
                    wells.sort((a, b) => dir * ((a.totalDiscountPct ?? 999) - (b.totalDiscountPct ?? 999)));
                    break;
                case 'netback':
                    wells.sort((a, b) => dir * ((a.netBackPrice ?? 999) - (b.netBackPrice ?? 999)));
                    break;
                case 'status':
                    wells.sort((a, b) => dir * ((riskOrder[a.riskLevel] ?? 5) - (riskOrder[b.riskLevel] ?? 5)));
                    break;
                case 'stressed':
                    wells.sort((a, b) => dir * ((a.stressedAtWti ?? 999) - (b.stressedAtWti ?? 999)));
                    break;
                case 'critical':
                    wells.sort((a, b) => dir * ((a.criticalAtWti ?? 999) - (b.criticalAtWti ?? 999)));
                    break;
                default:
                    wells.sort((a, b) => (a.stressedAtWti ?? 999) - (b.stressedAtWti ?? 999));
            }

            if (wells.length === 0) {
                container.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">No wells match the current filters.</div>';
                return;
            }

            // Sort indicator helper
            function sortArrow(col) {
                if (riskSortCol !== col) return '';
                return ' ' + (riskSortDir === 'asc' ? '\u25B2' : '\u25BC');
            }
            const thStyle = 'padding: 0.625rem 0.5rem; font-weight: 600; color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.03em; cursor: pointer; user-select: none; white-space: nowrap;';
            const thStyleR = thStyle + ' text-align: right;';

            let rows = wells.map(w => {
                const formStr = w.formationGroup || '<span style="color: var(--text-muted);">Unknown</span>';
                const beStr = w.halfCycleBreakeven !== null ? '$' + w.halfCycleBreakeven : '\u2014';
                const discountStr = w.totalDiscountPct !== null ? w.totalDiscountPct.toFixed(1) + '%' : '\u2014';
                const discountColor = !w.hasDeductionData ? 'color: var(--text-muted); font-style: italic;' : '';
                const netBackStr = w.netBackPrice !== null ? '$' + w.netBackPrice.toFixed(2) : '\u2014';

                // Status pill: tier label colored by risk level
                const statusHtml = '<span style="display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 500; ' + riskLevelBadgeStyle(w.riskLevel) + '">' + riskLevelLabel(w.riskLevel) + '</span>';

                // Stressed At — amber when within $10 of current WTI
                let stressedStr = '\u2014';
                let stressedStyle = '';
                if (w.stressedAtWti !== null) {
                    stressedStr = '$' + w.stressedAtWti.toFixed(0);
                    if (wti - w.stressedAtWti <= 10 && wti >= w.stressedAtWti) {
                        stressedStyle = 'color: #f59e0b; font-weight: 600;';
                    } else if (wti < w.stressedAtWti) {
                        stressedStyle = 'color: #ef4444; font-weight: 600;';
                    }
                }

                // Critical At — red when within $5 of current WTI
                let criticalStr = '\u2014';
                let criticalStyle = '';
                if (w.criticalAtWti !== null) {
                    criticalStr = '$' + w.criticalAtWti.toFixed(0);
                    if (wti - w.criticalAtWti <= 5 && wti >= w.criticalAtWti) {
                        criticalStyle = 'color: #f59e0b; font-weight: 600;';
                    } else if (wti < w.criticalAtWti) {
                        criticalStyle = 'color: #ef4444; font-weight: 600;';
                    }
                }

                return '<tr style="border-bottom: 1px solid var(--border-subtle);">' +
                    '<td style="padding: 0.5rem; font-weight: 500; max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + (w.wellName || '').replace(/"/g, '&quot;') + '">' + (w.wellName || 'Unknown') + '</td>' +
                    '<td style="padding: 0.5rem;">' + formStr + '</td>' +
                    '<td style="padding: 0.5rem; text-align: right;">' + beStr + '</td>' +
                    '<td style="padding: 0.5rem; text-align: right; ' + discountColor + '" title="' + (w.hasDeductionData ? 'Mkt: ' + (w.mktDeductionPct || 0).toFixed(1) + '% | Tax: ' + (w.taxPct || 0).toFixed(1) + '% | Floor: 15%' : 'Default 20% (no OTC data)') + '">' + discountStr + '</td>' +
                    '<td style="padding: 0.5rem; text-align: right; font-weight: 500;">' + netBackStr + '</td>' +
                    '<td style="padding: 0.5rem; text-align: center;">' + statusHtml + '</td>' +
                    '<td style="padding: 0.5rem; text-align: right; ' + stressedStyle + '">' + stressedStr + '</td>' +
                    '<td style="padding: 0.5rem; text-align: right; ' + criticalStyle + '">' + criticalStr + '</td>' +
                    '</tr>';
            }).join('');

            container.innerHTML = `
                <div style="overflow-x: auto; border: 1px solid var(--border-subtle); border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8125rem;">
                        <thead>
                            <tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border-subtle);">
                                <th style="${thStyle} text-align: left;" onclick="onRiskHeaderSort('name')">Well Name${sortArrow('name')}</th>
                                <th style="${thStyle} text-align: left;" onclick="onRiskHeaderSort('formation')">Formation${sortArrow('formation')}</th>
                                <th style="${thStyleR}" onclick="onRiskHeaderSort('breakeven')">Breakeven${sortArrow('breakeven')}</th>
                                <th style="${thStyleR}" onclick="onRiskHeaderSort('deductions')" title="All-in discount from OTC tax records">Deductions${sortArrow('deductions')}</th>
                                <th style="${thStyleR}" onclick="onRiskHeaderSort('netback')" title="WTI × (1 - deductions)">Net-Back${sortArrow('netback')}</th>
                                <th style="${thStyle} text-align: center;" onclick="onRiskHeaderSort('status')">Status${sortArrow('status')}</th>
                                <th style="${thStyleR}" onclick="onRiskHeaderSort('stressed')" title="WTI price where margin drops to 10%">Stressed At${sortArrow('stressed')}</th>
                                <th style="${thStyleR}" onclick="onRiskHeaderSort('critical')" title="WTI price where net-back equals breakeven">Critical At${sortArrow('critical')}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                    Showing ${wells.length} of ${lastWellRiskData.wells.length} wells
                </div>`;
        }

        // ---- BY FORMATION TAB ----

        function renderRiskFormationTab(data) {
            const { byFormation, wtiPrice, summary } = data;
            const wti = wtiPrice.price;
            const avgDiscount = (summary.avgDiscountPct || 20) / 100;
            const netBack = wti * (1 - avgDiscount);

            if (!byFormation || byFormation.length === 0) {
                return '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">No formation data available.</div>';
            }

            const profileNames = {
                'scoop-stack-hz': 'SCOOP/STACK Hz',
                'other-hz': 'Other Hz',
                'deep-conventional': 'Deep Conv.',
                'conventional-vert': 'Conv. Vertical',
                'unknown-formation': 'Unknown'
            };

            let cards = byFormation.map(f => {
                const avgBE = f.avgBreakeven;
                const cushion = avgBE !== null ? (netBack - avgBE) : null;
                const cushionPct = avgBE !== null && netBack > 0 ? ((cushion / netBack) * 100) : null;

                // Risk distribution bar
                let barHtml = '';
                const profileEntries = Object.entries(f.profileDistribution || {});
                if (profileEntries.length > 0) {
                    const total = f.wellCount;
                    const segments = profileEntries.map(([pid, count]) => {
                        const pct = (count / total * 100).toFixed(1);
                        const profileBE = getProfileBreakeven(pid);
                        const profileNetBack = wti * (1 - avgDiscount);
                        const color = riskLevelColor(getRiskLevelFrontend(profileNetBack, profileBE));
                        return '<div style="width: ' + pct + '%; background: ' + color + '; height: 8px;" title="' + (profileNames[pid] || pid) + ': ' + count + '"></div>';
                    }).join('');
                    barHtml = '<div style="display: flex; border-radius: 4px; overflow: hidden; margin: 0.5rem 0;">' + segments + '</div>';
                }

                // Profile breakdown
                const profileList = profileEntries.map(([pid, count]) =>
                    (profileNames[pid] || pid) + ' (' + count + ')'
                ).join(', ');

                return `
                    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 1.25rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: var(--text-primary);">${f.formationGroup}</h4>
                            <span style="font-size: 0.875rem; font-weight: 600; color: var(--text-secondary);">${f.wellCount} well${f.wellCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            ${avgBE !== null ? '<div>Avg Breakeven: <strong>$' + avgBE.toFixed(0) + '/bbl</strong></div>' : ''}
                            ${cushion !== null ? '<div>Net-Back Cushion: <strong style="color: ' + (cushion >= 0 ? '#10b981' : '#ef4444') + ';">' + (cushion >= 0 ? '+' : '') + '$' + cushion.toFixed(0) + '</strong></div>' : ''}
                            ${f.atRiskCount > 0 ? '<div style="color: #ef4444;"><strong>' + f.atRiskCount + '</strong> at risk</div>' : ''}
                        </div>
                        ${barHtml}
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">${profileList}</div>
                    </div>`;
            }).join('');

            return `
                <div style="display: grid; gap: 0.75rem;">
                    ${cards}
                </div>`;
        }

        function getProfileBreakeven(profileId) {
            const map = {
                'scoop-stack-hz': 28, 'other-hz': 35, 'deep-conventional': 45,
                'conventional-vert': 40, 'unknown-formation': 38
            };
            return map[profileId] || 38;
        }

        function getRiskLevelFrontend(netBack, breakeven) {
            const cushionPct = netBack > 0 ? ((netBack - breakeven) / netBack) * 100 : -100;
            if (cushionPct > 25) return 'comfortable';
            if (cushionPct > 10) return 'adequate';
            if (cushionPct > 0) return 'tight';
            return 'at_risk';
        }

        // ---- METHODOLOGY TAB ----

        function renderRiskMethodologyTab(data) {
            const avgDisc = data.summary.avgDiscountPct ? data.summary.avgDiscountPct.toFixed(1) : '20.0';
            const deductionWells = data.summary.wellsWithDeductionData || 0;
            return `
                <div style="max-width: 720px;">
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem;">Net-back pricing</h3>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; margin: 0;">
                            This report uses <strong>net-back pricing</strong> instead of raw WTI to evaluate risk. The net-back price is what the mineral owner actually receives after all deductions:
                        </p>
                        <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 1rem; margin: 0.75rem 0; font-family: monospace; font-size: 0.875rem; color: var(--text-primary);">
                            Net-Back = WTI &times; (1 &minus; All-in Discount)<br>
                            All-in Discount = 1 &minus; (Net Value &minus; GP Tax &minus; PE Tax) / Gross Value
                        </div>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; margin: 0.5rem 0 0;">
                            The all-in discount is computed <strong>per well</strong> from trailing 12-month OTC tax records. It captures marketing deductions (gas gathering/processing), gross production tax (~7%), and petroleum excise tax. A <strong>15% floor</strong> is applied because OTC data does not track oil-side deductions (gathering, transportation, basis differentials) &mdash; those happen at the operator level via check stubs. Currently <strong>${deductionWells} wells</strong> have OTC financial data (portfolio average: ${avgDisc}% discount). Wells without OTC data use a 20% default.
                        </p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem;">What is half-cycle breakeven?</h3>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; margin: 0;">
                            Half-cycle breakeven is the oil price needed to cover <strong>lease operating expenses (LOE)</strong> only &mdash; the ongoing costs of keeping an existing well producing. Unlike full-cycle breakeven (which includes drilling &amp; completion costs), half-cycle reflects <strong>sunk cost economics</strong>: for a well that is already drilled, D&amp;C costs are irrelevant. A well is only worth shutting in when oil drops below its half-cycle breakeven.
                        </p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem;">How profiles are assigned</h3>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; margin: 0;">
                            Each well is assigned a risk profile based on two factors: <strong>formation group</strong> (from OCC 1002A completion reports) and <strong>well type</strong> (horizontal vs. vertical). The combination determines which breakeven range applies:
                        </p>
                        <ul style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.8; margin: 0.5rem 0; padding-left: 1.25rem;">
                            <li><strong>SCOOP/STACK Horizontal</strong> &mdash; Mississippian, Woodford, Springer formations &middot; $28/bbl</li>
                            <li><strong>Other Horizontal</strong> &mdash; Granite Wash, Cleveland, Morrow, etc. &middot; $35/bbl</li>
                            <li><strong>Deep Conventional</strong> &mdash; Hunton, Viola, Simpson, Arbuckle verticals &middot; $45/bbl</li>
                            <li><strong>Conventional Vertical</strong> &mdash; Other vertical wells with known formations &middot; $40/bbl</li>
                            <li><strong>Unknown Formation</strong> &mdash; Blended Oklahoma average &middot; $38/bbl</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem;">Risk level thresholds</h3>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; margin: 0 0 0.5rem;">
                            Risk is measured as a <strong>net-back margin</strong>: (net-back &minus; breakeven) / net-back. This naturally scales across different price environments and deduction levels:
                        </p>
                        <div style="display: grid; gap: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 3px; background: #10b981;"></span>
                                <span style="font-size: 0.875rem; color: var(--text-secondary);"><strong>Comfortable</strong> &mdash; More than 25% margin above breakeven</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 3px; background: #14b8a6;"></span>
                                <span style="font-size: 0.875rem; color: var(--text-secondary);"><strong>Adequate</strong> &mdash; 10&ndash;25% margin above breakeven</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 3px; background: #f59e0b;"></span>
                                <span style="font-size: 0.875rem; color: var(--text-secondary);"><strong>Tight</strong> &mdash; 0&ndash;10% margin above breakeven</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 3px; background: #ef4444;"></span>
                                <span style="font-size: 0.875rem; color: var(--text-secondary);"><strong>At Risk</strong> &mdash; Below breakeven (operating at a loss)</span>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem;">Price sensitivity columns</h3>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; margin: 0;">
                            <strong>Stressed At</strong> shows the WTI price where a well&rsquo;s net-back margin drops to 10% (the tight threshold). <strong>Critical At</strong> shows the WTI price where the net-back equals breakeven &mdash; below this, the well operates at a loss. These thresholds are personalized per well based on actual deduction rates from OTC data. Wells with higher deductions have higher stress thresholds, making their margins more sensitive to WTI drops.
                        </p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem;">Data sources</h3>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; margin: 0;">
                            <strong>Deductions:</strong> Per-well all-in discount from Oklahoma Tax Commission (OTC) gross production reports &mdash; trailing 12-month actuals including marketing deductions, GP tax, and PE tax.
                            <strong>Formation data:</strong> OCC Form 1002A completion reports, normalized to geological groups.
                            <strong>Prices:</strong> OilPriceAPI/EIA, refreshed daily.
                            <strong>Breakeven:</strong> Dallas Fed Energy Survey, public operator filings (Devon, Coterra, Continental, SandRidge), Oklahoma stripper well commission data.
                        </p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem;">Limitations</h3>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; margin: 0;">
                            Breakeven estimates use <strong>formation-level averages</strong>. Individual well economics may vary based on depth, water cut, workover history, and operator efficiency. Wells without OTC financial data use a 20% default discount (the Oklahoma average). OTC data lags by 2&ndash;3 months from the reporting period.
                        </p>
                    </div>
                </div>`;
        }

        // ---- CSV EXPORT ----

        function exportWellRiskCsv() {
            if (!lastWellRiskData) return;
            const wti = lastWellRiskData.wtiPrice.price;

            const rows = [['Well Name', 'API Number', 'Operator', 'County', 'Formation', 'Formation Group', 'Profile', 'Breakeven ($/bbl)', 'WTI ($/bbl)', 'Deductions (%)', 'Net-Back ($/bbl)', 'Cushion ($)', 'Cushion (%)', 'Risk Level', 'Stressed At WTI ($)', 'Critical At WTI ($)', 'Has OTC Data']];
            for (const w of lastWellRiskData.wells) {
                rows.push([
                    w.wellName || '', w.apiNumber || '', w.operator || '', w.county || '',
                    w.formationCanonical || '', w.formationGroup || '',
                    w.profileName || '', w.halfCycleBreakeven !== null ? w.halfCycleBreakeven : '',
                    wti,
                    w.totalDiscountPct !== null ? w.totalDiscountPct.toFixed(1) : '',
                    w.netBackPrice !== null ? w.netBackPrice.toFixed(2) : '',
                    w.cushionDollar !== null ? w.cushionDollar.toFixed(2) : '',
                    w.cushionPct !== null ? w.cushionPct.toFixed(1) : '',
                    riskLevelLabel(w.riskLevel),
                    w.stressedAtWti !== null ? w.stressedAtWti.toFixed(0) : '',
                    w.criticalAtWti !== null ? w.criticalAtWti.toFixed(0) : '',
                    w.hasDeductionData ? 'Yes' : 'No'
                ]);
            }

            const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'well-risk-profile-' + new Date().toISOString().slice(0, 10) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

