        async function loadProperties() {
            try {
                const res = await fetch('/api/properties/v2');
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();
                const properties = data.records || data; // backward compat
                loadedProperties = properties;
                document.getElementById('propCount').textContent = properties.length;
                updateTotalCount();

                // Show upgrade banner if user has more data than their plan allows
                if (data._meta && data._meta.total > data._meta.visible) {
                    showUpgradeBanner('propertiesContent', 'properties', data._meta);
                }

                // Render table immediately (with zero counts)
                renderPropertiesTable();

                // Fetch link counts — skip if V2 already returned them inline
                if (properties.length > 0 && !properties[0]._linkCounts) {
                    fetchPropertyLinkCounts();
                }
            } catch { document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p style="color: var(--error);">Error loading. Refresh page.</p></div>'; }
        }

        // Fetch link counts and merge into loadedProperties
        async function fetchPropertyLinkCounts() {
            try {
                const res = await fetch('/api/properties/link-counts');
                if (!res.ok) return;
                const counts = await res.json();

                // Merge counts into loadedProperties
                for (const prop of loadedProperties) {
                    if (counts[prop.id]) {
                        prop._linkCounts = counts[prop.id];
                    }
                }

                // Re-render with updated counts
                renderPropertiesTable();
            } catch (err) {
                console.error('Failed to load link counts:', err);
            }
        }
        
        // Generate a map link for a property section (centers on general area)
        function generateSectionMapLink(sec, twn, rng, county) {
            // Link to OCC GIS with a search query - this will show the general area
            // We can't pin-drop without coordinates, but we can search
            const searchTerm = encodeURIComponent(`${county || ''} ${sec} ${twn} ${rng}`.trim());
            return `https://gis.occ.ok.gov/portal/apps/webappviewer/index.html?id=ba9b8612132f4106be6e3553dc0b827b`;
        }

        async function loadWells() {
            try {
                // Use V2 endpoint with D1 as primary data source
                const res = await fetch('/api/wells/v2');
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();
                const wells = data.records || data; // backward compat
                loadedWells = wells;
                document.getElementById('wellCount').textContent = wells.length;
                updateTotalCount();

                // Show upgrade banner if user has more data than their plan allows
                if (data._meta && data._meta.total > data._meta.visible) {
                    showUpgradeBanner('wellsContent', 'wells', data._meta);
                }

                // Render the table (handles empty state internally)
                renderWellsTable();

                // Fetch link counts in background (non-blocking)
                fetchWellLinkCounts();
            } catch { document.getElementById('wellsContent').innerHTML = '<div class="empty-state"><p style="color: var(--error);">Error loading. Refresh page.</p></div>'; }
        }

        // Fetch link counts and merge into loadedWells
        async function fetchWellLinkCounts() {
            try {
                const res = await fetch('/api/wells/link-counts');
                if (!res.ok) return;
                const counts = await res.json();

                // Merge counts into loadedWells
                for (const well of loadedWells) {
                    if (counts[well.id]) {
                        well._linkCounts = counts[well.id];
                    }
                }

                // Re-render with updated counts
                renderWellsTable();
            } catch (err) {
                console.error('Failed to load well link counts:', err);
            }
        }

        function showUpgradeBanner(containerId, resourceType, meta) {
            const existing = document.querySelector('#' + containerId + ' .upgrade-banner');
            if (existing) existing.remove();
            const banner = document.createElement('div');
            banner.className = 'upgrade-banner';
            banner.innerHTML = 'You have <strong>' + meta.total + '</strong> ' + resourceType +
                '. Your <strong>' + meta.plan + '</strong> plan includes <strong>' + meta.limit + '</strong>.' +
                ' <a href="/portal/upgrade">Upgrade to see all &rarr;</a>';
            const container = document.getElementById(containerId);
            if (container) container.insertBefore(banner, container.firstChild);
        }

        // Properties Search & Sort State
        let propertiesSearchTerm = '';
        let propertiesSortBy = 'legal-asc';

        // Initialize Properties Controls (call this after user loads)
        function initPropertiesControls() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Show/hide controls based on plan
            document.getElementById('propertiesControls').style.display = hasSearch ? 'flex' : 'none';
            
            if (!hasSearch) return;
            
            // Search input handler
            document.getElementById('propertiesSearch').addEventListener('input', (e) => {
                propertiesSearchTerm = e.target.value.toLowerCase().trim();
                renderPropertiesTable();
            });
            
            // Sort select handler
            document.getElementById('propertiesSort').addEventListener('change', (e) => {
                propertiesSortBy = e.target.value;
                renderPropertiesTable();
            });
        }

        // Filter properties based on search term
        function filterProperties(properties) {
            if (!propertiesSearchTerm) return properties;

            const searchNoDash = propertiesSearchTerm.replace(/-/g, '');
            return properties.filter(p => {
                const f = p.fields;
                const searchable = [
                    f.COUNTY || '',
                    f.SEC || '',
                    f.TWN || '',
                    f.RNG || '',
                    f.MERIDIAN || '',
                    f.Notes || '',
                    f.property_code || '',
                    f.Group || '',
                    (f.TWN || '') + '-' + (f.RNG || '') + '-' + (f.SEC || '')
                ].join(' ').toLowerCase();

                return searchable.includes(propertiesSearchTerm) ||
                    searchable.replace(/-/g, '').includes(searchNoDash);
            });
        }

        // Sort properties based on selected option
        function sortProperties(properties) {
            const [field, direction] = propertiesSortBy.split('-');
            const multiplier = direction === 'asc' ? 1 : -1;
            
            return [...properties].sort((a, b) => {
                if (field === 'legal') {
                    // Legal Description: County → Township → Range → Section
                    const aCounty = (a.fields.COUNTY || '').toLowerCase();
                    const bCounty = (b.fields.COUNTY || '').toLowerCase();
                    if (aCounty !== bCounty) {
                        return aCounty < bCounty ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse township (e.g., "T24N" -> { num: 24, dir: "N" })
                    const parseTownship = (twp) => {
                        const match = (twp || '').match(/T?(\d+)([NS])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aTwp = parseTownship(a.fields.TWN);
                    const bTwp = parseTownship(b.fields.TWN);
                    if (aTwp.num !== bTwp.num) {
                        return aTwp.num < bTwp.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aTwp.dir !== bTwp.dir) {
                        return aTwp.dir < bTwp.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse range (e.g., "R10W" -> { num: 10, dir: "W" })
                    const parseRange = (rng) => {
                        const match = (rng || '').match(/R?(\d+)([EW])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aRng = parseRange(a.fields.RNG);
                    const bRng = parseRange(b.fields.RNG);
                    if (aRng.num !== bRng.num) {
                        return aRng.num < bRng.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aRng.dir !== bRng.dir) {
                        return aRng.dir < bRng.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Section (numeric)
                    const aSection = parseInt(a.fields.SEC) || 0;
                    const bSection = parseInt(b.fields.SEC) || 0;
                    return aSection < bSection ? -1 * multiplier : (aSection > bSection ? 1 * multiplier : 0);
                    
                } else if (field === 'date') {
                    // Date Added - use createdTime from Airtable
                    const aDate = new Date(a.createdTime || 0);
                    const bDate = new Date(b.createdTime || 0);
                    return aDate < bDate ? -1 * multiplier : (aDate > bDate ? 1 * multiplier : 0);
                    
                } else if (field === 'acres') {
                    // Total Acres - sum of RI and WI acres
                    const aTotal = (parseFloat(a.fields['RI Acres'] || 0) + parseFloat(a.fields['WI Acres'] || 0));
                    const bTotal = (parseFloat(b.fields['RI Acres'] || 0) + parseFloat(b.fields['WI Acres'] || 0));
                    return aTotal < bTotal ? -1 * multiplier : (aTotal > bTotal ? 1 * multiplier : 0);

                } else if (field === 'wells') {
                    // Linked Wells count
                    const aCount = a._linkCounts?.wells || 0;
                    const bCount = b._linkCounts?.wells || 0;
                    return aCount < bCount ? -1 * multiplier : (aCount > bCount ? 1 * multiplier : 0);

                } else if (field === 'documents') {
                    // Linked Documents count
                    const aCount = a._linkCounts?.documents || 0;
                    const bCount = b._linkCounts?.documents || 0;
                    return aCount < bCount ? -1 * multiplier : (aCount > bCount ? 1 * multiplier : 0);

                } else if (field === 'filings') {
                    // OCC Filings count
                    const aCount = a._linkCounts?.filings || 0;
                    const bCount = b._linkCounts?.filings || 0;
                    return aCount < bCount ? -1 * multiplier : (aCount > bCount ? 1 * multiplier : 0);
                }

                return 0;
            });
        }

        // Render the properties table (extracted from loadProperties)
        function renderPropertiesTable() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Apply filter and sort
            let displayProperties = loadedProperties;
            if (hasSearch) {
                displayProperties = filterProperties(loadedProperties);
                displayProperties = sortProperties(displayProperties);
                
                // Update results count
                const countEl = document.getElementById('propertiesResultsCount');
                if (propertiesSearchTerm) {
                    countEl.textContent = `${displayProperties.length} of ${loadedProperties.length} properties`;
                } else {
                    countEl.textContent = `${loadedProperties.length} properties`;
                }
            }
            
            if (displayProperties.length === 0 && loadedProperties.length > 0) {
                // No search results
                document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p>No properties match your search.</p></div>';
                return;
            }
            
            if (displayProperties.length === 0) {
                document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p>No properties yet. Add your first property to start monitoring.</p></div>';
                return;
            }
            
            // Build table with conditional checkbox column for non-Viewers
            const isViewer = currentUser?.role === 'Viewer';
            let html = '<table class="data-table"><colgroup>';
            if (!isViewer) html += '<col class="col-select">';
            html += '<col class="col-prop-county"><col class="col-prop-legal"><col class="col-prop-group"><col class="col-prop-acres"><col class="col-prop-notes"><col class="col-links"></colgroup><thead><tr>';
            if (!isViewer) html += '<th class="bulk-only"><input type="checkbox" id="selectAllProperties" title="Select all"></th>';
            html += '<th>County</th><th>Legal</th><th class="col-prop-group">Group</th><th style="text-align: right;"><span class="desktop-only-total">Total </span><span class="mobile-only-acres"></span>Acres</th><th class="col-prop-notes-cell">Notes</th><th style="text-align: right;">Links</th></tr></thead><tbody>';
            
            // SVG icons for links column
            const wellsIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>';
            const docsIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>';
            const filingsIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>';
            // Link/chain icon for mobile total (Heroicons)
            const linkIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>';

            displayProperties.forEach(p => {
                const f = p.fields;
                const str = `${f.TWN}-${f.RNG}-${f.SEC}`;
                const riAcres = parseFloat(f['RI Acres'] || 0);
                const wiAcres = parseFloat(f['WI Acres'] || 0);
                const totalAcres = riAcres + wiAcres;
                const acresDisplay = totalAcres > 0 ? totalAcres.toFixed(2) : '—';
                const notesText = f.Notes ? escapeHtml(f.Notes.substring(0, 80)) + (f.Notes.length > 80 ? '...' : '') : '';
                const notes = notesText ? `<span style="color: var(--slate-blue); font-size: 13px;">${notesText}</span>` : '<em style="color: #A0AEC0;">—</em>';
                const group = f.Group ? `<span style="color: var(--oil-navy); font-size: 12px; background: #F1F5F9; padding: 2px 8px; border-radius: 12px;">${escapeHtml(f.Group)}</span>` : '<em style="color: #A0AEC0;">—</em>';

                // Get link counts (populated from API or default to 0)
                const linkCounts = p._linkCounts || { wells: 0, documents: 0, filings: 0 };
                const wellsClass = linkCounts.wells === 0 ? 'link-count zero' : 'link-count';
                const docsClass = linkCounts.documents === 0 ? 'link-count zero' : 'link-count';
                const filingsClass = linkCounts.filings === 0 ? 'link-count zero' : 'link-count';
                const totalLinks = linkCounts.wells + linkCounts.documents + linkCounts.filings;
                const totalClass = totalLinks === 0 ? 'link-total zero' : 'link-total';

                html += `<tr onclick="openPropertyDetails('${p.id}')" style="cursor: pointer;">`;
                if (!isViewer) {
                    html += `<td class="bulk-only" onclick="event.stopPropagation()"><input type="checkbox" class="property-checkbox" data-id="${p.id}"></td>`;
                }
                html += `<td>${escapeHtml(cleanCountyDisplay(f.COUNTY)) || '—'}</td>
                    <td><strong>${str}</strong></td>
                    <td class="col-prop-group">${group}</td>
                    <td style="text-align: right;">${acresDisplay}</td>
                    <td title="${f.Notes ? escapeHtml(f.Notes) : ''}" class="col-prop-notes-cell">${notes}</td>
                    <td>
                        <div class="links-cell">
                            <div class="link-breakdown">
                                <span class="${wellsClass}" title="Linked Wells">${wellsIcon}${linkCounts.wells}</span>
                                <span class="link-separator">│</span>
                                <span class="${docsClass}" title="Documents">${docsIcon}${linkCounts.documents}</span>
                                <span class="link-separator">│</span>
                                <span class="${filingsClass}" title="OCC Filings">${filingsIcon}${linkCounts.filings}</span>
                            </div>
                            <span class="${totalClass}" title="Total Links (Wells: ${linkCounts.wells}, Docs: ${linkCounts.documents}, OCC: ${linkCounts.filings})">${linkIcon}${totalLinks}</span>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('propertiesContent').innerHTML = html;
            
            // Check if any properties have groups and show/hide Group column
            const hasGroups = displayProperties.some(p => p.fields.Group);
            const propertiesTable = document.querySelector('#propertiesContent .data-table');
            if (hasGroups) {
                propertiesTable.classList.add('has-groups');
            } else {
                propertiesTable.classList.remove('has-groups');
            }
            
            // Update bulk selection state after table render
            updateSelectAllState('properties');
            updateBulkActionVisibility();
        }
/* __SPLIT_PROPS_B__ */
        // Property Modal
        document.getElementById('addPropertyBtn').addEventListener('click', () => { 
            document.getElementById('addPropertyModal').style.display = 'flex'; 
        });
        
        function closePropertyModal() {
            document.getElementById('addPropertyModal').style.display = 'none';
            document.getElementById('addPropertyForm').reset();
            document.getElementById('countySearch').value = '';
            document.getElementById('county').value = '';
            document.getElementById('countyDropdown').style.display = 'none';
            document.getElementById('propertyNotes').value = ''; // Clear notes field
            document.getElementById('addPropertyRIAcres').value = '';
            document.getElementById('addPropertyWIAcres').value = '';
            document.getElementById('addPropertyTotalAcres').textContent = '0';
            document.getElementById('addPropertyAcreageBadge').style.display = 'none';
            document.getElementById('addPropertyLocation').style.opacity = '0';
        }
        
        // Auto-set meridian based on county
        function autoSetMeridian(county) {
            const panhandleCounties = ['Cimarron', 'Texas', 'Beaver'];
            const meridianSelect = document.getElementById('meridian');
            
            if (panhandleCounties.includes(county)) {
                meridianSelect.value = 'CM';
            } else if (county) { // Only set IM if a county is selected
                meridianSelect.value = 'IM';
            }
        }
        window.autoSetMeridian = autoSetMeridian; // Make available globally

        // Searchable county dropdown
        (function initCountySearch() {
            const counties = ['Alfalfa','Atoka','Beaver','Beckham','Blaine','Bryan','Caddo','Canadian','Carter','Cherokee','Choctaw','Cimarron','Cleveland','Coal','Comanche','Cotton','Craig','Creek','Custer','Delaware','Dewey','Ellis','Garfield','Garvin','Grady','Grant','Greer','Harmon','Harper','Haskell','Hughes','Jackson','Jefferson','Johnston','Kay','Kingfisher','Kiowa','Latimer','Le Flore','Lincoln','Logan','Love','Major','Marshall','Mayes','McClain','McCurtain','McIntosh','Murray','Muskogee','Noble','Nowata','Okfuskee','Oklahoma','Okmulgee','Osage','Ottawa','Pawnee','Payne','Pittsburg','Pontotoc','Pottawatomie','Pushmataha','Roger Mills','Rogers','Seminole','Sequoyah','Stephens','Texas','Tillman','Tulsa','Wagoner','Washington','Washita','Woods','Woodward'];
            const searchInput = document.getElementById('countySearch');
            const hiddenInput = document.getElementById('county');
            const dropdown = document.getElementById('countyDropdown');

            function renderList(filter) {
                const q = (filter || '').toLowerCase();
                const matches = q ? counties.filter(c => c.toLowerCase().startsWith(q)) : counties;
                if (matches.length === 0) {
                    dropdown.innerHTML = '<div style="padding: 8px 12px; color: #94a3b8; font-size: 13px;">No match</div>';
                } else {
                    dropdown.innerHTML = matches.map(c => {
                        var label = c;
                        if (q) {
                            label = '<strong>' + c.substring(0, q.length) + '</strong>' + c.substring(q.length);
                        }
                        return '<div class="county-option" data-value="' + c + '" style="padding: 7px 12px; font-size: 14px; cursor: pointer;">' + label + '</div>';
                    }).join('');
                }
                dropdown.style.display = 'block';
            }

            searchInput.addEventListener('focus', () => renderList(searchInput.value));
            searchInput.addEventListener('input', () => {
                hiddenInput.value = ''; // clear until a valid selection
                renderList(searchInput.value);
            });

            dropdown.addEventListener('click', (e) => {
                const option = e.target.closest('.county-option');
                if (!option) return;
                const val = option.dataset.value;
                searchInput.value = val;
                hiddenInput.value = val;
                dropdown.style.display = 'none';
                autoSetMeridian(val);
                updateLocationDisplay();
            });

            // Keyboard navigation
            searchInput.addEventListener('keydown', (e) => {
                const options = dropdown.querySelectorAll('.county-option');
                const active = dropdown.querySelector('.county-option.active');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (!active && options.length) { options[0].classList.add('active'); options[0].style.background = '#f0f9ff'; }
                    else if (active && active.nextElementSibling?.classList.contains('county-option')) {
                        active.classList.remove('active'); active.style.background = '';
                        active.nextElementSibling.classList.add('active'); active.nextElementSibling.style.background = '#f0f9ff';
                        active.nextElementSibling.scrollIntoView({ block: 'nearest' });
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (active && active.previousElementSibling?.classList.contains('county-option')) {
                        active.classList.remove('active'); active.style.background = '';
                        active.previousElementSibling.classList.add('active'); active.previousElementSibling.style.background = '#f0f9ff';
                        active.previousElementSibling.scrollIntoView({ block: 'nearest' });
                    }
                } else if (e.key === 'Enter' && active) {
                    e.preventDefault();
                    active.click();
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                }
            });

            // Hover highlight
            dropdown.addEventListener('mouseover', (e) => {
                const option = e.target.closest('.county-option');
                if (!option) return;
                dropdown.querySelectorAll('.county-option').forEach(o => { o.classList.remove('active'); o.style.background = ''; });
                option.classList.add('active');
                option.style.background = '#f0f9ff';
            });
            dropdown.addEventListener('mouseout', (e) => {
                const option = e.target.closest('.county-option');
                if (option) { option.classList.remove('active'); option.style.background = ''; }
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.county-search-wrapper')) {
                    dropdown.style.display = 'none';
                    // Auto-match if user typed a valid county name
                    if (searchInput.value && !hiddenInput.value) {
                        const match = counties.find(c => c.toLowerCase() === searchInput.value.trim().toLowerCase());
                        if (match) {
                            searchInput.value = match;
                            hiddenInput.value = match;
                            autoSetMeridian(match);
                            updateLocationDisplay();
                        }
                    }
                }
            });
        })();

        // Update location display in Add Property header
        function updateLocationDisplay() {
            const county = document.getElementById('county').value;
            const section = document.getElementById('section').value;
            const township = document.getElementById('township').value.toUpperCase();
            const range = document.getElementById('range').value.toUpperCase();
            const locationDiv = document.getElementById('addPropertyLocation');
            
            if (county && section && township && range) {
                locationDiv.textContent = `${county} County • ${township}-${range}-${section}`;
                locationDiv.style.opacity = '1';
            } else if (county) {
                locationDiv.textContent = `${county} County`;
                locationDiv.style.opacity = '0.8';
            } else {
                locationDiv.style.opacity = '0';
            }
        }
        window.updateLocationDisplay = updateLocationDisplay;
        
        // Update total acres for Add Property
        function updateAddPropertyTotalAcres() {
            const riAcres = parseFloat(document.getElementById('addPropertyRIAcres').value) || 0;
            const wiAcres = parseFloat(document.getElementById('addPropertyWIAcres').value) || 0;
            const total = riAcres + wiAcres;
            
            document.getElementById('addPropertyTotalAcres').textContent = total.toFixed(2);
            
            // Update the badge in header
            const badge = document.getElementById('addPropertyAcreageBadge');
            if (total > 0) {
                badge.textContent = `${total.toFixed(2)} acres`;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        window.updateAddPropertyTotalAcres = updateAddPropertyTotalAcres;
        
        document.getElementById('addPropertyModal').addEventListener('click', e => { 
            if (e.target.id === 'addPropertyModal') closePropertyModal(); 
        });
        
        document.getElementById('addPropertyForm').addEventListener('submit', async e => {
            e.preventDefault();
            
            // Get form values - normalize on the client side for display, but
            // the backend does full normalization (prefix stripping, case, defaults)
            let section = document.getElementById('section').value.trim();
            let township = document.getElementById('township').value.trim().toUpperCase();
            let range = document.getElementById('range').value.trim().toUpperCase();
            const notes = document.getElementById('propertyNotes').value.trim();

            // Strip common prefixes users might type
            section = section.replace(/^(s|sec|section)\s*/i, '');
            township = township.replace(/^(T|TWN|TOWN|TOWNSHIP)\s*/i, '').replace(/\s+/g, '');
            range = range.replace(/^(R|RNG|RANGE)\s*/i, '').replace(/\s+/g, '');

            // Light validation - let backend do the heavy lifting
            const secNum = parseInt(section, 10);
            if (isNaN(secNum) || secNum < 1 || secNum > 36) {
                showToast('Section must be a number between 1 and 36', 'error');
                return;
            }

            // Accept just a number for township/range - backend will add default direction
            if (!/^\d{1,2}[NSns]?$/.test(township)) {
                showToast('Township: number + N or S (e.g., 12N). Direction defaults to N.', 'error');
                return;
            }

            if (!/^\d{1,2}[EWew]?$/.test(range)) {
                showToast('Range: number + W or E (e.g., 4W). Direction defaults to W.', 'error');
                return;
            }
            
            // Validate county selection
            const countyValue = document.getElementById('county').value;
            if (!countyValue) {
                showToast('Please select a county from the list', 'error');
                document.getElementById('countySearch').focus();
                return;
            }

            const data = {
                COUNTY: countyValue,
                SEC: section,
                TWN: township,
                RNG: range,
                MERIDIAN: document.getElementById('meridian').value,
                Notes: notes,
                Group: document.getElementById('addPropertyGroup').value.trim(),
                'RI Acres': parseFloat(document.getElementById('addPropertyRIAcres').value) || 0,
                'WI Acres': parseFloat(document.getElementById('addPropertyWIAcres').value) || 0
            };
            try {
                const res = await fetch('/api/properties', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(data) 
                });
                if (!res.ok) { 
                    const err = await res.json(); 
                    if (err.error && err.error.includes('already monitoring')) {
                        showToast('Already tracking this property', 'info');
                    } else {
                        showToast(err.error || 'Failed to add property', 'error');
                    }
                    return;
                }
                showToast('Success, Property Added', 'success');
                closePropertyModal();
                await loadProperties();
            } catch (err) { 
                showToast('Error adding property: ' + err.message, 'error');
            }
        });
/* __SPLIT_PROPS_C__ */
        // Property Details Modal Functions
        async function openPropertyDetails(propId) {
            console.log('[openPropertyDetails] Called with propId:', propId);
            
            // Reset linked counts and lists immediately to prevent concatenation issues
            const wellsCountEl = document.getElementById('property-linked-wells-count');
            if (wellsCountEl) {
                wellsCountEl.textContent = '—';
            }
            
            // Also clear the list content to show fresh loading state
            const wellsListEl = document.getElementById('linked-wells-list');
            if (wellsListEl) {
                wellsListEl.innerHTML = '';
                wellsListEl.style.display = 'none';
            }
            
            let prop = loadedProperties.find(p => p.id === propId);
            
            // If not in loaded properties, fetch from API
            if (!prop) {
                console.log('[openPropertyDetails] Property not found in loadedProperties:', propId);
                console.log('[openPropertyDetails] Fetching from API...');
                
                try {
                    // Fetch all properties and find the one we need
                    const res = await fetch('/api/properties');
                    if (!res.ok) throw new Error('Failed to fetch properties');
                    
                    const allProperties = await res.json();
                    prop = allProperties.find(p => p.id === propId);
                    
                    if (!prop) {
                        console.error('[openPropertyDetails] Property not found in API response');
                        alert('Property not found');
                        return;
                    }
                    
                    // Add to loaded properties for future use
                    loadedProperties.push(prop);
                    console.log('[openPropertyDetails] Property fetched and added to cache');
                } catch (error) {
                    console.error('[openPropertyDetails] Error fetching property:', error);
                    alert('Error loading property details');
                    return;
                }
            }
            
            const f = prop.fields;
            document.getElementById('propertyDetailsId').value = propId;
            
            // Calculate total acres for header badge
            const riAcres = parseFloat(f['RI Acres'] || 0);
            const wiAcres = parseFloat(f['WI Acres'] || 0);
            const totalAcres = riAcres + wiAcres;
            
            // Set header information
            const propertyName = f['Name'] || f['Property Name'] || 'Mineral Property';
            document.getElementById('propertyDetailsTitle').textContent = propertyName;
            
            // Set acreage badge
            const acreageBadge = document.getElementById('propertyDetailsAcreageBadge');
            if (totalAcres > 0) {
                acreageBadge.textContent = `${totalAcres.toFixed(2)} acres`;
                acreageBadge.style.display = 'inline-block';
            } else {
                acreageBadge.style.display = 'none';
            }
            
            // Set location info (county + legal)
            const county = cleanCountyDisplay(f['COUNTY']) || 'Unknown County';
            const legal = `${f.TWN}-${f.RNG}-${f.SEC}`;
            document.getElementById('propertyDetailsLocation').textContent = `${county} • ${legal}`;
            
            // Set form fields
            document.getElementById('propertyDetailsLegal').textContent = legal;
            document.getElementById('propertyDetailsMeridian').value = f['MERIDIAN'] || 'IM';
            
            // Show/hide Group row based on whether it has a value
            const groupRow = document.getElementById('propertyDetailsGroupRow');
            if (f['Group']) {
                document.getElementById('propertyDetailsGroup').textContent = f['Group'];
                groupRow.style.display = 'flex';
            } else {
                groupRow.style.display = 'none';
            }
            
            // Set other fields
            document.getElementById('propertyDetailsRIAcres').value = riAcres;
            document.getElementById('propertyDetailsWIAcres').value = wiAcres;
            document.getElementById('propertyDetailsNotes').value = f['Notes'] || '';
            
            // Store original values for change detection
            document.getElementById('propertyDetailsOriginalNotes').value = f['Notes'] || '';
            document.getElementById('propertyDetailsOriginalRIAcres').value = riAcres;
            document.getElementById('propertyDetailsOriginalWIAcres').value = wiAcres;

            // Update total acres display in form
            updateTotalAcres();

            // Enterprise: property_code display
            const codeRow = document.getElementById('propertyDetailsCodeRow');
            if (f.property_code) {
                document.getElementById('propertyDetailsCode').textContent = 'Ref: ' + f.property_code;
                codeRow.style.display = 'block';
            } else {
                codeRow.style.display = 'none';
            }

            // Enterprise: Ownership Interests section
            const ownershipSection = document.getElementById('ownership-interests-section');
            const ownershipGrid = document.getElementById('ownership-interests-grid');
            const ownershipCount = document.getElementById('ownership-interests-count');

            // Always show all 6 ownership interest fields, pre-populated if values exist
            const allInterestFields = [
                { id: 'riDecimal', label: 'RI Decimal', value: f.ri_decimal, format: 'decimal' },
                { id: 'wiDecimal', label: 'WI Decimal', value: f.wi_decimal, format: 'decimal' },
                { id: 'orriDecimal', label: 'ORRI Decimal', value: f.orri_decimal, format: 'decimal' },
                { id: 'miDecimal', label: 'MI Decimal', value: f.mi_decimal, format: 'decimal' },
                { id: 'orriAcres', label: 'ORRI Acres', value: f.orri_acres, format: 'acres' },
                { id: 'miAcres', label: 'MI Acres', value: f.mi_acres, format: 'acres' }
            ];

            ownershipSection.style.display = 'block';
            const populatedCount = allInterestFields.filter(ff => ff.value != null).length;
            ownershipCount.textContent = populatedCount || '—';
            let html = '';
            for (const field of allInterestFields) {
                const step = 'any';
                const displayVal = field.value != null ? field.value : '';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">'
                    + '<span style="font-size: 13px; color: #374151; font-weight: 500;">' + field.label + '</span>'
                    + '<input type="number" id="propEnterprise_' + field.id + '" step="' + step + '" min="0" value="' + displayVal + '" '
                    + 'style="padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-family: \'SF Mono\', \'Monaco\', monospace; font-size: 13px; width: 140px; text-align: right; background: white;" '
                    + 'oninput="toggleSaveButton(\'property\')" placeholder="—">'
                    + '</div>';
            }
            ownershipGrid.innerHTML = html;
            // Auto-expand when any values exist
            if (populatedCount > 0) {
                document.getElementById('ownership-interests-content').style.display = 'block';
                document.getElementById('ownership-interests-arrow').style.transform = 'rotate(90deg)';
            }

            // Store original enterprise values for change detection
            document.getElementById('propertyDetailsOriginalPropertyCode').value = f.property_code || '';
            document.getElementById('propertyDetailsOriginalRiDecimal').value = f.ri_decimal != null ? f.ri_decimal : '';
            document.getElementById('propertyDetailsOriginalWiDecimal').value = f.wi_decimal != null ? f.wi_decimal : '';
            document.getElementById('propertyDetailsOriginalOrriAcres').value = f.orri_acres != null ? f.orri_acres : '';
            document.getElementById('propertyDetailsOriginalOrriDecimal').value = f.orri_decimal != null ? f.orri_decimal : '';
            document.getElementById('propertyDetailsOriginalMiAcres').value = f.mi_acres != null ? f.mi_acres : '';
            document.getElementById('propertyDetailsOriginalMiDecimal').value = f.mi_decimal != null ? f.mi_decimal : '';
            
            // Don't try to show count from property data - just show loading state
            const wellsCountElement = document.getElementById('property-linked-wells-count');
            // Already reset to '—' at the start of this function
            console.log('[PropertyDetails] Initial count placeholder set to loading state');
            
            // Always show loading state initially - the API will update with real data
            document.getElementById('linked-wells-list').innerHTML = '<div style="padding: 12px; color: #6b7280;">Loading wells...</div>';
            document.getElementById('linked-wells-list').style.display = 'block';
            document.getElementById('linked-wells-empty').style.display = 'none';
            
            // Show modal with forced high z-index like bulk modals
            const propModal = document.getElementById('propertyDetailsModal');
            
            // Nuclear option - move modal to end of body to escape any stacking context
            if (propModal.parentNode !== document.body) {
                document.body.appendChild(propModal);
            }
            
            // Calculate z-index based on stack depth BEFORE adding to stack
            const baseZIndex = 999999;
            const newZIndex = baseZIndex + (modalStack.length * 10);
            
            propModal.style.cssText = `display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: ${newZIndex} !important; background: rgba(0,0,0,0.5) !important; align-items: center !important; justify-content: center !important; padding: 20px !important;`;
            
            // Add to modal stack if not already there (initial opening)
            if (!modalStack.find(m => m.element === propModal)) {
                modalStack.push({ type: 'property', id: propId, element: propModal });
            }
            
            // Show/hide county records section based on org
            const crSection = document.getElementById('county-records-section');
            if (crSection) {
                crSection.style.display = isCountyRecordsEnabled() ? 'block' : 'none';
            }

            // Load linked wells and OCC filings after modal is shown to avoid race condition
            console.log('[PropertyDetails] Opening property:', propId);
            setTimeout(() => {
                loadLinkedWells(propId);
                loadLinkedDocuments(propId, 'property');
                // Load OCC filings using section/township/range/meridian
                if (f.SEC && f.TWN && f.RNG) {
                    const meridian = f['MERIDIAN'] || 'IM';
                    loadOccFilings(f.SEC, f.TWN, f.RNG, 'property', meridian);
                }
            }, 100);
            
            // Handle viewer permissions
            const isViewer = currentUser?.role === 'Viewer';
            if (isViewer) {
                document.getElementById('savePropertyBtn').style.display = 'none';
                document.getElementById('propertyDetailsNotes').readOnly = true;
                document.getElementById('propertyDetailsNotes').style.backgroundColor = '#f5f5f5';
                document.getElementById('propertyDetailsRIAcres').readOnly = true;
                document.getElementById('propertyDetailsRIAcres').style.backgroundColor = '#f5f5f5';
                document.getElementById('propertyDetailsWIAcres').readOnly = true;
                document.getElementById('propertyDetailsWIAcres').style.backgroundColor = '#f5f5f5';
            } else {
                document.getElementById('propertyDetailsNotes').readOnly = false;
                document.getElementById('propertyDetailsNotes').style.backgroundColor = 'white';
                document.getElementById('propertyDetailsRIAcres').readOnly = false;
                document.getElementById('propertyDetailsRIAcres').style.backgroundColor = 'white';
                document.getElementById('propertyDetailsWIAcres').readOnly = false;
                document.getElementById('propertyDetailsWIAcres').style.backgroundColor = 'white';
                // Save button will be shown by toggleSaveButton when values change
                toggleSaveButton('property');
            }
        }
        
        function updateTotalAcres() {
            const riAcres = parseFloat(document.getElementById('propertyDetailsRIAcres').value) || 0;
            const wiAcres = parseFloat(document.getElementById('propertyDetailsWIAcres').value) || 0;
            const totalAcres = riAcres + wiAcres;
            
            // Update total in form
            document.getElementById('propertyDetailsTotalAcres').textContent = totalAcres > 0 ? totalAcres.toFixed(2) : '—';
            
            // Update badge in header
            const acreageBadge = document.getElementById('propertyDetailsAcreageBadge');
            if (totalAcres > 0) {
                acreageBadge.textContent = `${totalAcres.toFixed(2)} acres`;
                acreageBadge.style.display = 'inline-block';
            } else {
                acreageBadge.style.display = 'none';
            }
        }
        
        // Ownership Interests toggle
        function toggleOwnershipInterests() {
            const content = document.getElementById('ownership-interests-content');
            const arrow = document.getElementById('ownership-interests-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Linked Wells Functions
        function toggleLinkedWells() {
            const content = document.getElementById('linked-wells-content');
            const arrow = document.getElementById('linked-wells-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        async function loadLinkedWells(propertyId) {
            console.log('[LinkedWells] Loading linked wells for property:', propertyId);
            
            const countEl = document.getElementById('property-linked-wells-count');
            const listEl = document.getElementById('linked-wells-list');
            const emptyEl = document.getElementById('linked-wells-empty');
            
            console.log('[LinkedWells] Count element before update:', countEl, 'textContent:', countEl?.textContent);
            
            // Don't reset count - it's already set from property data
            // Just ensure loading state is shown if count > 0
            const currentCount = parseInt(countEl.textContent) || 0;
            if (currentCount > 0 && !listEl.innerHTML.includes('linked-well-row')) {
                listEl.innerHTML = '<div style="padding: 12px; color: #6b7280;">Loading wells...</div>';
                listEl.style.display = 'block';
                emptyEl.style.display = 'none';
            }
            
            try {
                const response = await fetch(`/api/property/${propertyId}/linked-wells`);
                console.log('[LinkedWells] API Response status:', response.status);
                const data = await response.json();
                console.log('[LinkedWells] API Response data:', data);
                
                const linkedWells = data.wells ? data.wells.filter(w => w.linkStatus !== 'Unlinked') : [];
                const wellCount = linkedWells.length;
                console.log('[LinkedWells] Setting API count to:', wellCount, '(total incl unlinked:', (data.wells || []).length, ')');
                countEl.textContent = String(wellCount);

                if (!data.wells || data.wells.length === 0) {
                    console.log('[LinkedWells] No wells found, showing empty state');
                    listEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                } else {
                    console.log('[LinkedWells] Found', data.wells.length, 'wells, updating DOM');
                    listEl.innerHTML = data.wells.map(w => {
                        const isUnlinked = w.linkStatus === 'Unlinked';
                        const unlinkedDate = w.rejectedDate ? new Date(w.rejectedDate).toLocaleDateString() : '';
                        // Build interest decimal line if any exist
                        const interestParts = [];
                        if (w.wiNri) interestParts.push('WI: ' + parseFloat(w.wiNri).toFixed(8));
                        if (w.riNri) interestParts.push('RI: ' + parseFloat(w.riNri).toFixed(8));
                        if (w.orriNri) interestParts.push('ORRI: ' + parseFloat(w.orriNri).toFixed(8));
                        const interestLine = interestParts.length > 0
                            ? '<div style="font-size: 11px; color: #4b5563; font-family: \'SF Mono\', \'Monaco\', monospace; margin-top: 2px;">' + interestParts.join(' &middot; ') + '</div>'
                            : '';
                        return `
                        <div class="linked-well-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6;${isUnlinked ? ' opacity: 0.5;' : ''}">
                            <div style="flex: 1; cursor: pointer;" onclick="openWellFromProperty('${w.wellId}')">
                                <div style="font-weight: 500; color: ${isUnlinked ? '#9ca3af' : '#2563eb'};">${escapeHtml(w.wellName)}</div>
                                <div style="font-size: 12px; color: #6b7280;">${escapeHtml(w.operator)} • ${escapeHtml(w.county)}</div>
                                ${interestLine}
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; ${getMatchReasonStyle(w.matchReason)}">${getMatchReasonLabel(w.matchReason)}</span>
                                <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; ${getStatusStyle(w.wellStatus)}">${w.wellStatus || 'AC'}</span>
                                ${isUnlinked
                                    ? `<span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #fef2f2; color: #991b1b;">Unlinked</span>
                                       <button onclick="event.stopPropagation(); relinkWell('${w.linkId}')" title="Re-link this well${unlinkedDate ? ' (unlinked ' + unlinkedDate + ')' : ''}" style="font-size: 11px; padding: 2px 8px; border-radius: 4px; border: 1px solid #2563eb; background: #eff6ff; color: #2563eb; cursor: pointer;">Relink</button>`
                                    : `<button onclick="event.stopPropagation(); unlinkWell('${w.linkId}')" title="Unlink this well" style="font-size: 11px; padding: 2px 8px; border-radius: 4px; border: 1px solid #d1d5db; background: #f9fafb; color: #6b7280; cursor: pointer;">Unlink</button>`
                                }
                            </div>
                        </div>`;
                    }).join('');
                    listEl.style.display = 'block';
                    emptyEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load linked wells:', error);
                document.getElementById('property-linked-wells-count').textContent = '0';
                document.getElementById('linked-wells-list').style.display = 'none';
                document.getElementById('linked-wells-empty').style.display = 'block';
            }
        }
        
        // getMatchReasonStyle(), getMatchReasonLabel(), getStatusStyle() are now in shared-utils.txt

        function openManualLinkWell() {
            // Manual well linking to properties - feature coming soon
            showToast('Manual well linking coming soon', 'info');
        }
        
        // Alias for openWellDetailsModal for consistency
        function openWellDetail(wellId) {
            openWellDetailsModal(wellId);
        }
        
        // Open well from property modal - stack on top
        function openWellFromProperty(wellId) {
            // Check if we've hit max depth
            if (modalStack.length >= MAX_MODAL_DEPTH) {
                alert(`Maximum of ${MAX_MODAL_DEPTH} modals can be opened at once.`);
                return;
            }
            
            // Don't close the property modal - open well on top
            setTimeout(async () => {
                await openWellDetailsModal(wellId);
            }, 50);
        }
        
        async function unlinkWell(linkId) {
            if (!confirm('Remove this well link?')) return;

            try {
                const response = await fetch(`/api/property-well-link/${linkId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Reload the linked wells list
                    const propertyId = document.getElementById('propertyDetailsId').value;
                    loadLinkedWells(propertyId);
                } else {
                    console.error('Failed to unlink well');
                }
            } catch (error) {
                console.error('Error unlinking well:', error);
            }
        }

        async function relinkWell(linkId) {
            try {
                const response = await fetch(`/api/property-well-link/${linkId}`, {
                    method: 'PATCH'
                });

                if (response.ok) {
                    const propertyId = document.getElementById('propertyDetailsId').value;
                    loadLinkedWells(propertyId);
                } else {
                    console.error('Failed to re-link well');
                }
            } catch (error) {
                console.error('Error re-linking well:', error);
            }
        }
        
        // Linked Properties Functions (for well modal)
        function toggleLinkedProperties() {
            const content = document.getElementById('linked-properties-content');
            const arrow = document.getElementById('linked-properties-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        async function loadLinkedProperties(wellId) {
            console.log('[LinkedProperties] Loading linked properties for well:', wellId);
            
            // Clear and show loading state
            const countEl = document.getElementById('well-linked-properties-count');
            const listEl = document.getElementById('linked-properties-list');
            const emptyEl = document.getElementById('linked-properties-empty');
            
            // Don't reset count if it's already set from well data
            const currentCount = parseInt(countEl.textContent) || 0;
            if (currentCount > 0) {
                listEl.innerHTML = '<div style="padding: 12px; color: #6b7280;">Loading properties...</div>';
                listEl.style.display = 'block';
                emptyEl.style.display = 'none';
            } else {
                listEl.innerHTML = '';
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
            }
            
            try {
                const response = await fetch(`/api/well/${wellId}/linked-properties`, { credentials: 'include' });
                const data = await response.json();
                
                const linkedProps = data.properties ? data.properties.filter(p => p.linkStatus !== 'Unlinked') : [];
                const propCount = linkedProps.length;
                console.log('[LinkedProperties] Setting API count to:', propCount, '(total incl unlinked:', (data.properties || []).length, ')');
                countEl.textContent = String(propCount);

                if (!data.properties || data.properties.length === 0) {
                    listEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                } else {
                    listEl.innerHTML = data.properties.map(p => {
                        const isUnlinked = p.linkStatus === 'Unlinked';
                        const unlinkedDate = p.rejectedDate ? new Date(p.rejectedDate).toLocaleDateString() : '';
                        return `
                        <div class="linked-property-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6;${isUnlinked ? ' opacity: 0.5;' : ''}">
                            <div style="flex: 1; cursor: pointer;" onclick="openPropertyFromWell('${p.propertyId}')">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-weight: 500; color: ${isUnlinked ? '#9ca3af' : '#2563eb'};">${escapeHtml(p.location)}</span>
                                    ${p.group ? `<span style="font-size: 11px; padding: 2px 6px; background: #e0e7ff; color: #3730a3; border-radius: 4px;">${escapeHtml(p.group)}</span>` : ''}
                                    ${p.nma ? `<span style="font-size: 11px; padding: 2px 6px; background: #dcfce7; color: #166534; border-radius: 4px;">${parseFloat(p.nma.toFixed(4))} NMA</span>` : ''}
                                </div>
                                <div style="font-size: 12px; color: #6b7280;">${escapeHtml(p.county)}${p.acres && !p.nma ? ' • ' + p.acres + ' acres' : ''}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; ${getMatchReasonStyle(p.matchReason)}">${getMatchReasonLabel(p.matchReason)}</span>
                                ${isUnlinked
                                    ? `<span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #fef2f2; color: #991b1b;">Unlinked</span>
                                       <button onclick="event.stopPropagation(); relinkProperty('${p.linkId}')" title="Re-link this property${unlinkedDate ? ' (unlinked ' + unlinkedDate + ')' : ''}" style="font-size: 11px; padding: 2px 8px; border-radius: 4px; border: 1px solid #2563eb; background: #eff6ff; color: #2563eb; cursor: pointer;">Relink</button>`
                                    : `<button onclick="event.stopPropagation(); unlinkProperty('${p.linkId}')" title="Unlink this property" style="font-size: 11px; padding: 2px 8px; border-radius: 4px; border: 1px solid #d1d5db; background: #f9fafb; color: #6b7280; cursor: pointer;">Unlink</button>`
                                }
                            </div>
                        </div>`;
                    }).join('');
                    listEl.style.display = 'block';
                    emptyEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load linked properties:', error);
                countEl.textContent = '0';
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
            }
        }
        
        function openPropertyFromWell(propertyId) {
            // Check if we've hit max depth
            if (modalStack.length >= MAX_MODAL_DEPTH) {
                alert(`Maximum of ${MAX_MODAL_DEPTH} modals can be opened at once.`);
                return;
            }
            
            // Don't close the well modal - open property on top
            setTimeout(async () => {
                await openPropertyDetails(propertyId);
            }, 50);
        }
        
        async function unlinkProperty(linkId) {
            if (!confirm('Remove this property link?')) return;

            try {
                const response = await fetch(`/api/property-well-link/${linkId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    // Reload the linked properties list
                    const wellId = document.getElementById('wellDetailsId').value;
                    loadLinkedProperties(wellId);
                } else {
                    console.error('Failed to unlink property');
                }
            } catch (error) {
                console.error('Error unlinking property:', error);
            }
        }

        async function relinkProperty(linkId) {
            try {
                const response = await fetch(`/api/property-well-link/${linkId}`, {
                    method: 'PATCH',
                    credentials: 'include'
                });

                if (response.ok) {
                    const wellId = document.getElementById('wellDetailsId').value;
                    loadLinkedProperties(wellId);
                } else {
                    console.error('Failed to re-link property');
                }
            } catch (error) {
                console.error('Error re-linking property:', error);
            }
        }
        
        function openManualLinkProperty() {
            // Manual property linking to wells - feature coming soon
            showToast('Manual property linking coming soon', 'info');
        }

        // ── County Records ──────────────────────────────────────────────────

        // Beta: only show for specific organizations
        const COUNTY_RECORDS_ALLOWED_ORGS = ['rec9fYy8Xwl3jNAbf']; // Price Minerals

        function isCountyRecordsEnabled() {
            return currentUser && COUNTY_RECORDS_ALLOWED_ORGS.includes(currentUser.organizationId);
        }

        // Mode-based type filtering with exact normalized matching
        // Normalize: lowercase, & → and, strip all non-alphanumeric
        function normalizeType(type) {
            return (type || '').toLowerCase().replace(/&/g, 'and').replace(/[^a-z0-9]/g, '');
        }

        // Leases & Activity types
        const CR_LEASES_ACTIVITY = [
            'Oil & Gas Lease',
            'Memorandum Of Oil & Gas',
            'Memorandum of Lease',
            'Ratification',
            'Amendment O & G',
            'Assignment',
            'Partial Assignment',
            'Pooling',
            'Pooling Order',
            'Spacing',
        ].map(normalizeType);

        // Title Document types
        const CR_TITLE_DOCS = [
            'Mineral Deed',
            'Mineral & Royalty Deed',
            'Quit Claim Deed/ Mineral Interest',
            'Trustee Mineral Deed',
            'Warranty Deed',
            'Quit Claim Deed',
            'Deed & Conveyance',
            'Convey',
            'Affidavit of Heirship',
        ].map(normalizeType);

        // Always-hidden types
        const CR_BLACKLIST = [
            'SURFACE GRANT',
            'Final Decree',
            'Journal Entry',
            'CERTIFICATE',
            'CORR/WD',
            'Notice',
            'REPORT',
            'Subordination Agreement',
        ].map(normalizeType);

        // Filter mode: 'both', 'leases', or 'title'
        let crFilterMode = 'both';

        function isBlacklistedType(type) {
            return CR_BLACKLIST.includes(normalizeType(type));
        }

        // Used by the auto-fetch loop: keep anything in either mode list (not blacklisted)
        function isRelevantInstrumentType(type) {
            if (!type) return false;
            if (isBlacklistedType(type)) return false;
            const norm = normalizeType(type);
            return CR_LEASES_ACTIVITY.includes(norm) || CR_TITLE_DOCS.includes(norm);
        }

        // Used by the renderer: filter based on current mode
        function isVisibleInstrumentType(type) {
            if (!type) return false;
            if (isBlacklistedType(type)) return false;
            const norm = normalizeType(type);
            if (crFilterMode === 'leases') return CR_LEASES_ACTIVITY.includes(norm);
            if (crFilterMode === 'title') return CR_TITLE_DOCS.includes(norm);
            return CR_LEASES_ACTIVITY.includes(norm) || CR_TITLE_DOCS.includes(norm);
        }

        const countyRecordsState = {
            loaded: false,
            loading: false,
            allResults: [],
            currentPage: 0,
            totalResults: 0,
            totalPages: 0,
            county: '',
            section: '',
            township: '',
            range: '',
        };

        // State tracking for county record retrieval processing (mirrors OCC pattern)
        const crProcessingStates = {};
        const CR_POLL_INTERVAL = 5000;
        const CR_MAX_POLL_DURATION = 5 * 60 * 1000;
        const CR_MAX_PAGE_COUNT = 50;
        const CR_TARGET_RESULTS_PER_LOAD = 15;
        const CR_MAX_PAGES_PER_LOAD = 5;

        function resetCountyRecordsState() {
            // Stop any active polling
            for (const key in crProcessingStates) {
                if (crProcessingStates[key].pollInterval) {
                    clearInterval(crProcessingStates[key].pollInterval);
                }
                delete crProcessingStates[key];
            }

            countyRecordsState.loaded = false;
            countyRecordsState.loading = false;
            countyRecordsState.allResults = [];
            countyRecordsState.currentPage = 0;
            countyRecordsState.totalResults = 0;
            countyRecordsState.totalPages = 0;
            countyRecordsState.county = '';
            countyRecordsState.section = '';
            countyRecordsState.township = '';
            countyRecordsState.range = '';
            crFilterMode = 'both';
            updateCrModeToggle();
            const modeToggleEl = document.getElementById('county-records-mode-toggle');
            if (modeToggleEl) modeToggleEl.style.display = 'none';

            const countEl = document.getElementById('county-records-count');
            if (countEl) countEl.textContent = '\u2014';
            const listEl = document.getElementById('county-records-list');
            if (listEl) listEl.innerHTML = '';
            const emptyEl = document.getElementById('county-records-empty');
            if (emptyEl) emptyEl.style.display = 'none';
            const filtersEl = document.getElementById('county-records-filters');
            if (filtersEl) filtersEl.style.display = 'none';
            const paginationEl = document.getElementById('county-records-pagination');
            if (paginationEl) paginationEl.style.display = 'none';
            const contentEl = document.getElementById('county-records-content');
            if (contentEl) contentEl.style.display = 'none';
            const arrowEl = document.getElementById('county-records-arrow');
            if (arrowEl) arrowEl.style.transform = 'rotate(0deg)';
        }

        // Counties not covered by OKCountyRecords.com (use separate systems)
        const UNSUPPORTED_COUNTIES = [
            'caddo', 'canadian', 'cleveland', 'creek', 'garfield',
            'hughes', 'oklahoma', 'payne', 'rogers', 'tulsa',
            'wagoner', 'woods',
        ];

        function isCountySupported(county) {
            return !UNSUPPORTED_COUNTIES.includes((county || '').toLowerCase().replace(' county', '').trim());
        }

        function toggleCountyRecords() {
            const content = document.getElementById('county-records-content');
            const arrow = document.getElementById('county-records-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';

                // Lazy load on first expand
                if (!countyRecordsState.loaded && !countyRecordsState.loading) {
                    const propId = document.getElementById('propertyDetailsId').value;
                    const prop = loadedProperties.find(p => p.id === propId);
                    if (prop) {
                        const f = prop.fields;
                        if (!f['COUNTY'] || !f.SEC || !f.TWN || !f.RNG) {
                            document.getElementById('county-records-list').innerHTML =
                                '<div style="color: #6b7280; font-size: 13px; font-style: italic; padding: 12px 0;">County, section, township, and range are required to search county records</div>';
                            return;
                        }
                        if (!isCountySupported(f['COUNTY'])) {
                            document.getElementById('county-records-list').innerHTML =
                                `<div style="color: #6b7280; font-size: 13px; padding: 12px 0;"><strong>${escapeHtml(f['COUNTY'])} County</strong> is not available through our county records provider. This county uses a separate recording system.</div>`;
                            document.getElementById('county-records-list').style.display = 'block';
                            document.getElementById('county-records-count').textContent = '—';
                            return;
                        }
                        loadCountyRecords(f['COUNTY'], f.SEC, f.TWN, f.RNG, 1);
                    }
                }
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        async function loadCountyRecords(county, section, township, range, startPage) {
            countyRecordsState.loading = true;
            countyRecordsState.county = county;
            countyRecordsState.section = section;
            countyRecordsState.township = township;
            countyRecordsState.range = range;

            const listEl = document.getElementById('county-records-list');
            const emptyEl = document.getElementById('county-records-empty');
            const loadMoreBtn = document.getElementById('county-records-load-more');

            if (startPage === 1) {
                listEl.innerHTML = '<div style="padding: 12px; color: #6b7280;">Searching county records...</div>';
                emptyEl.style.display = 'none';
            } else if (loadMoreBtn) {
                loadMoreBtn.textContent = 'Loading...';
                loadMoreBtn.disabled = true;
            }

            try {
                const prevCount = startPage === 1 ? 0 : countyRecordsState.allResults.length;
                let currentPage = startPage;
                let pagesLoaded = 0;

                // Fetch pages until we have enough relevant results or hit limits
                while (pagesLoaded < CR_MAX_PAGES_PER_LOAD) {
                    const response = await fetch('/api/county-records/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ county, section, township, range, page: currentPage }),
                    });

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(err.error || 'Search failed');
                    }

                    const data = await response.json();
                    countyRecordsState.currentPage = data.page || currentPage;
                    countyRecordsState.totalPages = data.total_pages || 1;

                    const relevantResults = (data.results || []).filter(r => isRelevantInstrumentType(r.instrument_type));

                    if (startPage === 1 && pagesLoaded === 0) {
                        countyRecordsState.allResults = relevantResults;
                    } else {
                        countyRecordsState.allResults = countyRecordsState.allResults.concat(relevantResults);
                    }

                    pagesLoaded++;
                    currentPage++;

                    // Stop if we have enough new relevant results
                    const newCount = countyRecordsState.allResults.length - prevCount;
                    if (newCount >= CR_TARGET_RESULTS_PER_LOAD) break;

                    // Stop if no more pages
                    if (currentPage > countyRecordsState.totalPages) break;
                }

                countyRecordsState.totalResults = countyRecordsState.allResults.length;
                countyRecordsState.loaded = true;

                // Update count badge with visible results count
                const visibleCount = countyRecordsState.allResults.filter(r => isVisibleInstrumentType(r.instrument_type)).length;
                document.getElementById('county-records-count').textContent = String(visibleCount);

                renderCountyRecords();
                updateCountyRecordsTypeFilter();
            } catch (error) {
                console.error('[CountyRecords] Search error:', error);
                if (startPage === 1) {
                    listEl.innerHTML = '<div style="padding: 12px; color: #dc2626;">Failed to search county records. Please try again.</div>';
                } else {
                    showToast('Failed to load more results', 'error');
                }
            } finally {
                countyRecordsState.loading = false;
                if (loadMoreBtn) {
                    loadMoreBtn.textContent = 'Load More';
                    loadMoreBtn.disabled = false;
                }
            }
        }

        function updateCountyRecordsTypeFilter() {
            const select = document.getElementById('county-records-type-filter');
            const types = new Set();
            for (const r of countyRecordsState.allResults) {
                if (r.instrument_type && isVisibleInstrumentType(r.instrument_type)) {
                    types.add(r.instrument_type);
                }
            }
            const currentVal = select.value;
            select.innerHTML = '<option value="">All Types</option>';
            Array.from(types).sort().forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                select.appendChild(opt);
            });
            select.value = currentVal;
        }

        function getFilteredCountyRecords() {
            // First filter by visibility tier (whitelist, or whitelist+graylist if toggled)
            let results = countyRecordsState.allResults.filter(r => isVisibleInstrumentType(r.instrument_type));

            const typeFilter = document.getElementById('county-records-type-filter').value;
            const dateFrom = document.getElementById('county-records-date-from').value;
            const dateTo = document.getElementById('county-records-date-to').value;

            if (typeFilter) {
                results = results.filter(r => r.instrument_type === typeFilter);
            }
            if (dateFrom) {
                results = results.filter(r => r.instrument_date && r.instrument_date >= dateFrom);
            }
            if (dateTo) {
                results = results.filter(r => r.instrument_date && r.instrument_date <= dateTo);
            }
            return results;
        }

        function filterCountyRecords() {
            renderCountyRecords();
        }

        function clearCountyRecordsFilters() {
            document.getElementById('county-records-type-filter').value = '';
            document.getElementById('county-records-date-from').value = '';
            document.getElementById('county-records-date-to').value = '';
            renderCountyRecords();
        }

        function setCrFilterMode(mode) {
            crFilterMode = mode;
            updateCrModeToggle();
            // Update count badge to reflect visible results
            const visibleCount = countyRecordsState.allResults.filter(r => isVisibleInstrumentType(r.instrument_type)).length;
            document.getElementById('county-records-count').textContent = String(visibleCount);
            updateCountyRecordsTypeFilter();
            renderCountyRecords();
        }

        function updateCrModeToggle() {
            ['both', 'leases', 'title'].forEach(m => {
                const btn = document.getElementById('cr-mode-' + m);
                if (btn) {
                    btn.style.background = m === crFilterMode ? '#374151' : 'white';
                    btn.style.color = m === crFilterMode ? 'white' : '#374151';
                }
            });
        }

        function renderCountyRecords() {
            const listEl = document.getElementById('county-records-list');
            const emptyEl = document.getElementById('county-records-empty');
            const filtersEl = document.getElementById('county-records-filters');
            const paginationEl = document.getElementById('county-records-pagination');
            const showingEl = document.getElementById('county-records-showing');
            const loadMoreBtn = document.getElementById('county-records-load-more');

            const filtered = getFilteredCountyRecords();

            if (countyRecordsState.allResults.length === 0) {
                listEl.innerHTML = '';
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
                filtersEl.style.display = 'none';
                paginationEl.style.display = 'none';
                return;
            }

            // Show filters when we have results
            filtersEl.style.display = 'flex';

            // Show mode toggle when we have results
            const modeToggle = document.getElementById('county-records-mode-toggle');
            if (modeToggle) modeToggle.style.display = 'block';

            if (filtered.length === 0) {
                listEl.innerHTML = '<div style="padding: 12px; color: #6b7280; font-style: italic;">No records match the current filters</div>';
                listEl.style.display = 'block';
                emptyEl.style.display = 'none';
                paginationEl.style.display = 'none';
                return;
            }

            listEl.innerHTML = filtered.map(r => renderCountyRecordItem(r)).join('');
            listEl.style.display = 'block';
            emptyEl.style.display = 'none';

            // Start polling for any records still processing
            for (const r of filtered) {
                if (r.in_library && r.document_id && r.doc_status && r.doc_status !== 'complete' && r.doc_status !== 'processed') {
                    const sanitized = (r.number || '').replace(/[^a-zA-Z0-9]/g, '-');
                    const container = document.getElementById('cr-action-' + sanitized);
                    if (container && !crProcessingStates[r.number]) {
                        const btn = container.querySelector('button');
                        crProcessingStates[r.number] = {
                            status: 'processing',
                            documentId: r.document_id,
                            buttonEl: btn,
                            pollStartTime: Date.now()
                        };
                        startCrDocumentPolling(r.number, r.document_id);
                    }
                }
            }

            // Pagination
            const hasMore = countyRecordsState.currentPage < countyRecordsState.totalPages;
            const filterNote = filtered.length !== countyRecordsState.allResults.length
                ? ` (${filtered.length} matching filter)` : '';
            paginationEl.style.display = 'block';
            if (hasMore) {
                showingEl.textContent = `${countyRecordsState.totalResults} records loaded${filterNote}`;
                loadMoreBtn.style.display = 'inline-block';
            } else {
                showingEl.textContent = `${countyRecordsState.totalResults} records${filterNote}`;
                loadMoreBtn.style.display = 'none';
            }
        }

        function renderCountyRecordItem(record) {
            const sanitizedNumber = (record.number || '').replace(/[^a-zA-Z0-9]/g, '-');
            const containerId = 'cr-action-' + sanitizedNumber;
            const date = record.instrument_date
                ? new Date(record.instrument_date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                : '';
            const grantorStr = (record.grantors || []).slice(0, 2).join(', ');
            const granteeStr = (record.grantees || []).slice(0, 2).join(', ');
            const partiesHtml = grantorStr && granteeStr
                ? `<span style="color: #374151;">${escapeHtml(grantorStr)}</span> <span style="color: #9ca3af;">\u2192</span> <span style="color: #374151;">${escapeHtml(granteeStr)}</span>`
                : grantorStr ? escapeHtml(grantorStr) : granteeStr ? escapeHtml(granteeStr) : '';
            const pages = record.page_count ? `${record.page_count} pg` : '';

            let actionHtml;
            if (record.in_library && record.document_id) {
                if (record.doc_status === 'complete' || record.doc_status === 'processed') {
                    actionHtml = `<button class="occ-process-btn complete" onclick="event.stopPropagation(); openDocumentDetail('${record.document_id}')" title="View analyzed document">Analyzed</button>`;
                } else {
                    actionHtml = `<button class="occ-process-btn processing" disabled title="Document is being processed"><span class="spinner-sm"></span> Processing...</button>`;
                }
            } else if (record.in_library) {
                actionHtml = `<button class="occ-process-btn complete" disabled title="In library">Analyzed</button>`;
            } else {
                const recPageCount = record.page_count || (record.images || []).length || 0;
                if (recPageCount > CR_MAX_PAGE_COUNT) {
                    actionHtml = `<button class="occ-process-btn" disabled style="opacity: 0.5; cursor: not-allowed;" title="Documents over ${CR_MAX_PAGE_COUNT} pages are not supported">${recPageCount} pg</button>`;
                } else {
                    actionHtml = `<button class="occ-process-btn" onclick="event.stopPropagation(); retrieveCountyRecordByNumber('${escapeHtml(record.number)}')" title="5 credits">Retrieve</button>`;
                }
            }

            // Type badge color
            const typeLower = (record.instrument_type || '').toLowerCase();
            let badgeBg = '#e5e7eb'; let badgeColor = '#374151';
            if (typeLower.includes('deed') || typeLower.includes('conveyance')) { badgeBg = '#dbeafe'; badgeColor = '#1e40af'; }
            else if (typeLower.includes('mortgage') || typeLower.includes('lien')) { badgeBg = '#fef3c7'; badgeColor = '#92400e'; }
            else if (typeLower.includes('lease') || typeLower.includes('assignment')) { badgeBg = '#d1fae5'; badgeColor = '#065f46'; }
            else if (typeLower.includes('order') || typeLower.includes('judgment')) { badgeBg = '#ede9fe'; badgeColor = '#5b21b6'; }

            return `
                <div style="padding: 10px 0; border-bottom: 1px solid #f3f4f6;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-bottom: 3px;">
                                <span style="font-size: 11px; padding: 1px 6px; border-radius: 3px; background: ${badgeBg}; color: ${badgeColor}; white-space: nowrap;">${escapeHtml(record.instrument_type || 'Unknown')}</span>
                                ${date ? `<span style="font-size: 12px; color: #6b7280;">${date}</span>` : ''}
                                ${pages ? `<span style="font-size: 11px; color: #9ca3af;">${pages}</span>` : ''}
                            </div>
                            ${partiesHtml ? `<div style="font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${partiesHtml}</div>` : ''}
                        </div>
                        <div id="${containerId}" style="flex-shrink: 0;">${actionHtml}</div>
                    </div>
                </div>`;
        }

        function loadMoreCountyRecords() {
            if (countyRecordsState.loading) return;
            const nextPage = countyRecordsState.currentPage + 1;
            if (nextPage > countyRecordsState.totalPages) return;
            loadCountyRecords(
                countyRecordsState.county,
                countyRecordsState.section,
                countyRecordsState.township,
                countyRecordsState.range,
                nextPage
            );
        }

        async function retrieveCountyRecordByNumber(instrumentNumber) {
            const record = countyRecordsState.allResults.find(r => r.number === instrumentNumber);
            if (!record) {
                showToast('Record not found', 'error');
                return;
            }

            const pageCount = record.page_count || (record.images || []).length || 0;

            // Block documents over the page limit
            if (pageCount > CR_MAX_PAGE_COUNT) {
                showConfirm(
                    `<div style="text-align: left; font-size: 14px; line-height: 1.6;">` +
                    `<div style="margin-bottom: 8px;"><strong>${escapeHtml(record.instrument_type || 'Document')}</strong></div>` +
                    `<div style="margin-bottom: 12px; color: #6b7280;">${escapeHtml(record.number)} &bull; ${pageCount} pages</div>` +
                    `<div style="color: #b91c1c; margin-bottom: 8px;">Documents over ${CR_MAX_PAGE_COUNT} pages are not currently supported for automated retrieval and extraction.</div>` +
                    `<div style="font-size: 12px; color: #6b7280;">Large documents may contain multiple instruments or extensive exhibits. Support for larger documents may be added in a future update.</div>` +
                    `</div>`,
                    { title: 'Document Too Large', confirmText: 'OK', cancelText: null }
                );
                return;
            }

            // Check "don't show again" preference
            const skipConfirm = localStorage.getItem('cr_skip_confirm') === 'true';

            if (!skipConfirm) {
                let body = `<div style="text-align: left; font-size: 14px; line-height: 1.6;">`;
                body += `<div style="margin-bottom: 8px;"><strong>${escapeHtml(record.instrument_type || 'Document')}</strong></div>`;
                body += `<div style="margin-bottom: 12px; color: #6b7280;">${escapeHtml(record.number)} &bull; ${pageCount} page${pageCount !== 1 ? 's' : ''}</div>`;
                body += `<div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px 12px; margin-bottom: 12px;">`;
                body += `<div style="display: flex; justify-content: space-between;"><span>Retrieval + extraction</span><span style="font-weight: 600;">5 credits</span></div>`;
                body += `</div>`;
                body += `<div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">The original document will be available for viewing and download with a county clerk watermark.</div>`;
                body += `<div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">If this is a multi-document instrument, each additional document contained within will be extracted separately and charged 1 additional credit.</div>`;
                body += `<div style="font-size: 12px; color: #6b7280; margin-bottom: 12px;">Feel free to leave the page — your document will appear in the Documents tab when processing is complete.</div>`;
                body += `<label style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: #6b7280; cursor: pointer;"><input type="checkbox" id="cr-skip-confirm-checkbox" style="cursor: pointer;"> Don't show this again</label>`;
                body += `</div>`;

                const confirmed = await showConfirm(body, {
                    title: 'Retrieve County Record',
                    confirmText: 'Retrieve (5 credits)',
                    cancelText: 'Cancel',
                });

                if (!confirmed) return;

                // Save preference if checked
                const skipCheckbox = document.getElementById('cr-skip-confirm-checkbox');
                if (skipCheckbox && skipCheckbox.checked) {
                    localStorage.setItem('cr_skip_confirm', 'true');
                }
            }

            retrieveCountyRecord(record.county, record.number, record.images || [], record.instrument_type || '');
        }

        async function retrieveCountyRecord(county, instrumentNumber, images, instrumentType) {
            const sanitized = instrumentNumber.replace(/[^a-zA-Z0-9]/g, '-');
            const containerId = 'cr-action-' + sanitized;
            const container = document.getElementById(containerId);

            // Track state and show fetching
            crProcessingStates[instrumentNumber] = { status: 'fetching' };
            updateCrButtonState(container, 'fetching', null, instrumentNumber);

            try {
                const response = await fetch('/api/county-records/retrieve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        county,
                        instrument_number: instrumentNumber,
                        images,
                        instrument_type: instrumentType,
                    }),
                });

                const data = await response.json();

                if (data.status === 'processing') {
                    crProcessingStates[instrumentNumber].status = 'processing';
                    updateCrButtonState(container, 'processing', null, instrumentNumber);
                    showToast('Document is being processed. Check back shortly.', 'info');
                    return;
                }

                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Retrieval failed');
                }

                // Success — update the record in state
                const record = countyRecordsState.allResults.find(r => r.number === instrumentNumber);
                if (record) {
                    record.in_library = true;
                    record.retrieve_credits = 0;
                    record.document_id = data.document_id;
                }

                showToast(`Document retrieved! ${data.credits_charged || 5} credits used.`, 'success');
                if (typeof loadUsageStats === 'function') loadUsageStats();

                // Check actual document status — it may still be processing
                if (data.document_id) {
                    try {
                        const docRes = await fetch(`/api/documents/${data.document_id}`, { credentials: 'include' });
                        const docData = docRes.ok ? await docRes.json() : null;
                        const actualStatus = docData?.document?.status || 'processing';

                        if (record) record.doc_status = actualStatus;

                        if (actualStatus === 'complete' || actualStatus === 'processed') {
                            crProcessingStates[instrumentNumber] = { status: 'complete', documentId: data.document_id };
                            updateCrButtonState(container, 'complete', data.document_id, instrumentNumber);
                        } else {
                            // Still processing — show Processing and start polling
                            crProcessingStates[instrumentNumber] = {
                                status: 'processing',
                                documentId: data.document_id,
                                pollStartTime: Date.now(),
                            };
                            updateCrButtonState(container, 'processing', null, instrumentNumber);
                            startCrDocumentPolling(instrumentNumber, data.document_id);
                        }
                    } catch (e) {
                        // Fallback: assume complete
                        if (record) record.doc_status = 'complete';
                        crProcessingStates[instrumentNumber] = { status: 'complete', documentId: data.document_id };
                        updateCrButtonState(container, 'complete', data.document_id, instrumentNumber);
                    }
                }

            } catch (error) {
                console.error('[CountyRecords] Retrieve error:', error);
                showToast(error.message || 'Failed to retrieve document', 'error');
                crProcessingStates[instrumentNumber] = { status: 'error' };
                updateCrButtonState(container, 'error', null, instrumentNumber);
            }
        }

        function updateCrButtonState(container, state, documentId, instrumentNumber) {
            if (!container) return;

            switch (state) {
                case 'fetching':
                    container.innerHTML = `<button class="occ-process-btn fetching" disabled title="Retrieving document..."><span class="spinner-sm"></span> Retrieving...</button>`;
                    break;
                case 'processing':
                    container.innerHTML = `<button class="occ-process-btn processing" disabled title="Processing document..."><span class="spinner-sm"></span> Processing...</button>`;
                    break;
                case 'complete':
                    if (documentId) {
                        container.innerHTML = `<button class="occ-process-btn complete" onclick="event.stopPropagation(); openDocumentDetail('${documentId}')" title="View analyzed document">Analyzed</button>`;
                    } else {
                        container.innerHTML = `<button class="occ-process-btn complete" disabled title="In library">Analyzed</button>`;
                    }
                    break;
                case 'error':
                    container.innerHTML = `<button class="occ-process-btn error" onclick="event.stopPropagation(); retrieveCountyRecordByNumber('${escapeHtml(instrumentNumber)}')" title="Click to retry">Retry</button>`;
                    break;
                default:
                    container.innerHTML = `<button class="occ-process-btn" onclick="event.stopPropagation(); retrieveCountyRecordByNumber('${escapeHtml(instrumentNumber)}')" title="5 credits">Retrieve</button>`;
            }

            // Update state tracking with new button reference
            if (instrumentNumber && crProcessingStates[instrumentNumber]) {
                crProcessingStates[instrumentNumber].buttonEl = container.querySelector('button');
            }
        }

        function startCrDocumentPolling(instrumentNumber, documentId) {
            const state = crProcessingStates[instrumentNumber];
            if (!state || state.pollInterval) return;

            console.log(`[CountyRecords Poll] Starting polling for ${documentId}`);
            const sanitized = instrumentNumber.replace(/[^a-zA-Z0-9]/g, '-');
            const containerId = 'cr-action-' + sanitized;

            state.pollInterval = setInterval(async () => {
                const currentState = crProcessingStates[instrumentNumber];
                if (!currentState) {
                    clearInterval(state.pollInterval);
                    return;
                }

                if (Date.now() - currentState.pollStartTime > CR_MAX_POLL_DURATION) {
                    console.log(`[CountyRecords Poll] Max duration exceeded for ${documentId}`);
                    clearInterval(currentState.pollInterval);
                    currentState.pollInterval = null;
                    return;
                }

                try {
                    const response = await fetch(`/api/documents/${documentId}`, { credentials: 'include' });
                    if (!response.ok) return;

                    const data = await response.json();
                    const doc = data.document;
                    if (!doc) return;

                    console.log(`[CountyRecords Poll] Document ${documentId} status: ${doc.status}`);
                    const container = document.getElementById(containerId);

                    if (doc.status === 'complete' || doc.status === 'processed') {
                        clearInterval(currentState.pollInterval);
                        currentState.pollInterval = null;
                        currentState.status = 'complete';

                        const record = countyRecordsState.allResults.find(r => r.number === instrumentNumber);
                        if (record) {
                            record.doc_status = 'complete';
                        }

                        updateCrButtonState(container, 'complete', documentId, instrumentNumber);
                        showToast('Document analysis complete!', 'success');
                        if (typeof loadUsageStats === 'function') loadUsageStats();
                    } else if (doc.status === 'processing' && currentState.status !== 'processing') {
                        currentState.status = 'processing';
                        updateCrButtonState(container, 'processing', null, instrumentNumber);
                    } else if (doc.status === 'error' || doc.status === 'failed') {
                        clearInterval(currentState.pollInterval);
                        currentState.pollInterval = null;
                        currentState.status = 'error';
                        updateCrButtonState(container, 'error', null, instrumentNumber);
                        showToast('Document processing failed', 'error');
                    }
                } catch (err) {
                    console.error(`[CountyRecords Poll] Error polling ${documentId}:`, err);
                }
            }, CR_POLL_INTERVAL);
        }

/* __SPLIT_PROPS_D__ */
        async function savePropertyDetails() {
            const propId = document.getElementById('propertyDetailsId').value;
            const notes = document.getElementById('propertyDetailsNotes').value;
            const meridian = document.getElementById('propertyDetailsMeridian').value;
            const riAcres = parseFloat(document.getElementById('propertyDetailsRIAcres').value) || 0;
            const wiAcres = parseFloat(document.getElementById('propertyDetailsWIAcres').value) || 0;
            
            try {
                const res = await fetch('/api/properties/' + propId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes, meridian, riAcres, wiAcres })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const prop = loadedProperties.find(p => p.id === propId);
                if (prop) {
                    prop.fields['Notes'] = notes;
                    prop.fields['MERIDIAN'] = meridian;
                    prop.fields['RI Acres'] = riAcres;
                    prop.fields['WI Acres'] = wiAcres;
                }
                
                showToast('Changes saved!', 'success');
                closePropertyDetailsModal();
                await loadProperties();
            } catch (err) {
                showToast('Error saving changes', 'error');
            }
        }
        
        async function savePropertyAndClose() {
            const propId = document.getElementById('propertyDetailsId').value;
            const notes = document.getElementById('propertyDetailsNotes').value;
            const meridian = document.getElementById('propertyDetailsMeridian').value;
            const riAcres = parseFloat(document.getElementById('propertyDetailsRIAcres').value) || 0;
            const wiAcres = parseFloat(document.getElementById('propertyDetailsWIAcres').value) || 0;

            // Read enterprise field values from inputs (if they exist)
            const getEnterpriseVal = (id) => {
                const el = document.getElementById('propEnterprise_' + id);
                return el ? (el.value !== '' ? el.value : null) : undefined;
            };
            const enterpriseBody = {};
            const riDec = getEnterpriseVal('riDecimal');
            const wiDec = getEnterpriseVal('wiDecimal');
            const orriA = getEnterpriseVal('orriAcres');
            const orriD = getEnterpriseVal('orriDecimal');
            const miA = getEnterpriseVal('miAcres');
            const miD = getEnterpriseVal('miDecimal');
            if (riDec !== undefined) enterpriseBody.riDecimal = riDec;
            if (wiDec !== undefined) enterpriseBody.wiDecimal = wiDec;
            if (orriA !== undefined) enterpriseBody.orriAcres = orriA;
            if (orriD !== undefined) enterpriseBody.orriDecimal = orriD;
            if (miA !== undefined) enterpriseBody.miAcres = miA;
            if (miD !== undefined) enterpriseBody.miDecimal = miD;

            // Validate decimal fields are in range 0-1
            const decimalChecks = [
                { val: riDec, label: 'RI Decimal' },
                { val: wiDec, label: 'WI Decimal' },
                { val: orriD, label: 'ORRI Decimal' },
                { val: miD, label: 'MI Decimal' }
            ];
            for (const chk of decimalChecks) {
                if (chk.val !== null && chk.val !== undefined) {
                    const num = parseFloat(chk.val);
                    if (isNaN(num) || num < 0 || num > 1) {
                        showToast(chk.label + ' must be between 0 and 1', 'error');
                        return;
                    }
                }
            }

            if (!propId) {
                showToast('Error: Property ID not found', 'error');
                return;
            }

            try {
                const res = await fetch('/api/properties/' + propId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes, meridian, riAcres, wiAcres, ...enterpriseBody })
                });

                if (!res.ok) throw new Error('Failed to save');

                // Update local data
                const prop = loadedProperties.find(p => p.id === propId);
                if (prop) {
                    prop.fields['Notes'] = notes;
                    prop.fields['MERIDIAN'] = meridian;
                    prop.fields['RI Acres'] = riAcres;
                    prop.fields['WI Acres'] = wiAcres;
                    // Update enterprise fields in cache
                    if (riDec !== undefined) prop.fields.ri_decimal = riDec ? parseFloat(riDec) : null;
                    if (wiDec !== undefined) prop.fields.wi_decimal = wiDec ? parseFloat(wiDec) : null;
                    if (orriA !== undefined) prop.fields.orri_acres = orriA ? parseFloat(orriA) : null;
                    if (orriD !== undefined) prop.fields.orri_decimal = orriD ? parseFloat(orriD) : null;
                    if (miA !== undefined) prop.fields.mi_acres = miA ? parseFloat(miA) : null;
                    if (miD !== undefined) prop.fields.mi_decimal = miD ? parseFloat(miD) : null;
                }
                
                // Close modal immediately after successful save
                closePropertyDetailsModal();
                
                // Show success toast after modal closes and reload properties
                setTimeout(() => {
                    showToast('Changes saved!', 'success');
                    loadProperties();
                }, 100);
            } catch (err) {
                console.error('Save property error:', err);
                showToast('Error saving changes', 'error');
                // Don't close modal if there was an error
            }
        }
        
        function closePropertyDetailsModal() {
            resetCountyRecordsState();
            const modal = document.getElementById('propertyDetailsModal');
            modal.style = '';
            // Reset z-index for next time
            modal.style.zIndex = '';
            
            // Remove from modal stack
            const index = modalStack.findIndex(m => m.element === modal);
            if (index > -1) {
                modalStack.splice(index, 1);
            }
        }
        
        document.getElementById('propertyDetailsModal').addEventListener('click', e => {
            if (e.target.id === 'propertyDetailsModal') closePropertyDetailsModal();
        });
