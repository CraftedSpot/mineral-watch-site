        let currentUser; // Set by checkAuth() in shared-auth.txt

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // =============================================
        // PAGE INITIALIZATION
        // =============================================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Auth: impersonation must run BEFORE any fetch calls
                const actAs = setupImpersonation();
                currentUser = await checkAuth();
                if (!currentUser) return;
                if (actAs) await loadImpersonationBanner(actAs);

                // Load all intelligence data in one request
                loadIntelligenceData();

            } catch (error) {
                console.error('Intelligence page init error:', error);
            }
        });

        // =============================================
        // COMBINED DATA LOADER
        // =============================================
        async function loadIntelligenceData() {
            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 15000);

                const response = await fetch('/api/intelligence/data', {
                    credentials: 'include',
                    signal: controller.signal
                });

                if (!response.ok) {
                    console.error('Intelligence API error:', response.status);
                    setSummaryError();
                    renderInsightsFallback();
                    return;
                }

                const data = await response.json();
                renderSummaryCards(data.summary);
                renderInsights(data.insights || []);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Intelligence request timed out');
                } else {
                    console.error('Failed to load intelligence data:', error);
                }
                setSummaryError();
                renderInsightsFallback();
            }
        }

        function renderSummaryCards(data) {
            // Remove skeleton loading animation
            document.getElementById('summaryCardsContainer')?.classList.remove('skeleton-loading');

            // Active Wells
            document.getElementById('summaryActiveWells').textContent = data.activeWells ?? '—';
            const wellsDetail = document.getElementById('summaryWellsDetail');
            if (data.countyCount) {
                wellsDetail.textContent = `Across ${data.countyCount} counties`;
            } else {
                wellsDetail.textContent = 'No well data yet';
            }

            // Estimated Monthly Revenue
            if (data.estimatedRevenue !== null && data.estimatedRevenue !== undefined) {
                document.getElementById('summaryRevenue').textContent = formatCurrency(data.estimatedRevenue);
                const revDetail = document.getElementById('summaryRevenueDetail');
                if (data.revenueWellCount && data.totalWells) {
                    revDetail.textContent = `Based on ${data.revenueWellCount} of ${data.totalWells} wells with data`;
                    revDetail.className = 'summary-detail neutral';
                } else if (data.revenueChange !== null && data.revenueChange !== undefined) {
                    const sign = data.revenueChange >= 0 ? '+' : '';
                    revDetail.textContent = `${sign}${data.revenueChange.toFixed(1)}% from prior month`;
                    revDetail.className = `summary-detail ${data.revenueChange >= 0 ? 'success' : 'alert'}`;
                } else {
                    revDetail.textContent = 'Based on available data';
                    revDetail.className = 'summary-detail neutral';
                }
            } else {
                document.getElementById('summaryRevenue').textContent = '—';
                const revDetail = document.getElementById('summaryRevenueDetail');
                if (data.totalWells > 0) {
                    revDetail.textContent = 'Add decimal interests or check stubs';
                } else {
                    revDetail.textContent = 'No revenue data yet';
                }
            }

            // Deduction Health - neutral presentation
            if (data.deductionFlags !== null && data.deductionFlags !== undefined) {
                const analyzedText = data.wellsAnalyzed ? `${data.wellsAnalyzed} wells analyzed` : '';
                if (data.deductionFlags > 0) {
                    document.getElementById('summaryDeductions').textContent = `${data.deductionFlags} High`;
                    const dedDetail = document.getElementById('summaryDeductionsDetail');
                    dedDetail.textContent = analyzedText || 'Wells with high deductions';
                    dedDetail.className = 'summary-detail neutral';
                } else {
                    document.getElementById('summaryDeductions').textContent = '0 High';
                    const dedDetail = document.getElementById('summaryDeductionsDetail');
                    dedDetail.textContent = analyzedText || 'No high deduction wells';
                    dedDetail.className = 'summary-detail neutral';
                }
            } else {
                document.getElementById('summaryDeductions').textContent = '—';
                document.getElementById('summaryDeductionsDetail').textContent = 'No deduction data yet';
            }

            // Action Items — count is set by renderInsights() after insights load
        }

        function setSummaryError() {
            // Remove skeleton loading animation
            document.getElementById('summaryCardsContainer')?.classList.remove('skeleton-loading');

            document.getElementById('summaryActiveWells').textContent = '—';
            document.getElementById('summaryWellsDetail').textContent = 'Could not load';
            document.getElementById('summaryRevenue').textContent = '—';
            document.getElementById('summaryRevenueDetail').textContent = 'Could not load';
            document.getElementById('summaryDeductions').textContent = '—';
            document.getElementById('summaryDeductionsDetail').textContent = 'Could not load';
            // Action Items count is owned by renderInsights() — don't overwrite here
        }

        function formatCurrency(amount) {
            if (amount >= 10000) {
                return '$' + (amount / 1000).toFixed(1) + 'K';
            }
            return '$' + amount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
