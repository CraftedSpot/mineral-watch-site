        // =============================================
        // OPERATOR DIRECTORY
        // =============================================

        let currentPage = 0;
        let pageSize = 100;
        let totalCount = 0;
        let currentOperators = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            setupUser();
            setupEventListeners();
            await loadOperators();
        });

        // Setup user info and logout
        function setupUser() {
            fetch('/api/user')
                .then(r => r.json())
                .then(data => {
                    if (data.user) {
                        document.getElementById('userName').textContent = data.user.name || data.user.email;
                        if (data.user.email === 'james@mymineralwatch.com') {
                            const menu = document.querySelector('.user-menu');
                            if (menu) {
                                const btn = document.createElement('a');
                                btn.href = '/portal/marketing';
                                btn.textContent = 'Marketing';
                                btn.style.cssText = 'background:rgba(139,92,246,0.15);color:#a78bfa;border:1px solid rgba(139,92,246,0.3);padding:6px 14px;border-radius:4px;font-size:12px;font-weight:600;text-decoration:none;letter-spacing:0.3px;';
                                menu.insertBefore(btn, menu.firstChild);
                            }
                        }
                    }
                })
                .catch(() => {});

            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/portal/login';
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search with debounce
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 0;
                    loadOperators();
                }, 300);
            });

            // Sort change
            document.getElementById('sortSelect').addEventListener('change', () => {
                currentPage = 0;
                loadOperators();
            });

            // Min wells change
            document.getElementById('minWellsSelect').addEventListener('change', () => {
                currentPage = 0;
                loadOperators();
            });

            // Pagination
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentPage > 0) {
                    currentPage--;
                    loadOperators();
                }
            });

            document.getElementById('nextBtn').addEventListener('click', () => {
                if ((currentPage + 1) * pageSize < totalCount) {
                    currentPage++;
                    loadOperators();
                }
            });

            // Close modal on overlay click
            document.getElementById('operatorModal').addEventListener('click', (e) => {
                if (e.target.id === 'operatorModal') {
                    closeOperatorModal();
                }
            });

            // ESC key closes modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeOperatorModal();
                }
            });
        }

        // Load operators from API
        async function loadOperators() {
            const search = document.getElementById('searchInput').value.trim();
            const sort = document.getElementById('sortSelect').value;
            const minWells = document.getElementById('minWellsSelect').value;

            const params = new URLSearchParams({
                sort,
                min_wells: minWells,
                limit: pageSize.toString(),
                offset: (currentPage * pageSize).toString()
            });

            if (search) {
                params.set('search', search);
            }

            showTableLoading();

            try {
                const response = await fetch(`/api/operators/directory?${params}`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to load operators');
                }

                const data = await response.json();
                currentOperators = data.operators;
                totalCount = data.total_count;

                updateHeroStats(data);
                renderOperatorsTable(data.operators);
                updatePagination(data.pagination);
                updateResultCount(data.operators.length, totalCount, search);

            } catch (error) {
                showToast(error.message, 'error');
                showTableError(error.message);
            }
        }

        // Update hero stats
        function updateHeroStats(data) {
            document.getElementById('statOperatorCount').textContent = formatNumber(data.total_count);

            if (data.statewide) {
                document.getElementById('statStatewideDed').textContent = data.statewide.deduction_ratio + '%';
                document.getElementById('statStatewideNGL').textContent =
                    data.statewide.ngl_recovery_ratio != null
                        ? data.statewide.ngl_recovery_ratio + '%'
                        : '—';
            }
        }

        // Render operators table
        function renderOperatorsTable(operators) {
            const tbody = document.getElementById('operatorsTableBody');

            if (!operators || operators.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="6">No operators found matching your criteria</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = operators.map(op => `
                <tr data-operator="${escapeHtml(op.operator_number)}">
                    <td class="col-name">
                        <div class="operator-name">${escapeHtml(op.operator_name)}</div>
                        <div class="operator-number">#${escapeHtml(op.operator_number)}</div>
                    </td>
                    <td class="col-wells">${formatNumber(op.well_count)}</td>
                    <td class="col-gross">${formatCurrency(op.total_gross)}</td>
                    <td class="col-deduction">
                        <span class="metric-badge ${getDeductionClass(op.deduction_ratio)}">${op.deduction_ratio}%</span>
                    </td>
                    <td class="col-ngl">
                        ${op.ngl_recovery_ratio != null
                            ? `<span class="metric-badge ${getNGLClass(op.ngl_recovery_ratio)}">${op.ngl_recovery_ratio}%</span>`
                            : '<span class="metric-badge neutral">N/A</span>'}
                    </td>
                    <td class="col-actions">
                        <button class="btn-detail" onclick="openOperatorDetail('${escapeHtml(op.operator_number)}')" title="View Details">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Get CSS class for deduction ratio
        function getDeductionClass(ratio) {
            if (ratio >= 30) return 'high';
            if (ratio >= 15) return 'medium';
            return 'low';
        }

        // Get CSS class for NGL recovery
        function getNGLClass(ratio) {
            if (ratio == null) return 'neutral';
            if (ratio >= 100) return 'low'; // Higher is better, so "low" danger
            if (ratio >= 50) return 'medium';
            return 'high'; // Low NGL recovery is concerning
        }

        // Update pagination
        function updatePagination(pagination) {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageInfo = document.getElementById('pageInfo');
            const paginationDiv = document.getElementById('pagination');

            if (totalCount <= pageSize) {
                paginationDiv.style.display = 'none';
                return;
            }

            paginationDiv.style.display = 'flex';

            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = !pagination.has_more;

            const startItem = currentPage * pageSize + 1;
            const endItem = Math.min((currentPage + 1) * pageSize, totalCount);
            pageInfo.textContent = `${startItem}-${endItem} of ${formatNumber(totalCount)}`;
        }

        // Update result count text
        function updateResultCount(shown, total, search) {
            const info = document.getElementById('resultsInfo');
            if (search) {
                info.innerHTML = `<span id="resultCount">Showing ${shown} operators matching "<strong>${escapeHtml(search)}</strong>"</span>`;
            } else {
                info.innerHTML = `<span id="resultCount">Showing ${shown} of ${formatNumber(total)} operators</span>`;
            }
        }

        // Show loading state
        function showTableLoading() {
            document.getElementById('operatorsTableBody').innerHTML = `
                <tr class="loading-row">
                    <td colspan="6">
                        <div class="loading-spinner"></div>
                        <span>Loading operators...</span>
                    </td>
                </tr>
            `;
        }

        // Show error state
        function showTableError(message) {
            document.getElementById('operatorsTableBody').innerHTML = `
                <tr class="empty-row">
                    <td colspan="6">
                        <span style="color: var(--danger-red);">${escapeHtml(message)}</span>
                    </td>
                </tr>
            `;
        }

        // Open operator detail modal
        async function openOperatorDetail(operatorNumber) {
            const modal = document.getElementById('operatorModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalOperatorName');

            // Find operator in current list for immediate name display
            const op = currentOperators.find(o => o.operator_number === operatorNumber);
            modalTitle.textContent = op ? op.operator_name : `Operator ${operatorNumber}`;

            modal.style.display = 'flex';
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading-spinner"></div>
                    <span>Loading details...</span>
                </div>
            `;

            try {
                const response = await fetch(`/api/operators/${operatorNumber}`);
                if (!response.ok) {
                    throw new Error('Failed to load operator details');
                }

                const data = await response.json();
                renderOperatorDetail(data);

            } catch (error) {
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--danger-red);">
                        ${escapeHtml(error.message)}
                    </div>
                `;
            }
        }

        // Render operator detail in modal
        function renderOperatorDetail(data) {
            const modalBody = document.getElementById('modalBody');
            const summary = data.summary;
            const contact = data.contact;

            // === HEADER: Name, operator number, status, gas profile ===
            document.getElementById('modalOperatorName').innerHTML = escapeHtml(data.operator_name);

            const metaEl = document.getElementById('modalOperatorMeta');
            if (metaEl) {
                let metaHtml = '';
                metaHtml += `<span style="font-size: 14px; opacity: 0.9;">#${escapeHtml(data.operator_number)}</span>`;

                if (data.status === 'OPEN') {
                    metaHtml += `<span style="font-size: 11px; font-weight: 600; background: rgba(16,185,129,0.25); color: #d1fae5; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Active</span>`;
                } else if (data.status === 'CLOSED') {
                    metaHtml += `<span style="font-size: 11px; font-weight: 600; background: rgba(148,163,184,0.3); color: #e2e8f0; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Inactive</span>`;
                }

                if (data.gas_profile && data.gas_profile.label) {
                    const gpLabel = data.gas_profile.label.includes('Lean') ? 'Primarily Gas' :
                                    data.gas_profile.label.includes('Rich') ? 'Primarily Oil' : 'Mixed Portfolio';
                    const gpColor = data.gas_profile.label.includes('Lean') ? 'rgba(59,130,246,0.3)' :
                                    data.gas_profile.label.includes('Rich') ? 'rgba(245,158,11,0.3)' : 'rgba(148,163,184,0.3)';
                    metaHtml += `<span style="font-size: 11px; font-weight: 600; background: ${gpColor}; color: white; padding: 2px 8px; border-radius: 4px;">${escapeHtml(gpLabel)}</span>`;
                }

                metaEl.innerHTML = metaHtml;
            }

            // === BODY: Summary Stats ===
            let html = `
                <div class="modal-summary">
                    <div class="modal-stat">
                        <div class="modal-stat-value">${formatNumber(summary.well_count)}</div>
                        <div class="modal-stat-label">Wells</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${formatCurrency(summary.total_gross)}</div>
                        <div class="modal-stat-label">6-Mo Gross</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${summary.deduction_ratio}%</div>
                        <div class="modal-stat-label">Deduction Ratio</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${summary.pcrr != null ? summary.pcrr + '%' : 'N/A'}</div>
                        <div class="modal-stat-label">PCRR</div>
                    </div>
                </div>
            `;

            // === Contact Information (moved up) ===
            if (contact && (contact.phone || contact.address || contact.contact_name)) {
                const addressParts = [contact.address, contact.city, contact.state, contact.zip].filter(Boolean);
                const fullAddress = addressParts.length > 0
                    ? `${contact.address || ''}<br>${contact.city || ''}, ${contact.state || ''} ${contact.zip || ''}`.trim()
                    : null;

                html += `
                    <div class="modal-section contact-section">
                        <h3>Contact Information</h3>
                        <div class="contact-grid">
                            ${contact.contact_name ? `
                                <div class="contact-item">
                                    <span class="contact-label">Contact</span>
                                    <span class="contact-value">${escapeHtml(contact.contact_name)}</span>
                                </div>
                            ` : ''}
                            ${contact.phone ? `
                                <div class="contact-item">
                                    <span class="contact-label">Phone</span>
                                    <a href="tel:${escapeHtml(contact.phone)}" class="contact-value contact-link" style="color: #7c3aed;">${escapeHtml(contact.phone)}</a>
                                </div>
                            ` : ''}
                            ${fullAddress ? `
                                <div class="contact-item contact-address">
                                    <span class="contact-label">Address</span>
                                    <span class="contact-value">${contact.address ? escapeHtml(contact.address) : ''}<br>${contact.city ? escapeHtml(contact.city) : ''}, ${contact.state ? escapeHtml(contact.state) : ''} ${contact.zip ? escapeHtml(contact.zip) : ''}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // === Operational Health ===
            if (data.production_health) {
                const h = data.production_health;
                const idleColor = getIdleRateColor(h.idleRatePct);
                const declineColor = getDeclineColor(h.avgDecline);
                const totalIdle = h.recentlyIdle + h.extendedIdle + h.longTermIdle;

                html += `
                    <div class="modal-section">
                        <h3>Operational Health</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 0.75rem;">
                            <div style="text-align: center; padding: 0.5rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; margin-bottom: 0.25rem;">Active</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #10b981;">${formatNumber(h.activePuns)}</div>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; margin-bottom: 0.25rem;">Idle</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: ${idleColor};">${formatNumber(h.idlePuns)}</div>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; margin-bottom: 0.25rem;">Idle Rate</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: ${idleColor};">${h.idleRatePct}%</div>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; margin-bottom: 0.25rem;">Avg Decline</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: ${declineColor};">${h.avgDecline != null ? h.avgDecline + '%' : 'N/A'}</div>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; margin-bottom: 0.25rem;">Declining</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #ef4444;">${formatNumber(h.decliningWells)}</div>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; margin-bottom: 0.25rem;">Growing</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: #10b981;">${formatNumber(h.growingWells)}</div>
                            </div>
                        </div>
                `;

                if (totalIdle > 0) {
                    const recentPct = Math.round(h.recentlyIdle / totalIdle * 100);
                    const extPct = Math.round(h.extendedIdle / totalIdle * 100);
                    const longPct = 100 - recentPct - extPct;
                    html += `
                        <div>
                            <div style="font-size: 0.65rem; color: #64748b; margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px;">Idle Breakdown (${formatNumber(totalIdle)} wells)</div>
                            <div style="display: flex; height: 8px; border-radius: 4px; overflow: hidden; background: #e5e7eb;">
                                ${h.recentlyIdle > 0 ? `<div style="width: ${recentPct}%; background: #f59e0b;" title="Recently idle (3-6mo): ${h.recentlyIdle}"></div>` : ''}
                                ${h.extendedIdle > 0 ? `<div style="width: ${extPct}%; background: #f97316;" title="Extended idle (6-12mo): ${h.extendedIdle}"></div>` : ''}
                                ${h.longTermIdle > 0 ? `<div style="width: ${longPct}%; background: #94a3b8;" title="Long-term idle (12+mo): ${h.longTermIdle}"></div>` : ''}
                            </div>
                            <div style="display: flex; gap: 0.75rem; margin-top: 0.375rem; font-size: 0.65rem; color: #64748b;">
                                ${h.recentlyIdle > 0 ? `<span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#f59e0b;margin-right:3px;"></span>3-6mo: ${h.recentlyIdle}</span>` : ''}
                                ${h.extendedIdle > 0 ? `<span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#f97316;margin-right:3px;"></span>6-12mo: ${h.extendedIdle}</span>` : ''}
                                ${h.longTermIdle > 0 ? `<span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#94a3b8;margin-right:3px;"></span>12+mo: ${h.longTermIdle}</span>` : ''}
                            </div>
                        </div>
                    `;
                }

                html += `</div>`;
            } else if (data.production_health === null) {
                html += `
                    <div class="modal-section">
                        <h3>Operational Health</h3>
                        <p style="color: #64748b; font-size: 0.85rem; font-style: italic;">No production unit data available for this operator.</p>
                    </div>
                `;
            }

            // === Monthly Trend ===
            if (data.monthly && data.monthly.length > 0) {
                html += `
                    <div class="modal-section">
                        <h3>Monthly Trend (${data.analysis_period})</h3>
                        <table class="modal-table">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th style="text-align: right;">Gross</th>
                                    <th style="text-align: right;">Deductions</th>
                                    <th style="text-align: right;">Ded. Ratio</th>
                                    <th style="text-align: right;">PCRR</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.monthly.map(m => `
                                    <tr>
                                        <td>${formatMonth(m.year_month)}</td>
                                        <td style="text-align: right;">${formatCurrency(m.total_gross)}</td>
                                        <td style="text-align: right;">${formatCurrency(m.residue_deductions)}</td>
                                        <td style="text-align: right;">${m.deduction_ratio}%</td>
                                        <td style="text-align: right;">${m.pcrr != null ? m.pcrr + '%' : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // === Counties ===
            if (data.counties && data.counties.length > 0) {
                html += `
                    <div class="modal-section">
                        <h3>Counties</h3>
                        <table class="modal-table">
                            <thead>
                                <tr>
                                    <th>County</th>
                                    <th style="text-align: right;">Wells</th>
                                    <th style="text-align: right;">Gross</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.counties.map(c => `
                                    <tr>
                                        <td>${escapeHtml(c.county || 'Unknown')}</td>
                                        <td style="text-align: right;">${formatNumber(c.well_count)}</td>
                                        <td style="text-align: right;">${formatCurrency(c.total_gross)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            modalBody.innerHTML = html;

            // === FOOTER ===
            const footer = document.getElementById('operatorModalFooter');
            if (footer) {
                footer.style.display = '';
                footer.querySelector('div').innerHTML = `
                    <button onclick="printOperatorSummary('${escapeHtml(data.operator_number)}')" style="padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; background: #7c3aed; color: white; display: flex; align-items: center; gap: 6px; transition: background 0.15s;">
                        Operator Summary ↗
                    </button>
                `;
            }
        }

        function printOperatorSummary(operatorNumber) {
            window.open('/print/operators/' + operatorNumber, '_blank');
        }

        // Close operator detail modal
        function closeOperatorModal() {
            document.getElementById('operatorModal').style.display = 'none';
        }

        // Utility functions
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatNumber(num) {
            if (num == null) return '—';
            return num.toLocaleString();
        }

        function formatCurrency(amount) {
            if (amount == null) return '—';
            if (amount >= 1000000) {
                return '$' + (amount / 1000000).toFixed(1) + 'M';
            }
            if (amount >= 1000) {
                return '$' + (amount / 1000).toFixed(0) + 'K';
            }
            return '$' + amount.toFixed(0);
        }

        function formatMonth(yyyymm) {
            if (!yyyymm || yyyymm.length !== 6) return yyyymm;
            const year = yyyymm.substring(0, 4);
            const month = parseInt(yyyymm.substring(4, 6), 10);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[month - 1]} ${year}`;
        }

        function getIdleRateColor(rate) {
            if (rate < 20) return '#10b981';
            if (rate < 50) return '#f59e0b';
            if (rate < 75) return '#f97316';
            return '#ef4444';
        }

        function getDeclineColor(rate) {
            if (rate == null) return '#94a3b8';
            if (rate > -10) return '#10b981';
            if (rate > -35) return '#f59e0b';
            if (rate > -60) return '#f97316';
            return '#ef4444';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
