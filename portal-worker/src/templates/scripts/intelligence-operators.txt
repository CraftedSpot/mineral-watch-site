        // =============================================
        // OPERATOR TOOLS
        // =============================================

        // =============================================
        // OPERATOR EFFICIENCY INDEX (Financial metrics)
        // =============================================

        let allEfficiencyOperators = []; // Full dataset from server
        let efficiencyOperators = []; // Filtered for display
        let efficiencySort = { key: 'well_count', dir: 'desc' };
        let efficiencySearchTerm = '';

        function loadOperatorEfficiency() {
            document.querySelector('main').style.display = 'none';
            document.querySelector('.intel-hero').style.display = 'none';
            document.getElementById('operatorEfficiencyViewer').style.display = 'block';

            setupEfficiencyListeners();
            fetchOperatorEfficiency();
        }

        function closeOperatorEfficiency() {
            document.getElementById('operatorEfficiencyViewer').style.display = 'none';
            document.querySelector('main').style.display = 'block';
            document.querySelector('.intel-hero').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function setupEfficiencyListeners() {
            if (window._efficiencyListenersSetup) return;
            window._efficiencyListenersSetup = true;

            // Search with debounce - client-side filtering
            let searchTimeout;
            document.getElementById('efficiencySearchInput').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    efficiencySearchTerm = e.target.value.trim();
                    applyEfficiencyFilters();
                }, 150);
            });

            // Min wells change - requires server reload
            document.getElementById('efficiencyMinWells').addEventListener('change', () => {
                fetchOperatorEfficiency();
            });
        }

        async function fetchOperatorEfficiency() {
            const minWells = document.getElementById('efficiencyMinWells').value;
            const params = new URLSearchParams({
                min_wells: minWells,
                limit: 1000 // Load all at once for client-side sorting
            });

            const contentEl = document.getElementById('efficiencyContent');
            contentEl.innerHTML = '<div class="report-loading">Loading efficiency data...</div>';

            try {
                const response = await fetch(`/api/operators/efficiency?${params}`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to load efficiency data');
                }

                const data = await response.json();
                allEfficiencyOperators = data.operators;
                efficiencySearchTerm = document.getElementById('efficiencySearchInput').value.trim();

                updateEfficiencyStats(data);
                applyEfficiencyFilters();

            } catch (error) {
                contentEl.innerHTML = `
                    <div class="directory-error">${escapeHtml(error.message)}</div>
                `;
                showToast(error.message, 'error');
            }
        }

        function updateEfficiencyStats(data) {
            document.getElementById('efficiencySubtitle').textContent =
                `${formatNumber(data.operators.length)} operators · 6-month analysis`;

            // Calculate distribution from full dataset
            const dist = data.operators.reduce((acc, op) => {
                if (op.net_value_return >= 0) acc.positive++;
                else if (op.net_value_return > -1000000) acc.neutral++;
                else if (op.net_value_return > -10000000) acc.warning++;
                else acc.danger++;
                return acc;
            }, { positive: 0, neutral: 0, warning: 0, danger: 0 });

            document.getElementById('efficiencyStats').innerHTML = `
                <span class="legend-pill success" title="Positive Net Return">${dist.positive}</span>
                <span class="legend-pill neutral" title="Neutral ($0 to -$1M)">${dist.neutral}</span>
                <span class="legend-pill warning" title="Moderate (-$1M to -$10M)">${dist.warning}</span>
                <span class="legend-pill danger" title="Significant (below -$10M)">${dist.danger}</span>
            `;
        }

        function handleEfficiencySort(key) {
            if (efficiencySort.key === key) {
                efficiencySort.dir = efficiencySort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                // Default directions: desc for numbers (show highest/lowest first), asc for name
                const defaultAsc = ['net_value_return', 'pcrr', 'name'];
                efficiencySort.key = key;
                efficiencySort.dir = defaultAsc.includes(key) ? 'asc' : 'desc';
            }
            applyEfficiencyFilters(); // Client-side sort, no refetch needed
        }

        function renderEfficiencySortArrow(key) {
            if (efficiencySort.key !== key) {
                return '<span class="sort-arrows"><span class="sort-arrow">▲</span><span class="sort-arrow">▼</span></span>';
            }
            return efficiencySort.dir === 'asc'
                ? '<span class="sort-arrows"><span class="sort-arrow active">▲</span><span class="sort-arrow">▼</span></span>'
                : '<span class="sort-arrows"><span class="sort-arrow">▲</span><span class="sort-arrow active">▼</span></span>';
        }

        function sortEfficiencyData(data, key, dir) {
            const sortKey = key === 'name' ? 'operator_name'
                          : key === 'deductions' ? 'residue_deductions'
                          : key;
            return [...data].sort((a, b) => {
                let aVal = a[sortKey];
                let bVal = b[sortKey];

                if (aVal == null && bVal == null) return 0;
                if (aVal == null) return dir === 'asc' ? 1 : -1;
                if (bVal == null) return dir === 'asc' ? -1 : 1;

                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    return dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }

                return dir === 'asc' ? aVal - bVal : bVal - aVal;
            });
        }

        function applyEfficiencyFilters() {
            const search = efficiencySearchTerm.toLowerCase();
            efficiencyOperators = allEfficiencyOperators.filter(op => {
                if (!search) return true;
                return op.operator_name.toLowerCase().includes(search) ||
                       op.operator_number.includes(search);
            });
            renderEfficiencyTable();
        }

        function renderEfficiencyTable() {
            if (!efficiencyOperators || efficiencyOperators.length === 0) {
                document.getElementById('efficiencyContent').innerHTML = `
                    <div class="directory-empty">${efficiencySearchTerm ? 'No operators match your search' : 'No operators found'}</div>
                `;
                return;
            }

            // Sort the data client-side
            const sortedOperators = sortEfficiencyData(efficiencyOperators, efficiencySort.key, efficiencySort.dir);

            // Show count if filtered
            const countHtml = efficiencySearchTerm
                ? `<div class="search-result-count">Showing ${efficiencyOperators.length} of ${allEfficiencyOperators.length} operators</div>`
                : '';

            let html = countHtml + `
                <table class="directory-table efficiency-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="handleEfficiencySort('name')">Operator${renderEfficiencySortArrow('name')}</th>
                            <th class="text-right sortable" onclick="handleEfficiencySort('well_count')" title="Number of active wells">Wells${renderEfficiencySortArrow('well_count')}</th>
                            <th class="text-right sortable" onclick="handleEfficiencySort('deductions')" title="Processing fees taken (Product 5 - Residue Gas)">Deductions${renderEfficiencySortArrow('deductions')}</th>
                            <th class="text-right sortable" onclick="handleEfficiencySort('pcrr_value')" title="Value returned from extracted liquids (Product 6 - NGLs)">NGL Returned${renderEfficiencySortArrow('pcrr_value')}</th>
                            <th class="text-right sortable" onclick="handleEfficiencySort('net_value_return')" title="NGL Returned minus Deductions. Positive = more returned than taken.">Net Return${renderEfficiencySortArrow('net_value_return')}</th>
                            <th class="text-right sortable" onclick="handleEfficiencySort('pcrr')" title="Post-Production Cost Recovery Ratio: NGL ÷ Deductions × 100. Over 100% is favorable.">PCRR${renderEfficiencySortArrow('pcrr')}</th>
                            <th title="Primary gas purchaser for this operator">Gas Purchaser</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedOperators.forEach(op => {
                const pcrrClass = op.pcrr == null ? 'neutral'
                    : op.pcrr >= 100 ? 'success'
                    : op.pcrr >= 30 ? 'medium' : 'danger';
                const returnClass = op.net_value_return == null ? 'neutral'
                    : op.net_value_return >= 0 ? 'success'
                    : op.net_value_return <= -10000000 ? 'danger'
                    : op.net_value_return <= -1000000 ? 'medium' : 'neutral';

                // Purchaser badge
                let purchaserHtml = '—';
                if (op.primary_purchaser_name) {
                    const badge = op.is_affiliated
                        ? '<span class="affiliated-badge" title="The gas purchaser is the same entity as the operator">Affiliated</span>'
                        : '<span class="third-party-badge" title="Third-party purchaser">Third Party</span>';
                    purchaserHtml = `<div class="purchaser-cell-name">${escapeHtml(op.primary_purchaser_name)}</div>${badge}`;
                }

                html += `
                    <tr onclick="openOperatorDetail('${escapeHtml(op.operator_number)}')" style="cursor: pointer;">
                        <td>
                            <div class="op-name">${escapeHtml(op.operator_name)}</div>
                            <div class="op-meta">#${escapeHtml(op.operator_number)}</div>
                        </td>
                        <td class="text-right">${formatNumber(op.well_count)}</td>
                        <td class="text-right">${formatCurrencyShort(op.residue_deductions)}</td>
                        <td class="text-right">${formatCurrencyShort(op.pcrr_value)}</td>
                        <td class="text-right"><span class="metric-pill ${returnClass}">${formatCurrencyShort(op.net_value_return)}</span></td>
                        <td class="text-right"><span class="metric-pill ${pcrrClass}">${op.pcrr != null ? op.pcrr + '%' : 'N/A'}</span></td>
                        <td class="purchaser-cell">${purchaserHtml}</td>
                        <td class="text-right">
                            <svg class="row-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('efficiencyContent').innerHTML = html;
        }

        function exportEfficiencyCSV() {
            if (!allEfficiencyOperators || allEfficiencyOperators.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            // Format number with commas
            function formatCSVNumber(val, decimals = 2) {
                if (val == null) return '';
                return val.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
            }

            // CSV header row
            const headers = [
                'Operator Number',
                'Operator Name',
                'Status',
                'Primary County',
                'Well Count',
                'Total Gross ($)',
                'Deductions ($)',
                'Deduction %',
                'NGL Returned ($)',
                'Net Return ($)',
                'PCRR %',
                'Primary Gas Purchaser',
                'Purchaser Type'
            ];

            // Build CSV rows
            const rows = allEfficiencyOperators.map(op => [
                op.operator_number,
                `"${(op.operator_name || '').replace(/"/g, '""')}"`, // Escape quotes in name
                op.status || '',
                op.primary_county || '',
                op.well_count != null ? formatCSVNumber(op.well_count, 0) : 0,
                op.total_gross != null ? `"${formatCSVNumber(op.total_gross)}"` : '',
                op.residue_deductions != null ? `"${formatCSVNumber(op.residue_deductions)}"` : '',
                op.deduction_pct != null ? `"${formatCSVNumber(op.deduction_pct, 1)}"` : '',
                op.pcrr_value != null ? `"${formatCSVNumber(op.pcrr_value)}"` : '',
                op.net_value_return != null ? `"${formatCSVNumber(op.net_value_return)}"` : '',
                op.pcrr != null ? `"${formatCSVNumber(op.pcrr, 1)}"` : '',
                `"${(op.primary_purchaser_name || '').replace(/"/g, '""')}"`,
                op.primary_purchaser_name ? (op.is_affiliated ? 'Affiliated' : 'Third Party') : ''
            ]);

            // Combine into CSV string
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');

            // Create download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `operator-efficiency-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showToast(`Exported ${allEfficiencyOperators.length} operators`, 'success');
        }

        // =============================================
        // OPERATOR DIRECTORY (Contact info, no financials)
        // =============================================

        let allDirectoryOperators = [];
        let currentDirectoryOperators = [];
        let directorySort = { key: 'well_count', dir: 'desc' };
        let directorySearchTerm = '';

        function sortDirectoryData(data, key, dir) {
            return [...data].sort((a, b) => {
                let aVal = a[key];
                let bVal = b[key];

                if (aVal == null && bVal == null) return 0;
                if (aVal == null) return dir === 'asc' ? -1 : 1;
                if (bVal == null) return dir === 'asc' ? 1 : -1;

                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    return dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }

                return dir === 'asc' ? aVal - bVal : bVal - aVal;
            });
        }

        function handleDirectorySort(key) {
            if (directorySort.key === key) {
                directorySort.dir = directorySort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                directorySort = { key, dir: key === 'operator_name' ? 'asc' : 'desc' };
            }
            applyDirectoryFilters();
        }

        function applyDirectoryFilters() {
            const search = directorySearchTerm.toLowerCase();
            currentDirectoryOperators = allDirectoryOperators.filter(op => {
                if (!search) return true;
                return op.operator_name.toLowerCase().includes(search) ||
                       op.operator_number.includes(search) ||
                       (op.city && op.city.toLowerCase().includes(search));
            });
            renderDirectoryTable(currentDirectoryOperators);
        }

        function renderDirectorySortArrow(key) {
            if (directorySort.key !== key) {
                return '<span class="sort-arrows"><span class="sort-arrow">▲</span><span class="sort-arrow">▼</span></span>';
            }
            return directorySort.dir === 'asc'
                ? '<span class="sort-arrows"><span class="sort-arrow active">▲</span><span class="sort-arrow">▼</span></span>'
                : '<span class="sort-arrows"><span class="sort-arrow">▲</span><span class="sort-arrow active">▼</span></span>';
        }

        function loadOperatorDirectory() {
            document.querySelector('main').style.display = 'none';
            document.querySelector('.intel-hero').style.display = 'none';
            document.getElementById('operatorDirectoryViewer').style.display = 'block';

            setupDirectoryListeners();
            fetchOperatorDirectory();
        }

        function closeOperatorDirectory() {
            document.getElementById('operatorDirectoryViewer').style.display = 'none';
            document.querySelector('main').style.display = 'block';
            document.querySelector('.intel-hero').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function setupDirectoryListeners() {
            if (window._directoryListenersSetup) return;
            window._directoryListenersSetup = true;

            let searchTimeout;
            document.getElementById('directorySearchInput').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    directorySearchTerm = e.target.value.trim();
                    applyDirectoryFilters();
                }, 150);
            });

            document.getElementById('directoryMinWells').addEventListener('change', () => {
                fetchOperatorDirectory();
            });
        }

        async function fetchOperatorDirectory() {
            const minWells = document.getElementById('directoryMinWells').value;
            const params = new URLSearchParams({ min_wells: minWells });

            document.getElementById('directoryContent').innerHTML = '<div class="report-loading">Loading operators...</div>';

            try {
                const response = await fetch(`/api/operators/directory?${params}`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to load operators');
                }

                const data = await response.json();
                allDirectoryOperators = data.operators;
                directorySearchTerm = document.getElementById('directorySearchInput').value.trim();

                document.getElementById('directorySubtitle').textContent =
                    `${formatNumber(data.total_count)} operators`;

                applyDirectoryFilters();

            } catch (error) {
                document.getElementById('directoryContent').innerHTML = `
                    <div class="directory-error">${escapeHtml(error.message)}</div>
                `;
                showToast(error.message, 'error');
            }
        }

        function renderDirectoryTable(operators) {
            if (!operators || operators.length === 0) {
                document.getElementById('directoryContent').innerHTML = `
                    <div class="directory-empty">${directorySearchTerm ? 'No operators match your search' : 'No operators found'}</div>
                `;
                return;
            }

            const sortedOperators = sortDirectoryData(operators, directorySort.key, directorySort.dir);

            const countHtml = directorySearchTerm
                ? `<div class="search-result-count">Showing ${operators.length} of ${allDirectoryOperators.length} operators</div>`
                : '';

            let html = countHtml + `
                <table class="directory-table compact-directory">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="handleDirectorySort('operator_name')">Operator${renderDirectorySortArrow('operator_name')}</th>
                            <th class="sortable" onclick="handleDirectorySort('well_count')">Wells${renderDirectorySortArrow('well_count')}</th>
                            <th>Contact</th>
                            <th>Mailing Address</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedOperators.forEach(op => {
                const statusBadge = op.status === 'OPEN'
                    ? '<span class="status-active">Active</span>'
                    : op.status === 'CLOSED'
                        ? '<span class="status-inactive">Inactive</span>'
                        : '';

                // Contact: name + phone stacked
                let contactHtml = '';
                if (op.contact_name) {
                    contactHtml += `<div class="contact-name">${escapeHtml(op.contact_name)}</div>`;
                }
                if (op.phone) {
                    contactHtml += `<div class="contact-phone"><a href="tel:${escapeHtml(op.phone)}" onclick="event.stopPropagation();">${escapeHtml(op.phone)}</a></div>`;
                }
                if (!contactHtml) contactHtml = '—';

                // Full mailing address
                let addressHtml = '';
                if (op.address) {
                    addressHtml += `<div class="address-line">${escapeHtml(op.address)}</div>`;
                }
                if (op.city || op.state || op.zip) {
                    const cityStateZip = [
                        op.city,
                        op.state,
                        op.zip
                    ].filter(Boolean).join(op.city && op.state ? ', ' : ' ').replace(/, (\d)/, ' $1');
                    if (cityStateZip) {
                        addressHtml += `<div class="address-line">${escapeHtml(cityStateZip)}</div>`;
                    }
                }
                if (!addressHtml) addressHtml = '—';

                html += `
                    <tr onclick="openOperatorDetail('${escapeHtml(op.operator_number)}')" style="cursor: pointer;">
                        <td>
                            <div class="op-name">${escapeHtml(op.operator_name)}</div>
                            <div class="op-meta">#${escapeHtml(op.operator_number)} ${statusBadge}</div>
                        </td>
                        <td class="wells-cell">${formatNumber(op.well_count)}</td>
                        <td class="contact-cell">${contactHtml}</td>
                        <td class="address-cell">${addressHtml}</td>
                        <td class="arrow-cell">
                            <svg class="row-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('directoryContent').innerHTML = html;
        }

        function exportDirectoryCSV() {
            if (!allDirectoryOperators || allDirectoryOperators.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            // CSV header row
            const headers = [
                'Operator Number',
                'Operator Name',
                'Status',
                'Well Count',
                'Contact Name',
                'Phone',
                'Address',
                'City',
                'State',
                'Zip'
            ];

            // Build CSV rows
            const rows = allDirectoryOperators.map(op => [
                op.operator_number,
                `"${(op.operator_name || '').replace(/"/g, '""')}"`,
                op.status === 'OPEN' ? 'Active' : op.status === 'CLOSED' ? 'Inactive' : (op.status || ''),
                op.well_count || 0,
                `"${(op.contact_name || '').replace(/"/g, '""')}"`,
                op.phone || '',
                `"${(op.address || '').replace(/"/g, '""')}"`,
                `"${(op.city || '').replace(/"/g, '""')}"`,
                op.state || '',
                op.zip || ''
            ]);

            // Combine into CSV string
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');

            // Create download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `operator-directory-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showToast(`Exported ${allDirectoryOperators.length} operators`, 'success');
        }

        // =============================================
        // OPERATOR DETAIL MODAL (shared by both views)
        // =============================================

        async function openOperatorDetail(operatorNumber) {
            const modal = document.getElementById('operatorModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalOperatorName');

            // Try to find name from either list
            const fromEff = allEfficiencyOperators.find(o => o.operator_number === operatorNumber);
            const fromDir = currentDirectoryOperators.find(o => o.operator_number === operatorNumber);
            const op = fromEff || fromDir;
            modalTitle.textContent = op ? op.operator_name : `Operator ${operatorNumber}`;

            modal.style.display = 'flex';
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading-spinner"></div>
                    <span>Loading details...</span>
                </div>
            `;

            try {
                const response = await fetch(`/api/operators/${operatorNumber}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || data.error || 'Failed to load operator details');
                }

                renderOperatorModal(data);

            } catch (error) {
                console.error('[Operator Detail] Error:', error);
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--danger-red);">
                        ${escapeHtml(error.message)}
                    </div>
                `;
            }
        }

        function renderOperatorModal(data) {
            const modalBody = document.getElementById('modalBody');
            document.getElementById('modalOperatorName').textContent = data.operator_name;

            const summary = data.summary;
            const contact = data.contact;

            const netValueReturn = summary.pcrr_value - summary.residue_deductions;
            const netReturnClass = netValueReturn >= 0 ? 'positive' : netValueReturn <= -1000000 ? 'negative' : '';

            let html = `
                <div class="modal-stats">
                    <div class="modal-stat">
                        <div class="modal-stat-value">${formatNumber(summary.well_count)}</div>
                        <div class="modal-stat-label">Wells</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${formatCurrencyShort(summary.total_gross)}</div>
                        <div class="modal-stat-label">6-Mo Gross</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value">${summary.deduction_ratio}%</div>
                        <div class="modal-stat-label">Deduction Rate</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-value ${summary.pcrr >= 100 ? 'positive' : summary.pcrr < 10 ? 'negative' : ''}">${summary.pcrr != null ? summary.pcrr + '%' : 'N/A'}</div>
                        <div class="modal-stat-label">PCRR</div>
                    </div>
                </div>
            `;

            // Financial Breakdown
            html += `
                <div class="modal-section financial-breakdown">
                    <h3>Financial Breakdown (6 Months)</h3>
                    <div class="breakdown-grid">
                        <div class="breakdown-row">
                            <span class="breakdown-label">Total Production Value</span>
                            <span class="breakdown-value">${formatCurrencyShort(summary.total_gross)}</span>
                        </div>
                        <div class="breakdown-row deduction">
                            <span class="breakdown-label">Processing Deductions (Prod 5)</span>
                            <span class="breakdown-value">-${formatCurrencyShort(summary.residue_deductions)}</span>
                        </div>
                        <div class="breakdown-row return">
                            <span class="breakdown-label">NGL Returned (Prod 6)</span>
                            <span class="breakdown-value">+${formatCurrencyShort(summary.pcrr_value)}</span>
                        </div>
                        <div class="breakdown-row net ${netReturnClass}">
                            <span class="breakdown-label"><strong>Net Value Return</strong></span>
                            <span class="breakdown-value"><strong>${formatCurrencyShort(netValueReturn)}</strong></span>
                        </div>
                    </div>
                    <div class="breakdown-context">
                        <p><strong>PCRR</strong> = NGL Returned ÷ Deductions × 100</p>
                        <p>Over 100% = More value returned than deducted (favorable)</p>
                    </div>
                </div>
            `;

            // Purchaser info
            if (data.purchaser && data.purchaser.primary_purchaser_name) {
                const badge = data.purchaser.is_affiliated
                    ? '<span class="affiliated-badge" title="The gas purchaser is the same entity as the operator">Affiliated</span>'
                    : '<span class="third-party-badge" title="Third-party purchaser">Third Party</span>';

                html += `
                    <div class="modal-section purchaser-section">
                        <h3>Gas Purchaser</h3>
                        <div class="purchaser-info">
                            <span class="purchaser-name">${escapeHtml(data.purchaser.primary_purchaser_name)}</span>
                            ${badge}
                        </div>
                        ${data.purchaser.is_affiliated ? `
                            <div class="affiliated-note">
                                This operator's gas is sold to an entity with the same or similar name, indicating vertical integration.
                                The operator may control both production and processing/marketing, which can affect deduction structures.
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Contact info
            if (contact && (contact.phone || contact.address || contact.contact_name)) {
                const statusBadge = contact.status === 'OPEN'
                    ? '<span class="contact-status active">Active</span>'
                    : contact.status === 'CLOSED'
                        ? '<span class="contact-status inactive">Inactive</span>'
                        : '';

                html += `
                    <div class="modal-section contact-box">
                        <h3>Contact Information ${statusBadge}</h3>
                        <div class="contact-grid">
                            ${contact.contact_name ? `<div class="contact-row"><span class="contact-label">Contact</span><span>${escapeHtml(contact.contact_name)}</span></div>` : ''}
                            ${contact.phone ? `<div class="contact-row"><span class="contact-label">Phone</span><a href="tel:${escapeHtml(contact.phone)}">${escapeHtml(contact.phone)}</a></div>` : ''}
                            ${contact.address ? `<div class="contact-row"><span class="contact-label">Address</span><span>${escapeHtml(contact.address)}<br>${escapeHtml(contact.city || '')}, ${escapeHtml(contact.state || '')} ${escapeHtml(contact.zip || '')}</span></div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Monthly trend
            if (data.monthly && data.monthly.length > 0) {
                html += `
                    <div class="modal-section">
                        <h3>Monthly Trend</h3>
                        <table class="modal-table">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th class="text-right">Gross</th>
                                    <th class="text-right">Deductions</th>
                                    <th class="text-right">Ded %</th>
                                    <th class="text-right">PCRR</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.monthly.slice(0, 6).map(m => `
                                    <tr>
                                        <td>${formatMonthShort(m.year_month)}</td>
                                        <td class="text-right">${formatCurrencyShort(m.total_gross)}</td>
                                        <td class="text-right">${formatCurrencyShort(m.residue_deductions)}</td>
                                        <td class="text-right">${m.deduction_ratio}%</td>
                                        <td class="text-right">${m.pcrr != null ? m.pcrr + '%' : '—'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Top Counties with metrics
            if (data.counties && data.counties.length > 0) {
                html += `
                    <div class="modal-section">
                        <h3>Top Counties</h3>
                        <div class="county-pills">
                            ${data.counties.slice(0, 5).map(c => `<span class="county-pill">${escapeHtml(c.county || 'Unknown')} <small>(${c.well_count} wells)</small></span>`).join('')}
                        </div>
                    </div>
                `;
            }

            // All counties
            if (data.all_counties && data.all_counties.length > 0) {
                html += `
                    <div class="modal-section">
                        <h3>All Counties (${data.all_counties.length})</h3>
                        <p class="counties-list">${data.all_counties.join(', ')}</p>
                    </div>
                `;
            }

            modalBody.innerHTML = html;
        }

        function closeOperatorModal() {
            document.getElementById('operatorModal').style.display = 'none';
        }

        // Close modal on overlay click or ESC
        document.getElementById('operatorModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'operatorModal') closeOperatorModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeOperatorModal();
        });

        // =============================================
        // UTILITY FUNCTIONS
        // =============================================

        function formatNumber(num) {
            if (num == null) return '—';
            return num.toLocaleString();
        }

        function formatCurrencyShort(amount) {
            if (amount == null || isNaN(amount)) return '—';
            const isNegative = amount < 0;
            const absAmount = Math.abs(amount);
            let formatted;
            if (absAmount >= 1000000) {
                formatted = '$' + (absAmount / 1000000).toFixed(1) + 'M';
            } else if (absAmount >= 1000) {
                formatted = '$' + (absAmount / 1000).toFixed(0) + 'K';
            } else {
                formatted = '$' + absAmount.toFixed(0);
            }
            return isNegative ? '-' + formatted : formatted;
        }

        function formatMonthShort(yyyymm) {
            if (!yyyymm || yyyymm.length !== 6) return yyyymm;
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[parseInt(yyyymm.substring(4, 6), 10) - 1] + ' ' + yyyymm.substring(2, 4);
        }

        if (typeof escapeHtml === 'undefined') {
            window.escapeHtml = function(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };
        }
