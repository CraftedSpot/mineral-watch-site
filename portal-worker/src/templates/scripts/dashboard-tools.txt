        // ═══════════════════════════════════════════
        //  Revenue Estimator — Tools Tab
        // ═══════════════════════════════════════════

        var toolsLoaded = false;
        var toolsMode = 'property';  // 'property' or 'well'
        var toolsPrices = { oil: 68.00, gas: 3.25, date: null, source: null };
        var toolsPropertyData = null;  // response from /api/tools/property-production
        var toolsWellData = null;      // response from /api/tools/well-production
        var toolsDeduction = 25;
        var toolsManualDecimal = null;
        var toolsAllocOverrides = {};  // wellId → decimal (0-1) for local "what if" allocation editing
        var toolsSelectedPropertyId = null;
        var toolsSelectedWellId = null;
        var toolsDrilldownFrom = null;  // { id, label } — set when drilling from property mode
        var toolsUnitDetailIdx = null;  // index into sharedPunGroups when viewing unit detail
        var toolsHighlightIndex = -1;
        var toolsDropdownItems = [];

        function interestSourceLabel(w) {
            if (w.interestSource === 'extracted_division_order') {
                var dateStr = '';
                if (w.interestSourceDate) {
                    var d = new Date(w.interestSourceDate + 'Z');
                    if (!isNaN(d)) dateStr = ' (' + d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ')';
                }
                return 'from Division Order' + dateStr;
            }
            if (w.interestSource === 'well_override') return 'from well';
            if (w.interestSource === 'property') return 'from property';
            return '';
        }

        async function loadTools() {
            if (toolsLoaded) return;
            toolsLoaded = true;

            // Check if user has any properties with linked wells OR any tracked wells
            var hasWellLinks = loadedProperties.some(function(p) { return (p._linkedWells || 0) > 0; });
            var hasWells = loadedWells && loadedWells.length > 0;

            if (!hasWellLinks && !hasWells) {
                document.getElementById('toolsContent').innerHTML =
                    '<div class="tools-empty">' +
                    '<svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>' +
                    '<h3>Add properties or wells to get started</h3>' +
                    '<p>The Revenue Estimator uses your tracked well production data to estimate royalty income.</p>' +
                    '<button class="btn-cta" onclick="switchToTab(\'properties\')">Go to Properties</button>' +
                    '</div>';
                return;
            }

            renderToolsUI();
            fetchToolsPrices();

            // Close dropdown on outside click (mousedown fires before click so selection completes first)
            document.addEventListener('mousedown', function(e) {
                var wrapper = document.getElementById('toolsPropertySearchWrapper') || document.getElementById('toolsWellSearchWrapper');
                if (wrapper && !wrapper.contains(e.target)) {
                    hideToolsDropdown();
                }
            });
        }

        function switchToTab(tabName) {
            var tabBtn = document.querySelector('.tab[data-tab="' + tabName + '"]');
            if (tabBtn) tabBtn.click();
        }

        // ── Mode Toggle ─────────────────────────────

        function setToolsMode(mode) {
            if (toolsMode === mode) return;
            toolsMode = mode;
            toolsPropertyData = null;
            toolsWellData = null;
            toolsManualDecimal = null;
            toolsSelectedPropertyId = null;
            toolsSelectedWellId = null;
            toolsDrilldownFrom = null;
            toolsUnitDetailIdx = null;
            toolsHighlightIndex = -1;

            // Update toggle buttons
            var propBtn = document.getElementById('toolsModeProperty');
            var wellBtn = document.getElementById('toolsModeWell');
            if (propBtn) propBtn.className = 'mode-btn' + (mode === 'property' ? ' active' : '');
            if (wellBtn) wellBtn.className = 'mode-btn' + (mode === 'well' ? ' active' : '');

            // Swap selector
            renderToolsSelector();

            // Reset to placeholders
            resetToolsPlaceholders();
        }

        // ── Placeholder Helpers ─────────────────────

        function buildTotalPlaceholder() {
            return '<div class="property-total-v ptv-placeholder">' +
                '<div class="ptv-header">Revenue Summary</div>' +
                '<div class="ptv-block">' +
                    '<div class="ptv-label">Latest Month</div>' +
                    '<div class="ptv-gross">--</div>' +
                    '<div class="ptv-gross-label">Gross Revenue</div>' +
                    '<div class="ptv-net">--</div>' +
                    '<div class="ptv-net-label">Net</div>' +
                '</div>' +
                '<div class="ptv-divider"></div>' +
                '<div class="ptv-block">' +
                    '<div class="ptv-label">3-Month Average</div>' +
                    '<div class="ptv-gross">--</div>' +
                    '<div class="ptv-gross-label">Gross Revenue</div>' +
                    '<div class="ptv-net">--</div>' +
                    '<div class="ptv-net-label">Net</div>' +
                '</div>' +
            '</div>';
        }

        function resetToolsPlaceholders() {
            var cardsEl = document.getElementById('toolsWellCards');
            var totalEl = document.getElementById('toolsPropertyTotal');
            var nriArea = document.getElementById('toolsNriArea');
            var disclaimerEl = document.getElementById('toolsDisclaimer');
            var msg = toolsMode === 'well' ? 'Search for a well above' : 'Select a property to see wells';
            if (cardsEl) cardsEl.innerHTML = '<div class="tools-wells-placeholder">' + msg + '</div>';
            if (totalEl) totalEl.innerHTML = buildTotalPlaceholder();
            if (nriArea) nriArea.innerHTML = '';
            if (disclaimerEl) disclaimerEl.style.display = 'none';
        }

        // ── Main UI Render ───────────────────────────

        function renderToolsUI() {
            var content = document.getElementById('toolsContent');

            content.innerHTML =
                '<div class="tools-header">' +
                    '<h2>Revenue Estimator</h2>' +
                    '<p>Estimate royalty income from your properties and wells using real production data and live prices.</p>' +
                '</div>' +
                '<div class="tools-mode-toggle">' +
                    '<button class="mode-btn active" id="toolsModeProperty" onclick="setToolsMode(\'property\')">By Property</button>' +
                    '<button class="mode-btn" id="toolsModeWell" onclick="setToolsMode(\'well\')">By Well</button>' +
                '</div>' +
                '<div id="toolsSelectorArea"></div>' +
                '<div class="tools-summary-row">' +
                    '<div class="tools-summary-left">' +
                        '<div class="tools-price-bar">' +
                            '<div class="price-row">' +
                                '<div class="price-field">' +
                                    '<label>Oil Price <span class="live-badge" id="toolsOilLive" style="display:none">Live</span></label>' +
                                    '<input type="number" id="toolsOilPrice" value="' + toolsPrices.oil.toFixed(2) + '" step="0.01" min="0" oninput="recalcTools()">' +
                                '</div>' +
                                '<div class="price-field">' +
                                    '<label>Gas Price <span class="live-badge" id="toolsGasLive" style="display:none">Live</span></label>' +
                                    '<input type="number" id="toolsGasPrice" value="' + toolsPrices.gas.toFixed(2) + '" step="0.01" min="0" oninput="recalcTools()">' +
                                '</div>' +
                            '</div>' +
                            '<div class="price-timestamp" id="toolsPriceTimestamp"></div>' +
                            '<div class="deduction-row">' +
                                '<label>Post-Production Deductions <span class="tools-default-hint">(default 25% \u2014 varies by operator)</span></label>' +
                                '<input type="range" class="deduction-slider" id="toolsDeductionSlider" min="0" max="50" value="' + toolsDeduction + '" oninput="onDeductionChange(this.value)">' +
                                '<span class="deduction-val" id="toolsDeductionVal">' + toolsDeduction + '%</span>' +
                            '</div>' +
                        '</div>' +
                        '<div id="toolsNriArea"></div>' +
                    '</div>' +
                    '<div class="tools-summary-center" id="toolsWellCards"><div class="tools-wells-placeholder">Select a property to see wells</div></div>' +
                    '<div class="tools-summary-right" id="toolsPropertyTotal">' + buildTotalPlaceholder() + '</div>' +
                '</div>' +
                '<div class="tools-disclaimer" id="toolsDisclaimer" style="display:none">' +
                    'Estimates based on EIA spot prices multiplied by your decimal interest. Actual royalty checks may differ due to posted wellhead prices, operator deductions, production allocation, and payment timing.' +
                '</div>';

            renderToolsSelector();
        }

        // ── Selector Rendering ───────────────────────

        function renderToolsSelector() {
            var area = document.getElementById('toolsSelectorArea');
            if (!area) return;

            if (toolsMode === 'property') {
                renderPropertySelector(area);
            } else {
                renderWellSelector(area);
            }
        }

        function renderPropertySelector(area) {
            area.innerHTML =
                '<div class="tools-selector">' +
                    '<label>Property</label>' +
                    '<div class="tools-search-wrapper" id="toolsPropertySearchWrapper">' +
                        '<input type="text" class="tools-search-input" id="toolsPropertySearch"' +
                            ' placeholder="Search by county, section, township-range..."' +
                            ' autocomplete="off"' +
                            ' oninput="onToolsPropertySearchInput(this.value)"' +
                            ' onfocus="onToolsPropertySearchInput(this.value)"' +
                            ' onkeydown="onToolsSearchKeydown(event)">' +
                        '<div class="tools-search-clear" id="toolsPropertySearchClear" style="display:none"' +
                            ' onclick="clearToolsPropertySearch()">&times;</div>' +
                        '<div class="tools-search-dropdown" id="toolsPropertyDropdown" style="display:none"' +
                            ' onmousedown="event.stopPropagation()"></div>' +
                    '</div>' +
                '</div>';
        }

        function renderWellSelector(area) {
            area.innerHTML =
                '<div class="tools-selector">' +
                    '<label>Well</label>' +
                    '<div class="tools-search-wrapper" id="toolsWellSearchWrapper">' +
                        '<input type="text" class="tools-search-input" id="toolsWellSearch"' +
                            ' placeholder="Search by well name or API number..."' +
                            ' autocomplete="off"' +
                            ' oninput="onToolsWellSearchInput(this.value)"' +
                            ' onfocus="onToolsWellSearchInput(this.value)"' +
                            ' onkeydown="onToolsSearchKeydown(event)">' +
                        '<div class="tools-search-clear" id="toolsWellSearchClear" style="display:none"' +
                            ' onclick="clearToolsWellSearch()">&times;</div>' +
                        '<div class="tools-search-dropdown" id="toolsWellDropdown" style="display:none"' +
                            ' onmousedown="event.stopPropagation()"></div>' +
                    '</div>' +
                '</div>';
        }

        // ── TRS Formatting ───────────────────────────

        function formatTrs(f) {
            var twn = (f.TWN || '').replace(/^T/i, '');
            var rng = (f.RNG || '').replace(/^R/i, '');
            var sec = f.SEC || '';
            if (sec.length === 1) sec = '0' + sec;
            return twn + '-' + rng + '-' + sec;
        }

        function formatPropertyLabel(f) {
            return (f.COUNTY || 'Unknown') + ' ' + formatTrs(f);
        }

        // ── Property Search ──────────────────────────

        function onToolsPropertySearchInput(query) {
            var q = (query || '').toLowerCase().replace(/-/g, '');
            var clearBtn = document.getElementById('toolsPropertySearchClear');
            if (clearBtn) clearBtn.style.display = query ? 'block' : 'none';

            var withWells = [];
            var withoutWells = [];

            for (var i = 0; i < loadedProperties.length; i++) {
                var p = loadedProperties[i];
                var f = p.fields || {};

                var linked = p._linkedWells || 0;
                var trs = formatTrs(f);
                var label = formatPropertyLabel(f);
                var searchable = (label + ' ' + trs).toLowerCase().replace(/-/g, '');
                var dec = f.ri_decimal;

                if (q && searchable.indexOf(q) === -1) continue;

                var item = { id: p.id, label: label, linked: linked, dec: dec, type: 'property' };
                if (linked > 0) withWells.push(item);
                else withoutWells.push(item);
            }

            // Sort with-wells by well count descending (more wells = likely more active)
            withWells.sort(function(a, b) { return b.linked - a.linked; });
            withoutWells.sort(function(a, b) { return a.label.localeCompare(b.label); });

            // Build dropdown
            var dropdown = document.getElementById('toolsPropertyDropdown');
            if (!dropdown) return;

            toolsDropdownItems = [];
            toolsHighlightIndex = -1;
            var html = '';

            if (withWells.length > 0) {
                html += '<div class="tools-search-group-label">Properties with Wells</div>';
                var max = Math.min(withWells.length, 15);
                for (var j = 0; j < max; j++) {
                    var pw = withWells[j];
                    toolsDropdownItems.push(pw);
                    var idx = toolsDropdownItems.length - 1;
                    html += '<div class="tools-search-result" data-idx="' + idx + '" onclick="selectToolsProperty(' + idx + ')">' +
                        '<div class="result-main"><div class="result-legal">' + escapeHtml(pw.label) + '</div></div>' +
                        '<div class="result-badges">' +
                            (pw.dec ? '<span class="result-decimal">' + pw.dec + '</span>' : '') +
                            '<span class="result-wells">' + pw.linked + ' well' + (pw.linked !== 1 ? 's' : '') + '</span>' +
                        '</div></div>';
                }
            }

            if (withoutWells.length > 0) {
                html += '<div class="tools-search-group-label">Properties without Wells</div>';
                var maxW = Math.min(withoutWells.length, 5);
                for (var k = 0; k < maxW; k++) {
                    var pw2 = withoutWells[k];
                    toolsDropdownItems.push(pw2);
                    var idx2 = toolsDropdownItems.length - 1;
                    html += '<div class="tools-search-result disabled" data-idx="' + idx2 + '">' +
                        '<div class="result-main"><div class="result-legal" style="color:#A0AEC0">' + escapeHtml(pw2.label) + '</div></div>' +
                        '<div class="result-badges">' +
                            '<span class="result-no-wells">no wells</span>' +
                        '</div></div>';
                }
            }

            if (withWells.length === 0 && withoutWells.length === 0) {
                html = '<div class="tools-search-no-results">No properties found</div>';
            }

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        function selectToolsProperty(idx) {
            var item = toolsDropdownItems[idx];
            if (!item || item.linked === 0) return;

            toolsSelectedPropertyId = item.id;
            var input = document.getElementById('toolsPropertySearch');
            if (input) input.value = item.label;
            var clearBtn = document.getElementById('toolsPropertySearchClear');
            if (clearBtn) clearBtn.style.display = 'block';
            hideToolsDropdown();
            onToolsPropertyChange(item.id);
        }

        function clearToolsPropertySearch() {
            var input = document.getElementById('toolsPropertySearch');
            if (input) { input.value = ''; input.focus(); }
            var clearBtn = document.getElementById('toolsPropertySearchClear');
            if (clearBtn) clearBtn.style.display = 'none';
            toolsSelectedPropertyId = null;
            toolsPropertyData = null;
            toolsManualDecimal = null;
            toolsUnitDetailIdx = null;
            resetToolsPlaceholders();
            onToolsPropertySearchInput('');
        }

        // ── Well Search ──────────────────────────────

        function onToolsWellSearchInput(query) {
            var q = (query || '').toLowerCase().replace(/-/g, '');
            var clearBtn = document.getElementById('toolsWellSearchClear');
            if (clearBtn) clearBtn.style.display = query ? 'block' : 'none';

            var results = [];
            for (var i = 0; i < loadedWells.length; i++) {
                var w = loadedWells[i];
                var searchable = ((w.well_name || '') + ' ' + (w.operator || '') + ' ' + (w.apiNumber || '') + ' ' + (w.county || '')).toLowerCase().replace(/-/g, '');

                if (q && searchable.indexOf(q) === -1) continue;
                results.push({
                    id: w.id,
                    wellName: w.well_name || 'Unknown Well',
                    apiNumber: w.apiNumber || '',
                    operator: w.operator || '',
                    status: w.well_status || '',
                    county: w.county || '',
                    type: 'well'
                });
                if (results.length >= 20) break;
            }

            var dropdown = document.getElementById('toolsWellDropdown');
            if (!dropdown) return;

            toolsDropdownItems = results;
            toolsHighlightIndex = -1;
            var html = '';

            if (results.length === 0) {
                html = '<div class="tools-search-no-results">No wells found</div>';
            } else {
                for (var j = 0; j < results.length; j++) {
                    var r = results[j];
                    toolsDropdownItems[j] = r;
                    var opLabel = r.operator.length > 25 ? r.operator.substring(0, 25) + '...' : r.operator;
                    html += '<div class="tools-search-result" data-idx="' + j + '" onclick="selectToolsWell(' + j + ')">' +
                        '<div class="result-main">' +
                            '<div class="result-legal">' + escapeHtml(r.wellName) + '</div>' +
                            '<div class="result-sub">' + escapeHtml(opLabel) + (r.apiNumber ? ' &middot; ' + escapeHtml(r.apiNumber) : '') + '</div>' +
                        '</div>' +
                        '<div class="result-badges">' +
                            statusBadgeHtml(r.status) +
                        '</div></div>';
                }
            }

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        function selectToolsWell(idx) {
            var item = toolsDropdownItems[idx];
            if (!item) return;

            toolsSelectedWellId = item.id;
            var input = document.getElementById('toolsWellSearch');
            if (input) input.value = item.wellName;
            var clearBtn = document.getElementById('toolsWellSearchClear');
            if (clearBtn) clearBtn.style.display = 'block';
            hideToolsDropdown();
            onToolsWellChange(item.id);
        }

        function clearToolsWellSearch() {
            var input = document.getElementById('toolsWellSearch');
            if (input) { input.value = ''; input.focus(); }
            var clearBtn = document.getElementById('toolsWellSearchClear');
            if (clearBtn) clearBtn.style.display = 'none';
            toolsSelectedWellId = null;
            toolsWellData = null;
            toolsManualDecimal = null;
            resetToolsPlaceholders();
            onToolsWellSearchInput('');
        }

        // ── Keyboard Nav ─────────────────────────────

        function onToolsSearchKeydown(e) {
            var dropdown = document.getElementById('toolsPropertyDropdown') || document.getElementById('toolsWellDropdown');
            if (!dropdown || dropdown.style.display === 'none') return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                toolsHighlightIndex = Math.min(toolsHighlightIndex + 1, toolsDropdownItems.length - 1);
                updateToolsHighlight(dropdown);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                toolsHighlightIndex = Math.max(toolsHighlightIndex - 1, 0);
                updateToolsHighlight(dropdown);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (toolsHighlightIndex >= 0 && toolsHighlightIndex < toolsDropdownItems.length) {
                    if (toolsMode === 'property') selectToolsProperty(toolsHighlightIndex);
                    else selectToolsWell(toolsHighlightIndex);
                }
            } else if (e.key === 'Escape') {
                hideToolsDropdown();
            }
        }

        function updateToolsHighlight(dropdown) {
            var items = dropdown.querySelectorAll('.tools-search-result');
            for (var i = 0; i < items.length; i++) {
                var idx = parseInt(items[i].getAttribute('data-idx'), 10);
                if (idx === toolsHighlightIndex) {
                    items[i].classList.add('highlighted');
                    items[i].scrollIntoView({ block: 'nearest' });
                } else {
                    items[i].classList.remove('highlighted');
                }
            }
        }

        function hideToolsDropdown() {
            var d1 = document.getElementById('toolsPropertyDropdown');
            var d2 = document.getElementById('toolsWellDropdown');
            if (d1) d1.style.display = 'none';
            if (d2) d2.style.display = 'none';
            toolsHighlightIndex = -1;
        }

        // ── Drill-Down Navigation ────────────────────

        function drillDownToWell(wellId) {
            toolsUnitDetailIdx = null;
            // Find the well in loadedWells to get its name
            var wellName = '';
            for (var i = 0; i < loadedWells.length; i++) {
                if (loadedWells[i].id === wellId) {
                    wellName = loadedWells[i].well_name || 'Unknown Well';
                    break;
                }
            }

            // Save current property context for back navigation
            if (toolsSelectedPropertyId && toolsPropertyData) {
                var pf = toolsPropertyData.property || {};
                toolsDrilldownFrom = { id: toolsSelectedPropertyId, label: formatPropertyLabel(pf) };
            }

            // Switch to well mode
            toolsMode = 'well';
            toolsPropertyData = null;
            toolsWellData = null;
            toolsManualDecimal = null;
            toolsSelectedPropertyId = null;

            // Update toggle buttons
            var propBtn = document.getElementById('toolsModeProperty');
            var wellBtn = document.getElementById('toolsModeWell');
            if (propBtn) propBtn.className = 'mode-btn';
            if (wellBtn) wellBtn.className = 'mode-btn active';

            // Render well selector and pre-fill
            renderToolsSelector();
            var input = document.getElementById('toolsWellSearch');
            if (input) input.value = wellName;
            var clearBtn = document.getElementById('toolsWellSearchClear');
            if (clearBtn) clearBtn.style.display = 'block';

            // Fetch and display
            toolsSelectedWellId = wellId;
            onToolsWellChange(wellId);
        }

        function backToProperty() {
            if (!toolsDrilldownFrom) return;
            var propId = toolsDrilldownFrom.id;
            var propLabel = toolsDrilldownFrom.label;
            toolsDrilldownFrom = null;

            // Switch back to property mode
            toolsMode = 'property';
            toolsWellData = null;
            toolsManualDecimal = null;
            toolsSelectedWellId = null;

            // Update toggle buttons
            var propBtn = document.getElementById('toolsModeProperty');
            var wellBtn = document.getElementById('toolsModeWell');
            if (propBtn) propBtn.className = 'mode-btn active';
            if (wellBtn) wellBtn.className = 'mode-btn';

            // Render property selector and pre-fill
            renderToolsSelector();
            var input = document.getElementById('toolsPropertySearch');
            if (input) input.value = propLabel;
            var clearBtn = document.getElementById('toolsPropertySearchClear');
            if (clearBtn) clearBtn.style.display = 'block';

            // Re-fetch property data
            toolsSelectedPropertyId = propId;
            onToolsPropertyChange(propId);
        }

        // ── Unit Detail Drill-Down ─────────────────

        function drillDownToUnit(idx) {
            toolsUnitDetailIdx = idx;
            renderUnitDetail(idx);
        }

        function backFromUnitDetail() {
            toolsUnitDetailIdx = null;
            renderToolsResults();
        }

        function renderUnitDetail(idx) {
            var data = toolsPropertyData;
            if (!data || !data.sharedPunGroups || !data.sharedPunGroups[idx]) return;

            var cardsEl = document.getElementById('toolsWellCards');
            var totalEl = document.getElementById('toolsPropertyTotal');
            var disclaimerEl = document.getElementById('toolsDisclaimer');
            if (!cardsEl) return;

            var group = data.sharedPunGroups[idx];
            var prop = data.property || {};
            var decimal = toolsManualDecimal || prop.ri_decimal || null;
            var production = group.production || [];
            var trail = group.trailing3mo || {};
            var latest = production.length > 0 ? production[0] : null;
            var propLabel = formatPropertyLabel(prop);

            var html = '';

            // Back link
            html += '<a href="#" class="tools-back-link" onclick="backFromUnitDetail();return false">\u2190 Back to ' + escapeHtml(propLabel) + '</a>';

            // Unit header
            html += '<div class="unit-detail-header">' +
                '<div class="pun-card-label">Shared Production Unit</div>' +
                '<div class="unit-detail-wells">' + (group.wellNames || []).map(function(n) {
                    return '<span class="unit-well-tag">' + escapeHtml(n) + '</span>';
                }).join(' ') + '</div>' +
            '</div>';

            // Production history
            if (production.length > 0) {
                html += '<div class="unit-detail-table">' +
                    '<div class="unit-detail-row unit-detail-th">' +
                        '<span>Month</span><span>Oil (BBL)</span><span>Gas (MCF)</span>' +
                        (decimal ? '<span>Net Revenue</span>' : '') +
                    '</div>';
                for (var i = 0; i < production.length; i++) {
                    var p = production[i];
                    var rev = calcWellRevenue(p.oilBbl, p.gasMcf, decimal, null);
                    html += '<div class="unit-detail-row">' +
                        '<span class="month-label">' + formatYearMonth(p.yearMonth) + '</span>' +
                        '<span class="vol">' + fmtVol(p.oilBbl) + '</span>' +
                        '<span class="vol">' + fmtVol(p.gasMcf) + '</span>' +
                        (decimal ? '<span class="net">' + fmtMoney(rev.net) + '</span>' : '') +
                    '</div>';
                }
                html += '</div>';
            }

            // 3-month average
            if (trail.avgOilBbl || trail.avgGasMcf) {
                var revAvg = calcWellRevenue(trail.avgOilBbl || 0, trail.avgGasMcf || 0, decimal, null);
                html += '<div class="unit-detail-avg">' +
                    '<strong>3-Month Avg:</strong> ' +
                    '<span class="vol">' + fmtVol(trail.avgOilBbl) + ' BBL</span> + ' +
                    '<span class="vol">' + fmtVol(trail.avgGasMcf) + ' MCF</span>' +
                    (revAvg.net != null ? ' \u2192 <span class="net">' + fmtMoney(revAvg.net) + '/mo net</span>' : '') +
                '</div>';
            }

            cardsEl.innerHTML = html;

            // Right column total
            var revLatest = latest ? calcWellRevenue(latest.oilBbl, latest.gasMcf, decimal, null) : { gross: null, net: null };
            var revAvg2 = calcWellRevenue(trail.avgOilBbl || 0, trail.avgGasMcf || 0, decimal, null);

            if (totalEl && revLatest.gross != null) {
                var basisText = data.dataHorizon ? formatYearMonth(data.dataHorizon) + ' OTC data' : '';
                totalEl.innerHTML =
                    '<div class="property-total-v">' +
                        '<div class="ptv-header">Unit Revenue</div>' +
                        '<div class="ptv-block">' +
                            '<div class="ptv-label">Latest Month</div>' +
                            '<div class="ptv-gross">' + fmtMoney(revLatest.gross) + '</div>' +
                            '<div class="ptv-gross-label">Gross Revenue</div>' +
                            '<div class="ptv-net">' + fmtMoney(revLatest.net) + '</div>' +
                            '<div class="ptv-net-label">Net (' + toolsDeduction + '% deductions)</div>' +
                        '</div>' +
                        '<div class="ptv-divider"></div>' +
                        '<div class="ptv-block">' +
                            '<div class="ptv-label">3-Month Average</div>' +
                            '<div class="ptv-gross">' + fmtMoney(revAvg2.gross) + '</div>' +
                            '<div class="ptv-gross-label">Gross Revenue</div>' +
                            '<div class="ptv-net">' + fmtMoney(revAvg2.net) + '</div>' +
                            '<div class="ptv-net-label">Net (' + toolsDeduction + '% deductions)</div>' +
                        '</div>' +
                        (basisText ? '<div class="ptv-basis">' + basisText + '</div>' : '') +
                    '</div>';
            } else {
                if (totalEl) totalEl.innerHTML = buildTotalPlaceholder();
            }

            if (disclaimerEl) disclaimerEl.style.display = revLatest.gross != null ? 'block' : 'none';
        }

        // ── Prices ───────────────────────────────────

        async function fetchToolsPrices() {
            try {
                var res = await fetch('https://mymineralwatch.com/api/prices');
                if (!res.ok) return;
                var data = await res.json();

                if (data.wti && data.wti.price) {
                    toolsPrices.oil = data.wti.price;
                    var oilInput = document.getElementById('toolsOilPrice');
                    if (oilInput) oilInput.value = data.wti.price.toFixed(2);
                    var oilBadge = document.getElementById('toolsOilLive');
                    if (oilBadge) oilBadge.style.display = 'inline-block';
                }
                if (data.henryHub && data.henryHub.price) {
                    toolsPrices.gas = data.henryHub.price;
                    var gasInput = document.getElementById('toolsGasPrice');
                    if (gasInput) gasInput.value = data.henryHub.price.toFixed(2);
                    var gasBadge = document.getElementById('toolsGasLive');
                    if (gasBadge) gasBadge.style.display = 'inline-block';
                }

                var dateStr = (data.wti && data.wti.date) || (data.henryHub && data.henryHub.date) || null;
                var tsEl = document.getElementById('toolsPriceTimestamp');
                if (tsEl && dateStr) {
                    var parts = dateStr.split('-');
                    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    var formatted = months[parseInt(parts[1],10) - 1] + ' ' + parseInt(parts[2],10) + ', ' + parts[0];
                    tsEl.textContent = 'As of ' + formatted + ' \u00b7 U.S. Energy Information Administration';
                }

                recalcTools();
            } catch (err) {
                console.error('[Tools] Price fetch error:', err);
            }
        }

        // ── Data Fetching ────────────────────────────

        async function onToolsPropertyChange(propertyId) {
            toolsPropertyData = null;
            toolsManualDecimal = null;
            toolsAllocOverrides = {};
            var cardsEl = document.getElementById('toolsWellCards');
            var totalEl = document.getElementById('toolsPropertyTotal');
            var disclaimerEl = document.getElementById('toolsDisclaimer');

            if (!propertyId) {
                resetToolsPlaceholders();
                return;
            }

            if (cardsEl) cardsEl.innerHTML = '<div class="tools-loading">Loading production data...</div>';

            try {
                var res = await fetch('/api/tools/property-production?property_id=' + encodeURIComponent(propertyId));
                if (!res.ok) throw new Error('Failed to load');
                toolsPropertyData = await res.json();
                renderToolsResults();
            } catch (err) {
                if (cardsEl) cardsEl.innerHTML = '<div class="tools-empty"><p style="color:var(--error)">Error loading production data. Please try again.</p></div>';
                console.error('[Tools] Property production error:', err);
            }
        }

        async function onToolsWellChange(wellId) {
            toolsWellData = null;
            toolsManualDecimal = null;
            toolsAllocOverrides = {};
            var cardsEl = document.getElementById('toolsWellCards');
            var totalEl = document.getElementById('toolsPropertyTotal');
            var disclaimerEl = document.getElementById('toolsDisclaimer');

            if (!wellId) {
                resetToolsPlaceholders();
                return;
            }

            if (cardsEl) cardsEl.innerHTML = '<div class="tools-loading">Loading production data...</div>';

            try {
                var res = await fetch('/api/tools/well-production?well_id=' + encodeURIComponent(wellId));
                if (!res.ok) throw new Error('Failed to load');
                toolsWellData = await res.json();
                renderToolsWellResults();
            } catch (err) {
                if (cardsEl) cardsEl.innerHTML = '<div class="tools-empty"><p style="color:var(--error)">Error loading production data. Please try again.</p></div>';
                console.error('[Tools] Well production error:', err);
            }
        }

        // ── Shared Controls ──────────────────────────

        function onDeductionChange(val) {
            toolsDeduction = parseInt(val, 10);
            var valEl = document.getElementById('toolsDeductionVal');
            if (valEl) valEl.textContent = toolsDeduction + '%';
            recalcTools();
        }

        function onManualDecimalChange(val) {
            toolsManualDecimal = parseFloat(val) || null;
            recalcTools();
        }

        function calcNriFromInputs() {
            var acres = parseFloat(document.getElementById('toolsNriAcres').value) || 0;
            var unit = parseFloat(document.getElementById('toolsNriUnit').value) || 640;
            var royaltyEl = document.getElementById('toolsNriRoyalty');
            var royalty = 0;
            if (royaltyEl) {
                var val = royaltyEl.value;
                if (val.indexOf('/') > -1) {
                    var parts = val.split('/');
                    royalty = parseFloat(parts[0]) / parseFloat(parts[1]);
                } else {
                    royalty = parseFloat(val) || 0;
                }
            }
            if (acres > 0 && unit > 0 && royalty > 0) {
                var decimal = (acres * royalty) / unit;
                toolsManualDecimal = decimal;
                var resultEl = document.getElementById('toolsNriResult');
                if (resultEl) resultEl.textContent = decimal.toFixed(8).replace(/0+$/, '').replace(/\.$/, '');
                var resultRow = document.getElementById('toolsNriResultRow');
                if (resultRow) resultRow.style.display = 'flex';
                recalcTools();
            }
        }

        function recalcTools() {
            if (toolsMode === 'property' && toolsPropertyData) {
                if (toolsUnitDetailIdx !== null) {
                    renderUnitDetail(toolsUnitDetailIdx);
                } else {
                    renderToolsResults();
                }
            } else if (toolsMode === 'well' && toolsWellData) {
                renderToolsWellResults();
            }
        }

        // ── Formatting Helpers ───────────────────────

        function getOilPrice() {
            var el = document.getElementById('toolsOilPrice');
            return el ? (parseFloat(el.value) || 0) : toolsPrices.oil;
        }

        function getGasPrice() {
            var el = document.getElementById('toolsGasPrice');
            return el ? (parseFloat(el.value) || 0) : toolsPrices.gas;
        }

        function formatYearMonth(ym) {
            if (!ym || ym.length !== 6) return ym || '--';
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            var y = ym.substring(0, 4);
            var m = parseInt(ym.substring(4, 6), 10);
            return months[m - 1] + ' ' + y;
        }

        function fmtMoney(n) {
            if (n == null || isNaN(n)) return '--';
            return '$' + n.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function fmtVol(n) {
            if (n == null || isNaN(n)) return '0';
            return n.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        function statusBadgeHtml(status) {
            if (!status) return '<span class="status-badge status-unknown">Unknown</span>';
            var s = status.toUpperCase();
            if (s === 'AC' || s === 'ACTIVE') return '<span class="status-badge status-active">Active</span>';
            if (s === 'SI' || s === 'SHUT-IN' || s === 'SHUTIN') return '<span class="status-badge status-shutin">Shut-In</span>';
            if (s === 'PG' || s === 'PLUGGED' || s === 'P&A' || s === 'PA') return '<span class="status-badge status-plugged">Plugged</span>';
            if (s === 'TA') return '<span class="status-badge status-shutin">Temp. Abandoned</span>';
            return '<span class="status-badge status-unknown">' + escapeHtml(status) + '</span>';
        }

        function isShutIn(status) {
            if (!status) return false;
            var s = status.toUpperCase();
            return s === 'SI' || s === 'SHUT-IN' || s === 'SHUTIN' || s === 'PG' || s === 'PLUGGED' || s === 'P&A' || s === 'PA' || s === 'TA';
        }

        function calcWellRevenue(oilBbl, gasMcf, decimal, allocationPct) {
            if (!decimal) return { gross: null, net: null };
            var oilPrice = getOilPrice();
            var gasPrice = getGasPrice();
            var alloc = (allocationPct != null && allocationPct > 0) ? allocationPct : 1;
            var grossWell = (oilBbl * oilPrice + gasMcf * gasPrice) * alloc;
            var gross = grossWell * decimal;
            var net = gross * (1 - toolsDeduction / 100);
            return { gross: gross, net: net };
        }

        function getEffectiveDecimal(well) {
            if (well.interestDecimal) return well.interestDecimal;
            if (toolsManualDecimal) return toolsManualDecimal;
            return null;
        }

        function getWellIdForAlloc(well) {
            return well.wellId || well.id || '';
        }

        function getEffectiveAlloc(well) {
            var wid = getWellIdForAlloc(well);
            if (wid && toolsAllocOverrides[wid] != null) return toolsAllocOverrides[wid];
            if (well.allocationPct != null) return well.allocationPct;
            return null;
        }

        function onAllocChange(wellId, val) {
            var pct = parseFloat(val);
            if (isNaN(pct) || pct <= 0) {
                delete toolsAllocOverrides[wellId];
            } else if (pct >= 100) {
                delete toolsAllocOverrides[wellId];
            } else {
                toolsAllocOverrides[wellId] = pct / 100;
            }
            recalcTools();
        }

        function allocSourceLabel(source) {
            if (source === 'division_order') return 'from Division Order';
            if (source === 'multi_unit_horizontal_order') return 'from Multi-Unit Order';
            if (source === 'user') return 'manual';
            return '';
        }

        function buildAllocRowHtml(well) {
            var wid = getWellIdForAlloc(well);
            var alloc = getEffectiveAlloc(well);
            var pctVal = alloc != null ? (alloc * 100).toFixed(2) : '100';
            // Clean up trailing zeros: 65.00 → 65, 65.40 → 65.4
            pctVal = pctVal.replace(/\.?0+$/, '') || '100';
            var srcLabel = well.allocationSource ? allocSourceLabel(well.allocationSource) : '';
            if (wid && toolsAllocOverrides[wid] != null) srcLabel = '';
            return '<div class="well-alloc-row">' +
                '<label>Section Alloc:</label>' +
                '<input type="number" class="alloc-input" value="' + pctVal + '" min="0" max="100" step="0.01" ' +
                    'onchange="onAllocChange(\'' + wid + '\', this.value)">' +
                '<span class="alloc-pct">%</span>' +
                (srcLabel ? '<span class="alloc-source">' + srcLabel + '</span>' : '') +
                '</div>';
        }

        function fmtDecimal(d) {
            return d.toFixed(8).replace(/0+$/, '').replace(/\.$/, '');
        }

        var modalLinkSvg = '<svg viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/></svg>';

        // ── NRI Calculator HTML ──────────────────────

        function buildNriCalcHtml(prefillAcres) {
            return '<div class="nri-calc-inline" id="toolsNriCalcBox">' +
                '<div class="nri-calc-title">Calculate Your Decimal Interest</div>' +
                '<div class="nri-calc-subtitle">Enter your mineral interest details to see revenue estimates below.</div>' +
                '<div class="nri-calc-row">' +
                    '<div class="nri-calc-field">' +
                        '<label>Net Mineral Acres</label>' +
                        '<input type="number" id="toolsNriAcres" value="' + prefillAcres + '" step="any" min="0" placeholder="e.g. 10" oninput="calcNriFromInputs()">' +
                    '</div>' +
                    '<div class="nri-calc-field">' +
                        '<label>Unit Size (acres)</label>' +
                        '<select id="toolsNriUnit" onchange="calcNriFromInputs()">' +
                            '<option value="640" selected>640</option>' +
                            '<option value="1280">1280</option>' +
                        '</select>' +
                    '</div>' +
                    '<div class="nri-calc-field">' +
                        '<label>Royalty Rate</label>' +
                        '<select id="toolsNriRoyalty" onchange="calcNriFromInputs()">' +
                            '<option value="3/16" selected>3/16 (18.75%)</option>' +
                            '<option value="1/8">1/8 (12.5%)</option>' +
                            '<option value="1/5">1/5 (20%)</option>' +
                            '<option value="1/4">1/4 (25%)</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +
                '<div class="nri-calc-result-row" id="toolsNriResultRow" style="display:none">' +
                    '<span class="nri-calc-result-label">Your Decimal:</span>' +
                    '<span class="nri-calc-result-value" id="toolsNriResult"></span>' +
                    '<span class="nri-calc-default-note" id="toolsNriDefaultNote"></span>' +
                '</div>' +
                '<div class="nri-calc-or">or <a href="#" onclick="document.getElementById(\'toolsNriCalcBox\').style.display=\'none\';document.getElementById(\'toolsManualDecBox\').style.display=\'flex\';return false">enter a known decimal directly</a></div>' +
            '</div>' +
            '<div class="no-decimal-prompt" id="toolsManualDecBox" style="display:none; margin: 0 24px 12px">' +
                '<label>Decimal interest:</label>' +
                '<input type="text" id="toolsManualDecInput" placeholder="e.g. 0.00293" oninput="onManualDecimalChange(this.value)"' +
                (toolsManualDecimal ? ' value="' + toolsManualDecimal + '"' : '') + '>' +
                ' <a href="#" onclick="document.getElementById(\'toolsManualDecBox\').style.display=\'none\';document.getElementById(\'toolsNriCalcBox\').style.display=\'block\';return false" style="font-size:12px;color:var(--slate-blue)">use calculator</a>' +
            '</div>';
        }

        // ── Property Mode Results ────────────────────

        function renderToolsResults() {
            var data = toolsPropertyData;
            if (!data) return;

            var cardsEl = document.getElementById('toolsWellCards');
            var totalEl = document.getElementById('toolsPropertyTotal');
            var disclaimerEl = document.getElementById('toolsDisclaimer');
            if (!cardsEl || !totalEl) return;

            var prop = data.property;
            var wells = data.wells || [];
            var sharedGroups = data.sharedPunGroups || [];

            // Auto-calc decimal from property acres if no decimal is set
            var anyWellHasDecimal = wells.some(function(w) { return !!w.interestDecimal; });
            if (!prop.ri_decimal && !toolsManualDecimal && !anyWellHasDecimal) {
                var autoAcres = prop.ri_acres || prop.total_acres || prop.acres || 0;
                if (autoAcres > 0) {
                    toolsManualDecimal = (autoAcres * (3/16)) / 640;
                }
            }

            var noDecimal = !prop.ri_decimal && !anyWellHasDecimal;

            var nriArea = document.getElementById('toolsNriArea');

            // No wells
            if (wells.length === 0) {
                if (nriArea) {
                    if (noDecimal) {
                        nriArea.innerHTML = buildNriCalcHtml(prop.ri_acres || prop.total_acres || prop.acres || '');
                    } else {
                        nriArea.innerHTML = '';
                    }
                }
                totalEl.innerHTML = buildTotalPlaceholder();
                cardsEl.innerHTML = '<div class="tools-wells-placeholder">No linked wells found for this property</div>';
                if (disclaimerEl) disclaimerEl.style.display = 'none';
                return;
            }

            // ── Calculate totals first ──
            var totalGrossLatest = 0;
            var totalNetLatest = 0;
            var totalGrossAvg = 0;
            var totalNetAvg = 0;
            var hasAnyRevenue = false;

            // Shared PUN group totals
            for (var g = 0; g < sharedGroups.length; g++) {
                var group = sharedGroups[g];
                var gProd = group.production || [];
                var gLatest = gProd.length > 0 ? gProd[0] : null;
                var gTrail = group.trailing3mo || {};
                var gDecimal = toolsManualDecimal || prop.ri_decimal || null;
                var gRevLatest = gLatest ? calcWellRevenue(gLatest.oilBbl, gLatest.gasMcf, gDecimal, null) : { gross: null, net: null };
                var gRevAvg = calcWellRevenue(gTrail.avgOilBbl || 0, gTrail.avgGasMcf || 0, gDecimal, null);
                if (gRevLatest.gross != null) { totalGrossLatest += gRevLatest.gross; totalNetLatest += gRevLatest.net; hasAnyRevenue = true; }
                if (gRevAvg.gross != null) { totalGrossAvg += gRevAvg.gross; totalNetAvg += gRevAvg.net; }
            }

            // Individual well totals (sum across all interest types)
            for (var w = 0; w < wells.length; w++) {
                var well = wells[w];
                var prod = well.production || [];
                var latest = prod.length > 0 ? prod[0] : null;
                var trail = well.trailing3mo || {};
                var hasOwnProd = !well.sharedPun && latest;
                var wAlloc = getEffectiveAlloc(well);

                var wellInterests = well.interests || [];
                if (wellInterests.length > 1 && hasOwnProd) {
                    // Sum revenue across all interest types
                    for (var wi2 = 0; wi2 < wellInterests.length; wi2++) {
                        var wiRev = calcWellRevenue(latest.oilBbl, latest.gasMcf, wellInterests[wi2].decimal, wAlloc);
                        var wiRevAvg = calcWellRevenue(trail.avgOilBbl || 0, trail.avgGasMcf || 0, wellInterests[wi2].decimal, wAlloc);
                        if (wiRev.gross != null) { totalGrossLatest += wiRev.gross; totalNetLatest += wiRev.net; hasAnyRevenue = true; }
                        if (wiRevAvg.gross != null) { totalGrossAvg += wiRevAvg.gross; totalNetAvg += wiRevAvg.net; }
                    }
                } else {
                    // Single interest type — use primary decimal
                    var decimal = getEffectiveDecimal(well);
                    var revLatest = hasOwnProd ? calcWellRevenue(latest.oilBbl, latest.gasMcf, decimal, wAlloc) : { gross: null, net: null };
                    var revAvg = !well.sharedPun ? calcWellRevenue(trail.avgOilBbl || 0, trail.avgGasMcf || 0, decimal, wAlloc) : { gross: null, net: null };
                    if (revLatest.gross != null && !well.sharedPun) { totalGrossLatest += revLatest.gross; totalNetLatest += revLatest.net; hasAnyRevenue = true; }
                    if (revAvg.gross != null && !well.sharedPun) { totalGrossAvg += revAvg.gross; totalNetAvg += revAvg.net; }
                }
            }

            // ── NRI calculator (left column, below price bar) ──
            // Only rebuild if not already showing (preserves user's unit/royalty selections)
            if (nriArea) {
                if (noDecimal && !document.getElementById('toolsNriCalcBox')) {
                    nriArea.innerHTML = buildNriCalcHtml(prop.ri_acres || prop.total_acres || prop.acres || '');
                } else if (!noDecimal) {
                    nriArea.innerHTML = '';
                }
            }

            // ── Property total (right column, vertical layout) ──
            if (hasAnyRevenue) {
                var basisText = data.dataHorizon ? formatYearMonth(data.dataHorizon) + ' OTC data' : '';
                totalEl.innerHTML =
                    '<div class="property-total-v">' +
                        '<div class="ptv-header">Property Total</div>' +
                        '<div class="ptv-block">' +
                            '<div class="ptv-label">Latest Month</div>' +
                            '<div class="ptv-gross">' + fmtMoney(totalGrossLatest) + '</div>' +
                            '<div class="ptv-gross-label">Gross Revenue</div>' +
                            '<div class="ptv-net">' + fmtMoney(totalNetLatest) + '</div>' +
                            '<div class="ptv-net-label">Net (' + toolsDeduction + '% deductions)</div>' +
                        '</div>' +
                        '<div class="ptv-divider"></div>' +
                        '<div class="ptv-block">' +
                            '<div class="ptv-label">3-Month Average</div>' +
                            '<div class="ptv-gross">' + fmtMoney(totalGrossAvg) + '</div>' +
                            '<div class="ptv-gross-label">Gross Revenue</div>' +
                            '<div class="ptv-net">' + fmtMoney(totalNetAvg) + '</div>' +
                            '<div class="ptv-net-label">Net (' + toolsDeduction + '% deductions)</div>' +
                        '</div>' +
                        (basisText ? '<div class="ptv-basis">' + basisText + '</div>' : '') +
                        '<a href="#" class="ptv-link" onclick="openPropertyDetails(\'' + prop.id + '\');return false">View property details \u2192</a>' +
                    '</div>';
            } else {
                totalEl.innerHTML = buildTotalPlaceholder();
            }

            // Show NRI result if decimal was auto-calculated from property acres
            if (noDecimal && toolsManualDecimal) {
                var resEl = document.getElementById('toolsNriResult');
                if (resEl) resEl.textContent = fmtDecimal(toolsManualDecimal);
                var resRow = document.getElementById('toolsNriResultRow');
                if (resRow) resRow.style.display = 'flex';
                var noteEl = document.getElementById('toolsNriDefaultNote');
                if (noteEl) noteEl.textContent = 'Pre-filled from property acres using default unit size and royalty rate';
            }

            if (disclaimerEl) disclaimerEl.style.display = hasAnyRevenue ? 'block' : 'none';

            // ── Render well cards area (scrollable) ──
            var html = '';

            // Wells section header
            html += '<div class="tools-wells-header">' +
                '<span>' + wells.length + ' Well' + (wells.length !== 1 ? 's' : '') +
                (sharedGroups.length > 0 ? ' + ' + sharedGroups.length + ' Shared Unit' + (sharedGroups.length !== 1 ? 's' : '') : '') +
                '</span></div>';

            // Well cards grid (PUN groups + individual wells)
            html += '<div class="tools-well-grid">';

            // Shared PUN groups (compact, inside grid)
            for (var g2 = 0; g2 < sharedGroups.length; g2++) {
                var sg = sharedGroups[g2];
                var sgProd = sg.production || [];
                var sgLatest = sgProd.length > 0 ? sgProd[0] : null;
                var sgDecimal = toolsManualDecimal || prop.ri_decimal || null;
                var sgRevLatest = sgLatest ? calcWellRevenue(sgLatest.oilBbl, sgLatest.gasMcf, sgDecimal, null) : { gross: null, net: null };

                html += '<div class="pun-card">' +
                    '<div class="pun-card-label">Shared Unit</div>' +
                    '<div class="pun-card-wells">' + (sg.wellNames || []).map(escapeHtml).join(', ') + '</div>';

                if (sgLatest) {
                    html += '<div class="well-production"><span class="month-label">' + formatYearMonth(sgLatest.yearMonth) + ':</span> ' +
                        '<span class="vol">' + fmtVol(sgLatest.oilBbl) + ' BBL</span> + <span class="vol">' + fmtVol(sgLatest.gasMcf) + ' MCF</span></div>';
                }

                if (sgRevLatest.gross != null) {
                    html += '<div class="well-revenue"><span class="gross">' + fmtMoney(sgRevLatest.gross) + '</span> ' +
                        '<span class="arrow">\u2192</span> <span class="net">Net ' + fmtMoney(sgRevLatest.net) + '</span></div>';
                }

                html += '<a href="#" class="tools-drilldown-btn" onclick="drillDownToUnit(' + g2 + ');return false">Unit Revenue Detail \u2192</a>';
                html += '</div>';
            }
            for (var w2 = 0; w2 < wells.length; w2++) {
                var wl = wells[w2];
                var shutIn = isShutIn(wl.wellStatus);
                var wDecimal = getEffectiveDecimal(wl);

                var wProd = wl.production || [];
                var wLatest = wProd.length > 0 ? wProd[0] : null;
                var wTrail = wl.trailing3mo || {};

                var wHasOwnProd = !wl.sharedPun && wLatest;
                var wlAlloc = getEffectiveAlloc(wl);
                var wRevLatest = wHasOwnProd ? calcWellRevenue(wLatest.oilBbl, wLatest.gasMcf, wDecimal, wlAlloc) : { gross: null, net: null };

                // Build interest badges for all types
                var wInterests = wl.interests || [];
                var wBadgesHtml = statusBadgeHtml(wl.wellStatus);
                if (wInterests.length > 0) {
                    for (var ib = 0; ib < wInterests.length; ib++) {
                        var wi = wInterests[ib];
                        var wiLabel = interestSourceLabel({ interestSource: wi.source, interestSourceDate: wi.sourceDate });
                        wBadgesHtml += '<span class="interest-badge interest-badge-' + wi.type.toLowerCase() + '">' + wi.type + ' ' + fmtDecimal(wi.decimal) +
                            (wiLabel ? ' <span class="interest-source">' + wiLabel + '</span>' : '') + '</span>';
                    }
                } else if (wDecimal) {
                    var wSourceLabel = interestSourceLabel(wl);
                    wBadgesHtml += '<span class="interest-badge">' + fmtDecimal(wDecimal) + (wSourceLabel ? ' <span class="interest-source">' + wSourceLabel + '</span>' : '') + '</span>';
                }

                html += '<div class="well-card' + (shutIn ? ' shut-in' : '') + '">' +
                    '<div class="well-card-header">' +
                        '<div>' +
                            '<div class="well-card-name"><a href="#" class="well-name-link" onclick="openWellDetailsModal(\'' + wl.wellId + '\');return false">' + escapeHtml(wl.wellName) + '</a></div>' +
                            (wl.operator ? '<div class="well-card-operator"><a href="#" class="well-op-link" onclick="lookupAndOpenOperator(\'' + escapeHtml(wl.operator).replace(/'/g, '\\\'') + '\');return false">' + escapeHtml(wl.operator.length > 25 ? wl.operator.substring(0, 25) + '...' : wl.operator) + '</a></div>' : '') +
                        '</div>' +
                        '<div class="well-card-badges">' + wBadgesHtml + '</div>' +
                    '</div>' +
                    buildAllocRowHtml(wl);

                if (shutIn && !wLatest) {
                    html += '<div class="well-production">No recent production</div>';
                } else if (wl.sharedPun && !wLatest) {
                    html += '<div class="well-production" style="color:#975A16;font-size:12px">Production via shared unit above</div>';
                } else if (wLatest) {
                    html += '<div class="well-production"><span class="month-label">' + formatYearMonth(wLatest.yearMonth) + ':</span> ' +
                        '<span class="vol">' + fmtVol(wLatest.oilBbl) + ' BBL</span> + <span class="vol">' + fmtVol(wLatest.gasMcf) + ' MCF</span></div>';

                    // Show per-interest-type revenue breakdown if multiple types
                    if (wInterests.length > 1 && wHasOwnProd) {
                        html += '<div class="well-interest-breakdown">';
                        for (var ir = 0; ir < wInterests.length; ir++) {
                            var wir = wInterests[ir];
                            var wirRev = calcWellRevenue(wLatest.oilBbl, wLatest.gasMcf, wir.decimal, wlAlloc);
                            if (wirRev.gross != null) {
                                html += '<div class="interest-rev-line"><span class="interest-rev-type">' + wir.type + ':</span> ' +
                                    '<span class="net">' + fmtMoney(wirRev.net) + '/mo</span>' +
                                    (wir.type === 'WI' ? ' <span class="wi-note">before OpEx</span>' : '') + '</div>';
                            }
                        }
                        html += '</div>';
                    } else if (wRevLatest.gross != null) {
                        html += '<div class="well-revenue"><span class="gross">Gross: ' + fmtMoney(wRevLatest.gross) + '</span> ' +
                            '<span class="arrow">\u2192</span> <span class="net">Net: ' + fmtMoney(wRevLatest.net) + '</span></div>';
                    }
                } else {
                    html += '<div class="well-production" style="color:#A0AEC0">No production data</div>';
                }

                // Drill-down button
                html += '<a href="#" class="tools-drilldown-btn" onclick="drillDownToWell(\'' + wl.wellId + '\');return false">Well Revenue Detail \u2192</a>';

                html += '</div>';
            }
            html += '</div>'; // close grid

            cardsEl.innerHTML = html;
        }

        // ── Well Mode Results ────────────────────────

        function renderToolsWellResults() {
            var data = toolsWellData;
            if (!data) return;

            var cardsEl = document.getElementById('toolsWellCards');
            var totalEl = document.getElementById('toolsPropertyTotal');
            var disclaimerEl = document.getElementById('toolsDisclaimer');
            if (!cardsEl) return;

            var well = data.well || {};
            var linkedProp = data.linkedProperty;
            var production = data.production || [];
            var trail = data.trailing3mo || {};
            var nriArea = document.getElementById('toolsNriArea');

            // Determine decimal
            var decimal = well.interestDecimal || toolsManualDecimal || null;
            var noDecimal = !well.interestDecimal;

            // Auto-calc from linked property acres if no decimal set
            if (!decimal && linkedProp) {
                var autoAcres = linkedProp.ri_acres || linkedProp.total_acres || linkedProp.acres || 0;
                if (autoAcres > 0) {
                    toolsManualDecimal = (autoAcres * (3/16)) / 640;
                    decimal = toolsManualDecimal;
                }
            }

            // NRI calculator in the shared NRI area
            // Only rebuild if not already showing (preserves user's unit/royalty selections)
            if (nriArea) {
                if (noDecimal && !document.getElementById('toolsNriCalcBox')) {
                    var prefillAcres = '';
                    if (linkedProp) {
                        prefillAcres = linkedProp.ri_acres || linkedProp.total_acres || linkedProp.acres || '';
                    }
                    nriArea.innerHTML = buildNriCalcHtml(prefillAcres);
                } else if (!noDecimal) {
                    nriArea.innerHTML = '';
                }
            }

            var html = '';

            // Back-to-property link when drilled down from property mode
            if (toolsDrilldownFrom) {
                html += '<a href="#" class="tools-back-link" onclick="backToProperty();return false">\u2190 Back to ' + escapeHtml(toolsDrilldownFrom.label) + '</a>';
            }

            // Linked property badge
            if (linkedProp) {
                var propLabel = (linkedProp.county || '') + ' ' +
                    ((linkedProp.township || '').replace(/^T/i,'') || '') + '-' +
                    ((linkedProp.range || '').replace(/^R/i,'') || '') + '-' +
                    (linkedProp.section && linkedProp.section.length === 1 ? '0' + linkedProp.section : linkedProp.section || '');
                html += '<div class="tools-linked-property">' +
                    'Linked to property: <a href="#" onclick="openPropertyDetails(\'' + linkedProp.id + '\');return false">' + escapeHtml(propLabel) + '</a>' +
                    (linkedProp.ri_decimal ? ' &middot; Decimal: ' + linkedProp.ri_decimal : '') +
                '</div>';
            }

            // Well card (single, not in grid)
            var shutIn = isShutIn(well.wellStatus);
            var latest = production.length > 0 ? production[0] : null;
            var wmAlloc = getEffectiveAlloc(well);
            var revLatest = latest ? calcWellRevenue(latest.oilBbl, latest.gasMcf, decimal, wmAlloc) : { gross: null, net: null };
            var revAvg = calcWellRevenue(trail.avgOilBbl || 0, trail.avgGasMcf || 0, decimal, wmAlloc);

            // Build interest badges for well mode
            var wmInterests = well.interests || [];
            var wmBadgesHtml = statusBadgeHtml(well.wellStatus);
            if (wmInterests.length > 0) {
                for (var ib2 = 0; ib2 < wmInterests.length; ib2++) {
                    var wmi = wmInterests[ib2];
                    var wmiLabel = interestSourceLabel({ interestSource: wmi.source, interestSourceDate: wmi.sourceDate });
                    wmBadgesHtml += '<span class="interest-badge interest-badge-' + wmi.type.toLowerCase() + '">' + wmi.type + ' ' + fmtDecimal(wmi.decimal) +
                        (wmiLabel ? ' <span class="interest-source">' + wmiLabel + '</span>' : '') + '</span>';
                }
            } else if (decimal) {
                var sourceLabel = interestSourceLabel(well);
                wmBadgesHtml += '<span class="interest-badge">' + fmtDecimal(decimal) + (sourceLabel ? ' <span class="interest-source">' + sourceLabel + '</span>' : '') + '</span>';
            }

            html += '<div class="well-card well-card-single' + (shutIn ? ' shut-in' : '') + '">' +
                '<div class="well-card-header">' +
                    '<div>' +
                        '<div class="well-card-name"><a href="#" class="well-name-link" onclick="openWellDetailsModal(\'' + well.id + '\');return false">' + escapeHtml(well.wellName || 'Unknown Well') + '</a></div>' +
                        (well.operator ? '<div class="well-card-operator"><a href="#" class="well-op-link" onclick="lookupAndOpenOperator(\'' + escapeHtml(well.operator).replace(/'/g, '\\\'') + '\');return false">' + escapeHtml(well.operator.length > 25 ? well.operator.substring(0, 25) + '...' : well.operator) + '</a></div>' : '') +
                    '</div>' +
                    '<div class="well-card-badges">' + wmBadgesHtml + '</div>' +
                '</div>' +
                buildAllocRowHtml(well);

            if (shutIn && !latest) {
                html += '<div class="well-production">No recent production</div>';
            } else if (latest) {
                html += '<div class="well-production"><span class="month-label">' + formatYearMonth(latest.yearMonth) + ':</span> ' +
                    '<span class="vol">' + fmtVol(latest.oilBbl) + ' BBL</span> + <span class="vol">' + fmtVol(latest.gasMcf) + ' MCF</span></div>';

                // Multi-interest revenue breakdown
                if (wmInterests.length > 1) {
                    html += '<div class="well-interest-breakdown">';
                    for (var ir2 = 0; ir2 < wmInterests.length; ir2++) {
                        var wir2 = wmInterests[ir2];
                        var wir2Rev = calcWellRevenue(latest.oilBbl, latest.gasMcf, wir2.decimal, wmAlloc);
                        if (wir2Rev.gross != null) {
                            html += '<div class="interest-rev-line"><span class="interest-rev-type">' + wir2.type + ':</span> ' +
                                '<span class="gross">' + fmtMoney(wir2Rev.gross) + '</span> <span class="arrow">\u2192</span> ' +
                                '<span class="net">Net: ' + fmtMoney(wir2Rev.net) + '</span>' +
                                (wir2.type === 'WI' ? ' <span class="wi-note">before OpEx</span>' : '') + '</div>';
                        }
                    }
                    html += '</div>';
                } else if (revLatest.gross != null) {
                    html += '<div class="well-revenue"><span class="gross">Gross: ' + fmtMoney(revLatest.gross) + '</span> ' +
                        '<span class="arrow">\u2192</span> <span class="net">Net (' + toolsDeduction + '%): ' + fmtMoney(revLatest.net) + '</span></div>';
                }

                if (trail.avgOilBbl || trail.avgGasMcf) {
                    html += '<div class="well-revenue-avg">3-Mo Avg: ';
                    if (wmInterests.length > 1) {
                        // Show combined avg for multi-interest
                        var combinedAvgNet = 0;
                        for (var ia = 0; ia < wmInterests.length; ia++) {
                            var aRev = calcWellRevenue(trail.avgOilBbl || 0, trail.avgGasMcf || 0, wmInterests[ia].decimal, wmAlloc);
                            if (aRev.net != null) combinedAvgNet += aRev.net;
                        }
                        html += '<span class="net">Combined Net ' + fmtMoney(combinedAvgNet) + '/mo</span>';
                    } else if (revAvg.gross != null) {
                        html += '<span class="gross">Gross ' + fmtMoney(revAvg.gross) + '</span> <span class="arrow">\u2192</span> <span class="net">Net ' + fmtMoney(revAvg.net) + '</span>';
                    } else {
                        html += '<span class="vol">' + fmtVol(trail.avgOilBbl) + ' BBL + ' + fmtVol(trail.avgGasMcf) + ' MCF</span>';
                    }
                    html += '</div>';
                }
            } else {
                html += '<div class="well-production" style="color:#A0AEC0">No production data available</div>';
            }

            html += '</div>';
            cardsEl.innerHTML = html;

            // Show NRI result if decimal was auto-calculated
            if (noDecimal && toolsManualDecimal) {
                var resEl = document.getElementById('toolsNriResult');
                if (resEl) resEl.textContent = fmtDecimal(toolsManualDecimal);
                var resRow = document.getElementById('toolsNriResultRow');
                if (resRow) resRow.style.display = 'flex';
                var noteEl = document.getElementById('toolsNriDefaultNote');
                if (noteEl) noteEl.textContent = 'Pre-filled from property acres using default unit size and royalty rate';
            }

            // Show total for single well using vertical card
            if (totalEl && revLatest.gross != null) {
                var basisText = data.dataHorizon ? formatYearMonth(data.dataHorizon) + ' OTC data' : '';
                totalEl.innerHTML =
                    '<div class="property-total-v">' +
                        '<div class="ptv-header">Well Revenue</div>' +
                        '<div class="ptv-block">' +
                            '<div class="ptv-label">Latest Month</div>' +
                            '<div class="ptv-gross">' + fmtMoney(revLatest.gross) + '</div>' +
                            '<div class="ptv-gross-label">Gross Revenue</div>' +
                            '<div class="ptv-net">' + fmtMoney(revLatest.net) + '</div>' +
                            '<div class="ptv-net-label">Net (' + toolsDeduction + '% deductions)</div>' +
                        '</div>' +
                        '<div class="ptv-divider"></div>' +
                        '<div class="ptv-block">' +
                            '<div class="ptv-label">3-Month Average</div>' +
                            '<div class="ptv-gross">' + fmtMoney(revAvg.gross) + '</div>' +
                            '<div class="ptv-gross-label">Gross Revenue</div>' +
                            '<div class="ptv-net">' + fmtMoney(revAvg.net) + '</div>' +
                            '<div class="ptv-net-label">Net (' + toolsDeduction + '% deductions)</div>' +
                        '</div>' +
                        (basisText ? '<div class="ptv-basis">' + basisText + '</div>' : '') +
                        '<a href="#" class="ptv-link" onclick="openWellDetailsModal(\'' + well.id + '\');return false">View well details \u2192</a>' +
                    '</div>';
                if (disclaimerEl) disclaimerEl.style.display = 'block';
            } else {
                if (totalEl) totalEl.innerHTML = buildTotalPlaceholder();
                if (disclaimerEl) disclaimerEl.style.display = 'none';
            }
        }

        // ═══════════════════════════════════════════
        //  Revenue Estimate Modal (stacked on detail modals)
        // ═══════════════════════════════════════════

        var rmData = null;
        var rmType = null;
        var rmId = null;
        var rmDeduction = 25;
        var rmManualDecimal = null;
        var rmAllocOverrides = {};
        var rmLabel = '';
        var rmDrilldownIdx = null;
        var rmDrilldownUnitIdx = null;

        function rmCalcRevenue(oilBbl, gasMcf, decimal, allocationPct) {
            if (!decimal) return { gross: null, net: null };
            var oilPrice = toolsPrices.oil;
            var gasPrice = toolsPrices.gas;
            var alloc = (allocationPct != null && allocationPct > 0) ? allocationPct : 1;
            var grossWell = (oilBbl * oilPrice + gasMcf * gasPrice) * alloc;
            var gross = grossWell * decimal;
            var net = gross * (1 - rmDeduction / 100);
            return { gross: gross, net: net };
        }

        function rmGetEffectiveDecimal(well) {
            if (well.interestDecimal) return well.interestDecimal;
            if (rmManualDecimal) return rmManualDecimal;
            return null;
        }

        function rmGetEffectiveAlloc(well) {
            var wid = well.wellId || well.id || '';
            if (wid && rmAllocOverrides[wid] != null) return rmAllocOverrides[wid];
            if (well.allocationPct != null) return well.allocationPct;
            return null;
        }

        function rmOnAllocChange(wellId, val) {
            var pct = parseFloat(val);
            if (isNaN(pct) || pct <= 0) {
                delete rmAllocOverrides[wellId];
            } else if (pct >= 100) {
                delete rmAllocOverrides[wellId];
            } else {
                rmAllocOverrides[wellId] = pct / 100;
            }
            if (rmData) renderRevModalContent(rmType, rmData);
        }

        function rmDrillDownToWell(idx) {
            rmDrilldownIdx = idx;
            rmDrilldownUnitIdx = null;
            renderRevModalContent();
        }

        function rmDrillDownToUnit(idx) {
            rmDrilldownUnitIdx = idx;
            rmDrilldownIdx = null;
            renderRevModalContent();
        }

        function rmBackToOverview() {
            rmDrilldownIdx = null;
            rmDrilldownUnitIdx = null;
            renderRevModalContent();
        }

        function rmBuildAllocRowHtml(well) {
            var wid = well.wellId || well.id || '';
            var alloc = rmGetEffectiveAlloc(well);
            var pctVal = alloc != null ? (alloc * 100).toFixed(2) : '100';
            pctVal = pctVal.replace(/\.?0+$/, '') || '100';
            var srcLabel = well.allocationSource ? allocSourceLabel(well.allocationSource) : '';
            if (wid && rmAllocOverrides[wid] != null) srcLabel = '';
            return '<div class="well-alloc-row">' +
                '<label>Section Alloc:</label>' +
                '<input type="number" class="alloc-input" value="' + pctVal + '" min="0" max="100" step="0.01" ' +
                    'onchange="rmOnAllocChange(\'' + wid + '\', this.value)">' +
                '<span class="alloc-pct">%</span>' +
                (srcLabel ? '<span class="alloc-source">' + srcLabel + '</span>' : '') +
                '</div>';
        }

        async function openRevenueModal(type) {
            if (modalStack.length >= MAX_MODAL_DEPTH) {
                alert('Maximum modal depth reached. Please close some modals first.');
                return;
            }

            // Reset state
            rmData = null;
            rmManualDecimal = null;
            rmAllocOverrides = {};
            rmDeduction = 25;
            rmDrilldownIdx = null;
            rmDrilldownUnitIdx = null;

            // Get ID and label from the open detail modal
            var id, subtitle, themeClass;
            if (type === 'property') {
                id = document.getElementById('propertyDetailsId').value;
                var locEl = document.getElementById('propertyDetailsLocation');
                subtitle = locEl ? locEl.textContent : '';
                themeClass = 'property-theme';
                rmLabel = subtitle;
            } else {
                id = document.getElementById('wellDetailsId').value;
                var titleEl = document.getElementById('wellDetailsTitle');
                var apiEl = document.getElementById('wellDetailsApi');
                subtitle = (titleEl ? titleEl.textContent : '') + (apiEl ? ' \u00b7 ' + apiEl.textContent : '');
                themeClass = 'well-theme';
                rmLabel = titleEl ? titleEl.textContent : '';
            }

            if (!id) return;
            rmType = type;
            rmId = id;

            // Ensure prices are loaded
            if (!toolsPrices.date && !toolsPrices.source) {
                try {
                    var priceRes = await fetch('https://mymineralwatch.com/api/prices');
                    if (priceRes.ok) {
                        var priceData = await priceRes.json();
                        if (priceData.wti && priceData.wti.price) toolsPrices.oil = priceData.wti.price;
                        if (priceData.henryHub && priceData.henryHub.price) toolsPrices.gas = priceData.henryHub.price;
                        toolsPrices.date = (priceData.wti && priceData.wti.date) || null;
                        toolsPrices.source = 'EIA';
                    }
                } catch (e) { /* use defaults */ }
            }

            // Build modal
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.id = 'revenueEstimateModal';
            overlay.style.cssText = 'display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; background: rgba(0,0,0,0.5) !important; align-items: center !important; justify-content: center !important; padding: 20px !important;';

            var baseZIndex = 999999;
            var newZIndex = baseZIndex + (modalStack.length * 10);
            overlay.style.zIndex = String(newZIndex);

            // Price display text
            var priceText = '<span class="rm-price-item">Oil: $' + toolsPrices.oil.toFixed(2) + '/BBL</span>' +
                '<span class="rm-price-item">Gas: $' + toolsPrices.gas.toFixed(2) + '/MCF</span>';
            if (toolsPrices.date) {
                var dp = toolsPrices.date.split('-');
                var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                priceText += '<span class="rm-price-source">EIA ' + months[parseInt(dp[1],10)-1] + ' ' + parseInt(dp[2],10) + ', ' + dp[0] + '</span>';
            }

            overlay.innerHTML =
                '<div class="rev-modal" onclick="event.stopPropagation()">' +
                    '<div class="rev-modal-header ' + themeClass + '">' +
                        '<button class="close-btn" onclick="closeRevenueModal()">×</button>' +
                        '<h2>Revenue Estimate</h2>' +
                        '<div class="rev-modal-subtitle">' + escapeHtml(subtitle) + '</div>' +
                    '</div>' +
                    '<div class="rev-modal-body" id="rmBody">' +
                        '<div class="rev-modal-prices">' + priceText + '</div>' +
                        '<div class="rev-modal-deduction">' +
                            '<label>Deductions</label>' +
                            '<input type="range" id="rmDeductionSlider" min="0" max="50" value="25" oninput="rmOnDeductionChange(this.value)">' +
                            '<span class="rm-ded-val" id="rmDeductionVal">25%</span>' +
                        '</div>' +
                        '<div id="rmNriArea"></div>' +
                        '<div id="rmContent"><div class="tools-loading">Loading production data...</div></div>' +
                    '</div>' +
                    '<div class="rev-modal-footer">' +
                        '<button class="rm-open-tools ' + themeClass + '" onclick="rmOpenInToolsTab()">Open in Revenue Estimator \u2192</button>' +
                        '<button class="rm-close-link" onclick="closeRevenueModal()">Close</button>' +
                    '</div>' +
                '</div>';

            // Close on overlay click
            overlay.addEventListener('mousedown', function(e) {
                if (e.target === overlay) closeRevenueModal();
            });

            document.body.appendChild(overlay);
            modalStack.push({ type: 'revenue', id: id, element: overlay });

            // Fetch data
            try {
                var endpoint = type === 'property'
                    ? '/api/tools/property-production?property_id=' + encodeURIComponent(id)
                    : '/api/tools/well-production?well_id=' + encodeURIComponent(id);
                var res = await fetch(endpoint);
                if (!res.ok) throw new Error('Failed to load');
                rmData = await res.json();
                renderRevModalContent();
            } catch (err) {
                var contentEl = document.getElementById('rmContent');
                if (contentEl) contentEl.innerHTML = '<div class="rm-empty-state"><h3>Error loading data</h3><p>Could not load production data. Please try again.</p></div>';
                console.error('[RevModal] Error:', err);
            }
        }

        function closeRevenueModal() {
            var overlay = document.getElementById('revenueEstimateModal');
            if (overlay) {
                overlay.remove();
                var idx = modalStack.findIndex(function(m) { return m.element === overlay; });
                if (idx > -1) modalStack.splice(idx, 1);
            }
            rmData = null;
            rmType = null;
            rmId = null;
        }

        function rmOnDeductionChange(val) {
            rmDeduction = parseInt(val, 10);
            var valEl = document.getElementById('rmDeductionVal');
            if (valEl) valEl.textContent = rmDeduction + '%';
            if (rmData) renderRevModalContent();
        }

        function rmCalcNri() {
            var acres = parseFloat(document.getElementById('rmNriAcres').value) || 0;
            var unit = parseFloat(document.getElementById('rmNriUnit').value) || 640;
            var royaltyEl = document.getElementById('rmNriRoyalty');
            var royalty = 0;
            if (royaltyEl) {
                var val = royaltyEl.value;
                if (val.indexOf('/') > -1) {
                    var parts = val.split('/');
                    royalty = parseFloat(parts[0]) / parseFloat(parts[1]);
                } else {
                    royalty = parseFloat(val) || 0;
                }
            }
            if (acres > 0 && unit > 0 && royalty > 0) {
                rmManualDecimal = (acres * royalty) / unit;
                var resultEl = document.getElementById('rmNriResult');
                if (resultEl) resultEl.textContent = fmtDecimal(rmManualDecimal);
                var resultRow = document.getElementById('rmNriResultRow');
                if (resultRow) resultRow.style.display = 'flex';
                if (rmData) renderRevModalContent();
            }
        }

        function rmCalcManualProd() {
            var oilBbl = parseFloat(document.getElementById('rmManualOil').value) || 0;
            var gasMcf = parseFloat(document.getElementById('rmManualGas').value) || 0;
            var decimal = rmManualDecimal || (rmData && rmData.property ? rmData.property.ri_decimal : null) || null;
            var resultEl = document.getElementById('rmManualResult');
            if (!resultEl) return;

            if (!decimal || (oilBbl === 0 && gasMcf === 0)) {
                resultEl.style.display = 'none';
                return;
            }
            var rev = rmCalcRevenue(oilBbl, gasMcf, decimal, null);
            if (rev.gross != null) {
                resultEl.style.display = 'block';
                resultEl.innerHTML = 'Gross: ' + fmtMoney(rev.gross) + '/mo \u2192 Net: ' + fmtMoney(rev.net) + '/mo <span style="font-weight:400;font-size:12px;color:#666">(' + rmDeduction + '% deductions)</span>';
            } else {
                resultEl.style.display = 'none';
            }
        }

        function buildRmNriCalcHtml(prefillAcres) {
            return '<div class="nri-calc-inline" id="rmNriCalcBox">' +
                '<div class="nri-calc-title">Calculate Your Decimal Interest</div>' +
                '<div class="nri-calc-subtitle">Enter your mineral interest details to see revenue estimates.</div>' +
                '<div class="nri-calc-row">' +
                    '<div class="nri-calc-field">' +
                        '<label>Net Mineral Acres</label>' +
                        '<input type="number" id="rmNriAcres" value="' + prefillAcres + '" step="any" min="0" placeholder="e.g. 10" oninput="rmCalcNri()">' +
                    '</div>' +
                    '<div class="nri-calc-field">' +
                        '<label>Unit Size (acres)</label>' +
                        '<select id="rmNriUnit" onchange="rmCalcNri()">' +
                            '<option value="640" selected>640</option>' +
                            '<option value="1280">1280</option>' +
                        '</select>' +
                    '</div>' +
                    '<div class="nri-calc-field">' +
                        '<label>Royalty Rate</label>' +
                        '<select id="rmNriRoyalty" onchange="rmCalcNri()">' +
                            '<option value="3/16" selected>3/16 (18.75%)</option>' +
                            '<option value="1/8">1/8 (12.5%)</option>' +
                            '<option value="1/5">1/5 (20%)</option>' +
                            '<option value="1/4">1/4 (25%)</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +
                '<div class="nri-calc-result-row" id="rmNriResultRow" style="display:none">' +
                    '<span class="nri-calc-result-label">Your Decimal:</span>' +
                    '<span class="nri-calc-result-value" id="rmNriResult"></span>' +
                '</div>' +
            '</div>';
        }

        function renderRevModalContent() {
            if (!rmData) return;
            if (rmType === 'property') {
                renderRevModalProperty();
            } else {
                renderRevModalWell();
            }
        }

        function renderRevModalProperty() {
            var data = rmData;
            var contentEl = document.getElementById('rmContent');
            var nriArea = document.getElementById('rmNriArea');
            if (!contentEl) return;

            var prop = data.property;
            var wells = data.wells || [];
            var sharedGroups = data.sharedPunGroups || [];

            // Auto-calc decimal from property acres if no well has a decimal
            var anyWellHasDecimal = wells.some(function(w) { return !!w.interestDecimal; });
            if (!prop.ri_decimal && !rmManualDecimal && !anyWellHasDecimal) {
                var autoAcres = prop.ri_acres || prop.total_acres || prop.acres || 0;
                if (autoAcres > 0) {
                    rmManualDecimal = (autoAcres * (3/16)) / 640;
                }
            }
            var noDecimal = !prop.ri_decimal && !anyWellHasDecimal;

            // NRI calculator
            if (nriArea) {
                if (noDecimal && !document.getElementById('rmNriCalcBox')) {
                    nriArea.innerHTML = buildRmNriCalcHtml(prop.ri_acres || prop.total_acres || prop.acres || '');
                } else if (!noDecimal) {
                    nriArea.innerHTML = '';
                }
            }

            // ── Single-well drilldown view ──
            if (rmDrilldownIdx != null && wells[rmDrilldownIdx]) {
                var dw = wells[rmDrilldownIdx];
                var dwShutIn = isShutIn(dw.wellStatus);
                var dwDecimal = rmGetEffectiveDecimal(dw);
                var dwProd = dw.production || [];
                var dwLatest = dwProd.length > 0 ? dwProd[0] : null;
                var dwTrail = dw.trailing3mo || {};
                var dwAlloc = rmGetEffectiveAlloc(dw);
                var dwInts = dw.interests || [];
                var dwHasOwn = !dw.sharedPun && dwLatest;
                var dwRevLatest = dwHasOwn ? rmCalcRevenue(dwLatest.oilBbl, dwLatest.gasMcf, dwDecimal, dwAlloc) : { gross: null, net: null };
                var dwRevAvg = rmCalcRevenue(dwTrail.avgOilBbl || 0, dwTrail.avgGasMcf || 0, dwDecimal, dwAlloc);

                var dhtml = '<a href="#" class="tools-back-link" onclick="rmBackToOverview();return false">\u2190 Back to all wells</a>';

                // Badges
                var dwBadges = statusBadgeHtml(dw.wellStatus);
                if (dwInts.length > 0) {
                    for (var dib = 0; dib < dwInts.length; dib++) {
                        dwBadges += '<span class="interest-badge interest-badge-' + dwInts[dib].type.toLowerCase() + '">' + dwInts[dib].type + ' ' + fmtDecimal(dwInts[dib].decimal) + '</span>';
                    }
                } else if (dwDecimal) {
                    dwBadges += '<span class="interest-badge">' + fmtDecimal(dwDecimal) + '</span>';
                }

                dhtml += '<div class="well-card well-card-single' + (dwShutIn ? ' shut-in' : '') + '">' +
                    '<div class="well-card-header">' +
                        '<div>' +
                            '<div class="well-card-name">' + escapeHtml(dw.wellName || 'Unknown Well') + '</div>' +
                            (dw.operator ? '<div class="well-card-operator">' + escapeHtml(dw.operator) + '</div>' : '') +
                        '</div>' +
                        '<div class="well-card-badges">' + dwBadges + '</div>' +
                    '</div>' +
                    rmBuildAllocRowHtml(dw);

                if (dwShutIn && !dwLatest) {
                    dhtml += '<div class="well-production">No recent production</div>';
                } else if (dwLatest) {
                    dhtml += '<div class="well-production"><span class="month-label">' + formatYearMonth(dwLatest.yearMonth) + ':</span> ' +
                        '<span class="vol">' + fmtVol(dwLatest.oilBbl) + ' BBL</span> + <span class="vol">' + fmtVol(dwLatest.gasMcf) + ' MCF</span></div>';

                    // Multi-interest breakdown
                    if (dwInts.length > 1 && dwHasOwn) {
                        dhtml += '<div class="well-interest-breakdown">';
                        for (var dir = 0; dir < dwInts.length; dir++) {
                            var dirRev = rmCalcRevenue(dwLatest.oilBbl, dwLatest.gasMcf, dwInts[dir].decimal, dwAlloc);
                            if (dirRev.gross != null) {
                                dhtml += '<div class="interest-rev-line"><span class="interest-rev-type">' + dwInts[dir].type + ':</span> ' +
                                    '<span class="gross">' + fmtMoney(dirRev.gross) + '</span> <span class="arrow">\u2192</span> ' +
                                    '<span class="net">Net: ' + fmtMoney(dirRev.net) + '</span>' +
                                    (dwInts[dir].type === 'WI' ? ' <span class="wi-note">before OpEx</span>' : '') + '</div>';
                            }
                        }
                        dhtml += '</div>';
                    } else if (dwRevLatest.gross != null) {
                        dhtml += '<div class="well-revenue"><span class="gross">Gross: ' + fmtMoney(dwRevLatest.gross) + '</span> ' +
                            '<span class="arrow">\u2192</span> <span class="net">Net (' + rmDeduction + '%): ' + fmtMoney(dwRevLatest.net) + '</span></div>';
                    }

                    // 3-month average
                    if (dwTrail.avgOilBbl || dwTrail.avgGasMcf) {
                        dhtml += '<div class="well-revenue-avg">3-Mo Avg: ';
                        if (dwInts.length > 1) {
                            var dwCombAvg = 0;
                            for (var dia = 0; dia < dwInts.length; dia++) {
                                var diaRev = rmCalcRevenue(dwTrail.avgOilBbl || 0, dwTrail.avgGasMcf || 0, dwInts[dia].decimal, dwAlloc);
                                if (diaRev.net != null) dwCombAvg += diaRev.net;
                            }
                            dhtml += '<span class="net">Combined Net ' + fmtMoney(dwCombAvg) + '/mo</span>';
                        } else if (dwRevAvg.gross != null) {
                            dhtml += '<span class="gross">Gross ' + fmtMoney(dwRevAvg.gross) + '</span> <span class="arrow">\u2192</span> <span class="net">Net ' + fmtMoney(dwRevAvg.net) + '</span>';
                        } else {
                            dhtml += '<span class="vol">' + fmtVol(dwTrail.avgOilBbl) + ' BBL + ' + fmtVol(dwTrail.avgGasMcf) + ' MCF</span>';
                        }
                        dhtml += '</div>';
                    }
                } else {
                    dhtml += '<div class="well-production" style="color:#A0AEC0">No production data available</div>';
                }
                dhtml += '</div>';

                // Well revenue total block
                if (dwRevLatest.gross != null) {
                    var dwBasis = data.dataHorizon ? formatYearMonth(data.dataHorizon) + ' OTC data' : '';
                    dhtml += '<div class="property-total-v" style="margin-top:12px">' +
                        '<div class="ptv-header">Well Revenue</div>' +
                        '<div class="ptv-block">' +
                            '<div class="ptv-label">Latest Month</div>' +
                            '<div class="ptv-gross">' + fmtMoney(dwRevLatest.gross) + '</div>' +
                            '<div class="ptv-gross-label">Gross Revenue</div>' +
                            '<div class="ptv-net">' + fmtMoney(dwRevLatest.net) + '</div>' +
                            '<div class="ptv-net-label">Net (' + rmDeduction + '% deductions)</div>' +
                        '</div>' +
                        '<div class="ptv-divider"></div>' +
                        '<div class="ptv-block">' +
                            '<div class="ptv-label">3-Month Average</div>' +
                            '<div class="ptv-gross">' + fmtMoney(dwRevAvg.gross) + '</div>' +
                            '<div class="ptv-gross-label">Gross Revenue</div>' +
                            '<div class="ptv-net">' + fmtMoney(dwRevAvg.net) + '</div>' +
                            '<div class="ptv-net-label">Net (' + rmDeduction + '% deductions)</div>' +
                        '</div>' +
                        (dwBasis ? '<div class="ptv-basis">' + dwBasis + '</div>' : '') +
                    '</div>';
                }

                dhtml += '<div class="rm-disclaimer">Estimates based on EIA spot prices multiplied by your decimal interest. Actual royalty checks may differ due to posted wellhead prices, operator deductions, production allocation, and payment timing.</div>';
                contentEl.innerHTML = dhtml;
                if (noDecimal && rmManualDecimal) {
                    var resEl = document.getElementById('rmNriResult');
                    if (resEl) resEl.textContent = fmtDecimal(rmManualDecimal);
                    var resRow = document.getElementById('rmNriResultRow');
                    if (resRow) resRow.style.display = 'flex';
                }
                return;
            }

            // ── Shared unit drilldown view ──
            if (rmDrilldownUnitIdx != null && sharedGroups[rmDrilldownUnitIdx]) {
                var ug = sharedGroups[rmDrilldownUnitIdx];
                var ugDecimal = rmManualDecimal || prop.ri_decimal || null;
                var ugProd = ug.production || [];
                var ugLatest = ugProd.length > 0 ? ugProd[0] : null;
                var ugTrail = ug.trailing3mo || {};
                var ugRevLatest = ugLatest ? rmCalcRevenue(ugLatest.oilBbl, ugLatest.gasMcf, ugDecimal, null) : { gross: null, net: null };
                var ugRevAvg = rmCalcRevenue(ugTrail.avgOilBbl || 0, ugTrail.avgGasMcf || 0, ugDecimal, null);

                var uhtml = '<a href="#" class="tools-back-link" onclick="rmBackToOverview();return false">\u2190 Back to all wells</a>';

                // Unit header
                uhtml += '<div class="unit-detail-header">' +
                    '<div class="pun-card-label">Shared Production Unit</div>' +
                    '<div class="unit-detail-wells">' + (ug.wellNames || []).map(function(n) {
                        return '<span class="unit-well-tag">' + escapeHtml(n) + '</span>';
                    }).join(' ') + '</div>' +
                '</div>';

                // Production history table
                if (ugProd.length > 0) {
                    uhtml += '<div class="unit-detail-table">' +
                        '<div class="unit-detail-row unit-detail-th">' +
                            '<span>Month</span><span>Oil (BBL)</span><span>Gas (MCF)</span>' +
                            (ugDecimal ? '<span>Net Revenue</span>' : '') +
                        '</div>';
                    for (var ui = 0; ui < ugProd.length; ui++) {
                        var up = ugProd[ui];
                        var uRev = rmCalcRevenue(up.oilBbl, up.gasMcf, ugDecimal, null);
                        uhtml += '<div class="unit-detail-row">' +
                            '<span class="month-label">' + formatYearMonth(up.yearMonth) + '</span>' +
                            '<span class="vol">' + fmtVol(up.oilBbl) + '</span>' +
                            '<span class="vol">' + fmtVol(up.gasMcf) + '</span>' +
                            (ugDecimal ? '<span class="net">' + fmtMoney(uRev.net) + '</span>' : '') +
                        '</div>';
                    }
                    uhtml += '</div>';
                }

                // 3-month average
                if (ugTrail.avgOilBbl || ugTrail.avgGasMcf) {
                    uhtml += '<div class="unit-detail-avg">' +
                        '<strong>3-Month Avg:</strong> ' +
                        '<span class="vol">' + fmtVol(ugTrail.avgOilBbl) + ' BBL</span> + ' +
                        '<span class="vol">' + fmtVol(ugTrail.avgGasMcf) + ' MCF</span>' +
                        (ugRevAvg.net != null ? ' \u2192 <span class="net">' + fmtMoney(ugRevAvg.net) + '/mo net</span>' : '') +
                    '</div>';
                }

                // Unit revenue total block
                if (ugRevLatest.gross != null) {
                    var ugBasis = data.dataHorizon ? formatYearMonth(data.dataHorizon) + ' OTC data' : '';
                    uhtml += '<div class="property-total-v" style="margin-top:12px">' +
                        '<div class="ptv-header">Unit Revenue</div>' +
                        '<div class="ptv-block">' +
                            '<div class="ptv-label">Latest Month</div>' +
                            '<div class="ptv-gross">' + fmtMoney(ugRevLatest.gross) + '</div>' +
                            '<div class="ptv-gross-label">Gross Revenue</div>' +
                            '<div class="ptv-net">' + fmtMoney(ugRevLatest.net) + '</div>' +
                            '<div class="ptv-net-label">Net (' + rmDeduction + '% deductions)</div>' +
                        '</div>' +
                        '<div class="ptv-divider"></div>' +
                        '<div class="ptv-block">' +
                            '<div class="ptv-label">3-Month Average</div>' +
                            '<div class="ptv-gross">' + fmtMoney(ugRevAvg.gross) + '</div>' +
                            '<div class="ptv-gross-label">Gross Revenue</div>' +
                            '<div class="ptv-net">' + fmtMoney(ugRevAvg.net) + '</div>' +
                            '<div class="ptv-net-label">Net (' + rmDeduction + '% deductions)</div>' +
                        '</div>' +
                        (ugBasis ? '<div class="ptv-basis">' + ugBasis + '</div>' : '') +
                    '</div>';
                }

                uhtml += '<div class="rm-disclaimer">Estimates based on EIA spot prices multiplied by your decimal interest. Actual royalty checks may differ due to posted wellhead prices, operator deductions, production allocation, and payment timing.</div>';
                contentEl.innerHTML = uhtml;
                if (noDecimal && rmManualDecimal) {
                    var resEl = document.getElementById('rmNriResult');
                    if (resEl) resEl.textContent = fmtDecimal(rmManualDecimal);
                    var resRow = document.getElementById('rmNriResultRow');
                    if (resRow) resRow.style.display = 'flex';
                }
                return;
            }

            // No wells — fallback states
            if (wells.length === 0) {
                var hasDecimal = prop.ri_decimal || rmManualDecimal;
                var hasAcres = prop.ri_acres || prop.total_acres || prop.acres;
                if (hasDecimal || hasAcres) {
                    // Show manual production entry
                    contentEl.innerHTML =
                        '<div class="rm-manual-prod">' +
                            '<div class="rm-manual-prod-title">No linked wells</div>' +
                            '<div class="rm-manual-prod-hint">Enter estimated monthly production to see revenue.</div>' +
                            '<div class="rm-manual-prod-row">' +
                                '<div class="rm-manual-prod-field">' +
                                    '<label>Monthly Oil (BBL)</label>' +
                                    '<input type="number" id="rmManualOil" placeholder="e.g. 100" min="0" step="any" oninput="rmCalcManualProd()">' +
                                '</div>' +
                                '<div class="rm-manual-prod-field">' +
                                    '<label>Monthly Gas (MCF)</label>' +
                                    '<input type="number" id="rmManualGas" placeholder="e.g. 500" min="0" step="any" oninput="rmCalcManualProd()">' +
                                '</div>' +
                            '</div>' +
                            '<div class="rm-manual-prod-result" id="rmManualResult" style="display:none"></div>' +
                        '</div>' +
                        '<div class="rm-disclaimer">Estimates based on EIA spot prices multiplied by your decimal interest. Actual royalty checks may differ.</div>';
                } else {
                    contentEl.innerHTML =
                        '<div class="rm-empty-state">' +
                            '<h3>No linked wells or interest data</h3>' +
                            '<p>Link wells from the Properties tab to see production-based revenue estimates.</p>' +
                            '<button class="rm-empty-cta" onclick="closeRevenueModal();closePropertyDetailsModal();switchToTab(\'properties\')">Go to Properties</button>' +
                        '</div>';
                }
                // Show auto-calc result
                if (noDecimal && rmManualDecimal) {
                    var resEl = document.getElementById('rmNriResult');
                    if (resEl) resEl.textContent = fmtDecimal(rmManualDecimal);
                    var resRow = document.getElementById('rmNriResultRow');
                    if (resRow) resRow.style.display = 'flex';
                }
                return;
            }

            // ── Calculate totals ──
            var totalGrossLatest = 0, totalNetLatest = 0;
            var totalGrossAvg = 0, totalNetAvg = 0;
            var hasAnyRevenue = false;

            for (var g = 0; g < sharedGroups.length; g++) {
                var group = sharedGroups[g];
                var gProd = group.production || [];
                var gLatest = gProd.length > 0 ? gProd[0] : null;
                var gDecimal = rmManualDecimal || prop.ri_decimal || null;
                var gTrail = group.trailing3mo || {};
                var gRevLatest = gLatest ? rmCalcRevenue(gLatest.oilBbl, gLatest.gasMcf, gDecimal, null) : { gross: null, net: null };
                var gRevAvg = rmCalcRevenue(gTrail.avgOilBbl || 0, gTrail.avgGasMcf || 0, gDecimal, null);
                if (gRevLatest.gross != null) { totalGrossLatest += gRevLatest.gross; totalNetLatest += gRevLatest.net; hasAnyRevenue = true; }
                if (gRevAvg.gross != null) { totalGrossAvg += gRevAvg.gross; totalNetAvg += gRevAvg.net; }
            }

            for (var w = 0; w < wells.length; w++) {
                var well = wells[w];
                var prod = well.production || [];
                var latest = prod.length > 0 ? prod[0] : null;
                var trail = well.trailing3mo || {};
                var hasOwnProd = !well.sharedPun && latest;
                var wInterests = well.interests || [];
                var wAlloc = rmGetEffectiveAlloc(well);

                if (wInterests.length > 1 && hasOwnProd) {
                    for (var wi2 = 0; wi2 < wInterests.length; wi2++) {
                        var wiRev = rmCalcRevenue(latest.oilBbl, latest.gasMcf, wInterests[wi2].decimal, wAlloc);
                        var wiRevAvg = rmCalcRevenue(trail.avgOilBbl || 0, trail.avgGasMcf || 0, wInterests[wi2].decimal, wAlloc);
                        if (wiRev.gross != null) { totalGrossLatest += wiRev.gross; totalNetLatest += wiRev.net; hasAnyRevenue = true; }
                        if (wiRevAvg.gross != null) { totalGrossAvg += wiRevAvg.gross; totalNetAvg += wiRevAvg.net; }
                    }
                } else {
                    var decimal = rmGetEffectiveDecimal(well);
                    var revL = hasOwnProd ? rmCalcRevenue(latest.oilBbl, latest.gasMcf, decimal, wAlloc) : { gross: null, net: null };
                    var revA = !well.sharedPun ? rmCalcRevenue(trail.avgOilBbl || 0, trail.avgGasMcf || 0, decimal, wAlloc) : { gross: null, net: null };
                    if (revL.gross != null && !well.sharedPun) { totalGrossLatest += revL.gross; totalNetLatest += revL.net; hasAnyRevenue = true; }
                    if (revA.gross != null && !well.sharedPun) { totalGrossAvg += revA.gross; totalNetAvg += revA.net; }
                }
            }

            var html = '';

            // Wells header
            html += '<div class="rm-wells-header">' + wells.length + ' Well' + (wells.length !== 1 ? 's' : '') +
                (sharedGroups.length > 0 ? ' + ' + sharedGroups.length + ' Shared Unit' + (sharedGroups.length !== 1 ? 's' : '') : '') + '</div>';

            // Well cards grid
            html += '<div class="tools-well-grid">';

            // Shared PUN groups
            for (var g2 = 0; g2 < sharedGroups.length; g2++) {
                var sg = sharedGroups[g2];
                var sgProd = sg.production || [];
                var sgLatest = sgProd.length > 0 ? sgProd[0] : null;
                var sgDecimal = rmManualDecimal || prop.ri_decimal || null;
                var sgRevLatest = sgLatest ? rmCalcRevenue(sgLatest.oilBbl, sgLatest.gasMcf, sgDecimal, null) : { gross: null, net: null };

                html += '<div class="pun-card">' +
                    '<div class="pun-card-label">Shared Unit</div>' +
                    '<div class="pun-card-wells">' + (sg.wellNames || []).map(escapeHtml).join(', ') + '</div>';
                if (sgLatest) {
                    html += '<div class="well-production"><span class="month-label">' + formatYearMonth(sgLatest.yearMonth) + ':</span> ' +
                        '<span class="vol">' + fmtVol(sgLatest.oilBbl) + ' BBL</span> + <span class="vol">' + fmtVol(sgLatest.gasMcf) + ' MCF</span></div>';
                }
                if (sgRevLatest.gross != null) {
                    html += '<div class="well-revenue"><span class="gross">' + fmtMoney(sgRevLatest.gross) + '</span> <span class="arrow">\u2192</span> <span class="net">Net ' + fmtMoney(sgRevLatest.net) + '</span></div>';
                }
                html += '<a href="#" class="tools-drilldown-btn" onclick="rmDrillDownToUnit(' + g2 + ');return false">Unit Revenue Detail \u2192</a>';
                html += '</div>';
            }

            // Individual wells
            for (var w2 = 0; w2 < wells.length; w2++) {
                var wl = wells[w2];
                var shutIn = isShutIn(wl.wellStatus);
                var wDecimal = rmGetEffectiveDecimal(wl);
                var wProd = wl.production || [];
                var wLatest = wProd.length > 0 ? wProd[0] : null;
                var wHasOwnProd = !wl.sharedPun && wLatest;
                var wlAlloc = rmGetEffectiveAlloc(wl);
                var wRevLatest = wHasOwnProd ? rmCalcRevenue(wLatest.oilBbl, wLatest.gasMcf, wDecimal, wlAlloc) : { gross: null, net: null };

                var wInts = wl.interests || [];
                var badgesHtml = statusBadgeHtml(wl.wellStatus);
                if (wInts.length > 0) {
                    for (var ib = 0; ib < wInts.length; ib++) {
                        var wi = wInts[ib];
                        badgesHtml += '<span class="interest-badge interest-badge-' + wi.type.toLowerCase() + '">' + wi.type + ' ' + fmtDecimal(wi.decimal) + '</span>';
                    }
                } else if (wDecimal) {
                    badgesHtml += '<span class="interest-badge">' + fmtDecimal(wDecimal) + '</span>';
                }

                html += '<div class="well-card' + (shutIn ? ' shut-in' : '') + '">' +
                    '<div class="well-card-header">' +
                        '<div>' +
                            '<div class="well-card-name">' + escapeHtml(wl.wellName) + '</div>' +
                            (wl.operator ? '<div class="well-card-operator">' + escapeHtml(wl.operator.length > 25 ? wl.operator.substring(0, 25) + '...' : wl.operator) + '</div>' : '') +
                        '</div>' +
                        '<div class="well-card-badges">' + badgesHtml + '</div>' +
                    '</div>' +
                    rmBuildAllocRowHtml(wl);

                if (shutIn && !wLatest) {
                    html += '<div class="well-production">No recent production</div>';
                } else if (wl.sharedPun && !wLatest) {
                    html += '<div class="well-production" style="color:#975A16;font-size:12px">Production via shared unit above</div>';
                } else if (wLatest) {
                    html += '<div class="well-production"><span class="month-label">' + formatYearMonth(wLatest.yearMonth) + ':</span> ' +
                        '<span class="vol">' + fmtVol(wLatest.oilBbl) + ' BBL</span> + <span class="vol">' + fmtVol(wLatest.gasMcf) + ' MCF</span></div>';
                    if (wInts.length > 1 && wHasOwnProd) {
                        html += '<div class="well-interest-breakdown">';
                        for (var ir = 0; ir < wInts.length; ir++) {
                            var wirRev = rmCalcRevenue(wLatest.oilBbl, wLatest.gasMcf, wInts[ir].decimal, wlAlloc);
                            if (wirRev.gross != null) {
                                html += '<div class="interest-rev-line"><span class="interest-rev-type">' + wInts[ir].type + ':</span> <span class="net">' + fmtMoney(wirRev.net) + '/mo</span>' +
                                    (wInts[ir].type === 'WI' ? ' <span class="wi-note">before OpEx</span>' : '') + '</div>';
                            }
                        }
                        html += '</div>';
                    } else if (wRevLatest.gross != null) {
                        html += '<div class="well-revenue"><span class="gross">' + fmtMoney(wRevLatest.gross) + '</span> <span class="arrow">\u2192</span> <span class="net">Net ' + fmtMoney(wRevLatest.net) + '</span></div>';
                    }
                } else {
                    html += '<div class="well-production" style="color:#A0AEC0">No production data</div>';
                }
                html += '<a href="#" class="tools-drilldown-btn" onclick="rmDrillDownToWell(' + w2 + ');return false">Well Revenue Detail \u2192</a>';
                html += '</div>';
            }
            html += '</div>'; // close grid

            // Property total
            if (hasAnyRevenue) {
                var basisText = data.dataHorizon ? formatYearMonth(data.dataHorizon) + ' OTC data' : '';
                html += '<div class="property-total-v" style="margin-top:12px">' +
                    '<div class="ptv-header">Property Total</div>' +
                    '<div class="ptv-block">' +
                        '<div class="ptv-label">Latest Month</div>' +
                        '<div class="ptv-gross">' + fmtMoney(totalGrossLatest) + '</div>' +
                        '<div class="ptv-gross-label">Gross Revenue</div>' +
                        '<div class="ptv-net">' + fmtMoney(totalNetLatest) + '</div>' +
                        '<div class="ptv-net-label">Net (' + rmDeduction + '% deductions)</div>' +
                    '</div>' +
                    '<div class="ptv-divider"></div>' +
                    '<div class="ptv-block">' +
                        '<div class="ptv-label">3-Month Average</div>' +
                        '<div class="ptv-gross">' + fmtMoney(totalGrossAvg) + '</div>' +
                        '<div class="ptv-gross-label">Gross Revenue</div>' +
                        '<div class="ptv-net">' + fmtMoney(totalNetAvg) + '</div>' +
                        '<div class="ptv-net-label">Net (' + rmDeduction + '% deductions)</div>' +
                    '</div>' +
                    (basisText ? '<div class="ptv-basis">' + basisText + '</div>' : '') +
                '</div>';
            }

            html += '<div class="rm-disclaimer">Estimates based on EIA spot prices multiplied by your decimal interest. Actual royalty checks may differ due to posted wellhead prices, operator deductions, production allocation, and payment timing.</div>';

            contentEl.innerHTML = html;

            // Show auto-calc NRI result
            if (noDecimal && rmManualDecimal) {
                var resEl = document.getElementById('rmNriResult');
                if (resEl) resEl.textContent = fmtDecimal(rmManualDecimal);
                var resRow = document.getElementById('rmNriResultRow');
                if (resRow) resRow.style.display = 'flex';
            }
        }

        function renderRevModalWell() {
            var data = rmData;
            var contentEl = document.getElementById('rmContent');
            var nriArea = document.getElementById('rmNriArea');
            if (!contentEl) return;

            var well = data.well || {};
            var linkedProp = data.linkedProperty;
            var production = data.production || [];
            var trail = data.trailing3mo || {};

            // Determine decimal
            var decimal = well.interestDecimal || rmManualDecimal || null;
            var noDecimal = !well.interestDecimal;

            // Auto-calc from linked property acres
            if (!decimal && linkedProp) {
                var autoAcres = linkedProp.ri_acres || linkedProp.total_acres || linkedProp.acres || 0;
                if (autoAcres > 0) {
                    rmManualDecimal = (autoAcres * (3/16)) / 640;
                    decimal = rmManualDecimal;
                }
            }

            // NRI calculator
            if (nriArea) {
                if (noDecimal && !document.getElementById('rmNriCalcBox')) {
                    var prefillAcres = linkedProp ? (linkedProp.ri_acres || linkedProp.total_acres || linkedProp.acres || '') : '';
                    nriArea.innerHTML = buildRmNriCalcHtml(prefillAcres);
                } else if (!noDecimal) {
                    nriArea.innerHTML = '';
                }
            }

            var html = '';
            var latest = production.length > 0 ? production[0] : null;
            var wmAlloc = rmGetEffectiveAlloc(well);
            var revLatest = latest ? rmCalcRevenue(latest.oilBbl, latest.gasMcf, decimal, wmAlloc) : { gross: null, net: null };
            var revAvg = rmCalcRevenue(trail.avgOilBbl || 0, trail.avgGasMcf || 0, decimal, wmAlloc);

            // Linked property badge
            if (linkedProp) {
                var propLabel = (linkedProp.county || '') + ' ' +
                    ((linkedProp.township || '').replace(/^T/i,'') || '') + '-' +
                    ((linkedProp.range || '').replace(/^R/i,'') || '') + '-' +
                    (linkedProp.section && linkedProp.section.length === 1 ? '0' + linkedProp.section : linkedProp.section || '');
                html += '<div class="tools-linked-property" style="margin-bottom:12px">' +
                    'Linked to property: ' + escapeHtml(propLabel) +
                    (linkedProp.ri_decimal ? ' \u00b7 Decimal: ' + linkedProp.ri_decimal : '') +
                '</div>';
            }

            // Well card
            var shutIn = isShutIn(well.wellStatus);
            var wmInterests = well.interests || [];
            var badgesHtml = statusBadgeHtml(well.wellStatus);
            if (wmInterests.length > 0) {
                for (var ib = 0; ib < wmInterests.length; ib++) {
                    var wmi = wmInterests[ib];
                    badgesHtml += '<span class="interest-badge interest-badge-' + wmi.type.toLowerCase() + '">' + wmi.type + ' ' + fmtDecimal(wmi.decimal) + '</span>';
                }
            } else if (decimal) {
                badgesHtml += '<span class="interest-badge">' + fmtDecimal(decimal) + '</span>';
            }

            html += '<div class="well-card well-card-single' + (shutIn ? ' shut-in' : '') + '">' +
                '<div class="well-card-header">' +
                    '<div>' +
                        '<div class="well-card-name">' + escapeHtml(well.wellName || 'Unknown Well') + '</div>' +
                        (well.operator ? '<div class="well-card-operator">' + escapeHtml(well.operator.length > 25 ? well.operator.substring(0, 25) + '...' : well.operator) + '</div>' : '') +
                    '</div>' +
                    '<div class="well-card-badges">' + badgesHtml + '</div>' +
                '</div>' +
                rmBuildAllocRowHtml(well);

            if (shutIn && !latest) {
                html += '<div class="well-production">No recent production</div>';
            } else if (latest) {
                html += '<div class="well-production"><span class="month-label">' + formatYearMonth(latest.yearMonth) + ':</span> ' +
                    '<span class="vol">' + fmtVol(latest.oilBbl) + ' BBL</span> + <span class="vol">' + fmtVol(latest.gasMcf) + ' MCF</span></div>';
                if (wmInterests.length > 1) {
                    html += '<div class="well-interest-breakdown">';
                    for (var ir = 0; ir < wmInterests.length; ir++) {
                        var wirRev = rmCalcRevenue(latest.oilBbl, latest.gasMcf, wmInterests[ir].decimal, wmAlloc);
                        if (wirRev.gross != null) {
                            html += '<div class="interest-rev-line"><span class="interest-rev-type">' + wmInterests[ir].type + ':</span> <span class="gross">' + fmtMoney(wirRev.gross) + '</span> <span class="arrow">\u2192</span> <span class="net">Net: ' + fmtMoney(wirRev.net) + '</span>' +
                                (wmInterests[ir].type === 'WI' ? ' <span class="wi-note">before OpEx</span>' : '') + '</div>';
                        }
                    }
                    html += '</div>';
                } else if (revLatest.gross != null) {
                    html += '<div class="well-revenue"><span class="gross">Gross: ' + fmtMoney(revLatest.gross) + '</span> <span class="arrow">\u2192</span> <span class="net">Net: ' + fmtMoney(revLatest.net) + '</span></div>';
                }
                if (trail.avgOilBbl || trail.avgGasMcf) {
                    html += '<div class="well-revenue-avg">3-Mo Avg: ';
                    if (revAvg.gross != null) {
                        html += '<span class="gross">Gross ' + fmtMoney(revAvg.gross) + '</span> <span class="arrow">\u2192</span> <span class="net">Net ' + fmtMoney(revAvg.net) + '</span>';
                    } else {
                        html += '<span class="vol">' + fmtVol(trail.avgOilBbl) + ' BBL + ' + fmtVol(trail.avgGasMcf) + ' MCF</span>';
                    }
                    html += '</div>';
                }
            } else {
                // No production — show manual entry if we have a decimal
                if (decimal) {
                    html += '<div class="well-production" style="color:#A0AEC0;margin-bottom:8px">No production data available</div>';
                    html += '</div>'; // close well card
                    html += '<div class="rm-manual-prod">' +
                        '<div class="rm-manual-prod-title">Enter estimated production</div>' +
                        '<div class="rm-manual-prod-row">' +
                            '<div class="rm-manual-prod-field">' +
                                '<label>Monthly Oil (BBL)</label>' +
                                '<input type="number" id="rmManualOil" placeholder="e.g. 100" min="0" step="any" oninput="rmCalcManualProd()">' +
                            '</div>' +
                            '<div class="rm-manual-prod-field">' +
                                '<label>Monthly Gas (MCF)</label>' +
                                '<input type="number" id="rmManualGas" placeholder="e.g. 500" min="0" step="any" oninput="rmCalcManualProd()">' +
                            '</div>' +
                        '</div>' +
                        '<div class="rm-manual-prod-result" id="rmManualResult" style="display:none"></div>' +
                    '</div>';
                    html += '<div class="rm-disclaimer">Estimates based on EIA spot prices multiplied by your decimal interest. Actual royalty checks may differ.</div>';
                    contentEl.innerHTML = html;
                    if (noDecimal && rmManualDecimal) {
                        var resEl = document.getElementById('rmNriResult');
                        if (resEl) resEl.textContent = fmtDecimal(rmManualDecimal);
                        var resRow = document.getElementById('rmNriResultRow');
                        if (resRow) resRow.style.display = 'flex';
                    }
                    return;
                }
                html += '<div class="well-production" style="color:#A0AEC0">No production data available</div>';
            }

            html += '</div>'; // close well card

            // Revenue total
            if (revLatest.gross != null) {
                var basisText = data.dataHorizon ? formatYearMonth(data.dataHorizon) + ' OTC data' : '';
                html += '<div class="property-total-v" style="margin-top:12px">' +
                    '<div class="ptv-header">Well Revenue</div>' +
                    '<div class="ptv-block">' +
                        '<div class="ptv-label">Latest Month</div>' +
                        '<div class="ptv-gross">' + fmtMoney(revLatest.gross) + '</div>' +
                        '<div class="ptv-gross-label">Gross Revenue</div>' +
                        '<div class="ptv-net">' + fmtMoney(revLatest.net) + '</div>' +
                        '<div class="ptv-net-label">Net (' + rmDeduction + '% deductions)</div>' +
                    '</div>' +
                    '<div class="ptv-divider"></div>' +
                    '<div class="ptv-block">' +
                        '<div class="ptv-label">3-Month Average</div>' +
                        '<div class="ptv-gross">' + fmtMoney(revAvg.gross) + '</div>' +
                        '<div class="ptv-gross-label">Gross Revenue</div>' +
                        '<div class="ptv-net">' + fmtMoney(revAvg.net) + '</div>' +
                        '<div class="ptv-net-label">Net (' + rmDeduction + '% deductions)</div>' +
                    '</div>' +
                    (basisText ? '<div class="ptv-basis">' + basisText + '</div>' : '') +
                '</div>';
            }

            html += '<div class="rm-disclaimer">Estimates based on EIA spot prices multiplied by your decimal interest. Actual royalty checks may differ due to posted wellhead prices, operator deductions, production allocation, and payment timing.</div>';

            contentEl.innerHTML = html;

            if (noDecimal && rmManualDecimal) {
                var resEl2 = document.getElementById('rmNriResult');
                if (resEl2) resEl2.textContent = fmtDecimal(rmManualDecimal);
                var resRow2 = document.getElementById('rmNriResultRow');
                if (resRow2) resRow2.style.display = 'flex';
            }
        }

        async function rmOpenInToolsTab() {
            var type = rmType;
            var id = rmId;
            var label = rmLabel;

            // Close revenue modal
            closeRevenueModal();

            // Close detail modal underneath
            if (type === 'property') {
                if (typeof closePropertyDetailsModal === 'function') closePropertyDetailsModal();
            } else {
                if (typeof closeWellDetailsModal === 'function') closeWellDetailsModal();
            }

            // Switch to Tools tab
            var tabBtn = document.querySelector('.tab[data-tab="tools"]');
            if (tabBtn) tabBtn.click();

            // Ensure tools loaded
            await loadTools();

            // Pre-select
            if (type === 'property') {
                setToolsMode('property');
                toolsSelectedPropertyId = id;
                var input = document.getElementById('toolsPropertySearch');
                if (input) input.value = label;
                var clearBtn = document.getElementById('toolsPropertySearchClear');
                if (clearBtn) clearBtn.style.display = 'block';
                onToolsPropertyChange(id);
            } else {
                setToolsMode('well');
                toolsSelectedWellId = id;
                var wInput = document.getElementById('toolsWellSearch');
                if (wInput) wInput.value = label;
                var wClearBtn = document.getElementById('toolsWellSearchClear');
                if (wClearBtn) wClearBtn.style.display = 'block';
                onToolsWellChange(id);
            }
        }
