        // Enhanced extraction toggle
        let enhancedExtractionEnabled = false;

        function toggleEnhancedExtraction() {
            enhancedExtractionEnabled = document.getElementById('enhancedExtractionToggle').checked;
            const track = document.getElementById('enhancedToggleTrack');
            const thumb = document.getElementById('enhancedToggleThumb');
            const text = document.getElementById('enhancedToggleText');
            const label = document.getElementById('enhancedToggleLabel');
            if (enhancedExtractionEnabled) {
                track.style.background = '#059669';
                thumb.style.transform = 'translateX(16px)';
                text.style.color = '#065F46';
                label.style.background = '#F0FDF4';
                label.style.borderColor = '#BBF7D0';
            } else {
                track.style.background = '#D1D5DB';
                thumb.style.transform = 'translateX(0)';
                text.style.color = '#6B7280';
                label.style.background = 'transparent';
                label.style.borderColor = '#E5E7EB';
            }
            // Update credit estimate if upload modal is open with files selected
            if (typeof updateCreditEstimate === 'function') updateCreditEstimate();
        }
        window.toggleEnhancedExtraction = toggleEnhancedExtraction;

        // Document functions
        let currentDocumentId = null;
        let currentDocumentContentType = null;
        let currentDocumentRotation = 0;
        let currentDocumentFilename = null;
        let loadedDocuments = [];
        
        // Documents list controller (state + event binding via shared ListController)
        const documentsController = createListController({
            defaultFilter: 'all',
            defaultSort: 'date-desc',
            controlsId: 'documentsControls',
            searchId: 'documentsSearch',
            sortId: 'documentsSort',
            debounceMs: 300,
            requirePlan: true,
            itemName: 'documents',
            renderFn: () => renderDocumentsList(loadedDocuments),
            filterFn: filterDocuments,
            sortFn: sortDocuments,
            onInit: () => {
                updateDocumentsSortOptions();
                initDocumentsCategoryDropdown();
            }
        });

        // Alias for backward compat — initDocumentsControls is called from dashboard-init
        const initDocumentsControls = () => documentsController.initControls();
        
        // Update sort options based on selected category
        function updateDocumentsSortOptions() {
            const sortSelect = document.getElementById('documentsSort');
            const currentSort = sortSelect.value;
            
            // Clear existing options
            sortSelect.innerHTML = '';
            
            // Base sort options (always available)
            const baseOptions = [
                { value: 'date-desc', text: 'Upload Date (Newest)' },
                { value: 'date-asc', text: 'Upload Date (Oldest)' }
            ];
            
            // Category-specific sort options
            const categoryOptions = {
                // Deeds
                'mineral_deeds': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' },
                    { value: 'recording-date', text: 'Recording Date' },
                    { value: 'grantor', text: 'Grantor Name' },
                    { value: 'grantee', text: 'Grantee Name' }
                ],
                'royalty_deed': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' },
                    { value: 'grantor', text: 'Grantor Name' },
                    { value: 'grantee', text: 'Grantee Name' }
                ],
                'assignment': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' },
                    { value: 'assignor', text: 'Assignor Name' },
                    { value: 'assignee', text: 'Assignee Name' }
                ],
                'ratification': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' }
                ],
                'right_of_way': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' },
                    { value: 'grantee', text: 'Grantee Name' }
                ],

                // Leases
                'leases': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'lease-date', text: 'Lease Date' },
                    { value: 'lessor', text: 'Lessor Name' },
                    { value: 'lessee', text: 'Lessee Name' }
                ],
                'release_of_lease': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' },
                    { value: 'operator', text: 'Operator' }
                ],
                'lease_amendment': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' }
                ],
                'lease_extension': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' }
                ],

                // OCC Orders - granular
                'pooling_orders': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county', text: 'County' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'formation', text: 'Formation' }
                ],
                'drilling_and_spacing': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'unit-size', text: 'Unit Size (Acres)' },
                    { value: 'formation', text: 'Formation' }
                ],
                'horizontal_drilling_and_spacing': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'unit-size', text: 'Unit Size (Acres)' },
                    { value: 'formation', text: 'Formation' },
                    { value: 'operator', text: 'Operator' }
                ],
                'location_exception': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'well-name', text: 'Well Name' },
                    { value: 'operator', text: 'Operator' }
                ],
                'increased_density': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county', text: 'County' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'wells-authorized', text: 'Wells Authorized' }
                ],
                'change_of_operator': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county', text: 'County' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'new-operator', text: 'New Operator' },
                    { value: 'wells-transferred', text: 'Wells Transferred' }
                ],
                'multi_unit_horizontal': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county', text: 'County' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'formation', text: 'Formation' },
                    { value: 'sections', text: 'Sections' }
                ],

                // Well documents
                'drilling_permits': [
                    { value: 'permit-date', text: 'Permit Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'well-name', text: 'Well Name' }
                ],
                'well_completion_reports': [
                    { value: 'completion-date', text: 'Completion Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'well-name', text: 'Well Name' }
                ],
                'production_reports': [
                    { value: 'production-date', text: 'Production Date' },
                    { value: 'oil-volume', text: 'Oil Volume' },
                    { value: 'gas-volume', text: 'Gas Volume' }
                ],
                'division_orders': [
                    { value: 'effective-date', text: 'Effective Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'interest-decimal', text: 'Interest Decimal' }
                ],
                'title_opinions': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'opinion-date', text: 'Opinion Date' },
                    { value: 'attorney', text: 'Attorney/Firm' }
                ],
                'joa': [
                    { value: 'effective-date', text: 'Effective Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'unit-name', text: 'Unit Name' }
                ],

                // Financial
                'check_stubs': [
                    { value: 'payment-date', text: 'Payment Date' },
                    { value: 'amount', text: 'Payment Amount' },
                    { value: 'well', text: 'Well Name' }
                ],
                'suspense_notices': [
                    { value: 'notice-date', text: 'Notice Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'amount', text: 'Suspense Amount' }
                ],
                'tax_records': [
                    { value: 'tax-year', text: 'Tax Year' },
                    { value: 'assessed-value', text: 'Assessed Value' }
                ],

                // Estate/Ownership - granular
                'affidavit_of_heirship': [
                    { value: 'county', text: 'County' },
                    { value: 'decedent', text: 'Decedent Name' },
                    { value: 'execution-date', text: 'Execution Date' }
                ],
                'probate': [
                    { value: 'county', text: 'County' },
                    { value: 'decedent', text: 'Decedent Name' },
                    { value: 'case-number', text: 'Case Number' }
                ],
                'trust': [
                    { value: 'entity-name', text: 'Entity Name' },
                    { value: 'document-date', text: 'Document Date' }
                ],

                // Legal - granular
                'legal_documents': [
                    { value: 'document-date', text: 'Document Date' },
                    { value: 'document-type', text: 'Document Type' }
                ],
                'divorce_decree': [
                    { value: 'decree-date', text: 'Decree Date' },
                    { value: 'petitioner', text: 'Petitioner Name' }
                ],
                'death_certificate': [
                    { value: 'death-date', text: 'Date of Death' },
                    { value: 'decedent', text: 'Decedent Name' }
                ],
                'power_of_attorney': [
                    { value: 'execution-date', text: 'Execution Date' },
                    { value: 'principal', text: 'Principal Name' }
                ],

                // Other
                'correspondence': [
                    { value: 'letter-date', text: 'Letter Date' },
                    { value: 'sender', text: 'From' },
                    { value: 'recipient', text: 'To' }
                ],
                'maps_plats': [
                    { value: 'map-date', text: 'Map Date' },
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'map-type', text: 'Map Type' }
                ]
            };
            
            // Add base options
            baseOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                sortSelect.appendChild(option);
            });
            
            // Add category-specific options if applicable
            if (documentsController.filterBy !== 'all' && categoryOptions[documentsController.filterBy]) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '──────────';
                sortSelect.appendChild(separator);

                categoryOptions[documentsController.filterBy].forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    sortSelect.appendChild(option);
                });
            }
            
            // Restore previous selection if still valid
            if (Array.from(sortSelect.options).find(opt => opt.value === currentSort)) {
                sortSelect.value = currentSort;
            } else {
                // Reset to default if previous selection is no longer valid
                sortSelect.value = 'date-desc';
                documentsController.sortBy = 'date-desc';
            }
        }

        // Document categories - alphabetized with granular types
        const DOCUMENT_CATEGORIES = [
            { value: 'all', label: 'All Categories' },
            { value: 'affidavit_of_heirship', label: 'Affidavit of Heirship' },
            { value: 'assignment', label: 'Assignments' },
            { value: 'change_of_operator', label: 'Change of Operator' },
            { value: 'check_stubs', label: 'Check Stubs / Royalty Statements' },
            { value: 'correspondence', label: 'Correspondence' },
            { value: 'death_certificate', label: 'Death Certificates' },
            { value: 'divorce_decree', label: 'Divorce Decrees' },
            { value: 'division_orders', label: 'Division Orders' },
            { value: 'drilling_and_spacing', label: 'Drilling & Spacing Orders (Vertical)' },
            { value: 'drilling_permits', label: 'Drilling Permits' },
            { value: 'horizontal_drilling_and_spacing', label: 'Horizontal Drilling & Spacing Orders' },
            { value: 'increased_density', label: 'Increased Density Orders' },
            { value: 'joa', label: 'Joint Operating Agreements' },
            { value: 'leases', label: 'Leases' },
            { value: 'lease_amendment', label: 'Lease Amendments' },
            { value: 'lease_extension', label: 'Lease Extensions' },
            { value: 'legal_documents', label: 'Legal Documents' },
            { value: 'location_exception', label: 'Location Exception Orders' },
            { value: 'maps_plats', label: 'Maps / Plats' },
            { value: 'mineral_deeds', label: 'Mineral Deeds' },
            { value: 'multi_document', label: 'Multi-Document PDFs' },
            { value: 'multi_unit_horizontal', label: 'Multi-Unit Horizontal Orders' },
            { value: 'pooling_orders', label: 'Pooling Orders' },
            { value: 'power_of_attorney', label: 'Power of Attorney' },
            { value: 'probate', label: 'Probate Documents' },
            { value: 'production_reports', label: 'Production Reports' },
            { value: 'ratification', label: 'Ratifications' },
            { value: 'release_of_lease', label: 'Release of Lease' },
            { value: 'right_of_way', label: 'Right of Way' },
            { value: 'royalty_deed', label: 'Royalty Deeds' },
            { value: 'suspense_notices', label: 'Suspense Notices' },
            { value: 'tax_records', label: 'Tax Records' },
            { value: 'title_opinions', label: 'Title Opinions' },
            { value: 'trust', label: 'Trust Documents' },
            { value: 'unitization_orders', label: 'Unitization Orders' },
            { value: 'well_completion_reports', label: 'Well Completion Reports' },
            { value: 'other', label: 'Other' }
        ];

        // Initialize searchable category dropdown
        function initDocumentsCategoryDropdown() {
            const dropdown = document.getElementById('documentsCategoryDropdown');
            const trigger = document.getElementById('documentsCategoryTrigger');
            const menu = document.getElementById('documentsCategoryMenu');
            const searchInput = document.getElementById('documentsCategorySearch');
            const optionsContainer = document.getElementById('documentsCategoryOptions');
            const hiddenInput = document.getElementById('documentsCategory');
            const label = trigger.querySelector('.dropdown-label');

            // Populate options
            function renderOptions(filter = '') {
                const filterLower = filter.toLowerCase();
                let hasVisible = false;

                optionsContainer.innerHTML = '';

                DOCUMENT_CATEGORIES.forEach(cat => {
                    const matchesFilter = !filter || cat.label.toLowerCase().includes(filterLower);
                    if (!matchesFilter) return;

                    hasVisible = true;
                    const option = document.createElement('div');
                    option.className = 'dropdown-option' + (cat.value === documentsController.filterBy ? ' selected' : '');
                    option.dataset.value = cat.value;
                    option.textContent = cat.label;
                    option.addEventListener('click', () => selectCategory(cat.value, cat.label));
                    optionsContainer.appendChild(option);
                });

                if (!hasVisible) {
                    optionsContainer.innerHTML = '<div class="dropdown-no-results">No categories found</div>';
                }
            }

            // Select a category
            function selectCategory(value, labelText) {
                documentsController.filterBy = value;
                hiddenInput.value = value;
                label.textContent = labelText;
                closeDropdown();
                updateDocumentsSortOptions();
                renderDocumentsList(loadedDocuments);
            }

            // Open/close dropdown
            function toggleDropdown() {
                const isOpen = dropdown.classList.contains('open');
                if (isOpen) {
                    closeDropdown();
                } else {
                    openDropdown();
                }
            }

            function openDropdown() {
                dropdown.classList.add('open');
                searchInput.value = '';
                renderOptions();
                setTimeout(() => searchInput.focus(), 50);
            }

            function closeDropdown() {
                dropdown.classList.remove('open');
                searchInput.value = '';
            }

            // Event listeners
            trigger.addEventListener('click', toggleDropdown);

            searchInput.addEventListener('input', (e) => {
                renderOptions(e.target.value);
            });

            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeDropdown();
                    trigger.focus();
                }
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Initial render
            renderOptions();
        }

        // Filter documents based on search and category
        function filterDocuments(documents, filterBy, searchTerm) {
            return documents.filter(doc => {
                // Category filter
                if (filterBy !== 'all') {
                    // Use category field if available, fall back to doc_type mapping
                    let docCategory;
                    
                    // Map database category/doc_type to filter value (granular categories)
                    const categoryOrDocType = doc.category || doc.doc_type || 'other';
                    const docTypeToFilterValue = {
                        // Deeds
                        'mineral_deed': 'mineral_deeds',
                        'royalty_deed': 'royalty_deed',
                        'assignment': 'assignment',
                        'assignment_of_lease': 'assignment',
                        'ratification': 'ratification',
                        'right_of_way': 'right_of_way',

                        // Leases
                        'lease': 'leases',
                        'oil_and_gas_lease': 'leases',
                        'oil_gas_lease': 'leases',
                        'release_of_lease': 'release_of_lease',
                        'lease_amendment': 'lease_amendment',
                        'lease_extension': 'lease_extension',

                        // OCC Orders - now granular
                        'pooling_order': 'pooling_orders',
                        'drilling_and_spacing_order': 'drilling_and_spacing',
                        'horizontal_drilling_and_spacing_order': 'horizontal_drilling_and_spacing',
                        'location_exception_order': 'location_exception',
                        'increased_density_order': 'increased_density',
                        'change_of_operator_order': 'change_of_operator',
                        'multi_unit_horizontal_order': 'multi_unit_horizontal',
                        'unitization_order': 'unitization_orders',
                        'occ_order': 'other',  // Generic OCC orders go to other

                        // Well documents
                        'division_order': 'division_orders',
                        'drilling_permit': 'drilling_permits',
                        'title_opinion': 'title_opinions',
                        'joa': 'joa',
                        'joint_operating_agreement': 'joa',

                        // Financial
                        'check_stub': 'check_stubs',
                        'royalty_statement': 'check_stubs',
                        'suspense_notice': 'suspense_notices',
                        'tax_record': 'tax_records',

                        // Estate/Ownership - now granular
                        'affidavit_of_heirship': 'affidavit_of_heirship',
                        'heirship': 'affidavit_of_heirship',
                        'probate': 'probate',
                        'probate_document': 'probate',
                        'trust': 'trust',
                        'ownership_entity': 'trust',
                        'llc_docs': 'trust',
                        'estate': 'probate',

                        // Legal - now granular
                        'legal_document': 'legal_documents',
                        'divorce_decree': 'divorce_decree',
                        'death_certificate': 'death_certificate',
                        'power_of_attorney': 'power_of_attorney',

                        // Other
                        'correspondence': 'correspondence',
                        'map': 'maps_plats',
                        'plat': 'maps_plats',
                        'multi_document': 'multi_document',
                        'production_report': 'production_reports',
                        'well_completion_report': 'well_completion_reports',
                        'other': 'other'
                    };
                    docCategory = docTypeToFilterValue[categoryOrDocType.toLowerCase()] || 'other';
                    
                    if (docCategory !== filterBy) return false;
                }
                
                // Search filter
                if (!searchTerm) return true;

                const searchStr = searchTerm;  // Already lowercase from input handler
                
                // Basic field search
                const basicMatch = (
                    (doc.filename || '').toLowerCase().includes(searchStr) ||
                    (doc.display_name || '').toLowerCase().includes(searchStr) ||
                    (doc.category || '').toLowerCase().includes(searchStr) ||
                    (doc.doc_type || '').toLowerCase().includes(searchStr) ||
                    (doc.county || '').toLowerCase().includes(searchStr) ||
                    (doc.description || '').toLowerCase().includes(searchStr)
                );
                
                if (basicMatch) return true;
                
                // Search in extracted data if available
                if (doc.parsedExtractedData) {
                    const extractedStr = JSON.stringify(doc.parsedExtractedData).toLowerCase();
                    return extractedStr.includes(searchStr);
                }
                
                return false;
            });
        }
        
        // Sort documents
        function sortDocuments(documents, sortBy) {
            const sorted = [...documents];

            sorted.sort((a, b) => {
                switch (sortBy) {
                    case 'date-desc':
                        return new Date(b.upload_date) - new Date(a.upload_date);
                    case 'date-asc':
                        return new Date(a.upload_date) - new Date(b.upload_date);
                    case 'county-trs':
                        // Sort by county, then township, range, section
                        const countyCompare = (a.county || '').localeCompare(b.county || '');
                        if (countyCompare !== 0) return countyCompare;
                        const aTRS = `${a.township || ''}${a.range || ''}${a.section || ''}`;
                        const bTRS = `${b.township || ''}${b.range || ''}${b.section || ''}`;
                        return aTRS.localeCompare(bTRS);
                    
                    // Category-specific sorts using extracted data
                    case 'execution-date':
                    case 'recording-date':
                    case 'lease-date':
                    case 'permit-date':
                    case 'production-date':
                    case 'effective-date':
                        const aDate = getExtractedDate(a, sortBy);
                        const bDate = getExtractedDate(b, sortBy);
                        return compareDates(aDate, bDate);
                    
                    case 'grantor':
                    case 'grantee':
                    case 'lessor':
                    case 'lessee':
                    case 'operator':
                    case 'well-name':
                        const aValue = getExtractedString(a, sortBy);
                        const bValue = getExtractedString(b, sortBy);
                        return aValue.localeCompare(bValue);
                    
                    case 'oil-volume':
                    case 'gas-volume':
                    case 'interest-decimal':
                        const aNum = getExtractedNumber(a, sortBy);
                        const bNum = getExtractedNumber(b, sortBy);
                        return bNum - aNum; // Descending for volumes
                    
                    default:
                        return 0;
                }
            });
            
            return sorted;
        }
        
        // Helper functions for extracting data from parsed extracted_data
        function getExtractedDate(doc, sortType) {
            if (!doc.parsedExtractedData) return '';
            
            const fieldMap = {
                'execution-date': ['execution_date', 'executionDate'],
                'recording-date': ['recording_date', 'recordingDate', 'recorded_date'],
                'lease-date': ['lease_date', 'leaseDate', 'dated'],
                'permit-date': ['permit_date', 'permitDate', 'date_issued'],
                'production-date': ['production_date', 'productionDate', 'reporting_date'],
                'effective-date': ['effective_date', 'effectiveDate']
            };
            
            const possibleFields = fieldMap[sortType] || [];
            for (const field of possibleFields) {
                if (doc.parsedExtractedData[field]) {
                    return doc.parsedExtractedData[field];
                }
            }
            return '';
        }
        
        function getExtractedString(doc, sortType) {
            if (!doc.parsedExtractedData) return '';
            
            const fieldMap = {
                'grantor': ['grantor', 'grantors', 'grantor_name'],
                'grantee': ['grantee', 'grantees', 'grantee_name'],
                'lessor': ['lessor', 'lessors', 'lessor_name'],
                'lessee': ['lessee', 'lessees', 'lessee_name'],
                'operator': ['operator', 'operator_name', 'company'],
                'well-name': ['well_name', 'wellName', 'well']
            };
            
            const possibleFields = fieldMap[sortType] || [];
            for (const field of possibleFields) {
                const value = doc.parsedExtractedData[field];
                if (value) {
                    // Handle arrays (multiple grantors, etc.)
                    if (Array.isArray(value)) {
                        return value.join(', ');
                    }
                    return String(value);
                }
            }
            return '';
        }
        
        function getExtractedNumber(doc, sortType) {
            if (!doc.parsedExtractedData) return 0;
            
            const fieldMap = {
                'oil-volume': ['oil_volume', 'oil_production', 'oil_bbls'],
                'gas-volume': ['gas_volume', 'gas_production', 'gas_mcf'],
                'interest-decimal': ['interest_decimal', 'decimal_interest', 'interest']
            };
            
            const possibleFields = fieldMap[sortType] || [];
            for (const field of possibleFields) {
                const value = doc.parsedExtractedData[field];
                if (value !== undefined && value !== null) {
                    return parseFloat(value) || 0;
                }
            }
            return 0;
        }
        
        function compareDates(a, b) {
            // Handle various date formats
            const dateA = a ? new Date(a) : new Date(0);
            const dateB = b ? new Date(b) : new Date(0);
            return dateB.getTime() - dateA.getTime(); // Descending (newest first)
        }
        
        // Document viewer — delegates to shared openDocumentViewer with dashboard-specific state
        async function viewDocumentInModal(docId, filename, fromDetailModal = false, contentType = 'application/pdf', rotationApplied = 0) {
            console.log('Opening document in modal:', docId, filename, 'type:', contentType, 'rotation:', rotationApplied);
            currentDocumentId = docId;
            window.viewingFromDetailModal = fromDetailModal;
            window.currentDocumentRotation = rotationApplied || 0;

            await openDocumentViewer(docId, filename, contentType, {
                container: document.getElementById('pdfViewerContainer'),
                titleEl: document.getElementById('documentViewTitle'),
                modal: document.getElementById('documentViewModal'),
                zIndex: fromDetailModal ? '9999999' : '2000',
                rotation: rotationApplied || 0
            });
        }

        function closeDocumentViewer() {
            closeDocumentViewerShared({
                container: document.getElementById('pdfViewerContainer'),
                modal: document.getElementById('documentViewModal'),
                resetZIndex: true
            });

            // Don't clear currentDocumentId if we're returning to detail modal
            if (!window.viewingFromDetailModal) {
                currentDocumentId = null;
            }
            window.viewingFromDetailModal = false;
        }

        function downloadCurrentDocument() {
            if (currentDocumentId) {
                downloadDocument(currentDocumentId);
            }
        }

        function downloadDocument(docId) {
            console.log('Download document clicked:', docId);
            window.location.href = `/api/documents/${docId}/download`;
        }
        
        // Confidence scoring was removed from extraction prompts to reduce AI load.
        // This stub function remains for backward compatibility with existing call sites.
        function getConfidenceIndicator(fieldName, fieldScores) {
            return '';
        }
        
        // formatFieldName is in shared-doc-helpers.txt

        // ===== Check Stub Custom Renderers =====
        function fmtCurrency(val) {
            if (val == null) return '-';
            const n = parseFloat(val);
            if (isNaN(n)) return escapeHtml(String(val));
            const neg = n < 0;
            const formatted = '$' + Math.abs(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return neg ? '<span style="color:#DC2626;">-' + formatted + '</span>' : formatted;
        }

        function renderCheckStubWellRevenue(wells) {
            let html = '<div class="section-group" style="margin-bottom: 20px;">';
            html += '<h4 class="section-title" style="font-size: 13px; font-weight: 600; color: #1D6F5C; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #D1FAE5;">Well Revenue</h4>';

            wells.forEach((well, wIdx) => {
                const wellName = well.well_name || 'Unknown Well';
                const wellNum = well.well_number ? ' (#' + escapeHtml(well.well_number) + ')' : '';
                const api = well.api_number ? ' <span style="font-family:monospace;font-size:11px;color:#6B7280;">' + escapeHtml(well.api_number) + '</span>' : '';
                const months = Array.isArray(well.production_months) ? well.production_months.join(', ') : (well.production_months || '');
                const loc = [well.county, well.state].filter(Boolean).join(', ');

                html += '<div style="background:#F9FAFB;border:1px solid #E5E7EB;border-radius:8px;padding:12px;margin-bottom:12px;">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:4px;">';
                html += '<div><span style="font-weight:600;color:#111827;">' + escapeHtml(wellName) + '</span>' + wellNum + api + '</div>';
                html += '<div style="font-size:12px;color:#6B7280;">' + (loc ? escapeHtml(loc) + ' | ' : '') + (months ? 'Prod: ' + escapeHtml(months) : '') + '</div>';
                html += '</div>';

                if (Array.isArray(well.products) && well.products.length > 0) {
                    html += '<div style="overflow-x:auto;">';
                    html += '<table style="width:100%;border-collapse:collapse;font-size:12px;background:white;border:1px solid #E5E7EB;border-radius:6px;overflow:hidden;min-width:600px;">';
                    html += '<thead style="background:#F3F4F6;"><tr>';
                    html += '<th style="padding:8px 6px;text-align:left;font-weight:600;color:#374151;">Product</th>';
                    html += '<th style="padding:8px 6px;text-align:right;font-weight:600;color:#374151;">Volume</th>';
                    html += '<th style="padding:8px 6px;text-align:right;font-weight:600;color:#374151;">Price</th>';
                    html += '<th style="padding:8px 6px;text-align:right;font-weight:600;color:#374151;">Decimal</th>';
                    html += '<th style="padding:8px 6px;text-align:left;font-weight:600;color:#374151;">Purchaser</th>';
                    html += '<th style="padding:8px 6px;text-align:right;font-weight:600;color:#374151;">Gross</th>';
                    html += '<th style="padding:8px 6px;text-align:right;font-weight:600;color:#374151;">Deductions</th>';
                    html += '<th style="padding:8px 6px;text-align:right;font-weight:600;color:#374151;">Taxes</th>';
                    html += '<th style="padding:8px 6px;text-align:right;font-weight:600;color:#374151;">Owner Amt</th>';
                    html += '</tr></thead><tbody>';

                    well.products.forEach((p, pIdx) => {
                        const prodLabel = (p.product_type || 'Unknown').charAt(0).toUpperCase() + (p.product_type || '').slice(1);
                        const vol = p.volume != null ? parseFloat(p.volume).toLocaleString('en-US') + (p.volume_unit ? ' ' + p.volume_unit : '') : '-';
                        const price = p.price_per_unit != null ? '$' + parseFloat(p.price_per_unit).toFixed(2) : '-';
                        const dec = p.decimal_interest != null ? String(p.decimal_interest) : '-';
                        const purchaser = p.purchaser ? escapeHtml(p.purchaser) : '-';
                        const hasDetail = (Array.isArray(p.deductions) && p.deductions.length > 0) || (Array.isArray(p.taxes) && p.taxes.length > 0);
                        const detailId = 'cs-detail-' + wIdx + '-' + pIdx;

                        html += '<tr style="border-bottom:1px solid #E5E7EB;' + (hasDetail ? 'cursor:pointer;' : '') + '"' + (hasDetail ? ' onclick="document.getElementById(\'' + detailId + '\').style.display=document.getElementById(\'' + detailId + '\').style.display===\'none\'?\'table-row\':\'none\'"' : '') + '>';
                        html += '<td style="padding:8px 6px;font-weight:500;">' + (hasDetail ? '<span style="font-size:10px;color:#9CA3AF;margin-right:4px;">&#9654;</span>' : '') + escapeHtml(prodLabel) + '</td>';
                        html += '<td style="padding:8px 6px;text-align:right;">' + vol + '</td>';
                        html += '<td style="padding:8px 6px;text-align:right;">' + price + '</td>';
                        html += '<td style="padding:8px 6px;text-align:right;font-family:monospace;font-size:11px;">' + escapeHtml(dec) + '</td>';
                        html += '<td style="padding:8px 6px;">' + purchaser + '</td>';
                        html += '<td style="padding:8px 6px;text-align:right;">' + fmtCurrency(p.gross_sales) + '</td>';
                        html += '<td style="padding:8px 6px;text-align:right;">' + fmtCurrency(p.total_deductions) + '</td>';
                        html += '<td style="padding:8px 6px;text-align:right;">' + fmtCurrency(p.total_taxes) + '</td>';
                        html += '<td style="padding:8px 6px;text-align:right;font-weight:600;">' + fmtCurrency(p.owner_amount) + '</td>';
                        html += '</tr>';

                        // Expandable deduction/tax detail row
                        if (hasDetail) {
                            html += '<tr id="' + detailId + '" style="display:none;"><td colspan="9" style="padding:0;">';
                            html += '<div style="background:#FEFCE8;padding:8px 12px;border-top:1px dashed #E5E7EB;">';

                            if (Array.isArray(p.deductions) && p.deductions.length > 0) {
                                html += '<div style="font-size:11px;font-weight:600;color:#92400E;margin-bottom:4px;">Deductions</div>';
                                html += '<table style="width:100%;font-size:11px;margin-bottom:6px;">';
                                p.deductions.forEach(d => {
                                    const catBadge = d.normalized_category ? '<span style="background:#FEF3C7;color:#92400E;padding:1px 6px;border-radius:3px;font-size:10px;margin-left:6px;">' + escapeHtml(d.normalized_category) + '</span>' : '';
                                    html += '<tr><td style="padding:2px 0;color:#6B7280;">' + escapeHtml(d.raw_label || '') + catBadge + '</td>';
                                    html += '<td style="padding:2px 0;text-align:right;">' + fmtCurrency(d.amount) + '</td></tr>';
                                });
                                html += '</table>';
                            }

                            if (Array.isArray(p.taxes) && p.taxes.length > 0) {
                                html += '<div style="font-size:11px;font-weight:600;color:#1E40AF;margin-bottom:4px;">Taxes</div>';
                                html += '<table style="width:100%;font-size:11px;">';
                                p.taxes.forEach(t => {
                                    const typeBadge = t.normalized_type ? '<span style="background:#DBEAFE;color:#1E40AF;padding:1px 6px;border-radius:3px;font-size:10px;margin-left:6px;">' + escapeHtml(t.normalized_type) + '</span>' : '';
                                    html += '<tr><td style="padding:2px 0;color:#6B7280;">' + escapeHtml(t.raw_label || '') + typeBadge + '</td>';
                                    html += '<td style="padding:2px 0;text-align:right;">' + fmtCurrency(t.amount) + '</td></tr>';
                                });
                                html += '</table>';
                            }

                            html += '</div></td></tr>';
                        }
                    });

                    html += '</tbody></table></div>';
                }

                if (well.well_owner_total != null) {
                    html += '<div style="text-align:right;margin-top:8px;font-weight:600;font-size:13px;color:#111827;">Well Total: ' + fmtCurrency(well.well_owner_total) + '</div>';
                }
                html += '</div>';
            });

            html += '</div>';
            return html;
        }

        function renderCheckStubSummary(summary) {
            let html = '<div class="section-group" style="margin-bottom: 20px;">';
            html += '<h4 class="section-title" style="font-size: 13px; font-weight: 600; color: #1D6F5C; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #D1FAE5;">Check Summary</h4>';
            html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;">';

            const items = [
                { label: 'Gas Net Revenue', val: summary.gas_net_revenue },
                { label: 'Oil Net Revenue', val: summary.oil_net_revenue },
                { label: 'Liquids Net Revenue', val: summary.liquids_net_revenue },
                { label: 'Total Net Revenue', val: summary.total_net_revenue }
            ];
            items.forEach(item => {
                if (item.val == null && item.label !== 'Total Net Revenue') return;
                const isBold = item.label === 'Total Net Revenue';
                html += '<div style="background:' + (isBold ? '#ECFDF5' : '#F9FAFB') + ';border:1px solid ' + (isBold ? '#10B981' : '#E5E7EB') + ';border-radius:6px;padding:10px;">';
                html += '<div style="font-size:11px;color:#6B7280;margin-bottom:4px;">' + item.label + '</div>';
                html += '<div style="font-size:' + (isBold ? '16px' : '14px') + ';font-weight:' + (isBold ? '700' : '500') + ';color:#111827;">' + fmtCurrency(item.val) + '</div>';
                html += '</div>';
            });

            html += '</div></div>';
            return html;
        }

        function renderCheckStubOperatingExpenses(expenses) {
            let html = '<div class="section-group" style="margin-bottom: 20px;">';
            html += '<h4 class="section-title" style="font-size: 13px; font-weight: 600; color: #1D6F5C; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #D1FAE5;">Operating Expenses</h4>';
            html += '<div style="overflow-x:auto;">';
            html += '<table style="width:100%;border-collapse:collapse;font-size:12px;background:white;border:1px solid #E5E7EB;border-radius:6px;overflow:hidden;">';
            html += '<thead style="background:#FEF3C7;"><tr>';
            html += '<th style="padding:8px 6px;text-align:left;font-weight:600;color:#92400E;">Description</th>';
            html += '<th style="padding:8px 6px;text-align:left;font-weight:600;color:#92400E;">Vendor</th>';
            html += '<th style="padding:8px 6px;text-align:left;font-weight:600;color:#92400E;">Category</th>';
            html += '<th style="padding:8px 6px;text-align:right;font-weight:600;color:#92400E;">Gross</th>';
            html += '<th style="padding:8px 6px;text-align:right;font-weight:600;color:#92400E;">Owner Amt</th>';
            html += '</tr></thead><tbody>';

            let totalOwner = 0;
            expenses.forEach(exp => {
                const ownerAmt = exp.owner_amount != null ? parseFloat(exp.owner_amount) : 0;
                totalOwner += ownerAmt;
                const catBadge = exp.category ? '<span style="background:#FEF3C7;color:#92400E;padding:1px 6px;border-radius:3px;font-size:10px;">' + escapeHtml(exp.category) + '</span>' : '-';
                html += '<tr style="border-bottom:1px solid #E5E7EB;">';
                html += '<td style="padding:8px 6px;">' + escapeHtml(exp.description || '') + '</td>';
                html += '<td style="padding:8px 6px;">' + escapeHtml(exp.vendor || '-') + '</td>';
                html += '<td style="padding:8px 6px;">' + catBadge + '</td>';
                html += '<td style="padding:8px 6px;text-align:right;">' + fmtCurrency(exp.gross_amount) + '</td>';
                html += '<td style="padding:8px 6px;text-align:right;font-weight:600;">' + fmtCurrency(exp.owner_amount) + '</td>';
                html += '</tr>';
            });

            html += '</tbody><tfoot><tr style="background:#FEF3C7;font-weight:600;">';
            html += '<td colspan="4" style="padding:8px 6px;text-align:right;">Total Operating Expenses:</td>';
            html += '<td style="padding:8px 6px;text-align:right;">' + fmtCurrency(totalOwner) + '</td>';
            html += '</tr></tfoot></table></div></div>';
            return html;
        }

        // Helper to group fields into logical sections
        function groupFieldsBySection(data) {
            const groups = {
                'Detailed Analysis': ['ai_observations'],
                // Division Order groups (consolidated for cleaner display)
                'Operator & Well': ['operator_name', 'operator_address', 'operator_phone', 'operator_email', 'return_instructions',
                            'property_name', 'property_number', 'billing_code'],  // api_number moved to Well Information
                'Owner & Interest': ['owner_name', 'owner_address', 'trustee_name', 'owner_number',
                            'owner_phone', 'owner_fax', 'owner_email',  // Owner-provided contact from signature section
                            'working_interest', 'royalty_interest', 'overriding_royalty_interest', 'net_revenue_interest', 'non_participating_royalty_interest'],
                'Terms & Unit': ['effective_date', 'payment_minimum', 'product_type', 'unit_size_acres',
                            'county', 'state', 'section', 'township', 'range',
                            'is_multi_section_unit', 'unit_sections',
                            'primary_term', 'royalty_rate', 'delay_rental', 'shut_in_royalty', 'extension_provisions',
                            'lease_form', 'habendum_clause', 'pooling_provisions'],
                'Recording & Execution': ['recording', 'recording_book', 'recording_page', 'document_number', 'recording_date', 'recording_county', 'instrument_number',
                                    'execution_date', 'prepared_by', 'notary_date', 'notary_county', 'notary_state', 'deed_type',
                                    'notary_expiration', 'commission_expiration', 'corporate_acknowledgment', 'acknowledgment_date',
                                    'notarization', 'witnesses'],  // Combined recording and execution info
                'Legal Description': ['legal_description', 'section', 'township', 'range', 'county', 'state', 'quarter', 'quarter_section', 'lot_block', 'acres', 'acreage', 'location'],
                'Parties': ['grantors', 'grantees', 'grantor', 'grantee', 'grantor_name', 'grantee_name', 'grantor_names', 'grantee_names',
                          'grantor_address', 'grantee_address',
                          'grantor_marital_status', 'lessor_name', 'lessee_name', 'lessor_address', 'lessee_address',
                          'lessor', 'lessee',  // oil_gas_lease v2 schema nested objects
                          'assignor', 'assignee',  // trust_funding schema nested objects
                          'assignor_name', 'assignee_name', 'assignor_address', 'assignee_address',
                          'releasor', 'ratifying_party', 'original_party', 'principal_name', 'agent_name',
                          'petitioner_name', 'respondent_name', 'decedent_name', 'executor_name', 'affiant_name',
                          'decedent', 'affiant', 'heirs_summary', 'children_living', 'children_predeceased', 'spouses',
                          'president', 'vice_president', 'secretary', 'assistant_secretary', 'treasurer', 'corporate_officer',
                          'from', 'sender', 'to'],  // Correspondence parties
                'Letter Details': ['subject', 're_line'],  // Correspondence letter details (date handled separately)
                // Check Stub / Revenue Statement sections
                'Payment Information': ['check_number', 'check_date', 'check_amount', 'statement_type', 'interest_type', 'operator_number', 'operator_address', 'owner_number'],
                'Well Revenue': ['wells'],
                'Check Summary': ['summary'],
                'Operating Expenses': ['operating_expenses'],
                'Tracts & Interest': ['tracts', 'interest_conveyed', 'interest_assigned', 'consideration',
                                           'consideration_amount', 'consideration_description', 'bonus_amount',
                                           'net_mineral_acres', 'minerals_covered', 'mineral_types_conveyed',
                                           'royalty'],  // oil_gas_lease v2 royalty object (interest_type moved to Owner & Interest for division orders)
                'Notes': ['extraction_notes', 'notes'],  // Extraction notes and general notes
                'Lease Terms': ['primary_term', 'royalty_rate', 'delay_rental', 'shut_in_royalty', 'extension_provisions',
                               'lease_form', 'habendum_clause', 'pooling_provisions',
                               'shut_in_provisions', 'force_majeure', 'surface_use', 'assignment_status',
                               'top_lease_provision', 'continuous_development_clause'],
                // Oil & Gas Lease Protective Clauses (v2 schema)
                'Lease Clauses': ['depth_clause', 'pugh_clause', 'deductions_clause', 'exhibit_a'],
                'Well Information': ['well_name', 'well_number', 'well_identification', 'api_number', 'api_number_normalized',
                               'well_type', 'operator', 'purchaser', 'permit_type', 'permit_number', 'issue_date', 'expiration_date'],  // Consolidated well & permit info
                'Order Details': ['cd_number', 'order_number', 'cause_number', 'case_number', 'order_sub_type',
                               'order_date', 'effective_date', 'hearing_date', 'reopen_date', 'reopen_purpose',
                               'applicant', 'well_cost', 'unit_size_acres', 'unit_description', 'relief_granted',
                               'unit_shape', 'formations', 'election_options', 'election_deadline_days',
                               'additional_wells_authorized', 'existing_wells', 'expiration_date', 'expiration_period',
                               'amends_order', 'engineering_data', 'allowable_type', 'allowable_notes',
                               'unit_sections', 'total_unit_acres', 'total_completion_interval_feet',
                               'allocation_method', 'well_type', 'target_reservoir', 'adjacent_common_source',
                               'completion_interval', 'referenced_spacing_orders', 'referenced_pooling_orders',
                               'companion_cases', 'special_provisions', 'cost_savings',
                               'proposed_well_name', 'previous_operator', 'new_operator', 'transfer_date', 'affected_wells'],
                'Hearing Details': ['hearing_location', 'administrative_law_judge', 'applicant_attorney',
                                  'protestant', 'protestant_attorney', 'protest_status'],
                'Document References': ['related_documents', 'exhibits', 'prior_instruments', 'original_lease_reference',
                                      'original_document_reference', 'original_lease_date', 'original_document_date'],
                'Title & Warranties': ['warranty_type', 'source_of_title', 'warranty_of_title', 'warranty_scope', 'warranty_language', 'has_warranty'],
                'Restrictions & Provisions': ['reservations', 'exceptions', 'subject_to', 'depth_limitations',
                                            'formation_limitations', 'mineral_types', 'pooling_authorization',
                                            'surface_restrictions', 'no_surface_clause', 'pugh_clause', 'vertical_pugh_clause'],
                // Drilling Permit (Form 1000) and Completion Report sections
                // 'Permit Information' removed - merged into 'Well Information'
                // 'Well Identification' removed - merged into 'Well Information'
                // 'Surface Location' removed - duplicates Legal Description for completion reports
                'Bottom Hole Location': ['bottom_hole_location'],
                'Target Formation': ['target_formation', 'target_depth_top', 'target_depth_bottom'],
                'Unit Details': ['unit_size_acres', 'spacing_order', 'lateral_direction', 'lateral_length_ft'],
                'Multi-Unit Sections': ['multi_unit_sections', 'section_crossings'],
                // Mineral Deed sections (v2 schema)
                // 'Tracts' merged into 'Interest & Consideration' for cleaner display
                // 'Recording Information' merged into main Recording Information above
                'Reservation': ['reservation'],  // Grantor's reserved interests
                'Prior Instruments': ['prior_instruments'],  // Chain of title references
                // Increased Density Order sections
                'Order Details': ['order_info'],
                'Officials': ['officials'],
                // 'Well Authorization' and 'Allocation Factors' defined in Multi-Unit Horizontal Order section below
                'Target Formations': ['target_formations'],
                'Existing Wells': ['existing_wells'],
                'Recoverable Reserves': ['recoverable_reserves'],
                'Expiration': ['expiration'],
                'Related Orders': ['related_orders'],
                // Drilling and Spacing Order sections (v2 schema with units[] array)
                'Spacing Units': ['units'],  // Array of spacing units with legal/formations/well_location
                'Companion Causes': ['companion_causes'],  // Related OCC cases
                // Pooling Order sections (nested objects with special rendering)
                'Election Options': ['election_options'],
                'Operator Information': ['operator'],
                'Applicant Information': ['applicant', 'attorney_information',
                    // Flat attorney field names that extractor may produce
                    'attorney_name', 'attorney_bar_number', 'attorney_oba_number', 'oba_number',
                    'attorney_firm', 'attorney_address', 'attorney_phone', 'attorney_fax'],
                'Formations': ['formations'],
                'Important Deadlines': ['deadlines'],
                // default_election omitted — redundant with is_default badge in election_options
                'Subsequent Wells': ['subsequent_wells',
                    // Flat subsequent wells field names that extractor may produce
                    'subsequent_wells_provisions_election_period', 'subsequent_wells_provisions_payment_deadline',
                    'subsequent_wells_provisions_bonus_payment_deadline', 'subsequent_wells_provisions_operator_commencement',
                    'subsequent_wells_provisions_participation_options'],
                'Additional Parties': ['additional_parties', 'respondents_with_known_addresses',
                    'respondents_with_unknown_addresses', 'respondents_dismissed'],
                'Pooling Order Details': ['order_info', 'commissioners'],
                'Well Details': ['well_info', 'well_orientation'],
                'Unit Information': ['unit_info'],
                // Trust Funding sections
                'Assignment Flags': ['is_blanket_assignment', 'includes_future_acquired', 'includes_mineral_interests'],
                'Property Coverage': ['property_categories', 'mineral_interests', 'specific_properties'],
                'Trustee Acceptance': ['acceptance'],
                // Limited Partnership sections
                'Entity Information': ['entity_info'],
                'Partnership Term': ['term'],
                'Principal Office': ['principal_office'],
                'General Partners': ['general_partners'],
                'Limited Partners': ['limited_partners'],
                'Business Purpose': ['business_purpose'],
                'Capital Provisions': ['contribution_provisions', 'distribution_provisions'],
                'Management & Governance': ['management_provisions', 'voting_provisions', 'liability_provisions'],
                'Succession & Assignment': ['succession_provisions', 'assignment_provisions'],
                'Dissolution': ['dissolution_provisions'],
                // Assignment of Lease sections
                'Assignors': ['assignors'],
                'Assignees': ['assignees'],
                'Interest Assigned': ['interest_assigned'],
                'Retained Interests': ['retained_interests'],
                'Subject To': ['subject_to'],
                'Proportionate Reduction': ['proportionate_reduction'],
                'Underlying Lease': ['underlying_lease'],
                'Warranties': ['warranties'],
                // Quit Claim Deed sections (Grantors/Grantees handled by 'Parties', Interest/Consideration by 'Tracts & Interest')
                'Deed Classification': ['deed_classification'],
                'Granting Clause': ['granting_clause'],
                'Reservations & Exceptions': ['reservations_exceptions'],
                'Return To': ['return_to'],
                'Chain of Title Links': ['chain_of_title_links'],
                'Annotations': ['annotations'],
                // Change of Operator Order sections
                'Former Operator': ['former_operator'],
                'New Operator': ['new_operator'],
                'Affected Wells': ['affected_wells'],
                'Modified Orders': ['modified_orders'],
                // Location Exception Order sections
                'Order Information': ['order_info'],  // Override Pooling Order Details for location exceptions
                'Exception Details': ['exception_details'],
                'Lateral Path': ['lateral_path'],
                'Vertical Well Location': ['vertical_well_location'],
                'Allowable': ['allowable'],
                'Offset Impact': ['offset_impact'],
                'Conditions': ['conditions'],
                // Death Certificate sections
                'Certificate Information': ['certificate_info'],
                'Decedent': ['decedent'],
                'Death Location': ['death_location'],
                'Residence at Death': ['residence_at_death'],
                'Marital Status': ['marital_status'],
                'Parents': ['parents'],
                'Family Members': ['family_members'],
                'Cause of Death': ['cause_of_death'],
                'Disposition': ['disposition'],
                'Certification': ['certification'],
                'Consular Information': ['consular_info'],
                'Chain of Title': ['chain_of_title'],
                'Related Documents': ['related_documents'],
                // Multi-Unit Horizontal Order sections
                'Well Authorization': ['well_authorization'],
                'Well Location': ['well_location'],
                'Allocation Factors': ['allocation_factors'],
                'Relief Granted': ['relief_granted'],
                'Special Provisions': ['special_provisions'],
                // Completion Report sections (Well Information consolidates well data, Surface Location removed as duplicate)
                'Key Dates': ['dates'],
                // 'Well Type' removed - merged into 'Well Information'
                'Lateral Details': ['lateral_details'],
                'Perforated Intervals': ['perforated_intervals', 'total_perforated_length_ft'],
                'Initial Production': ['initial_production'],
                'First Sales': ['first_sales'],
                'Stimulation': ['stimulation'],
                'Formation Zones': ['formation_zones'],
                'Formation Tops': ['formation_tops'],
                // 'Status' removed - OCC status not needed for mineral owners
                // Well Transfer sections (Former Operator, New Operator already defined in Change of Operator section)
                'Transfer Information': ['transfer_info'],
                'Wells Transferred': ['wells'],
                'Transfer Summary': ['summary'],
                'Notes': ['notes', 'additional_info'],
                // Unitization Order sections
                'Unit Summary': ['unit_info'],
                'Unit Order Details': ['order_info', 'commissioners'],  // Unitization-specific order info (prevents 'Pooling Order Details')
                'Allocation Formula': ['allocation_formula'],
                'Unit Boundaries': ['location'],
                'Authorized Operations': ['authorized_operations'],
                'Superseded Orders': ['related_orders'],
                'Termination Provisions': ['termination_provisions'],
                'Ratification': ['ratification'],
                // 'All Tracts' removed - tracts now handled by 'Tracts & Interest' for deeds
                'Exhibits': ['exhibits'],
                'Reference Well': ['reference_well'],
                'Unit Parties': ['parties'],  // Unitization order parties (applicant + other_parties)
                'Other Information': []  // Catch-all for fields not in other groups
            };
            
            const grouped = {};
            const processedFields = new Set();

            // Build a lowercase map of group fields for case-insensitive matching
            // Handle both snake_case and space-separated formats
            const fieldToSection = {};
            for (const [section, fields] of Object.entries(groups)) {
                for (const field of fields) {
                    // Add snake_case version
                    fieldToSection[field.toLowerCase()] = section;
                    // Add space-separated version (deed_type -> deed type)
                    fieldToSection[field.toLowerCase().replace(/_/g, ' ')] = section;
                    // Add title case version (deed_type -> Deed Type)
                    const titleCase = field.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()).toLowerCase();
                    fieldToSection[titleCase] = section;
                }
            }

            // First pass: assign data fields to their designated groups (case-insensitive)
            for (const [dataField, value] of Object.entries(data)) {
                // Normalize to lowercase, try both snake_case and space formats
                const dataFieldLower = dataField.toLowerCase();
                const dataFieldNormalized = dataFieldLower.replace(/\s+/g, '_');

                // Skip confidence fields
                if (dataFieldNormalized.endsWith('_confidence') ||
                    dataFieldLower.endsWith(' confidence') ||
                    dataFieldNormalized.includes('confidence_')) {
                    processedFields.add(dataField);
                    continue;
                }

                // Check if this field belongs to a group (try multiple formats)
                let section = fieldToSection[dataFieldLower] ||
                               fieldToSection[dataFieldNormalized] ||
                               fieldToSection[dataFieldLower.replace(/_/g, ' ')];

                // If no exact match, try prefix-based pattern matching for pooling order fields
                if (!section) {
                    if (dataFieldLower.startsWith('legal representation') ||
                        dataFieldLower.startsWith('legal_representation')) {
                        section = 'Applicant Information';
                    } else if (dataFieldLower.startsWith('order execution') ||
                               dataFieldLower.startsWith('order_execution')) {
                        section = 'Pooling Order Details';
                    } else if (dataFieldLower.startsWith('additional provisions subsequent wells') ||
                               dataFieldLower.startsWith('additional_provisions_subsequent_wells') ||
                               dataFieldLower.startsWith('additional provisions bonus payment') ||
                               dataFieldLower.startsWith('additional_provisions_bonus_payment') ||
                               dataFieldLower.startsWith('additional provisions replacement wells') ||
                               dataFieldLower.startsWith('additional_provisions_replacement_wells')) {
                        section = 'Subsequent Wells';
                    } else if (dataFieldLower.startsWith('exhibit a respondents') ||
                               dataFieldLower.startsWith('exhibit_a_respondents')) {
                        section = 'Additional Parties';
                    } else if (dataFieldLower.startsWith('additional provisions operator lien') ||
                               dataFieldLower.startsWith('additional_provisions_operator_lien')) {
                        section = 'Notes';
                    }
                }

                if (section && value !== null && value !== undefined && value !== '') {
                    // Skip interest fields that are 0 (only show interests with actual values)
                    const interestFields = ['working_interest', 'royalty_interest', 'overriding_royalty_interest',
                                           'net_revenue_interest', 'non_participating_royalty_interest'];
                    if (interestFields.includes(dataFieldNormalized) && (value === 0 || value === '0' || value === 0.0)) {
                        processedFields.add(dataField);
                        continue;
                    }

                    if (!grouped[section]) {
                        grouped[section] = {};
                    }
                    grouped[section][dataField] = value;
                    processedFields.add(dataField);
                }
            }
            
            // Add Observations if notes exist
            if (data.notes) {
                grouped['Observations'] = { observations: data.notes };
                processedFields.add('notes');
            }
            
            // Second pass: add any remaining fields to "Other Information"
            const otherFields = {};
            for (const [field, value] of Object.entries(data)) {
                // Skip if already processed
                if (processedFields.has(field)) continue;

                // Normalize field name for comparison (handle both snake_case and spaces)
                const fieldLower = field.toLowerCase().replace(/\s+/g, '_');
                const fieldWithSpaces = field.toLowerCase();

                // Skip confidence-related fields (various patterns)
                if (fieldLower.endsWith('_confidence') ||
                    fieldWithSpaces.endsWith(' confidence') ||
                    fieldLower.includes('confidence_') ||
                    fieldLower === 'field_scores' ||
                    fieldLower === 'document_confidence' ||
                    fieldLower === 'fields_needing_review' ||
                    fieldLower === 'notes' ||
                    fieldLower === 'doc_type' ||
                    // Skip chain_of_title and all its sub-fields (internal data for Phase 2)
                    fieldLower.startsWith('chain_of_title') ||
                    fieldWithSpaces.startsWith('chain of title') ||
                    fieldLower.includes('chain_of_title') ||
                    fieldWithSpaces.includes('chain of title') ||
                    // Skip reservation sub-fields (handled specially in Interest section)
                    (fieldLower.startsWith('reservation_') && fieldLower !== 'reservation') ||
                    (fieldWithSpaces.startsWith('reservation ') && fieldWithSpaces !== 'reservation') ||
                    // Skip internal metadata (page info from multi-document splitting)
                    fieldLower === 'start_page' ||
                    fieldWithSpaces === 'start page' ||
                    fieldLower.includes('start_page') ||
                    fieldLower === '_split_metadata' ||
                    fieldLower === 'split_metadata' ||
                    fieldLower.includes('split_metadata') ||
                    fieldWithSpaces.includes('start page') ||
                    fieldLower === 'end_page' ||
                    fieldWithSpaces === 'end page' ||
                    fieldLower.includes('end_page') ||
                    fieldWithSpaces.includes('end page') ||
                    fieldLower === 'page_count' ||
                    fieldLower === 'page_number' ||
                    fieldLower === 'prior_instruments' ||
                    fieldLower === 'property_acquisition' ||
                    fieldLower === 'will_and_probate' ||
                    fieldLower === 'unpaid_debts' ||
                    fieldLower === 'inheritance_tax_status' ||
                    fieldLower === 'notary' ||
                    fieldLower === 'recording_info' ||
                    fieldLower === 'adopted_stepchildren' ||
                    fieldLower === 'grandchildren_of_predeceased' ||
                    // Skip internal validation/review metadata (causes [object Object] display)
                    fieldLower === '_schema_validation' ||
                    fieldLower === '_review_flags' ||
                    fieldLower === '_validation_issues' ||
                    fieldLower === '_flag_details') {
                    continue;
                }
                
                // Skip null/undefined/empty values and "None"/"N/A" strings
                if (value === null || value === undefined || value === '') {
                    continue;
                }
                // Skip interest fields that are 0 (only show the interest type that has a value)
                const interestFields = ['working_interest', 'royalty_interest', 'overriding_royalty_interest',
                                       'net_revenue_interest', 'non_participating_royalty_interest'];
                if (interestFields.includes(fieldLower) && (value === 0 || value === '0' || value === 0.0)) {
                    continue;
                }
                // Skip string values that are essentially empty
                if (typeof value === 'string') {
                    const trimmed = value.trim().toLowerCase();
                    if (trimmed === '' || trimmed === 'none' || trimmed === 'n/a' || trimmed === 'null' || trimmed === 'undefined') {
                        continue;
                    }
                }
                // Skip empty arrays
                if (Array.isArray(value) && value.length === 0) {
                    continue;
                }
                // Skip empty objects
                if (typeof value === 'object' && !Array.isArray(value) && Object.keys(value).length === 0) {
                    continue;
                }

                otherFields[field] = value;
            }
            
            if (Object.keys(otherFields).length > 0) {
                grouped['Other Information'] = otherFields;
            }
            
            return grouped;
        }
        
        // Render all fields dynamically
        function renderExtractedData(data, fieldScores) {
            let content = '';

            // Key Takeaway - render prominently at the very top, outside sections
            if (data.key_takeaway) {
                // Clean up formatting issues - remove markdown headers, rules, and excessive whitespace
                let cleanedTakeaway = String(data.key_takeaway)
                    .trim()
                    .replace(/^#{1,6}\s*/gm, '') // Remove leading # headers from lines
                    .replace(/^---+$/gm, '') // Remove horizontal rules
                    .replace(/\*\*([^*]+)\*\*/g, '$1') // Remove paired bold markers
                    .replace(/\*\*/g, '') // Remove orphaned ** markers
                    .replace(/^\s+/gm, '') // Remove leading spaces from each line
                    .replace(/\t/g, ' ') // Replace tabs with spaces
                    .replace(/\n{3,}/g, '\n\n'); // Collapse multiple newlines

                content += `<div style="margin-bottom: 16px;">
                    <details class="key-takeaway-block" open>
                        <summary class="key-takeaway-trigger">
                            <span class="details-chevron">&#9654;</span>
                            <span class="key-takeaway-label">Key Takeaway</span>
                        </summary>
                        <div class="key-takeaway-content">${escapeHtml(cleanedTakeaway)}</div>
                    </details>
                </div>`;
            }

            // Detailed Analysis - render right after Key Takeaway, full width, not nested
            // Check for both ai_observations (older schemas) and detailed_analysis (newer schemas)
            const analysisText = data.ai_observations || data.detailed_analysis;
            if (analysisText) {
                const cleanedAnalysis = String(analysisText)
                    .trim()
                    .replace(/^\s+/gm, '')
                    .replace(/\t/g, ' ');

                content += `<div style="margin-bottom: 20px;">
                    <details class="detailed-analysis-block">
                        <summary class="detailed-analysis-trigger">
                            <span class="details-chevron">&#9654;</span>
                            <span class="detailed-analysis-label">View Detailed Analysis</span>
                            <span class="detailed-analysis-hint">Click to expand</span>
                        </summary>
                        <div class="detailed-analysis-content">${formatAnalysisText(cleanedAnalysis)}</div>
                    </details>
                </div>`;
            }

            const groupedFields = groupFieldsBySection(data);

            // Define section order (Key Takeaway and Detailed Analysis rendered above, not in sections)
            const sectionOrder = [
                // Mineral Deed sections (chain of title priority)
                'Parties',
                'Tracts & Interest',
                'Reservation',
                'Recording & Execution',
                'Prior Instruments',
                // Drilling and Spacing Order sections (v2 schema)
                'Spacing Units',
                'Companion Causes',
                // Increased Density Order sections (in priority order)
                'Order Details',
                'Officials',
                'Operator Information',
                'Applicant Information',
                'Legal Description',
                // Change of Operator sections (placed here for proper ordering)
                'Former Operator',
                'New Operator',
                'Affected Wells',
                'Subsequent Wells',  // Shared with pooling orders
                'Target Formations',
                'Order Information',  // For location exception and change of operator
                'Modified Orders',
                'Unit Information',
                // 'Well Authorization' and 'Allocation Factors' moved to Multi-Unit Horizontal Order section below
                'Existing Wells',
                'Recoverable Reserves',
                'Expiration',
                'Related Orders',
                // Pooling Order sections (in priority order - most actionable first)
                'Election Options',
                'Well Details',
                'Formations',
                'Important Deadlines',
                'Default Election',
                // 'Subsequent Wells' - moved up to Change of Operator section
                'Pooling Order Details',
                'Notes',
                'Additional Parties',
                // Division Order sections (consolidated)
                'Operator & Well',
                'Owner & Interest',
                'Terms & Unit',
                // 'Parties' - already in Mineral Deed sections above
                // 'Interest & Consideration' - already in Mineral Deed sections above
                // 'Recording & Execution' - already in Mineral Deed sections above
                // Check Stub / Revenue Statement sections
                'Payment Information',
                'Well Revenue',
                'Check Summary',
                'Operating Expenses',
                'Title & Warranties',
                'Restrictions & Provisions',
                // 'Lease Terms' - consolidated into Terms & Unit for division orders
                'Lease Clauses',
                'Well Information',
                'Order Details',
                'Hearing Details',
                'Document References',
                // Drilling Permit (Form 1000) sections
                'Permit Information',
                'Well Identification',
                'Surface Location',
                'Bottom Hole Location',
                'Target Formation',
                'Unit Details',
                'Multi-Unit Sections',
                // Trust Funding sections
                'Assignment Flags',
                'Property Coverage',
                'Trustee Acceptance',
                // Limited Partnership sections
                'Entity Information',
                'Partnership Term',
                'Principal Office',
                'General Partners',
                'Limited Partners',
                'Business Purpose',
                'Capital Provisions',
                'Management & Governance',
                'Succession & Assignment',
                'Dissolution',
                // Assignment of Lease sections
                'Assignors',
                'Assignees',
                'Interest Assigned',
                'Retained Interests',
                'Subject To',
                'Proportionate Reduction',
                'Underlying Lease',
                'Warranties',
                // Quit Claim Deed sections (Grantors/Grantees use 'Parties' section)
                'Deed Classification',
                'Granting Clause',
                'Reservations & Exceptions',
                'Return To',
                'Chain of Title Links',
                'Annotations',
                // Location Exception Order sections (Order Information and Modified Orders moved up)
                'Exception Details',
                'Lateral Path',
                'Vertical Well Location',
                'Allowable',
                'Offset Impact',
                'Conditions',
                // Death Certificate sections
                'Certificate Information',
                'Decedent',
                'Death Location',
                'Residence at Death',
                'Marital Status',
                'Parents',
                'Family Members',
                'Cause of Death',
                'Disposition',
                'Certification',
                'Consular Information',
                'Chain of Title',
                'Related Documents',
                // Multi-Unit Horizontal Order sections
                'Well Authorization',
                'Well Location',
                'Allocation Factors',
                'Relief Granted',
                'Special Provisions',
                // Completion Report sections (Well Identification, Surface/Bottom Hole Location defined above)
                'Key Dates',
                'Well Type',
                'Lateral Details',
                'Perforated Intervals',
                'Initial Production',
                'First Sales',
                'Stimulation',
                'Formation Tops',
                // Note: Allocation Factors already in list above - used for both multiunit orders and completion reports
                'Status',
                // Well Transfer sections (Former Operator, New Operator already defined above for Change of Operator)
                'Transfer Information',
                'Wells Transferred',
                'Transfer Summary',
                // Unitization Order sections
                'Unit Summary',
                'Unit Order Details',  // Order number, cause number, dates, commissioners
                'Allocation Formula',
                // Note: Target Formations already in list above - don't duplicate
                'Reference Well',
                'Unit Boundaries',
                'Authorized Operations',
                'Superseded Orders',
                'Termination Provisions',
                'Ratification',
                'Exhibits',
                'Unit Parties',
                // Correspondence sections
                'Letter Details',
                'Other Information'
            ];
            
            // Render sections in defined order
            const docType = data.doc_type;
            for (const sectionName of sectionOrder) {
                // Custom check_stub section rendering — must run BEFORE visibility filter
                // because wells/summary/operating_expenses are in the hide list (they use custom renderers)
                if (data.doc_type === 'check_stub') {
                    if (sectionName === 'Well Revenue' && Array.isArray(data.wells) && data.wells.length > 0) {
                        content += renderCheckStubWellRevenue(data.wells);
                        continue;
                    }
                    if (sectionName === 'Check Summary' && data.summary && typeof data.summary === 'object') {
                        content += renderCheckStubSummary(data.summary);
                        continue;
                    }
                    if (sectionName === 'Operating Expenses' && Array.isArray(data.operating_expenses) && data.operating_expenses.length > 0) {
                        content += renderCheckStubOperatingExpenses(data.operating_expenses);
                        continue;
                    }
                }

                const fields = groupedFields[sectionName];
                if (!fields) continue;

                // Filter out fields that shouldn't be displayed based on doc type
                const visibleFieldNames = Object.keys(fields).filter(fn => shouldDisplayField(fn, docType));
                if (visibleFieldNames.length === 0) continue;

                // Skip Legal Description section if data has 'units' array (drilling/spacing orders)
                // because the detailed legal info is shown in the Spacing Units section
                if (sectionName === 'Legal Description' && data.units && Array.isArray(data.units)) {
                    continue;
                }

                // Skip Legal Description for death certificates (no TRS - county/state are domicile, not property)
                if (sectionName === 'Legal Description' && data.doc_type === 'death_certificate') {
                    continue;
                }

                // Build section content first to check if it's empty
                let sectionContent = '';
                let hasVisibleFields = false;
                
                // Track if legal_description object was processed to avoid duplicate flat fields
                const hasLegalDescObject = fields.legal_description && typeof fields.legal_description === 'object';
                const legalDescFlatFields = ['section', 'township', 'range', 'county', 'state', 'meridian', 'quarters', 'quarter', 'quarter_section', 'lot_block', 'acres', 'acreage'];

                for (const [fieldName, value] of Object.entries(fields)) {
                    // Skip fields that shouldn't be displayed for this doc type
                    if (!shouldDisplayField(fieldName, docType)) {
                        continue;
                    }

                    // Skip flat legal description fields if we already have the object
                    if (hasLegalDescObject && legalDescFlatFields.includes(fieldName.toLowerCase())) {
                        continue;
                    }

                    // Special handling for observations
                    if (fieldName === 'observations' && sectionName.includes('Observations')) {
                        const observations = escapeHtml(String(value));
                        const isLong = observations.length > 200;
                        
                        sectionContent += '<div id="observationsContainer" style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 12px; font-size: 13px; line-height: 1.5; color: #6B7280; width: 100%; grid-column: 1 / -1;">';
                        
                        if (isLong) {
                            const truncated = observations.substring(0, 200) + '...';
                            sectionContent += `<div id="observationsText" data-full="${observations.replace(/"/g, '&quot;')}" data-truncated="${truncated.replace(/"/g, '&quot;')}">${truncated}</div>`;
                            sectionContent += `<button type="button" onclick="toggleObservations()" id="observationsToggle" style="background: none; border: none; color: #1D6F5C; cursor: pointer; font-size: 13px; margin-top: 8px; padding: 0;">Show more ▶</button>`;
                        } else {
                            sectionContent += observations;
                        }
                        
                        sectionContent += '</div>';
                        hasVisibleFields = true;
                        continue;
                    }
                    // Special handling for legal_description - use condensed format
                    if (fieldName === 'legal_description' && typeof value === 'object') {
                        const condensed = condenseLegal(value);
                        if (condensed) {
                            // Handle multi-section (newline separated) with styled chips
                            const locations = condensed.split('\n').filter(s => s.trim());
                            if (locations.length > 1) {
                                sectionContent += `<div class="doc-field" style="grid-column: 1 / -1;">`;
                                sectionContent += `<label>Legal Description</label>`;
                                sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                                locations.forEach(loc => {
                                    sectionContent += `
                                        <div style="background: #F0F9FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 6px 10px;">
                                            <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(loc)}</span>
                                        </div>`;
                                });
                                sectionContent += `</div></div>`;
                            } else {
                                sectionContent += `
                                    <div class="doc-field">
                                        <label>Legal Description</label>
                                        <div class="doc-value">${escapeHtml(condensed)}</div>
                                    </div>`;
                            }
                            hasVisibleFields = true;
                        }
                    } else if (fieldName.toLowerCase() === 'wells' && Array.isArray(value) && value.length > 0 && typeof value[0] === 'object' && (value[0].api_number !== undefined || value[0].well_name !== undefined)) {
                        // Special handling for wells array (well transfer) - BEFORE generic array handler
                        // Handles both detailed well lists (with api_number) and summary entries (well_name only)
                        hasVisibleFields = true;
                        // Check if this is detailed well data (has api_number) or summary data (well_name only)
                        const hasDetailedData = value.some(w => w.api_number);

                        if (hasDetailedData) {
                            // Render detailed wells table
                            const statusLabels = {
                                'AC': 'Active', 'TA': 'Temp Abandoned', 'SP': 'Spudded',
                                'ND': 'Not Drilled', 'TM': 'Temp Shut-in', 'PA': 'Perm Abandoned', 'CM': 'Commingled'
                            };
                            let wellsHtml = value.map(well => {
                                const api = well.api_number || '';
                                const name = well.well_name || '';
                                const num = well.well_number || '';
                                const type = well.well_type || '';
                                const status = well.well_status || '';
                                const statusLabel = statusLabels[status] || status;
                                const section = well.section || '';
                                const township = well.township || '';
                                const range = well.range || '';
                                const county = well.county || '';
                                const comments = well.comments || '';
                                const typeColor = type === 'OIL' ? '#92400E' : (type === 'GAS' ? '#1E40AF' : '#6B7280');
                                const statusColor = status === 'AC' ? '#16A34A' : (status === 'TA' || status === 'TM' ? '#F59E0B' : '#6B7280');
                                return `<tr style="border-bottom: 1px solid #E5E7EB;">
                                    <td style="padding: 10px 8px;"><span style="font-family: monospace; font-size: 12px; color: #6B7280;">${escapeHtml(api)}</span></td>
                                    <td style="padding: 10px 8px; font-weight: 600;">${escapeHtml(name)} ${num ? `<span style="font-weight: 400; color: #6B7280;">${escapeHtml(num)}</span>` : ''}</td>
                                    <td style="padding: 10px 8px;"><span style="background: ${typeColor}15; color: ${typeColor}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${escapeHtml(type)}</span></td>
                                    <td style="padding: 10px 8px;"><span style="color: ${statusColor}; font-size: 12px;">${escapeHtml(statusLabel)}</span></td>
                                    <td style="padding: 10px 8px; font-family: monospace; font-size: 12px;">${section ? `S${section}` : ''}-${escapeHtml(String(township))}-${escapeHtml(String(range))}</td>
                                    <td style="padding: 10px 8px; font-size: 12px; color: #6B7280;">${escapeHtml(county)}</td>
                                </tr>${comments ? `<tr style="background: #FEF3C7;"><td colspan="6" style="padding: 4px 8px 4px 20px; font-size: 11px; color: #92400E;">⚠️ ${escapeHtml(comments)}</td></tr>` : ''}`;
                            }).join('');
                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 13px; background: white; border: 1px solid #E5E7EB; border-radius: 8px; overflow: hidden; min-width: 700px;">
                                            <thead style="background: #F3F4F6;">
                                                <tr>
                                                    <th style="padding: 10px 8px; text-align: left; font-weight: 600; color: #374151;">API</th>
                                                    <th style="padding: 10px 8px; text-align: left; font-weight: 600; color: #374151;">Well Name</th>
                                                    <th style="padding: 10px 8px; text-align: left; font-weight: 600; color: #374151;">Type</th>
                                                    <th style="padding: 10px 8px; text-align: left; font-weight: 600; color: #374151;">Status</th>
                                                    <th style="padding: 10px 8px; text-align: left; font-weight: 600; color: #374151;">Location</th>
                                                    <th style="padding: 10px 8px; text-align: left; font-weight: 600; color: #374151;">County</th>
                                                </tr>
                                            </thead>
                                            <tbody>${wellsHtml}</tbody>
                                        </table>
                                    </div>
                                    <div style="margin-top: 8px; font-size: 12px; color: #6B7280;">${value.length} well${value.length !== 1 ? 's' : ''} transferred</div>
                                    ${getConfidenceIndicator(fieldName, fieldScores)}
                                </div>`;
                        } else {
                            // Render summary info box (cover/summary pages without individual well details)
                            let summaryHtml = value.map(item => {
                                const name = item.well_name || '';
                                const comments = item.comments || '';
                                return `<div style="background: #F0F9FF; border: 1px solid #0EA5E9; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                                    ${name ? `<div style="font-weight: 500; color: #0369A1; margin-bottom: 4px;">${escapeHtml(name)}</div>` : ''}
                                    ${comments ? `<div style="font-size: 13px; color: #475569;">${escapeHtml(comments)}</div>` : ''}
                                </div>`;
                            }).join('');
                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    ${summaryHtml}
                                    ${getConfidenceIndicator(fieldName, fieldScores)}
                                </div>`;
                        }
                    } else if (Array.isArray(value)) {
                        // Handle arrays
                        if (value.length > 0) {
                            hasVisibleFields = true;
                            sectionContent += `<div class="doc-field" style="grid-column: 1 / -1;">`;
                            sectionContent += `<label>${formatFieldName(fieldName)}</label>`;

                            if (fieldName === 'grantors' || fieldName === 'grantees') {
                                // Special handling for grantors/grantees arrays with detailed info (v2 schema and quit_claim_deed)
                                const partyType = fieldName === 'grantors' ? 'Grantor' : 'Grantee';
                                const bgColor = fieldName === 'grantors' ? '#FEF3C7' : '#F0FDF4';
                                const borderColor = fieldName === 'grantors' ? '#F59E0B' : '#22C55E';
                                const textColor = fieldName === 'grantors' ? '#92400E' : '#166534';

                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach((party, index) => {
                                    if (typeof party === 'object') {
                                        const name = party.name || 'Unknown';
                                        const nameVariations = party.name_variations || [];
                                        const address = party.address || '';
                                        const city = party.city || '';
                                        const state = party.state || '';
                                        const capacity = party.capacity || '';  // Trustee, Personal Representative, etc.
                                        const entityName = party.entity_name || '';  // Trust/entity name
                                        const entityType = party.entity_type || '';  // Trust, LLC, etc.
                                        const trustDate = party.trust_date || '';    // Trust date if trustee
                                        const tenancy = party.tenancy || '';    // joint_tenants_wros, tenants_in_common, etc.
                                        const maritalStatus = party.marital_status || '';

                                        // Format tenancy for display
                                        const tenancyDisplay = tenancy ? tenancy.replace(/_/g, ' ').replace(/wros/gi, 'WROS') : '';

                                        // Format full address
                                        const fullAddress = [address, city, state].filter(Boolean).join(', ');

                                        sectionContent += `
                                            <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 6px; padding: 10px 12px;">
                                                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                                    <span style="font-weight: 600; color: ${textColor};">${escapeHtml(name)}</span>
                                                    ${capacity ? `<span style="background: #E5E7EB; color: #374151; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">${escapeHtml(capacity)}</span>` : ''}
                                                </div>
                                                ${entityName ? `<div style="font-size: 12px; color: #7C3AED; margin-top: 4px; font-weight: 500;">${escapeHtml(entityName)}${entityType ? ` (${escapeHtml(entityType)})` : ''}${trustDate ? ` dated ${escapeHtml(trustDate)}` : ''}</div>` : ''}
                                                ${fullAddress ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(fullAddress)}</div>` : ''}
                                                ${nameVariations.length > 0 ? `<div style="font-size: 11px; color: #9CA3AF; margin-top: 4px; font-style: italic;">Also known as: ${nameVariations.map(v => escapeHtml(v)).join(', ')}</div>` : ''}
                                                <div style="display: flex; gap: 12px; margin-top: 4px; flex-wrap: wrap;">
                                                    ${maritalStatus ? `<span style="font-size: 11px; color: #9CA3AF; text-transform: capitalize;">${escapeHtml(maritalStatus)}</span>` : ''}
                                                    ${tenancyDisplay ? `<span style="font-size: 11px; color: #6B7280; text-transform: capitalize;">${escapeHtml(tenancyDisplay)}</span>` : ''}
                                                </div>
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 6px; padding: 10px 12px;">
                                                <span style="font-weight: 600; color: ${textColor};">${escapeHtml(String(party))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'heirs_summary') {
                                // Special handling for heirs summary with shares
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(heir => {
                                    if (typeof heir === 'object') {
                                        const name = heir.name || 'Unknown';
                                        const relationship = heir.relationship || '';
                                        const share = heir.estimated_share || heir.share || '';
                                        const shareDecimal = heir.share_decimal;

                                        sectionContent += `
                                            <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <span style="font-weight: 600; color: #1E40AF;">${escapeHtml(name)}</span>
                                                    ${relationship ? `<span style="color: #6B7280; font-size: 12px; margin-left: 8px;">(${escapeHtml(relationship)})</span>` : ''}
                                                </div>
                                                ${share ? `<span style="background: #DBEAFE; color: #1E40AF; padding: 4px 10px; border-radius: 4px; font-weight: 500;">${escapeHtml(share)}</span>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `<div style="padding: 8px; background: #EFF6FF; border-radius: 4px;">${escapeHtml(String(heir))}</div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'children_living' || fieldName === 'spouses') {
                                // Special handling for children and spouses arrays
                                const bgColor = fieldName === 'children_living' ? '#F0FDF4' : '#FAF5FF';
                                const borderColor = fieldName === 'children_living' ? '#22C55E' : '#A855F7';
                                const textColor = fieldName === 'children_living' ? '#166534' : '#7C3AED';

                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(person => {
                                    if (typeof person === 'object') {
                                        const name = person.name || 'Unknown';
                                        const address = person.address || '';
                                        const spouseName = person.spouse_name || '';
                                        const status = person.status || '';
                                        const marriageDate = person.marriage_date || '';

                                        sectionContent += `
                                            <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 6px; padding: 10px 12px;">
                                                <div style="font-weight: 600; color: ${textColor};">${escapeHtml(name)}</div>
                                                ${status ? `<div style="font-size: 11px; color: #9CA3AF; text-transform: capitalize;">${escapeHtml(status)}</div>` : ''}
                                                ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(address)}</div>` : ''}
                                                ${spouseName ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Spouse: ${escapeHtml(spouseName)}</div>` : ''}
                                                ${marriageDate ? `<div style="font-size: 11px; color: #9CA3AF;">Married: ${escapeHtml(marriageDate)}</div>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `<div style="padding: 8px; background: ${bgColor}; border-radius: 4px;">${escapeHtml(String(person))}</div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'election_options') {
                                // Special handling for election options
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
                                value.forEach((option, index) => {
                                    // Support both option.type and option.option_type
                                    const optType = (option.option_type || option.type || '').toLowerCase();
                                    const isDefault = option.is_default === true;

                                    // Color coding: green=default, blue=participate, grey=other
                                    let optionBgColor, optionBorderColor, optionTextColor, borderWidth;
                                    if (isDefault) {
                                        // Default option - green with thicker border
                                        optionBgColor = '#DCFCE7'; optionBorderColor = '#22C55E'; optionTextColor = '#166534'; borderWidth = '2px';
                                    } else if (optType === 'participate') {
                                        // Participate option - blue
                                        optionBgColor = '#EFF6FF'; optionBorderColor = '#3B82F6'; optionTextColor = '#1E40AF'; borderWidth = '1px';
                                    } else if (optType === 'non_consent') {
                                        // Non-consent option - red (warning)
                                        optionBgColor = '#FEE2E2'; optionBorderColor = '#EF4444'; optionTextColor = '#DC2626'; borderWidth = '1px';
                                    } else {
                                        // All other options - grey
                                        optionBgColor = '#F3F4F6'; optionBorderColor = '#9CA3AF'; optionTextColor = '#4B5563'; borderWidth = '1px';
                                    }

                                    sectionContent += `
                                        <div style="background: ${optionBgColor}; border: ${borderWidth} solid ${optionBorderColor}; border-radius: 8px; padding: 14px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                <div style="font-weight: 600; color: ${optionTextColor}; font-size: 14px;">Option ${option.option_number || index + 1}${optType ? ` - ${formatFieldName(optType)}` : ''}</div>
                                                ${isDefault ? `<span style="background: #22C55E; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">DEFAULT</span>` : ''}
                                            </div>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; font-size: 13px;">
                                                ${option.bonus_per_nma ? `<div><span style="color: #6B7280;">Bonus:</span> <strong>$${option.bonus_per_nma.toLocaleString()}/NMA</strong></div>` : ''}
                                                ${option.bonus_per_acre ? `<div><span style="color: #6B7280;">Bonus:</span> <strong>$${option.bonus_per_acre}/acre</strong></div>` : ''}
                                                ${option.cost_per_nma ? `<div><span style="color: #6B7280;">Est. Cost:</span> <strong>$${option.cost_per_nma.toLocaleString()}/NMA</strong></div>` : ''}
                                                ${option.royalty_rate ? `<div><span style="color: #6B7280;">Royalty:</span> <strong>${option.royalty_rate}</strong></div>` : ''}
                                                ${option.excess_royalty ? `<div><span style="color: #6B7280;">Excess Royalty:</span> <strong>${option.excess_royalty}</strong></div>` : ''}
                                                ${option.nri_delivered ? `<div><span style="color: #6B7280;">NRI Delivered:</span> <strong>${option.nri_delivered}</strong></div>` : ''}
                                                ${option.risk_penalty_percentage ? `<div><span style="color: #DC2626;">Risk Penalty:</span> <strong style="color: #DC2626;">${option.risk_penalty_percentage}%</strong></div>` : ''}
                                            </div>
                                            ${option.description ? `<div style="margin-top: 8px; font-size: 13px; color: #4B5563; border-top: 1px solid ${optionBorderColor}; padding-top: 8px;">${escapeHtml(option.description)}</div>` : ''}
                                            ${option.notes ? `<div style="margin-top: 4px; font-size: 12px; color: #6B7280; font-style: italic;">${escapeHtml(option.notes)}</div>` : ''}
                                        </div>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'formations') {
                                // Special handling for formations array (pooling orders)
                                sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                                value.forEach(formation => {
                                    if (typeof formation === 'object') {
                                        const name = formation.name || formation.formation || 'Unknown';
                                        const depthInfo = formation.depth_from && formation.depth_to
                                            ? ` (${formation.depth_from.toLocaleString()}' - ${formation.depth_to.toLocaleString()}')`
                                            : '';
                                        sectionContent += `
                                            <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 8px 12px;">
                                                <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(name)}</span>
                                                ${depthInfo ? `<span style="color: #6B7280; font-size: 12px;">${depthInfo}</span>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 8px 12px;">
                                                <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(String(formation))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'target_formations') {
                                // Special handling for target formations array
                                // Supports increased density (name, common_source) and location exception (formation_name, qualifier)
                                sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                                value.forEach(formation => {
                                    const name = formation.name || formation.formation_name || '';
                                    const isPrimary = formation.is_primary;
                                    const commonSource = formation.common_source || '';
                                    const qualifier = formation.qualifier || '';
                                    if (name) {
                                        sectionContent += `
                                            <div style="background: ${isPrimary ? '#DCFCE7' : '#F3F4F6'}; border: 1px solid ${isPrimary ? '#22C55E' : '#D1D5DB'}; border-radius: 8px; padding: 10px 14px;">
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <span style="font-weight: 600; color: ${isPrimary ? '#166534' : '#374151'}; font-size: 14px;">${escapeHtml(name)}</span>
                                                    ${qualifier ? `<span style="color: #6B7280; font-size: 12px;">(${escapeHtml(qualifier)})</span>` : ''}
                                                    ${isPrimary ? `<span style="background: #166534; color: white; font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 3px;">PRIMARY</span>` : ''}
                                                </div>
                                                ${commonSource ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(commonSource)}</div>` : ''}
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'allocation_factors') {
                                // Special handling for allocation factors array (multiunit wells and completion reports)
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                sectionContent += `<div style="font-size: 12px; color: #6B7280; margin-bottom: 4px;">Production and costs are allocated across these sections:</div>`;
                                value.forEach(factor => {
                                    const section = factor.section || '';
                                    const township = factor.township || '';
                                    const range = factor.range || '';
                                    const percentage = factor.percentage;
                                    const acres = factor.acres;
                                    const pun = factor.pun || '';
                                    const isSurface = factor.is_surface_location;
                                    const location = section ? `Section ${section}${township ? ` - ${township}` : ''}${range ? `-${range}` : ''}` : '';

                                    if (location) {
                                        sectionContent += `
                                            <div style="background: #F0F9FF; border: 1px solid #0EA5E9; border-radius: 8px; padding: 12px 14px;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <span style="font-weight: 600; color: #0369A1; font-size: 14px;">${escapeHtml(location)}</span>
                                                        ${acres ? `<span style="color: #6B7280; font-size: 12px; margin-left: 8px;">(${acres.toLocaleString()} acres)</span>` : ''}
                                                        ${isSurface ? `<span style="background: #DBEAFE; color: #1E40AF; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">SURFACE</span>` : ''}
                                                    </div>
                                                    ${percentage !== undefined ? `<span style="background: #0369A1; color: white; padding: 4px 12px; border-radius: 6px; font-weight: 600; font-size: 14px;">${percentage}%</span>` : ''}
                                                </div>
                                                ${pun ? `<div style="margin-top: 6px; font-size: 11px; color: #6B7280;">OTC PUN: <span style="font-family: monospace; background: #F3F4F6; padding: 2px 6px; border-radius: 3px;">${escapeHtml(pun)}</span></div>` : ''}
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'existing_wells') {
                                // Special handling for existing wells array (from increased density orders)
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(well => {
                                    if (typeof well === 'object') {
                                        const wellName = well.well_name || well.name || 'Unknown Well';
                                        const apiNumber = well.api_number || well.api || '';
                                        const classification = well.well_classification || well.classification || well.type || '';
                                        sectionContent += `
                                            <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 6px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <span style="font-weight: 500; color: #166534;">${escapeHtml(wellName)}</span>
                                                    ${apiNumber ? `<span style="color: #6B7280; font-size: 12px; margin-left: 8px;">API: ${escapeHtml(apiNumber)}</span>` : ''}
                                                </div>
                                                ${classification ? `<span style="background: ${classification.toLowerCase() === 'oil' ? '#FEE2E2' : '#DBEAFE'}; color: ${classification.toLowerCase() === 'oil' ? '#92400E' : '#1E40AF'}; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">${escapeHtml(classification)}</span>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 6px; padding: 10px 12px;">
                                                <span style="font-weight: 500; color: #166534;">${escapeHtml(String(well))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'tracts' && data.doc_type === 'unitization_order') {
                                // Special handling for unitization order tracts (participation percentages)
                                hasVisibleFields = true;

                                const tractCount = value.length;
                                const showCollapsed = tractCount > 10;
                                const tableId = `tracts-table-${Date.now()}`;
                                const searchId = `tracts-search-${Date.now()}`;

                                // Check for split tracts (A/B designations)
                                const hasSplitTracts = value.some(t => /[AB]$/.test(t.tract_number || ''));

                                let tableRows = value.map(tract => {
                                    const tractNum = tract.tract_number || '';
                                    const isSplit = /[AB]$/.test(tractNum);
                                    const section = tract.section || '';
                                    const twp = tract.township || '';
                                    const rng = tract.range || '';
                                    const county = tract.county || '';
                                    const acres = tract.acres;
                                    const participation = tract.participation_percent;
                                    const qualifier = tract.formation_qualifier || '';

                                    // Format participation as percentage
                                    const partDisplay = participation ? participation.toFixed(6) + '%' : '';

                                    return `
                                        <tr class="tract-row" data-search="${escapeHtml((tractNum + ' ' + section + ' ' + twp + ' ' + rng + ' ' + county + ' ' + qualifier).toLowerCase())}" style="border-bottom: 1px solid #E5E7EB;">
                                            <td style="padding: 8px 12px; font-weight: ${isSplit ? '500' : '400'}; ${isSplit ? 'background: #FEF3C7;' : ''}">${escapeHtml(tractNum)}</td>
                                            <td style="padding: 8px 12px;">${section ? section + '-' : ''}${escapeHtml(twp)}-${escapeHtml(rng)}</td>
                                            <td style="padding: 8px 12px;">${escapeHtml(county)}</td>
                                            <td style="padding: 8px 12px; text-align: right;">${acres ? acres.toLocaleString() : ''}</td>
                                            <td style="padding: 8px 12px; text-align: right; font-family: monospace; font-size: 0.875rem;">${partDisplay}</td>
                                            ${hasSplitTracts ? `<td style="padding: 8px 12px; font-size: 0.75rem; color: #6B7280;">${qualifier ? escapeHtml(qualifier) : ''}</td>` : ''}
                                        </tr>
                                    `;
                                }).join('');

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: white; border: 1px solid #E5E7EB; border-radius: 8px; overflow: hidden;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #F9FAFB; border-bottom: 1px solid #E5E7EB;">
                                                <div>
                                                    <span style="font-weight: 600;">${tractCount} Tracts</span>
                                                    ${hasSplitTracts ? '<span style="margin-left: 8px; font-size: 0.75rem; color: #D97706; background: #FEF3C7; padding: 2px 8px; border-radius: 4px;">Contains Split Tracts</span>' : ''}
                                                </div>
                                                <div style="position: relative;">
                                                    <input type="text" id="${searchId}" placeholder="Search tracts..."
                                                        style="padding: 6px 12px 6px 32px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 0.875rem; width: 200px;"
                                                        onkeyup="filterTracts('${tableId}', '${searchId}')">
                                                    <svg style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: #9CA3AF;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                            <div style="max-height: ${showCollapsed ? '400px' : 'none'}; overflow-y: auto;">
                                                <table id="${tableId}" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                                    <thead style="position: sticky; top: 0; background: #F3F4F6;">
                                                        <tr>
                                                            <th style="padding: 10px 12px; text-align: left; border-bottom: 2px solid #E5E7EB; font-weight: 600;">Tract</th>
                                                            <th style="padding: 10px 12px; text-align: left; border-bottom: 2px solid #E5E7EB; font-weight: 600;">Location</th>
                                                            <th style="padding: 10px 12px; text-align: left; border-bottom: 2px solid #E5E7EB; font-weight: 600;">County</th>
                                                            <th style="padding: 10px 12px; text-align: right; border-bottom: 2px solid #E5E7EB; font-weight: 600;">Acres</th>
                                                            <th style="padding: 10px 12px; text-align: right; border-bottom: 2px solid #E5E7EB; font-weight: 600;">Participation %</th>
                                                            ${hasSplitTracts ? '<th style="padding: 10px 12px; text-align: left; border-bottom: 2px solid #E5E7EB; font-weight: 600;">Formation</th>' : ''}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${tableRows}
                                                    </tbody>
                                                </table>
                                            </div>
                                            ${hasSplitTracts ? `
                                                <div style="padding: 12px 16px; background: #FFFBEB; border-top: 1px solid #FCD34D; font-size: 0.75rem; color: #92400E;">
                                                    <strong>Split Tracts:</strong> Tracts ending in A/B represent the same surface acreage split between different formation intervals.
                                                    You may have interests in both sub-tracts if you own minerals in that section.
                                                </div>
                                            ` : ''}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            } else if (fieldName === 'tracts') {
                                // Special handling for tracts array (mineral deed v2 and oil_gas_lease v2 schemas)
                                // Mineral deed: tract.legal, tract.interest
                                // Lease: tract.legal_description, tract.acres
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 12px;">`;
                                value.forEach((tract, index) => {
                                    if (typeof tract === 'object') {
                                        // Support both mineral deed (tract.legal) and lease (tract.legal_description) schemas
                                        const legal = tract.legal || tract.legal_description || {};
                                        const interest = tract.interest || {};

                                        // Location info
                                        const section = legal.section || '';
                                        const township = legal.township || '';
                                        const range = legal.range || '';
                                        const meridian = legal.meridian || '';
                                        const county = legal.county || '';
                                        const state = legal.state || 'OK';
                                        const quarterCalls = legal.quarter_calls || [];
                                        const quarters = legal.quarters || '';  // Lease uses 'quarters' string
                                        const grossAcres = legal.gross_acres || tract.acres;  // Lease has acres at tract level
                                        const acresQualifier = tract.acres_qualifier || '';
                                        const fullDescription = legal.full_description || '';

                                        // Interest info
                                        const interestType = interest.type || 'mineral';
                                        const fractionText = interest.fraction_text || '';
                                        const fractionDecimal = interest.fraction_decimal;
                                        const netMineralAcres = interest.net_mineral_acres;
                                        const depthClause = interest.depth_clause || '';
                                        const formationClause = interest.formation_clause || '';
                                        const termClause = interest.term_clause || '';

                                        // Build location string
                                        let locationStr = '';
                                        if (section && township && range) {
                                            locationStr = `Section ${section}-${township}-${range}`;
                                            if (meridian) locationStr += `-${meridian}`;
                                        }
                                        if (county) locationStr += locationStr ? `, ${county} County` : `${county} County`;
                                        if (state) locationStr += `, ${state}`;

                                        // Determine quarter display (quarterCalls array for deeds, quarters string for leases)
                                        const quarterDisplay = quarterCalls.length > 0 ? quarterCalls.join(', ') : quarters;

                                        // Check if this is a mineral deed (has interest object with data)
                                        const hasInterestData = interest.type || fractionText || netMineralAcres !== undefined;

                                        sectionContent += `
                                            <div style="background: #F9FAFB; border: 1px solid #D1D5DB; border-radius: 8px; padding: 14px;">
                                                ${value.length > 1 ? `<div style="font-size: 11px; color: #9CA3AF; margin-bottom: 8px;">Tract ${index + 1}</div>` : ''}
                                                <div style="font-weight: 600; color: #1F2937; font-size: 14px; margin-bottom: 8px;">${escapeHtml(locationStr)}</div>
                                                ${quarterDisplay ? `<div style="font-size: 13px; color: #4B5563; margin-bottom: 4px;">Quarter: ${escapeHtml(quarterDisplay)}</div>` : ''}
                                                ${grossAcres ? `<div style="font-size: 13px; color: #4B5563; margin-bottom: 8px;">Acres: ${grossAcres.toLocaleString()}${acresQualifier ? ` (${escapeHtml(acresQualifier)})` : ''}</div>` : ''}

                                                ${hasInterestData ? `
                                                <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 10px; margin-top: 8px;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                                        <div>
                                                            <span style="font-size: 12px; color: #6B7280;">Interest Type:</span>
                                                            <span style="font-weight: 600; color: #1E40AF; text-transform: capitalize; margin-left: 4px;">${escapeHtml(interestType)}</span>
                                                        </div>
                                                        ${fractionText ? `<div style="font-weight: 600; color: #1E40AF;">${escapeHtml(fractionText)}</div>` : ''}
                                                    </div>
                                                    ${netMineralAcres !== undefined ? `<div style="font-size: 13px; color: #4B5563; margin-top: 6px;">Net Mineral Acres: <strong>${netMineralAcres.toLocaleString()}</strong></div>` : ''}
                                                </div>
                                                ` : ''}

                                                ${depthClause || formationClause || termClause ? `
                                                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #D1D5DB;">
                                                        ${depthClause ? `<div style="font-size: 12px; color: #DC2626; margin-bottom: 4px;"><strong>Depth Limitation:</strong> ${escapeHtml(depthClause)}</div>` : ''}
                                                        ${formationClause ? `<div style="font-size: 12px; color: #DC2626; margin-bottom: 4px;"><strong>Formation Limitation:</strong> ${escapeHtml(formationClause)}</div>` : ''}
                                                        ${termClause ? `<div style="font-size: 12px; color: #9333EA;"><strong>Term:</strong> ${escapeHtml(termClause)}</div>` : ''}
                                                    </div>
                                                ` : ''}

                                                ${fullDescription ? `<div style="font-size: 12px; color: #6B7280; margin-top: 8px; font-style: italic;">${escapeHtml(fullDescription)}</div>` : ''}
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'prior_instruments') {
                                // Special handling for prior instruments array (chain of title references)
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                sectionContent += `<div style="font-size: 12px; color: #6B7280; margin-bottom: 4px;">References to source of title:</div>`;
                                value.forEach(instrument => {
                                    if (typeof instrument === 'object') {
                                        const book = instrument.book || '';
                                        const page = instrument.page || '';
                                        const instrumentNumber = instrument.instrument_number || '';
                                        const description = instrument.description || '';

                                        let refStr = '';
                                        if (book && page) {
                                            refStr = `Book ${book}, Page ${page}`;
                                        }
                                        if (instrumentNumber) {
                                            refStr = refStr ? `${refStr} (Inst. #${instrumentNumber})` : `Inst. #${instrumentNumber}`;
                                        }

                                        sectionContent += `
                                            <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 6px; padding: 10px 12px;">
                                                ${refStr ? `<div style="font-weight: 500; color: #92400E;">${escapeHtml(refStr)}</div>` : ''}
                                                ${description ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(description)}</div>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 6px; padding: 10px 12px;">
                                                <span style="color: #92400E;">${escapeHtml(String(instrument))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'heirs' && value.some(h => typeof h === 'object')) {
                                // Special handling for heirs array
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(heir => {
                                    if (typeof heir === 'object') {
                                        sectionContent += `<div style="padding: 8px; background: #F9FAFB; border-radius: 4px;">`;
                                        sectionContent += `<strong>${escapeHtml(heir.name || 'Unknown')}</strong>`;
                                        if (heir.relationship) sectionContent += ` - ${escapeHtml(heir.relationship)}`;
                                        if (heir.share) sectionContent += ` (${escapeHtml(heir.share)})`;
                                        sectionContent += `</div>`;
                                    } else {
                                        sectionContent += `<div>${escapeHtml(String(heir))}</div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'unit_sections') {
                                // Special handling for multi-unit horizontal well sections and Division Order allocations
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(unit => {
                                    if (typeof unit === 'object') {
                                        const section = unit.section || '';
                                        const township = unit.township || '';
                                        const range = unit.range || '';
                                        // Support both allocation_percentage (OCC orders) and allocation_factor (Division Orders)
                                        let allocation = unit.allocation_percentage;
                                        if (allocation === undefined && unit.allocation_factor !== undefined) {
                                            allocation = (unit.allocation_factor * 100).toFixed(2);
                                        }
                                        const acres = unit.acres;
                                        const spacingOrder = unit.spacing_order;

                                        const locationStr = section ? `Section ${section}` + (township ? ` - ${township}` : '') + (range ? `-${range}` : '') : 'Unknown Section';

                                        sectionContent += `
                                            <div style="background: #F0F9FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 10px 12px;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(locationStr)}</span>
                                                    ${allocation !== undefined ? `<span style="background: #DBEAFE; color: #1E40AF; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${allocation}% Allocation</span>` : ''}
                                                </div>
                                                ${acres || spacingOrder ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">
                                                    ${acres ? `${acres} acres` : ''}
                                                    ${acres && spacingOrder ? ' • ' : ''}
                                                    ${spacingOrder ? `Spacing Order: ${spacingOrder}` : ''}
                                                </div>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: #F0F9FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 10px 12px;">
                                                <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(String(unit))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'affected_wells') {
                                // Special handling for change of operator affected wells
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(well => {
                                    if (typeof well === 'object') {
                                        const wellName = well.well_name || well.name || '';
                                        const apiNumber = well.api_number || '';
                                        const legalLoc = well.legal_location || '';

                                        sectionContent += `
                                            <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 6px; padding: 10px 12px;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-weight: 500; color: #92400E;">${escapeHtml(wellName || 'Unknown Well')}</span>
                                                    ${apiNumber ? `<span style="color: #6B7280; font-size: 12px;">API: ${escapeHtml(apiNumber)}</span>` : ''}
                                                </div>
                                                ${legalLoc ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(legalLoc)}</div>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 6px; padding: 10px 12px;">
                                                <span style="font-weight: 500; color: #92400E;">${escapeHtml(String(well))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'multi_unit_sections') {
                                // Special handling for drilling permit multi-unit section allocations
                                sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                                value.forEach(unit => {
                                    if (typeof unit === 'object') {
                                        const section = unit.section || '';
                                        const township = unit.township || '';
                                        const range = unit.range || '';
                                        const allocation = unit.allocation_percentage;
                                        const locationStr = section ? `Section ${section}` + (township ? ` - ${township}` : '') + (range ? `-${range}` : '') : '';

                                        sectionContent += `
                                            <div style="background: #F3E8FF; border: 1px solid #A855F7; border-radius: 6px; padding: 10px 14px; min-width: 140px;">
                                                <div style="font-weight: 600; color: #7C3AED;">${escapeHtml(locationStr)}</div>
                                                ${allocation != null ? `<div style="font-size: 13px; color: #6B7280; margin-top: 4px;">${allocation}% Allocation</div>` : ''}
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'section_crossings') {
                                // Special handling for drilling permit section crossings with coordinates
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach((crossing, index) => {
                                    if (typeof crossing === 'object') {
                                        const fromSection = crossing.from_section || '';
                                        const toSection = crossing.to_section || '';
                                        const lat = crossing.latitude;
                                        const lon = crossing.longitude;

                                        sectionContent += `
                                            <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 6px; padding: 10px 12px;">
                                                <div style="font-weight: 500; color: #92400E;">Section ${fromSection} → ${toSection}</div>
                                                ${lat != null && lon != null ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Coordinates: ${lat.toFixed(6)}, ${lon.toFixed(6)}</div>` : ''}
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'units') {
                                // Special handling for units array (drilling/spacing order v2 schema)
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 12px;">`;
                                value.forEach((unit, index) => {
                                    if (typeof unit === 'object') {
                                        const legal = unit.legal || {};
                                        const formations = Array.isArray(unit.formations) ? unit.formations : [];
                                        const wellLocation = (typeof unit.well_location === 'object' && unit.well_location) ? unit.well_location : {};

                                        // Safely extract scalar values
                                        const unitSize = typeof unit.unit_size_acres === 'number' ? unit.unit_size_acres : null;
                                        const unitShape = typeof unit.unit_shape === 'string' ? unit.unit_shape : '';
                                        const wellType = typeof unit.well_type === 'string' ? unit.well_type : '';
                                        const sectionsCovered = typeof unit.sections_covered === 'number' ? unit.sections_covered : null;

                                        // Build location string
                                        const section = typeof legal.section === 'string' ? legal.section : (legal.section ? String(legal.section) : '');
                                        const township = typeof legal.township === 'string' ? legal.township : (legal.township ? String(legal.township) : '');
                                        const range = typeof legal.range === 'string' ? legal.range : (legal.range ? String(legal.range) : '');
                                        const meridian = typeof legal.meridian === 'string' ? legal.meridian : '';
                                        const quarterCalls = Array.isArray(legal.quarter_calls) ? legal.quarter_calls : [];
                                        const fullDescription = typeof legal.full_description === 'string' ? legal.full_description : '';

                                        let locationStr = '';
                                        if (section && township && range) {
                                            locationStr = `Section ${section}-${township}-${range}`;
                                            if (meridian) locationStr += `-${meridian}`;
                                        }
                                        if (quarterCalls.length > 0) {
                                            const qcStrings = quarterCalls.map(qc => {
                                                if (typeof qc === 'string') return qc;
                                                if (typeof qc === 'object' && qc) return qc.name || qc.quarter || '';
                                                return '';
                                            }).filter(s => s);
                                            if (qcStrings.length > 0) {
                                                locationStr += ` (${qcStrings.join(', ')})`;
                                            }
                                        }

                                        sectionContent += `
                                            <div style="background: #F9FAFB; border: 1px solid #D1D5DB; border-radius: 8px; padding: 14px;">
                                                ${value.length > 1 ? `<div style="font-size: 11px; color: #9CA3AF; margin-bottom: 8px;">Unit ${index + 1}</div>` : ''}
                                                <div style="font-weight: 600; color: #1F2937; font-size: 14px; margin-bottom: 8px;">${escapeHtml(locationStr || fullDescription)}</div>

                                                <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 10px;">
                                                    ${unitSize ? `<div style="background: #DBEAFE; border-radius: 4px; padding: 4px 8px; font-size: 12px;"><span style="color: #6B7280;">Size:</span> <strong style="color: #1E40AF;">${unitSize}-acre</strong></div>` : ''}
                                                    ${unitShape ? `<div style="background: #E0E7FF; border-radius: 4px; padding: 4px 8px; font-size: 12px;"><span style="color: #6B7280;">Shape:</span> <strong style="color: #3730A3;">${escapeHtml(unitShape)}</strong></div>` : ''}
                                                    ${wellType ? `<div style="background: #D1FAE5; border-radius: 4px; padding: 4px 8px; font-size: 12px;"><span style="color: #6B7280;">Well Type:</span> <strong style="color: #065F46;">${escapeHtml(wellType)}</strong></div>` : ''}
                                                    ${sectionsCovered ? `<div style="background: #FEF3C7; border-radius: 4px; padding: 4px 8px; font-size: 12px;"><span style="color: #6B7280;">Sections:</span> <strong style="color: #92400E;">${sectionsCovered}</strong></div>` : ''}
                                                </div>

                                                ${formations.length > 0 ? `
                                                    <div style="margin-bottom: 10px;">
                                                        <div style="font-size: 12px; color: #6B7280; margin-bottom: 6px;">Formations:</div>
                                                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                                            ${formations.map(f => {
                                                                let name = '';
                                                                if (typeof f === 'object') {
                                                                    name = typeof f.name === 'string' ? f.name : '';
                                                                } else {
                                                                    name = String(f);
                                                                }
                                                                const depthFrom = typeof f === 'object' ? (f.depth_from_ft || f.depth_from) : null;
                                                                const depthTo = typeof f === 'object' ? (f.depth_to_ft || f.depth_to) : null;
                                                                const depthDesc = typeof f === 'object' ? f.depth_description : null;
                                                                let depthStr = '';
                                                                if (typeof depthFrom === 'number' && typeof depthTo === 'number') {
                                                                    depthStr = ` (${depthFrom.toLocaleString()}'-${depthTo.toLocaleString()}')`;
                                                                } else if (depthDesc && typeof depthDesc === 'string') {
                                                                    depthStr = ` (${escapeHtml(depthDesc)})`;
                                                                }
                                                                return `<span style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 4px; padding: 3px 8px; font-size: 12px; color: #92400E;">${escapeHtml(name)}${depthStr}</span>`;
                                                            }).join('')}
                                                        </div>
                                                    </div>
                                                ` : ''}

                                                ${Object.keys(wellLocation).length > 0 ? (() => {
                                                    const ubSetback = typeof wellLocation.unit_boundary_setback_ft === 'number' ? wellLocation.unit_boundary_setback_ft : null;
                                                    const llSetback = typeof wellLocation.lease_line_setback_ft === 'number' ? wellLocation.lease_line_setback_ft : null;
                                                    const latSetback = typeof wellLocation.lateral_setback_ft === 'number' ? wellLocation.lateral_setback_ft : null;
                                                    const ciSetback = typeof wellLocation.completion_interval_setback_ft === 'number' ? wellLocation.completion_interval_setback_ft : null;
                                                    const maxWellsUnit = typeof wellLocation.max_wells_per_unit === 'number' ? wellLocation.max_wells_per_unit : null;
                                                    const maxWellsForm = typeof wellLocation.max_wells_per_formation === 'number' ? wellLocation.max_wells_per_formation : null;
                                                    const locDesc = typeof wellLocation.location_description === 'string' ? wellLocation.location_description : '';
                                                    const specCond = typeof wellLocation.special_conditions === 'string' ? wellLocation.special_conditions : '';
                                                    return `
                                                    <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 10px;">
                                                        <div style="font-size: 12px; color: #1E40AF; font-weight: 500; margin-bottom: 6px;">Well Location Requirements</div>
                                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; font-size: 12px;">
                                                            ${ubSetback !== null ? `<div><span style="color: #6B7280;">Unit Boundary:</span> <strong>${ubSetback}' setback</strong></div>` : ''}
                                                            ${llSetback !== null ? `<div><span style="color: #6B7280;">Lease Line:</span> <strong>${llSetback}' setback</strong></div>` : ''}
                                                            ${latSetback !== null ? `<div><span style="color: #6B7280;">Lateral:</span> <strong>${latSetback}' setback</strong></div>` : ''}
                                                            ${ciSetback !== null ? `<div><span style="color: #6B7280;">Completion Interval:</span> <strong>${ciSetback}' setback</strong></div>` : ''}
                                                            ${maxWellsUnit !== null ? `<div><span style="color: #6B7280;">Max Wells/Unit:</span> <strong>${maxWellsUnit}</strong></div>` : ''}
                                                            ${maxWellsForm !== null ? `<div><span style="color: #6B7280;">Max Wells/Formation:</span> <strong>${maxWellsForm}</strong></div>` : ''}
                                                        </div>
                                                        ${locDesc ? `<div style="font-size: 12px; color: #4B5563; margin-top: 6px;">${escapeHtml(locDesc)}</div>` : ''}
                                                        ${specCond ? `<div style="font-size: 12px; color: #6B7280; margin-top: 6px; font-style: italic;">${escapeHtml(specCond)}</div>` : ''}
                                                    </div>`;
                                                })() : ''}
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'companion_causes') {
                                // Special handling for companion causes (drilling/spacing order v2 schema)
                                sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                                value.forEach(cause => {
                                    if (typeof cause === 'object') {
                                        const caseNum = typeof cause.case_number === 'string' ? cause.case_number : '';
                                        const causeType = typeof cause.cause_type === 'string' ? formatFieldName(cause.cause_type) : '';
                                        sectionContent += `
                                            <div style="background: #DBEAFE; border: 1px solid #93C5FD; border-radius: 6px; padding: 6px 10px;">
                                                <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(caseNum)}</span>
                                                ${causeType ? `<span style="color: #6B7280; font-size: 12px; margin-left: 6px;">(${escapeHtml(causeType)})</span>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: #DBEAFE; border: 1px solid #93C5FD; border-radius: 6px; padding: 6px 10px;">
                                                <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(String(cause))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'affected_wells') {
                                // Special handling for affected wells array (change of operator orders)
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
                                value.forEach(well => {
                                    const wellName = well.well_name || '';
                                    const apiNumber = well.api_number || '';
                                    const otcNumber = well.otc_number || '';
                                    const wellType = well.well_type || '';
                                    const status = well.status || '';
                                    const formations = well.producing_formations || [];

                                    sectionContent += `
                                        <div style="background: #F3F4F6; border: 1px solid #D1D5DB; border-radius: 8px; padding: 12px;">
                                            <div style="font-weight: 600; color: #374151; font-size: 14px; margin-bottom: 6px;">${escapeHtml(wellName)}</div>
                                            <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 13px;">
                                                ${apiNumber ? `<span style="color: #6B7280;"><strong>API:</strong> ${escapeHtml(apiNumber)}</span>` : ''}
                                                ${otcNumber ? `<span style="color: #6B7280;"><strong>OTC:</strong> ${escapeHtml(otcNumber)}</span>` : ''}
                                                ${wellType ? `<span style="color: #374151;"><strong>Type:</strong> ${escapeHtml(formatFieldName(wellType))}</span>` : ''}
                                                ${status ? `<span style="color: #374151;"><strong>Status:</strong> ${escapeHtml(formatFieldName(status))}</span>` : ''}
                                                ${formations.length > 0 ? `<span style="color: #6B7280;"><strong>Formations:</strong> ${formations.map(f => escapeHtml(f)).join(', ')}</span>` : ''}
                                            </div>
                                        </div>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'modified_orders') {
                                // Special handling for modified orders array (change of operator orders)
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
                                value.forEach(order => {
                                    const orderNum = order.order_number || '';
                                    const orderDate = order.order_date || '';
                                    const orderType = order.order_type || '';
                                    const modifications = order.modifications_made || [];

                                    sectionContent += `
                                        <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 12px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                <div style="font-weight: 600; color: #92400E; font-size: 14px;">Order No. ${escapeHtml(orderNum)}</div>
                                                <div style="font-size: 12px; color: #6B7280;">
                                                    ${orderType ? `${escapeHtml(orderType)}` : ''}
                                                    ${orderDate ? ` • ${escapeHtml(orderDate)}` : ''}
                                                </div>
                                            </div>
                                            ${modifications.length > 0 ? `
                                                <div style="font-size: 13px; color: #374151;">
                                                    <strong>Modifications:</strong>
                                                    <ul style="margin: 4px 0 0 16px; padding: 0;">
                                                        ${modifications.map(mod => `<li>${escapeHtml(mod)}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'prohibited_deductions') {
                                // Special handling for prohibited deductions array (lease deductions_clause)
                                sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 6px;">`;
                                value.forEach(deduction => {
                                    sectionContent += `
                                        <span style="background: #FEE2E2; border: 1px solid #EF4444; border-radius: 4px; padding: 3px 8px; font-size: 12px; color: #DC2626;">
                                            ${escapeHtml(String(deduction))}
                                        </span>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'provisions' && data.doc_type === 'oil_gas_lease') {
                                // Special handling for exhibit_a provisions array
                                sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 6px;">`;
                                value.forEach(provision => {
                                    sectionContent += `
                                        <span style="background: #DBEAFE; border: 1px solid #3B82F6; border-radius: 4px; padding: 4px 10px; font-size: 12px; color: #1E40AF; font-weight: 500;">
                                            ${escapeHtml(String(provision))}
                                        </span>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'general_partners' && data.doc_type === 'limited_partnership') {
                                // Special handling for general_partners array (limited_partnership schema)
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
                                value.forEach(partner => {
                                    const name = partner.name || '';
                                    const address = partner.address || '';
                                    const interestFraction = partner.interest_fraction || '';
                                    const interestDecimal = partner.interest_decimal;
                                    const capacity = partner.capacity || '';
                                    const contribution = partner.capital_contribution || '';

                                    sectionContent += `
                                        <div style="background: #DBEAFE; border: 1px solid #3B82F6; border-radius: 8px; padding: 12px;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; flex-wrap: wrap;">
                                                <div style="flex: 1; min-width: 200px;">
                                                    <div style="font-weight: 600; color: #1E40AF; font-size: 15px;">${escapeHtml(name)}</div>
                                                    ${capacity ? `<div style="font-size: 12px; color: #3B82F6; margin-top: 2px;">${escapeHtml(capacity)}</div>` : ''}
                                                    ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(address)}</div>` : ''}
                                                </div>
                                                <div style="text-align: right;">
                                                    ${interestFraction ? `<div style="font-weight: 700; color: #1E40AF; font-size: 16px;">${escapeHtml(interestFraction)}</div>` : ''}
                                                    ${interestDecimal !== undefined && interestDecimal !== null ? `<div style="font-size: 12px; color: #6B7280;">(${(interestDecimal * 100).toFixed(4)}%)</div>` : ''}
                                                    ${contribution ? `<div style="font-size: 12px; color: #059669; margin-top: 4px;">Contribution: ${escapeHtml(contribution)}</div>` : ''}
                                                </div>
                                            </div>
                                        </div>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'limited_partners' && data.doc_type === 'limited_partnership') {
                                // Special handling for limited_partners array (limited_partnership schema)
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
                                value.forEach(partner => {
                                    const name = partner.name || '';
                                    const address = partner.address || '';
                                    const interestFraction = partner.interest_fraction || '';
                                    const interestDecimal = partner.interest_decimal;
                                    const capacity = partner.capacity || '';
                                    const custodianFor = partner.custodian_for || '';
                                    const contribution = partner.capital_contribution || '';

                                    // Different background if acting as custodian
                                    const bgColor = custodianFor ? '#FEF3C7' : '#F0FDF4';
                                    const borderColor = custodianFor ? '#F59E0B' : '#22C55E';
                                    const nameColor = custodianFor ? '#92400E' : '#166534';

                                    sectionContent += `
                                        <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 12px;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; flex-wrap: wrap;">
                                                <div style="flex: 1; min-width: 200px;">
                                                    <div style="font-weight: 600; color: ${nameColor}; font-size: 15px;">${escapeHtml(name)}</div>
                                                    ${capacity ? `<div style="font-size: 12px; color: #6B7280; margin-top: 2px;">${escapeHtml(capacity)}</div>` : ''}
                                                    ${custodianFor ? `<div style="font-size: 12px; color: #B45309; margin-top: 2px; font-weight: 500;">Custodian for: ${escapeHtml(custodianFor)}</div>` : ''}
                                                    ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(address)}</div>` : ''}
                                                </div>
                                                <div style="text-align: right;">
                                                    ${interestFraction ? `<div style="font-weight: 700; color: ${nameColor}; font-size: 16px;">${escapeHtml(interestFraction)}</div>` : ''}
                                                    ${interestDecimal !== undefined && interestDecimal !== null ? `<div style="font-size: 12px; color: #6B7280;">(${(interestDecimal * 100).toFixed(4)}%)</div>` : ''}
                                                    ${contribution ? `<div style="font-size: 12px; color: #059669; margin-top: 4px;">Contribution: ${escapeHtml(contribution)}</div>` : ''}
                                                </div>
                                            </div>
                                        </div>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'assignors' && data.doc_type === 'assignment_of_lease') {
                                // Special handling for assignors array (assignment_of_lease schema)
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
                                value.forEach(assignor => {
                                    const name = assignor.name || '';
                                    const address = assignor.address || '';
                                    const capacity = assignor.capacity || '';
                                    const entityName = assignor.entity_name || '';
                                    const entityType = assignor.entity_type || '';

                                    sectionContent += `
                                        <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 12px;">
                                            <div style="font-weight: 600; color: #92400E; font-size: 15px;">${escapeHtml(name)}</div>
                                            ${capacity ? `<div style="font-size: 12px; color: #B45309; margin-top: 2px;">${escapeHtml(capacity)}</div>` : ''}
                                            ${entityName ? `<div style="font-size: 12px; color: #6B7280; margin-top: 2px;">${escapeHtml(entityName)}${entityType ? ` (${escapeHtml(entityType)})` : ''}</div>` : ''}
                                            ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(address)}</div>` : ''}
                                        </div>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'assignees' && data.doc_type === 'assignment_of_lease') {
                                // Special handling for assignees array (assignment_of_lease schema)
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
                                value.forEach(assignee => {
                                    const name = assignee.name || '';
                                    const address = assignee.address || '';
                                    const capacity = assignee.capacity || '';
                                    const entityName = assignee.entity_name || '';
                                    const entityType = assignee.entity_type || '';
                                    const interestShare = assignee.interest_share || {};
                                    const shareFraction = interestShare.fraction || '';
                                    const shareDecimal = interestShare.decimal;

                                    sectionContent += `
                                        <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 8px; padding: 12px;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; flex-wrap: wrap;">
                                                <div style="flex: 1; min-width: 200px;">
                                                    <div style="font-weight: 600; color: #166534; font-size: 15px;">${escapeHtml(name)}</div>
                                                    ${capacity ? `<div style="font-size: 12px; color: #22C55E; margin-top: 2px;">${escapeHtml(capacity)}</div>` : ''}
                                                    ${entityName ? `<div style="font-size: 12px; color: #6B7280; margin-top: 2px;">${escapeHtml(entityName)}${entityType ? ` (${escapeHtml(entityType)})` : ''}</div>` : ''}
                                                    ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(address)}</div>` : ''}
                                                </div>
                                                ${shareFraction ? `
                                                    <div style="text-align: right;">
                                                        <div style="font-weight: 700; color: #166534; font-size: 16px;">${escapeHtml(shareFraction)}</div>
                                                        ${shareDecimal !== undefined && shareDecimal !== null ? `<div style="font-size: 12px; color: #6B7280;">(${(shareDecimal * 100).toFixed(4)}%)</div>` : ''}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'family_members') {
                                // Special handling for death certificate family members
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(member => {
                                    if (typeof member === 'object') {
                                        const name = member.name || '';
                                        const relationship = member.relationship || '';
                                        const roleOnCert = member.role_on_certificate || '';
                                        const relationshipSource = member.relationship_source || '';
                                        const notes = member.notes || '';

                                        sectionContent += `
                                            <div style="background: #F0F9FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 10px 12px;">
                                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                                    <div>
                                                        <div style="font-weight: 600; color: #1E40AF; font-size: 14px;">${escapeHtml(name)}</div>
                                                        ${relationship ? `<div style="font-size: 13px; color: #3B82F6; margin-top: 2px;">${escapeHtml(relationship)}</div>` : ''}
                                                        ${roleOnCert ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Role: ${escapeHtml(roleOnCert)}</div>` : ''}
                                                        ${relationshipSource ? `<div style="font-size: 11px; color: #9CA3AF; margin-top: 2px;">Source: ${escapeHtml(relationshipSource)}</div>` : ''}
                                                        ${notes ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px; font-style: italic;">${escapeHtml(notes)}</div>` : ''}
                                                    </div>
                                                </div>
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: #F0F9FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 10px 12px;">
                                                <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(String(member))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'expected_companion_documents') {
                                // Special handling for death certificate expected companion documents
                                sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                                value.forEach(doc => {
                                    sectionContent += `
                                        <span style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 4px; padding: 4px 10px; font-size: 13px; color: #92400E;">
                                            ${escapeHtml(String(doc))}
                                        </span>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'name_variations') {
                                // Special handling for death certificate name variations in chain_of_title
                                sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                                value.forEach(variation => {
                                    sectionContent += `
                                        <span style="background: #EDE9FE; border: 1px solid #A855F7; border-radius: 4px; padding: 4px 10px; font-size: 13px; color: #7C3AED;">
                                            ${escapeHtml(String(variation))}
                                        </span>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'children_names') {
                                // Special handling for death certificate children names
                                sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                                value.forEach(child => {
                                    sectionContent += `
                                        <span style="background: #DBEAFE; border: 1px solid #3B82F6; border-radius: 4px; padding: 4px 10px; font-size: 13px; color: #1E40AF;">
                                            ${escapeHtml(String(child))}
                                        </span>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'allocation_factors' && data.doc_type === 'multi_unit_horizontal_order') {
                                // Special handling for multi-unit horizontal order allocation factors
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
                                value.forEach(factor => {
                                    const section = factor.section || '';
                                    const township = factor.township || '';
                                    const range = factor.range || '';
                                    const county = factor.county || '';
                                    const percentage = factor.allocation_percentage;
                                    const intervalFt = factor.completion_interval_length_ft;
                                    const unitAcres = factor.unit_size_acres;
                                    const isSurface = factor.is_surface_location;
                                    const spacingOrder = factor.spacing_order_number;
                                    const entryPoint = factor.entry_point || {};

                                    // Color based on percentage (larger = more prominent)
                                    const bgColor = percentage > 50 ? '#DCFCE7' : percentage > 25 ? '#FEF9C3' : '#F3F4F6';
                                    const borderColor = percentage > 50 ? '#22C55E' : percentage > 25 ? '#EAB308' : '#D1D5DB';
                                    const percentColor = percentage > 50 ? '#166534' : percentage > 25 ? '#A16207' : '#374151';

                                    sectionContent += `
                                        <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 14px;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px;">
                                                <div>
                                                    <div style="font-weight: 700; color: #1F2937; font-size: 15px;">
                                                        Section ${escapeHtml(String(section))} - ${escapeHtml(township)}-${escapeHtml(range)}
                                                        ${county ? `<span style="font-weight: 400; color: #6B7280; font-size: 13px; margin-left: 8px;">${escapeHtml(county)} County</span>` : ''}
                                                    </div>
                                                    ${isSurface ? `<span style="background: #3B82F6; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-top: 4px; display: inline-block;">SURFACE LOCATION</span>` : ''}
                                                </div>
                                                <div style="text-align: right;">
                                                    <div style="font-size: 24px; font-weight: 700; color: ${percentColor};">${percentage ? percentage.toFixed(2) : '—'}%</div>
                                                    <div style="font-size: 12px; color: #6B7280;">Allocation</div>
                                                </div>
                                            </div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-top: 10px; font-size: 13px;">
                                                ${intervalFt ? `<div><span style="color: #6B7280;">Lateral Length:</span> <strong>${intervalFt.toLocaleString()} ft</strong></div>` : ''}
                                                ${unitAcres ? `<div><span style="color: #6B7280;">Unit Size:</span> <strong>${unitAcres} acres</strong></div>` : ''}
                                                ${spacingOrder ? `<div><span style="color: #6B7280;">Spacing Order:</span> <strong>#${escapeHtml(spacingOrder)}</strong></div>` : ''}
                                            </div>
                                            ${entryPoint.description ? `
                                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid ${borderColor}; font-size: 12px; color: #6B7280;">
                                                    <strong>Entry:</strong> ${escapeHtml(entryPoint.description)}
                                                    ${entryPoint.measured_depth_ft ? ` at ${entryPoint.measured_depth_ft.toLocaleString()} ft MD` : ''}
                                                </div>` : ''}
                                        </div>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'related_orders' && value.length > 0 && typeof value[0] === 'object') {
                                // Special handling for related orders array (unitization orders, v4 format)
                                // Format: [{order_number, relationship, cause_number, description}]
                                const superseded = value.filter(o => o.relationship === 'supersedes');

                                if (superseded.length > 0) {
                                    const showScrollable = superseded.length > 10;

                                    let orderList = superseded.map(order => {
                                        const orderNum = order.order_number || '';
                                        const desc = order.description || '';
                                        return `
                                            <div style="display: inline-flex; align-items: center; background: #FEE2E2; color: #991B1B; padding: 4px 10px; border-radius: 4px; font-size: 0.875rem; margin: 2px;">
                                                <span style="font-weight: 500;">${escapeHtml(orderNum)}</span>
                                                ${desc ? `<span style="margin-left: 6px; font-size: 0.75rem; color: #B91C1C;">(${escapeHtml(desc)})</span>` : ''}
                                            </div>
                                        `;
                                    }).join('');

                                    sectionContent += `
                                        <div style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 8px; padding: 16px;">
                                            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                                <svg style="width: 20px; height: 20px; color: #DC2626; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                </svg>
                                                <span style="font-weight: 600; color: #991B1B;">${superseded.length} Prior Spacing Order${superseded.length > 1 ? 's' : ''} Superseded</span>
                                            </div>
                                            <div style="font-size: 0.875rem; color: #7F1D1D; margin-bottom: 12px;">
                                                The following spacing orders no longer control production allocation within this unit area:
                                            </div>
                                            <div style="${showScrollable ? 'max-height: 200px; overflow-y: auto;' : ''} display: flex; flex-wrap: wrap; gap: 4px;">
                                                ${orderList}
                                            </div>
                                        </div>`;
                                } else {
                                    // No superseded orders, show generic list
                                    sectionContent += `<ul style="margin: 8px 0; padding-left: 20px;">`;
                                    value.forEach(order => {
                                        const orderNum = order.order_number || '';
                                        const relationship = order.relationship || '';
                                        sectionContent += `<li style="margin-bottom: 4px;">${escapeHtml(orderNum)}${relationship ? ` (${escapeHtml(relationship)})` : ''}</li>`;
                                    });
                                    sectionContent += `</ul>`;
                                }
                            } else {
                                // Regular array
                                sectionContent += `<ul style="margin: 8px 0; padding-left: 20px;">`;
                                value.forEach(item => {
                                    if (typeof item === 'object' && item !== null) {
                                        // For objects, try to display meaningful properties
                                        const display = item.name || item.order_number || item.description || item.title || JSON.stringify(item);
                                        sectionContent += `<li style="margin-bottom: 4px;">${escapeHtml(String(display))}</li>`;
                                    } else {
                                        sectionContent += `<li style="margin-bottom: 4px;">${escapeHtml(String(item))}</li>`;
                                    }
                                });
                                sectionContent += `</ul>`;
                            }
                            sectionContent += getConfidenceIndicator(fieldName, fieldScores);
                            sectionContent += `</div>`;
                        }
                    } else if (typeof value === 'boolean') {
                        // Handle boolean values
                        hasVisibleFields = true;
                        sectionContent += `
                            <div class="doc-field">
                                <label>${formatFieldName(fieldName)}</label>
                                <div class="doc-value">${value ? 'Yes' : 'No'}${getConfidenceIndicator(fieldName, fieldScores)}</div>
                            </div>`;
                    } else if (typeof value === 'object' && value !== null) {
                        // Special handling for completion_interval
                        if (fieldName === 'completion_interval') {
                            hasVisibleFields = true;
                            const topDepth = value.top_depth;
                            const bottomDepth = value.bottom_depth;
                            const length = value.length || value.lateral_length;

                            sectionContent += `
                                <div class="doc-field">
                                    <label>Completion Interval</label>
                                    <div style="background: #F3E8FF; border: 1px solid #A855F7; border-radius: 6px; padding: 10px 12px;">
                                        ${topDepth != null && bottomDepth != null ?
                                            `<div style="font-weight: 500; color: #7C3AED;">${Number(topDepth).toLocaleString()}' - ${Number(bottomDepth).toLocaleString()}'</div>` : ''}
                                        ${length != null ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Length: ${Number(length).toLocaleString()}'</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'interest_conveyed') {
                            // Special handling for interest_conveyed object (mineral_deed and quit_claim_deed)
                            hasVisibleFields = true;
                            const interestType = value.type || '';
                            // Support both mineral_deed (fraction_text/fraction_decimal) and quit_claim_deed (fraction/decimal) fields
                            const fractionText = value.fraction_text || value.fraction || '';
                            const fractionDecimal = value.fraction_decimal !== undefined ? value.fraction_decimal : value.decimal;
                            const netMineralAcres = value.net_mineral_acres;
                            const depthLimit = value.depth_limitation || value.depths || '';
                            const formationLimit = value.formation_limitation;
                            const formations = value.formations || [];
                            const interestDescription = value.interest_description || '';
                            const mineralSurface = value.mineral_surface || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Interest Conveyed</label>
                                    <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 12px;">
                                        ${interestType ? `<div style="font-weight: 600; color: #1E40AF; text-transform: capitalize; margin-bottom: 4px;">${escapeHtml(interestType)} Interest</div>` : ''}
                                        ${fractionText ? `<div style="color: #374151;">${escapeHtml(fractionText)}</div>` : ''}
                                        ${interestDescription ? `<div style="font-size: 13px; color: #374151; margin-top: 4px; font-style: italic;">"${escapeHtml(interestDescription)}"</div>` : ''}
                                        ${fractionDecimal != null ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Decimal: ${fractionDecimal}</div>` : ''}
                                        ${mineralSurface && mineralSurface !== 'not_specified' ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px; text-transform: capitalize;">Type: ${escapeHtml(mineralSurface.replace(/_/g, ' '))}</div>` : ''}
                                        ${netMineralAcres != null ? `<div style="font-size: 13px; color: #059669; font-weight: 500; margin-top: 6px;">${netMineralAcres} Net Mineral Acres</div>` : ''}
                                        ${depthLimit ? `<div style="font-size: 12px; color: #92400E; margin-top: 4px;">Depth: ${escapeHtml(depthLimit)}</div>` : ''}
                                        ${formationLimit ? `<div style="font-size: 12px; color: #92400E; margin-top: 2px;">Formation: ${escapeHtml(formationLimit)}</div>` : ''}
                                        ${formations.length > 0 ? `<div style="font-size: 12px; color: #92400E; margin-top: 2px;">Formations: ${formations.map(f => escapeHtml(f)).join(', ')}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'reservation') {
                            // Special handling for reservation object
                            if (value.has_reservation) {
                                hasVisibleFields = true;
                                const reservationText = value.reservation_text || '';
                                const reservedType = value.reserved_interest_type || '';
                                const reservedFraction = value.reserved_fraction || '';

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Reservation</label>
                                        <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 6px; padding: 12px;">
                                            <div style="font-weight: 600; color: #92400E; margin-bottom: 4px;">Grantor Reserved Interest</div>
                                            ${reservedType ? `<div style="color: #374151; text-transform: capitalize;">${escapeHtml(reservedType)}</div>` : ''}
                                            ${reservedFraction ? `<div style="font-size: 13px; color: #92400E; margin-top: 4px;">Reserved: ${escapeHtml(reservedFraction)}</div>` : ''}
                                            ${reservationText ? `<div style="font-size: 12px; color: #6B7280; margin-top: 6px; font-style: italic;">"${escapeHtml(reservationText)}"</div>` : ''}
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'decedent') {
                            // Special handling for decedent object
                            hasVisibleFields = true;
                            const name = value.name || 'Unknown';
                            const deathDate = value.date_of_death || '';
                            const birthDate = value.date_of_birth || '';
                            const age = value.age_at_death;
                            const placeOfDeath = value.place_of_death;

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Decedent</label>
                                    <div style="background: #F3F4F6; border: 1px solid #6B7280; border-radius: 6px; padding: 12px;">
                                        <div style="font-weight: 600; color: #1F2937; font-size: 15px;">${escapeHtml(name)}</div>
                                        ${deathDate ? `<div style="font-size: 13px; color: #4B5563; margin-top: 4px;">Date of Death: ${escapeHtml(deathDate)}${age ? ` (Age ${age})` : ''}</div>` : ''}
                                        ${birthDate ? `<div style="font-size: 12px; color: #6B7280;">Born: ${escapeHtml(birthDate)}</div>` : ''}
                                        ${placeOfDeath && placeOfDeath.county ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Place of Death: ${escapeHtml(placeOfDeath.county)} County, ${escapeHtml(placeOfDeath.state || 'OK')}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'affiant') {
                            // Special handling for affiant object
                            hasVisibleFields = true;
                            const name = value.name || 'Unknown';
                            const relationship = value.relationship_to_decedent || '';
                            const address = value.address || '';
                            const yearsKnown = value.years_known_decedent;

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Affiant</label>
                                    <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 6px; padding: 12px;">
                                        <div style="font-weight: 600; color: #166534;">${escapeHtml(name)}</div>
                                        ${relationship ? `<div style="font-size: 13px; color: #4B5563; margin-top: 4px; text-transform: capitalize;">Relationship: ${escapeHtml(relationship)}</div>` : ''}
                                        ${yearsKnown ? `<div style="font-size: 12px; color: #6B7280;">Knew decedent for ${yearsKnown} years</div>` : ''}
                                        ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(address)}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'surface_location' || fieldName === 'bottom_hole_location') {
                            // Special handling for drilling permit location objects
                            hasVisibleFields = true;
                            const section = value.section;
                            const township = value.township || '';
                            const range = value.range || '';
                            const lat = value.latitude;
                            const lon = value.longitude;
                            const label = fieldName === 'surface_location' ? 'Surface Location' : 'Bottom Hole Location';
                            const bgColor = fieldName === 'surface_location' ? '#F0FDF4' : '#EFF6FF';
                            const borderColor = fieldName === 'surface_location' ? '#22C55E' : '#3B82F6';
                            const textColor = fieldName === 'surface_location' ? '#166534' : '#1E40AF';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>${label}</label>
                                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 6px; padding: 12px;">
                                        ${section ? `<div style="font-weight: 600; color: ${textColor}; font-size: 15px;">Section ${section} - ${township}-${range}</div>` : ''}
                                        ${lat != null && lon != null ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Coordinates: ${lat.toFixed(6)}, ${lon.toFixed(6)}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'operator' && typeof value === 'object') {
                            // Special handling for pooling order operator object
                            hasVisibleFields = true;
                            const name = value.name || '';
                            const contactName = value.contact_name || '';
                            const address = value.address || '';
                            const city = value.city || '';
                            const state = value.state || '';
                            const zip = value.zip || '';
                            const phone = value.phone || '';
                            const email = value.email || '';
                            const fullAddress = [address, city, state, zip].filter(Boolean).join(', ').replace(/, ,/g, ',');

                            // Check if applicant is same company (merge attorney info into this card)
                            const applicantIsOperator = data.applicant && (
                                data.applicant.is_operator === true ||
                                (data.applicant.name && name && data.applicant.name.trim().toLowerCase() === name.trim().toLowerCase())
                            );
                            const mergedApplicant = applicantIsOperator ? data.applicant : null;
                            const attorney = mergedApplicant ? (mergedApplicant.attorney || '') : '';
                            const attorneyOba = mergedApplicant ? (mergedApplicant.attorney_oba || '') : '';
                            const attorneyAddress = mergedApplicant ? (mergedApplicant.attorney_address || '') : '';
                            const attorneyPhone = mergedApplicant ? (mergedApplicant.attorney_phone || '') : '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                            ${name ? `<div style="font-weight: 600; color: #1E40AF; font-size: 15px;">${escapeHtml(name)}</div>` : ''}
                                            ${mergedApplicant ? `<span style="background: #DBEAFE; color: #1E40AF; font-size: 11px; font-weight: 500; padding: 2px 8px; border-radius: 4px;">Applicant & Operator</span>` : ''}
                                        </div>
                                        ${contactName ? `<div style="font-size: 13px; color: #374151;"><strong>Contact:</strong> ${escapeHtml(contactName)}</div>` : ''}
                                        ${fullAddress ? `<div style="font-size: 13px; color: #6B7280; margin-top: 4px;">${escapeHtml(fullAddress)}</div>` : ''}
                                        ${phone || email ? `<div style="margin-top: 8px; display: flex; gap: 16px; flex-wrap: wrap;">
                                            ${phone ? `<span style="font-size: 13px; color: #059669;">📞 ${escapeHtml(phone)}</span>` : ''}
                                            ${email ? `<span style="font-size: 13px; color: #3B82F6;">✉️ ${escapeHtml(email)}</span>` : ''}
                                        </div>` : ''}
                                        ${attorney ? `
                                            <div style="border-top: 1px solid #BFDBFE; padding-top: 8px; margin-top: 10px;">
                                                <div style="font-size: 13px; color: #374151;"><strong>Attorney:</strong> ${escapeHtml(attorney)}${attorneyOba ? ` (OBA #${escapeHtml(attorneyOba)})` : ''}</div>
                                                ${attorneyAddress ? `<div style="font-size: 12px; color: #6B7280; margin-top: 2px;">${escapeHtml(attorneyAddress)}</div>` : ''}
                                                ${attorneyPhone ? `<div style="font-size: 12px; color: #059669; margin-top: 2px;">📞 ${escapeHtml(attorneyPhone)}</div>` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'applicant' && typeof value === 'object') {
                            // Skip applicant card when already merged into operator section
                            const opName = data.operator && data.operator.name ? data.operator.name.trim().toLowerCase() : '';
                            const appName = value.name ? value.name.trim().toLowerCase() : '';
                            if (opName && appName && (opName === appName || value.is_operator === true)) {
                                // Don't render - info already shown in Operator card
                                continue;
                            }
                            // Special handling for applicant object (pooling order and increased density)
                            hasVisibleFields = true;
                            const name = value.name || '';
                            const isOperator = value.is_operator;
                            const attorney = value.attorney || '';
                            const attorneyOba = value.attorney_oba || '';
                            const attorneyAddress = value.attorney_address || '';
                            const attorneyPhone = value.attorney_phone || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 8px; padding: 12px;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: ${attorney ? '8px' : '0'};">
                                            ${name ? `<div style="font-weight: 600; color: #166534; font-size: 15px;">${escapeHtml(name)}</div>` : ''}
                                            ${isOperator === false ? `<span style="background: #FEF3C7; color: #92400E; font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 4px;">⚠️ NOT OPERATOR</span>` : ''}
                                            ${isOperator === true ? `<span style="background: #DCFCE7; color: #166534; font-size: 11px; font-weight: 500; padding: 2px 8px; border-radius: 4px;">Operator</span>` : ''}
                                        </div>
                                        ${attorney ? `
                                            <div style="border-top: 1px solid #BBF7D0; padding-top: 8px; margin-top: 4px;">
                                                <div style="font-size: 13px; color: #374151;"><strong>Attorney:</strong> ${escapeHtml(attorney)}${attorneyOba ? ` (OBA #${escapeHtml(attorneyOba)})` : ''}</div>
                                                ${attorneyAddress ? `<div style="font-size: 12px; color: #6B7280; margin-top: 2px;">${escapeHtml(attorneyAddress)}</div>` : ''}
                                                ${attorneyPhone ? `<div style="font-size: 12px; color: #059669; margin-top: 2px;">📞 ${escapeHtml(attorneyPhone)}</div>` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'attorney_information' && typeof value === 'object') {
                            // Special handling for attorney information object
                            hasVisibleFields = true;
                            const alj = value.administrative_law_judge || '';
                            const applicantAttorney = value.applicant_attorney || '';
                            const firm = value.applicant_attorney_firm || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #FAF5FF; border: 1px solid #A855F7; border-radius: 8px; padding: 12px;">
                                        ${alj ? `<div style="font-size: 13px; color: #374151; margin-bottom: 6px;"><strong>Administrative Law Judge:</strong> ${escapeHtml(alj)}</div>` : ''}
                                        ${applicantAttorney ? `<div style="font-size: 13px; color: #374151;"><strong>Applicant Attorney:</strong> ${escapeHtml(applicantAttorney)}${firm ? ` (${escapeHtml(firm)})` : ''}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'order_info' && typeof value === 'object') {
                            // Special handling for order details object (pooling, unitization, and other OCC orders)
                            hasVisibleFields = true;
                            const caseNumber = value.case_number || value.cause_number || '';
                            const orderNumber = value.order_number || '';
                            const applicant = value.applicant || '';
                            const hearingDate = value.hearing_date || '';
                            const orderDate = value.order_date || '';
                            const effectiveDate = value.effective_date || '';
                            const aljReportDate = value.alj_report_date || value.alj_approval_date || '';
                            const aljName = value.alj_name || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
                                        ${caseNumber ? `<div><label style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Cause Number</label><div style="font-weight: 600; color: #1F2937;">${escapeHtml(caseNumber)}</div></div>` : ''}
                                        ${orderNumber ? `<div><label style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Order Number</label><div style="font-weight: 600; color: #1F2937;">${escapeHtml(orderNumber)}</div></div>` : ''}
                                        ${applicant ? `<div><label style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Applicant</label><div style="font-weight: 500; color: #374151;">${escapeHtml(applicant)}</div></div>` : ''}
                                        ${hearingDate ? `<div><label style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Hearing Date</label><div style="color: #374151;">${escapeHtml(hearingDate)}</div></div>` : ''}
                                        ${orderDate && effectiveDate && orderDate === effectiveDate ? `
                                            <div><label style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Order / Effective Date</label><div style="color: #374151;">${escapeHtml(orderDate)}</div></div>
                                        ` : `
                                            ${orderDate ? `<div><label style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Order Date</label><div style="color: #374151;">${escapeHtml(orderDate)}</div></div>` : ''}
                                            ${effectiveDate ? `<div><label style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Effective Date</label><div style="color: #374151;">${escapeHtml(effectiveDate)}</div></div>` : ''}
                                        `}
                                        ${aljName ? `<div><label style="font-size: 11px; color: #6B7280; text-transform: uppercase;">ALJ</label><div style="color: #374151;">${escapeHtml(aljName)}</div></div>` : ''}
                                        ${aljReportDate ? `<div><label style="font-size: 11px; color: #6B7280; text-transform: uppercase;">ALJ Approval Date</label><div style="color: #374151;">${escapeHtml(aljReportDate)}</div></div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'unit_info' && typeof value === 'object') {
                            // Special handling for unit information object
                            // Supports: pooling orders (legal_description), increased density, AND unitization orders (unit_name, unit_operator)

                            // Check if this is a unitization order format (has unit_name)
                            if (value.unit_name || value.unit_operator || value.total_acres) {
                                // Unitization order format
                                const unitName = value.unit_name || '';
                                const unitType = value.unit_type || '';
                                const unitOperator = value.unit_operator || '';
                                const totalAcres = value.total_acres;
                                const tractCount = value.tract_count;

                                if (unitName || unitOperator || totalAcres) {
                                    hasVisibleFields = true;
                                    sectionContent += `
                                        <div class="doc-field" style="grid-column: 1 / -1;">
                                            <div style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); border-radius: 12px; padding: 20px; color: white;">
                                                ${unitName ? `<div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 8px;">${escapeHtml(unitName)}</div>` : ''}
                                                <div style="display: flex; flex-wrap: wrap; gap: 24px; margin-top: 12px;">
                                                    ${unitType ? `
                                                        <div>
                                                            <div style="font-size: 0.75rem; text-transform: uppercase; opacity: 0.8;">Unit Type</div>
                                                            <div style="font-size: 1rem; font-weight: 500;">${escapeHtml(unitType)}</div>
                                                        </div>
                                                    ` : ''}
                                                    ${unitOperator ? `
                                                        <div>
                                                            <div style="font-size: 0.75rem; text-transform: uppercase; opacity: 0.8;">Unit Operator</div>
                                                            <div style="font-size: 1rem; font-weight: 500;">${escapeHtml(unitOperator)}</div>
                                                        </div>
                                                    ` : ''}
                                                    ${totalAcres ? `
                                                        <div>
                                                            <div style="font-size: 0.75rem; text-transform: uppercase; opacity: 0.8;">Total Acres</div>
                                                            <div style="font-size: 1rem; font-weight: 500;">${Number(totalAcres).toLocaleString()}</div>
                                                        </div>
                                                    ` : ''}
                                                    ${tractCount ? `
                                                        <div>
                                                            <div style="font-size: 0.75rem; text-transform: uppercase; opacity: 0.8;">Tracts</div>
                                                            <div style="font-size: 1rem; font-weight: 500;">${tractCount}</div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            ${getConfidenceIndicator(fieldName, fieldScores)}
                                        </div>`;
                                }
                            } else {
                                // Pooling order format has nested legal_description
                                hasVisibleFields = true;
                                const legalDesc = value.legal_description || {};
                                const unitDesc = value.unit_description || value.description || '';
                                const unitSize = value.unit_size_acres;
                                const spacingOrder = value.spacing_order || '';
                                const section = legalDesc.section || '';
                                const township = legalDesc.township || '';
                                const range = legalDesc.range || '';
                                const county = legalDesc.county || '';
                                const quarters = legalDesc.quarters || '';

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F0F9FF; border: 1px solid #0EA5E9; border-radius: 8px; padding: 14px;">
                                            ${section ? `<div style="font-weight: 600; color: #0369A1; font-size: 15px;">Section ${escapeHtml(section)} - ${escapeHtml(township)}-${escapeHtml(range)}${county ? `, ${escapeHtml(county)} County` : ''}</div>` : ''}
                                            ${quarters ? `<div style="font-size: 13px; color: #374151; margin-top: 4px;">${escapeHtml(quarters)}</div>` : ''}
                                            ${unitDesc ? `<div style="font-size: 13px; color: #6B7280; margin-top: 6px;">${escapeHtml(unitDesc)}</div>` : ''}
                                            <div style="display: flex; gap: 16px; margin-top: 8px; font-size: 13px;">
                                                ${unitSize ? `<span style="color: #059669; font-weight: 500;">${unitSize.toLocaleString()} acres</span>` : ''}
                                                ${spacingOrder ? `<span style="color: #6B7280;">Spacing Order: <strong>${escapeHtml(spacingOrder)}</strong></span>` : ''}
                                            </div>
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'allocation_formula' && typeof value === 'object') {
                            // Special handling for allocation formula (unitization orders)
                            const factors = value.factors || [];
                            const asOfDate = value.as_of_date;

                            if (factors.length > 0) {
                                hasVisibleFields = true;

                                // Color palette for factor bars
                                const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];

                                let factorBars = factors.map((f, i) => {
                                    const color = colors[i % colors.length];
                                    const width = f.weight_percent || 0;
                                    return `
                                        <div style="margin-bottom: 12px;">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                                <span style="font-size: 0.875rem; color: #374151;">${escapeHtml(f.factor_name || 'Unknown Factor')}</span>
                                                <span style="font-size: 0.875rem; font-weight: 600; color: #374151;">${width}%</span>
                                            </div>
                                            <div style="background: #E5E7EB; border-radius: 4px; height: 24px; overflow: hidden;">
                                                <div style="background: ${color}; height: 100%; width: ${width}%; border-radius: 4px; transition: width 0.3s;"></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('');

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px; padding: 16px;">
                                            <div style="font-size: 0.875rem; color: #6B7280; margin-bottom: 12px;">
                                                Participation percentages are calculated using these weighted factors:
                                            </div>
                                            ${factorBars}
                                            ${asOfDate ? `
                                                <div style="font-size: 0.75rem; color: #9CA3AF; margin-top: 8px;">
                                                    Cumulative production measured as of ${escapeHtml(asOfDate)}
                                                </div>
                                            ` : ''}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'authorized_operations' && typeof value === 'object') {
                            // Special handling for authorized operations (unitization orders)
                            const methods = value.specific_methods || [];
                            const hasSecondary = value.secondary_recovery;
                            const hasEnhanced = value.enhanced_recovery;
                            const hasInjection = value.injection_wells_permitted;

                            if (methods.length > 0 || hasSecondary || hasEnhanced) {
                                hasVisibleFields = true;

                                let badges = [];
                                if (hasEnhanced) badges.push({label: 'Enhanced Recovery', color: '#7C3AED', bg: '#EDE9FE'});
                                if (hasSecondary) badges.push({label: 'Secondary Recovery', color: '#2563EB', bg: '#DBEAFE'});
                                if (hasInjection) badges.push({label: 'Injection Wells Permitted', color: '#059669', bg: '#D1FAE5'});

                                let badgeHtml = badges.map(b => `
                                    <span style="display: inline-block; background: ${b.bg}; color: ${b.color}; padding: 4px 12px; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; margin-right: 8px; margin-bottom: 8px;">
                                        ${b.label}
                                    </span>
                                `).join('');

                                let methodsHtml = methods.length > 0 ? `
                                    <div style="margin-top: 12px;">
                                        <div style="font-size: 0.75rem; text-transform: uppercase; color: #6B7280; margin-bottom: 8px;">Specific Methods Authorized</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                            ${methods.map(m => `<span style="background: #F3F4F6; padding: 4px 10px; border-radius: 4px; font-size: 0.875rem;">${escapeHtml(m)}</span>`).join('')}
                                        </div>
                                    </div>
                                ` : '';

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px; padding: 16px;">
                                            ${badgeHtml}
                                            ${methodsHtml}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'termination_provisions' && typeof value === 'object') {
                            // Special handling for termination provisions (unitization orders)
                            const leaseExtension = value.lease_extension_days;
                            const salvagePeriod = value.salvage_period_months;
                            const taMonths = value.temporarily_abandoned_months;

                            if (leaseExtension || salvagePeriod || taMonths) {
                                hasVisibleFields = true;

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #FFFBEB; border: 1px solid #FCD34D; border-radius: 8px; padding: 16px;">
                                            <div style="font-size: 0.875rem; color: #92400E; margin-bottom: 12px;">
                                                <strong>When unit operations cease:</strong>
                                            </div>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                                ${leaseExtension ? `
                                                    <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #FDE68A;">
                                                        <div style="font-size: 2rem; font-weight: 700; color: #D97706;">${leaseExtension}</div>
                                                        <div style="font-size: 0.875rem; color: #92400E;">day lease extension</div>
                                                        <div style="font-size: 0.75rem; color: #B45309; margin-top: 4px;">to allow lessee to resume operations</div>
                                                    </div>
                                                ` : ''}
                                                ${salvagePeriod ? `
                                                    <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #FDE68A;">
                                                        <div style="font-size: 2rem; font-weight: 700; color: #D97706;">${salvagePeriod}</div>
                                                        <div style="font-size: 0.875rem; color: #92400E;">month salvage period</div>
                                                        <div style="font-size: 0.75rem; color: #B45309; margin-top: 4px;">for operator to remove equipment</div>
                                                    </div>
                                                ` : ''}
                                                ${taMonths ? `
                                                    <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #FDE68A;">
                                                        <div style="font-size: 2rem; font-weight: 700; color: #D97706;">${taMonths}</div>
                                                        <div style="font-size: 0.875rem; color: #92400E;">months = "temporarily abandoned"</div>
                                                        <div style="font-size: 0.75rem; color: #B45309; margin-top: 4px;">production cessation threshold</div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'ratification' && typeof value === 'object') {
                            // Special handling for ratification (unitization orders)
                            const lesseePct = value.lessee_percent;
                            const ownerPct = value.owner_percent;
                            const requiredPct = value.required_percent;
                            const method = value.effective_method;

                            if (lesseePct || ownerPct) {
                                hasVisibleFields = true;

                                const lesseeOk = lesseePct >= (requiredPct || 63);
                                const ownerOk = ownerPct >= (requiredPct || 63);

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F0FDF4; border: 1px solid #86EFAC; border-radius: 8px; padding: 16px;">
                                            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                                                ${lesseePct ? `
                                                    <div>
                                                        <div style="font-size: 0.75rem; text-transform: uppercase; color: #166534;">Lessee Ratification</div>
                                                        <div style="font-size: 1.5rem; font-weight: 700; color: ${lesseeOk ? '#15803D' : '#DC2626'};">
                                                            ${lesseePct.toFixed(2)}%
                                                            ${lesseeOk ? '✓' : '✗'}
                                                        </div>
                                                    </div>
                                                ` : ''}
                                                ${ownerPct ? `
                                                    <div>
                                                        <div style="font-size: 0.75rem; text-transform: uppercase; color: #166534;">Owner Ratification</div>
                                                        <div style="font-size: 1.5rem; font-weight: 700; color: ${ownerOk ? '#15803D' : '#DC2626'};">
                                                            ${ownerPct.toFixed(2)}%
                                                            ${ownerOk ? '✓' : '✗'}
                                                        </div>
                                                    </div>
                                                ` : ''}
                                                ${requiredPct ? `
                                                    <div>
                                                        <div style="font-size: 0.75rem; text-transform: uppercase; color: #166534;">Required</div>
                                                        <div style="font-size: 1.5rem; font-weight: 700; color: #166534;">${requiredPct}%</div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            ${method ? `
                                                <div style="margin-top: 12px; font-size: 0.875rem; color: #166534;">
                                                    Method: ${escapeHtml(formatFieldName(method))}
                                                </div>
                                            ` : ''}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'reference_well' && typeof value === 'object') {
                            // Special handling for reference well (unitization orders)
                            const wellName = value.well_name;
                            const api = value.api_number;
                            const section = value.section;
                            const twp = value.township;
                            const rng = value.range;
                            const county = value.county;
                            const depthTop = value.depth_interval_top_ft;
                            const depthBottom = value.depth_interval_bottom_ft;

                            if (wellName || api) {
                                hasVisibleFields = true;

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F3F4F6; border-radius: 8px; padding: 16px;">
                                            <div style="font-size: 0.75rem; text-transform: uppercase; color: #6B7280; margin-bottom: 8px;">Reference Well (defines formation interval)</div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
                                                ${wellName ? `<div style="font-weight: 600; font-size: 1rem;">${escapeHtml(wellName)}</div>` : ''}
                                                ${api ? `<div style="font-family: monospace; background: #E5E7EB; padding: 4px 8px; border-radius: 4px;">API: ${escapeHtml(api)}</div>` : ''}
                                                ${(section && twp && rng) ? `<div style="color: #6B7280;">${section}-${escapeHtml(twp)}-${escapeHtml(rng)}${county ? ', ' + escapeHtml(county) : ''}</div>` : ''}
                                                ${(depthTop && depthBottom) ? `<div style="color: #6B7280;">${depthTop.toLocaleString()}-${depthBottom.toLocaleString()} ft</div>` : ''}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'exhibits' && Array.isArray(value) && value.length > 0) {
                            // Special handling for exhibits array (unitization orders)
                            hasVisibleFields = true;

                            let exhibitList = value.map(ex => {
                                const letter = ex.exhibit_letter || '';
                                const desc = ex.description || '';
                                return `
                                    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid #E5E7EB;">
                                        <div style="background: #3B82F6; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0;">
                                            ${escapeHtml(letter)}
                                        </div>
                                        <div style="color: #374151;">${escapeHtml(desc)}</div>
                                    </div>
                                `;
                            }).join('');

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: white; border: 1px solid #E5E7EB; border-radius: 8px; padding: 16px;">
                                        ${exhibitList}
                                    </div>
                                    ${getConfidenceIndicator(fieldName, fieldScores)}
                                </div>`;
                        } else if (fieldName === 'parties' && typeof value === 'object' && data.doc_type === 'unitization_order') {
                            // Special handling for parties (unitization orders)
                            const applicant = value.applicant || {};
                            const otherParties = value.other_parties || [];

                            if (applicant.name || otherParties.length > 0) {
                                hasVisibleFields = true;

                                let applicantHtml = applicant.name ? `
                                    <div style="background: #F0F9FF; border: 1px solid #0EA5E9; border-radius: 8px; padding: 14px; margin-bottom: 12px;">
                                        <div style="font-size: 0.75rem; text-transform: uppercase; color: #0369A1; margin-bottom: 6px;">Applicant</div>
                                        <div style="font-weight: 600; color: #0C4A6E;">${escapeHtml(applicant.name)}</div>
                                        ${applicant.attorneys && applicant.attorneys.length > 0 ? `
                                            <div style="font-size: 0.875rem; color: #6B7280; margin-top: 6px;">
                                                Attorneys: ${applicant.attorneys.map(a => escapeHtml(a)).join(', ')}
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : '';

                                let otherPartiesHtml = otherParties.length > 0 ? `
                                    <div style="font-size: 0.75rem; text-transform: uppercase; color: #6B7280; margin-bottom: 8px;">Other Parties</div>
                                    ${otherParties.map(p => `
                                        <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                                            <div style="font-weight: 500; color: #374151;">${escapeHtml(p.name || '')}</div>
                                            ${p.role ? `<div style="font-size: 0.875rem; color: #6B7280;">${escapeHtml(p.role)}</div>` : ''}
                                            ${p.attorney ? `<div style="font-size: 0.875rem; color: #9CA3AF;">Attorney: ${escapeHtml(p.attorney)}</div>` : ''}
                                        </div>
                                    `).join('')}
                                ` : '';

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        ${applicantHtml}
                                        ${otherPartiesHtml}
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'location' && typeof value === 'object' && data.doc_type === 'unitization_order') {
                            // Special handling for location (unit boundaries for unitization orders)
                            const counties = value.counties || [];
                            const sections = value.sections || [];

                            if (counties.length > 0 || sections.length > 0) {
                                hasVisibleFields = true;

                                let countiesHtml = counties.length > 0 ? `
                                    <div style="margin-bottom: 16px;">
                                        <span style="font-size: 0.875rem; color: #6B7280;">Counties:</span>
                                        ${counties.map(c => `<span style="background: #DBEAFE; color: #1D4ED8; padding: 4px 10px; border-radius: 4px; margin-left: 8px; font-weight: 500;">${escapeHtml(c)}</span>`).join('')}
                                    </div>
                                ` : '';

                                let sectionsTable = sections.length > 0 ? `
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                        <thead style="background: #F3F4F6;">
                                            <tr>
                                                <th style="padding: 8px 12px; text-align: left; border-bottom: 2px solid #E5E7EB;">Section</th>
                                                <th style="padding: 8px 12px; text-align: left; border-bottom: 2px solid #E5E7EB;">Twp-Rng</th>
                                                <th style="padding: 8px 12px; text-align: left; border-bottom: 2px solid #E5E7EB;">County</th>
                                                <th style="padding: 8px 12px; text-align: left; border-bottom: 2px solid #E5E7EB;">Quarters</th>
                                                <th style="padding: 8px 12px; text-align: right; border-bottom: 2px solid #E5E7EB;">Acres</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${sections.map(s => `
                                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                                    <td style="padding: 8px 12px;">${s.section || ''}</td>
                                                    <td style="padding: 8px 12px;">${escapeHtml(s.township || '')}-${escapeHtml(s.range || '')}</td>
                                                    <td style="padding: 8px 12px;">${escapeHtml(s.county || '')}</td>
                                                    <td style="padding: 8px 12px;">${escapeHtml(s.quarters || '')}</td>
                                                    <td style="padding: 8px 12px; text-align: right;">${s.acres_in_unit ? s.acres_in_unit.toLocaleString() : ''}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '';

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: white; border: 1px solid #E5E7EB; border-radius: 8px; padding: 16px;">
                                            ${countiesHtml}
                                            ${sectionsTable}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'well_info' && typeof value === 'object') {
                            // Special handling for well information object
                            // Supports pooling orders (proposed_well_name) and location exception orders (well_name)
                            hasVisibleFields = true;
                            const wellName = value.proposed_well_name || value.well_name || '';
                            const wellType = value.well_type || '';
                            const wellStatus = value.well_status || '';
                            const apiNumber = value.api_number || '';
                            const initialCost = value.initial_well_cost;
                            // Location exception order fields
                            const operator = value.operator || '';
                            const previousFormation = value.previous_formation || '';
                            const spacingUnitAcres = value.spacing_unit_acres;

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 14px;">
                                        ${wellName ? `<div style="font-weight: 600; color: #92400E; font-size: 15px; margin-bottom: 6px;">${escapeHtml(wellName)}</div>` : ''}
                                        <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px;">
                                            ${wellType ? `<span style="color: #374151;"><strong>Type:</strong> ${escapeHtml(formatFieldName(wellType))}</span>` : ''}
                                            ${wellStatus ? `<span style="color: #374151;"><strong>Status:</strong> ${escapeHtml(wellStatus)}</span>` : ''}
                                            ${apiNumber ? `<span style="color: #6B7280;"><strong>API:</strong> ${escapeHtml(apiNumber)}</span>` : ''}
                                            ${operator ? `<span style="color: #374151;"><strong>Operator:</strong> ${escapeHtml(operator)}</span>` : ''}
                                            ${previousFormation ? `<span style="color: #6B7280;"><strong>Previous Formation:</strong> ${escapeHtml(previousFormation)}</span>` : ''}
                                            ${spacingUnitAcres ? `<span style="color: #6B7280;"><strong>Spacing Unit:</strong> ${spacingUnitAcres} acres</span>` : ''}
                                        </div>
                                        ${initialCost ? `<div style="font-size: 13px; color: #92400E; font-weight: 500; margin-top: 8px;">Est. Well Cost: $${initialCost.toLocaleString()}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'former_operator' && typeof value === 'object' && data.doc_type !== 'well_transfer') {
                            // Special handling for former operator (change of operator orders) - NOT for well_transfer
                            hasVisibleFields = true;
                            const name = value.name || '';
                            const address = value.address || '';
                            const city = value.city || '';
                            const state = value.state || '';
                            const zip = value.zip || '';
                            const otcNumber = value.otc_operator_number || '';

                            const addressParts = [address, city, state, zip].filter(Boolean);
                            const fullAddress = addressParts.join(', ');

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #FEE2E2; border: 1px solid #EF4444; border-radius: 8px; padding: 14px;">
                                        <div style="font-weight: 600; color: #DC2626; font-size: 15px; margin-bottom: 6px;">${escapeHtml(name)}</div>
                                        <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px;">
                                            ${otcNumber ? `<span style="color: #6B7280;"><strong>OTC Operator #:</strong> ${escapeHtml(otcNumber)}</span>` : ''}
                                            ${fullAddress ? `<span style="color: #6B7280;"><strong>Address:</strong> ${escapeHtml(fullAddress)}</span>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'new_operator' && typeof value === 'object' && data.doc_type !== 'well_transfer') {
                            // Special handling for new operator (change of operator orders) - NOT for well_transfer
                            hasVisibleFields = true;
                            const name = value.name || '';
                            const address = value.address || '';
                            const city = value.city || '';
                            const state = value.state || '';
                            const zip = value.zip || '';
                            const otcNumber = value.otc_operator_number || '';
                            const inBusiness = value.in_business_since || '';
                            const wellsOperated = value.wells_currently_operated;
                            const financialAmt = value.financial_statement_amount;

                            const addressParts = [address, city, state, zip].filter(Boolean);
                            const fullAddress = addressParts.join(', ');

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #DCFCE7; border: 1px solid #22C55E; border-radius: 8px; padding: 14px;">
                                        <div style="font-weight: 600; color: #166534; font-size: 15px; margin-bottom: 6px;">${escapeHtml(name)}</div>
                                        <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px;">
                                            ${otcNumber ? `<span style="color: #065F46;"><strong>OTC Operator #:</strong> ${escapeHtml(otcNumber)}</span>` : ''}
                                            ${fullAddress ? `<span style="color: #6B7280;"><strong>Address:</strong> ${escapeHtml(fullAddress)}</span>` : ''}
                                        </div>
                                        <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px; margin-top: 8px;">
                                            ${wellsOperated ? `<span style="color: #065F46;"><strong>Wells Currently Operated:</strong> ${wellsOperated}</span>` : ''}
                                            ${financialAmt ? `<span style="color: #065F46;"><strong>Financial Statement:</strong> $${financialAmt.toLocaleString()}</span>` : ''}
                                            ${inBusiness ? `<span style="color: #6B7280;"><strong>In Business Since:</strong> ${escapeHtml(inBusiness)}</span>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'deadlines' && typeof value === 'object') {
                            // Special handling for deadlines object
                            hasVisibleFields = true;
                            const electionDays = value.election_period_days;
                            const electionDeadline = value.election_deadline || '';
                            const participationDays = value.participation_payment_days;
                            const bonusDays = value.bonus_payment_days;
                            const commencementDays = value.operator_commencement_days;

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #FEE2E2; border: 1px solid #EF4444; border-radius: 8px; padding: 14px;">
                                        <div style="font-weight: 600; color: #DC2626; font-size: 14px; margin-bottom: 10px;">⚠️ Important Deadlines</div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                                            ${electionDays ? `<div style="background: white; border-radius: 6px; padding: 10px;"><div style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Election Period</div><div style="font-weight: 600; color: #DC2626; font-size: 16px;">${electionDays} days</div>${electionDeadline ? `<div style="font-size: 12px; color: #6B7280;">Deadline: ${escapeHtml(electionDeadline)}</div>` : ''}</div>` : ''}
                                            ${participationDays ? `<div style="background: white; border-radius: 6px; padding: 10px;"><div style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Participation Payment</div><div style="font-weight: 500; color: #374151;">${participationDays} days</div></div>` : ''}
                                            ${bonusDays ? `<div style="background: white; border-radius: 6px; padding: 10px;"><div style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Bonus Payment</div><div style="font-weight: 500; color: #374151;">${bonusDays} days</div></div>` : ''}
                                            ${commencementDays ? `<div style="background: white; border-radius: 6px; padding: 10px;"><div style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Operator Must Commence</div><div style="font-weight: 500; color: #374151;">${commencementDays} days</div></div>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'subsequent_wells' && typeof value === 'object') {
                            // Special handling for subsequent wells provision
                            hasVisibleFields = true;
                            const hasProvision = value.has_provision;
                            const noticeDays = value.notice_period_days;
                            const paymentDays = value.payment_deadline_days;
                            const bonusPaymentDays = value.bonus_payment_deadline_days;
                            const commencementDays = value.operator_commencement_days;
                            const participationOptions = value.participation_options;
                            const excludesReplacement = value.excludes_replacement_wells;

                            if (hasProvision) {
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #FAF5FF; border: 1px solid #A855F7; border-radius: 8px; padding: 14px;">
                                            <div style="font-weight: 600; color: #7C3AED; font-size: 14px; margin-bottom: 8px;">📋 Subsequent Wells Provision</div>
                                            <div style="font-size: 13px; color: #374151;">This order covers future wells in the same unit.</div>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; margin-top: 10px; font-size: 13px;">
                                                ${noticeDays ? `<div><span style="color: #6B7280;">Election Period:</span> <strong>${noticeDays} days</strong></div>` : ''}
                                                ${paymentDays ? `<div><span style="color: #6B7280;">Payment Deadline:</span> <strong>${paymentDays} days</strong></div>` : ''}
                                                ${bonusPaymentDays ? `<div><span style="color: #6B7280;">Bonus Payment:</span> <strong>${bonusPaymentDays} days</strong></div>` : ''}
                                                ${commencementDays ? `<div><span style="color: #6B7280;">Operator Commencement:</span> <strong>${commencementDays} days</strong></div>` : ''}
                                            </div>
                                            ${participationOptions && Array.isArray(participationOptions) && participationOptions.length > 0 ? `
                                                <div style="margin-top: 10px;">
                                                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px;">Available Options:</div>
                                                    <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #374151;">
                                                        ${participationOptions.map(opt => `<li>${escapeHtml(String(opt))}</li>`).join('')}
                                                    </ul>
                                                </div>` : ''}
                                            ${excludesReplacement ? `<div style="font-size: 12px; color: #6B7280; margin-top: 8px; font-style: italic;">Note: Excludes replacement/substitute wells</div>` : ''}
                                        </div>
                                    </div>`;
                            } else {
                                hasVisibleFields = false;
                            }
                        } else if (fieldName === 'additional_parties' && typeof value === 'object') {
                            // Special handling for additional parties object with nested arrays
                            hasVisibleFields = true;
                            sectionContent += `<div class="doc-field" style="grid-column: 1 / -1;">`;

                            // Render respondents with known addresses
                            const knownRespondents = value.respondents_with_known_addresses || [];
                            if (Array.isArray(knownRespondents) && knownRespondents.length > 0) {
                                sectionContent += `<div style="margin-bottom: 12px;"><div style="font-size: 12px; color: #6B7280; margin-bottom: 6px; text-transform: uppercase;">Respondents with Known Addresses</div>`;
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 6px;">`;
                                knownRespondents.forEach(party => {
                                    const name = party.name || '';
                                    const address = party.address || '';
                                    sectionContent += `
                                        <div style="background: #F3F4F6; border: 1px solid #D1D5DB; border-radius: 6px; padding: 8px 12px;">
                                            <div style="font-weight: 500; color: #374151;">${escapeHtml(name)}</div>
                                            ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 2px;">${escapeHtml(address)}</div>` : ''}
                                        </div>`;
                                });
                                sectionContent += `</div></div>`;
                            }

                            // Render counts for unknown addresses and dismissed
                            const unknownCount = value.respondents_with_unknown_addresses;
                            const dismissedCount = value.respondents_dismissed;
                            if (unknownCount || dismissedCount) {
                                sectionContent += `<div style="display: flex; gap: 16px; font-size: 13px; color: #6B7280;">`;
                                if (unknownCount) sectionContent += `<span>Unknown addresses: ${unknownCount}</span>`;
                                if (dismissedCount) sectionContent += `<span>Dismissed: ${dismissedCount}</span>`;
                                sectionContent += `</div>`;
                            }

                            sectionContent += `</div>`;
                        } else if (fieldName === 'officials' && typeof value === 'object') {
                            // Special handling for officials object (increased density orders)
                            hasVisibleFields = true;
                            const alj = value.administrative_law_judge || '';
                            const commissioners = value.commissioners || [];

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 8px; padding: 14px;">
                                        ${alj ? `<div style="font-size: 13px; color: #374151; margin-bottom: 8px;"><strong>Administrative Law Judge:</strong> ${escapeHtml(alj)}</div>` : ''}
                                        ${commissioners.length > 0 ? `
                                            <div style="font-size: 13px; color: #374151;">
                                                <strong>Commissioners:</strong> ${commissioners.map(c => {
                                                    if (typeof c === 'object') {
                                                        const name = c.name || '';
                                                        const title = c.title || '';
                                                        return escapeHtml(title ? `${name} (${title})` : name);
                                                    }
                                                    return escapeHtml(String(c));
                                                }).join(', ')}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'well_authorization' && typeof value === 'object') {
                            // Special handling for well authorization object (increased density orders)
                            hasVisibleFields = true;
                            const wellName = value.well_name || '';
                            const apiNumber = value.api_number || '';
                            const wellType = value.well_type || '';
                            const wellClassification = value.well_classification || '';
                            const additionalWells = value.additional_wells_authorized;

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 14px;">
                                        ${wellName ? `<div style="font-weight: 600; color: #92400E; font-size: 16px; margin-bottom: 8px;">${escapeHtml(wellName)}</div>` : ''}
                                        <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px;">
                                            ${wellType ? `<span style="background: #FEF9C3; padding: 4px 10px; border-radius: 4px;"><strong>Type:</strong> ${escapeHtml(wellType)}</span>` : ''}
                                            ${wellClassification ? `<span style="background: ${wellClassification.toLowerCase() === 'oil' ? '#FEE2E2' : '#DBEAFE'}; padding: 4px 10px; border-radius: 4px;"><strong>Classification:</strong> ${escapeHtml(wellClassification)}</span>` : ''}
                                            ${apiNumber ? `<span style="color: #6B7280;"><strong>API:</strong> ${escapeHtml(apiNumber)}</span>` : ''}
                                        </div>
                                        ${additionalWells ? `<div style="font-size: 14px; color: #166534; font-weight: 500; margin-top: 10px;">✓ ${additionalWells} additional well${additionalWells > 1 ? 's' : ''} authorized</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'recoverable_reserves' && typeof value === 'object') {
                            // Special handling for recoverable reserves object (increased density orders)
                            const oilMbo = value.oil_mbo;
                            const gasMmcf = value.gas_mmcf;
                            if (oilMbo || gasMmcf) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 8px; padding: 14px;">
                                            <div style="font-weight: 600; color: #166534; font-size: 14px; margin-bottom: 10px;">📊 Estimated Recoverable Reserves</div>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                                                ${oilMbo ? `
                                                    <div style="background: white; border-radius: 6px; padding: 12px; text-align: center;">
                                                        <div style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Oil</div>
                                                        <div style="font-weight: 700; color: #92400E; font-size: 20px;">${oilMbo.toLocaleString()}</div>
                                                        <div style="font-size: 11px; color: #6B7280;">MBO (thousand barrels)</div>
                                                    </div>
                                                ` : ''}
                                                ${gasMmcf ? `
                                                    <div style="background: white; border-radius: 6px; padding: 12px; text-align: center;">
                                                        <div style="font-size: 11px; color: #6B7280; text-transform: uppercase;">Gas</div>
                                                        <div style="font-weight: 700; color: #0369A1; font-size: 20px;">${gasMmcf.toLocaleString()}</div>
                                                        <div style="font-size: 11px; color: #6B7280;">MMCF (million cubic feet)</div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'expiration' && typeof value === 'object') {
                            // Special handling for expiration object (increased density orders)
                            const period = value.period || '';
                            const date = value.date || '';
                            if (period || date) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 12px;">
                                            <div style="font-weight: 600; color: #92400E; font-size: 14px; margin-bottom: 6px;">⏰ Authorization Expiration</div>
                                            <div style="font-size: 13px; color: #374151;">
                                                ${period ? `<span>Valid for <strong>${escapeHtml(period)}</strong></span>` : ''}
                                                ${period && date ? ` • ` : ''}
                                                ${date ? `<span>Expires: <strong>${escapeHtml(date)}</strong></span>` : ''}
                                            </div>
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'related_orders' && Array.isArray(value) && value.length > 0) {
                            // Special handling for related orders array (unitization orders, v4 format)
                            // Format: [{order_number, relationship, cause_number, description}]
                            const superseded = value.filter(o => o.relationship === 'supersedes');

                            if (superseded.length > 0) {
                                hasVisibleFields = true;
                                const showScrollable = superseded.length > 10;

                                let orderList = superseded.map(order => {
                                    const orderNum = order.order_number || '';
                                    const desc = order.description || '';
                                    return `
                                        <div style="display: inline-flex; align-items: center; background: #FEE2E2; color: #991B1B; padding: 4px 10px; border-radius: 4px; font-size: 0.875rem; margin: 2px;">
                                            <span style="font-weight: 500;">${escapeHtml(orderNum)}</span>
                                            ${desc ? `<span style="margin-left: 6px; font-size: 0.75rem; color: #B91C1C;">(${escapeHtml(desc)})</span>` : ''}
                                        </div>
                                    `;
                                }).join('');

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 8px; padding: 16px;">
                                            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                                <svg style="width: 20px; height: 20px; color: #DC2626; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                </svg>
                                                <span style="font-weight: 600; color: #991B1B;">${superseded.length} Prior Spacing Order${superseded.length > 1 ? 's' : ''} Superseded</span>
                                            </div>
                                            <div style="font-size: 0.875rem; color: #7F1D1D; margin-bottom: 12px;">
                                                The following spacing orders no longer control production allocation within this unit area:
                                            </div>
                                            <div style="${showScrollable ? 'max-height: 200px; overflow-y: auto;' : ''} display: flex; flex-wrap: wrap; gap: 4px;">
                                                ${orderList}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'related_orders' && typeof value === 'object') {
                            // Special handling for related orders object
                            // Supports v1 (increased density), v2 (drilling/spacing), and v3 (location exception) structures
                            hasVisibleFields = true;
                            sectionContent += `<div class="doc-field" style="grid-column: 1 / -1;">`;
                            sectionContent += `<div style="background: #F3F4F6; border: 1px solid #D1D5DB; border-radius: 8px; padding: 12px;">`;

                            // v3 structure fields (location exception - references array)
                            const references = value.references || [];

                            // v1 structure fields (increased density)
                            const spacingOrder = value.spacing_order || '';
                            const amendsOrderV1 = typeof value.amends_order === 'string' ? value.amends_order : '';
                            const companionCases = value.companion_cases || [];

                            // v2 structure fields (drilling/spacing)
                            const corrects = value.corrects;
                            const amends = value.amends || [];
                            const extends_ = value.extends || [];
                            const vacates = value.vacates || [];
                            const supersededBy = value.superseded_by || '';

                            // Render v2 structure if present
                            if (corrects || amends.length > 0 || extends_.length > 0 || vacates.length > 0 || supersededBy) {
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 10px; font-size: 13px;">`;

                                // Corrects (nunc pro tunc)
                                if (corrects && typeof corrects === 'object') {
                                    sectionContent += `
                                        <div style="background: #DBEAFE; border-left: 3px solid #3B82F6; padding: 8px 12px; border-radius: 0 6px 6px 0;">
                                            <span style="color: #1E40AF; font-weight: 500;">Corrects Order:</span>
                                            <strong>${escapeHtml(corrects.order_number || '')}</strong>
                                            ${corrects.description ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(corrects.description)}</div>` : ''}
                                        </div>`;
                                }

                                // Amends
                                if (amends.length > 0) {
                                    amends.forEach(ref => {
                                        sectionContent += `
                                            <div style="background: #FEF3C7; border-left: 3px solid #F59E0B; padding: 8px 12px; border-radius: 0 6px 6px 0;">
                                                <span style="color: #92400E; font-weight: 500;">Amends Order:</span>
                                                <strong>${escapeHtml(ref.order_number || '')}</strong>
                                                ${ref.formation ? `<span style="color: #6B7280;"> (${escapeHtml(ref.formation)})</span>` : ''}
                                                ${ref.lands_affected ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Lands: ${escapeHtml(ref.lands_affected)}</div>` : ''}
                                            </div>`;
                                    });
                                }

                                // Extends
                                if (extends_.length > 0) {
                                    extends_.forEach(ref => {
                                        sectionContent += `
                                            <div style="background: #D1FAE5; border-left: 3px solid #10B981; padding: 8px 12px; border-radius: 0 6px 6px 0;">
                                                <span style="color: #065F46; font-weight: 500;">Extends Order:</span>
                                                <strong>${escapeHtml(ref.order_number || '')}</strong>
                                                ${ref.formation ? `<span style="color: #6B7280;"> (${escapeHtml(ref.formation)})</span>` : ''}
                                                ${ref.lands_affected ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Lands: ${escapeHtml(ref.lands_affected)}</div>` : ''}
                                            </div>`;
                                    });
                                }

                                // Vacates
                                if (vacates.length > 0) {
                                    vacates.forEach(ref => {
                                        sectionContent += `
                                            <div style="background: #FEE2E2; border-left: 3px solid #EF4444; padding: 8px 12px; border-radius: 0 6px 6px 0;">
                                                <span style="color: #DC2626; font-weight: 500;">Vacates Order:</span>
                                                <strong>${escapeHtml(ref.order_number || '')}</strong>
                                                ${ref.formation ? `<span style="color: #6B7280;"> (${escapeHtml(ref.formation)})</span>` : ''}
                                                ${ref.lands_affected ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Lands: ${escapeHtml(ref.lands_affected)}</div>` : ''}
                                            </div>`;
                                    });
                                }

                                // Superseded by
                                if (supersededBy) {
                                    sectionContent += `
                                        <div style="background: #F3F4F6; border-left: 3px solid #6B7280; padding: 8px 12px; border-radius: 0 6px 6px 0;">
                                            <span style="color: #4B5563; font-weight: 500;">Superseded By:</span>
                                            <strong>${escapeHtml(supersededBy)}</strong>
                                        </div>`;
                                }

                                sectionContent += `</div>`;
                            }
                            // Fall back to v1 structure
                            else if (spacingOrder || amendsOrderV1 || companionCases.length > 0) {
                                sectionContent += `
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; font-size: 13px;">
                                        ${spacingOrder ? `<div><span style="color: #6B7280;">Spacing Order:</span> <strong>${escapeHtml(spacingOrder)}</strong></div>` : ''}
                                        ${amendsOrderV1 ? `<div><span style="color: #6B7280;">Amends Order:</span> <strong>${escapeHtml(amendsOrderV1)}</strong></div>` : ''}
                                        ${companionCases.length > 0 ? `<div style="grid-column: 1 / -1;"><span style="color: #6B7280;">Companion Cases:</span> <strong>${companionCases.map(c => escapeHtml(c)).join(', ')}</strong></div>` : ''}
                                    </div>`;
                            }
                            // v3 structure (location exception - references array)
                            else if (references.length > 0) {
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 10px; font-size: 13px;">`;
                                references.forEach(ref => {
                                    const orderNum = ref.order_number || '';
                                    const causeNum = ref.cause_number || '';
                                    const refType = ref.type || 'reference';
                                    const description = ref.description || '';

                                    // Color coding by type
                                    let bgColor = '#F3F4F6';
                                    let borderColor = '#6B7280';
                                    let textColor = '#4B5563';
                                    if (refType === 'spacing_order' || refType === 'drilling_spacing') {
                                        bgColor = '#DBEAFE'; borderColor = '#3B82F6'; textColor = '#1E40AF';
                                    } else if (refType === 'pooling_order') {
                                        bgColor = '#D1FAE5'; borderColor = '#10B981'; textColor = '#065F46';
                                    } else if (refType === 'prior_location_exception') {
                                        bgColor = '#FEF3C7'; borderColor = '#F59E0B'; textColor = '#92400E';
                                    }

                                    sectionContent += `
                                        <div style="background: ${bgColor}; border-left: 3px solid ${borderColor}; padding: 8px 12px; border-radius: 0 6px 6px 0;">
                                            <span style="color: ${textColor}; font-weight: 500;">${formatFieldName(refType)}:</span>
                                            ${orderNum ? `<strong>${escapeHtml(orderNum)}</strong>` : ''}
                                            ${causeNum && !orderNum ? `<strong>Cause ${escapeHtml(causeNum)}</strong>` : ''}
                                            ${causeNum && orderNum ? `<span style="color: #6B7280;"> (Cause ${escapeHtml(causeNum)})</span>` : ''}
                                            ${description ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(description)}</div>` : ''}
                                        </div>`;
                                });
                                sectionContent += `</div>`;
                            }

                            sectionContent += `</div></div>`;
                        } else if (fieldName === 'recording' && typeof value === 'object') {
                            // Special handling for recording info object (mineral deeds v2 schema)
                            hasVisibleFields = true;
                            const recordingDate = value.recording_date || '';
                            const book = value.book || '';
                            const page = value.page || '';
                            const instrumentNumber = value.instrument_number || '';
                            const county = value.county || '';
                            const state = value.state || 'OK';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #F9FAFB; border: 1px solid #D1D5DB; border-radius: 8px; padding: 14px;">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; font-size: 13px;">
                                            ${book && page ? `<div><span style="color: #6B7280;">Book/Page:</span> <strong>${escapeHtml(book)}/${escapeHtml(page)}</strong></div>` : ''}
                                            ${instrumentNumber ? `<div><span style="color: #6B7280;">Instrument #:</span> <strong>${escapeHtml(instrumentNumber)}</strong></div>` : ''}
                                            ${recordingDate ? `<div><span style="color: #6B7280;">Recorded:</span> <strong>${escapeHtml(recordingDate)}</strong></div>` : ''}
                                            ${county ? `<div><span style="color: #6B7280;">County:</span> <strong>${escapeHtml(county)}${state ? `, ${escapeHtml(state)}` : ''}</strong></div>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'reservation' && typeof value === 'object') {
                            // Special handling for reservation object (mineral deeds v2 schema)
                            hasVisibleFields = true;
                            const resType = value.type || '';
                            const fractionText = value.fraction_text || '';
                            const fractionDecimal = value.fraction_decimal;
                            const description = value.description || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #FEE2E2; border: 1px solid #EF4444; border-radius: 8px; padding: 14px;">
                                        <div style="font-weight: 600; color: #DC2626; font-size: 14px; margin-bottom: 8px;">⚠️ Grantor Reserved Interest</div>
                                        <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px; margin-bottom: 8px;">
                                            ${resType ? `<span style="background: #FECACA; padding: 4px 10px; border-radius: 4px;"><strong>Type:</strong> ${escapeHtml(resType)}</span>` : ''}
                                            ${fractionText ? `<span style="background: #FECACA; padding: 4px 10px; border-radius: 4px;"><strong>Amount:</strong> ${escapeHtml(fractionText)}</span>` : ''}
                                            ${fractionDecimal !== undefined ? `<span style="color: #6B7280;">(${fractionDecimal})</span>` : ''}
                                        </div>
                                        ${description ? `<div style="font-size: 12px; color: #7F1D1D; padding: 8px; background: #FECACA; border-radius: 4px; font-style: italic;">${escapeHtml(description)}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if ((fieldName === 'lessor' || fieldName === 'lessee') && typeof value === 'object') {
                            // Special handling for lessor/lessee objects (oil_gas_lease v2 schema)
                            hasVisibleFields = true;
                            const partyType = fieldName === 'lessor' ? 'Lessor (Mineral Owner)' : 'Lessee (Oil Company)';
                            const bgColor = fieldName === 'lessor' ? '#FEF3C7' : '#EFF6FF';
                            const borderColor = fieldName === 'lessor' ? '#F59E0B' : '#3B82F6';
                            const textColor = fieldName === 'lessor' ? '#92400E' : '#1E40AF';

                            const name = value.name || '';
                            const address = value.address || '';
                            const city = value.city || '';
                            const state = value.state || '';
                            const zip = value.zip || '';
                            const capacity = value.capacity || '';
                            const signatory = value.signatory || '';
                            const signatoryTitle = value.signatory_title || '';
                            const fullAddress = [address, city, state, zip].filter(Boolean).join(', ').replace(/, ,/g, ',');

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>${partyType}</label>
                                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                            <span style="font-weight: 600; color: ${textColor}; font-size: 15px;">${escapeHtml(name)}</span>
                                            ${capacity ? `<span style="background: #E5E7EB; color: #374151; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">${escapeHtml(capacity)}</span>` : ''}
                                        </div>
                                        ${fullAddress ? `<div style="font-size: 13px; color: #6B7280; margin-top: 6px;">${escapeHtml(fullAddress)}</div>` : ''}
                                        ${signatory ? `<div style="font-size: 12px; color: #4B5563; margin-top: 6px; border-top: 1px solid ${borderColor}; padding-top: 6px;">
                                            <strong>Signed by:</strong> ${escapeHtml(signatory)}${signatoryTitle ? ` (${escapeHtml(signatoryTitle)})` : ''}
                                        </div>` : ''}
                                    </div>
                                </div>`;
                        } else if ((fieldName === 'from' || fieldName === 'sender' || fieldName === 'to') && typeof value === 'object' && data.doc_type === 'correspondence') {
                            // Special handling for correspondence from/sender/to objects
                            const company = value.company || value.name || '';
                            const address = value.address || '';
                            const phone = value.phone || '';
                            const fax = value.fax || '';
                            const email = value.email || '';
                            const name = value.name || '';
                            const title = value.title || '';

                            // Only show if there's actual data
                            if (company || name || address) {
                                hasVisibleFields = true;
                                const labelMap = { 'from': 'From', 'sender': 'Sender', 'to': 'To' };
                                const bgColor = fieldName === 'from' ? '#DBEAFE' : fieldName === 'sender' ? '#F3E8FF' : '#D1FAE5';
                                const borderColor = fieldName === 'from' ? '#3B82F6' : fieldName === 'sender' ? '#9333EA' : '#10B981';
                                const textColor = fieldName === 'from' ? '#1E40AF' : fieldName === 'sender' ? '#6B21A8' : '#047857';

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>${labelMap[fieldName]}</label>
                                        <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 14px;">
                                            <div style="font-weight: 600; color: ${textColor}; font-size: 15px;">${escapeHtml(company || name)}</div>
                                            ${fieldName === 'sender' && name && company ? `<div style="font-size: 13px; color: #4B5563; margin-top: 4px;">${escapeHtml(name)}${title ? ` - ${escapeHtml(title)}` : ''}</div>` : ''}
                                            ${address ? `<div style="font-size: 13px; color: #6B7280; margin-top: 6px;">${escapeHtml(address)}</div>` : ''}
                                            ${(phone || fax || email) ? `
                                                <div style="font-size: 12px; color: #4B5563; margin-top: 8px; display: flex; flex-wrap: wrap; gap: 12px;">
                                                    ${phone ? `<span>📞 ${escapeHtml(phone)}</span>` : ''}
                                                    ${fax ? `<span>📠 ${escapeHtml(fax)}</span>` : ''}
                                                    ${email ? `<span>✉️ ${escapeHtml(email)}</span>` : ''}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'primary_term' && typeof value === 'object') {
                            // Special handling for primary_term object (oil_gas_lease v2 schema)
                            hasVisibleFields = true;
                            const years = value.years;
                            const months = value.months;
                            const commencementDate = value.commencement_date || '';
                            const expirationDate = value.expiration_date || '';

                            let termStr = '';
                            if (years) termStr += `${years} year${years > 1 ? 's' : ''}`;
                            if (months) termStr += `${termStr ? ' ' : ''}${months} month${months > 1 ? 's' : ''}`;

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Primary Term</label>
                                    <div style="background: #DBEAFE; border: 1px solid #3B82F6; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 20px; font-size: 14px;">
                                            ${termStr ? `<div><span style="color: #6B7280;">Term:</span> <strong style="color: #1E40AF;">${escapeHtml(termStr)}</strong></div>` : ''}
                                            ${commencementDate ? `<div><span style="color: #6B7280;">Commencement:</span> <strong style="color: #1E40AF;">${escapeHtml(commencementDate)}</strong></div>` : ''}
                                            ${expirationDate ? `<div><span style="color: #6B7280;">Expiration:</span> <strong style="color: #DC2626;">${escapeHtml(expirationDate)}</strong></div>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'consideration' && typeof value === 'object') {
                            // Special handling for consideration object (oil_gas_lease v2 and trust_funding schemas)
                            hasVisibleFields = true;

                            // Trust funding schema fields
                            const stated = value.stated || '';
                            const considerationType = value.type || '';
                            const amount = value.amount;
                            const perAcre = value.per_acre;

                            // Oil & gas lease schema fields
                            const bonusStated = value.bonus_stated || '';
                            const bonusPerAcre = value.bonus_per_acre;
                            const totalBonus = value.total_bonus;
                            const isPaidUp = value.is_paid_up;
                            const delayRental = value.delay_rental || '';
                            const delayRentalPerAcre = value.delay_rental_per_acre;

                            // Detect which schema we're using
                            const isTrustFunding = data.doc_type === 'trust_funding' || (stated && !bonusStated);
                            const isLease = data.doc_type === 'oil_gas_lease' || bonusStated;

                            if (isTrustFunding) {
                                // Trust funding consideration display
                                const typeLabels = {
                                    'nominal': { label: 'NOMINAL', color: '#6B7280', bg: '#F3F4F6' },
                                    'gift': { label: 'GIFT/LOVE & AFFECTION', color: '#9333EA', bg: '#F3E8FF' },
                                    'specific': { label: 'SPECIFIC AMOUNT', color: '#166534', bg: '#DCFCE7' },
                                    'not_stated': { label: 'NOT STATED', color: '#6B7280', bg: '#F3F4F6' }
                                };
                                const typeConfig = typeLabels[considerationType] || { label: considerationType.toUpperCase(), color: '#6B7280', bg: '#F3F4F6' };

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Consideration</label>
                                        <div style="background: ${typeConfig.bg}; border: 1px solid #D1D5DB; border-radius: 8px; padding: 14px;">
                                            ${considerationType ? `<span style="background: ${typeConfig.color}; color: white; padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 12px; display: inline-block; margin-bottom: 10px;">${typeConfig.label}</span>` : ''}
                                            <div style="display: flex; flex-wrap: wrap; gap: 20px; font-size: 13px;">
                                                ${amount ? `<div><span style="color: #6B7280;">Amount:</span> <strong style="color: #166534;">$${amount.toLocaleString()}</strong></div>` : ''}
                                                ${perAcre ? `<div><span style="color: #6B7280;">Per Acre:</span> <strong style="color: #166534;">$${perAcre}/acre</strong></div>` : ''}
                                            </div>
                                            ${stated ? `<div style="font-size: 12px; color: #6B7280; margin-top: 8px; font-style: italic;">"${escapeHtml(stated)}"</div>` : ''}
                                        </div>
                                    </div>`;
                            } else {
                                // Oil & gas lease consideration display
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Consideration</label>
                                        <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 8px; padding: 14px;">
                                            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 10px;">
                                                ${isPaidUp === true ? `<span style="background: #22C55E; color: white; padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 12px;">PAID-UP LEASE</span>` : ''}
                                                ${isPaidUp === false ? `<span style="background: #F59E0B; color: white; padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 12px;">DELAY RENTAL</span>` : ''}
                                            </div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 20px; font-size: 13px;">
                                                ${bonusPerAcre ? `<div><span style="color: #6B7280;">Bonus:</span> <strong style="color: #166534;">$${bonusPerAcre}/acre</strong></div>` : ''}
                                                ${totalBonus ? `<div><span style="color: #6B7280;">Total Bonus:</span> <strong style="color: #166534;">$${totalBonus.toLocaleString()}</strong></div>` : ''}
                                                ${delayRentalPerAcre ? `<div><span style="color: #6B7280;">Delay Rental:</span> <strong style="color: #92400E;">$${delayRentalPerAcre}/acre/year</strong></div>` : ''}
                                            </div>
                                            ${bonusStated ? `<div style="font-size: 12px; color: #6B7280; margin-top: 8px; font-style: italic;">"${escapeHtml(bonusStated)}"</div>` : ''}
                                            ${delayRental && !delayRentalPerAcre ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Delay Rental: ${escapeHtml(delayRental)}</div>` : ''}
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'royalty' && typeof value === 'object') {
                            // Special handling for royalty object (oil_gas_lease v2 schema)
                            hasVisibleFields = true;
                            const oil = value.oil || {};
                            const gas = value.gas || {};
                            const otherMinerals = value.other_minerals || {};

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Royalty Rates</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                                        ${oil.fraction ? `
                                            <div style="background: #1F2937; color: white; border-radius: 8px; padding: 12px 16px; min-width: 100px; text-align: center;">
                                                <div style="font-size: 11px; color: #9CA3AF; margin-bottom: 4px;">OIL</div>
                                                <div style="font-size: 18px; font-weight: 700;">${escapeHtml(oil.fraction)}</div>
                                                ${oil.decimal ? `<div style="font-size: 11px; color: #9CA3AF;">(${oil.decimal})</div>` : ''}
                                            </div>` : ''}
                                        ${gas.fraction ? `
                                            <div style="background: #3B82F6; color: white; border-radius: 8px; padding: 12px 16px; min-width: 100px; text-align: center;">
                                                <div style="font-size: 11px; color: #BFDBFE; margin-bottom: 4px;">GAS</div>
                                                <div style="font-size: 18px; font-weight: 700;">${escapeHtml(gas.fraction)}</div>
                                                ${gas.decimal ? `<div style="font-size: 11px; color: #BFDBFE;">(${gas.decimal})</div>` : ''}
                                            </div>` : ''}
                                        ${otherMinerals.fraction ? `
                                            <div style="background: #6B7280; color: white; border-radius: 8px; padding: 12px 16px; min-width: 100px; text-align: center;">
                                                <div style="font-size: 11px; color: #D1D5DB; margin-bottom: 4px;">OTHER</div>
                                                <div style="font-size: 18px; font-weight: 700;">${escapeHtml(otherMinerals.fraction)}</div>
                                                ${otherMinerals.note ? `<div style="font-size: 10px; color: #D1D5DB; margin-top: 4px;">${escapeHtml(otherMinerals.note)}</div>` : ''}
                                            </div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'depth_clause' && typeof value === 'object') {
                            // Special handling for depth_clause object (oil_gas_lease v2 schema)
                            hasVisibleFields = true;
                            const hasClause = value.has_depth_clause;
                            const trigger = value.trigger || '';
                            const depthRetained = value.depth_retained || '';
                            const depthFeet = value.depth_feet;
                            const referencePoint = value.reference_point || '';
                            const source = value.source || '';

                            const bgColor = hasClause ? '#DCFCE7' : '#FEE2E2';
                            const borderColor = hasClause ? '#22C55E' : '#EF4444';
                            const textColor = hasClause ? '#166534' : '#DC2626';
                            const icon = hasClause ? '✓' : '✗';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: ${hasClause ? '10px' : '0'};">
                                            <span style="font-size: 16px;">${icon}</span>
                                            <span style="font-weight: 600; color: ${textColor}; font-size: 14px;">Depth Clause</span>
                                            ${source ? `<span style="font-size: 11px; color: #6B7280; background: white; padding: 2px 6px; border-radius: 3px;">${escapeHtml(source)}</span>` : ''}
                                        </div>
                                        ${hasClause ? `
                                            <div style="font-size: 13px; color: #374151;">
                                                ${trigger ? `<div style="margin-bottom: 4px;"><strong>Trigger:</strong> ${escapeHtml(trigger)}</div>` : ''}
                                                ${depthRetained ? `<div style="margin-bottom: 4px;"><strong>Depth Retained:</strong> ${escapeHtml(depthRetained)}</div>` : ''}
                                                ${depthFeet ? `<div style="margin-bottom: 4px;"><strong>Specific Depth:</strong> ${depthFeet.toLocaleString()} feet</div>` : ''}
                                                ${referencePoint ? `<div><strong>Reference:</strong> ${escapeHtml(referencePoint)}</div>` : ''}
                                            </div>
                                        ` : `<div style="font-size: 13px; color: #DC2626; font-style: italic;">No depth clause - lessee retains all depths</div>`}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'pugh_clause' && typeof value === 'object') {
                            // Special handling for pugh_clause object (oil_gas_lease v2 schema)
                            hasVisibleFields = true;
                            const hasClause = value.has_pugh_clause;
                            const type = value.type || '';
                            const trigger = value.trigger || '';
                            const releases = value.releases || '';
                            const horizontalPugh = value.horizontal_pugh;
                            const verticalPugh = value.vertical_pugh;
                            const unitChangeProvision = value.unit_change_provision || '';
                            const source = value.source || '';

                            const bgColor = hasClause ? '#DCFCE7' : '#FEE2E2';
                            const borderColor = hasClause ? '#22C55E' : '#EF4444';
                            const textColor = hasClause ? '#166534' : '#DC2626';
                            const icon = hasClause ? '✓' : '✗';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: ${hasClause ? '10px' : '0'};">
                                            <span style="font-size: 16px;">${icon}</span>
                                            <span style="font-weight: 600; color: ${textColor}; font-size: 14px;">Pugh Clause</span>
                                            ${source ? `<span style="font-size: 11px; color: #6B7280; background: white; padding: 2px 6px; border-radius: 3px;">${escapeHtml(source)}</span>` : ''}
                                        </div>
                                        ${hasClause ? `
                                            <div style="font-size: 13px; color: #374151;">
                                                ${type ? `<div style="margin-bottom: 4px;"><strong>Type:</strong> ${escapeHtml(type)}</div>` : ''}
                                                ${trigger ? `<div style="margin-bottom: 4px;"><strong>Trigger:</strong> ${escapeHtml(trigger)}</div>` : ''}
                                                ${releases ? `<div style="margin-bottom: 4px;"><strong>Releases:</strong> ${escapeHtml(releases)}</div>` : ''}
                                                <div style="display: flex; gap: 12px; margin-top: 8px;">
                                                    ${horizontalPugh !== undefined ? `<span style="background: ${horizontalPugh ? '#166534' : '#6B7280'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${horizontalPugh ? '✓' : '✗'} Horizontal Pugh</span>` : ''}
                                                    ${verticalPugh !== undefined ? `<span style="background: ${verticalPugh ? '#166534' : '#6B7280'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${verticalPugh ? '✓' : '✗'} Vertical Pugh</span>` : ''}
                                                </div>
                                                ${unitChangeProvision ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid ${borderColor}; font-size: 12px; color: #6B7280;"><strong>Unit Change:</strong> ${escapeHtml(unitChangeProvision)}</div>` : ''}
                                            </div>
                                        ` : `<div style="font-size: 13px; color: #DC2626; font-style: italic;">No Pugh clause - non-pooled acreage NOT automatically released</div>`}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'deductions_clause' && typeof value === 'object') {
                            // Special handling for deductions_clause object (oil_gas_lease v2 schema)
                            hasVisibleFields = true;
                            const hasNoDeductions = value.has_no_deductions_clause;
                            const scope = value.scope || '';
                            const prohibitedDeductions = Array.isArray(value.prohibited_deductions) ? value.prohibited_deductions : [];
                            const exception = value.exception || '';
                            const source = value.source || '';

                            const bgColor = hasNoDeductions ? '#DCFCE7' : '#FEE2E2';
                            const borderColor = hasNoDeductions ? '#22C55E' : '#EF4444';
                            const textColor = hasNoDeductions ? '#166534' : '#DC2626';
                            const icon = hasNoDeductions ? '✓' : '✗';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: ${hasNoDeductions ? '10px' : '0'};">
                                            <span style="font-size: 16px;">${icon}</span>
                                            <span style="font-weight: 600; color: ${textColor}; font-size: 14px;">No-Deductions Clause</span>
                                            ${source ? `<span style="font-size: 11px; color: #6B7280; background: white; padding: 2px 6px; border-radius: 3px;">${escapeHtml(source)}</span>` : ''}
                                        </div>
                                        ${hasNoDeductions ? `
                                            <div style="font-size: 13px; color: #374151;">
                                                ${scope ? `<div style="margin-bottom: 6px;"><strong>Scope:</strong> ${escapeHtml(scope)}</div>` : ''}
                                                ${prohibitedDeductions.length > 0 ? `
                                                    <div style="margin-bottom: 6px;"><strong>Prohibited:</strong></div>
                                                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                        ${prohibitedDeductions.map(d => `<span style="background: #FEE2E2; border: 1px solid #EF4444; color: #DC2626; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${escapeHtml(String(d))}</span>`).join('')}
                                                    </div>
                                                ` : ''}
                                                ${exception ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid ${borderColor}; font-size: 12px; color: #6B7280;"><strong>Exception:</strong> ${escapeHtml(exception)}</div>` : ''}
                                            </div>
                                        ` : `<div style="font-size: 13px; color: #DC2626; font-style: italic;">No no-deductions clause - post-production costs may be deducted from royalty</div>`}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'shut_in_provisions' && typeof value === 'object') {
                            // Special handling for shut_in_provisions object (oil_gas_lease v2 schema)
                            hasVisibleFields = true;
                            const shutInRoyalty = value.shut_in_royalty || '';
                            const perAcre = value.shut_in_royalty_per_acre;
                            const triggerDays = value.trigger_period_days;
                            const frequency = value.payment_frequency || '';
                            const limitation = value.limitation || {};
                            const hasLimitation = limitation.has_limitation;
                            const maxYears = limitation.max_consecutive_years;
                            const source = limitation.source || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Shut-In Provisions</label>
                                    <div style="background: #F9FAFB; border: 1px solid #D1D5DB; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px; margin-bottom: 10px;">
                                            ${shutInRoyalty ? `<div><span style="color: #6B7280;">Amount:</span> <strong>${escapeHtml(shutInRoyalty)}</strong></div>` : ''}
                                            ${perAcre ? `<div><span style="color: #6B7280;">Per Acre:</span> <strong>$${perAcre}</strong></div>` : ''}
                                            ${triggerDays ? `<div><span style="color: #6B7280;">Trigger:</span> <strong>${triggerDays} days</strong></div>` : ''}
                                            ${frequency ? `<div><span style="color: #6B7280;">Payment:</span> <strong>${escapeHtml(frequency)}</strong></div>` : ''}
                                        </div>
                                        ${hasLimitation !== undefined ? `
                                            <div style="background: ${hasLimitation ? '#DCFCE7' : '#FEE2E2'}; border: 1px solid ${hasLimitation ? '#22C55E' : '#EF4444'}; border-radius: 6px; padding: 10px; margin-top: 8px;">
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <span style="font-size: 14px;">${hasLimitation ? '✓' : '✗'}</span>
                                                    <span style="font-weight: 600; color: ${hasLimitation ? '#166534' : '#DC2626'}; font-size: 13px;">
                                                        ${hasLimitation ? `Shut-In Limited to ${maxYears} consecutive year${maxYears > 1 ? 's' : ''}` : 'No shut-in limitation - lessee can hold indefinitely'}
                                                    </span>
                                                    ${source ? `<span style="font-size: 11px; color: #6B7280; background: white; padding: 2px 6px; border-radius: 3px;">${escapeHtml(source)}</span>` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'exhibit_a' && typeof value === 'object') {
                            // Special handling for exhibit_a object (oil_gas_lease v2 schema)
                            hasVisibleFields = true;
                            const hasExhibitA = value.has_exhibit_a;
                            const provisions = Array.isArray(value.provisions) ? value.provisions : [];
                            const controlsOver = value.controls_over_printed_form;
                            const additionalTerms = value.additional_terms || '';

                            const bgColor = hasExhibitA ? '#DBEAFE' : '#F3F4F6';
                            const borderColor = hasExhibitA ? '#3B82F6' : '#D1D5DB';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: ${hasExhibitA && provisions.length > 0 ? '10px' : '0'};">
                                            <span style="font-size: 16px;">${hasExhibitA ? '📋' : '—'}</span>
                                            <span style="font-weight: 600; color: ${hasExhibitA ? '#1E40AF' : '#6B7280'}; font-size: 14px;">
                                                ${hasExhibitA ? 'Exhibit A / Addendum' : 'No Exhibit A'}
                                            </span>
                                            ${controlsOver ? `<span style="background: #3B82F6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">Controls Over Printed Form</span>` : ''}
                                        </div>
                                        ${provisions.length > 0 ? `
                                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                                ${provisions.map(p => `<span style="background: white; border: 1px solid #3B82F6; color: #1E40AF; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500;">${escapeHtml(String(p))}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                        ${additionalTerms ? `<div style="font-size: 12px; color: #6B7280; margin-top: 8px;">${escapeHtml(additionalTerms)}</div>` : ''}
                                        ${!hasExhibitA ? `<div style="font-size: 13px; color: #6B7280; font-style: italic;">Standard printed form only - no protective addendum</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'pooling_provisions' && typeof value === 'object' && data.doc_type === 'oil_gas_lease') {
                            // Special handling for pooling_provisions in oil_gas_lease (different from pooling order)
                            hasVisibleFields = true;
                            const hasRights = value.lessee_has_pooling_rights;
                            const poolingType = value.pooling_type || '';
                            const verticalOil = value.vertical_oil_well || {};
                            const gasHorizontal = value.gas_or_horizontal_well || {};
                            const govOverride = value.governmental_override;
                            const allocationMethod = value.allocation_method || '';
                            const pughLimits = value.pugh_clause_limits_pooling;
                            const antiPugh = value.anti_pugh_language;
                            const antiPughText = value.anti_pugh_text || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Pooling Provisions</label>
                                    <div style="background: #F9FAFB; border: 1px solid #D1D5DB; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px;">
                                            ${hasRights !== undefined ? `<span style="background: ${hasRights ? '#DCFCE7' : '#FEE2E2'}; color: ${hasRights ? '#166534' : '#DC2626'}; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                                ${hasRights ? '✓ Lessee Has Pooling Rights' : '✗ No Lessee Pooling Rights'}
                                            </span>` : ''}
                                            ${poolingType ? `<span style="background: #E5E7EB; color: #374151; padding: 4px 10px; border-radius: 4px; font-size: 12px;">${escapeHtml(poolingType)}</span>` : ''}
                                        </div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px; margin-bottom: 12px;">
                                            ${verticalOil.max_acres ? `<div><strong>Vertical/Oil:</strong> ${verticalOil.max_acres} acres max${verticalOil.tolerance ? ` (${verticalOil.tolerance} tolerance)` : ''}</div>` : ''}
                                            ${gasHorizontal.max_acres ? `<div><strong>Gas/Horizontal:</strong> ${gasHorizontal.max_acres} acres max${gasHorizontal.tolerance ? ` (${gasHorizontal.tolerance} tolerance)` : ''}</div>` : ''}
                                            ${allocationMethod ? `<div><strong>Allocation:</strong> ${escapeHtml(allocationMethod)}</div>` : ''}
                                            ${govOverride !== undefined ? `<div><strong>Govt Override:</strong> ${govOverride ? 'Yes' : 'No'}</div>` : ''}
                                        </div>
                                        ${antiPugh ? `
                                            <div style="background: #FEE2E2; border: 1px solid #EF4444; border-radius: 6px; padding: 10px; margin-top: 8px;">
                                                <div style="font-weight: 600; color: #DC2626; font-size: 13px; margin-bottom: 4px;">⚠️ Anti-Pugh Language Detected</div>
                                                ${antiPughText ? `<div style="font-size: 12px; color: #7F1D1D; font-style: italic;">"${escapeHtml(antiPughText)}"</div>` : ''}
                                            </div>
                                        ` : ''}
                                        ${pughLimits ? `
                                            <div style="background: #DCFCE7; border: 1px solid #22C55E; border-radius: 6px; padding: 10px; margin-top: 8px;">
                                                <span style="color: #166534; font-size: 13px;">✓ Pugh Clause Limits Pooling Effect</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'assignor' && typeof value === 'object' && data.doc_type === 'trust_funding') {
                            // Special handling for assignor object (trust_funding schema)
                            hasVisibleFields = true;
                            const name = value.name || '';
                            const address = value.address || '';
                            const capacity = value.capacity || 'Individual';
                            const signatory = value.signatory || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Assignor (Transferring Party)</label>
                                    <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                            <span style="font-weight: 600; color: #92400E; font-size: 15px;">${escapeHtml(name)}</span>
                                            <span style="background: #FDE68A; color: #92400E; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">${escapeHtml(capacity)}</span>
                                        </div>
                                        ${address ? `<div style="font-size: 13px; color: #6B7280; margin-top: 6px;">${escapeHtml(address)}</div>` : ''}
                                        ${signatory && signatory !== name ? `<div style="font-size: 12px; color: #4B5563; margin-top: 6px; border-top: 1px solid #F59E0B; padding-top: 6px;">
                                            <strong>Signed by:</strong> ${escapeHtml(signatory)}
                                        </div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'assignee' && typeof value === 'object' && data.doc_type === 'trust_funding') {
                            // Special handling for assignee object (trust_funding schema)
                            hasVisibleFields = true;
                            const name = value.name || '';
                            const address = value.address || '';
                            const capacity = value.capacity || 'Trustee';
                            const trustName = value.trust_name || '';
                            const trustDate = value.trust_date || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Assignee (Receiving Party)</label>
                                    <div style="background: #DBEAFE; border: 1px solid #3B82F6; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                            <span style="font-weight: 600; color: #1E40AF; font-size: 15px;">${escapeHtml(name)}</span>
                                            <span style="background: #BFDBFE; color: #1E40AF; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">${escapeHtml(capacity)}</span>
                                        </div>
                                        ${trustName ? `
                                            <div style="background: #EFF6FF; border-radius: 6px; padding: 10px; margin-top: 10px;">
                                                <div style="font-weight: 600; color: #1E40AF; font-size: 14px;">${escapeHtml(trustName)}</div>
                                                ${trustDate ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Trust Created: ${escapeHtml(trustDate)}</div>` : ''}
                                            </div>
                                        ` : ''}
                                        ${address ? `<div style="font-size: 13px; color: #6B7280; margin-top: 6px;">${escapeHtml(address)}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'property_categories' && typeof value === 'object' && data.doc_type === 'trust_funding') {
                            // Special handling for property_categories object (trust_funding schema)
                            hasVisibleFields = true;
                            const categories = [
                                { key: 'mineral_interests', label: 'Mineral Interests', important: true },
                                { key: 'real_property', label: 'Real Property', important: false },
                                { key: 'personal_effects', label: 'Personal Effects', important: false },
                                { key: 'household_goods', label: 'Household Goods', important: false },
                                { key: 'financial_accounts', label: 'Financial Accounts', important: false },
                                { key: 'vehicles', label: 'Vehicles', important: false },
                                { key: 'other_property', label: 'Other Property', important: false }
                            ];

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Property Categories Included</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${categories.map(cat => {
                                            const included = value[cat.key];
                                            if (included === undefined) return '';
                                            const bgColor = included ? (cat.important ? '#DCFCE7' : '#F3F4F6') : '#FEE2E2';
                                            const textColor = included ? (cat.important ? '#166534' : '#374151') : '#DC2626';
                                            const borderColor = included ? (cat.important ? '#22C55E' : '#D1D5DB') : '#EF4444';
                                            const icon = included ? '✓' : '✗';
                                            return `<span style="background: ${bgColor}; color: ${textColor}; border: 1px solid ${borderColor}; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: ${cat.important && included ? '600' : '400'};">
                                                ${icon} ${cat.label}
                                            </span>`;
                                        }).join('')}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'mineral_interests' && typeof value === 'object' && data.doc_type === 'trust_funding') {
                            // Special handling for mineral_interests object (trust_funding schema)
                            hasVisibleFields = true;
                            const description = value.description || '';
                            const typesIncluded = value.types_included || [];
                            const geographicScope = value.geographic_scope || '';
                            const depthLimitation = value.depth_limitation || '';
                            const formationLimitation = value.formation_limitation || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Mineral Interests Coverage</label>
                                    <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 8px; padding: 14px;">
                                        ${description ? `<div style="font-size: 13px; color: #374151; font-style: italic; margin-bottom: 10px;">"${escapeHtml(description)}"</div>` : ''}
                                        ${typesIncluded.length > 0 ? `
                                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                                                ${typesIncluded.map(type => `<span style="background: #166534; color: white; padding: 3px 10px; border-radius: 4px; font-size: 11px; font-weight: 500;">${escapeHtml(type)}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                        <div style="font-size: 13px; color: #374151;">
                                            ${geographicScope ? `<div><strong>Geographic Scope:</strong> ${escapeHtml(geographicScope)}</div>` : ''}
                                            ${depthLimitation ? `<div><strong>Depth Limitation:</strong> ${escapeHtml(depthLimitation)}</div>` : ''}
                                            ${formationLimitation ? `<div><strong>Formation Limitation:</strong> ${escapeHtml(formationLimitation)}</div>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'specific_properties' && Array.isArray(value) && data.doc_type === 'trust_funding') {
                            // Special handling for specific_properties array (trust_funding schema)
                            if (value.length > 0) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Specific Properties Mentioned</label>
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            ${value.map(prop => {
                                                const propertyName = prop.property_name || '';
                                                const source = prop.source || '';
                                                const legal = prop.legal_description || {};
                                                const interestType = prop.interest_type || '';
                                                const notes = prop.notes || '';

                                                const isHandwritten = source === 'handwritten';
                                                const bgColor = isHandwritten ? '#FEF9C3' : '#F9FAFB';
                                                const borderColor = isHandwritten ? '#EAB308' : '#D1D5DB';

                                                let locationStr = '';
                                                if (legal.section) locationStr += 'S' + legal.section;
                                                if (legal.township) locationStr += '-' + legal.township;
                                                if (legal.range) locationStr += '-' + legal.range;
                                                if (legal.county) locationStr += ', ' + legal.county + ' County';

                                                return `
                                                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 6px; padding: 12px;">
                                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                                            ${propertyName ? `<span style="font-weight: 600; color: #374151;">${escapeHtml(propertyName)}</span>` : ''}
                                                            ${isHandwritten ? `<span style="background: #FDE68A; color: #92400E; padding: 2px 6px; border-radius: 3px; font-size: 10px;">✎ Handwritten</span>` : ''}
                                                            ${source && !isHandwritten ? `<span style="background: #E5E7EB; color: #6B7280; padding: 2px 6px; border-radius: 3px; font-size: 10px;">${escapeHtml(source)}</span>` : ''}
                                                            ${interestType ? `<span style="background: #DBEAFE; color: #1E40AF; padding: 2px 6px; border-radius: 3px; font-size: 10px;">${escapeHtml(interestType)}</span>` : ''}
                                                        </div>
                                                        ${locationStr ? `<div style="font-size: 13px; color: #374151; margin-top: 6px;">${escapeHtml(locationStr)}</div>` : ''}
                                                        ${notes ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px; font-style: italic;">${escapeHtml(notes)}</div>` : ''}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'acceptance' && typeof value === 'object' && data.doc_type === 'trust_funding') {
                            // Special handling for acceptance object (trust_funding schema)
                            hasVisibleFields = true;
                            const trusteeAccepted = value.trustee_accepted;
                            const acceptanceDate = value.acceptance_date || '';
                            const acceptedBy = value.accepted_by || '';
                            const capacity = value.capacity || '';

                            const bgColor = trusteeAccepted ? '#DCFCE7' : '#FEE2E2';
                            const borderColor = trusteeAccepted ? '#22C55E' : '#EF4444';
                            const textColor = trusteeAccepted ? '#166534' : '#DC2626';
                            const icon = trusteeAccepted ? '✓' : '✗';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Trustee Acceptance</label>
                                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: ${trusteeAccepted && (acceptedBy || acceptanceDate) ? '10px' : '0'};">
                                            <span style="font-size: 16px;">${icon}</span>
                                            <span style="font-weight: 600; color: ${textColor}; font-size: 14px;">
                                                ${trusteeAccepted ? 'Trustee Accepted Assignment' : 'Trustee Acceptance Missing'}
                                            </span>
                                        </div>
                                        ${trusteeAccepted ? `
                                            <div style="font-size: 13px; color: #374151;">
                                                ${acceptedBy ? `<div><strong>Accepted by:</strong> ${escapeHtml(acceptedBy)}${capacity ? ` (${escapeHtml(capacity)})` : ''}</div>` : ''}
                                                ${acceptanceDate ? `<div><strong>Date:</strong> ${escapeHtml(acceptanceDate)}</div>` : ''}
                                            </div>
                                        ` : `<div style="font-size: 13px; color: #DC2626; font-style: italic;">Note: Missing trustee acceptance may affect document validity</div>`}
                                    </div>
                                </div>`;
                        } else if ((fieldName === 'is_blanket_assignment' || fieldName === 'includes_future_acquired' || fieldName === 'includes_mineral_interests') && data.doc_type === 'trust_funding') {
                            // Special handling for trust_funding assignment flags
                            hasVisibleFields = true;
                            const flagLabels = {
                                'is_blanket_assignment': { label: 'Blanket Assignment', trueText: 'All Property', falseText: 'Specific Only' },
                                'includes_future_acquired': { label: 'Future-Acquired Property', trueText: 'Included', falseText: 'Not Included' },
                                'includes_mineral_interests': { label: 'Mineral Interests', trueText: 'Included', falseText: 'Not Included' }
                            };
                            const config = flagLabels[fieldName];
                            const bgColor = value ? '#DCFCE7' : '#FEE2E2';
                            const borderColor = value ? '#22C55E' : '#EF4444';
                            const textColor = value ? '#166534' : '#DC2626';
                            const icon = value ? '✓' : '✗';
                            const displayText = value ? config.trueText : config.falseText;
                            const isImportant = fieldName === 'includes_mineral_interests' && value;

                            sectionContent += `
                                <div class="doc-field">
                                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 6px; padding: 10px 14px; text-align: center;">
                                        <div style="font-size: 11px; color: #6B7280; margin-bottom: 4px;">${config.label}</div>
                                        <div style="font-weight: ${isImportant ? '700' : '600'}; color: ${textColor}; font-size: 14px;">
                                            ${icon} ${displayText}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'entity_info' && typeof value === 'object' && data.doc_type === 'limited_partnership') {
                            // Special handling for entity_info object (limited_partnership schema)
                            hasVisibleFields = true;
                            const name = value.name || '';
                            const formationDate = value.formation_date || '';
                            const governingLaw = value.governing_law || '';
                            const jurisdiction = value.jurisdiction || '';
                            const filedWith = value.filed_with || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Partnership Entity</label>
                                    <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 8px; padding: 14px;">
                                        ${name ? `<div style="font-size: 18px; font-weight: 700; color: #1E40AF; margin-bottom: 8px;">${escapeHtml(name)}</div>` : ''}
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; font-size: 13px;">
                                            ${formationDate ? `<div><span style="color: #6B7280;">Formation Date:</span> <strong>${escapeHtml(formationDate)}</strong></div>` : ''}
                                            ${jurisdiction ? `<div><span style="color: #6B7280;">Jurisdiction:</span> <strong>${escapeHtml(jurisdiction)}</strong></div>` : ''}
                                            ${governingLaw ? `<div><span style="color: #6B7280;">Governing Law:</span> <strong>${escapeHtml(governingLaw)}</strong></div>` : ''}
                                            ${filedWith ? `<div><span style="color: #6B7280;">Filed With:</span> <strong>${escapeHtml(filedWith)}</strong></div>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'term' && typeof value === 'object' && data.doc_type === 'limited_partnership') {
                            // Special handling for term object (limited_partnership schema)
                            hasVisibleFields = true;
                            const durationType = value.duration_type || '';
                            const years = value.years;
                            const expirationDate = value.expiration_date || '';
                            const isPerpetual = durationType === 'perpetual';
                            const bgColor = isPerpetual ? '#FEF3C7' : '#F3F4F6';
                            const borderColor = isPerpetual ? '#F59E0B' : '#D1D5DB';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Partnership Term</label>
                                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
                                            ${durationType ? `<div><span style="color: #6B7280;">Duration:</span> <strong style="font-size: 15px; text-transform: capitalize;">${escapeHtml(durationType)}</strong></div>` : ''}
                                            ${years ? `<div><span style="color: #6B7280;">Term:</span> <strong style="font-size: 15px;">${years} years</strong></div>` : ''}
                                            ${expirationDate ? `<div><span style="color: #6B7280;">Expires:</span> <strong style="font-size: 15px;">${escapeHtml(expirationDate)}</strong></div>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'principal_office' && typeof value === 'object' && data.doc_type === 'limited_partnership') {
                            // Special handling for principal_office object (limited_partnership schema)
                            hasVisibleFields = true;
                            const city = value.city || '';
                            const state = value.state || '';
                            const registeredAgent = value.registered_agent || '';
                            const registeredAgentAddress = value.registered_agent_address || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Principal Office</label>
                                    <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px; padding: 14px;">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 13px;">
                                            ${city || state ? `<div><span style="color: #6B7280;">Location:</span> <strong>${city ? escapeHtml(city) : ''}${city && state ? ', ' : ''}${state ? escapeHtml(state) : ''}</strong></div>` : ''}
                                            ${registeredAgent ? `<div><span style="color: #6B7280;">Registered Agent:</span> <strong>${escapeHtml(registeredAgent)}</strong></div>` : ''}
                                            ${registeredAgentAddress ? `<div style="grid-column: 1 / -1;"><span style="color: #6B7280;">Agent Address:</span> <strong>${escapeHtml(registeredAgentAddress)}</strong></div>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'general_partners' && Array.isArray(value) && data.doc_type === 'limited_partnership') {
                            // Special handling for general_partners array (limited_partnership schema)
                            if (value.length > 0) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>General Partners (${value.length})</label>
                                        <div style="display: flex; flex-direction: column; gap: 10px;">`;
                                value.forEach(partner => {
                                    const name = partner.name || '';
                                    const address = partner.address || '';
                                    const interestFraction = partner.interest_fraction || '';
                                    const interestDecimal = partner.interest_decimal;
                                    const capacity = partner.capacity || '';
                                    const contribution = partner.capital_contribution || '';

                                    sectionContent += `
                                        <div style="background: #DBEAFE; border: 1px solid #3B82F6; border-radius: 8px; padding: 12px;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; flex-wrap: wrap;">
                                                <div style="flex: 1; min-width: 200px;">
                                                    <div style="font-weight: 600; color: #1E40AF; font-size: 15px;">${escapeHtml(name)}</div>
                                                    ${capacity ? `<div style="font-size: 12px; color: #3B82F6; margin-top: 2px;">${escapeHtml(capacity)}</div>` : ''}
                                                    ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(address)}</div>` : ''}
                                                </div>
                                                <div style="text-align: right;">
                                                    ${interestFraction ? `<div style="font-weight: 700; color: #1E40AF; font-size: 16px;">${escapeHtml(interestFraction)}</div>` : ''}
                                                    ${interestDecimal !== undefined && interestDecimal !== null ? `<div style="font-size: 12px; color: #6B7280;">(${(interestDecimal * 100).toFixed(4)}%)</div>` : ''}
                                                    ${contribution ? `<div style="font-size: 12px; color: #059669; margin-top: 4px;">Contribution: ${escapeHtml(contribution)}</div>` : ''}
                                                </div>
                                            </div>
                                        </div>`;
                                });
                                sectionContent += `</div></div>`;
                            }
                        } else if (fieldName === 'limited_partners' && Array.isArray(value) && data.doc_type === 'limited_partnership') {
                            // Special handling for limited_partners array (limited_partnership schema)
                            if (value.length > 0) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Limited Partners (${value.length})</label>
                                        <div style="display: flex; flex-direction: column; gap: 10px;">`;
                                value.forEach(partner => {
                                    const name = partner.name || '';
                                    const address = partner.address || '';
                                    const interestFraction = partner.interest_fraction || '';
                                    const interestDecimal = partner.interest_decimal;
                                    const capacity = partner.capacity || '';
                                    const custodianFor = partner.custodian_for || '';
                                    const contribution = partner.capital_contribution || '';

                                    // Different background if acting as custodian
                                    const bgColor = custodianFor ? '#FEF3C7' : '#F0FDF4';
                                    const borderColor = custodianFor ? '#F59E0B' : '#22C55E';
                                    const nameColor = custodianFor ? '#92400E' : '#166534';

                                    sectionContent += `
                                        <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 12px;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; flex-wrap: wrap;">
                                                <div style="flex: 1; min-width: 200px;">
                                                    <div style="font-weight: 600; color: ${nameColor}; font-size: 15px;">${escapeHtml(name)}</div>
                                                    ${capacity ? `<div style="font-size: 12px; color: #6B7280; margin-top: 2px;">${escapeHtml(capacity)}</div>` : ''}
                                                    ${custodianFor ? `<div style="font-size: 12px; color: #B45309; margin-top: 2px; font-weight: 500;">Custodian for: ${escapeHtml(custodianFor)}</div>` : ''}
                                                    ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(address)}</div>` : ''}
                                                </div>
                                                <div style="text-align: right;">
                                                    ${interestFraction ? `<div style="font-weight: 700; color: ${nameColor}; font-size: 16px;">${escapeHtml(interestFraction)}</div>` : ''}
                                                    ${interestDecimal !== undefined && interestDecimal !== null ? `<div style="font-size: 12px; color: #6B7280;">(${(interestDecimal * 100).toFixed(4)}%)</div>` : ''}
                                                    ${contribution ? `<div style="font-size: 12px; color: #059669; margin-top: 4px;">Contribution: ${escapeHtml(contribution)}</div>` : ''}
                                                </div>
                                            </div>
                                        </div>`;
                                });
                                sectionContent += `</div></div>`;
                            }
                        } else if (fieldName === 'succession_provisions' && typeof value === 'object' && data.doc_type === 'limited_partnership') {
                            // Special handling for succession_provisions object (limited_partnership schema)
                            hasVisibleFields = true;
                            const survives = value.survives_death_of_gp;
                            const converts = value.gp_interest_converts_to_lp_on_death;
                            const language = value.succession_language || '';

                            // This is critical info for chain of title
                            const bgColor = converts ? '#FEF3C7' : '#F3F4F6';
                            const borderColor = converts ? '#F59E0B' : '#D1D5DB';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Succession Provisions</label>
                                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: ${language ? '10px' : '0'};">
                                            ${survives !== undefined ? `
                                                <div style="background: ${survives ? '#DCFCE7' : '#FEE2E2'}; border-radius: 6px; padding: 8px 14px;">
                                                    <div style="font-size: 11px; color: #6B7280;">Survives GP Death</div>
                                                    <div style="font-weight: 600; color: ${survives ? '#166534' : '#DC2626'};">${survives ? '✓ Yes' : '✗ No'}</div>
                                                </div>` : ''}
                                            ${converts !== undefined ? `
                                                <div style="background: ${converts ? '#FEF3C7' : '#F3F4F6'}; border-radius: 6px; padding: 8px 14px;">
                                                    <div style="font-size: 11px; color: #6B7280;">GP Interest → LP on Death</div>
                                                    <div style="font-weight: 600; color: ${converts ? '#92400E' : '#374151'};">${converts ? '✓ Converts' : '✗ Does Not Convert'}</div>
                                                </div>` : ''}
                                        </div>
                                        ${language ? `<div style="font-size: 13px; color: #374151; font-style: italic; border-top: 1px solid #E5E7EB; padding-top: 10px;">"${escapeHtml(language)}"</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'assignment_provisions' && typeof value === 'object' && data.doc_type === 'limited_partnership') {
                            // Special handling for assignment_provisions object (limited_partnership schema)
                            hasVisibleFields = true;
                            const familyRequired = value.family_relationship_required;
                            const writtenConsent = value.requires_written_consent;
                            const language = value.general_language || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Assignment Restrictions</label>
                                    <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: ${language ? '10px' : '0'};">
                                            ${familyRequired !== undefined ? `
                                                <div style="background: ${familyRequired ? '#FEE2E2' : '#DCFCE7'}; border-radius: 6px; padding: 8px 14px;">
                                                    <div style="font-size: 11px; color: #6B7280;">Family Relationship Required</div>
                                                    <div style="font-weight: 600; color: ${familyRequired ? '#DC2626' : '#166534'};">${familyRequired ? '✓ Yes - Restricted' : '✗ Not Required'}</div>
                                                </div>` : ''}
                                            ${writtenConsent !== undefined ? `
                                                <div style="background: ${writtenConsent ? '#FEF3C7' : '#F3F4F6'}; border-radius: 6px; padding: 8px 14px;">
                                                    <div style="font-size: 11px; color: #6B7280;">Written Consent Required</div>
                                                    <div style="font-weight: 600; color: ${writtenConsent ? '#92400E' : '#374151'};">${writtenConsent ? '✓ Required' : '✗ Not Required'}</div>
                                                </div>` : ''}
                                        </div>
                                        ${language ? `<div style="font-size: 13px; color: #374151; font-style: italic; border-top: 1px solid #E5E7EB; padding-top: 10px;">"${escapeHtml(language)}"</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'management_provisions' && typeof value === 'object' && data.doc_type === 'limited_partnership') {
                            // Special handling for management_provisions object (limited_partnership schema)
                            hasVisibleFields = true;
                            const lpCanParticipate = value.lp_can_participate_in_management;
                            const gpAuthority = value.gp_authority || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Management Provisions</label>
                                    <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 16px;">
                                            ${lpCanParticipate !== undefined ? `
                                                <div style="background: ${lpCanParticipate ? '#FEF3C7' : '#DCFCE7'}; border-radius: 6px; padding: 8px 14px;">
                                                    <div style="font-size: 11px; color: #6B7280;">LP Can Participate in Management</div>
                                                    <div style="font-weight: 600; color: ${lpCanParticipate ? '#92400E' : '#166534'};">${lpCanParticipate ? '✓ Yes - May Affect LP Status' : '✗ No - Limited Partner Protected'}</div>
                                                </div>` : ''}
                                            ${gpAuthority ? `
                                                <div style="flex: 1; min-width: 200px;">
                                                    <div style="font-size: 11px; color: #6B7280; margin-bottom: 4px;">GP Authority</div>
                                                    <div style="font-size: 13px; color: #374151;">${escapeHtml(gpAuthority)}</div>
                                                </div>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'dissolution_provisions' && typeof value === 'object' && data.doc_type === 'limited_partnership') {
                            // Special handling for dissolution_provisions object (limited_partnership schema)
                            hasVisibleFields = true;
                            const triggers = value.triggers || [];

                            if (triggers.length > 0) {
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Dissolution Triggers</label>
                                        <div style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 8px; padding: 14px;">
                                            <ul style="margin: 0; padding-left: 20px; color: #991B1B;">
                                                ${triggers.map(t => `<li style="margin-bottom: 4px;">${escapeHtml(t)}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'interest_assigned' && typeof value === 'object' && data.doc_type === 'assignment_of_lease') {
                            // Special handling for interest_assigned object (assignment_of_lease schema)
                            hasVisibleFields = true;
                            const type = value.type || '';
                            const fraction = value.fraction || '';
                            const decimal = value.decimal;
                            const description = value.description || '';
                            const depths = value.depths || '';
                            const formations = value.formations || [];
                            const acres = value.acres;

                            const isPartial = type === 'partial' || (depths || formations.length > 0);
                            const bgColor = isPartial ? '#FEF3C7' : '#EFF6FF';
                            const borderColor = isPartial ? '#F59E0B' : '#3B82F6';
                            const textColor = isPartial ? '#92400E' : '#1E40AF';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Interest Assigned</label>
                                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px;">
                                            <div>
                                                ${type ? `<div style="font-weight: 600; color: ${textColor}; font-size: 15px; text-transform: uppercase;">${escapeHtml(type)} INTEREST</div>` : ''}
                                                ${description ? `<div style="font-size: 13px; color: #374151; margin-top: 6px; font-style: italic;">"${escapeHtml(description)}"</div>` : ''}
                                            </div>
                                            <div style="text-align: right;">
                                                ${fraction ? `<div style="font-weight: 700; color: ${textColor}; font-size: 18px;">${escapeHtml(fraction)}</div>` : ''}
                                                ${decimal !== undefined && decimal !== null ? `<div style="font-size: 12px; color: #6B7280;">(${(decimal * 100).toFixed(4)}%)</div>` : ''}
                                                ${acres ? `<div style="font-size: 12px; color: #059669; margin-top: 4px;">${acres} acres</div>` : ''}
                                            </div>
                                        </div>
                                        ${depths ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid ${borderColor};"><span style="color: #6B7280; font-size: 12px;">Depth Limitation:</span> <strong style="color: ${textColor};">${escapeHtml(depths)}</strong></div>` : ''}
                                        ${formations.length > 0 ? `<div style="margin-top: 6px;"><span style="color: #6B7280; font-size: 12px;">Formations:</span> <strong style="color: ${textColor};">${formations.map(f => escapeHtml(f)).join(', ')}</strong></div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'retained_interests' && typeof value === 'object' && data.doc_type === 'assignment_of_lease') {
                            // Special handling for retained_interests object (assignment_of_lease schema)
                            hasVisibleFields = true;
                            const hasRetained = value.has_retained_interest;
                            const orri = value.overriding_royalty || {};
                            const orriFraction = orri.fraction || '';
                            const orriDecimal = orri.decimal;
                            const orriPayableOutOf = orri.payable_out_of || '';
                            const description = value.description || '';

                            if (hasRetained) {
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Retained Interests</label>
                                        <div style="background: #FEE2E2; border: 1px solid #EF4444; border-radius: 8px; padding: 14px;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                <span style="background: #EF4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">ORRI RETAINED</span>
                                            </div>
                                            ${orriFraction ? `
                                                <div style="display: flex; align-items: baseline; gap: 8px;">
                                                    <span style="font-weight: 700; color: #DC2626; font-size: 18px;">${escapeHtml(orriFraction)}</span>
                                                    ${orriDecimal !== undefined ? `<span style="font-size: 12px; color: #6B7280;">(${(orriDecimal * 100).toFixed(4)}%)</span>` : ''}
                                                    ${orriPayableOutOf ? `<span style="font-size: 12px; color: #6B7280;">of ${escapeHtml(orriPayableOutOf.replace(/_/g, ' '))}</span>` : ''}
                                                </div>
                                            ` : ''}
                                            ${description ? `<div style="font-size: 13px; color: #374151; margin-top: 8px; font-style: italic;">"${escapeHtml(description)}"</div>` : ''}
                                        </div>
                                    </div>`;
                            } else {
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Retained Interests</label>
                                        <div style="background: #DCFCE7; border: 1px solid #22C55E; border-radius: 8px; padding: 14px;">
                                            <span style="color: #166534; font-weight: 500;">✓ No interests retained - full assignment</span>
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'subject_to' && typeof value === 'object' && data.doc_type === 'assignment_of_lease') {
                            // Special handling for subject_to object (assignment_of_lease schema)
                            if (value.has_subject_to_clause) {
                                hasVisibleFields = true;
                                const existingRoyalties = value.existing_royalties;
                                const existingOverrides = value.existing_overrides;
                                const existingBurdens = value.existing_burdens || [];
                                const burdensDescription = value.burdens_description || '';

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Subject To</label>
                                        <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 14px;">
                                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: ${burdensDescription ? '10px' : '0'};">
                                                ${existingRoyalties ? `<span style="background: #FEF3C7; border: 1px solid #D97706; border-radius: 4px; padding: 4px 8px; font-size: 12px; color: #92400E;">Lessor's Royalty</span>` : ''}
                                                ${existingOverrides ? `<span style="background: #FEF3C7; border: 1px solid #D97706; border-radius: 4px; padding: 4px 8px; font-size: 12px; color: #92400E;">Existing ORRIs</span>` : ''}
                                                ${existingBurdens.map(b => `<span style="background: #FEF3C7; border: 1px solid #D97706; border-radius: 4px; padding: 4px 8px; font-size: 12px; color: #92400E;">${escapeHtml(b)}</span>`).join('')}
                                            </div>
                                            ${burdensDescription ? `<div style="font-size: 13px; color: #374151; font-style: italic;">"${escapeHtml(burdensDescription)}"</div>` : ''}
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'underlying_lease' && typeof value === 'object' && data.doc_type === 'assignment_of_lease') {
                            // Special handling for underlying_lease object (assignment_of_lease schema)
                            hasVisibleFields = true;
                            const leaseDate = value.lease_date || '';
                            const lessor = value.lessor || {};
                            const lessorName = lessor.name || '';
                            const lessorCapacity = lessor.capacity || '';
                            const originalLessee = value.original_lessee || {};
                            const lesseeName = originalLessee.name || '';
                            const recordingInfo = value.recording_info || {};
                            const book = recordingInfo.book || '';
                            const page = recordingInfo.page || '';
                            const recordingDate = recordingInfo.recording_date || '';
                            const recordingCounty = recordingInfo.county || '';
                            const leaseDescription = value.lease_description || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Underlying Lease</label>
                                    <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 8px; padding: 14px;">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                            ${leaseDate ? `<div><span style="color: #6B7280; font-size: 12px;">Lease Date:</span><br><strong style="color: #1E40AF;">${escapeHtml(leaseDate)}</strong></div>` : ''}
                                            ${lessorName ? `<div><span style="color: #6B7280; font-size: 12px;">Lessor:</span><br><strong style="color: #1E40AF;">${escapeHtml(lessorName)}</strong>${lessorCapacity ? `<br><span style="font-size: 11px; color: #6B7280;">${escapeHtml(lessorCapacity)}</span>` : ''}</div>` : ''}
                                            ${lesseeName ? `<div><span style="color: #6B7280; font-size: 12px;">Original Lessee:</span><br><strong style="color: #1E40AF;">${escapeHtml(lesseeName)}</strong></div>` : ''}
                                        </div>
                                        ${book && page ? `
                                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #93C5FD;">
                                                <span style="color: #6B7280; font-size: 12px;">Recording:</span>
                                                <strong style="color: #1E40AF;"> Book ${escapeHtml(book)}, Page ${escapeHtml(page)}</strong>
                                                ${recordingCounty ? `<span style="color: #6B7280;">, ${escapeHtml(recordingCounty)} County</span>` : ''}
                                                ${recordingDate ? `<span style="color: #6B7280;"> (${escapeHtml(recordingDate)})</span>` : ''}
                                            </div>
                                        ` : ''}
                                        ${leaseDescription ? `<div style="margin-top: 8px; font-size: 13px; color: #374151; font-style: italic;">${escapeHtml(leaseDescription)}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'warranties' && typeof value === 'object' && data.doc_type === 'assignment_of_lease') {
                            // Special handling for warranties object (assignment_of_lease schema)
                            hasVisibleFields = true;
                            const hasWarranty = value.has_warranty;
                            const warrantyType = value.warranty_type || '';
                            const covenants = value.covenants || [];
                            const warrantyLanguage = value.warranty_language || '';

                            const typeColors = {
                                'general': { bg: '#DCFCE7', border: '#22C55E', text: '#166534' },
                                'special': { bg: '#FEF3C7', border: '#F59E0B', text: '#92400E' },
                                'quitclaim': { bg: '#FEE2E2', border: '#EF4444', text: '#DC2626' },
                                'none': { bg: '#F3F4F6', border: '#9CA3AF', text: '#6B7280' }
                            };
                            const colors = typeColors[warrantyType] || typeColors['none'];

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Warranties</label>
                                    <div style="background: ${colors.bg}; border: 1px solid ${colors.border}; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: ${warrantyLanguage || covenants.length ? '10px' : '0'};">
                                            <span style="font-weight: 600; color: ${colors.text}; font-size: 15px; text-transform: uppercase;">${warrantyType ? escapeHtml(warrantyType) : 'No'} Warranty</span>
                                            ${hasWarranty ? `<span style="color: ${colors.text};">✓</span>` : `<span style="color: ${colors.text};">✗</span>`}
                                        </div>
                                        ${covenants.length > 0 ? `
                                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px;">
                                                ${covenants.map(c => `<span style="background: white; border: 1px solid ${colors.border}; border-radius: 4px; padding: 2px 8px; font-size: 11px; color: ${colors.text};">${escapeHtml(c)}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                        ${warrantyLanguage ? `<div style="font-size: 13px; color: #374151; font-style: italic;">"${escapeHtml(warrantyLanguage)}"</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'deed_classification' && typeof value === 'object') {
                            // Special handling for deed_classification object (quit_claim_deed)
                            hasVisibleFields = true;
                            const isCorrection = value.is_correction_deed;
                            const correctionInfo = value.correction_info || {};
                            const correctsDoc = correctionInfo.corrects_document || {};
                            const reason = correctionInfo.reason_for_correction || '';
                            const whatWasWrong = correctionInfo.what_was_wrong || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Deed Classification</label>
                                    <div style="background: ${isCorrection ? '#FEF3C7' : '#F0FDF4'}; border: 1px solid ${isCorrection ? '#F59E0B' : '#22C55E'}; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: ${isCorrection ? '12px' : '0'};">
                                            <span style="font-weight: 600; color: ${isCorrection ? '#92400E' : '#166534'}; font-size: 15px;">
                                                ${isCorrection ? 'CORRECTION DEED' : 'STANDARD QUIT CLAIM DEED'}
                                            </span>
                                            ${isCorrection ? `<span style="color: #92400E;">⚠</span>` : `<span style="color: #166534;">✓</span>`}
                                        </div>
                                        ${isCorrection && (correctsDoc.doc_type || correctsDoc.recording_reference) ? `
                                            <div style="background: white; border: 1px solid #F59E0B; border-radius: 6px; padding: 10px; margin-bottom: 10px;">
                                                <div style="font-size: 11px; color: #92400E; font-weight: 600; margin-bottom: 6px;">CORRECTS PRIOR DOCUMENT</div>
                                                ${correctsDoc.doc_type ? `<div style="color: #374151; text-transform: capitalize;">${escapeHtml(correctsDoc.doc_type.replace(/_/g, ' '))}</div>` : ''}
                                                ${correctsDoc.recording_reference ? `<div style="font-size: 12px; color: #6B7280;">Recorded: ${escapeHtml(correctsDoc.recording_reference)}</div>` : ''}
                                                ${correctsDoc.recording_date ? `<div style="font-size: 12px; color: #6B7280;">Date: ${escapeHtml(correctsDoc.recording_date)}</div>` : ''}
                                                ${correctsDoc.original_grantor ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Original Grantor: ${escapeHtml(correctsDoc.original_grantor)}</div>` : ''}
                                                ${correctsDoc.original_grantee ? `<div style="font-size: 12px; color: #6B7280;">Original Grantee: ${escapeHtml(correctsDoc.original_grantee)}</div>` : ''}
                                            </div>
                                        ` : ''}
                                        ${reason ? `<div style="font-size: 13px; color: #374151; margin-bottom: 6px;"><strong>Reason:</strong> ${escapeHtml(reason)}</div>` : ''}
                                        ${whatWasWrong ? `<div style="font-size: 13px; color: #374151;"><strong>Error:</strong> ${escapeHtml(whatWasWrong)}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'consideration' && typeof value === 'object') {
                            // Special handling for consideration object (quit_claim_deed)
                            hasVisibleFields = true;
                            const stated = value.stated || '';
                            const amount = value.amount;
                            const isNominal = value.is_nominal;
                            const stampsRequired = value.stamps_required;
                            const stampsAmount = value.stamps_amount;

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Consideration</label>
                                    <div style="background: ${isNominal ? '#F0FDF4' : '#EFF6FF'}; border: 1px solid ${isNominal ? '#22C55E' : '#3B82F6'}; border-radius: 6px; padding: 12px;">
                                        <div style="font-weight: 600; color: ${isNominal ? '#166534' : '#1E40AF'}; margin-bottom: 4px;">
                                            ${isNominal ? 'Nominal Consideration' : 'Consideration'}
                                        </div>
                                        ${stated ? `<div style="color: #374151; font-style: italic;">"${escapeHtml(stated)}"</div>` : ''}
                                        ${amount != null ? `<div style="font-size: 13px; color: #6B7280; margin-top: 4px;">Amount: $${amount.toLocaleString()}</div>` : ''}
                                        ${stampsRequired ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Documentary stamps: ${stampsAmount ? `$${stampsAmount}` : 'Required'}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'granting_clause' && typeof value === 'object') {
                            // Special handling for granting_clause object (quit_claim_deed)
                            hasVisibleFields = true;
                            const grantingWords = value.granting_words || '';
                            const habendum = value.habendum || '';
                            const purposeStated = value.purpose_stated || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Granting Clause</label>
                                    <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 12px;">
                                        ${grantingWords ? `<div style="color: #374151;"><strong>Granting words:</strong> "${escapeHtml(grantingWords)}"</div>` : ''}
                                        ${habendum ? `<div style="color: #374151; margin-top: 4px;"><strong>Habendum:</strong> "${escapeHtml(habendum)}"</div>` : ''}
                                        ${purposeStated ? `<div style="font-size: 13px; color: #6B7280; margin-top: 6px; font-style: italic;">Purpose: ${escapeHtml(purposeStated)}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'reservations_exceptions' && typeof value === 'object') {
                            // Special handling for reservations_exceptions object (quit_claim_deed)
                            const hasReservations = value.has_reservations;
                            const reservedInterests = value.reserved_interests || [];
                            const exceptions = value.exceptions || [];
                            const subjectTo = value.subject_to || [];

                            if (hasReservations || reservedInterests.length > 0 || exceptions.length > 0 || subjectTo.length > 0) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Reservations & Exceptions</label>
                                        <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 6px; padding: 12px;">
                                            ${reservedInterests.length > 0 ? `
                                                <div style="margin-bottom: 8px;">
                                                    <div style="font-size: 11px; color: #92400E; font-weight: 600; margin-bottom: 4px;">RESERVED INTERESTS</div>
                                                    <ul style="margin: 0; padding-left: 20px; color: #374151;">
                                                        ${reservedInterests.map(r => `<li>${escapeHtml(r)}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                            ${exceptions.length > 0 ? `
                                                <div style="margin-bottom: 8px;">
                                                    <div style="font-size: 11px; color: #92400E; font-weight: 600; margin-bottom: 4px;">EXCEPTIONS</div>
                                                    <ul style="margin: 0; padding-left: 20px; color: #374151;">
                                                        ${exceptions.map(e => `<li>${escapeHtml(e)}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                            ${subjectTo.length > 0 ? `
                                                <div>
                                                    <div style="font-size: 11px; color: #92400E; font-weight: 600; margin-bottom: 4px;">SUBJECT TO</div>
                                                    <ul style="margin: 0; padding-left: 20px; color: #374151;">
                                                        ${subjectTo.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'return_to' && typeof value === 'object') {
                            // Special handling for return_to object (quit_claim_deed)
                            const name = value.name || '';
                            const address = value.address || '';
                            const city = value.city || '';
                            const state = value.state || '';
                            const zip = value.zip || '';

                            if (name || address) {
                                hasVisibleFields = true;
                                const fullAddress = [address, city, state, zip].filter(Boolean).join(', ');
                                sectionContent += `
                                    <div class="doc-field">
                                        <label>Return To</label>
                                        <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 10px;">
                                            ${name ? `<div style="font-weight: 500; color: #374151;">${escapeHtml(name)}</div>` : ''}
                                            ${fullAddress ? `<div style="font-size: 12px; color: #6B7280; margin-top: 2px;">${escapeHtml(fullAddress)}</div>` : ''}
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'chain_of_title_links' && typeof value === 'object') {
                            // Special handling for chain_of_title_links object (quit_claim_deed)
                            const grantorEntities = value.grantor_entities || [];
                            const granteeEntities = value.grantee_entities || [];
                            const priorDocs = value.prior_documents || [];
                            const subsequentDocs = value.subsequent_documents || [];

                            if (grantorEntities.length > 0 || granteeEntities.length > 0 || priorDocs.length > 0 || subsequentDocs.length > 0) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Chain of Title Links</label>
                                        <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 12px;">
                                            ${grantorEntities.length > 0 ? `
                                                <div style="margin-bottom: 8px;">
                                                    <div style="font-size: 11px; color: #1E40AF; font-weight: 600; margin-bottom: 4px;">GRANTOR ENTITIES</div>
                                                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                        ${grantorEntities.map(e => `<span style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 4px; padding: 2px 6px; font-size: 12px;">${escapeHtml(e)}</span>`).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${granteeEntities.length > 0 ? `
                                                <div style="margin-bottom: 8px;">
                                                    <div style="font-size: 11px; color: #1E40AF; font-weight: 600; margin-bottom: 4px;">GRANTEE ENTITIES</div>
                                                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                        ${granteeEntities.map(e => `<span style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 4px; padding: 2px 6px; font-size: 12px;">${escapeHtml(e)}</span>`).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${priorDocs.length > 0 ? `
                                                <div style="margin-bottom: ${subsequentDocs.length > 0 ? '8px' : '0'};">
                                                    <div style="font-size: 11px; color: #1E40AF; font-weight: 600; margin-bottom: 4px;">PRIOR DOCUMENTS</div>
                                                    ${priorDocs.map(doc => `
                                                        <div style="background: white; border: 1px solid #BFDBFE; border-radius: 4px; padding: 8px; margin-bottom: 4px;">
                                                            <div style="font-weight: 500; color: #374151; text-transform: capitalize;">${escapeHtml((doc.doc_type || '').replace(/_/g, ' '))}</div>
                                                            ${doc.description ? `<div style="font-size: 12px; color: #6B7280;">${escapeHtml(doc.description)}</div>` : ''}
                                                            ${doc.recording_reference ? `<div style="font-size: 11px; color: #9CA3AF;">${escapeHtml(doc.recording_reference)}</div>` : ''}
                                                            ${doc.relationship ? `<div style="font-size: 11px; color: #3B82F6; text-transform: capitalize;">${escapeHtml(doc.relationship.replace(/_/g, ' '))}</div>` : ''}
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                            ${subsequentDocs.length > 0 ? `
                                                <div>
                                                    <div style="font-size: 11px; color: #1E40AF; font-weight: 600; margin-bottom: 4px;">SUBSEQUENT DOCUMENTS</div>
                                                    ${subsequentDocs.map(doc => `
                                                        <div style="background: white; border: 1px solid #BFDBFE; border-radius: 4px; padding: 8px; margin-bottom: 4px;">
                                                            <div style="font-weight: 500; color: #374151; text-transform: capitalize;">${escapeHtml((doc.doc_type || '').replace(/_/g, ' '))}</div>
                                                            ${doc.description ? `<div style="font-size: 12px; color: #6B7280;">${escapeHtml(doc.description)}</div>` : ''}
                                                            ${doc.recording_reference ? `<div style="font-size: 11px; color: #9CA3AF;">${escapeHtml(doc.recording_reference)}</div>` : ''}
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'annotations' && typeof value === 'object' && (data.doc_type === 'assignment_of_lease' || data.doc_type === 'quit_claim_deed')) {
                            // Special handling for annotations object (assignment_of_lease and quit_claim_deed schemas)
                            if (value.has_annotations) {
                                hasVisibleFields = true;
                                const handwrittenNotes = value.handwritten_notes || [];
                                const stamps = value.stamps || [];
                                const marginalNotes = value.marginal_notes || [];

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Annotations</label>
                                        <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 14px;">
                                            ${handwrittenNotes.length > 0 ? `
                                                <div style="margin-bottom: ${stamps.length || marginalNotes.length ? '12px' : '0'};">
                                                    <div style="font-size: 11px; color: #92400E; font-weight: 600; margin-bottom: 6px;">HANDWRITTEN NOTES</div>
                                                    ${handwrittenNotes.map(note => `
                                                        <div style="background: white; border: 1px solid #F59E0B; border-radius: 6px; padding: 10px; margin-bottom: 6px;">
                                                            <div style="font-weight: 600; color: #92400E;">"${escapeHtml(note.content || '')}"</div>
                                                            ${note.location ? `<div style="font-size: 11px; color: #6B7280; margin-top: 4px;">Location: ${escapeHtml(note.location)}</div>` : ''}
                                                            ${note.significance ? `<div style="font-size: 12px; color: #374151; margin-top: 4px;">${escapeHtml(note.significance)}</div>` : ''}
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                            ${stamps.length > 0 ? `
                                                <div style="margin-bottom: ${marginalNotes.length ? '12px' : '0'};">
                                                    <div style="font-size: 11px; color: #92400E; font-weight: 600; margin-bottom: 6px;">STAMPS</div>
                                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                                        ${stamps.map(s => `<span style="background: #E5E7EB; border-radius: 4px; padding: 4px 8px; font-size: 12px; color: #374151;">${escapeHtml(s)}</span>`).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${marginalNotes.length > 0 ? `
                                                <div>
                                                    <div style="font-size: 11px; color: #92400E; font-weight: 600; margin-bottom: 6px;">MARGINAL NOTES</div>
                                                    <ul style="margin: 0; padding-left: 20px; color: #374151;">
                                                        ${marginalNotes.map(n => `<li>${escapeHtml(n)}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>`;
                            }
                        } else if ((fieldName === 'respondents_with_known_addresses' ||
                                   fieldName.toLowerCase().includes('respondents') && fieldName.toLowerCase().includes('known')) &&
                                   Array.isArray(value)) {
                            // Handle respondents with known addresses array (various field name patterns)
                            if (value.length > 0) {
                                hasVisibleFields = true;
                                sectionContent += `<div class="doc-field" style="grid-column: 1 / -1;">`;
                                sectionContent += `<label>${formatFieldName(fieldName)}</label>`;
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 6px;">`;
                                value.forEach(party => {
                                    if (typeof party === 'object' && party !== null) {
                                        const name = party.name || party.Name || '';
                                        const address = party.address || party.Address || '';
                                        sectionContent += `
                                            <div style="background: #F3F4F6; border: 1px solid #D1D5DB; border-radius: 6px; padding: 8px 12px;">
                                                <div style="font-weight: 500; color: #374151;">${escapeHtml(name)}</div>
                                                ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 2px;">${escapeHtml(address)}</div>` : ''}
                                            </div>`;
                                    } else if (typeof party === 'string') {
                                        sectionContent += `
                                            <div style="background: #F3F4F6; border: 1px solid #D1D5DB; border-radius: 6px; padding: 8px 12px;">
                                                <div style="font-weight: 500; color: #374151;">${escapeHtml(party)}</div>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div></div>`;
                            }
                        } else if (fieldName === 'affected_sections' && Array.isArray(value) && data.doc_type === 'completion_report') {
                            // Special handling for affected_sections array (completion report)
                            if (value.length > 0) {
                                hasVisibleFields = true;
                                let sectionsHtml = value.map(sec => {
                                    const section = sec.section || '';
                                    const township = sec.township || '';
                                    const range = sec.range || '';
                                    return `<span style="background: #DBEAFE; color: #1E40AF; padding: 4px 10px; border-radius: 16px; font-size: 12px; font-weight: 500;">
                                        ${escapeHtml(String(section))} - ${escapeHtml(String(township))} - ${escapeHtml(String(range))}
                                    </span>`;
                                }).join('');
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                            ${sectionsHtml}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'perforated_intervals' && Array.isArray(value)) {
                            // Special handling for perforated_intervals array (completion reports, permits)
                            if (value.length > 0) {
                                hasVisibleFields = true;
                                let intervalsHtml = value.map((interval, idx) => {
                                    const formation = interval.formation || '';
                                    const top = interval.top_md_ft || interval.from_ft;
                                    const bottom = interval.bottom_md_ft || interval.to_ft;
                                    // Calculate length if not provided
                                    const length = interval.interval_length_ft || (top && bottom ? Math.abs(bottom - top) : null);
                                    return `<tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 8px; font-weight: 500;">${escapeHtml(formation) || `Interval ${idx + 1}`}</td>
                                        <td style="padding: 8px; text-align: right; font-family: monospace;">${top ? Number(top).toLocaleString() : '-'}</td>
                                        <td style="padding: 8px; text-align: right; font-family: monospace;">${bottom ? Number(bottom).toLocaleString() : '-'}</td>
                                        <td style="padding: 8px; text-align: right; font-family: monospace; font-weight: 600;">${length ? Number(length).toLocaleString() : '-'}</td>
                                    </tr>`;
                                }).join('');
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 13px; background: white; border: 1px solid #E5E7EB; border-radius: 8px; overflow: hidden;">
                                            <thead style="background: #F3F4F6;">
                                                <tr>
                                                    <th style="padding: 10px 8px; text-align: left; font-weight: 600; color: #374151;">Formation</th>
                                                    <th style="padding: 10px 8px; text-align: right; font-weight: 600; color: #374151;">Top (ft MD)</th>
                                                    <th style="padding: 10px 8px; text-align: right; font-weight: 600; color: #374151;">Bottom (ft MD)</th>
                                                    <th style="padding: 10px 8px; text-align: right; font-weight: 600; color: #374151;">Length (ft)</th>
                                                </tr>
                                            </thead>
                                            <tbody>${intervalsHtml}</tbody>
                                        </table>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'formation_tops' && Array.isArray(value)) {
                            // Special handling for formation_tops array (completion reports, permits)
                            if (value.length > 0) {
                                hasVisibleFields = true;
                                let formationsHtml = value.map(formation => {
                                    const name = formation.name || '';
                                    const md = formation.md_ft;
                                    const tvd = formation.tvd_ft;
                                    return `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #E5E7EB;">
                                        <span style="font-weight: 500;">${escapeHtml(name)}</span>
                                        <span style="font-family: monospace; color: #6B7280;">
                                            ${md ? `${Number(md).toLocaleString()} ft MD` : ''}${md && tvd ? ' / ' : ''}${tvd ? `${Number(tvd).toLocaleString()} ft TVD` : ''}
                                        </span>
                                    </div>`;
                                }).join('');
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px; padding: 12px;">
                                            ${formationsHtml}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'formation_zones' && Array.isArray(value)) {
                            // Special handling for formation_zones array (v2 completion reports - commingled wells)
                            if (value.length > 0) {
                                hasVisibleFields = true;
                                let zonesHtml = value.map((zone, idx) => {
                                    const formationName = zone.formation_name || `Zone ${idx + 1}`;
                                    const formationCode = zone.formation_code || '';
                                    const spacingOrder = zone.spacing_order || '';
                                    const unitSize = zone.unit_size_acres ? `${zone.unit_size_acres}-acre unit` : '';
                                    const perfs = zone.perforated_intervals || [];
                                    const stim = zone.stimulation || null;

                                    // Build perforated intervals mini-table
                                    let perfsHtml = '';
                                    if (perfs.length > 0) {
                                        const perfsRows = perfs.map(interval => {
                                            const top = interval.from_ft || interval.top_md_ft;
                                            const bottom = interval.to_ft || interval.bottom_md_ft;
                                            const length = interval.interval_length_ft || (top && bottom ? Math.abs(bottom - top) : null);
                                            return `<tr>
                                                <td style="padding: 4px 8px; font-family: monospace; text-align: right;">${top ? Number(top).toLocaleString() : '-'}</td>
                                                <td style="padding: 4px 8px; font-family: monospace; text-align: right;">${bottom ? Number(bottom).toLocaleString() : '-'}</td>
                                                <td style="padding: 4px 8px; font-family: monospace; text-align: right; font-weight: 500;">${length ? Number(length).toLocaleString() : '-'}</td>
                                            </tr>`;
                                        }).join('');
                                        perfsHtml = `
                                            <div style="margin-top: 8px;">
                                                <div style="font-size: 11px; color: #6B7280; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Perforated Intervals</div>
                                                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                                                    <thead style="background: #F3F4F6;">
                                                        <tr>
                                                            <th style="padding: 4px 8px; text-align: right; font-weight: 600; color: #374151;">Top (ft)</th>
                                                            <th style="padding: 4px 8px; text-align: right; font-weight: 600; color: #374151;">Bottom (ft)</th>
                                                            <th style="padding: 4px 8px; text-align: right; font-weight: 600; color: #374151;">Length</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>${perfsRows}</tbody>
                                                </table>
                                            </div>`;
                                    }

                                    // Build stimulation summary
                                    let stimHtml = '';
                                    if (stim) {
                                        const stimParts = [];
                                        if (stim.method) stimParts.push(stim.method);
                                        if (stim.stages) stimParts.push(`${stim.stages} stages`);
                                        if (stim.total_proppant_lbs) stimParts.push(`${Number(stim.total_proppant_lbs).toLocaleString()} lbs proppant`);
                                        if (stim.total_fluid_bbls) stimParts.push(`${Number(stim.total_fluid_bbls).toLocaleString()} bbls fluid`);
                                        if (stimParts.length > 0) {
                                            stimHtml = `
                                                <div style="margin-top: 8px;">
                                                    <div style="font-size: 11px; color: #6B7280; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Stimulation</div>
                                                    <div style="font-size: 13px; color: #374151;">${stimParts.join(' | ')}</div>
                                                </div>`;
                                        }
                                    }

                                    // Build spacing order info
                                    let spacingHtml = '';
                                    if (spacingOrder || unitSize) {
                                        const spacingParts = [];
                                        if (spacingOrder) spacingParts.push(`Order ${spacingOrder}`);
                                        if (unitSize) spacingParts.push(unitSize);
                                        spacingHtml = `<div style="font-size: 12px; color: #6B7280;">${spacingParts.join(' | ')}</div>`;
                                    }

                                    return `
                                        <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                                                <div>
                                                    <span style="font-weight: 600; font-size: 14px; color: #1F2937;">${escapeHtml(formationName)}</span>
                                                    ${formationCode ? `<span style="font-size: 12px; color: #6B7280; margin-left: 8px;">(${escapeHtml(formationCode)})</span>` : ''}
                                                </div>
                                            </div>
                                            ${spacingHtml}
                                            ${perfsHtml}
                                            ${stimHtml}
                                        </div>`;
                                }).join('');
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        ${zonesHtml}
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'object') {
                            // Generic handler for arrays of objects (catch-all for respondents, sections, etc.)
                            hasVisibleFields = true;
                            sectionContent += `<div class="doc-field" style="grid-column: 1 / -1;">`;
                            sectionContent += `<label>${formatFieldName(fieldName)}</label>`;

                            // Sections arrays → condensed S7-T12N-R8W (target) format
                            if (isSectionsArray(value)) {
                                const condensed = condenseSections(value);
                                sectionContent += `<div class="doc-value" style="white-space: pre-line;">${escapeHtml(condensed)}</div>`;
                            } else {
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 6px;">`;
                                value.forEach(item => {
                                    if (typeof item === 'object' && item !== null) {
                                        const parts = Object.entries(item)
                                            .filter(([k, v]) => v !== null && v !== undefined && v !== '' && String(v).toLowerCase() !== 'none')
                                            .map(([k, v]) => `<strong>${formatFieldName(k)}:</strong> ${escapeHtml(typeof v === 'string' ? formatSnakeCaseValue(v) : String(v))}`);
                                        if (parts.length > 0) {
                                            sectionContent += `
                                                <div style="background: #F3F4F6; border: 1px solid #D1D5DB; border-radius: 6px; padding: 8px 12px;">
                                                    ${parts.join(' • ')}
                                                </div>`;
                                        }
                                    }
                                });
                                sectionContent += `</div>`;
                            }
                            sectionContent += `</div>`;
                        } else if (fieldName === 'commissioners' && Array.isArray(value)) {
                            // Special handling for commissioners array
                            if (value.length > 0) {
                                hasVisibleFields = true;
                                sectionContent += `<div class="doc-field" style="grid-column: 1 / -1;">`;
                                sectionContent += `<label>Commissioners</label>`;
                                sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                                value.forEach(commissioner => {
                                    const name = commissioner.name || (typeof commissioner === 'string' ? commissioner : '');
                                    const title = commissioner.title || '';
                                    sectionContent += `
                                        <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 4px; padding: 6px 10px;">
                                            <span style="font-weight: 500; color: #374151;">${escapeHtml(name)}</span>
                                            ${title ? `<span style="font-size: 11px; color: #6B7280; margin-left: 4px;">(${escapeHtml(title)})</span>` : ''}
                                        </div>`;
                                });
                                sectionContent += `</div></div>`;
                            }
                        } else if ((fieldName === 'notes' || fieldName === 'additional_info') && value && typeof value !== 'object') {
                            // Special handling for notes/additional info (skip if object - needs custom handler)
                            hasVisibleFields = true;
                            const noteText = String(value).trim();
                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 12px; font-size: 13px; color: #4B5563; line-height: 1.5;">
                                        ${escapeHtml(noteText)}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'decedent' && typeof value === 'object' && data.doc_type === 'death_certificate') {
                            // Special handling for decedent object (death certificate)
                            hasVisibleFields = true;
                            const fullName = value.full_name || '';
                            const dateOfDeath = value.date_of_death || '';
                            const dateOfBirth = value.date_of_birth || '';
                            const ageAtDeath = value.age_at_death || {};
                            const placeOfBirth = value.place_of_birth || '';
                            const ssnLastFour = value.ssn_last_four || '';
                            const occupation = value.occupation || '';
                            const educationLevel = value.education_level || '';

                            const ageYears = ageAtDeath.years;
                            const ageStr = ageYears ? `${ageYears} years` : '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #F3F4F6; border: 1px solid #9CA3AF; border-radius: 8px; padding: 14px;">
                                        ${fullName ? `<div style="font-size: 18px; font-weight: 700; color: #1F2937; margin-bottom: 10px;">${escapeHtml(fullName)}</div>` : ''}
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; font-size: 13px;">
                                            ${dateOfBirth ? `<div><span style="color: #6B7280;">Born:</span> <strong>${escapeHtml(dateOfBirth)}</strong></div>` : ''}
                                            ${dateOfDeath ? `<div><span style="color: #6B7280;">Died:</span> <strong style="color: #DC2626;">${escapeHtml(dateOfDeath)}</strong></div>` : ''}
                                            ${ageStr ? `<div><span style="color: #6B7280;">Age:</span> <strong>${escapeHtml(ageStr)}</strong></div>` : ''}
                                            ${placeOfBirth ? `<div><span style="color: #6B7280;">Birthplace:</span> <strong>${escapeHtml(placeOfBirth)}</strong></div>` : ''}
                                            ${ssnLastFour ? `<div><span style="color: #6B7280;">SSN (last 4):</span> <strong>***-**-${escapeHtml(ssnLastFour)}</strong></div>` : ''}
                                            ${occupation ? `<div><span style="color: #6B7280;">Occupation:</span> <strong>${escapeHtml(occupation)}</strong></div>` : ''}
                                            ${educationLevel ? `<div><span style="color: #6B7280;">Education:</span> <strong>${escapeHtml(educationLevel)}</strong></div>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'marital_status' && typeof value === 'object' && data.doc_type === 'death_certificate') {
                            // Special handling for marital_status object (death certificate)
                            hasVisibleFields = true;
                            const status = value.status || '';
                            const survivingSpouse = value.surviving_spouse || {};
                            const spouseName = survivingSpouse.name_on_certificate || survivingSpouse.married_name || '';
                            const isSurviving = survivingSpouse.is_surviving;

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 14px;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center; font-size: 14px;">
                                            ${status ? `<div><span style="color: #6B7280;">Status:</span> <strong style="color: #92400E;">${escapeHtml(status)}</strong></div>` : ''}
                                            ${spouseName ? `<div><span style="color: #6B7280;">Spouse:</span> <strong>${escapeHtml(spouseName)}</strong>
                                                ${isSurviving === true ? `<span style="background: #22C55E; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 6px;">SURVIVING</span>` : ''}
                                                ${isSurviving === false ? `<span style="background: #6B7280; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 6px;">PREDECEASED</span>` : ''}
                                            </div>` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        } else if (fieldName === 'parents' && typeof value === 'object' && data.doc_type === 'death_certificate') {
                            // Special handling for parents object (death certificate)
                            hasVisibleFields = true;
                            const father = value.father || {};
                            const mother = value.mother || {};
                            const fatherName = father.full_name || '';
                            const fatherBirthplace = father.birthplace || '';
                            const motherName = mother.full_name || '';
                            const motherBirthplace = mother.birthplace || '';
                            const motherMaidenName = mother.maiden_name || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                                        ${fatherName ? `
                                            <div style="background: #DBEAFE; border: 1px solid #3B82F6; border-radius: 8px; padding: 12px; flex: 1; min-width: 200px;">
                                                <div style="font-size: 11px; color: #6B7280; margin-bottom: 4px;">FATHER</div>
                                                <div style="font-weight: 600; color: #1E40AF; font-size: 14px;">${escapeHtml(fatherName)}</div>
                                                ${fatherBirthplace ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Born: ${escapeHtml(fatherBirthplace)}</div>` : ''}
                                            </div>` : ''}
                                        ${motherName ? `
                                            <div style="background: #FCE7F3; border: 1px solid #EC4899; border-radius: 8px; padding: 12px; flex: 1; min-width: 200px;">
                                                <div style="font-size: 11px; color: #6B7280; margin-bottom: 4px;">MOTHER</div>
                                                <div style="font-weight: 600; color: #BE185D; font-size: 14px;">${escapeHtml(motherName)}</div>
                                                ${motherMaidenName ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Maiden: ${escapeHtml(motherMaidenName)}</div>` : ''}
                                                ${motherBirthplace ? `<div style="font-size: 12px; color: #6B7280; margin-top: 2px;">Born: ${escapeHtml(motherBirthplace)}</div>` : ''}
                                            </div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'chain_of_title' && typeof value === 'object' && data.doc_type === 'death_certificate') {
                            // Special handling for chain_of_title object (death certificate)
                            hasVisibleFields = true;
                            const decedentNameAsOwner = value.decedent_name_as_owner || '';
                            const nameVariations = value.name_variations || [];
                            const domicileState = value.domicile_state || '';
                            const hasSurvivingSpouse = value.has_surviving_spouse;
                            const childrenIdentified = value.children_identified;
                            const childrenNames = value.children_names || [];
                            const heirCompleteness = value.heir_identification_completeness || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 8px; padding: 14px;">
                                        <div style="font-weight: 600; color: #166534; font-size: 14px; margin-bottom: 10px;">Chain of Title Information</div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 13px;">
                                            ${decedentNameAsOwner ? `<div><span style="color: #6B7280;">Name as Owner:</span> <strong>${escapeHtml(decedentNameAsOwner)}</strong></div>` : ''}
                                            ${domicileState ? `<div><span style="color: #6B7280;">Domicile:</span> <strong>${escapeHtml(domicileState)}</strong></div>` : ''}
                                            ${hasSurvivingSpouse !== undefined ? `<div><span style="color: #6B7280;">Surviving Spouse:</span> <strong>${hasSurvivingSpouse ? 'Yes' : 'No'}</strong></div>` : ''}
                                            ${childrenIdentified !== undefined ? `<div><span style="color: #6B7280;">Children Identified:</span> <strong>${childrenIdentified ? 'Yes' : 'No'}</strong></div>` : ''}
                                        </div>
                                        ${nameVariations.length > 0 ? `
                                            <div style="margin-top: 12px;">
                                                <div style="font-size: 12px; color: #6B7280; margin-bottom: 6px;">Name Variations:</div>
                                                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                                    ${nameVariations.map(v => `<span style="background: #EDE9FE; border: 1px solid #A855F7; border-radius: 4px; padding: 3px 8px; font-size: 12px; color: #7C3AED;">${escapeHtml(v)}</span>`).join('')}
                                                </div>
                                            </div>` : ''}
                                        ${childrenNames.length > 0 ? `
                                            <div style="margin-top: 12px;">
                                                <div style="font-size: 12px; color: #6B7280; margin-bottom: 6px;">Children Names:</div>
                                                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                                    ${childrenNames.map(c => `<span style="background: #DBEAFE; border: 1px solid #3B82F6; border-radius: 4px; padding: 3px 8px; font-size: 12px; color: #1E40AF;">${escapeHtml(c)}</span>`).join('')}
                                                </div>
                                            </div>` : ''}
                                        ${heirCompleteness ? `
                                            <div style="margin-top: 12px; padding: 8px; background: ${heirCompleteness === 'complete' ? '#DCFCE7' : '#FEF3C7'}; border-radius: 4px;">
                                                <span style="color: #6B7280; font-size: 12px;">Heir Identification:</span>
                                                <strong style="color: ${heirCompleteness === 'complete' ? '#166534' : '#92400E'}; margin-left: 6px; text-transform: capitalize;">${escapeHtml(heirCompleteness)}</strong>
                                            </div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'related_documents' && typeof value === 'object' && data.doc_type === 'death_certificate') {
                            // Special handling for related_documents object (death certificate)
                            hasVisibleFields = true;
                            const expectedCompanion = value.expected_companion_documents || [];
                            const notes = value.notes || '';

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 14px;">
                                        ${expectedCompanion.length > 0 ? `
                                            <div style="font-size: 12px; color: #6B7280; margin-bottom: 8px;">Expected Companion Documents:</div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: ${notes ? '12px' : '0'};">
                                                ${expectedCompanion.map(doc => `<span style="background: #FDE68A; border: 1px solid #F59E0B; border-radius: 4px; padding: 4px 10px; font-size: 12px; color: #92400E;">${escapeHtml(doc)}</span>`).join('')}
                                            </div>` : ''}
                                        ${notes ? `<div style="font-size: 13px; color: #92400E; font-style: italic;">${escapeHtml(notes)}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'well_location' && typeof value === 'object' && data.doc_type === 'multi_unit_horizontal_order') {
                            // Special handling for well_location object (multi-unit horizontal order)
                            const surfaceLoc = value.surface_location || {};
                            const firstPerf = value.first_perforation || {};
                            const lastPerf = value.last_perforation || {};
                            const totalMD = value.total_measured_depth_ft;
                            const lateralLength = value.lateral_total_length_ft;

                            // Only show section if there's actual data
                            const hasLocData = Object.keys(surfaceLoc).length > 0 || Object.keys(firstPerf).length > 0 ||
                                              Object.keys(lastPerf).length > 0 || totalMD || lateralLength;
                            if (hasLocData) {
                                hasVisibleFields = true;
                                sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <div style="display: flex; flex-direction: column; gap: 12px;">
                                        ${Object.keys(surfaceLoc).length > 0 ? `
                                            <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 8px; padding: 12px;">
                                                <div style="font-weight: 600; color: #1E40AF; font-size: 13px; margin-bottom: 8px;">📍 Surface Location</div>
                                                <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px;">
                                                    ${surfaceLoc.section ? `<div><span style="color: #6B7280;">Section:</span> <strong>${escapeHtml(String(surfaceLoc.section))}</strong></div>` : ''}
                                                    ${surfaceLoc.township ? `<div><span style="color: #6B7280;">Township:</span> <strong>${escapeHtml(surfaceLoc.township)}</strong></div>` : ''}
                                                    ${surfaceLoc.range ? `<div><span style="color: #6B7280;">Range:</span> <strong>${escapeHtml(surfaceLoc.range)}</strong></div>` : ''}
                                                </div>
                                                <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px; margin-top: 6px;">
                                                    ${surfaceLoc.footage_ns ? `<div><span style="color: #6B7280;">N/S:</span> <strong>${escapeHtml(surfaceLoc.footage_ns)}</strong></div>` : ''}
                                                    ${surfaceLoc.footage_ew ? `<div><span style="color: #6B7280;">E/W:</span> <strong>${escapeHtml(surfaceLoc.footage_ew)}</strong></div>` : ''}
                                                </div>
                                            </div>` : ''}
                                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                            ${Object.keys(firstPerf).length > 0 ? `
                                                <div style="flex: 1; min-width: 250px; background: #DCFCE7; border: 1px solid #22C55E; border-radius: 8px; padding: 12px;">
                                                    <div style="font-weight: 600; color: #166534; font-size: 13px; margin-bottom: 8px;">▶ First Perforation</div>
                                                    <div style="font-size: 13px;">
                                                        ${firstPerf.section ? `<div><strong>Section ${escapeHtml(String(firstPerf.section))}</strong> - ${escapeHtml(firstPerf.township || '')}-${escapeHtml(firstPerf.range || '')}</div>` : ''}
                                                        ${firstPerf.formation ? `<div style="margin-top: 4px;"><span style="color: #6B7280;">Formation:</span> <strong>${escapeHtml(firstPerf.formation)}</strong></div>` : ''}
                                                        ${firstPerf.measured_depth_ft ? `<div style="margin-top: 4px;"><span style="color: #6B7280;">MD:</span> <strong>${firstPerf.measured_depth_ft.toLocaleString()} ft</strong></div>` : ''}
                                                        ${firstPerf.tvd_ft ? `<div><span style="color: #6B7280;">TVD:</span> <strong>${firstPerf.tvd_ft.toLocaleString()} ft</strong></div>` : ''}
                                                    </div>
                                                </div>` : ''}
                                            ${Object.keys(lastPerf).length > 0 ? `
                                                <div style="flex: 1; min-width: 250px; background: #FEE2E2; border: 1px solid #EF4444; border-radius: 8px; padding: 12px;">
                                                    <div style="font-weight: 600; color: #DC2626; font-size: 13px; margin-bottom: 8px;">⏹ Last Perforation</div>
                                                    <div style="font-size: 13px;">
                                                        ${lastPerf.section ? `<div><strong>Section ${escapeHtml(String(lastPerf.section))}</strong> - ${escapeHtml(lastPerf.township || '')}-${escapeHtml(lastPerf.range || '')}</div>` : ''}
                                                        ${lastPerf.formation ? `<div style="margin-top: 4px;"><span style="color: #6B7280;">Formation:</span> <strong>${escapeHtml(lastPerf.formation)}</strong></div>` : ''}
                                                        ${lastPerf.measured_depth_ft ? `<div style="margin-top: 4px;"><span style="color: #6B7280;">MD:</span> <strong>${lastPerf.measured_depth_ft.toLocaleString()} ft</strong></div>` : ''}
                                                        ${lastPerf.tvd_ft ? `<div><span style="color: #6B7280;">TVD:</span> <strong>${lastPerf.tvd_ft.toLocaleString()} ft</strong></div>` : ''}
                                                    </div>
                                                </div>` : ''}
                                        </div>
                                        ${(totalMD || lateralLength) ? `
                                            <div style="display: flex; gap: 20px; padding: 10px; background: #F9FAFB; border-radius: 6px; font-size: 14px;">
                                                ${totalMD ? `<div><span style="color: #6B7280;">Total MD:</span> <strong>${totalMD.toLocaleString()} ft</strong></div>` : ''}
                                                ${lateralLength ? `<div><span style="color: #6B7280;">Lateral Length:</span> <strong>${lateralLength.toLocaleString()} ft</strong></div>` : ''}
                                            </div>` : ''}
                                    </div>
                                    ${getConfidenceIndicator(fieldName, fieldScores)}
                                </div>`;
                            }
                        } else if (fieldName === 'relief_granted' && typeof value === 'object' && data.doc_type === 'multi_unit_horizontal_order') {
                            // Special handling for relief_granted object (multi-unit horizontal order)
                            const reason = value.reason_summary || '';
                            const costSavings = value.cost_savings || '';
                            const reservoir = value.reservoir_justification || '';

                            // Only show section if there's actual data
                            if (reason || costSavings || reservoir) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 8px; padding: 14px;">
                                            ${reason ? `<div style="font-size: 14px; color: #166534; font-weight: 500; margin-bottom: 10px;">${escapeHtml(reason)}</div>` : ''}
                                            <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px;">
                                                ${costSavings ? `<div style="background: #DCFCE7; padding: 8px 12px; border-radius: 6px;"><span style="color: #166534;">💰 Cost Savings:</span> <strong>${escapeHtml(costSavings)}</strong></div>` : ''}
                                            </div>
                                            ${reservoir ? `<div style="font-size: 13px; color: #374151; margin-top: 10px; padding-top: 10px; border-top: 1px solid #22C55E;"><strong>Reservoir Justification:</strong> ${escapeHtml(reservoir)}</div>` : ''}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'special_provisions' && typeof value === 'object' && data.doc_type === 'multi_unit_horizontal_order') {
                            // Special handling for special_provisions object (multi-unit horizontal order)
                            const shortenedReason = value.shortened_lateral_reason || '';
                            const cemented = value.cemented_perforations;
                            const amendments = value.amendments_at_hearing || '';

                            // Only show section if there's actual data
                            if (shortenedReason || cemented !== undefined || amendments) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 14px;">
                                            <div style="display: flex; flex-direction: column; gap: 10px; font-size: 13px;">
                                                ${shortenedReason ? `<div><strong style="color: #92400E;">⚠️ Shortened Lateral:</strong> ${escapeHtml(shortenedReason)}</div>` : ''}
                                                ${cemented !== undefined ? `<div><strong>Cemented Perforations:</strong> ${cemented ? '<span style="color: #166534;">✓ Yes</span>' : '<span style="color: #DC2626;">✗ No</span>'}</div>` : ''}
                                                ${amendments ? `<div><strong>Hearing Amendments:</strong> ${escapeHtml(amendments)}</div>` : ''}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'well_authorization' && typeof value === 'object' && data.doc_type === 'multi_unit_horizontal_order') {
                            // Special handling for well_authorization object (multi-unit horizontal order)
                            const wellName = value.well_name || '';
                            const apiNumber = value.api_number || '';
                            const wellType = value.well_type || '';
                            const wellClass = value.well_classification || '';

                            // Only show section if there's actual data
                            if (wellName || apiNumber || wellType || wellClass) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 8px; padding: 14px;">
                                            ${wellName ? `<div style="font-size: 18px; font-weight: 700; color: #1E40AF; margin-bottom: 8px;">${escapeHtml(wellName)}</div>` : ''}
                                            <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px;">
                                                ${apiNumber ? `<div><span style="color: #6B7280;">API:</span> <strong>${escapeHtml(apiNumber)}</strong></div>` : ''}
                                                ${wellType ? `<div><span style="color: #6B7280;">Type:</span> <strong>${escapeHtml(formatFieldName(wellType))}</strong></div>` : ''}
                                                ${wellClass ? `<div><span style="color: #6B7280;">Classification:</span> <strong style="text-transform: capitalize;">${escapeHtml(wellClass)}</strong></div>` : ''}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'well_identification' && typeof value === 'object' && data.doc_type === 'completion_report') {
                            // Special handling for well_identification object (completion report)
                            const wellName = value.well_name || '';
                            const apiNumber = value.api_number || '';
                            const permitNumber = value.permit_number || '';
                            const operator = value.operator || '';
                            const otcPun = value.otc_prod_unit_no || '';

                            if (wellName || apiNumber || permitNumber || operator) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 8px; padding: 14px;">
                                            ${wellName ? `<div style="font-size: 18px; font-weight: 700; color: #1E40AF; margin-bottom: 8px;">${escapeHtml(wellName)}</div>` : ''}
                                            <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px;">
                                                ${apiNumber ? `<div><span style="color: #6B7280;">API:</span> <strong style="font-family: monospace;">${escapeHtml(apiNumber)}</strong></div>` : ''}
                                                ${permitNumber ? `<div><span style="color: #6B7280;">Permit:</span> <strong>${escapeHtml(permitNumber)}</strong></div>` : ''}
                                                ${operator ? `<div><span style="color: #6B7280;">Operator:</span> <strong>${escapeHtml(operator)}</strong></div>` : ''}
                                                ${otcPun ? `<div><span style="color: #6B7280;">OTC PUN:</span> <strong style="font-family: monospace;">${escapeHtml(otcPun)}</strong></div>` : ''}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'dates' && typeof value === 'object' && data.doc_type === 'completion_report') {
                            // Special handling for dates object (completion report)
                            const spudDate = value.spud_date || '';
                            const completionDate = value.completion_date || '';
                            const firstProduction = value.first_production_date || '';

                            if (spudDate || completionDate || firstProduction) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 16px; padding: 12px; background: #F9FAFB; border-radius: 8px;">
                                            ${spudDate ? `<div style="background: white; padding: 10px 14px; border-radius: 6px; border: 1px solid #E5E7EB;"><span style="color: #6B7280; font-size: 12px;">Spud Date</span><div style="font-weight: 600; font-size: 14px;">${escapeHtml(spudDate)}</div></div>` : ''}
                                            ${completionDate ? `<div style="background: white; padding: 10px 14px; border-radius: 6px; border: 1px solid #E5E7EB;"><span style="color: #6B7280; font-size: 12px;">Completion Date</span><div style="font-weight: 600; font-size: 14px;">${escapeHtml(completionDate)}</div></div>` : ''}
                                            ${firstProduction ? `<div style="background: white; padding: 10px 14px; border-radius: 6px; border: 1px solid #22C55E;"><span style="color: #16A34A; font-size: 12px;">First Production</span><div style="font-weight: 600; font-size: 14px; color: #166534;">${escapeHtml(firstProduction)}</div></div>` : ''}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'well_type' && typeof value === 'object' && data.doc_type === 'completion_report') {
                            // Special handling for well_type object (completion report)
                            const drillType = value.drill_type || '';
                            const wellClass = value.well_class || '';
                            const status = value.status || '';

                            if (drillType || wellClass || status) {
                                hasVisibleFields = true;
                                const typeColor = drillType === 'HORIZONTAL' ? '#7C3AED' : '#3B82F6';
                                const statusColor = status === 'Accepted' ? '#16A34A' : (status === 'Rejected' ? '#DC2626' : '#F59E0B');
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                                            ${drillType ? `<span style="background: ${typeColor}; color: white; padding: 4px 12px; border-radius: 16px; font-size: 13px; font-weight: 600;">${escapeHtml(drillType)}</span>` : ''}
                                            ${wellClass ? `<span style="background: #E5E7EB; color: #374151; padding: 4px 12px; border-radius: 16px; font-size: 13px; font-weight: 500;">${escapeHtml(wellClass)}</span>` : ''}
                                            ${status ? `<span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 16px; font-size: 13px; font-weight: 600;">${escapeHtml(status)}</span>` : ''}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'surface_location' && typeof value === 'object' && data.doc_type === 'completion_report') {
                            // Special handling for surface_location object (completion report)
                            // Field names match extraction schema
                            const section = value.section || '';
                            const township = value.township || '';
                            const range = value.range || '';
                            const county = value.county || '';
                            const state = value.state || '';
                            const quarters = value.quarters || '';
                            const footageNS = value.footage_ns || '';
                            const footageEW = value.footage_ew || '';
                            const elevation = value.ground_elevation_ft;
                            const totalDepth = value.total_depth_ft;

                            if (section || township || range || county) {
                                hasVisibleFields = true;
                                const footageDisplay = [footageNS, footageEW].filter(Boolean).join(', ');
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 8px; padding: 14px;">
                                            <div style="font-size: 14px; font-weight: 600; color: #166534; margin-bottom: 8px;">
                                                ${section ? `Section ${escapeHtml(String(section))}` : ''} ${township ? `- ${escapeHtml(township)}` : ''} ${range ? `- ${escapeHtml(range)}` : ''}
                                            </div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px;">
                                                ${county ? `<div><span style="color: #6B7280;">County:</span> <strong>${escapeHtml(county)}</strong></div>` : ''}
                                                ${state ? `<div><span style="color: #6B7280;">State:</span> <strong>${escapeHtml(state)}</strong></div>` : ''}
                                                ${quarters ? `<div><span style="color: #6B7280;">Quarters:</span> <strong>${escapeHtml(quarters)}</strong></div>` : ''}
                                            </div>
                                            ${footageDisplay || elevation || totalDepth ? `<div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 12px; font-size: 12px; color: #374151; background: #DCFCE7; padding: 6px 10px; border-radius: 4px;">
                                                ${footageDisplay ? `<span>${escapeHtml(footageDisplay)}</span>` : ''}
                                                ${elevation ? `<span>Elev: ${elevation.toLocaleString()} ft</span>` : ''}
                                                ${totalDepth ? `<span>TD: ${totalDepth.toLocaleString()} ft</span>` : ''}
                                            </div>` : ''}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'bottom_hole_location' && typeof value === 'object' && data.doc_type === 'completion_report') {
                            // Special handling for bottom_hole_location object (completion report)
                            // Field names match extraction schema
                            const section = value.section || '';
                            const township = value.township || '';
                            const range = value.range || '';
                            const county = value.county || '';
                            const quarters = value.quarters || '';
                            const footageNS = value.footage_ns || '';
                            const footageEW = value.footage_ew || '';

                            if (section || township || range) {
                                hasVisibleFields = true;
                                const footageDisplay = [footageNS, footageEW].filter(Boolean).join(', ');
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 14px;">
                                            <div style="font-size: 14px; font-weight: 600; color: #92400E; margin-bottom: 8px;">
                                                🎯 Bottom Hole: Section ${escapeHtml(String(section))} - ${escapeHtml(township)} - ${escapeHtml(range)}
                                            </div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px;">
                                                ${county ? `<div><span style="color: #6B7280;">County:</span> <strong>${escapeHtml(county)}</strong></div>` : ''}
                                                ${quarters ? `<div><span style="color: #6B7280;">Quarters:</span> <strong>${escapeHtml(quarters)}</strong></div>` : ''}
                                            </div>
                                            ${footageDisplay ? `<div style="margin-top: 8px; font-size: 12px; color: #374151; background: #FEF9C3; padding: 6px 10px; border-radius: 4px;">${escapeHtml(footageDisplay)}</div>` : ''}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'lateral_details' && typeof value === 'object' && data.doc_type === 'completion_report') {
                            // Special handling for lateral_details object (completion report)
                            // Field names match extraction schema
                            const lateralLength = value.lateral_length_ft;
                            const kickoffDepth = value.depth_of_deviation_ft;
                            const radiusOfTurn = value.radius_of_turn_ft;
                            const direction = value.direction || (value.direction_degrees ? value.direction_degrees + '°' : '');
                            const completionInterval = value.completion_interval_ft;

                            if (lateralLength || kickoffDepth || direction) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F5F3FF; border: 1px solid #8B5CF6; border-radius: 8px; padding: 14px;">
                                            <div style="display: flex; flex-wrap: wrap; gap: 20px; font-size: 14px;">
                                                ${lateralLength ? `<div style="text-align: center;"><div style="font-size: 24px; font-weight: 700; color: #7C3AED;">${lateralLength.toLocaleString()}'</div><div style="font-size: 12px; color: #6B7280;">Lateral Length</div></div>` : ''}
                                                ${completionInterval ? `<div style="text-align: center;"><div style="font-size: 24px; font-weight: 700; color: #7C3AED;">${completionInterval.toLocaleString()}'</div><div style="font-size: 12px; color: #6B7280;">Completion Interval</div></div>` : ''}
                                                ${direction ? `<div style="text-align: center;"><div style="font-size: 24px; font-weight: 700; color: #7C3AED;">${escapeHtml(direction)}</div><div style="font-size: 12px; color: #6B7280;">Direction</div></div>` : ''}
                                            </div>
                                            ${kickoffDepth || radiusOfTurn ? `<div style="display: flex; gap: 16px; margin-top: 12px; font-size: 12px; color: #6B7280;">
                                                ${kickoffDepth ? `<span>Kickoff: ${kickoffDepth.toLocaleString()} ft</span>` : ''}
                                                ${radiusOfTurn ? `<span>Turn Radius: ${radiusOfTurn.toLocaleString()} ft</span>` : ''}
                                            </div>` : ''}
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'initial_production' && typeof value === 'object' && data.doc_type === 'completion_report') {
                            // Special handling for initial_production object (completion report)
                            // Field names match extraction schema: oil_bbl_per_day, gas_mcf_per_day, etc.
                            // Note: Check for both null AND undefined since extraction may return null for missing fields
                            const testDate = value.test_date || '';
                            const oil = value.oil_bbl_per_day;
                            const gas = value.gas_mcf_per_day;
                            const water = value.water_bbl_per_day;
                            const choke = value.choke_size || '';
                            const flowMethod = value.flow_method || '';
                            const tubingPressure = value.flow_tubing_pressure_psi;
                            const shutInPressure = value.initial_shut_in_pressure_psi;
                            const oilGravity = value.oil_gravity_api;
                            const gor = value.gas_oil_ratio;

                            // Use != null to check for both null and undefined
                            if (testDate || oil != null || gas != null || water != null || tubingPressure != null || flowMethod) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: linear-gradient(135deg, #065F46 0%, #047857 100%); border-radius: 12px; padding: 16px; color: white;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                ${testDate ? `<div style="font-size: 12px; opacity: 0.8;">Test Date: ${escapeHtml(testDate)}</div>` : '<div></div>'}
                                                ${flowMethod ? `<div style="font-size: 11px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px;">${escapeHtml(flowMethod)}</div>` : ''}
                                            </div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 12px;">
                                                ${oil != null ? `<div style="background: rgba(255,255,255,0.15); padding: 12px 16px; border-radius: 8px; text-align: center;"><div style="font-size: 28px; font-weight: 700;">${oil.toLocaleString()}</div><div style="font-size: 11px; opacity: 0.8;">OIL (BOPD)</div></div>` : ''}
                                                ${gas != null ? `<div style="background: rgba(255,255,255,0.15); padding: 12px 16px; border-radius: 8px; text-align: center;"><div style="font-size: 28px; font-weight: 700;">${gas.toLocaleString()}</div><div style="font-size: 11px; opacity: 0.8;">GAS (MCFD)</div></div>` : ''}
                                                ${water != null ? `<div style="background: rgba(255,255,255,0.15); padding: 12px 16px; border-radius: 8px; text-align: center;"><div style="font-size: 28px; font-weight: 700;">${water.toLocaleString()}</div><div style="font-size: 11px; opacity: 0.8;">WATER (BWPD)</div></div>` : ''}
                                            </div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 12px; opacity: 0.9;">
                                                ${choke ? `<span>Choke: ${escapeHtml(choke)}</span>` : ''}
                                                ${oilGravity != null ? `<span>API Gravity: ${oilGravity}°</span>` : ''}
                                                ${gor != null ? `<span>GOR: ${gor.toLocaleString()}</span>` : ''}
                                                ${tubingPressure != null ? `<span>FTP: ${tubingPressure.toLocaleString()} psi</span>` : ''}
                                                ${shutInPressure != null ? `<span>ISIP: ${shutInPressure.toLocaleString()} psi</span>` : ''}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'first_sales' && typeof value === 'object' && data.doc_type === 'completion_report') {
                            // Special handling for first_sales object (completion report)
                            const salesDate = value.date || '';
                            const purchaser = value.purchaser || '';
                            const purchaserNumber = value.purchaser_number || '';
                            const gasPlant = value.gas_plant || '';

                            if (salesDate || purchaser) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 8px; padding: 14px;">
                                            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                                                ${salesDate ? `<div><span style="color: #6B7280; font-size: 12px;">First Sale Date</span><div style="font-weight: 600; color: #166534;">${escapeHtml(salesDate)}</div></div>` : ''}
                                                ${purchaser ? `<div><span style="color: #6B7280; font-size: 12px;">Purchaser</span><div style="font-weight: 600; color: #166534;">${escapeHtml(purchaser)}${purchaserNumber ? ` <span style="font-weight: 400; color: #6B7280;">(#${escapeHtml(purchaserNumber)})</span>` : ''}</div></div>` : ''}
                                                ${gasPlant ? `<div><span style="color: #6B7280; font-size: 12px;">Gas Plant</span><div style="font-weight: 500;">${escapeHtml(gasPlant)}</div></div>` : ''}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'stimulation' && typeof value === 'object' && data.doc_type === 'completion_report') {
                            // Special handling for stimulation object (completion report)
                            const method = value.method || '';
                            const stages = value.stages;
                            const proppant = value.total_proppant_lbs;
                            const fluid = value.total_fluid_bbls;

                            if (method || stages || proppant || fluid) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 14px;">
                                            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                                                ${method ? `<div><span style="color: #6B7280; font-size: 12px;">Method</span><div style="font-weight: 600; color: #92400E;">${escapeHtml(method)}</div></div>` : ''}
                                                ${stages ? `<div><span style="color: #6B7280; font-size: 12px;">Frac Stages</span><div style="font-weight: 600; color: #92400E;">${stages}</div></div>` : ''}
                                                ${proppant ? `<div><span style="color: #6B7280; font-size: 12px;">Total Proppant</span><div style="font-weight: 500;">${proppant.toLocaleString()} lbs</div></div>` : ''}
                                                ${fluid ? `<div><span style="color: #6B7280; font-size: 12px;">Total Fluid</span><div style="font-weight: 500;">${fluid.toLocaleString()} bbls</div></div>` : ''}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'transfer_info' && typeof value === 'object' && (data.doc_type === 'well_transfer' || sectionName === 'Transfer Information')) {
                            // Special handling for transfer_info object (well transfer)
                            const formNumber = value.form_number || '';
                            const transferDate = value.transfer_date || '';
                            const approvalDate = value.approval_date || '';
                            const wellsCount = value.wells_transferred_count;

                            if (formNumber || transferDate || approvalDate || wellsCount) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F3F4F6; border: 1px solid #D1D5DB; border-radius: 8px; padding: 14px;">
                                            <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
                                                ${formNumber ? `<div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #E5E7EB;"><span style="color: #6B7280; font-size: 11px;">Form</span><div style="font-weight: 600;">${escapeHtml(formNumber)}</div></div>` : ''}
                                                ${transferDate ? `<div style="background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #E5E7EB;"><span style="color: #6B7280; font-size: 11px;">Transfer Date</span><div style="font-weight: 600;">${escapeHtml(transferDate)}</div></div>` : ''}
                                                ${approvalDate ? `<div style="background: #DCFCE7; padding: 8px 12px; border-radius: 6px; border: 1px solid #22C55E;"><span style="color: #16A34A; font-size: 11px;">Approval Date</span><div style="font-weight: 600; color: #166534;">${escapeHtml(approvalDate)}</div></div>` : ''}
                                                ${wellsCount ? `<div style="background: #DBEAFE; padding: 8px 12px; border-radius: 6px; border: 1px solid #3B82F6;"><span style="color: #1E40AF; font-size: 11px;">Wells Transferred</span><div style="font-weight: 700; font-size: 18px; color: #1E40AF;">${wellsCount}</div></div>` : ''}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'former_operator' && typeof value === 'object' && data.doc_type === 'well_transfer') {
                            // Special handling for former_operator object (well transfer)
                            const name = value.name || '';
                            const occNumber = value.occ_number || '';
                            const address = value.address || '';
                            const phone = value.phone || '';
                            const email = value.email || '';
                            const contact = value.contact_name || '';

                            if (name || occNumber) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F9FAFB; border: 1px solid #D1D5DB; border-radius: 8px; padding: 14px;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                <span style="font-size: 16px;">📤</span>
                                                <span style="font-size: 11px; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px;">Transferring From</span>
                                            </div>
                                            <div style="font-size: 16px; font-weight: 700; color: #374151;">${escapeHtml(name)}</div>
                                            ${occNumber ? `<div style="font-size: 12px; color: #6B7280; margin-top: 2px;">OCC #${escapeHtml(occNumber)}</div>` : ''}
                                            ${address ? `<div style="font-size: 13px; color: #4B5563; margin-top: 8px;">${escapeHtml(address)}</div>` : ''}
                                            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 8px; font-size: 12px;">
                                                ${phone ? `<span style="color: #6B7280;">📞 ${escapeHtml(phone)}</span>` : ''}
                                                ${email ? `<span style="color: #6B7280;">✉️ ${escapeHtml(email)}</span>` : ''}
                                                ${contact ? `<span style="color: #6B7280;">👤 ${escapeHtml(contact)}</span>` : ''}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'new_operator' && typeof value === 'object' && data.doc_type === 'well_transfer') {
                            // Special handling for new_operator object (well transfer) - HIGHLIGHTED
                            const name = value.name || '';
                            const occNumber = value.occ_number || '';
                            const address = value.address || '';
                            const phone = value.phone || '';
                            const email = value.email || '';
                            const contact = value.contact_name || '';

                            if (name || occNumber) {
                                hasVisibleFields = true;
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: linear-gradient(135deg, #065F46 0%, #047857 100%); border-radius: 8px; padding: 14px; color: white;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                <span style="font-size: 16px;">📥</span>
                                                <span style="font-size: 11px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">New Operator - Contact for Royalties</span>
                                            </div>
                                            <div style="font-size: 18px; font-weight: 700;">${escapeHtml(name)}</div>
                                            ${occNumber ? `<div style="font-size: 12px; opacity: 0.9; margin-top: 2px;">OCC #${escapeHtml(occNumber)}</div>` : ''}
                                            ${address ? `<div style="font-size: 13px; opacity: 0.95; margin-top: 8px;">${escapeHtml(address)}</div>` : ''}
                                            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px; font-size: 13px;">
                                                ${phone ? `<span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px;">📞 ${escapeHtml(phone)}</span>` : ''}
                                                ${email ? `<span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px;">✉️ ${escapeHtml(email)}</span>` : ''}
                                                ${contact ? `<span style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px;">👤 ${escapeHtml(contact)}</span>` : ''}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else if (fieldName === 'summary' && typeof value === 'object' && (data.doc_type === 'well_transfer' || sectionName === 'Transfer Summary')) {
                            // Special handling for summary object (well transfer)
                            // Filter out placeholder values - normalize by replacing hyphens/underscores with spaces
                            const placeholders = ['unknown', 'not specified', 'n a', 'none', 'not available', 'unknown not specified in document', 'not specified in document'];
                            const counties = (value.counties_affected || []).filter(c => {
                                if (!c) return false;
                                const normalized = String(c).toLowerCase().trim().replace(/[-_]/g, ' ').replace(/\s+/g, ' ');
                                return !placeholders.includes(normalized);
                            });
                            const wellTypes = value.well_types || {};
                            const oilCount = wellTypes.oil_count || 0;
                            const gasCount = wellTypes.gas_count || 0;
                            const dryCount = wellTypes.dry_count || 0;

                            if (counties.length > 0 || oilCount || gasCount || dryCount) {
                                hasVisibleFields = true;
                                const countiesHtml = counties.map(c => `<span style="background: #E5E7EB; color: #374151; padding: 3px 10px; border-radius: 12px; font-size: 12px;">${escapeHtml(c)}</span>`).join(' ');
                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px; padding: 14px;">
                                            ${counties.length > 0 ? `<div style="margin-bottom: 12px;"><span style="font-size: 12px; color: #6B7280; margin-right: 8px;">Counties:</span>${countiesHtml}</div>` : ''}
                                            <div style="display: flex; gap: 16px;">
                                                ${oilCount ? `<div style="text-align: center;"><div style="font-size: 24px; font-weight: 700; color: #92400E;">${oilCount}</div><div style="font-size: 11px; color: #6B7280;">Oil Wells</div></div>` : ''}
                                                ${gasCount ? `<div style="text-align: center;"><div style="font-size: 24px; font-weight: 700; color: #1E40AF;">${gasCount}</div><div style="font-size: 11px; color: #6B7280;">Gas Wells</div></div>` : ''}
                                                ${dryCount ? `<div style="text-align: center;"><div style="font-size: 24px; font-weight: 700; color: #6B7280;">${dryCount}</div><div style="font-size: 11px; color: #6B7280;">Dry Wells</div></div>` : ''}
                                            </div>
                                        </div>
                                        ${getConfidenceIndicator(fieldName, fieldScores)}
                                    </div>`;
                            }
                        } else {
                            // Handle other nested objects (like grantor/grantee)
                            for (const [subField, subValue] of Object.entries(value)) {
                                // Skip null/None/empty values
                                if (subValue === null || subValue === undefined || subValue === '') continue;
                                if (typeof subValue === 'string') {
                                    const trimmed = subValue.trim().toLowerCase();
                                    if (trimmed === '' || trimmed === 'none' || trimmed === 'n/a' || trimmed === 'null') continue;
                                }
                                if (Array.isArray(subValue) && subValue.length === 0) continue;
                                if (typeof subValue === 'object' && !Array.isArray(subValue) && Object.keys(subValue).length === 0) continue;

                                hasVisibleFields = true;
                                let displayValue;

                                if (Array.isArray(subValue)) {
                                    // Render arrays
                                    if (subValue.every(item => typeof item === 'string' || typeof item === 'number')) {
                                        // Simple array of strings/numbers
                                        displayValue = subValue.join(', ');
                                    } else if (isSectionsArray(subValue)) {
                                        // Sections array → condensed S7-T12N-R8W (target) format
                                        displayValue = escapeHtml(condenseSections(subValue)).replace(/\n/g, '<br>');
                                    } else {
                                        // Array of objects - render each
                                        displayValue = '<ul style="margin: 4px 0; padding-left: 20px;">';
                                        subValue.forEach(item => {
                                            if (typeof item === 'object') {
                                                const parts = Object.entries(item)
                                                    .filter(([k, v]) => v !== null && v !== undefined && v !== '' && String(v).toLowerCase() !== 'none')
                                                    .map(([k, v]) => `${formatFieldName(k)}: ${escapeHtml(typeof v === 'string' ? formatSnakeCaseValue(v) : String(v))}`);
                                                displayValue += `<li>${parts.join(' • ')}</li>`;
                                            } else {
                                                displayValue += `<li>${escapeHtml(String(item))}</li>`;
                                            }
                                        });
                                        displayValue += '</ul>';
                                    }
                                } else if (typeof subValue === 'object') {
                                    // Render nested objects as key-value pairs
                                    const parts = Object.entries(subValue)
                                        .filter(([k, v]) => v !== null && v !== undefined && v !== '' && String(v).toLowerCase() !== 'none')
                                        .map(([k, v]) => `<strong>${formatFieldName(k)}:</strong> ${escapeHtml(typeof v === 'string' ? formatSnakeCaseValue(v) : String(v))}`);
                                    displayValue = parts.join(' • ');
                                } else {
                                    // Clean any markdown artifacts and convert snake_case identifiers
                                    let cleaned = cleanFieldValue(String(subValue));
                                    cleaned = formatSnakeCaseValue(cleaned);
                                    displayValue = escapeHtml(cleaned);
                                }

                                sectionContent += `
                                    <div class="doc-field">
                                        <label>${formatFieldName(fieldName)} ${formatFieldName(subField)}</label>
                                        <div class="doc-value">${displayValue}${getConfidenceIndicator(`${fieldName}_${subField}`, fieldScores)}</div>
                                    </div>`;
                            }
                        }
                    } else {
                        // Regular field
                        hasVisibleFields = true;

                        // Skip key_takeaway, ai_observations, and detailed_analysis - rendered at the top
                        if (fieldName === 'key_takeaway' || fieldName === 'ai_observations' || fieldName === 'detailed_analysis') {
                            // Already rendered at top of content
                            hasVisibleFields = false; // Don't count these as visible in sections
                        } else if (fieldName === 'check_amount' && typeof value === 'number') {
                            // Format monetary amounts with $ and commas
                            const neg = value < 0;
                            const formatted = '$' + Math.abs(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            const display = neg ? '-' + formatted : formatted;
                            sectionContent += `
                                <div class="doc-field">
                                    <label>${formatFieldName(fieldName)}</label>
                                    <div class="doc-value" style="font-weight:600;font-size:15px;">${escapeHtml(display)}${getConfidenceIndicator(fieldName, fieldScores)}</div>
                                </div>`;
                        } else {
                            // Clean any markdown artifacts from field values
                            const cleanedValue = cleanFieldValue(String(value));
                            sectionContent += `
                                <div class="doc-field">
                                    <label>${formatFieldName(fieldName)}</label>
                                    <div class="doc-value">${escapeHtml(cleanedValue)}${getConfidenceIndicator(fieldName, fieldScores)}</div>
                                </div>`;
                        }
                    }
                }
                
                // Only add section if it has visible fields
                if (hasVisibleFields) {
                    // Make Observations expanded by default, all others collapsed
                    const isObservations = sectionName === 'Observations' || sectionName === 'Observations';
                    const isExpanded = isObservations;
                    const sectionId = sectionName.toLowerCase().replace(/[^a-z0-9]/g, '-');

                    // Rename sections when applicant is merged into operator
                    let displayName = sectionName;
                    if (data.applicant && data.operator) {
                        const namesMatch = data.applicant.name && data.operator.name &&
                            data.applicant.name.trim().toLowerCase() === data.operator.name.trim().toLowerCase();
                        const isMerged = data.applicant.is_operator === true || namesMatch;
                        if (isMerged && sectionName === 'Operator Information') {
                            displayName = 'Operator / Applicant';
                        } else if (isMerged && sectionName === 'Applicant Information') {
                            displayName = 'Legal Representation';
                        }
                    }

                    content += `<div class="detail-section">`;
                    content += `<h4 class="detail-section-title collapsible ${isExpanded ? 'expanded' : ''}" onclick="toggleSection('${sectionId}')" data-section="${sectionId}">`;
                    content += `<span class="section-chevron">&#9654;</span> ${displayName}`;
                    content += `</h4>`;
                    content += `<div class="doc-detail-grid" id="${sectionId}" style="display: ${isExpanded ? 'grid' : 'none'};">`;
                    content += sectionContent;
                    content += `</div></div>`;
                }
            }
            
            return content;
        }
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const header = document.querySelector(`[data-section="${sectionId}"]`);

            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'grid';
                header.classList.add('expanded');
            } else {
                section.style.display = 'none';
                header.classList.remove('expanded');
            }
        }
        
        function toggleConfidenceDetails(btn) {
            const details = btn.closest('.confidence-section').querySelector('.confidence-details');
            const modal = btn.closest('.modal');
            const isHidden = details.style.display === 'none';
            
            details.style.display = isHidden ? 'block' : 'none';
            btn.textContent = isHidden ? 'Hide Details ▼' : 'Show Details ▶';
            
            // Toggle confidence-visible class on modal to show/hide inline indicators
            if (isHidden) {
                modal.classList.add('confidence-visible');
            } else {
                modal.classList.remove('confidence-visible');
            }
        }
        
        // Confidence scoring was removed from extraction prompts to reduce AI load.
        // This stub function remains for backward compatibility with existing call sites.
        function calculateOverallScore(fieldScores) {
            return null;
        }

        // Helper function to render linked items sections in document modal
        function renderDocumentLinkedSections(doc) {
            const hasLinkedProperties = doc.linked_properties && doc.linked_properties.length > 0;
            const hasLinkedWells = doc.linked_wells && doc.linked_wells.length > 0;
            const hasLinkedWell = !hasLinkedWells && doc.well_id && doc.well_name; // fallback for old API

            if (!hasLinkedProperties && !hasLinkedWells && !hasLinkedWell) {
                return '';
            }

            let html = '';

            // Linked Properties section
            if (hasLinkedProperties) {
                const propCount = doc.linked_properties.length;
                html += `
                    <div class="doc-linked-section">
                        <div class="doc-linked-header expanded" onclick="toggleDocLinkedSection(this)">
                            <span class="doc-linked-arrow">▶</span>
                            <span class="doc-linked-title">Linked Properties</span>
                            <span class="doc-linked-count">${propCount}</span>
                        </div>
                        <div class="doc-linked-content expanded">`;

                for (const prop of doc.linked_properties) {
                    const meridianSuffix = prop.meridian ? `-${prop.meridian}` : '';
                    const locationStr = `S${prop.section}-T${prop.township}-R${prop.range}${meridianSuffix}`;
                    const countyStr = prop.county || '';

                    html += `
                        <div class="doc-linked-row" onclick="openPropertyFromDocument('${prop.id}')">
                            <div>
                                <div class="link-name">${escapeHtml(locationStr)} (${escapeHtml(countyStr)})</div>
                            </div>
                            <div class="link-badges">
                                ${prop.group_name ? `<span class="group-badge">${escapeHtml(prop.group_name)}</span>` : ''}
                            </div>
                        </div>`;
                }

                html += `</div></div>`;
            }

            // Linked Wells section (array from linked_wells, or fallback to single well)
            if (hasLinkedWells) {
                const wellCount = doc.linked_wells.length;
                html += `
                    <div class="doc-linked-section">
                        <div class="doc-linked-header expanded" onclick="toggleDocLinkedSection(this)">
                            <span class="doc-linked-arrow">▶</span>
                            <span class="doc-linked-title">Linked Wells</span>
                            <span class="doc-linked-count">${wellCount}</span>
                        </div>
                        <div class="doc-linked-content expanded">`;

                for (const well of doc.linked_wells) {
                    const ws = well.well_status || 'AC';
                    const statusStyle = ws === 'AC' ? 'background: #dcfce7; color: #166534;' :
                                       ws === 'TA' ? 'background: #fef9c3; color: #854d0e;' :
                                       ws === 'PA' ? 'background: #f3f4f6; color: #6b7280;' :
                                       'background: #e5e7eb; color: #374151;';

                    html += `
                            <div class="doc-linked-row" onclick="openWellFromDocument('${well.api_number || well.id}')">
                                <div>
                                    <div class="link-name">${escapeHtml(well.well_name || 'Unknown Well')}</div>
                                    <div class="link-meta">${well.api_number ? escapeHtml(well.api_number) + ' • ' : ''}${well.operator ? escapeHtml(well.operator) + ' • ' : ''}${well.county ? escapeHtml(well.county) : ''}</div>
                                </div>
                                <div class="link-badges">
                                    <span class="status-badge" style="${statusStyle}">${ws}</span>
                                </div>
                            </div>`;
                }

                html += `</div></div>`;
            } else if (hasLinkedWell) {
                // Fallback for documents fetched before linked_wells was added
                const wellStatus = doc.well_status || 'AC';
                const statusStyle = wellStatus === 'AC' ? 'background: #dcfce7; color: #166534;' :
                                   wellStatus === 'TA' ? 'background: #fef9c3; color: #854d0e;' :
                                   wellStatus === 'PA' ? 'background: #f3f4f6; color: #6b7280;' :
                                   'background: #e5e7eb; color: #374151;';

                html += `
                    <div class="doc-linked-section">
                        <div class="doc-linked-header expanded" onclick="toggleDocLinkedSection(this)">
                            <span class="doc-linked-arrow">▶</span>
                            <span class="doc-linked-title">Linked Wells</span>
                            <span class="doc-linked-count">1</span>
                        </div>
                        <div class="doc-linked-content expanded">
                            <div class="doc-linked-row" onclick="openWellFromDocument('${doc.well_api_number || doc.well_id}')">
                                <div>
                                    <div class="link-name">${escapeHtml(doc.well_name)}</div>
                                    <div class="link-meta">${doc.well_api_number ? escapeHtml(doc.well_api_number) + ' • ' : ''}${doc.well_operator ? escapeHtml(doc.well_operator) + ' • ' : ''}${doc.well_county ? escapeHtml(doc.well_county) : ''}</div>
                                </div>
                                <div class="link-badges">
                                    <span class="status-badge" style="${statusStyle}">${wellStatus}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }

            return html;
        }

        // Toggle function for document linked sections
        function toggleDocLinkedSection(header) {
            header.classList.toggle('expanded');
            const content = header.nextElementSibling;
            content.classList.toggle('expanded');
        }

        async function openDocumentDetail(docId) {
            console.log('=== OPENING DOCUMENT DETAILS ===');
            console.log('Document ID:', docId);
            
            // Fetch fresh document data to get children if any
            try {
                console.log('Fetching document from API...');
                const response = await fetch(`/api/documents/${docId}`);
                if (!response.ok) throw new Error('Failed to fetch document details');
                
                const data = await response.json();
                const doc = data.document;
                
                if (!doc) {
                    console.error('Document not found:', docId);
                    return;
                }
                
                // Debug: Log document data
                console.log('Document data received:', {
                    id: doc.id,
                    filename: doc.display_name || doc.filename,
                    has_children: !!doc.children,
                    child_count: doc.child_count,
                    children: doc.children,
                    property_id: doc.property_id,
                    property_name: doc.property_name,
                    well_id: doc.well_id,
                    well_name: doc.well_name,
                    well_api_number: doc.well_api_number
                });
                console.log('Full document object:', doc);
                
                currentDocumentId = docId;
                currentDocumentContentType = doc.content_type || 'application/pdf';
                currentDocumentRotation = doc.rotation_applied || 0;
                currentDocumentFilename = doc.display_name || doc.filename;

            // Update modal header
            document.getElementById('documentModalTitle').textContent = formatDocType(doc.category || doc.doc_type) || 'Document Details';
            
            // Update subtitle with filename and status
            const subtitleText = doc.display_name || doc.filename;
            document.getElementById('documentModalSubtitle').textContent = subtitleText;
            
            // Format the content based on what data is available
            let content = '';
            
            // Debug: Log which display path we're taking
            console.log('Display logic:', {
                has_children: !!doc.children,
                children_length: doc.children ? doc.children.length : 0,
                has_extracted_data: !!doc.extracted_data,
                status: doc.status
            });
            
            // Check if this is a parent document with children
            if (doc.children && doc.children.length > 0) {
                console.log('PARENT DOCUMENT DETECTED with', doc.children.length, 'children');
                // Parent document - show split info
                content += '<div class="doc-detail-grid">';
                
                // Status field
                const statusColor = doc.status === 'complete' ? '#1D6F5C' :
                                   doc.status === 'failed' ? 'var(--error)' :
                                   doc.status === 'manual_review' ? '#D97706' : '#F59E0B';
                const statusText = doc.status === 'complete' ? 'Complete' :
                                  doc.status === 'failed' ? 'Failed' :
                                  doc.status === 'manual_review' ? 'Needs Review' : 'Processing';
                content += `
                    <div class="doc-field">
                        <label>Status</label>
                        <div class="doc-value" style="color: ${statusColor}; font-weight: 600;">${statusText}</div>
                    </div>`;
                
                content += '</div>';
                
                // Split document info
                content += '<div class="detail-section" style="background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 8px; padding: 16px; margin: 20px 0;">';
                content += '<h4 style="margin: 0 0 12px 0; color: #1E40AF; font-size: 16px; font-weight: 600;">This PDF contained multiple documents</h4>';
                content += `<p style="margin: 0; color: #1E40AF; font-size: 14px;">The uploaded PDF has been split into ${doc.children.length} separate documents for easier management.</p>`;
                content += '</div>';
                
                // List of child documents
                content += '<div class="detail-section">';
                content += '<h4 class="detail-section-title">Individual Documents</h4>';
                content += '<div style="display: flex; flex-direction: column; gap: 8px;">';
                
                doc.children.forEach((child, index) => {
                    const childDocType = formatDocType(child.doc_type) || 'Document';
                    const pageInfo = child.page_range_start && child.page_range_end ? 
                        ` (Pages ${child.page_range_start}-${child.page_range_end})` : '';
                    
                    content += `
                        <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 12px; display: flex; justify-content: between; align-items: center; cursor: pointer; transition: all 0.2s;"
                             onmouseover="this.style.backgroundColor='#F3F4F6'" 
                             onmouseout="this.style.backgroundColor='#F9FAFB'"
                             onclick="openDocumentDetail('${child.id}')">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--oil-navy); margin-bottom: 4px;">
                                    ${index + 1}. ${escapeHtml(child.display_name || child.filename)}
                                </div>
                                <div style="font-size: 13px; color: #6B7280;">
                                    ${childDocType}${pageInfo}
                                    ${child.county ? ` • ${escapeHtml(child.county)} County` : ''}
                                    ${child.confidence ? ` • ${child.confidence} confidence` : ''}
                                </div>
                            </div>
                            <div style="color: #1D6F5C; font-weight: 500; font-size: 14px; margin-left: 16px;">
                                View →
                            </div>
                        </div>
                    `;
                });
                
                content += '</div></div>';
                
                // User Notes - always show
                content += '<div class="detail-section">';
                content += '<h4 class="detail-section-title">Notes</h4>';
                content += `<textarea id="userNotesTextarea" onchange="enableSaveButton()" oninput="enableSaveButton()" style="width: 100%; min-height: 100px; padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 14px; line-height: 1.5; resize: vertical; font-family: inherit;" placeholder="Add your notes here...">${escapeHtml(doc.user_notes || '')}</textarea>`;
                content += '</div>';
                
            } else if (doc.extracted_data) {
                try {
                    const data = JSON.parse(doc.extracted_data);
                    const fieldScores = data.field_scores || {};

                    // Check if this is a processor error response
                    if (data.error) {
                        // Processor failed to parse Claude's response
                        content += '<div class="doc-detail-grid">';
                        content += `
                            <div class="doc-field">
                                <label>Status</label>
                                <div class="doc-value" style="color: var(--error); font-weight: 600;">Processing Error</div>
                            </div>`;
                        content += '</div>';

                        content += '<div class="detail-section" style="background: #FEF2F2; border: 1px solid #FECACA; border-radius: 8px; padding: 16px; margin: 20px 0;">';
                        content += `<h4 style="margin: 0 0 8px 0; color: #B91C1C; font-size: 14px; font-weight: 600;">Error: ${escapeHtml(data.error)}</h4>`;
                        content += '<p style="margin: 0 0 12px 0; color: #7F1D1D; font-size: 13px;">The document processor encountered an error parsing the AI response. Please try re-analyzing the document.</p>';

                        // Show raw response preview if available (collapsed by default)
                        if (data.raw_response) {
                            const preview = data.raw_response.substring(0, 500) + (data.raw_response.length > 500 ? '...' : '');
                            content += `<details style="margin-top: 12px;">
                                <summary style="cursor: pointer; color: #B91C1C; font-size: 12px;">Show Raw Response</summary>
                                <pre style="margin-top: 8px; padding: 12px; background: #FFF; border: 1px solid #FECACA; border-radius: 4px; font-size: 11px; overflow-x: auto; white-space: pre-wrap; word-break: break-all;">${escapeHtml(preview)}</pre>
                            </details>`;
                        }
                        content += '</div>';

                        // User Notes - always show
                        content += '<div class="detail-section">';
                        content += '<h4 class="detail-section-title">Notes</h4>';
                        content += `<textarea id="userNotesTextarea" onchange="enableSaveButton()" oninput="enableSaveButton()" style="width: 100%; min-height: 100px; padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 14px; line-height: 1.5; resize: vertical; font-family: inherit;" placeholder="Add your notes here...">${escapeHtml(doc.user_notes || '')}</textarea>`;
                        content += '</div>';

                    // Check if this is an "other" document with skip_extraction
                    } else if (data.skip_extraction) {
                        // Simplified display for "other" documents
                        content += '<div class="doc-detail-grid">';
                        
                        // Status field
                        const statusColor = doc.status === 'complete' ? '#1D6F5C' :
                                           doc.status === 'failed' ? 'var(--error)' :
                                           doc.status === 'manual_review' ? '#D97706' : '#F59E0B';
                        const statusText = doc.status === 'complete' ? 'Complete' :
                                          doc.status === 'failed' ? 'Failed' :
                                          doc.status === 'manual_review' ? 'Needs Review' : 'Processing';
                        content += `
                            <div class="doc-field">
                                <label>Status</label>
                                <div class="doc-value" style="color: ${statusColor}; font-weight: 600;">${statusText}</div>
                            </div>`;
                        
                        // Document Type
                        content += `
                            <div class="doc-field">
                                <label>Document Type</label>
                                <div class="doc-value">Other</div>
                            </div>`;
                        
                        // Upload date
                        const uploadDate = new Date(doc.upload_date).toLocaleDateString('en-US', { 
                            timeZone: 'America/Chicago',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        content += `
                            <div class="doc-field">
                                <label>Uploaded</label>
                                <div class="doc-value">${uploadDate}</div>
                            </div>`;
                        
                        // Page count if available
                        if (doc.page_count) {
                            content += `
                                <div class="doc-field">
                                    <label>Page Count</label>
                                    <div class="doc-value">${doc.page_count} page${doc.page_count > 1 ? 's' : ''}</div>
                                </div>`;
                        }
                        
                        content += '</div>';

                        // Key Takeaway if available (always visible, prominent at top)
                        if (data.key_takeaway) {
                            const cleanedTakeaway = data.key_takeaway.trim().replace(/^#{1,6}\s*/gm, '').replace(/^---+$/gm, '').replace(/\*\*([^*]+)\*\*/g, '$1').replace(/\*\*/g, '').replace(/^\s+/gm, '').replace(/\t/g, ' ').replace(/\n{3,}/g, '\n\n');
                            content += `<div style="margin-bottom: 16px;">
                                <details class="key-takeaway-block" open>
                                    <summary class="key-takeaway-trigger">
                                        <span class="details-chevron">&#9654;</span>
                                        <span class="key-takeaway-label">Key Takeaway</span>
                                    </summary>
                                    <div class="key-takeaway-content">${escapeHtml(cleanedTakeaway)}</div>
                                </details>
                            </div>`;
                        }

                        // AI Observations if available (prominent expandable detailed analysis)
                        if (data.ai_observations) {
                            content += '<div class="detail-section">';
                            const cleanedObs = data.ai_observations.trim().replace(/^\s+/gm, '').replace(/\t/g, ' ');
                            content += `<details class="detailed-analysis-block">
                                <summary class="detailed-analysis-trigger">
                                    <span class="details-chevron">&#9654;</span>
                                    <span class="detailed-analysis-label">View Detailed Analysis</span>
                                    <span class="detailed-analysis-hint">Click to expand</span>
                                </summary>
                                <div class="detailed-analysis-content">${formatAnalysisText(cleanedObs)}</div>
                            </details>`;
                            content += '</div>';
                        }

                        // Message about no extraction
                        content += '<div class="detail-section" style="background: #F3F4F6; border: 1px solid #E5E7EB; border-radius: 8px; padding: 16px; margin-top: 20px;">';
                        content += '<p style="margin: 0; color: #4B5563; font-size: 14px; line-height: 1.5;">This document was classified as "Other" and detailed field extraction was skipped. You can view the original PDF using the button below.</p>';
                        content += '</div>';
                        
                        // User Notes - always show
                        content += '<div class="detail-section">';
                        content += '<h4 class="detail-section-title">Notes</h4>';
                        content += `<textarea id="userNotesTextarea" onchange="enableSaveButton()" oninput="enableSaveButton()" style="width: 100%; min-height: 100px; padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 14px; line-height: 1.5; resize: vertical; font-family: inherit;" placeholder="Add your notes here...">${escapeHtml(doc.user_notes || '')}</textarea>`;
                        content += '</div>';
                        
                    } else {
                        // Normal extraction flow
                        // Add status info at the top
                        content += '<div class="doc-detail-grid">';
                        
                        // Status field
                        const statusColor = doc.status === 'complete' ? '#1D6F5C' :
                                           doc.status === 'failed' ? 'var(--error)' :
                                           doc.status === 'manual_review' ? '#D97706' : '#F59E0B';
                        const statusText = doc.status === 'complete' ? 'Complete' :
                                          doc.status === 'failed' ? 'Failed' :
                                          doc.status === 'manual_review' ? 'Needs Review' : 'Processing';
                        content += `
                            <div class="doc-field">
                                <label>Status</label>
                                <div class="doc-value" style="color: ${statusColor}; font-weight: 600;">${statusText}</div>
                            </div>`;
                        
                        // Document Type
                        if (data.doc_type || doc.doc_type) {
                            content += `
                                <div class="doc-field">
                                    <label>Document Type</label>
                                    <div class="doc-value">${formatDocType(data.category || data.doc_type || doc.category || doc.doc_type)}</div>
                                </div>`;
                        }

                        // Schema Type (for debugging/transparency)
                        const schemaValidation = data._schema_validation;
                        if (schemaValidation && schemaValidation.schema) {
                            const schemaType = schemaValidation.schema.schema_type;
                            const docType = schemaValidation.schema.doc_type;
                            if (schemaType || docType) {
                                const schemaDisplay = schemaType
                                    ? formatDocType(schemaType) + (schemaType !== docType ? ` (doc: ${docType})` : '')
                                    : docType;
                                content += `
                                    <div class="doc-field">
                                        <label>Schema Used</label>
                                        <div class="doc-value" style="font-size: 12px; color: #6B7280;">${schemaDisplay}</div>
                                    </div>`;
                            }
                        }

                        content += '</div>';
                    
                    // Add linked items sections (Properties and Wells as separate collapsibles)
                    content += renderDocumentLinkedSections(doc);

                    // Render all extracted fields dynamically (includes Observations at top)
                    content += renderExtractedData(data, fieldScores);
                    
                    // User Notes
                    content += '<div class="detail-section">';
                    content += '<h4 class="detail-section-title">Notes</h4>';
                    content += `<textarea id="userNotesTextarea" onchange="enableSaveButton()" oninput="enableSaveButton()" style="width: 100%; min-height: 100px; padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 14px; line-height: 1.5; resize: vertical; font-family: inherit;" placeholder="Add your notes here...">${escapeHtml(doc.user_notes || '')}</textarea>`;
                    content += '</div>';
                    }
                    
                } catch (e) {
                    console.error('Error parsing extracted data:', e);
                    content += '<div class="detail-section">';
                    content += '<p style="color: var(--error);">Error displaying extracted data</p>';
                    content += '</div>';
                }
            } else {
                // No extracted data yet - show status and user notes
                content += '<div class="doc-detail-grid">';
                
                // Status field
                const statusColor = doc.status === 'complete' ? '#1D6F5C' :
                                   doc.status === 'failed' ? 'var(--error)' :
                                   doc.status === 'manual_review' ? '#D97706' : '#F59E0B';
                const statusText = doc.status === 'complete' ? 'Complete' :
                                  doc.status === 'failed' ? 'Failed' :
                                  doc.status === 'manual_review' ? 'Needs Review' : 'Processing';
                content += `
                    <div class="doc-field">
                        <label>Status</label>
                        <div class="doc-value" style="color: ${statusColor}; font-weight: 600;">${statusText}</div>
                    </div>`;
                
                content += '</div>';

                // Add linked items sections (Properties and Wells as separate collapsibles)
                content += renderDocumentLinkedSections(doc);

                content += '<div class="detail-section" style="text-align: center; padding: 40px 20px; background: #F9FAFB; border-radius: 8px; margin: 20px 0;">';
                content += '<svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 16px; opacity: 0.3;">';
                content += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>';
                content += '</svg>';
                content += '<p style="color: var(--slate-blue); font-weight: 500;">Document is being processed</p>';
                content += '<p style="color: var(--slate-blue); font-size: 13px;">Data extraction will be available soon</p>';
                content += '</div>';
                
                // User Notes - always show
                content += '<div class="detail-section">';
                content += '<h4 class="detail-section-title">Notes</h4>';
                content += `<textarea id="userNotesTextarea" onchange="enableSaveButton()" oninput="enableSaveButton()" style="width: 100%; min-height: 100px; padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 14px; line-height: 1.5; resize: vertical; font-family: inherit;" placeholder="Add your notes here...">${escapeHtml(doc.user_notes || '')}</textarea>`;
                content += '</div>';
            }
            
            // Add some CSS for the detail sections
            if (!document.getElementById('documentDetailStyles')) {
                const style = document.createElement('style');
                style.id = 'documentDetailStyles';
                style.textContent = `
                    /* Document details styles v2 */
                    .doc-detail-grid {
                        display: grid;
                        gap: 16px;
                        margin-bottom: 24px;
                        max-width: 600px;
                    }
                    .doc-field {
                        display: flex;
                        justify-content: space-between;
                        align-items: baseline;
                        padding: 12px 0;
                        border-bottom: 1px solid #E5E7EB;
                        gap: 16px;
                    }
                    .doc-field:last-child {
                        border-bottom: none;
                    }
                    .doc-field label {
                        font-size: 14px;
                        font-weight: 500;
                        color: #6B7280;
                        flex: 0 0 140px;
                    }
                    .doc-value {
                        font-size: 14px;
                        color: #111827;
                        text-align: right;
                        flex: 1;
                    }
                    @media (max-width: 600px) {
                        .doc-detail-grid {
                            max-width: 100%;
                        }
                        .doc-field {
                            flex-direction: column;
                            align-items: flex-start;
                            gap: 4px;
                        }
                        .doc-field label {
                            flex: none;
                        }
                        .doc-value {
                            text-align: left;
                            word-break: break-word;
                        }
                    }
                    .detail-section {
                        margin-bottom: 24px;
                    }
                    .detail-section:last-child {
                        margin-bottom: 0;
                    }
                    .detail-section-title {
                        margin: 0 0 16px;
                        font-size: 16px;
                        font-weight: 600;
                        color: #111827;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .detail-section-title.collapsible {
                        cursor: pointer;
                        user-select: none;
                        transition: color 0.2s;
                    }
                    .detail-section-title.collapsible:hover {
                        color: #1D6F5C;
                    }
                    .section-chevron {
                        font-size: 12px;
                        color: #6B7280;
                        transition: transform 0.2s;
                    }
                    .detail-section-title.expanded .section-chevron {
                        transform: rotate(90deg);
                    }

                    /* Document Modal - Linked Items Sections */
                    .doc-linked-section {
                        margin: 12px 0;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        overflow: hidden;
                    }
                    .doc-linked-header {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 10px 14px;
                        background: #f9fafb;
                        cursor: pointer;
                        user-select: none;
                    }
                    .doc-linked-header:hover {
                        background: #f3f4f6;
                    }
                    .doc-linked-arrow {
                        font-size: 10px;
                        color: #6b7280;
                        transition: transform 0.2s;
                    }
                    .doc-linked-header.expanded .doc-linked-arrow {
                        transform: rotate(90deg);
                    }
                    .doc-linked-title {
                        font-weight: 500;
                        font-size: 14px;
                        color: var(--oil-navy);
                    }
                    .doc-linked-count {
                        background: #e5e7eb;
                        padding: 2px 8px;
                        border-radius: 10px;
                        font-size: 11px;
                        font-weight: 500;
                        color: #374151;
                    }
                    .doc-linked-content {
                        display: none;
                        padding: 0 14px 10px;
                    }
                    .doc-linked-content.expanded {
                        display: block;
                    }
                    .doc-linked-row {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px 0;
                        border-bottom: 1px solid #f3f4f6;
                        cursor: pointer;
                    }
                    .doc-linked-row:last-child {
                        border-bottom: none;
                    }
                    .doc-linked-row:hover {
                        background: #f9fafb;
                        margin: 0 -14px;
                        padding: 8px 14px;
                    }
                    .doc-linked-row .link-name {
                        font-weight: 500;
                        color: #2563eb;
                        font-size: 14px;
                    }
                    .doc-linked-row .link-meta {
                        font-size: 12px;
                        color: #6b7280;
                        margin-top: 2px;
                    }
                    .doc-linked-row .link-badges {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        flex-shrink: 0;
                    }
                    .doc-linked-row .group-badge {
                        background: #dbeafe;
                        color: #1d4ed8;
                        padding: 2px 8px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: 500;
                    }
                    .doc-linked-row .status-badge {
                        padding: 2px 6px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: 500;
                    }
                    .doc-linked-empty {
                        color: #6b7280;
                        font-size: 13px;
                        padding: 8px 0;
                        font-style: italic;
                    }

                    /* Hide default details marker across browsers */
                    summary::-webkit-details-marker {
                        display: none;
                    }
                    summary::marker {
                        display: none;
                        content: '';
                    }
                    details summary {
                        list-style: none;
                    }

                    /* Custom chevron rotation */
                    .details-chevron {
                        display: inline-block;
                        font-size: 10px;
                        transition: transform 0.2s ease;
                    }
                    details[open] .details-chevron {
                        transform: rotate(90deg);
                    }

                    /* Key Takeaway styling (green, matches Detailed Analysis structure) */
                    .key-takeaway-block {
                        background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
                        border: 2px solid #22C55E;
                        border-radius: 10px;
                        overflow: hidden;
                        transition: all 0.2s ease;
                    }
                    .key-takeaway-block:hover {
                        border-color: #16A34A;
                        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
                    }
                    .key-takeaway-trigger {
                        padding: 14px 18px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        background: transparent;
                        user-select: none;
                    }
                    .key-takeaway-trigger:hover {
                        background: rgba(34, 197, 94, 0.1);
                    }
                    .key-takeaway-trigger .details-chevron {
                        font-size: 12px;
                        color: #22C55E;
                        transition: transform 0.2s ease;
                    }
                    .key-takeaway-label {
                        font-weight: 600;
                        color: #166534;
                        font-size: 14px;
                    }
                    .key-takeaway-content {
                        white-space: pre-wrap;
                        line-height: 1.7;
                        padding: 16px 18px;
                        border-top: 1px solid #BBF7D0;
                        background: white;
                        color: #166534;
                        font-size: 14px;
                    }

                    /* Detailed Analysis prominent styling */
                    .detailed-analysis-block {
                        background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
                        border: 2px solid #3B82F6;
                        border-radius: 10px;
                        overflow: hidden;
                        transition: all 0.2s ease;
                    }
                    .detailed-analysis-block:hover {
                        border-color: #2563EB;
                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
                    }
                    .detailed-analysis-trigger {
                        padding: 14px 18px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        background: transparent;
                        user-select: none;
                    }
                    .detailed-analysis-trigger:hover {
                        background: rgba(59, 130, 246, 0.1);
                    }
                    .detailed-analysis-trigger .details-chevron {
                        font-size: 12px;
                        color: #3B82F6;
                        transition: transform 0.2s ease;
                    }
                    .detailed-analysis-label {
                        font-weight: 600;
                        color: #1E40AF;
                        font-size: 14px;
                    }
                    .detailed-analysis-hint {
                        font-size: 12px;
                        color: #6B7280;
                        margin-left: auto;
                        opacity: 0.8;
                    }
                    .detailed-analysis-block[open] .detailed-analysis-hint {
                        display: none;
                    }
                    .detailed-analysis-content {
                        white-space: pre-wrap;
                        line-height: 1.7;
                        padding: 16px 18px;
                        border-top: 1px solid #BFDBFE;
                        background: white;
                        color: #334155;
                        font-size: 14px;
                    }
                    .detail-row {
                        margin-bottom: 8px;
                        font-size: 14px;
                        line-height: 1.5;
                    }
                    .detail-row:last-child {
                        margin-bottom: 0;
                    }
                    .detail-row strong {
                        display: inline-block;
                        min-width: 120px;
                        color: #6B7280;
                    }
                    .detail-row span {
                        color: #111827;
                    }
                    
                    /* Confidence indicator styles */
                    .document-detail-modal .confidence-indicator {
                        margin-left: 0.5rem;
                        font-size: 1rem;
                        display: none; /* Hidden by default */
                    }
                    .confidence-indicator.confidence-high { color: #10b981; }
                    .confidence-indicator.confidence-medium { color: #f59e0b; }
                    .confidence-indicator.confidence-low { color: #ef4444; }
                    
                    /* Hide percentages by default */
                    .confidence-percentage {
                        display: none;
                    }
                    
                    /* Show confidence indicators when details are expanded */
                    .document-detail-modal.confidence-visible .confidence-indicator {
                        display: inline;
                    }
                    
                    /* Show percentages when details are expanded */
                    .document-detail-modal.confidence-visible .confidence-percentage {
                        display: inline;
                    }
                    
                    /* Confidence section styles - subtle metadata row */
                    .confidence-section {
                        background-color: #f9fafb;
                        padding: 8px 12px;
                        border-radius: 6px;
                        margin-top: 12px;
                        margin-bottom: 12px;
                        font-size: 14px;
                    }

                    .confidence-header {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }

                    .confidence-label {
                        color: #6b7280;
                        font-weight: 500;
                    }

                    .confidence-badge {
                        display: inline-flex;
                        align-items: center;
                        gap: 4px;
                        font-weight: 500;
                        font-size: 13px;
                    }

                    .confidence-badge.high { color: #10b981; }
                    .confidence-badge.medium { color: #f59e0b; }
                    .confidence-badge.low { color: #ef4444; }

                    .confidence-toggle {
                        background: none;
                        border: none;
                        color: #6b7280;
                        cursor: pointer;
                        font-size: 12px;
                        padding: 2px 6px;
                        margin-left: auto;
                        transition: color 0.2s;
                    }

                    .confidence-toggle:hover {
                        color: #374151;
                    }

                    /* Mobile: Compact confidence section */
                    @media (max-width: 480px) {
                        .confidence-section {
                            padding: 6px 10px;
                            font-size: 12px;
                        }
                        .confidence-label {
                            display: none;
                        }
                        .confidence-badge {
                            font-size: 12px;
                        }
                        .confidence-toggle {
                            font-size: 11px;
                        }
                    }

                    .confidence-details {
                        margin-top: 10px;
                        padding-top: 10px;
                        border-top: 1px solid #e5e7eb;
                    }

                    .confidence-details.hidden {
                        display: none;
                    }

                    .confidence-details-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 6px;
                    }

                    .confidence-detail-item {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 4px 8px;
                        background-color: white;
                        border-radius: 4px;
                        border: 1px solid #e5e7eb;
                        font-size: 12px;
                    }

                    .confidence-detail-item .field-name {
                        color: #6b7280;
                    }

                    .confidence-detail-item .field-score {
                        display: flex;
                        align-items: center;
                        gap: 4px;
                        font-weight: 500;
                    }

                    .confidence-high { color: #10b981; }
                    .confidence-medium { color: #f59e0b; }
                    .confidence-low { color: #ef4444; }
                    
                    #documentDetailModal .modal {
                        border: none;
                    }
                    #viewOriginalBtn:hover {
                        background: #155347 !important;
                    }
                    
                    /* 
                     * Full-bleed modal pattern (edge-to-edge header, scrollable body, fixed footer)
                     * Currently used on: Document details
                     * TODO: Apply to Properties and Wells detail modals for consistency
                     * 
                     * Usage: Apply these classes to any detail modal:
                     * - .detail-modal on the modal container (with padding: 0)
                     * - .detail-modal-header on the header section
                     * - .detail-modal-body on the scrollable content area
                     * - .detail-modal-footer on the fixed footer section
                     */
                    .detail-modal {
                        padding: 0 !important;
                        display: flex !important;
                        flex-direction: column !important;
                        overflow: hidden !important;
                    }
                    
                    .detail-modal-header {
                        flex-shrink: 0 !important;
                        /* Header styling should be applied inline for different colors */
                    }
                    
                    .detail-modal-body {
                        flex: 1 !important;
                        overflow-y: auto !important;
                        -webkit-overflow-scrolling: touch !important;
                        min-height: 0 !important;
                    }
                    
                    .detail-modal-footer {
                        flex-shrink: 0 !important;
                        background: white !important;
                        border-top: 1px solid #e5e7eb !important;
                    }
                    
                    /* Mobile-specific fixes for document detail modal */
                    @media (max-width: 768px) {
                        #documentDetailModal {
                            align-items: center !important;
                            justify-content: center !important;
                            padding: 0 !important;
                        }
                        #documentDetailModal .modal {
                            max-height: calc(100vh - 16px) !important;
                            max-height: calc(100dvh - 16px) !important; /* Use dvh for better mobile support */
                            margin: 8px !important;
                            width: calc(100vw - 16px) !important;
                            position: relative !important;
                        }
                        /* Tighter padding on mobile */
                        #documentDetailModal .modal-header {
                            padding: 16px 20px !important;
                        }
                        #documentDetailModal .modal-body {
                            padding: 16px 20px !important;
                        }
                        #documentDetailModal .modal-footer {
                            padding: 12px 16px !important;
                        }
                        #documentDetailModal button {
                            padding: 8px 12px;
                            font-size: 14px;
                        }
                        /* Make header text smaller on mobile */
                        #documentModalTitle {
                            font-size: 18px !important;
                        }
                        #documentModalSubtitle {
                            font-size: 13px !important;
                        }
                        /* Stack footer buttons on very small screens */
                        @media (max-width: 480px) {
                            #documentDetailModal .modal-footer {
                                flex-direction: column;
                                align-items: stretch;
                                gap: 8px !important;
                            }
                            #documentDetailModal .modal-footer > * {
                                width: 100%;
                            }
                            #documentDetailModal .modal-footer button {
                                justify-content: center;
                            }
                        }
                    }
                    
                    /* Confidence indicators */
                    .confidence-high {
                        color: #22c55e;
                        margin-left: 8px;
                        font-weight: 600;
                    }
                    .confidence-medium {
                        color: #f59e0b;
                        margin-left: 8px;
                        font-weight: 600;
                    }
                    .confidence-low {
                        color: #ef4444;
                        margin-left: 8px;
                        font-weight: 600;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Update modal content and show
            document.getElementById('documentDetailContent').innerHTML = content;
            const detailModal = document.getElementById('documentDetailModal');
            
            // Calculate z-index based on stack depth BEFORE adding to stack
            const baseZIndex = 999999;
            const newZIndex = baseZIndex + (modalStack.length * 10);
            
            detailModal.style.display = 'flex';
            detailModal.style.zIndex = String(newZIndex);
            
            // Add to modal stack if not already there
            if (!modalStack.find(m => m.element === detailModal)) {
                modalStack.push({ type: 'document', id: docId, element: detailModal });
            }
            
            // Initialize notes tracking after modal is shown
            originalNotes = doc.user_notes || '';
            hasNotesChanged = false;
            const saveBtn = document.getElementById('saveDocNotesBtn');
            if (saveBtn) {
                saveBtn.style.display = 'none';
            }

            // Show/hide print button based on whether document has extractable content
            // Hide for parent documents (split PDFs) and documents without extracted data
            const printBtn = document.getElementById('printDocBtn');
            if (printBtn) {
                const isParentDocument = doc.children && doc.children.length > 0;
                const hasExtractedData = doc.extracted_data && (doc.status === 'complete' || doc.status === 'processed');
                printBtn.style.display = (hasExtractedData && !isParentDocument) ? 'flex' : 'none';
            }
            } catch (error) {
                console.error('Error loading document details:', error);
                alert('Failed to load document details');
            }
        }

        function closeDocumentDetailModal() {
            const modal = document.getElementById('documentDetailModal');
            modal.style.display = 'none';
            modal.style.zIndex = '';  // Reset z-index
            currentDocumentId = null;
            
            // Remove from modal stack
            const index = modalStack.findIndex(m => m.element === modal);
            if (index > -1) {
                modalStack.splice(index, 1);
            }
        }

        function viewDocumentPDF() {
            if (currentDocumentId) {
                viewDocumentInModal(currentDocumentId, currentDocumentFilename || '', true, currentDocumentContentType || 'application/pdf', currentDocumentRotation || 0);
                // Don't close the detail modal - keep it in the background
            }
        }

        function printDocumentSummary() {
            if (currentDocumentId) {
                // Open print page in new tab
                window.open(`/print/document?id=${currentDocumentId}`, '_blank');
            }
        }

        function calculateMineralAcres(interest, acres) {
            // Parse interest fraction
            const interestLower = interest.toLowerCase();
            let fraction = null;
            
            // Try to extract fraction
            if (interestLower.includes('1/8') || interestLower.includes('one-eighth')) {
                fraction = 1/8;
            } else if (interestLower.includes('1/4') || interestLower.includes('one-fourth')) {
                fraction = 1/4;
            } else if (interestLower.includes('1/2') || interestLower.includes('one-half')) {
                fraction = 1/2;
            } else if (interestLower.includes('3/4') || interestLower.includes('three-fourths')) {
                fraction = 3/4;
            } else if (interestLower.includes('1/16')) {
                fraction = 1/16;
            } else if (interestLower.includes('1/32')) {
                fraction = 1/32;
            } else if (interestLower.includes('1/64')) {
                fraction = 1/64;
            }
            
            if (fraction && acres) {
                const acresNum = parseFloat(acres);
                if (!isNaN(acresNum)) {
                    return (acresNum * fraction).toFixed(2);
                }
            }
            
            return null;
        }

        // Document notes tracking
        let originalNotes = '';
        let hasNotesChanged = false;

        function enableSaveButton() {
            const textarea = document.getElementById('userNotesTextarea');
            const saveBtn = document.getElementById('saveDocNotesBtn');
            if (textarea && saveBtn) {
                hasNotesChanged = textarea.value !== originalNotes;
                saveBtn.style.display = hasNotesChanged ? 'block' : 'none';
                console.log('Notes changed:', hasNotesChanged, 'Original:', originalNotes, 'Current:', textarea.value);
            } else {
                console.log('Could not find textarea or save button');
            }
        }

        function toggleObservations() {
            const textDiv = document.getElementById('observationsText');
            const toggleBtn = document.getElementById('observationsToggle');
            
            if (textDiv && toggleBtn) {
                const isExpanded = toggleBtn.textContent.includes('less');
                
                if (isExpanded) {
                    textDiv.textContent = textDiv.getAttribute('data-truncated');
                    toggleBtn.innerHTML = 'Show more ▶';
                } else {
                    textDiv.textContent = textDiv.getAttribute('data-full');
                    toggleBtn.innerHTML = 'Show less ▼';
                }
            }
        }

        async function saveAndCloseDocumentNotes() {
            if (!currentDocumentId || !hasNotesChanged) {
                closeDocumentDetailModal();
                return;
            }
            
            const textarea = document.getElementById('userNotesTextarea');
            const notes = textarea.value;
            
            try {
                const response = await fetch(`/api/documents/${currentDocumentId}/notes`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notes }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    // Update the document in our loaded array
                    const doc = loadedDocuments.find(d => d.id === currentDocumentId);
                    if (doc) {
                        doc.user_notes = notes;
                    }
                    
                    closeDocumentDetailModal();
                    // Optionally show a success message
                } else {
                    const error = await response.json();
                    alert('Failed to save notes: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving notes:', error);
                alert('Failed to save notes. Please try again.');
            }
        }


        // Open property from document modal - stack on top
        function openPropertyFromDocument(propertyId) {
            console.log('[openPropertyFromDocument] Called with propertyId:', propertyId);

            // Handle comma-separated property IDs (multi-property documents) - use first one
            if (propertyId && propertyId.includes(',')) {
                const firstPropertyId = propertyId.split(',')[0];
                console.log('[openPropertyFromDocument] Multi-property document, using first ID:', firstPropertyId);
                propertyId = firstPropertyId;
            }

            console.log('[openPropertyFromDocument] Current modal stack length:', modalStack.length);
            console.log('[openPropertyFromDocument] Modal stack:', modalStack.map(m => ({ type: m.type, id: m.id })));

            // Check if we've hit max depth
            if (modalStack.length >= MAX_MODAL_DEPTH) {
                console.log('[openPropertyFromDocument] Max depth reached, closing document modal first');
                // Close the document modal to make room
                closeDocumentDetailModal();
                // Give it time to close before opening property
                setTimeout(async () => {
                    await openPropertyDetails(propertyId);
                }, 100);
                return;
            }
            
            // Don't close the document modal - open property on top
            console.log('[openPropertyFromDocument] Opening property modal on top of document modal');
            setTimeout(async () => {
                await openPropertyDetails(propertyId);
            }, 50);
        }
        
        // Open well from document modal - stack on top
        // wellIdOrApi can be either a well ID (Airtable record ID) or an API number
        function openWellFromDocument(wellIdOrApi) {
            console.log('[openWellFromDocument] Called with:', wellIdOrApi);
            console.log('[openWellFromDocument] Current modal stack length:', modalStack.length);
            console.log('[openWellFromDocument] Modal stack:', modalStack.map(m => ({ type: m.type, id: m.id })));

            // Check if this looks like an API number (10+ digits, possibly with dashes)
            const isApiNumber = wellIdOrApi && /^\d{2}-?\d{3}-?\d{5}/.test(wellIdOrApi);
            let targetWellId = wellIdOrApi;

            if (isApiNumber) {
                console.log('[openWellFromDocument] Detected API number, searching in loadedWells');
                // Find the well by API number in loaded wells
                const matchedWell = loadedWells.find(w => w.apiNumber === wellIdOrApi);
                if (matchedWell) {
                    targetWellId = matchedWell.id;
                    console.log('[openWellFromDocument] Found well by API:', matchedWell.well_name, targetWellId);
                } else {
                    console.log('[openWellFromDocument] Well not in tracked wells, showing info message');
                    showToast('This well is not in your tracked wells list', 'info');
                    return;
                }
            }

            // Check if we've hit max depth
            if (modalStack.length >= MAX_MODAL_DEPTH) {
                console.log('[openWellFromDocument] Max depth reached, closing document modal first');
                // Close the document modal to make room
                closeDocumentDetailModal();
                // Give it time to close before opening well
                setTimeout(async () => {
                    await openWellDetailsModal(targetWellId);
                }, 100);
                return;
            }

            // Don't close the document modal - open well on top
            console.log('[openWellFromDocument] Opening well modal on top of document modal');
            setTimeout(async () => {
                await openWellDetailsModal(targetWellId);
            }, 50);
        }
        
        // Make functions available globally
        window.viewDocumentInModal = viewDocumentInModal;
        window.closeDocumentViewer = closeDocumentViewer;
        window.downloadCurrentDocument = downloadCurrentDocument;
        window.downloadDocument = downloadDocument;
        window.openDocumentDetail = openDocumentDetail;
        window.closeDocumentDetailModal = closeDocumentDetailModal;
        window.viewDocumentPDF = viewDocumentPDF;
        window.printDocumentSummary = printDocumentSummary;
        window.formatDocType = formatDocType;
        window.getConfidenceIndicator = getConfidenceIndicator;
        window.enableSaveButton = enableSaveButton;
        window.toggleObservations = toggleObservations;
        window.saveAndCloseDocumentNotes = saveAndCloseDocumentNotes;
        window.toggleSection = toggleSection;
        window.toggleConfidenceDetails = toggleConfidenceDetails;
        window.openPropertyFromDocument = openPropertyFromDocument;
        window.openWellFromDocument = openWellFromDocument;
        window.openWellFromProperty = openWellFromProperty;
        window.openPropertyFromWell = openPropertyFromWell;
        
        // Load Documents
        let documentPollInterval;
        let documentPollStartTime;
        let uploadBatchTimer;
        const POLL_INTERVAL = 15000; // 15 seconds
        const MAX_POLL_DURATION = 5 * 60 * 1000; // 5 minutes
        
        // Document Usage Tracking
        let currentUsageStats = null;
        // Track rolling credits baseline in localStorage so it persists across page refreshes
        let rollingCreditsBaseline = localStorage.getItem('rollingCreditsBaseline')
            ? parseInt(localStorage.getItem('rollingCreditsBaseline'), 10)
            : null;
        
        async function loadUsageStats() {
            try {
                const response = await fetch('/api/documents/usage');
                if (!response.ok) throw new Error('Failed to load usage stats');
                
                const data = await response.json();
                displayUsageStats(data);
            } catch (error) {
                console.error('Error loading usage stats:', error);
                // Don't show the tracker if we can't load stats
                document.getElementById('documentUsageTracker').style.display = 'none';
            }
        }
        
        function displayUsageStats(data) {
            currentUsageStats = data;
            const { usage, plan, credits } = data;
            const isLifetimeTier = usage.is_lifetime_tier;

            // Calculate values
            const monthlyUsed = usage.credits_used || 0;
            const monthlyLimit = usage.monthly_limit || 100;
            const monthlyRemaining = usage.monthly_remaining || 0;
            const rollingCredits = (usage.purchased_credits || 0) + (usage.permanent_credits || 0);
            const totalAvailable = usage.total_available || 0;

            // Update main credit display
            document.getElementById('creditsAvailable').textContent = totalAvailable.toLocaleString();

            // Format reset date
            const resetDate = new Date(usage.reset_date);
            const resetDateStr = resetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            // Update monthly row - show remaining
            document.getElementById('monthlyRemaining').textContent = monthlyRemaining;
            document.getElementById('monthlyStatus').textContent = isLifetimeTier ? 'Lifetime' : `Resets ${resetDateStr}`;

            // Update monthly progress bar - bar depletes as credits are used
            const monthlyBarFill = document.getElementById('monthlyBarFill');
            const monthlyPercentage = monthlyLimit > 0 ? Math.min(100, (monthlyRemaining / monthlyLimit) * 100) : 0;
            monthlyBarFill.style.width = monthlyPercentage + '%';

            // Color coding for monthly bar (when low)
            monthlyBarFill.classList.remove('warning', 'danger');
            if (monthlyRemaining === 0) {
                monthlyBarFill.classList.add('danger');
            } else if (monthlyRemaining <= monthlyLimit * 0.2) {
                monthlyBarFill.classList.add('warning');
            }

            // Update rolling row (only show if user has rolling credits)
            const rollingRow = document.getElementById('rollingRow');
            if (rollingCredits > 0) {
                rollingRow.style.display = 'grid';
                document.getElementById('rollingRemaining').textContent = rollingCredits.toLocaleString();

                // Track baseline on first load (or if credits increased, e.g., purchased more)
                if (rollingCreditsBaseline === null || rollingCredits > rollingCreditsBaseline) {
                    rollingCreditsBaseline = rollingCredits;
                    localStorage.setItem('rollingCreditsBaseline', rollingCredits.toString());
                }

                // If rolling credits hit 0, clear baseline so it resets on next purchase
                if (rollingCredits === 0 && rollingCreditsBaseline !== null) {
                    rollingCreditsBaseline = null;
                    localStorage.removeItem('rollingCreditsBaseline');
                }

                // Rolling bar - show percentage relative to baseline
                // This makes the bar deplete visually as rolling credits are used during the session
                const rollingBarFill = document.getElementById('rollingBarFill');
                const rollingPercentage = rollingCreditsBaseline > 0
                    ? Math.min(100, (rollingCredits / rollingCreditsBaseline) * 100)
                    : 0;
                rollingBarFill.style.width = rollingPercentage + '%';

                // Color coding for rolling bar (when low)
                rollingBarFill.classList.remove('warning', 'danger');
                if (rollingCredits === 0) {
                    rollingBarFill.classList.add('danger');
                } else if (rollingCredits <= rollingCreditsBaseline * 0.2) {
                    rollingBarFill.classList.add('warning');
                }
            } else {
                rollingRow.style.display = 'none';
            }

            // Legacy tooltip updates (for View details hover)
            const tooltipMonthlyUsed = document.getElementById('tooltipMonthlyUsed');
            const tooltipMonthlyLimit = document.getElementById('tooltipMonthlyLimit');
            const tooltipResetDate = document.getElementById('tooltipResetDate');
            const tooltipPurchasedRow = document.getElementById('tooltipPurchasedRow');
            const tooltipBonusRow = document.getElementById('tooltipBonusRow');

            if (tooltipMonthlyUsed) tooltipMonthlyUsed.textContent = monthlyUsed;
            if (tooltipMonthlyLimit) tooltipMonthlyLimit.textContent = monthlyLimit;
            if (tooltipResetDate) tooltipResetDate.textContent = isLifetimeTier ? 'never' : resetDateStr;

            // Show purchased credits in tooltip
            const purchasedCredits = usage.purchased_credits || 0;
            if (tooltipPurchasedRow) {
                if (purchasedCredits > 0) {
                    tooltipPurchasedRow.style.display = 'flex';
                    const tooltipPurchasedRemaining = document.getElementById('tooltipPurchasedRemaining');
                    if (tooltipPurchasedRemaining) tooltipPurchasedRemaining.textContent = purchasedCredits;
                } else {
                    tooltipPurchasedRow.style.display = 'none';
                }
            }

            // Show bonus credits in tooltip
            const permanentCredits = usage.permanent_credits || 0;
            if (tooltipBonusRow) {
                if (permanentCredits > 0) {
                    tooltipBonusRow.style.display = 'flex';
                    const tooltipBonusRemaining = document.getElementById('tooltipBonusRemaining');
                    if (tooltipBonusRemaining) tooltipBonusRemaining.textContent = permanentCredits;
                } else {
                    tooltipBonusRow.style.display = 'none';
                }
            }

            // Update total in tooltip (if element exists)
            const tooltipTotalAvailable = document.getElementById('tooltipTotalAvailable');
            if (tooltipTotalAvailable) tooltipTotalAvailable.textContent = usage.total_available || 0;

            // Show low credit warning if below 20% or out of credits
            showLowCreditWarning(usage, isLifetimeTier);

            // Document count will be updated by loadDocuments() to show actual inventory
        }

        function showLowCreditWarning(usage, isLifetimeTier) {
            const warningBanner = document.getElementById('lowCreditWarning');
            if (!warningBanner) return;

            const totalAvailable = usage.total_available || 0;
            const monthlyLimit = usage.monthly_limit || 1;

            // Calculate remaining percentage
            let remainingPct;
            if (isLifetimeTier) {
                const totalLifetime = (usage.credits_used || 0) + totalAvailable;
                remainingPct = totalLifetime > 0 ? (totalAvailable / totalLifetime * 100) : 0;
            } else {
                remainingPct = (totalAvailable / monthlyLimit * 100);
            }

            // Show warning if out of credits
            if (totalAvailable === 0) {
                warningBanner.style.display = 'block';
                warningBanner.className = 'credit-warning-banner danger';
                warningBanner.innerHTML = `
                    <span class="warning-icon">⚠️</span>
                    <span class="warning-text">You're out of credits. Documents won't be processed until you have credits available.</span>
                    <button type="button" onclick="openCreditPackModal()" class="btn-link warning-action">Buy More Credits</button>
                `;
            } else if (remainingPct <= 20) {
                // Show warning if below 20%
                warningBanner.style.display = 'block';
                warningBanner.className = 'credit-warning-banner warning';
                warningBanner.innerHTML = `
                    <span class="warning-icon">⚡</span>
                    <span class="warning-text">Low credits: ${totalAvailable} remaining${isLifetimeTier ? '' : ' this month'}.</span>
                    <button type="button" onclick="openCreditPackModal()" class="btn-link warning-action">Buy More</button>
                `;
            } else {
                warningBanner.style.display = 'none';
            }
        }
        
        function refreshUsageStats() {
            loadUsageStats();
        }

        // Called after document processing to update credits display
        // Can be called with a number (remaining credits) or without args to refresh
        function updateCreditsDisplay(creditsRemaining, refreshFromServer = false) {
            if (typeof creditsRemaining === 'number') {
                // Optimistic update: immediately show the new credit count
                const creditsEl = document.getElementById('creditsAvailable');
                if (creditsEl) creditsEl.textContent = creditsRemaining.toLocaleString();
            }
            // Only refresh from server when explicitly requested (e.g., when processing completes)
            // Don't refresh immediately after queuing - credit hasn't been deducted yet
            if (refreshFromServer) {
                loadUsageStats();
            }
        }
        
        // Auto-update usage after document processing
        function incrementLocalUsageCount() {
            if (currentUsageStats) {
                currentUsageStats.usage.docs_processed++;
                displayUsageStats(currentUsageStats);
            }
        }
        
        async function loadDocuments() {
            try {
                const res = await fetch('/api/documents');
                if (!res.ok) throw new Error('Failed to load documents');
                
                const data = await res.json();
                
                // Update total document count in the header
                const totalDocs = data.documents.filter(doc => !doc.deleted_at).length;
                if (document.getElementById('docCount')) {
                    document.getElementById('docCount').textContent = totalDocs;
                }
                
                // Check if any documents changed status
                const prevProcessing = loadedDocuments.filter(doc => 
                    doc.status === 'processing' || doc.status === 'pending'
                );
                
                const nowComplete = data.documents.filter(doc => {
                    const wasProcessing = prevProcessing.find(p => p.id === doc.id);
                    return wasProcessing && doc.status === 'complete';
                });
                
                // Show toast if documents completed
                if (nowComplete.length > 0) {
                    const message = nowComplete.length === 1
                        ? '1 document finished processing'
                        : `${nowComplete.length} documents finished processing`;
                    showToast(message, 'success');

                    // Refresh credit display after processing completes
                    loadUsageStats();
                }

                renderDocumentsList(data.documents);
                
                // Start or stop polling based on document status
                updateDocumentPolling();
                
            } catch (error) {
                console.error('Error loading documents:', error);
                document.getElementById('documentsContent').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading documents</p>
                        <p style="font-size: 13px; color: var(--slate-blue);">${error.message}</p>
                    </div>
                `;
            }
        }

        // Re-link unlinked documents to properties/wells
        async function relinkDocuments() {
            const btn = document.getElementById('relinkDocumentsBtn');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = `
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="spin">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Scanning...
                `;

                const res = await fetch('/api/documents/relink', { method: 'POST' });
                if (!res.ok) throw new Error('Failed to re-link documents');

                const result = await res.json();
                console.log('[Documents] Re-link result:', result);

                if (result.linked > 0) {
                    showToast(`Linked ${result.linked} document${result.linked > 1 ? 's' : ''} to properties/wells`, 'success');
                    // Reload documents to show updated links
                    await loadDocuments();
                } else if (result.total === 0) {
                    showToast('All documents are already linked', 'info');
                } else {
                    showToast('No new links found - documents may not match any properties', 'info');
                }

                // Update button visibility
                updateRelinkButtonVisibility();

            } catch (error) {
                console.error('Error re-linking documents:', error);
                showToast('Failed to re-link documents', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Show/hide re-link button based on unlinked document count
        function updateRelinkButtonVisibility() {
            const btn = document.getElementById('relinkDocumentsBtn');
            if (!btn) return;

            const unlinkedCount = loadedDocuments.filter(doc =>
                !doc.deleted_at &&
                doc.status === 'completed' &&
                !doc.property_id &&
                !doc.well_id
            ).length;

            btn.style.display = unlinkedCount > 0 ? 'inline-flex' : 'none';
            if (unlinkedCount > 0) {
                btn.title = `Re-scan ${unlinkedCount} unlinked document${unlinkedCount > 1 ? 's' : ''} for property/well matches`;
            }
        }

        // Make relinkDocuments available globally
        window.relinkDocuments = relinkDocuments;

        // Re-analyze selected documents
        async function bulkReanalyzeSelected() {
            const ids = Array.from(selectedDocuments);
            if (ids.length === 0) return;

            const enhanced = enhancedExtractionEnabled;
            const creditsEach = enhanced ? 2 : 1;
            const totalCredits = ids.length * creditsEach;
            const modeLabel = enhanced ? 'Enhanced' : 'Standard';

            const confirmed = await showConfirm(
                `Re-analyze <strong>${ids.length}</strong> document${ids.length > 1 ? 's' : ''}?<br><br>This will use <strong>${totalCredits} credit${totalCredits > 1 ? 's' : ''}</strong> (${modeLabel}).`,
                { title: 'Re-Analyze Documents', confirmText: `Re-Analyze (${totalCredits} credit${totalCredits > 1 ? 's' : ''})` }
            );
            if (!confirmed) return;

            try {
                const res = await fetch('/api/documents/reanalyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ document_ids: ids, enhanced })
                });

                if (res.status === 402) {
                    const err = await res.json();
                    showToast(err.error || 'Insufficient credits', 'error');
                    return;
                }
                if (!res.ok) throw new Error('Failed to re-analyze documents');

                const result = await res.json();
                showToast(`${result.queued} document${result.queued > 1 ? 's' : ''} queued for re-analysis`, 'success');
                clearSelection('documents');
                await loadDocuments();
                loadUsageStats();
            } catch (error) {
                console.error('Error re-analyzing documents:', error);
                showToast('Failed to re-analyze documents', 'error');
            }
        }
        window.bulkReanalyzeSelected = bulkReanalyzeSelected;


        // Manual document linking modal functions
        function openManualDocLinkModal(targetType, targetId) {
            console.log('[ManualLink] Opening modal for', targetType, targetId);

            // Store target info
            document.getElementById('manualDocLinkTargetType').value = targetType;
            document.getElementById('manualDocLinkTargetId').value = targetId;

            // Update subtitle
            const subtitle = document.getElementById('manualDocLinkSubtitle');
            subtitle.textContent = `Select a document to link to this ${targetType}`;

            // Get unlinked documents from loadedDocuments
            const unlinkedDocs = loadedDocuments.filter(doc =>
                !doc.deleted_at &&
                doc.status === 'completed' &&
                !doc.property_id &&
                !doc.well_id
            );

            const listEl = document.getElementById('manualDocLinkList');
            const emptyEl = document.getElementById('manualDocLinkEmpty');

            if (unlinkedDocs.length === 0) {
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
            } else {
                listEl.style.display = 'block';
                emptyEl.style.display = 'none';

                // Build list of documents
                let html = '';
                unlinkedDocs.forEach(doc => {
                    const category = doc.parsedExtractedData?.documentCategory || doc.category || 'Unknown';
                    const uploadDate = new Date(doc.upload_date).toLocaleDateString('en-US', { timeZone: 'America/Chicago' });

                    html += `
                        <div class="manual-link-doc-item" onclick="linkDocumentToTarget('${doc.id}')" style="padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 500; color: var(--oil-navy); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${doc.filename}</div>
                                    <div style="font-size: 12px; color: var(--slate-blue); margin-top: 2px;">
                                        ${category} &bull; ${uploadDate}
                                    </div>
                                </div>
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0; margin-left: 12px; color: var(--slate-blue);">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                </svg>
                            </div>
                        </div>
                    `;
                });
                listEl.innerHTML = html;
            }

            // Show modal
            const modal = document.getElementById('manualDocLinkModal');
            modal.style.cssText = 'display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 1000001 !important; background: rgba(0,0,0,0.5) !important; align-items: center !important; justify-content: center !important;';
        }

        function closeManualDocLinkModal() {
            document.getElementById('manualDocLinkModal').style.display = 'none';
        }

        async function linkDocumentToTarget(documentId) {
            const targetType = document.getElementById('manualDocLinkTargetType').value;
            const targetId = document.getElementById('manualDocLinkTargetId').value;

            console.log('[ManualLink] Linking document', documentId, 'to', targetType, targetId);

            try {
                const body = {};
                if (targetType === 'property') {
                    body.property_id = targetId;
                } else if (targetType === 'well') {
                    body.well_id = targetId;
                }

                const res = await fetch(`/api/documents/${documentId}/link`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Failed to link document');
                }

                showToast('Document linked successfully', 'success');
                closeManualDocLinkModal();

                // Refresh documents and the linked documents list
                await loadDocuments();

                // Refresh the linked documents section in the modal
                if (targetType === 'property') {
                    loadLinkedDocuments(targetId, 'property');
                } else if (targetType === 'well') {
                    loadLinkedDocuments(targetId, 'well');
                }

            } catch (error) {
                console.error('[ManualLink] Error:', error);
                showToast(error.message || 'Failed to link document', 'error');
            }
        }

        // Make manual link functions globally available
        window.openManualDocLinkModal = openManualDocLinkModal;
        window.closeManualDocLinkModal = closeManualDocLinkModal;
        window.linkDocumentToTarget = linkDocumentToTarget;

        // Close manual doc link modal when clicking outside (deferred until DOM ready)
        document.addEventListener('DOMContentLoaded', () => {
            const manualDocModal = document.getElementById('manualDocLinkModal');
            if (manualDocModal) {
                manualDocModal.addEventListener('click', e => {
                    if (e.target.id === 'manualDocLinkModal') closeManualDocLinkModal();
                });
            }
        });

        function startDocumentPolling() {
            if (documentPollInterval) return; // Already polling
            
            console.log('[Documents] Starting polling for processing documents');
            documentPollStartTime = Date.now();
            
            documentPollInterval = setInterval(async () => {
                // Check guardrails
                const isDocumentsTabActive = currentTab === 'documents';
                const isTabVisible = !document.hidden;
                const hasProcessing = loadedDocuments.some(doc => 
                    doc.status === 'processing' || doc.status === 'pending'
                );
                const notExpired = (Date.now() - documentPollStartTime) < MAX_POLL_DURATION;
                
                if (isDocumentsTabActive && isTabVisible && hasProcessing && notExpired) {
                    console.log('[Documents] Polling for updates...');
                    await loadDocuments();
                } else {
                    console.log('[Documents] Stopping poll:', {
                        isDocumentsTabActive,
                        isTabVisible,
                        hasProcessing,
                        notExpired
                    });
                    stopDocumentPolling();
                }
            }, POLL_INTERVAL);
        }
        
        function stopDocumentPolling() {
            if (documentPollInterval) {
                console.log('[Documents] Stopping document polling');
                clearInterval(documentPollInterval);
                documentPollInterval = null;
                documentPollStartTime = null;
            }
        }
        
        function updateDocumentPolling() {
            const hasProcessing = loadedDocuments.some(doc => 
                doc.status === 'processing' || doc.status === 'pending'
            );
            
            if (hasProcessing && currentTab === 'documents' && !document.hidden) {
                startDocumentPolling();
            } else {
                stopDocumentPolling();
            }
        }
        
        // Debounced polling start for bulk uploads
        function onDocumentUploaded() {
            // Reset timer with each upload
            clearTimeout(uploadBatchTimer);
            
            // Start polling 3 seconds after the LAST upload completes
            uploadBatchTimer = setTimeout(() => {
                if (currentTab === 'documents') {
                    updateDocumentPolling();
                }
            }, 3000);
        }
        
        function renderDocumentsList(documents) {
            // Parse extracted_data JSON for each document if it exists
            if (documents && documents.length > 0) {
                documents = documents.map(doc => {
                    if (doc.extracted_data && typeof doc.extracted_data === 'string') {
                        try {
                            doc.parsedExtractedData = JSON.parse(doc.extracted_data);
                        } catch (e) {
                            console.log('Failed to parse extracted_data for doc', doc.id);
                            doc.parsedExtractedData = {};
                        }
                    } else {
                        doc.parsedExtractedData = doc.extracted_data || {};
                    }
                    return doc;
                });
            }
            
            loadedDocuments = documents;
            const container = document.getElementById('documentsContent');
            
            const hasSearch = currentUser?.plan !== 'Free';

            // Apply filter and sort via controller pipeline
            let displayDocuments = documents;
            if (hasSearch && documents && documents.length > 0) {
                displayDocuments = documentsController.applyPipeline(documents);
                documentsController.updateCount(displayDocuments.length, documents.length, 'documentsResultsCount');
            }
            
            // Handle empty states
            if (!documents || documents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 60px 20px;">
                        <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 16px; opacity: 0.3;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p style="font-size: 18px; font-weight: 600; color: var(--oil-navy); margin-bottom: 8px;">No documents yet</p>
                        <p style="font-size: 14px; color: var(--slate-blue);">Click the "Upload Documents" button above to get started</p>
                    </div>
                `;
                return;
            }
            
            if (displayDocuments.length === 0 && documents.length > 0) {
                // No search results
                container.innerHTML = '<div class="empty-state"><p>No documents match your search or filter.</p></div>';
                return;
            }
            
            // Build table like properties/wells
            let html = '<table class="data-table"><thead><tr>';
            html += '<th class="bulk-only"><input type="checkbox" id="selectAllDocuments" title="Select all"></th>';
            html += '<th>Filename</th><th>Category</th><th>County</th><th>Status</th><th>Uploaded</th><th style="text-align: right;">Actions</th>';
            html += '</tr></thead><tbody>';
            
            displayDocuments.forEach(doc => {
                const uploadDate = new Date(doc.upload_date).toLocaleDateString('en-US', { timeZone: 'America/Chicago' });

                // Calculate confidence score for complete documents
                let confidenceScore = null;
                if (doc.status === 'complete' && doc.parsedExtractedData?.field_scores) {
                    confidenceScore = calculateOverallScore(doc.parsedExtractedData.field_scores);
                }

                // Derive status display from confidence when complete
                let statusColor, statusText, statusClass;
                if (doc.status === 'complete') {
                    if (confidenceScore !== null && confidenceScore < 0.70) {
                        // Low confidence - needs review
                        statusColor = '#D97706';
                        statusText = 'Review';
                        statusClass = 'manual_review';
                    } else {
                        statusColor = 'var(--success)';
                        statusText = 'Complete';
                        statusClass = 'complete';
                    }
                } else if (doc.status === 'failed') {
                    statusColor = 'var(--error)';
                    statusText = 'Failed';
                    statusClass = 'failed';
                } else if (doc.status === 'manual_review') {
                    statusColor = '#D97706';
                    statusText = 'Review';
                    statusClass = 'manual_review';
                } else if (doc.status === 'pending') {
                    statusColor = '#F59E0B';
                    statusText = 'Queued';
                    statusClass = 'pending';
                } else {
                    statusColor = '#F59E0B';
                    statusText = 'Processing';
                    statusClass = 'processing';
                }

                // Add pulsing animation for processing documents
                const statusStyle = (doc.status === 'processing' || doc.status === 'pending')
                    ? 'animation: pulse 1.5s ease-in-out infinite;'
                    : '';

                html += `<tr onclick="openDocumentDetail('${doc.id}')" style="cursor: pointer;">`;
                html += `<td class="bulk-only" onclick="event.stopPropagation()"><input type="checkbox" class="document-checkbox" data-id="${doc.id}"></td>`;
                html += `<td><strong>${escapeHtml(doc.display_name || doc.filename)}</strong></td>`;
                html += `<td>${(doc.category || doc.doc_type) ? formatDocType(doc.category || doc.doc_type) : '<em style="color: #A0AEC0;">—</em>'}</td>`;
                // Check doc.county first, then fall back to extracted_data.county
                // For deeds, county is nested in tracts[0].legal.county
                // Don't show county for multi_document parents (their county is often wrong - use children's counties instead)
                const isParentMultiDoc = doc.doc_type === 'multi_document' || doc.category === 'multi_document';
                let displayCounty = null;
                if (!isParentMultiDoc) {
                    displayCounty = doc.county
                        || doc.parsedExtractedData?.county
                        || doc.parsedExtractedData?.tracts?.[0]?.legal?.county  // Deed schema
                        || doc.parsedExtractedData?.recording?.county;  // Recording info fallback
                }
                html += `<td>${displayCounty ? escapeHtml(displayCounty) : '<em style="color: #A0AEC0;">—</em>'}</td>`;
                // Status: text badge for desktop, dot for mobile
                // Show confidence % for complete documents
                const confidenceDisplay = (doc.status === 'complete' && confidenceScore !== null)
                    ? ` <span style="opacity: 0.7; font-weight: 500;">${Math.round(confidenceScore * 100)}%</span>`
                    : '';
                const dotTitle = (doc.status === 'complete' && confidenceScore !== null)
                    ? `${statusText} (${Math.round(confidenceScore * 100)}% confidence)`
                    : statusText;
                // Extraction mode badge (STD/AI+) for completed docs
                let extractionBadge = '';
                if (doc.status === 'complete' || doc.status === 'completed' || doc.status === 'manual_review') {
                    if (doc.enhanced_extraction === 1) {
                        extractionBadge = ' <span class="status-text" style="padding: 1px 6px; border-radius: 8px; font-size: 10px; font-weight: 700; background: #EDE9FE; color: #7C3AED; margin-left: 4px;" title="Enhanced extraction (Opus)">AI+</span>';
                    } else {
                        extractionBadge = ' <span class="status-text" style="padding: 1px 6px; border-radius: 8px; font-size: 10px; font-weight: 700; background: #FEF3C7; color: #92400E; margin-left: 4px;" title="Standard extraction">STD</span>';
                    }
                }
                html += `<td>
                    <span class="status-text" style="padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${statusColor}20; color: ${statusColor}; ${statusStyle}">${statusText}${confidenceDisplay}</span>${extractionBadge}
                    <span class="status-dot ${statusClass}" title="${dotTitle}"></span>
                </td>`;
                html += `<td>${uploadDate}</td>`;
                html += `<td style="text-align: right;" onclick="event.stopPropagation()">
                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button onclick="viewDocumentInModal('${doc.id}', '${escapeHtml(doc.display_name || doc.filename)}', false, '${doc.content_type || 'application/pdf'}', ${doc.rotation_applied || 0})" title="View" class="btn-action-icon" style="background: #E0F2FE; color: #1E40AF;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                        <button onclick="downloadDocument('${doc.id}')" title="Download" class="btn-action-icon">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </button>
                    </div>
                </td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Add select all checkbox handler
            const selectAllCheckbox = document.getElementById('selectAllDocuments');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', (e) => {
                    selectAllItems('documents', e.target.checked);
                });
            }

            // Update re-link button visibility based on unlinked documents
            updateRelinkButtonVisibility();
        }
/* __SPLIT_DOCS_B__ */
        // Linked Documents Functions
        function toggleLinkedDocuments(type) {
            const content = document.getElementById(type === 'property' ? 'linked-documents-content' : 'linked-documents-content-well');
            const arrow = document.getElementById(type === 'property' ? 'linked-documents-arrow' : 'linked-documents-arrow-well');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        async function loadLinkedDocuments(id, type, apiNumber = null) {
            console.log(`[LinkedDocuments] Loading linked documents for ${type}:`, id, apiNumber ? `(API: ${apiNumber})` : '');
            
            const countEl = document.getElementById(type === 'property' ? 'property-linked-documents-count' : 'well-linked-documents-count');
            const listEl = document.getElementById(type === 'property' ? 'linked-documents-list' : 'linked-documents-list-well');
            const emptyEl = document.getElementById(type === 'property' ? 'linked-documents-empty' : 'linked-documents-empty-well');
            
            // Show loading state
            countEl.textContent = '—';
            listEl.innerHTML = '<div style="padding: 12px; color: #6b7280;">Loading documents...</div>';
            listEl.style.display = 'block';
            emptyEl.style.display = 'none';
            
            try {
                // Build URL with api_number parameter for wells
                let url = `/api/${type}/${id}/linked-documents`;
                if (type === 'well' && apiNumber) {
                    url += `?api_number=${encodeURIComponent(apiNumber)}`;
                }
                
                const response = await fetch(url, { credentials: 'include' });
                const data = await response.json();
                
                const docCount = data.documents?.length || 0;
                console.log(`[LinkedDocuments] Setting count to:`, docCount);
                countEl.textContent = String(docCount);
                
                if (!data.documents || data.documents.length === 0) {
                    listEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                } else {
                    listEl.innerHTML = data.documents.map(doc => {
                        const uploadDate = doc.uploadDate ? new Date(doc.uploadDate).toLocaleDateString('en-US', { timeZone: 'America/Chicago' }) : 'Unknown';
                        return `
                            <div class="linked-document-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6;">
                                <div style="flex: 1; cursor: pointer;" onclick="openDocumentDetail('${doc.id}')">
                                    <div style="font-weight: 500; color: #2563eb;">${escapeHtml(doc.displayName)}</div>
                                    <div style="font-size: 12px; color: #6b7280;">${escapeHtml(doc.docType)} • ${uploadDate}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    listEl.style.display = 'block';
                    emptyEl.style.display = 'none';
                }
            } catch (error) {
                console.error(`Failed to load linked documents for ${type}:`, error);
                countEl.textContent = '0';
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
            }
        }
/* __SPLIT_DOCS_C__ */
        // Expose functions globally for onclick handlers
        window.toggleLinkedDocuments = toggleLinkedDocuments;
