<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account - Mineral Watch</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --oil-navy: #1C2B36; --slate-blue: #334E68; --red-dirt: #C05621; --red-dirt-dark: #9C4215; --paper: #F8F9FA; --border: #E2E8F0; --success: #03543F; --success-bg: #DEF7EC; --error: #DC2626; --error-bg: #FEE2E2; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: var(--oil-navy); background: #F7FAFC; min-height: 100vh; }
        h1, h2, .logo { font-family: 'Merriweather', serif; }
        header { background: var(--oil-navy); padding: 15px 0; color: white; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 25px; }
        .header-inner { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: 900; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 25px; }
        .nav-links a { color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; font-size: 14px; }
        .nav-links a:hover, .nav-links a.active { color: white; }
        .user-menu { display: flex; align-items: center; gap: 15px; }
        .user-name { font-size: 14px; color: rgba(255,255,255,0.8); }
        .btn-logout { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer; }
        .menu-toggle { display: none; background: none; border: none; cursor: pointer; padding: 8px; color: white; }
        main { padding: 40px 0; }
        .page-header h1 { font-size: 28px; margin-bottom: 30px; }
        .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 25px; }
        .card.full { grid-column: span 2; }
        .card h2 { font-size: 18px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .info-row:last-of-type { border-bottom: none; }
        .info-label { font-size: 14px; color: var(--slate-blue); }
        .info-value { font-size: 14px; font-weight: 600; }
        .plan-badge { background: var(--success-bg); color: var(--success); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .plan-badge.free { background: #E2E8F0; color: var(--slate-blue); }
        .btn { display: inline-block; padding: 12px 20px; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer; text-decoration: none; border: none; margin-top: 20px; }
        .btn-secondary { background: white; color: var(--oil-navy); border: 1px solid var(--border); }
        .btn-primary { background: var(--red-dirt); color: white; }
        .features { margin: 20px 0; list-style: none; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .features li { padding: 8px 0 8px 25px; position: relative; font-size: 14px; color: var(--slate-blue); }
        .features li::before { content: '✓'; position: absolute; left: 0; color: var(--success); font-weight: bold; }
        @media (max-width: 1024px) { .features { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 640px) { .features { grid-template-columns: 1fr; } }
        .upgrade-box { background: var(--paper); border-radius: 6px; padding: 20px; margin-top: 20px; }
        .upgrade-box p { font-size: 14px; color: var(--slate-blue); margin-bottom: 15px; }
        /* Organization Styles */
        .member-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .member-row:last-child { border-bottom: none; }
        .member-info { flex: 1; }
        .member-name { font-size: 14px; font-weight: 600; display: block; }
        .member-email { font-size: 13px; color: var(--slate-blue); display: block; margin-top: 2px; }
        .member-role { background: var(--paper); color: var(--slate-blue); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 10px; }
        .member-role.admin { background: var(--success-bg); color: var(--success); }
        .member-actions { display: flex; gap: 10px; align-items: center; }
        .btn-text { background: none; border: none; color: var(--red-dirt); font-size: 13px; cursor: pointer; padding: 4px 8px; }
        .btn-text:hover { text-decoration: underline; }
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal { background: white; border-radius: 8px; padding: 25px; max-width: 450px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--oil-navy); }
        .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--red-dirt); }
        .form-hint { font-size: 12px; color: var(--slate-blue); margin-top: 4px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }
        
        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 16px 20px;
            margin-bottom: 12px;
            min-width: 300px;
            max-width: 400px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            pointer-events: auto;
            border-left: 4px solid var(--slate-blue);
        }
        
        .toast.success {
            border-left-color: var(--success);
        }
        
        .toast.error {
            border-left-color: var(--error);
        }
        
        .toast-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .toast.success .toast-icon {
            background: var(--success-bg);
            color: var(--success);
        }
        
        .toast.error .toast-icon {
            background: var(--error-bg);
            color: var(--error);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
            color: var(--oil-navy);
        }
        
        .toast-message {
            font-size: 13px;
            color: var(--slate-blue);
        }
        
        .toast-close {
            flex-shrink: 0;
            background: none;
            border: none;
            color: var(--slate-blue);
            cursor: pointer;
            padding: 0;
            font-size: 18px;
            line-height: 1;
            opacity: 0.7;
            margin-left: 8px;
        }
        
        .toast-close:hover {
            opacity: 1;
        }
        
        .toast.hiding {
            animation: slideOut 0.3s ease-in forwards;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        .btn-cancel { padding: 10px 20px; border: 1px solid var(--border); background: white; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn-cancel:hover { background: var(--paper); }
        /* Alert Preference Toggles */
        .pref-toggle { display: flex; align-items: flex-start; gap: 12px; padding: 15px; background: white; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .pref-toggle:hover { border-color: var(--red-dirt); background: #FFFAF5; }
        .pref-toggle input { display: none; }
        .pref-slider { position: relative; width: 44px; height: 24px; background: #CBD5E1; border-radius: 12px; flex-shrink: 0; transition: background 0.2s; }
        .pref-slider::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .pref-toggle input:checked + .pref-slider { background: var(--success); }
        .pref-toggle input:checked + .pref-slider::after { transform: translateX(20px); }
        .pref-content { flex: 1; }
        .pref-title { display: block; font-weight: 600; font-size: 14px; color: var(--oil-navy); margin-bottom: 2px; }
        .pref-desc { display: block; font-size: 12px; color: var(--slate-blue); line-height: 1.4; }
        footer { background: var(--oil-navy); color: #A0AEC0; padding: 20px 0; font-size: 13px; text-align: center; }
        @media (max-width: 768px) {
            .cards { grid-template-columns: 1fr; }
            .card.full { grid-column: span 1; }
            .container { padding: 0 15px; }

            /* Mobile hamburger navigation */
            header { position: relative; z-index: 1000; }
            .menu-toggle { display: block; }
            .header-inner { flex-wrap: wrap; }
            .nav-links, .user-menu { display: none; width: 100%; }
            .nav-links.open, .user-menu.open { display: flex; }
            .nav-links { flex-direction: column; gap: 0; padding: 15px 0 5px; border-top: 1px solid rgba(255,255,255,0.15); order: 3; }
            .nav-links a { padding: 12px 0; font-size: 15px; }
            .user-menu.open { padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.1); justify-content: space-between; order: 4; }
            
            /* Organization section mobile styles */
            .org-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 15px;
            }
            
            .member-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 15px 0;
            }
            
            .member-actions {
                flex-wrap: wrap;
                width: 100%;
                justify-content: flex-start;
            }
            
            .member-role {
                order: -1;
                margin-bottom: 5px;
            }
            
            .btn-text {
                font-size: 12px;
                padding: 2px 6px;
            }
            
            #orgName {
                font-size: 18px !important;
            }
            
            .btn-primary {
                font-size: 13px;
                padding: 8px 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>
    <header>
        <div class="container">
            <div class="header-inner">
                <a href="/" class="logo">Mineral Watch</a>
                <button class="menu-toggle" aria-label="Menu">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
                <nav class="nav-links">
                    <a href="/portal">Dashboard</a>
                    <a href="/portal/map">Map</a>
                    <a href="/portal/intelligence">Intelligence</a>
                    <a href="/portal/account" class="active">Account</a>
                    <a href="/portal/learn">Learn</a>
                </nav>
                <div class="user-menu">
                    <span class="user-name" id="userName">Loading...</span>
                    <button class="btn-logout" id="logoutBtn">Log Out</button>
                </div>
            </div>
        </div>
    </header>
    <script>document.querySelector('.menu-toggle').addEventListener('click',function(){document.querySelector('.nav-links').classList.toggle('open');document.querySelector('.user-menu').classList.toggle('open');});</script>
    <main>
        <div class="container">
            <div class="page-header"><h1>Account Settings</h1></div>
            <div class="cards">
                <div class="card">
                    <h2>Profile</h2>
                    <div class="info-row"><span class="info-label">Name</span><span class="info-value" id="profileName">—</span></div>
                    <div class="info-row">
                        <span class="info-label">Email</span>
                        <span class="info-value" style="display: flex; align-items: center; gap: 10px;">
                            <span id="profileEmail">—</span>
                            <!-- Email change feature hidden for now - too complex with orgs/stripe -->
                            <!-- <button class="btn-text" onclick="showChangeEmailModal()" style="font-size: 12px; padding: 2px 8px;">Change</button> -->
                        </span>
                    </div>
                </div>
                <div class="card">
                    <h2>Subscription</h2>
                    <div class="info-row"><span class="info-label">Plan</span><span class="plan-badge" id="currentPlan">Loading...</span></div>
                    <div class="info-row"><span class="info-label">Properties</span><span class="info-value"><span id="propItems">0</span> / <span id="propLimit">1</span></span></div>
                    <div class="info-row"><span class="info-label">Wells</span><span class="info-value"><span id="wellItems">0</span> / <span id="wellLimit">0</span></span></div>
                    <div class="info-row"><span class="info-label">Status</span><span class="info-value" id="status">—</span></div>
                    <div class="billing-actions" id="billingActions" style="margin-top: 20px;">
                        <div style="margin-bottom: 10px; text-align: center;" id="changePlanSection">
                            <a href="/portal/upgrade" class="btn btn-primary" style="width: 100%;">
                                Change Plan
                            </a>
                        </div>
                        <button class="btn btn-secondary" id="manageBtn" style="width: 100%;">Manage Subscription</button>
                        <p class="billing-hint" id="billingHint" style="display:none; margin: 8px 0 0 0; font-size: 12px; color: var(--slate-blue); text-align: center;">
                            Update payment method, download invoices, or cancel
                        </p>
                    </div>
                </div>
                <!-- Alert Preferences -->
                <div class="card full">
                    <h2>Alert Preferences</h2>
                    <p style="color: var(--slate-blue); font-size: 14px; margin-bottom: 20px;">
                        Choose which types of alerts you want to receive. Changes apply to future alerts only.
                    </p>

                    <!-- Notification Delivery Mode -->
                    <div id="notificationModeSection" style="margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: var(--oil-navy);">How would you like to receive alerts?</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-start;">
                            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 250px; max-width: 400px;">
                                <select id="prefNotificationMode" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px;">
                                    <option value="Use Org Default">Use Organization Default</option>
                                    <option value="Daily + Weekly">Daily Updates + Weekly Report (Recommended)</option>
                                    <option value="Daily Digest">Daily Updates Only</option>
                                    <option value="Weekly Report">Weekly Report Only</option>
                                    <option value="None">None - No notifications</option>
                                </select>
                                <p id="notificationModeHint" style="font-size: 12px; color: var(--slate-blue); margin-top: 6px;">
                                    Daily updates arrive each morning with your property alerts. Weekly reports include regional activity.
                                </p>
                            </div>
                        </div>
                    </div>

                    <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 15px; color: var(--oil-navy);">Alert Types</h4>
                    <div class="preferences-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <label class="pref-toggle">
                            <input type="checkbox" id="prefPermits" checked>
                            <span class="pref-slider"></span>
                            <div class="pref-content">
                                <span class="pref-title">New Drilling Permits</span>
                                <span class="pref-desc">When operators file permits near your properties</span>
                            </div>
                        </label>
                        <label class="pref-toggle">
                            <input type="checkbox" id="prefCompletions" checked>
                            <span class="pref-slider"></span>
                            <div class="pref-content">
                                <span class="pref-title">Well Completions</span>
                                <span class="pref-desc">When wells finish drilling and start producing</span>
                            </div>
                        </label>
                        <label class="pref-toggle">
                            <input type="checkbox" id="prefStatusChanges" checked>
                            <span class="pref-slider"></span>
                            <div class="pref-content">
                                <span class="pref-title">Status Changes</span>
                                <span class="pref-desc">When wells are plugged, shut in, or reactivated</span>
                            </div>
                        </label>
                        <div class="pref-toggle-group">
                            <label class="pref-toggle" style="border-bottom-left-radius: 0; border-bottom-right-radius: 0; border-bottom: none;">
                                <input type="checkbox" id="prefExpirations" checked onchange="toggleExpirationDays()">
                                <span class="pref-slider"></span>
                                <div class="pref-content">
                                    <span class="pref-title">Permit Expirations</span>
                                    <span class="pref-desc">When permits approach their 1-year expiration</span>
                                </div>
                            </label>
                            <div class="expiration-days-setting" id="expirationDaysSetting" style="display: flex; align-items: center; gap: 10px; padding: 12px 15px 12px 71px; background: var(--paper); border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px;">
                                <span style="font-size: 13px; color: var(--slate-blue);">Warn me before expiration:</span>
                                <select id="prefExpirationDays" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: white;">
                                    <option value="7">7 days</option>
                                    <option value="14">14 days</option>
                                    <option value="30" selected>30 days</option>
                                    <option value="60">60 days</option>
                                    <option value="90">90 days</option>
                                </select>
                            </div>
                        </div>
                        <label class="pref-toggle">
                            <input type="checkbox" id="prefTransfers" checked>
                            <span class="pref-slider"></span>
                            <div class="pref-content">
                                <span class="pref-title">Operator Transfers</span>
                                <span class="pref-desc">When well ownership changes to a new operator</span>
                            </div>
                        </label>
                    </div>
                    <button class="btn btn-primary" id="savePrefsBtn" onclick="savePreferences()">Save Preferences</button>
                    <span id="prefsSaveStatus" style="margin-left: 15px; font-size: 14px; color: var(--success); display: none;">✓ Saved</span>
                </div>

                <!-- Organization Section - Only shown for Professional/Enterprise -->
                <div class="card full" id="organizationSection" style="display:none;">
                    <h2>Organization</h2>
                    <div class="org-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <div class="org-info">
                            <h3 id="orgName" style="margin: 0; font-size: 20px;">Loading...</h3>
                            <p class="org-plan" style="margin: 5px 0 0 0; color: var(--slate-blue); font-size: 14px;">
                                <span id="orgPlan">—</span> • <span id="memberCount">0</span> members
                            </p>
                        </div>
                        <button class="btn btn-primary" id="inviteMemberBtn" style="display:none;">Invite Member</button>
                    </div>
                    
                    <div class="members-section">
                        <h4 style="font-size: 16px; margin-bottom: 15px; color: var(--slate-blue);">Members</h4>
                        <div id="membersList" class="members-list">
                            <div style="text-align: center; padding: 20px; color: var(--slate-blue);">
                                Loading members...
                            </div>
                        </div>
                    </div>

                    <!-- Organization Notification Settings (Admin only) -->
                    <div class="notification-settings-section" id="orgNotificationSettings" style="display: none; margin-top: 30px; padding-top: 25px; border-top: 1px solid var(--border);">
                        <h4 style="font-size: 16px; margin-bottom: 15px; color: var(--slate-blue);">Team Notification Settings</h4>
                        <p style="color: var(--slate-blue); font-size: 13px; margin-bottom: 20px;">
                            Configure how team members receive alert notifications. Members can override this if allowed.
                        </p>
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start;">
                            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                                <label for="orgNotificationMode" style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Default Notification Mode</label>
                                <select id="orgNotificationMode" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px;">
                                    <option value="Daily + Weekly">Daily Updates + Weekly Report (Recommended)</option>
                                    <option value="Daily Digest">Daily Updates Only</option>
                                    <option value="Weekly Report">Weekly Report Only</option>
                                    <option value="None">None - No notifications</option>
                                </select>
                            </div>
                            <div style="flex: 0 0 auto; padding-top: 25px;">
                                <label class="pref-toggle" style="cursor: pointer;">
                                    <input type="checkbox" id="orgAllowOverride" checked>
                                    <span class="pref-slider"></span>
                                    <div class="pref-content">
                                        <span class="pref-title">Allow Member Override</span>
                                        <span class="pref-desc">Let members choose their own preference</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="saveOrgSettingsBtn" onclick="saveOrganizationSettings()" style="margin-top: 20px;">Save Team Settings</button>
                        <span id="orgSettingsSaveStatus" style="margin-left: 15px; font-size: 14px; color: var(--success); display: none;"></span>
                    </div>
                </div>
                <div class="card full">
                    <h2>Your Plan Features</h2>
                    <ul class="features" id="features"><li>Loading...</li></ul>
                </div>
            </div>
        </div>
    </main>
    <footer><div class="container">&copy; 2025 Mineral Watch</div></footer>
    <script>
        // Toast Notification System
        function showToast(message, type = 'info', title = null) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const iconMap = {
                success: '✓',
                error: '✕',
                info: 'i'
            };
            
            const titleMap = {
                success: 'Success',
                error: 'Error',
                info: 'Info'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${iconMap[type] || iconMap.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title || titleMap[type] || titleMap.info}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="closeToast(this)">×</button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    closeToast(toast.querySelector('.toast-close'));
                }
            }, 5000);
        }
        
        function closeToast(button) {
            const toast = button.closest('.toast');
            toast.classList.add('hiding');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }
        
        // Make functions available globally
        window.showToast = showToast;
        window.closeToast = closeToast;
        
        const planConfigs = {
            'Free': { properties: 1, wells: 1, members: 1, features: ['1 property', '1 well', '3 document credits/month', 'Adjacent monitoring', 'Daily scans', 'Email alerts'] },
            'Starter': { properties: 10, wells: 10, members: 1, features: ['10 properties', '10 wells', '10 document credits/month', 'Adjacent monitoring', 'Daily scans', 'Email alerts', 'Email support'] },
            'Standard': { properties: 50, wells: 50, members: 1, features: ['50 properties', '50 wells', '25 document credits/month', 'Adjacent monitoring', 'Daily scans', 'Priority support', 'Export data', 'Free copy of The Mineral Rights Guide'] },
            'Professional': { properties: 250, wells: 250, members: 1, features: ['250 properties', '250 wells', '50 document credits/month', 'Adjacent monitoring', 'Daily scans', 'Priority support', 'Bulk upload', 'Export data', 'Organization management', 'Free copy of The Mineral Rights Guide'] },
            'Business': { properties: 500, wells: 500, members: 3, features: ['500 properties', '500 wells', '100 document credits/month', '3 team members', 'Adjacent monitoring', 'Daily scans', 'Priority support', 'Dedicated support', 'Export data', 'Free copy of The Mineral Rights Guide'] },
            'Enterprise 1K': { properties: 1000, wells: 1000, members: 5, features: ['1,000 properties', '1,000 wells', '150 document credits/month', '5+ team members', 'All features', 'Dedicated support', 'Export data', 'Free copy of The Mineral Rights Guide'] }
        };
        
        let currentUser = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/auth/me');
                if (!res.ok) { window.location.href = '/portal/login'; return; }
                currentUser = await res.json();
                const plan = currentUser.plan || 'Free';
                const config = planConfigs[plan] || planConfigs['Free'];
                
                document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                document.getElementById('profileName').textContent = currentUser.name || '—';
                document.getElementById('profileEmail').textContent = currentUser.email;
                document.getElementById('currentPlan').textContent = plan;
                document.getElementById('currentPlan').classList.toggle('free', plan === 'Free');
                document.getElementById('propLimit').textContent = config.properties === Infinity ? '∞' : config.properties;
                document.getElementById('wellLimit').textContent = config.wells === Infinity ? '∞' : config.wells;
                document.getElementById('status').textContent = currentUser.status || 'Active';
                document.getElementById('features').innerHTML = config.features.map(f => '<li>' + f + '</li>').join('');
                
                // Update manage button based on plan
                const manageBtn = document.getElementById('manageBtn');
                const billingHint = document.getElementById('billingHint');
                const changePlanSection = document.getElementById('changePlanSection');
                const billingActions = document.getElementById('billingActions');
                
                // Only hide for Free users without any billing history
                if (plan === 'Free' && !currentUser.stripeCustomerId) {
                    billingActions.style.display = 'none';
                } else if (plan !== 'Free') {
                    // Show everything for paid users
                    billingActions.style.display = 'block';
                    manageBtn.innerHTML = 'Manage Billing or Cancel Subscription';
                    billingHint.style.display = 'block';
                    // Hide change plan for Enterprise users
                    if (plan.startsWith('Enterprise')) {
                        changePlanSection.style.display = 'none';
                    }
                } else {
                    // Free users with billing history
                    billingActions.style.display = 'block';
                    manageBtn.innerHTML = 'Manage Billing';
                    billingHint.style.display = 'none';
                    changePlanSection.innerHTML = '<a href="/portal/upgrade" class="btn btn-primary" style="width: 100%;">Upgrade Plan</a>';
                }
                
                // Get counts
                const [propsRes, wellsRes] = await Promise.all([
                    fetch('/api/properties'),
                    fetch('/api/wells')
                ]);
                if (propsRes.ok && wellsRes.ok) {
                    const props = await propsRes.json();
                    const wells = await wellsRes.json();
                    document.getElementById('propItems').textContent = props.length;
                    document.getElementById('wellItems').textContent = wells.length;
                }
                
                // Check if user has organization (Business/Professional/Enterprise plans)
                if (plan === 'Business' || plan === 'Professional' || plan.startsWith('Enterprise')) {
                    await loadOrganization();
                }

                // Load alert preferences
                loadAlertPreferences(currentUser);
            } catch { window.location.href = '/portal/login'; }
            
            // Set up manage button
            const manageBtn = document.getElementById('manageBtn');
            if (manageBtn) {
                manageBtn.addEventListener('click', async () => {
                    try {
                        const res = await fetch('/api/billing/portal', { method: 'POST' });
                        if (res.ok) {
                            const { url } = await res.json();
                            window.location.href = url;
                        } else { showToast('Unable to open billing portal.', 'error'); }
                    } catch { showToast('Error connecting to billing.', 'error'); }
                });
            }
            
            // Set up logout button
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/portal/login';
            });
            
            // Expose functions for onclick handlers
            window.resendInvitation = resendInvitation;
            
            // Set up invite member functionality
            setupInviteModal();
            
            // Change Role Form Handler
            document.getElementById('changeRoleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const newRole = document.getElementById('newRole').value;
                if (!newRole || !changeRoleMemberId) return;
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                
                try {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Changing...';
                    
                    const response = await fetch(`/api/organization/members/${changeRoleMemberId}/role`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify({ role: newRole })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showToast('Role updated successfully!', 'success');
                        closeChangeRoleModal();
                        // Reload organization to show updated role
                        loadOrganization();
                    } else {
                        showToast(data.error || 'Failed to update role', 'error');
                    }
                } catch (error) {
                    console.error('Error updating role:', error);
                    showToast('Failed to update role. Please try again.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        });
        
        async function loadOrganization() {
            const orgSection = document.getElementById('organizationSection');
            
            try {
                // Fetch real organization data
                const res = await fetch('/api/organization');
                if (!res.ok) {
                    console.error('Failed to fetch organization');
                    return;
                }
                
                const data = await res.json();
                if (!data.organization) {
                    console.log('No organization found');
                    return;
                }
                
                const org = data.organization;
                currentOrganization = org; // Store organization data globally
                orgSection.style.display = 'block';
                
                // Update organization info
                document.getElementById('orgName').textContent = org.name;
                document.getElementById('orgPlan').textContent = org.plan;
                document.getElementById('memberCount').textContent = org.members.length;
                
                // Show invite button and notification settings for admins
                const currentMember = org.members.find(m => m.email === currentUser.email);
                if (currentMember && currentMember.role === 'Admin') {
                    document.getElementById('inviteMemberBtn').style.display = 'block';
                    // Show notification settings section for admins
                    document.getElementById('orgNotificationSettings').style.display = 'block';
                    // Load current settings
                    document.getElementById('orgNotificationMode').value = org.defaultNotificationMode || 'Instant';
                    document.getElementById('orgAllowOverride').checked = org.allowUserOverride !== false;
                }
                
                // Render members list
                const membersList = document.getElementById('membersList');
                membersList.innerHTML = org.members.map(member => `
                <div class="member-row">
                    <div class="member-info">
                        <span class="member-name">${member.name}</span>
                        <span class="member-email">${member.email}</span>
                    </div>
                    <div class="member-actions">
                        <span class="member-role ${member.role.toLowerCase()}">${member.role}</span>
                        ${member.email !== currentUser.email && currentMember && currentMember.role === 'Admin' ? `
                            <button class="btn-text" onclick="resendInvitation('${member.email}', this)">Resend Invitation</button>
                            <button class="btn-text" onclick="changeRole('${member.id}', '${member.name || member.email}')">Change Role</button>
                            <button class="btn-text" onclick="removeMember('${member.id}')">Remove</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            } catch (error) {
                console.error('Error loading organization:', error);
                const membersList = document.getElementById('membersList');
                membersList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);">Failed to load organization data</div>';
            }
        }
        
        let changeRoleMemberId = null;
        let removeMemberId = null;
        let currentOrganization = null;
        
        function changeRole(memberId, memberName) {
            changeRoleMemberId = memberId;
            document.getElementById('changeRoleMemberName').textContent = memberName;
            
            // Get current role and set the select to show the other option
            const member = currentOrganization && currentOrganization.members 
                ? currentOrganization.members.find(m => m.id === memberId) 
                : null;
                
            const select = document.getElementById('newRole');
            select.value = ''; // Reset selection
            
            // Show current role in hint
            if (member) {
                const hint = document.querySelector('#changeRoleModal .form-hint');
                hint.textContent = `Current role: ${member.role}`;
            }
            
            document.getElementById('changeRoleModal').style.display = 'flex';
        }
        
        function closeChangeRoleModal() {
            document.getElementById('changeRoleModal').style.display = 'none';
            changeRoleMemberId = null;
        }
        
        // Make functions global
        window.changeRole = changeRole;
        window.closeChangeRoleModal = closeChangeRoleModal;
        
        function removeMember(memberId) {
            const member = currentOrganization?.members.find(m => m.id === memberId);
            const memberName = member?.name || member?.email || 'this member';
            
            removeMemberId = memberId;
            document.getElementById('removeMemberName').textContent = memberName;
            document.getElementById('removeMemberModal').style.display = 'flex';
        }
        
        function closeRemoveMemberModal() {
            document.getElementById('removeMemberModal').style.display = 'none';
            removeMemberId = null;
        }
        
        async function confirmRemoveMember() {
            if (!removeMemberId) return;
            
            const member = currentOrganization?.members.find(m => m.id === removeMemberId);
            const memberName = member?.name || member?.email || 'this member';
            const removeBtn = document.querySelector('#removeMemberModal .btn-primary');
            const originalText = removeBtn.textContent;
            
            try {
                removeBtn.disabled = true;
                removeBtn.textContent = 'Removing...';
                
                const response = await fetch(`/api/organization/members/${removeMemberId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`${memberName} has been removed from the organization.`, 'success', 'Member Removed');
                    closeRemoveMemberModal();
                    // Reload organization to update member list
                    loadOrganization();
                } else {
                    showToast(data.error || 'Failed to remove member', 'error');
                }
            } catch (error) {
                console.error('Error removing member:', error);
                showToast('Failed to remove member. Please try again.', 'error');
            } finally {
                removeBtn.disabled = false;
                removeBtn.textContent = originalText;
            }
        }
        
        // Make functions global
        window.removeMember = removeMember;
        window.closeRemoveMemberModal = closeRemoveMemberModal;
        window.confirmRemoveMember = confirmRemoveMember;
        
        async function resendInvitation(email, buttonElement) {
            // Get the button element from the onclick
            const btn = buttonElement || event.target;
            
            try {
                btn.disabled = true;
                btn.textContent = 'Sending...';
                
                const res = await fetch('/api/organization/invite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, role: 'Editor' }) // Default to Editor for resends
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showToast(data.message || `Invitation resent to ${email}!`, 'success', 'Invitation Sent');
                } else {
                    showToast(data.error || 'Failed to resend invitation', 'error');
                }
            } catch (error) {
                console.error('Resend error:', error);
                showToast('Failed to resend invitation. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Resend Invitation';
            }
        }
        
        // Setup invite modal functionality
        function setupInviteModal() {
            // Define modal functions globally for onclick handlers
            window.openInviteModal = function() {
                const inviteForm = document.getElementById('inviteMemberForm');
                const inviteModal = document.getElementById('inviteMemberModal');
                if (inviteForm) inviteForm.reset();
                if (inviteModal) inviteModal.style.display = 'flex';
            };
            
            window.closeInviteModal = function() {
                const inviteModal = document.getElementById('inviteMemberModal');
                if (inviteModal) inviteModal.style.display = 'none';
            };
            
            // Invite member button
            const inviteBtn = document.getElementById('inviteMemberBtn');
            if (inviteBtn) {
                inviteBtn.addEventListener('click', () => {
                    window.openInviteModal();
                });
            }
            
            // Set up modal event listeners
            const inviteModal = document.getElementById('inviteMemberModal');
            const inviteForm = document.getElementById('inviteMemberForm');
            
            if (inviteModal) {
                // Close modal when clicking outside
                inviteModal.addEventListener('click', e => {
                    if (e.target.id === 'inviteMemberModal') window.closeInviteModal();
                });
            }
            
            if (inviteForm) {
                // Handle invite form submission
                inviteForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = document.getElementById('inviteEmail').value.trim();
                    const name = document.getElementById('inviteName').value.trim() || null;
                    const role = document.getElementById('inviteRole').value;
                    
                    // Close modal and send invite
                    window.closeInviteModal();
                    inviteMember(email, role, name);
                });
            }
        }
        
        async function inviteMember(email, role, name = null) {
            // Check member limit before sending invite
            if (currentOrganization) {
                const currentMemberCount = currentOrganization.members.length;
                const plan = currentOrganization.plan || currentUser.plan;
                const maxMembers = planConfigs[plan]?.members || 1;
                
                if (currentMemberCount >= maxMembers) {
                    showToast(`Your ${plan} plan allows up to ${maxMembers} team member${maxMembers > 1 ? 's' : ''}. Please upgrade to add more members.`, 'error', 'Member Limit Reached');
                    return;
                }
            }
            
            try {
                const inviteBtn = document.getElementById('inviteMemberBtn');
                inviteBtn.disabled = true;
                inviteBtn.textContent = 'Sending...';
                
                const res = await fetch('/api/organization/invite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, role, name })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showToast(data.message || `Invitation sent to ${email}!`, 'success', 'Invitation Sent');
                    // Reload organization data to show updated member list
                    await loadOrganization();
                } else {
                    showToast(data.error || 'Failed to send invitation', 'error');
                }
            } catch (error) {
                console.error('Invite error:', error);
                showToast('Failed to send invitation. Please try again.', 'error');
            } finally {
                const inviteBtn = document.getElementById('inviteMemberBtn');
                inviteBtn.disabled = false;
                inviteBtn.textContent = 'Invite Member';
            }
        }
        
        // Email Change Modal Functions
        window.showChangeEmailModal = function() {
            const modal = document.getElementById('changeEmailModal');
            const currentEmailInput = document.getElementById('currentEmail');
            const newEmailInput = document.getElementById('newEmail');
            const orgWarning = document.getElementById('orgAdminWarning');
            
            // Set current email
            if (currentUser) {
                currentEmailInput.value = currentUser.email;
            }
            
            // Clear new email field
            newEmailInput.value = '';
            
            // Show warning for organization admins
            if (currentUser && currentUser.role === 'Admin' && currentUser.organizationId) {
                orgWarning.style.display = 'block';
            } else {
                orgWarning.style.display = 'none';
            }
            
            modal.style.display = 'flex';
        };
        
        window.closeChangeEmailModal = function() {
            document.getElementById('changeEmailModal').style.display = 'none';
        };
        
        window.handleChangeEmail = async function(event) {
            event.preventDefault();
            
            const newEmail = document.getElementById('newEmail').value.trim();
            const submitBtn = event.target.querySelector('button[type="submit"]');
            
            if (!newEmail) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            // Check if it's the same as current email
            if (newEmail.toLowerCase() === currentUser.email.toLowerCase()) {
                showToast('New email must be different from current email', 'error');
                return;
            }
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Sending...';
                
                const response = await fetch('/api/auth/change-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newEmail })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Verification email sent! Please check your inbox.', 'success', 'Email Sent');
                    closeChangeEmailModal();
                } else {
                    showToast(data.error || 'Failed to send verification email', 'error');
                }
            } catch (error) {
                console.error('Change email error:', error);
                showToast('Failed to process request. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Verification';
            }
        };
        
        // Click outside to close modals
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                if (e.target.id === 'changeEmailModal') {
                    closeChangeEmailModal();
                }
            }
        });

        // Alert Preferences Functions
        function loadAlertPreferences(user) {
            // Set toggles based on user preferences (default to true if not set)
            document.getElementById('prefPermits').checked = user.alertPermits !== false;
            document.getElementById('prefCompletions').checked = user.alertCompletions !== false;
            document.getElementById('prefStatusChanges').checked = user.alertStatusChanges !== false;
            document.getElementById('prefExpirations').checked = user.alertExpirations !== false;
            document.getElementById('prefTransfers').checked = user.alertOperatorTransfers !== false;

            // Set expiration warning days (default to 30)
            const days = user.expirationWarningDays || 30;
            document.getElementById('prefExpirationDays').value = days;

            // Update expiration days visibility based on checkbox
            toggleExpirationDays();

            // Set notification mode
            const modeSelect = document.getElementById('prefNotificationMode');
            const modeHint = document.getElementById('notificationModeHint');

            // Check if user is in an organization
            if (user.organizationId) {
                // Show "Use Org Default" option
                modeSelect.querySelector('option[value="Use Org Default"]').style.display = '';
                modeSelect.value = user.notificationOverride || 'Use Org Default';
                // Update hint based on selection
                updateNotificationModeHint(modeSelect.value, user.orgDefaultNotificationMode);
            } else {
                // Hide "Use Org Default" option - not in an org
                modeSelect.querySelector('option[value="Use Org Default"]').style.display = 'none';
                // Set default to Daily + Weekly if not set (for non-org users)
                const currentMode = user.notificationOverride && user.notificationOverride !== 'Use Org Default'
                    ? user.notificationOverride
                    : 'Daily + Weekly';
                modeSelect.value = currentMode;
                modeHint.textContent = 'Daily updates arrive each morning with your property alerts. Weekly reports include regional activity.';
            }

            // Add change listener to update hint
            modeSelect.addEventListener('change', () => {
                updateNotificationModeHint(modeSelect.value, user.orgDefaultNotificationMode);
            });
        }

        function updateNotificationModeHint(mode, orgDefault) {
            const hint = document.getElementById('notificationModeHint');
            if (mode === 'Use Org Default') {
                hint.textContent = `Your organization default: ${orgDefault || 'Daily + Weekly'}`;
            } else if (mode === 'None') {
                hint.textContent = 'You will not receive any alert notifications.';
            } else if (mode === 'Daily + Weekly') {
                hint.textContent = 'Morning email with your property alerts plus a weekly report with regional activity.';
            } else if (mode === 'Daily Digest') {
                hint.textContent = 'Morning email with your property alerts. No weekly report.';
            } else if (mode === 'Weekly Report') {
                hint.textContent = 'All alerts bundled into a weekly report with regional activity every Sunday.';
            }
        }

        function toggleExpirationDays() {
            const enabled = document.getElementById('prefExpirations').checked;
            const daysSection = document.getElementById('expirationDaysSetting');
            const daysSelect = document.getElementById('prefExpirationDays');

            if (enabled) {
                daysSection.style.opacity = '1';
                daysSelect.disabled = false;
            } else {
                daysSection.style.opacity = '0.5';
                daysSelect.disabled = true;
            }
        }

        // Make toggleExpirationDays global
        window.toggleExpirationDays = toggleExpirationDays;

        async function savePreferences() {
            const btn = document.getElementById('savePrefsBtn');
            const status = document.getElementById('prefsSaveStatus');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = 'Saving...';
                status.style.display = 'none';

                const preferences = {
                    alertPermits: document.getElementById('prefPermits').checked,
                    alertCompletions: document.getElementById('prefCompletions').checked,
                    alertStatusChanges: document.getElementById('prefStatusChanges').checked,
                    alertExpirations: document.getElementById('prefExpirations').checked,
                    alertOperatorTransfers: document.getElementById('prefTransfers').checked,
                    expirationWarningDays: parseInt(document.getElementById('prefExpirationDays').value, 10),
                    notificationOverride: document.getElementById('prefNotificationMode').value
                };

                const res = await fetch('/api/user/preferences', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(preferences)
                });

                if (res.ok) {
                    status.style.display = 'inline';
                    setTimeout(() => { status.style.display = 'none'; }, 3000);
                    showToast('Alert preferences saved!', 'success');
                } else {
                    const data = await res.json();
                    showToast(data.error || 'Failed to save preferences', 'error');
                }
            } catch (error) {
                console.error('Save preferences error:', error);
                showToast('Failed to save preferences. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Make savePreferences global
        window.savePreferences = savePreferences;

        // Organization settings save function
        async function saveOrganizationSettings() {
            const btn = document.getElementById('saveOrgSettingsBtn');
            const status = document.getElementById('orgSettingsSaveStatus');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = 'Saving...';
                status.style.display = 'none';

                const settings = {
                    defaultNotificationMode: document.getElementById('orgNotificationMode').value,
                    allowUserOverride: document.getElementById('orgAllowOverride').checked
                };

                const res = await fetch('/api/organization/settings', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(settings)
                });

                if (res.ok) {
                    status.textContent = '✓ Team settings saved';
                    status.style.display = 'inline';
                    setTimeout(() => { status.style.display = 'none'; }, 3000);
                    showToast('Team notification settings saved!', 'success');
                    // Update currentOrganization
                    if (currentOrganization) {
                        currentOrganization.defaultNotificationMode = settings.defaultNotificationMode;
                        currentOrganization.allowUserOverride = settings.allowUserOverride;
                    }
                } else {
                    const data = await res.json();
                    showToast(data.error || 'Failed to save team settings', 'error');
                }
            } catch (error) {
                console.error('Save organization settings error:', error);
                showToast('Failed to save team settings. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Make saveOrganizationSettings global
        window.saveOrganizationSettings = saveOrganizationSettings;

    </script>
    
    <!-- Invite Member Modal -->
    <div class="modal-overlay" id="inviteMemberModal" style="display: none;">
        <div class="modal">
            <h2 style="margin: 0 0 20px 0; font-size: 20px;">Invite Team Member</h2>
            <form id="inviteMemberForm">
                <div class="form-group">
                    <label for="inviteEmail">Email Address *</label>
                    <input type="email" id="inviteEmail" placeholder="colleague@company.com" required>
                    <div class="form-hint">They'll receive an invitation email to join your organization</div>
                </div>
                <div class="form-group">
                    <label for="inviteName">Name (Optional)</label>
                    <input type="text" id="inviteName" placeholder="John Smith">
                    <div class="form-hint">If not provided, we'll use their email username</div>
                </div>
                <div class="form-group">
                    <label for="inviteRole">Role *</label>
                    <select id="inviteRole" required>
                        <option value="Editor" selected>Editor - Can add/edit properties and wells</option>
                        <option value="Viewer">Viewer - Read-only access</option>
                    </select>
                    <div class="form-hint">Only organization owners can invite other Admins</div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeInviteModal()">Cancel</button>
                    <button type="submit" class="btn-primary" style="margin-top: 0;">Send Invitation</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Change Role Modal -->
    <div class="modal-overlay" id="changeRoleModal" style="display: none;">
        <div class="modal">
            <h3>Change Member Role</h3>
            <p style="margin-bottom: 20px; color: var(--slate-blue);">
                Select a new role for <span id="changeRoleMemberName"></span>
            </p>
            <form id="changeRoleForm">
                <div class="form-group">
                    <label>Role</label>
                    <select id="newRole" required>
                        <option value="">Select a role</option>
                        <option value="Editor">Editor - Can manage properties and wells</option>
                        <option value="Viewer">Viewer - Read-only access</option>
                    </select>
                    <div class="form-hint">Admins can invite members and manage the organization</div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeChangeRoleModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Change Role</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Remove Member Confirmation Modal -->
    <div class="modal-overlay" id="removeMemberModal" style="display: none;">
        <div class="modal">
            <h3 style="color: var(--error); margin-bottom: 20px;">Remove Member</h3>
            <div style="margin-bottom: 25px;">
                <p style="font-size: 15px; color: var(--oil-navy); margin-bottom: 15px;">
                    Are you sure you want to remove <strong id="removeMemberName"></strong> from your organization?
                </p>
                <div style="background: var(--error-bg); border-left: 3px solid var(--error); padding: 12px 15px; border-radius: 4px;">
                    <p style="font-size: 14px; color: var(--error); margin: 0;">
                        <strong>Warning:</strong> This member will immediately lose access to all organization data, including properties, wells, and activity reports.
                    </p>
                </div>
                <p style="font-size: 13px; color: var(--slate-blue); margin-top: 15px;">
                    This action cannot be undone. You will need to send a new invitation if you want to add them back.
                </p>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="closeRemoveMemberModal()">Cancel</button>
                <button type="button" class="btn-primary" style="background: var(--error);" onclick="confirmRemoveMember()">Remove Member</button>
            </div>
        </div>
    </div>

    <!-- Change Email Modal -->
    <div class="modal-overlay" id="changeEmailModal" style="display: none;">
        <div class="modal-content">
            <form id="changeEmailForm" onsubmit="handleChangeEmail(event)">
                <h3>Change Email Address</h3>
                <div class="form-group">
                    <label for="currentEmail">Current Email</label>
                    <input type="email" id="currentEmail" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label for="newEmail">New Email</label>
                    <input type="email" id="newEmail" required placeholder="Enter your new email address">
                    <div class="form-hint">We'll send a verification link to confirm this email</div>
                </div>
                <div id="orgAdminWarning" style="display: none; background: #FEF3C7; border: 1px solid #F59E0B; padding: 12px; border-radius: 4px; margin-top: 10px;">
                    <p style="margin: 0; color: #92400E; font-size: 14px;">
                        <strong>Note:</strong> You are an organization administrator. Changing your email will update your login credentials but won't affect organization ownership. Make sure other admins are aware of this change.
                    </p>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeChangeEmailModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Send Verification</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>