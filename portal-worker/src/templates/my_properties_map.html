<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Properties Map - Mineral Watch</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        :root { 
            --oil-navy: #1C2B36; 
            --slate-blue: #334E68; 
            --red-dirt: #C05621; 
            --red-dirt-dark: #9C4215; 
            --paper: #F8F9FA; 
            --border: #E2E8F0; 
            --success: #03543F; 
            --success-bg: #DEF7EC; 
            --error: #DC2626; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: var(--oil-navy); background: #F7FAFC; min-height: 100vh; }
        h1, h2, .logo { font-family: 'Merriweather', serif; }
        header { background: var(--oil-navy); padding: 15px 0; color: white; }
        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        .header-inner { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: 900; color: white; text-decoration: none; }
        main { padding: 20px 0; }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-header h1 { font-size: 24px; margin: 0; }
        
        /* Map Container */
        .map-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 600px;
        }
        
        /* Map Legend */
        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 13px;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--oil-navy);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.2);
        }
        
        /* Map Controls */
        .map-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--paper);
            border-bottom: 1px solid var(--border);
        }
        
        .map-info {
            font-size: 14px;
            color: var(--slate-blue);
        }
        
        .map-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-map-action {
            background: white;
            color: var(--slate-blue);
            border: 1px solid var(--border);
            padding: 8px 14px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-map-action:hover {
            border-color: var(--slate-blue);
            color: var(--oil-navy);
        }
        
        .btn-map-action.active {
            background: var(--oil-navy);
            color: white;
            border-color: var(--oil-navy);
        }
        
        /* Property Panel */
        .property-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 320px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        
        .property-panel.open {
            display: block;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--paper);
            border-radius: 8px 8px 0 0;
        }
        
        .panel-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--oil-navy);
        }
        
        .panel-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--slate-blue);
            padding: 0;
            line-height: 1;
        }
        
        .panel-body {
            padding: 16px;
        }
        
        .panel-section {
            margin-bottom: 16px;
        }
        
        .panel-section:last-child {
            margin-bottom: 0;
        }
        
        .panel-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--slate-blue);
            margin-bottom: 4px;
        }
        
        .panel-value {
            font-size: 14px;
            color: var(--oil-navy);
        }
        
        .panel-value strong {
            font-weight: 600;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.active { background: #DCFCE7; color: #166534; }
        .status-badge.recent { background: #FEF3C7; color: #92400E; }
        .status-badge.quiet { background: #DBEAFE; color: #1E40AF; }
        
        /* Loading overlay */
        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--red-dirt);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 12px;
            font-size: 14px;
            color: var(--slate-blue);
        }
        
        /* Adjacent sections (lighter) */
        .leaflet-interactive.adjacent-section {
            fill-opacity: 0.15 !important;
            stroke-dasharray: 4 4 !important;
        }

        /* Popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        
        .leaflet-popup-content {
            margin: 12px;
            font-family: 'Inter', sans-serif;
        }
        
        .popup-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--oil-navy);
        }
        
        .popup-detail {
            font-size: 13px;
            color: var(--slate-blue);
            margin: 4px 0;
        }
        
        .popup-link {
            display: inline-block;
            margin-top: 8px;
            color: var(--red-dirt);
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
        }
        
        .popup-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-inner">
                <a href="/" class="logo">Mineral Watch</a>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <div class="page-header">
                <h1>My Properties Map</h1>
            </div>
            
            <div class="map-container" style="position: relative;">
                <!-- Map Controls Bar -->
                <div class="map-controls">
                    <div class="map-info">
                        <span id="propertyCountInfo">Loading properties...</span>
                    </div>
                    <div class="map-actions">
                        <button class="btn-map-action active" id="showMyProperties">My Properties</button>
                        <button class="btn-map-action" id="showAdjacent">Show Adjacent</button>
                        <button class="btn-map-action" id="fitBounds">Fit All</button>
                    </div>
                </div>
                
                <!-- The Map -->
                <div id="map"></div>
                
                <!-- Loading Overlay -->
                <div class="map-loading" id="mapLoading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading property boundaries...</div>
                </div>
                
                <!-- Legend -->
                <div class="map-legend">
                    <div class="legend-title">Activity Status</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #22C55E;"></div>
                        <span>Active (permits nearby)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #F59E0B;"></div>
                        <span>Recent (last 30 days)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3B82F6;"></div>
                        <span>Quiet (no recent activity)</span>
                    </div>
                </div>
                
                <!-- Property Detail Panel -->
                <div class="property-panel" id="propertyPanel">
                    <div class="panel-header">
                        <span class="panel-title" id="panelTitle">Property Details</span>
                        <button class="panel-close" onclick="closePropertyPanel()">×</button>
                    </div>
                    <div class="panel-body">
                        <div class="panel-section">
                            <div class="panel-label">Location</div>
                            <div class="panel-value" id="panelLocation">—</div>
                        </div>
                        <div class="panel-section">
                            <div class="panel-label">County</div>
                            <div class="panel-value" id="panelCounty">—</div>
                        </div>
                        <div class="panel-section">
                            <div class="panel-label">Acreage</div>
                            <div class="panel-value" id="panelAcreage">—</div>
                        </div>
                        <div class="panel-section">
                            <div class="panel-label">Status</div>
                            <div class="panel-value" id="panelStatus">—</div>
                        </div>
                        <div class="panel-section">
                            <div class="panel-label">Notes</div>
                            <div class="panel-value" id="panelNotes">—</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        const OCC_API_BASE = 'https://gis.occ.ok.gov/server/rest/services/Hosted/STR/FeatureServer';
        const CORS_PROXY = 'https://corsproxy.io/?';
        const SECTION_LAYER = 226; // OK_SEC layer
        
        // Activity status colors
        const STATUS_COLORS = {
            active: '#22C55E',   // Green - permits nearby
            recent: '#F59E0B',   // Yellow - activity in last 30 days  
            quiet: '#3B82F6'     // Blue - no recent activity
        };
        
        // =============================================
        // DEMO DATA (replace with API fetch in production)
        // =============================================
        const DEMO_PROPERTIES = [
            { id: 'prop1', fields: { SEC: '15', TWN: '22N', RNG: '19W', COUNTY: 'BLAINE', Notes: 'Family homestead section', 'Monitor Adjacent': true }, status: 'active' },
            { id: 'prop2', fields: { SEC: '22', TWN: '22N', RNG: '19W', COUNTY: 'BLAINE', Notes: '' }, status: 'quiet' },
            { id: 'prop3', fields: { SEC: '10', TWN: '10N', RNG: '6W', COUNTY: 'LINCOLN', Notes: 'Leased to Devon' }, status: 'recent' },
            { id: 'prop4', fields: { SEC: '7', TWN: '7N', RNG: '1W', COUNTY: 'OKLAHOMA', Notes: '' }, status: 'quiet' },
            { id: 'prop5', fields: { SEC: '23', TWN: '14N', RNG: '11W', COUNTY: 'CANADIAN', Notes: 'SCOOP play' }, status: 'active' },
        ];
        
        // =============================================
        // STATE
        // =============================================
        let map;
        let propertiesLayer = L.featureGroup();
        let adjacentLayer = L.featureGroup();
        let geometryCache = {};
        let showingAdjacent = false;
        
        // =============================================
        // PLSS ID FORMATTER
        // =============================================
        function formatPlssId(twn, rng) {
            // Parse township: "22N" -> { num: 22, dir: 'N' }
            const twnMatch = twn.match(/(\d+)([NS])/i);
            if (!twnMatch) return null;
            const twnNum = twnMatch[1].padStart(3, '0');
            const twnDir = twnMatch[2].toUpperCase();
            
            // Parse range: "19W" -> { num: 19, dir: 'W' }
            const rngMatch = rng.match(/(\d+)([EW])/i);
            if (!rngMatch) return null;
            const rngNum = rngMatch[1].padStart(3, '0');
            const rngDir = rngMatch[2].toUpperCase();
            
            // Format: OK17TTTT0DRRRR0D0
            return `OK17${twnNum}0${twnDir}${rngNum}0${rngDir}0`;
        }
        
        // =============================================
        // OCC API QUERIES
        // =============================================
        async function fetchSectionGeometry(section, twn, rng) {
            const cacheKey = `${section}-${twn}-${rng}`;
            
            // Check cache first
            if (geometryCache[cacheKey]) {
                return geometryCache[cacheKey];
            }
            
            // Check localStorage cache
            const stored = localStorage.getItem(`mw_section_${cacheKey}`);
            if (stored) {
                const parsed = JSON.parse(stored);
                geometryCache[cacheKey] = parsed;
                return parsed;
            }
            
            const plssId = formatPlssId(twn, rng);
            if (!plssId) {
                console.error('Invalid township/range format:', twn, rng);
                return null;
            }
            
            const url = `${OCC_API_BASE}/${SECTION_LAYER}/query?` +
                `where=frstdivno='${section}' AND plssid='${plssId}'` +
                `&outFields=frstdivno,frstdivlab,gisacre,plssid,survtyptxt` +
                `&f=geojson` +
                `&outSR=4326`;
            
            try {
                const response = await fetch(CORS_PROXY + encodeURIComponent(url));
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    // Cache in memory and localStorage
                    geometryCache[cacheKey] = feature;
                    localStorage.setItem(`mw_section_${cacheKey}`, JSON.stringify(feature));
                    return feature;
                }
            } catch (err) {
                console.error('Error fetching section geometry:', err);
            }
            
            return null;
        }
        
        async function fetchAdjacentSections(section, twn, rng) {
            // Get the 8 adjacent sections
            const adjacent = getAdjacentSectionNumbers(parseInt(section));
            const promises = adjacent.map(adjSec => 
                fetchSectionGeometry(adjSec.toString(), twn, rng)
            );
            
            const results = await Promise.all(promises);
            return results.filter(r => r !== null);
        }
        
        function getAdjacentSectionNumbers(sec) {
            // PLSS section numbering (snake pattern):
            // 6  5  4  3  2  1
            // 7  8  9  10 11 12
            // 18 17 16 15 14 13
            // 19 20 21 22 23 24
            // 30 29 28 27 26 25
            // 31 32 33 34 35 36
            
            const grid = [
                [6, 5, 4, 3, 2, 1],
                [7, 8, 9, 10, 11, 12],
                [18, 17, 16, 15, 14, 13],
                [19, 20, 21, 22, 23, 24],
                [30, 29, 28, 27, 26, 25],
                [31, 32, 33, 34, 35, 36]
            ];
            
            // Find position in grid
            let row = -1, col = -1;
            for (let r = 0; r < 6; r++) {
                for (let c = 0; c < 6; c++) {
                    if (grid[r][c] === sec) {
                        row = r;
                        col = c;
                        break;
                    }
                }
                if (row >= 0) break;
            }
            
            if (row < 0) return [];
            
            // Get adjacent (within same township only for now)
            const adjacent = [];
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    if (dr === 0 && dc === 0) continue;
                    const nr = row + dr;
                    const nc = col + dc;
                    if (nr >= 0 && nr < 6 && nc >= 0 && nc < 6) {
                        adjacent.push(grid[nr][nc]);
                    }
                }
            }
            
            return adjacent;
        }
        
        // =============================================
        // MAP FUNCTIONS
        // =============================================
        function initMap() {
            map = L.map('map').setView([35.5, -97.5], 7); // Center on Oklahoma
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            propertiesLayer.addTo(map);
            adjacentLayer.addTo(map);
        }
        
        async function loadProperties() {
            document.getElementById('mapLoading').style.display = 'flex';
            
            // In production, replace with:
            // const res = await fetch('/api/properties');
            // const properties = await res.json();
            const properties = DEMO_PROPERTIES;
            
            let loaded = 0;
            const total = properties.length;
            
            for (const prop of properties) {
                const f = prop.fields;
                // Strip any T/R prefixes from the values
                const sec = f.SEC.replace(/^S/i, '');
                const twn = f.TWN.replace(/^T/i, '');
                const rng = f.RNG.replace(/^R/i, '');
                
                const geometry = await fetchSectionGeometry(sec, twn, rng);
                
                if (geometry) {
                    addPropertyToMap(prop, geometry);
                }
                
                loaded++;
                document.querySelector('.loading-text').textContent = 
                    `Loading property boundaries... (${loaded}/${total})`;
            }
            
            document.getElementById('mapLoading').style.display = 'none';
            document.getElementById('propertyCountInfo').textContent = 
                `${properties.length} properties loaded`;
            
            // Fit map to show all properties
            if (propertiesLayer.getLayers().length > 0) {
                map.fitBounds(propertiesLayer.getBounds(), { padding: [50, 50] });
            }
        }
        
        function addPropertyToMap(property, geometry) {
            const f = property.fields;
            const status = property.status || 'quiet';
            const color = STATUS_COLORS[status];
            
            const layer = L.geoJSON(geometry, {
                style: {
                    color: color,
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 0.35
                }
            });
            
            // Popup content
            const popupContent = `
                <div class="popup-title">${f.COUNTY} County</div>
                <div class="popup-detail"><strong>S${f.SEC} T${f.TWN} R${f.RNG}</strong></div>
                <div class="popup-detail">${geometry.properties?.gisacre ? Math.round(geometry.properties.gisacre) + ' acres' : ''}</div>
                ${f.Notes ? `<div class="popup-detail" style="font-style: italic; margin-top: 8px;">"${f.Notes}"</div>` : ''}
                <a href="#" class="popup-link" onclick="showPropertyDetail('${property.id}'); return false;">View Details →</a>
            `;
            
            layer.bindPopup(popupContent);
            
            // Store property data on layer for panel
            layer.propertyData = property;
            layer.geometryData = geometry;
            
            // Click handler
            layer.on('click', () => {
                showPropertyPanel(property, geometry);
            });
            
            // Hover effects
            layer.on('mouseover', function() {
                this.setStyle({ fillOpacity: 0.6, weight: 3 });
            });
            
            layer.on('mouseout', function() {
                this.setStyle({ fillOpacity: 0.35, weight: 2 });
            });
            
            propertiesLayer.addLayer(layer);
        }
        
        async function toggleAdjacent() {
            showingAdjacent = !showingAdjacent;
            
            document.getElementById('showAdjacent').classList.toggle('active', showingAdjacent);
            
            if (showingAdjacent) {
                document.getElementById('mapLoading').style.display = 'flex';
                document.querySelector('.loading-text').textContent = 'Loading adjacent sections...';
                
                // For each property, load adjacent sections
                for (const layer of propertiesLayer.getLayers()) {
                    const prop = layer.propertyData;
                    if (!prop) continue;
                    
                    const f = prop.fields;
                    const sec = f.SEC.replace(/^S/i, '');
                    const twn = f.TWN.replace(/^T/i, '');
                    const rng = f.RNG.replace(/^R/i, '');
                    
                    const adjacents = await fetchAdjacentSections(sec, twn, rng);
                    
                    for (const adjGeom of adjacents) {
                        const adjLayer = L.geoJSON(adjGeom, {
                            style: {
                                color: '#6B7280',
                                weight: 1,
                                fillColor: '#9CA3AF',
                                fillOpacity: 0.15,
                                dashArray: '4 4'
                            }
                        });
                        
                        const adjPopup = `
                            <div class="popup-detail"><strong>Section ${adjGeom.properties?.frstdivno}</strong></div>
                            <div class="popup-detail">${adjGeom.properties?.gisacre ? Math.round(adjGeom.properties.gisacre) + ' acres' : ''}</div>
                            <div class="popup-detail" style="color: #6B7280;">Adjacent section</div>
                        `;
                        
                        adjLayer.bindPopup(adjPopup);
                        adjacentLayer.addLayer(adjLayer);
                    }
                }
                
                document.getElementById('mapLoading').style.display = 'none';
            } else {
                adjacentLayer.clearLayers();
            }
        }
        
        function showPropertyPanel(property, geometry) {
            const f = property.fields;
            const status = property.status || 'quiet';
            
            document.getElementById('panelTitle').textContent = `${f.COUNTY} County`;
            document.getElementById('panelLocation').innerHTML = `<strong>S${f.SEC} T${f.TWN} R${f.RNG}</strong>`;
            document.getElementById('panelCounty').textContent = f.COUNTY;
            document.getElementById('panelAcreage').textContent = geometry.properties?.gisacre 
                ? Math.round(geometry.properties.gisacre) + ' acres' 
                : 'Unknown';
            
            const statusBadge = status === 'active' ? 'Active Permits' : 
                               status === 'recent' ? 'Recent Activity' : 'Quiet';
            document.getElementById('panelStatus').innerHTML = 
                `<span class="status-badge ${status}">${statusBadge}</span>`;
            
            document.getElementById('panelNotes').textContent = f.Notes || 'No notes';
            
            document.getElementById('propertyPanel').classList.add('open');
        }
        
        function closePropertyPanel() {
            document.getElementById('propertyPanel').classList.remove('open');
        }
        
        function showPropertyDetail(propertyId) {
            // In production, this would link to the property detail modal
            console.log('Show detail for:', propertyId);
            alert('Would open property detail modal for: ' + propertyId);
        }
        
        function fitAllBounds() {
            if (propertiesLayer.getLayers().length > 0) {
                map.fitBounds(propertiesLayer.getBounds(), { padding: [50, 50] });
            }
        }
        
        // =============================================
        // INITIALIZATION
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadProperties();
            
            // Event listeners
            document.getElementById('showAdjacent').addEventListener('click', toggleAdjacent);
            document.getElementById('fitBounds').addEventListener('click', fitAllBounds);
        });
    </script>
</body>
</html>
