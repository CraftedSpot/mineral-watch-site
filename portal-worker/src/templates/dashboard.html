<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mineral Watch</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --oil-navy: #1C2B36; --slate-blue: #334E68; --red-dirt: #C05621; --red-dirt-dark: #9C4215; --paper: #F8F9FA; --border: #E2E8F0; --success: #03543F; --success-bg: #DEF7EC; --error: #DC2626; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: var(--oil-navy); background: #F7FAFC; min-height: 100vh; }
        h1, h2, .logo { font-family: 'Merriweather', serif; }
        header { background: var(--oil-navy); padding: 15px 0; color: white; }
        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        .header-inner { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: 900; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 25px; }
        .nav-links a { color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; font-size: 14px; }
        .nav-links a:hover, .nav-links a.active { color: white; }
        .user-menu { display: flex; align-items: center; gap: 15px; }
        .user-name { font-size: 14px; color: rgba(255,255,255,0.8); }
        .btn-logout { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer; }
        main { padding: 40px 0; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .page-header h1 { font-size: 28px; margin: 0; line-height: 1.2; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        /* Action Groups with Dividers */
        .action-group { display: flex; gap: 8px; align-items: center; }
        .action-divider { width: 1px; height: 24px; background: var(--border); margin: 0 8px; }
        .btn-add { background: var(--red-dirt); color: white; padding: 10px 16px; border: 1px solid var(--red-dirt); border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; text-decoration: none; transition: all 0.2s; }
        .btn-add:hover { background: var(--red-dirt-dark); border-color: var(--red-dirt-dark); }
        
        .btn-secondary-action { background: white; color: var(--slate-blue); border: 1px solid var(--border); padding: 10px 16px; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-secondary-action:hover { border-color: var(--slate-blue); color: var(--oil-navy); background: #f8fafc; }
        .plan-info { background: white; border-radius: 8px; padding: 16px 20px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-wrap: wrap; }
        .plan-badge { background: var(--success-bg); color: var(--success); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .plan-usage { font-size: 14px; color: var(--slate-blue); display: flex; gap: 20px; flex-wrap: wrap; }
        .usage-item { display: flex; align-items: center; gap: 6px; }
        .upgrade-link { margin-left: auto; color: var(--red-dirt); text-decoration: none; font-size: 14px; font-weight: 600; }
        .stats-card { background: white; border-radius: 8px; padding: 20px 30px; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 40px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-item { text-align: center; }
        .stat-label { display: block; font-size: 12px; color: var(--slate-blue); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .stat-value { display: block; font-size: 24px; font-weight: 700; color: var(--oil-navy); font-family: 'Merriweather', serif; }
        .stat-divider { width: 1px; height: 40px; background: var(--border); }
        .activity-list { padding: 0; }
        .activity-item { display: flex; gap: 16px; padding: 20px; border-bottom: 1px solid var(--border); }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .activity-icon.permit { background: #DBEAFE; }
        .activity-icon.drilling { background: #FEF3C7; }
        .activity-icon.completed { background: #DEF7EC; }
        .activity-icon.transfer { background: #EDE9FE; }
        .activity-icon.status { background: #E0F2FE; }
        .activity-icon.abandoned { background: #F3F4F6; }
        .activity-details { flex: 1; }
        .activity-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        .activity-type { font-weight: 600; font-size: 14px; color: var(--oil-navy); }
        .activity-level { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; }
        .activity-level.property { background: #FEE2E2; color: #991B1B; }
        .activity-level.adjacent { background: #FEF3C7; color: #92400E; }
        .activity-level.tracked { background: #CCFBF1; color: #115E59; }
        .activity-well { font-size: 15px; font-weight: 500; margin-bottom: 4px; }
        .activity-meta { font-size: 13px; color: var(--slate-blue); }
        .activity-change { background: var(--paper); padding: 8px 12px; border-radius: 4px; font-size: 13px; margin-top: 8px; display: inline-block; }
        .activity-actions { display: flex; gap: 8px; margin-top: 10px; }
        .activity-btn { display: inline-block; padding: 6px 12px; font-size: 12px; font-weight: 600; text-decoration: none; border-radius: 4px; background: var(--paper); color: var(--slate-blue); border: 1px solid var(--border); transition: all 0.2s; cursor: pointer; }
        .activity-btn:hover { background: #E2E8F0; color: var(--oil-navy); }
        .activity-btn.track-btn { background: white; border-color: var(--red-dirt); color: var(--red-dirt); }
        .activity-btn.track-btn:hover { background: var(--red-dirt); color: white; }
        .activity-date { font-size: 12px; color: #718096; white-space: nowrap; }
        .activity-limit-notice { background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 12px 16px; margin: 16px 20px; border-radius: 0 4px 4px 0; font-size: 13px; color: #92400E; }
        .activity-limit-notice a { color: #92400E; font-weight: 600; }
        .tabs { display: flex; gap: 4px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; position: relative; border: 1px solid transparent; display: flex; align-items: center; gap: 8px; }
        
        .tab-icon { width: 16px; height: 16px; opacity: 0.7; }
        .tab.active .tab-icon { opacity: 1; color: var(--red-dirt); }
        .tab.active { background: white; color: var(--oil-navy); border-bottom: 3px solid #3B82F6; border-left: 1px solid var(--border); border-right: 1px solid var(--border); border-top: 1px solid var(--border); box-shadow: none; }
        .tab:not(.active) { background: #f8f9fa; color: #94A3B8; border: 1px solid #e9ecef; opacity: 0.9; }
        .tab:not(.active):hover { background: #f1f3f4; color: #64748B; opacity: 1; border-color: #d6d9dc; }
        .content-card { background: white; border-radius: 0 8px 8px 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .data-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        /* --- COLUMN WIDTHS --- */
        .col-select { width: 50px; text-align: center; padding: 16px 10px !important; }
        .col-actions { width: 160px; text-align: right; }
        
        /* Properties Table */
        .col-prop-county { width: 18%; }
        .col-prop-legal { width: 25%; }
        .col-prop-notes { width: auto; }
        
        /* Wells Table */
        .col-well-name { width: 22%; }
        .col-operator { width: 18%; }
        .col-api { width: 16%; }
        .col-county { width: 14%; }
        .col-location { width: 15%; }
        .data-table th { background: var(--paper); text-align: left; padding: 14px 20px; font-size: 12px; font-weight: 600; color: var(--slate-blue); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
        .data-table td { padding: 16px 20px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .data-table tr:last-child td { border-bottom: none; }
        .status-active { color: var(--success); font-weight: 600; }
        .btn-link { background: none; border: none; color: var(--red-dirt); cursor: pointer; font-size: 13px; text-decoration: underline; margin-right: 12px; }
        .btn-link:hover { color: var(--red-dirt-dark); }
        .btn-delete { background: none; border: none; color: #94A3B8; cursor: pointer; font-size: 13px; padding: 4px; border-radius: 4px; transition: all 0.2s; }
        .btn-delete:hover { color: #DC2626; background: #FEE2E2; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--slate-blue); }
        .empty-state p { margin-bottom: 20px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; border-radius: 8px; padding: 30px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal h2 { margin-bottom: 20px; }
        
        /* Delete Modal Specifics */
        .delete-icon-wrapper { width: 48px; height: 48px; border-radius: 50%; background: #FEE2E2; color: #DC2626; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
        .delete-warning-text { text-align: center; color: var(--slate-blue); font-size: 15px; margin-bottom: 24px; line-height: 1.5; }
        
        /* Bulk Selection Styles */
        .bulk-checkbox-column { width: 50px; text-align: center; }
        .bulk-checkbox { cursor: pointer; width: 16px; height: 16px; }
        .bulk-action-bar {
            display: none;
            background: linear-gradient(135deg, #FEF3C7 0%, #FED7AA 100%);
            border: 2px solid #F59E0B;
            border-radius: 8px;
            padding: 16px 24px;
            margin-bottom: 20px;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            position: sticky;
            top: 10px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .bulk-action-bar.active { display: flex; }
        
        .bulk-count {
            color: var(--oil-navy);
            font-size: 15px;
            font-weight: 700;
        }
        
        .bulk-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .bulk-btn {
            background: var(--red-dirt);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bulk-btn:hover:not(:disabled) {
            background: var(--red-dirt-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(192, 86, 33, 0.3);
        }
        
        .bulk-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Add loading state */
        .bulk-btn.loading {
            position: relative;
            color: transparent;
        }
        
        .bulk-btn.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spinner 0.6s linear infinite;
        }
        
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        
        .bulk-clear { color: var(--slate-blue); text-decoration: underline; cursor: pointer; font-size: 13px; }
        .bulk-clear:hover { color: var(--oil-navy); }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            min-width: 300px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .toast-show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .toast-success {
            border-left: 4px solid var(--success);
        }
        
        .toast-success .toast-icon {
            background: var(--success-bg);
            color: var(--success);
        }
        
        .toast-error {
            border-left: 4px solid #DC2626;
        }
        
        .toast-error .toast-icon {
            background: #FEE2E2;
            color: #DC2626;
        }
        
        .toast-message {
            color: var(--oil-navy);
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
        }
        .data-table tr.selected { background-color: #F0F9FF; }
        .data-table tr.selected td { border-color: #BFDBFE; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group.full { grid-column: span 2; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; }
        .form-group textarea { resize: vertical; min-height: 60px; }
        .form-hint { font-size: 12px; color: var(--slate-blue); margin-top: 4px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; }
        .btn-cancel { padding: 10px 20px; border: 1px solid var(--border); background: white; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-submit { padding: 10px 20px; background: var(--red-dirt); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .details-grid { display: flex; flex-direction: column; gap: 12px; }
        .details-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .details-row:last-child { border-bottom: none; }
        .details-label { font-size: 13px; color: var(--slate-blue); font-weight: 500; }
        .details-value { font-size: 14px; color: var(--oil-navy); font-weight: 500; text-align: right; max-width: 60%; }
        .details-actions { display: flex; gap: 10px; margin-top: 20px; }
        .details-btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; font-size: 13px; font-weight: 600; text-decoration: none; border-radius: 4px; background: var(--paper); color: var(--slate-blue); border: 1px solid var(--border); flex: 1; text-align: center; }
        .details-btn:hover { background: #E2E8F0; }
        .details-btn.primary { background: var(--red-dirt); color: white; border-color: var(--red-dirt); }
        .details-btn.primary:hover { background: var(--red-dirt-dark); }
        footer { background: var(--oil-navy); color: #A0AEC0; padding: 20px 0; font-size: 13px; text-align: center; margin-top: auto; }
        @media (max-width: 768px) { 
            .form-row { grid-template-columns: 1fr; } 
            .form-group.full { grid-column: span 1; } 
            .user-name { display: none; } 
            .data-table { font-size: 13px; } 
            .data-table th, .data-table td { padding: 12px; }
            .bulk-only,
            .bulk-action-bar,
            th.bulk-only,
            td.bulk-only { 
                display: none !important; 
            }
            .plan-usage { gap: 10px; }
            .header-actions { flex-direction: column; width: 100%; }
            .btn-add { width: 100%; justify-content: center; }
            .stats-card { flex-direction: column; gap: 15px; padding: 15px 20px; }
            .stat-divider { width: 60px; height: 1px; }
            .stat-value { font-size: 20px; }
            .activity-item { flex-direction: column; gap: 12px; }
            .activity-header { flex-direction: column; gap: 8px; }
            .activity-date { align-self: flex-start; }
            .toast {
                left: 20px;
                right: 20px;
                min-width: auto;
            }
        }
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-table { width: 100%; }
        .skeleton-row { display: flex; gap: 20px; padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .skeleton-row:last-child { border-bottom: none; }
        .skeleton-cell { height: 20px; flex: 1; }
        .skeleton-cell.narrow { max-width: 80px; }
        .skeleton-cell.medium { max-width: 120px; }
        .skeleton-header { background: var(--paper); padding: 14px 20px; display: flex; gap: 20px; border-bottom: 1px solid var(--border); }
        .skeleton-header .skeleton-cell { height: 14px; opacity: 0.5; }
        .skeleton-activity { padding: 20px; display: flex; gap: 16px; border-bottom: 1px solid var(--border); }
        .skeleton-activity:last-child { border-bottom: none; }
        .skeleton-avatar { width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; }
        .skeleton-activity-content { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .skeleton-line { height: 16px; }
        .skeleton-line.short { width: 40%; }
        .skeleton-line.medium { width: 60%; }
        .skeleton-line.long { width: 85%; }
        
        /* Search and Sort Controls */
        .table-controls {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            background: var(--paper);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--red-dirt);
        }
        .search-input::placeholder {
            color: #94a3b8;
        }
        .sort-select {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            cursor: pointer;
            min-width: 160px;
        }
        .sort-select:focus {
            outline: none;
            border-color: var(--red-dirt);
        }
        .results-count {
            font-size: 13px;
            color: var(--slate-blue);
            margin-left: auto;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-inner">
                <a href="/" class="logo">Mineral Watch</a>
                <nav class="nav-links">
                    <a href="/portal" class="active">Dashboard</a>
                    <a href="/portal/account">Account</a>
                </nav>
                <div class="user-menu">
                    <span class="user-name" id="userName">Loading...</span>
                    <button class="btn-logout" id="logoutBtn">Log Out</button>
                </div>
            </div>
        </div>
    </header>
    <main>
        <div class="container">
            <div class="page-header">
                <h1 style="margin: 0;">My Monitoring</h1>
                <div class="header-actions">
                    <div class="action-group">
                        <button class="btn-add" id="addPropertyBtn">
                            <span>‚ûï</span> Property
                        </button>
                        <button class="btn-secondary-action" id="bulkUploadBtn" title="Import Properties">
                            Import
                        </button>
                        <button class="btn-secondary-action" id="exportPropertiesBtn" style="display: none;" onclick="exportPropertiesCSV()" title="Export Properties">
                            Export
                        </button>
                    </div>
                    <div class="action-divider"></div>
                    <div class="action-group">
                        <button class="btn-add" id="addWellBtn">
                            <span>‚ûï</span> Well
                        </button>
                        <button class="btn-secondary-action" id="bulkUploadWellsBtn" title="Import Wells">
                            Import
                        </button>
                        <button class="btn-secondary-action" id="exportWellsBtn" style="display: none;" onclick="exportWellsCSV()" title="Export Wells">
                            Export
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="plan-info">
                <span class="plan-badge" id="planBadge">FREE</span>
                <div class="plan-usage">
                    <div class="usage-item">
                        <span><strong id="propCount">0</strong> / <strong id="propLimit">1</strong> Properties</span>
                    </div>
                    <div class="usage-item">
                        <span>|</span>
                    </div>
                    <div class="usage-item">
                        <span><strong id="wellCount">0</strong> / <strong id="wellLimit">0</strong> Wells</span>
                    </div>
                </div>
                <a href="/portal/upgrade" class="upgrade-link" id="upgradeLink">Upgrade ‚Üí</a>
            </div>
            
            <div class="stats-card" id="statsCard">
                <div class="stat-item">
                    <span class="stat-label">Last Alert</span>
                    <span class="stat-value" id="statLastAlert">‚Äî</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">This Month</span>
                    <span class="stat-value" id="statThisMonth">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">This Year</span>
                    <span class="stat-value" id="statThisYear">0</span>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="properties">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    Properties
                </button>
                <button class="tab" data-tab="wells">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    Wells
                </button>
                <button class="tab" data-tab="activity">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    Activity Log
                </button>
            </div>

            <div class="content-card">
                <div id="properties-tab" class="tab-content active">
                    <div id="propertiesControls" class="table-controls" style="display: none;">
                        <input type="text" id="propertiesSearch" class="search-input" placeholder="Search properties by county, section, township, or range...">
                        <select id="propertiesSort" class="sort-select">
                            <option value="legal-asc" selected>Legal Description</option>
                            <option value="date-desc">Date Added</option>
                        </select>
                        <span id="propertiesResultsCount" class="results-count"></span>
                    </div>
                   <div id="propertiesBulkActionBar" class="bulk-action-bar">
                        <div class="bulk-count"><span class="selected-count">0</span> selected</div>
                        <div class="bulk-actions">
                            <button class="bulk-btn" onclick="bulkDeleteSelected('properties')">
                                <span>üóëÔ∏è</span> Delete Selected
                            </button>
                        </div>
                        <span class="bulk-clear" onclick="clearSelection('properties')">Clear selection</span>
                    </div>
                   <div id="propertiesContent">
    <div class="skeleton-table">
        <div class="skeleton-header">
            <div class="skeleton skeleton-cell medium"></div>
            <div class="skeleton skeleton-cell narrow"></div>
            <div class="skeleton skeleton-cell narrow"></div>
            <div class="skeleton skeleton-cell narrow"></div>
            <div class="skeleton skeleton-cell narrow"></div>
        </div>
        <div class="skeleton-row"><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div></div>
        <div class="skeleton-row"><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div></div>
        <div class="skeleton-row"><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div></div>
    </div>
</div>
                </div>
                
                <div id="wells-tab" class="tab-content">
                    <div id="wellsControls" class="table-controls" style="display: none;">
                        <input type="text" id="wellsSearch" class="search-input" placeholder="Search wells by name, operator, API, or county...">
                        <select id="wellsSort" class="sort-select">
                            <option value="legal-asc" selected>Legal Description</option>
                            <option value="date-desc">Date Added</option>
                            <option value="name-asc">Well Name</option>
                            <option value="operator-asc">Operator</option>
                        </select>
                        <span id="wellsResultsCount" class="results-count"></span>
                    </div>
                   <div id="wellsBulkActionBar" class="bulk-action-bar">
                        <div class="bulk-count"><span class="selected-count">0</span> selected</div>
                        <div class="bulk-actions">
                            <button class="bulk-btn" onclick="bulkDeleteSelected('wells')">
                                <span>üóëÔ∏è</span> Delete Selected
                            </button>
                        </div>
                        <span class="bulk-clear" onclick="clearSelection('wells')">Clear selection</span>
                    </div>
                   <div id="wellsContent">
    <div class="skeleton-table">
        <div class="skeleton-header">
            <div class="skeleton skeleton-cell"></div>
            <div class="skeleton skeleton-cell medium"></div>
            <div class="skeleton skeleton-cell medium"></div>
            <div class="skeleton skeleton-cell narrow"></div>
            <div class="skeleton skeleton-cell narrow"></div>
        </div>
        <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div></div>
        <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div></div>
        <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div></div>
    </div>
</div>
                </div>

                <div id="activity-tab" class="tab-content">
                    <div id="activityContent">
                    <div class="skeleton-activity"><div class="skeleton skeleton-avatar"></div><div class="skeleton-activity-content"><div class="skeleton skeleton-line short"></div><div class="skeleton skeleton-line long"></div><div class="skeleton skeleton-line medium"></div></div></div>
                    <div class="skeleton-activity"><div class="skeleton skeleton-avatar"></div><div class="skeleton-activity-content"><div class="skeleton skeleton-line short"></div><div class="skeleton skeleton-line long"></div><div class="skeleton skeleton-line medium"></div></div></div>
                    <div class="skeleton-activity"><div class="skeleton skeleton-avatar"></div><div class="skeleton-activity-content"><div class="skeleton skeleton-line short"></div><div class="skeleton skeleton-line long"></div><div class="skeleton skeleton-line medium"></div></div></div>
                </div>
                </div>
            </div>
        </div>
    </main>
    <footer><div class="container">&copy; 2025 Mineral Watch</div></footer>
    
    <!-- Add Property Modal -->
    <div class="modal-overlay" id="addPropertyModal">
        <div class="modal">
            <h2>Add Property</h2>
            <form id="addPropertyForm">
                <div class="form-group full">
                    <label for="county">County</label>
                    <select id="county" required>
                        <option value="">Select County</option>
                        <option>Alfalfa</option><option>Atoka</option><option>Beaver</option><option>Beckham</option><option>Blaine</option><option>Bryan</option><option>Caddo</option><option>Canadian</option><option>Carter</option><option>Cherokee</option><option>Choctaw</option><option>Cimarron</option><option>Cleveland</option><option>Coal</option><option>Comanche</option><option>Cotton</option><option>Craig</option><option>Creek</option><option>Custer</option><option>Delaware</option><option>Dewey</option><option>Ellis</option><option>Garfield</option><option>Garvin</option><option>Grady</option><option>Grant</option><option>Greer</option><option>Harmon</option><option>Harper</option><option>Haskell</option><option>Hughes</option><option>Jackson</option><option>Jefferson</option><option>Johnston</option><option>Kay</option><option>Kingfisher</option><option>Kiowa</option><option>Latimer</option><option>Le Flore</option><option>Lincoln</option><option>Logan</option><option>Love</option><option>Major</option><option>Marshall</option><option>Mayes</option><option>McClain</option><option>McCurtain</option><option>McIntosh</option><option>Murray</option><option>Muskogee</option><option>Noble</option><option>Nowata</option><option>Okfuskee</option><option>Oklahoma</option><option>Okmulgee</option><option>Osage</option><option>Ottawa</option><option>Pawnee</option><option>Payne</option><option>Pittsburg</option><option>Pontotoc</option><option>Pottawatomie</option><option>Pushmataha</option><option>Roger Mills</option><option>Rogers</option><option>Seminole</option><option>Sequoyah</option><option>Stephens</option><option>Texas</option><option>Tillman</option><option>Tulsa</option><option>Wagoner</option><option>Washington</option><option>Washita</option><option>Woods</option><option>Woodward</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="section">Section</label>
                        <input type="text" id="section" placeholder="e.g. 15" required>
                    </div>
                    <div class="form-group">
                        <label for="township">Township</label>
                        <input type="text" id="township" placeholder="e.g. 12N" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="range">Range</label>
                        <input type="text" id="range" placeholder="e.g. 4W" required>
                    </div>
                    <div class="form-group">
                        <label for="meridian">Meridian</label>
                        <select id="meridian">
                            <option value="IM">Indian Meridian (IM)</option>
                            <option value="CM">Cimarron Meridian (CM)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closePropertyModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Add Property</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Well Modal -->
    <div class="modal-overlay" id="addWellModal">
        <div class="modal">
            <h2>Add Well API</h2>
            <form id="addWellForm">
                <div class="form-group full">
                    <label for="apiNumber">API Number *</label>
                    <input type="text" id="apiNumber" placeholder="3515322352" required>
                    <div class="form-hint">10-digit Oklahoma well API (starts with 35)</div>
                </div>
                <div class="form-group full">
                    <label for="wellName">Well Name (Optional)</label>
                    <input type="text" id="wellName" placeholder="Your reference name">
                    <div class="form-hint">Optional nickname for your own reference</div>
                </div>
                <div class="form-group full">
                    <label for="wellNotes">Notes (Optional)</label>
                    <textarea id="wellNotes" placeholder="Any notes about this well"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeWellModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Add Well</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Well Details Modal -->
    <div class="modal-overlay" id="wellDetailsModal">
        <div class="modal" style="max-width: 550px;">
            <h2 style="margin-bottom: 5px;" id="wellDetailsTitle">Well Details</h2>
            <p style="color: var(--slate-blue); font-size: 14px; margin-bottom: 20px;" id="wellDetailsApi">API: ‚Äî</p>
            
            <div class="details-grid">
                <div class="details-row">
                    <span class="details-label">Operator</span>
                    <span class="details-value" id="wellDetailsOperator">‚Äî</span>
                </div>
                <div class="details-row">
                    <span class="details-label">Location</span>
                    <span class="details-value" id="wellDetailsLocation">‚Äî</span>
                </div>
                <div class="details-row">
                    <span class="details-label">County</span>
                    <span class="details-value" id="wellDetailsCounty">‚Äî</span>
                </div>
                <div class="details-row">
                    <span class="details-label">Well Type</span>
                    <span class="details-value" id="wellDetailsType">‚Äî</span>
                </div>
                <div class="details-row">
                    <span class="details-label">OCC Status</span>
                    <span class="details-value" id="wellDetailsStatus">‚Äî</span>
                </div>
                <div class="details-row" style="flex-direction: column; align-items: flex-start;">
                    <span class="details-label" style="margin-bottom: 8px;">Notes</span>
                    <textarea id="wellDetailsNotes" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical;" placeholder="Add notes about this well..."></textarea>
                </div>
            </div>
            
            <div class="details-actions">
                <a href="#" target="_blank" class="details-btn primary" id="wellDetailsMapLink">üìç View on Map</a>
                <a href="#" target="_blank" class="details-btn" id="wellDetailsOccLink">üìÑ OCC Filing</a>
            </div>
            
            <input type="hidden" id="wellDetailsId">
            <div class="modal-buttons" style="margin-top: 20px;">
                <button type="button" class="btn-cancel" onclick="closeWellDetailsModal()">Close</button>
                <button type="button" class="btn-submit" onclick="saveWellNotes()">Save Notes</button>
            </div>
        </div>
    </div>
    
    <!-- Property Details Modal -->
    <div class="modal-overlay" id="propertyDetailsModal">
        <div class="modal" style="max-width: 500px;">
            <h2 style="margin-bottom: 5px;" id="propertyDetailsTitle">Property Details</h2>
            <p style="color: var(--slate-blue); font-size: 14px; margin-bottom: 20px;" id="propertyDetailsLegal">‚Äî</p>
            
            <div class="details-grid">
                <div class="details-row">
                    <span class="details-label">County</span>
                    <span class="details-value" id="propertyDetailsCounty">‚Äî</span>
                </div>
                <div class="details-row">
                    <span class="details-label">Section</span>
                    <span class="details-value" id="propertyDetailsSection">‚Äî</span>
                </div>
                <div class="details-row">
                    <span class="details-label">Township</span>
                    <span class="details-value" id="propertyDetailsTownship">‚Äî</span>
                </div>
                <div class="details-row">
                    <span class="details-label">Range</span>
                    <span class="details-value" id="propertyDetailsRange">‚Äî</span>
                </div>
                <div class="details-row">
                    <span class="details-label">Meridian</span>
                    <select id="propertyDetailsMeridian" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white;">
                        <option value="IM">IM (Indian Meridian)</option>
                        <option value="CM">CM (Cimarron Meridian)</option>
                    </select>
                </div>
                <div class="details-row">
                    <span class="details-label">Monitor Adjacent</span>
                    <span class="details-value" id="propertyDetailsAdjacent">‚Äî</span>
                </div>
                <div class="details-row" style="flex-direction: column; align-items: flex-start;">
                    <span class="details-label" style="margin-bottom: 8px;">Notes</span>
                    <textarea id="propertyDetailsNotes" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical;" placeholder="Add notes about this property..."></textarea>
                </div>
            </div>
            
            <input type="hidden" id="propertyDetailsId">
            <div class="modal-buttons" style="margin-top: 20px;">
                <button type="button" class="btn-cancel" onclick="closePropertyDetailsModal()">Close</button>
                <button type="button" class="btn-submit" onclick="savePropertyDetails()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        // Security: escape HTML to prevent XSS from user-generated content
        function escapeHtml(text) {
            if (!text) return '';
            const str = String(text);
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        const planConfigs = { 
            'Free': { properties: 1, wells: 1 }, 
            'Starter': { properties: 10, wells: 10 }, 
            'Standard': { properties: 50, wells: 50 }, 
            'Professional': { properties: 250, wells: 250 }, 
            'Enterprise': { properties: Infinity, wells: Infinity } 
        };
        let currentTab = 'properties';
        let currentUser = null; // Store user data globally
        
        // Bulk Selection State
        let selectedProperties = new Set();
        let selectedWells = new Set();
        
        // Bulk Selection Functions
        function updateBulkActionVisibility() {
            // Show/hide bulk action bars based on selection state
            const propBar = document.getElementById('propertiesBulkActionBar');
            const wellBar = document.getElementById('wellsBulkActionBar');
            
            if (propBar) {
                propBar.style.display = selectedProperties.size > 0 ? 'flex' : 'none';
                const count = document.querySelector('#propertiesBulkActionBar .selected-count');
                if (count) count.textContent = selectedProperties.size;
            }
            
            if (wellBar) {
                wellBar.style.display = selectedWells.size > 0 ? 'flex' : 'none';
                const count = document.querySelector('#wellsBulkActionBar .selected-count');
                if (count) count.textContent = selectedWells.size;
            }
        }
        
        function togglePropertySelection(propertyId, checked) {
            if (checked) {
                selectedProperties.add(propertyId);
            } else {
                selectedProperties.delete(propertyId);
            }
            updateBulkActionVisibility();
            updateSelectAllState('properties');
        }
        
        function toggleWellSelection(wellId, checked) {
            if (checked) {
                selectedWells.add(wellId);
            } else {
                selectedWells.delete(wellId);
            }
            updateBulkActionVisibility();
            updateSelectAllState('wells');
        }
        
        function selectAllItems(type, checked) {
            if (type === 'properties') {
                const checkboxes = document.querySelectorAll('.property-checkbox');
                selectedProperties.clear();
                checkboxes.forEach(cb => {
                    cb.checked = checked;
                    if (checked) selectedProperties.add(cb.dataset.id);
                });
            } else if (type === 'wells') {
                const checkboxes = document.querySelectorAll('.well-checkbox');
                selectedWells.clear();
                checkboxes.forEach(cb => {
                    cb.checked = checked;
                    if (checked) selectedWells.add(cb.dataset.id);
                });
            }
            updateBulkActionVisibility();
        }
        
        function updateSelectAllState(type) {
            const selectAllId = type === 'properties' ? 'selectAllProperties' : 'selectAllWells';
            const checkboxes = document.querySelectorAll(type === 'properties' ? '.property-checkbox' : '.well-checkbox');
            const selectedSet = type === 'properties' ? selectedProperties : selectedWells;
            const selectAllCheckbox = document.getElementById(selectAllId);
            
            if (!selectAllCheckbox) return;
            
            if (selectedSet.size === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedSet.size === checkboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }
        }
        
        async function bulkDeleteSelected(type) {
            const selectedSet = type === 'properties' ? selectedProperties : selectedWells;
            const itemName = type === 'properties' ? 'properties' : 'wells';
            
            if (selectedSet.size === 0) return;
            
            const confirmMsg = `Delete ${selectedSet.size} ${itemName}? This cannot be undone.`;
            if (!confirm(confirmMsg)) return;
            
            // Get the delete button and add loading state
            const deleteBtn = event.target;
            deleteBtn.classList.add('loading');
            deleteBtn.disabled = true;
            
            try {
                const itemsToDelete = Array.from(selectedSet);
                let successCount = 0;
                let failCount = 0;
                
                // Batch deletes in groups of 5 (Airtable rate limit)
                for (let i = 0; i < itemsToDelete.length; i += 5) {
                    const batch = itemsToDelete.slice(i, i + 5);
                    const deletePromises = batch.map(id => {
                        const endpoint = type === 'properties' ? `/api/properties/${id}` : `/api/wells/${id}`;
                        return fetch(endpoint, { method: 'DELETE' })
                            .then(res => res.ok ? successCount++ : failCount++)
                            .catch(() => failCount++);
                    });
                    
                    await Promise.all(deletePromises);
                    
                    // Wait 1 second between batches for rate limiting
                    if (i + 5 < itemsToDelete.length) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                // Clear selection
                selectedSet.clear();
                updateBulkActionVisibility();
                
                // Reload data
                await loadAllData();
                
                // Show success toast
                if (failCount === 0) {
                    showToast(`Successfully deleted ${successCount} ${itemName}`, 'success', 4000);
                } else {
                    showToast(`Deleted ${successCount} ${itemName}. ${failCount} failed.`, 'error', 6000);
                }
                
            } catch (err) {
                console.error(`Bulk delete ${itemName} error:`, err);
                showToast(`Failed to delete ${itemName}. Please try again.`, 'error');
            } finally {
                // Remove loading state
                deleteBtn.classList.remove('loading');
                deleteBtn.disabled = false;
            }
        }
        
        function clearSelection(type) {
            if (type === 'properties') {
                selectedProperties.clear();
                document.querySelectorAll('.property-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('selectAllProperties').checked = false;
                document.getElementById('selectAllProperties').indeterminate = false;
            } else if (type === 'wells') {
                selectedWells.clear();
                document.querySelectorAll('.well-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('selectAllWells').checked = false;
                document.getElementById('selectAllWells').indeterminate = false;
            }
            updateBulkActionVisibility();
        }
        
        async function bulkAddToWells() {
            if (selectedProperties.size === 0) return;
            
            // Get selected property data
            const selectedPropData = loadedProperties.filter(p => selectedProperties.has(p.id));
            
            try {
                const addPromises = selectedPropData.map(async (prop) => {
                    const fields = prop.fields;
                    
                    // Check if well already exists for this property
                    const existingWell = loadedWells.find(w => 
                        w.fields.Section === fields.SEC &&
                        w.fields.Township === fields.TWN &&
                        w.fields.Range === fields.RNG &&
                        w.fields.County === fields.COUNTY
                    );
                    
                    if (existingWell) {
                        console.log(`Well already exists for ${fields.COUNTY} S${fields.SEC} T${fields.TWN} R${fields.RNG}`);
                        return null;
                    }
                    
                    // Create well data from property
                    const wellData = {
                        'Well Name': `${fields.COUNTY} S${fields.SEC} T${fields.TWN} R${fields.RNG}`,
                        'County': fields.COUNTY,
                        'Section': fields.SEC,
                        'Township': fields.TWN,
                        'Range': fields.RNG,
                        'API Number': '', // Will be filled when user adds it
                        'Email': currentUser.email
                    };
                    
                    const res = await fetch('/api/wells', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(wellData)
                    });
                    
                    if (!res.ok) throw new Error(`Failed to create well for ${wellData['Well Name']}`);
                    return await res.json();
                });
                
                const results = await Promise.all(addPromises);
                const created = results.filter(r => r !== null).length;
                const skipped = results.length - created;
                
                // Clear selection and reload data
                clearSelection('properties');
                await loadWells();
                
                let message = `Successfully created ${created} wells`;
                if (skipped > 0) message += ` (${skipped} already existed)`;
                showToast(message);
                
            } catch (err) {
                console.error('Bulk add to wells error:', err);
                showToast('Failed to add some properties as wells. Please try again.', 'error');
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/auth/me');
                if (!res.ok) { window.location.href = '/portal/login'; return; }
                currentUser = await res.json();
                document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                document.getElementById('planBadge').textContent = currentUser.plan || 'FREE';
                const limits = planConfigs[currentUser.plan] || { properties: 1, wells: 0 };
                document.getElementById('propLimit').textContent = limits.properties === Infinity ? '‚àû' : limits.properties;
                document.getElementById('wellLimit').textContent = limits.wells === Infinity ? '‚àû' : limits.wells;
                
                // Hide upgrade link for Enterprise users
                if (currentUser.plan === 'Enterprise') {
                    document.getElementById('upgradeLink').style.display = 'none';
                }
                
                // Show export buttons for Professional and Enterprise users
                if (currentUser.plan === 'Professional' || currentUser.plan === 'Enterprise') {
                    document.getElementById('exportPropertiesBtn').style.display = 'inline-flex';
                    document.getElementById('exportWellsBtn').style.display = 'inline-flex';
                }
                
                await loadAllData();

                // Initialize search/sort controls
                initWellsControls();
                initPropertiesControls();
            } catch { window.location.href = '/portal/login'; }

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentTab = tab.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(currentTab + '-tab').classList.add('active');
                    
                    // Load activity data when tab is selected (lazy load)
                    if (currentTab === 'activity') {
                        loadActivity();
                    }
                });
            });
            
            // Bulk selection event listeners
            document.addEventListener('change', (e) => {
                // Handle select all checkboxes
                if (e.target.id === 'selectAllProperties') {
                    selectAllItems('properties', e.target.checked);
                } else if (e.target.id === 'selectAllWells') {
                    selectAllItems('wells', e.target.checked);
                }
                // Handle individual checkboxes
                else if (e.target.classList.contains('property-checkbox')) {
                    togglePropertySelection(e.target.dataset.id, e.target.checked);
                } else if (e.target.classList.contains('well-checkbox')) {
                    toggleWellSelection(e.target.dataset.id, e.target.checked);
                }
            });
        });
        
        async function loadAllData() {
        await Promise.all([loadProperties(), loadWells(), loadActivityStats()]);
}

        async function loadProperties() {
            try {
                const res = await fetch('/api/properties');
                if (!res.ok) throw new Error('Failed to load');
                const properties = await res.json();
                loadedProperties = properties; // Store for filtering/sorting
                document.getElementById('propCount').textContent = properties.length;
                updateTotalCount();
                
                
                // Render the table (handles empty state internally)
                renderPropertiesTable();
            } catch { document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p style="color: var(--error);">Error loading. Refresh page.</p></div>'; }
        }
        
        // Generate a map link for a property section (centers on general area)
        function generateSectionMapLink(sec, twn, rng, county) {
            // Link to OCC GIS with a search query - this will show the general area
            // We can't pin-drop without coordinates, but we can search
            const searchTerm = encodeURIComponent(`${county || ''} ${sec} ${twn} ${rng}`.trim());
            return `https://gis.occ.ok.gov/portal/apps/webappviewer/index.html?id=ba9b8612132f4106be6e3553dc0b827b`;
        }

        async function loadWells() {
            try {
                const res = await fetch('/api/wells');
                if (!res.ok) throw new Error('Failed to load');
                const wells = await res.json();
                loadedWells = wells; // Store for filtering/sorting
                document.getElementById('wellCount').textContent = wells.length;
                updateTotalCount();
                
                
                // Render the table (handles empty state internally)
                renderWellsTable();
            } catch { document.getElementById('wellsContent').innerHTML = '<div class="empty-state"><p style="color: var(--error);">Error loading. Refresh page.</p></div>'; }
        }

        // Properties Search & Sort State
        let propertiesSearchTerm = '';
        let propertiesSortBy = 'legal-asc';

        // Initialize Properties Controls (call this after user loads)
        function initPropertiesControls() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Show/hide controls based on plan
            document.getElementById('propertiesControls').style.display = hasSearch ? 'flex' : 'none';
            
            if (!hasSearch) return;
            
            // Search input handler
            document.getElementById('propertiesSearch').addEventListener('input', (e) => {
                propertiesSearchTerm = e.target.value.toLowerCase().trim();
                renderPropertiesTable();
            });
            
            // Sort select handler
            document.getElementById('propertiesSort').addEventListener('change', (e) => {
                propertiesSortBy = e.target.value;
                renderPropertiesTable();
            });
        }

        // Filter properties based on search term
        function filterProperties(properties) {
            if (!propertiesSearchTerm) return properties;
            
            return properties.filter(p => {
                const f = p.fields;
                const searchable = [
                    f.COUNTY || '',
                    f.SEC || '',
                    f.TWN || '',
                    f.RNG || '',
                    f.MERIDIAN || '',
                    f.Notes || ''
                ].join(' ').toLowerCase();
                
                return searchable.includes(propertiesSearchTerm);
            });
        }

        // Sort properties based on selected option
        function sortProperties(properties) {
            const [field, direction] = propertiesSortBy.split('-');
            const multiplier = direction === 'asc' ? 1 : -1;
            
            return [...properties].sort((a, b) => {
                if (field === 'legal') {
                    // Legal Description: County ‚Üí Township ‚Üí Range ‚Üí Section
                    const aCounty = (a.fields.COUNTY || '').toLowerCase();
                    const bCounty = (b.fields.COUNTY || '').toLowerCase();
                    if (aCounty !== bCounty) {
                        return aCounty < bCounty ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse township (e.g., "T24N" -> { num: 24, dir: "N" })
                    const parseTownship = (twp) => {
                        const match = (twp || '').match(/T?(\d+)([NS])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aTwp = parseTownship(a.fields.TWN);
                    const bTwp = parseTownship(b.fields.TWN);
                    if (aTwp.num !== bTwp.num) {
                        return aTwp.num < bTwp.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aTwp.dir !== bTwp.dir) {
                        return aTwp.dir < bTwp.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse range (e.g., "R10W" -> { num: 10, dir: "W" })
                    const parseRange = (rng) => {
                        const match = (rng || '').match(/R?(\d+)([EW])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aRng = parseRange(a.fields.RNG);
                    const bRng = parseRange(b.fields.RNG);
                    if (aRng.num !== bRng.num) {
                        return aRng.num < bRng.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aRng.dir !== bRng.dir) {
                        return aRng.dir < bRng.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Section (numeric)
                    const aSection = parseInt(a.fields.SEC) || 0;
                    const bSection = parseInt(b.fields.SEC) || 0;
                    return aSection < bSection ? -1 * multiplier : (aSection > bSection ? 1 * multiplier : 0);
                    
                } else if (field === 'date') {
                    // Date Added - use createdTime from Airtable
                    const aDate = new Date(a.createdTime || 0);
                    const bDate = new Date(b.createdTime || 0);
                    return aDate < bDate ? -1 * multiplier : (aDate > bDate ? 1 * multiplier : 0);
                }
                
                return 0;
            });
        }

        // Render the properties table (extracted from loadProperties)
        function renderPropertiesTable() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Apply filter and sort
            let displayProperties = loadedProperties;
            if (hasSearch) {
                displayProperties = filterProperties(loadedProperties);
                displayProperties = sortProperties(displayProperties);
                
                // Update results count
                const countEl = document.getElementById('propertiesResultsCount');
                if (propertiesSearchTerm) {
                    countEl.textContent = `${displayProperties.length} of ${loadedProperties.length} properties`;
                } else {
                    countEl.textContent = `${loadedProperties.length} properties`;
                }
            }
            
            if (displayProperties.length === 0 && loadedProperties.length > 0) {
                // No search results
                document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p>No properties match your search.</p></div>';
                return;
            }
            
            if (displayProperties.length === 0) {
                document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p>No properties yet. Add your first property to start monitoring.</p></div>';
                return;
            }
            
            let html = '<table class="data-table"><colgroup><col class="col-select"><col class="col-prop-county"><col class="col-prop-legal"><col class="col-prop-notes"><col class="col-actions"></colgroup><thead><tr><th class="bulk-only"><input type="checkbox" id="selectAllProperties" title="Select all"></th><th>County</th><th>Legal</th><th>Notes</th><th></th></tr></thead><tbody>';
            
            displayProperties.forEach(p => {
                const f = p.fields;
                const str = `S${f.SEC} T${f.TWN} R${f.RNG}`;
                const notesText = f.Notes ? escapeHtml(f.Notes.substring(0, 30)) + (f.Notes.length > 30 ? '...' : '') : '';
                const notes = notesText ? `<span style="color: var(--slate-blue); font-size: 13px;">${notesText}</span>` : '<em style="color: #A0AEC0;">‚Äî</em>';
                
                html += `<tr>
                    <td class="bulk-only"><input type="checkbox" class="property-checkbox" data-id="${p.id}"></td>
                    <td>${escapeHtml(f.COUNTY) || '‚Äî'}</td>
                    <td><strong>${str}</strong></td>
                    <td>${notes}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn-link" onclick="openPropertyDetails('${p.id}')">Details</button>
                        <button class="btn-delete" onclick="deleteProperty('${p.id}')" title="Delete property">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('propertiesContent').innerHTML = html;
            
            // Update bulk selection state after table render
            updateSelectAllState('properties');
            updateBulkActionVisibility();
        }

        // Wells Search & Sort State
        let wellsSearchTerm = '';
        let wellsSortBy = 'legal-asc';

        // Initialize Wells Controls (call this after user loads)
        function initWellsControls() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Show/hide controls based on plan
            document.getElementById('wellsControls').style.display = hasSearch ? 'flex' : 'none';
            
            if (!hasSearch) return;
            
            // Search input handler
            document.getElementById('wellsSearch').addEventListener('input', (e) => {
                wellsSearchTerm = e.target.value.toLowerCase().trim();
                renderWellsTable();
            });
            
            // Sort select handler
            document.getElementById('wellsSort').addEventListener('change', (e) => {
                wellsSortBy = e.target.value;
                renderWellsTable();
            });
        }

        // Filter wells based on search term
        function filterWells(wells) {
            if (!wellsSearchTerm) return wells;
            
            return wells.filter(w => {
                const f = w.fields;
                const searchable = [
                    f['Well Name'] || '',
                    f['Operator'] || '',
                    f['API Number'] || '',
                    f['County'] || ''
                ].join(' ').toLowerCase();
                
                return searchable.includes(wellsSearchTerm);
            });
        }

        // Sort wells based on selected option
        function sortWells(wells) {
            const [field, direction] = wellsSortBy.split('-');
            const multiplier = direction === 'asc' ? 1 : -1;
            
            return [...wells].sort((a, b) => {
                if (field === 'legal') {
                    // Legal Description: County ‚Üí Township ‚Üí Range ‚Üí Section
                    const aCounty = (a.fields['County'] || '').toLowerCase();
                    const bCounty = (b.fields['County'] || '').toLowerCase();
                    if (aCounty !== bCounty) {
                        return aCounty < bCounty ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse township (e.g., "T24N" -> { num: 24, dir: "N" })
                    const parseTownship = (twp) => {
                        const match = (twp || '').match(/T?(\d+)([NS])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aTwp = parseTownship(a.fields['Township']);
                    const bTwp = parseTownship(b.fields['Township']);
                    if (aTwp.num !== bTwp.num) {
                        return aTwp.num < bTwp.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aTwp.dir !== bTwp.dir) {
                        return aTwp.dir < bTwp.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse range (e.g., "R10W" -> { num: 10, dir: "W" })
                    const parseRange = (rng) => {
                        const match = (rng || '').match(/R?(\d+)([EW])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aRng = parseRange(a.fields['Range']);
                    const bRng = parseRange(b.fields['Range']);
                    if (aRng.num !== bRng.num) {
                        return aRng.num < bRng.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aRng.dir !== bRng.dir) {
                        return aRng.dir < bRng.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Section (numeric)
                    const aSection = parseInt(a.fields['Section']) || 0;
                    const bSection = parseInt(b.fields['Section']) || 0;
                    return aSection < bSection ? -1 * multiplier : (aSection > bSection ? 1 * multiplier : 0);
                    
                } else if (field === 'date') {
                    // Date Added - use createdTime from Airtable
                    const aDate = new Date(a.createdTime || 0);
                    const bDate = new Date(b.createdTime || 0);
                    return aDate < bDate ? -1 * multiplier : (aDate > bDate ? 1 * multiplier : 0);
                    
                } else if (field === 'name') {
                    // Well Name
                    const aVal = (a.fields['Well Name'] || '').toLowerCase();
                    const bVal = (b.fields['Well Name'] || '').toLowerCase();
                    return aVal < bVal ? -1 * multiplier : (aVal > bVal ? 1 * multiplier : 0);
                    
                } else if (field === 'operator') {
                    // Operator
                    const aVal = (a.fields['Operator'] || '').toLowerCase();
                    const bVal = (b.fields['Operator'] || '').toLowerCase();
                    return aVal < bVal ? -1 * multiplier : (aVal > bVal ? 1 * multiplier : 0);
                }
                
                return 0;
            });
        }

        // Render the wells table (extracted from loadWells)
        function renderWellsTable() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Apply filter and sort
            let displayWells = loadedWells;
            if (hasSearch) {
                displayWells = filterWells(loadedWells);
                displayWells = sortWells(displayWells);
                
                // Update results count
                const countEl = document.getElementById('wellsResultsCount');
                if (wellsSearchTerm) {
                    countEl.textContent = `${displayWells.length} of ${loadedWells.length} wells`;
                } else {
                    countEl.textContent = `${loadedWells.length} wells`;
                }
            }
            
            if (displayWells.length === 0 && loadedWells.length > 0) {
                // No search results
                document.getElementById('wellsContent').innerHTML = '<div class="empty-state"><p>No wells match your search.</p></div>';
                return;
            }
            
            if (displayWells.length === 0) {
                document.getElementById('wellsContent').innerHTML = '<div class="empty-state"><p>No wells yet. Add your first well API to start monitoring.</p></div>';
                return;
            }
            
            let html = '<table class="data-table"><colgroup><col class="col-select"><col class="col-well-name"><col class="col-operator"><col class="col-api"><col class="col-county"><col class="col-location"><col class="col-actions"></colgroup><thead><tr><th class="bulk-only"><input type="checkbox" id="selectAllWells" title="Select all"></th><th>Well Name</th><th>Operator</th><th>API</th><th>County</th><th>Legal</th><th></th></tr></thead><tbody>';
            
            displayWells.forEach(w => {
                const f = w.fields;
                const wellName = f['Well Name'] ? escapeHtml(f['Well Name']) : '<em style="color: #A0AEC0;">Unknown</em>';
                const operator = f['Operator'] ? escapeHtml(f['Operator']) : '<em style="color: #A0AEC0;">‚Äî</em>';
                const county = escapeHtml(f['County']) || '‚Äî';
                const section = f['Section'] || '';
                const township = f['Township'] || '';
                const range = f['Range'] || '';
                const str = (section && township && range) ? `S${section} T${township} R${range}` : '‚Äî';
                const mapLink = f['OCC Map Link'] && f['OCC Map Link'] !== '#' ? f['OCC Map Link'] : null;
                
                html += `<tr>
                    <td class="bulk-only"><input type="checkbox" class="well-checkbox" data-id="${w.id}"></td>
                    <td><strong>${wellName}</strong></td>
                    <td>${operator}</td>
                    <td>${escapeHtml(f['API Number'])}</td>
                    <td>${county}</td>
                    <td>${str}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn-link" onclick="openWellDetails('${w.id}')">Details</button>
                        ${mapLink ? `<button class="btn-link" onclick="window.open('${escapeHtml(mapLink)}', '_blank')">Map</button>` : ''}
                        <button class="btn-delete" onclick="deleteWell('${w.id}')" title="Delete well">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('wellsContent').innerHTML = html;
            
            // Update bulk selection state after table render
            updateSelectAllState('wells');
            updateBulkActionVisibility();
        }

        function updateTotalCount() {
            // No longer needed - separate limits shown
        }
        
        async function loadActivityStats() {
            try {
                const res = await fetch('/api/activity/stats');
                if (!res.ok) return;
                const stats = await res.json();
                
                // Format last alert date
                if (stats.lastAlert) {
                    const date = new Date(stats.lastAlert);
                    const now = new Date();
                    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                    
                    let lastAlertText;
                    if (diffDays === 0) lastAlertText = 'Today';
                    else if (diffDays === 1) lastAlertText = 'Yesterday';
                    else if (diffDays < 7) lastAlertText = diffDays + ' days ago';
                    else if (diffDays < 30) lastAlertText = Math.floor(diffDays / 7) + ' weeks ago';
                    else lastAlertText = date.toLocaleDateString();
                    
                    document.getElementById('statLastAlert').textContent = lastAlertText;
                } else {
                    document.getElementById('statLastAlert').textContent = 'No alerts yet';
                }
                
                document.getElementById('statThisMonth').textContent = stats.thisMonth;
                document.getElementById('statThisYear').textContent = stats.thisYear;
            } catch (err) {
                console.error('Failed to load activity stats:', err);
            }
        }
        
        async function loadActivity() {
            try {
                const res = await fetch('/api/activity');
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();
                const records = data.records || [];
                const recordLimit = data.recordLimit || 5;
                const plan = data.plan || 'Free';
                
                if (records.length === 0) {
                    let msg = `<div class="empty-state"><p>No activity recorded yet.</p><p style="font-size: 13px; color: var(--slate-blue);">When wells on your properties have status changes, they'll appear here.</p></div>`;
                    document.getElementById('activityContent').innerHTML = msg;
                    return;
                }
                
                let html = '<div class="activity-list">';
                
                // Show limit notice for lower tiers
                if (recordLimit < 100 && plan !== 'Professional' && plan !== 'Enterprise') {
                    html += `<div class="activity-limit-notice">Showing last ${recordLimit} alerts. <a href="/portal/upgrade">Upgrade</a> for more history.</div>`;
                }
                
                records.forEach(r => {
                    const f = r.fields;
                    const activityType = f['Activity Type'] || 'Status Change';
                    const alertLevel = f['Alert Level'] || 'YOUR PROPERTY';
                    
                    // Icon and class based on activity type
                    let icon = 'üìã';
                    let iconClass = 'status';
                    if (activityType.includes('Permit')) { icon = 'üìã'; iconClass = 'permit'; }
                    else if (activityType.includes('Drilling')) { icon = 'üî®'; iconClass = 'drilling'; }
                    else if (activityType.includes('Completed')) { icon = '‚úÖ'; iconClass = 'completed'; }
                    else if (activityType.includes('Transfer')) { icon = 'üîÑ'; iconClass = 'transfer'; }
                    else if (activityType.includes('Abandoned') || activityType.includes('Plugged')) { icon = '‚õî'; iconClass = 'abandoned'; }
                    
                    // Alert level class
                    let levelClass = 'property';
                    if (alertLevel.includes('ADJACENT')) levelClass = 'adjacent';
                    else if (alertLevel.includes('TRACKED')) levelClass = 'tracked';
                    
                    // Format date
                    const date = new Date(f['Detected At']);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    
                    // Build change text
                    let changeText = '';
                    if (f['Previous Value'] && f['New Value']) {
                        if (activityType.includes('Transfer')) {
                            changeText = `${f['Previous Value']} ‚Üí ${f['New Value']}`;
                        } else {
                            changeText = `Status: ${f['Previous Value']} ‚Üí ${f['New Value']}`;
                        }
                    }
                    
                    // Build action buttons
                    const occLink = f['OCC Link'];
                    const mapLink = f['Map Link'];
                    let actionsHtml = '<div class="activity-actions">';
                    if (occLink) {
                        actionsHtml += `<a href="${escapeHtml(occLink)}" target="_blank" class="activity-btn">OCC Filing</a>`;
                    }
                    if (mapLink) {
                        actionsHtml += `<a href="${escapeHtml(mapLink)}" target="_blank" class="activity-btn">View Map</a>`;
                    }
                    actionsHtml += '</div>';
                    
                    html += `
                        <div class="activity-item">
                            <div class="activity-icon ${iconClass}">${icon}</div>
                            <div class="activity-details">
                                <div class="activity-header">
                                    <span class="activity-type">${escapeHtml(activityType)}</span>
                                    <span class="activity-level ${levelClass}">${escapeHtml(alertLevel.replace('_', ' '))}</span>
                                </div>
                                <div class="activity-well">${escapeHtml(f['Well Name']) || 'Unknown Well'}</div>
                                <div class="activity-meta">${escapeHtml(f['Operator']) || ''} ‚Ä¢ ${escapeHtml(f['Section-Township-Range']) || ''} ‚Ä¢ ${escapeHtml(f['County']) || ''}</div>
                                ${changeText ? `<div class="activity-change">${escapeHtml(changeText)}</div>` : ''}
                                ${(occLink || mapLink) ? actionsHtml : ''}
                            </div>
                            <div class="activity-date">${dateStr}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('activityContent').innerHTML = html;
            } catch (err) {
                document.getElementById('activityContent').innerHTML = '<div class="empty-state"><p style="color: var(--error);">Error loading activity. Refresh page.</p></div>';
            }
        }
        
        // Property Modal
        document.getElementById('addPropertyBtn').addEventListener('click', () => { 
            document.getElementById('addPropertyModal').style.display = 'flex'; 
        });
        
        function closePropertyModal() { 
            document.getElementById('addPropertyModal').style.display = 'none'; 
            document.getElementById('addPropertyForm').reset(); 
        }
        
        document.getElementById('addPropertyModal').addEventListener('click', e => { 
            if (e.target.id === 'addPropertyModal') closePropertyModal(); 
        });
        
        document.getElementById('addPropertyForm').addEventListener('submit', async e => {
            e.preventDefault();
            const data = { 
                COUNTY: document.getElementById('county').value, 
                SEC: document.getElementById('section').value, 
                TWN: document.getElementById('township').value, 
                RNG: document.getElementById('range').value, 
                MERIDIAN: document.getElementById('meridian').value 
            };
            try {
                const res = await fetch('/api/properties', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(data) 
                });
                if (!res.ok) { 
                    const err = await res.json(); 
                    throw new Error(err.error); 
                }
                closePropertyModal();
                await loadProperties();
            } catch (err) { alert(err.message); }
        });

        // Well Modal
        document.getElementById('addWellBtn').addEventListener('click', () => { 
            document.getElementById('addWellModal').style.display = 'flex'; 
        });
        
        // Bulk Upload Properties Modal
        document.getElementById('bulkUploadBtn').addEventListener('click', () => {
            openBulkUploadModal();
        });
        
        // Bulk Upload Wells Modal
        document.getElementById('bulkUploadWellsBtn').addEventListener('click', () => {
            openBulkUploadWellsModal();
        });
        
        function closeWellModal() { 
            document.getElementById('addWellModal').style.display = 'none'; 
            document.getElementById('addWellForm').reset(); 
        }
        
        document.getElementById('addWellModal').addEventListener('click', e => { 
            if (e.target.id === 'addWellModal') closeWellModal(); 
        });
        
        document.getElementById('addWellForm').addEventListener('submit', async e => {
            e.preventDefault();
            const data = { 
                apiNumber: document.getElementById('apiNumber').value, 
                wellName: document.getElementById('wellName').value,
                notes: document.getElementById('wellNotes').value
            };
            try {
                const res = await fetch('/api/wells', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(data) 
                });
                if (!res.ok) { 
                    const err = await res.json(); 
                    throw new Error(err.error); 
                }
                closeWellModal();
                await loadWells();
            } catch (err) { alert(err.message); }
        });
        
        async function deleteProperty(id) {
            if (!confirm('Remove this property?')) return;
            try {
                await fetch('/api/properties/' + id, { method: 'DELETE' });
                await loadProperties();
            } catch { alert('Error deleting.'); }
        }

        async function deleteWell(id) {
            if (!confirm('Remove this well?')) return;
            try {
                await fetch('/api/wells/' + id, { method: 'DELETE' });
                await loadWells();
            } catch { alert('Error deleting.'); }
        }
        
        // Store loaded data for details modals
        let loadedProperties = [];
        let loadedWells = [];
        
        // Well Details Modal Functions
        function openWellDetails(wellId) {
            const well = loadedWells.find(w => w.id === wellId);
            if (!well) return;
            
            const f = well.fields;
            document.getElementById('wellDetailsId').value = wellId;
            document.getElementById('wellDetailsTitle').textContent = f['Well Name'] || 'Unknown Well';
            document.getElementById('wellDetailsApi').textContent = 'API: ' + (f['API Number'] || '‚Äî');
            document.getElementById('wellDetailsOperator').textContent = f['Operator'] || '‚Äî';
            
            const sec = f['Section'] || '';
            const twn = f['Township'] || '';
            const rng = f['Range'] || '';
            document.getElementById('wellDetailsLocation').textContent = (sec && twn && rng) ? `S${sec} T${twn} R${rng}` : '‚Äî';
            
            document.getElementById('wellDetailsCounty').textContent = f['County'] || '‚Äî';
            document.getElementById('wellDetailsType').textContent = f['Well Type'] || '‚Äî';
            document.getElementById('wellDetailsStatus').textContent = f['Well Status'] || '‚Äî';
            document.getElementById('wellDetailsNotes').value = f['Notes'] || '';
            
            // Map link
            const mapLink = f['OCC Map Link'];
            const mapBtn = document.getElementById('wellDetailsMapLink');
            if (mapLink && mapLink !== '#') {
                mapBtn.href = mapLink;
                mapBtn.style.display = 'inline-flex';
            } else {
                mapBtn.style.display = 'none';
            }
            
            // OCC Filing link (Well Browse - works with API number)
            const occLink = `https://imaging.occ.ok.gov/imaging/OGWellRecords.aspx?api=${f['API Number']}`;
            document.getElementById('wellDetailsOccLink').href = occLink;
            
            document.getElementById('wellDetailsModal').style.display = 'flex';
        }
        
        async function saveWellNotes() {
            const wellId = document.getElementById('wellDetailsId').value;
            const notes = document.getElementById('wellDetailsNotes').value;
            
            try {
                const res = await fetch('/api/wells/' + wellId + '/notes', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const well = loadedWells.find(w => w.id === wellId);
                if (well) well.fields['Notes'] = notes;
                
                alert('Notes saved!');
                closeWellDetailsModal();
                await loadWells();
            } catch (err) {
                alert('Error saving notes.');
            }
        }
        
        function closeWellDetailsModal() {
            document.getElementById('wellDetailsModal').style.display = 'none';
        }
        
        document.getElementById('wellDetailsModal').addEventListener('click', e => {
            if (e.target.id === 'wellDetailsModal') closeWellDetailsModal();
        });
        
        // Property Details Modal Functions
        function openPropertyDetails(propId) {
            const prop = loadedProperties.find(p => p.id === propId);
            if (!prop) return;
            
            const f = prop.fields;
            document.getElementById('propertyDetailsId').value = propId;
            document.getElementById('propertyDetailsTitle').textContent = f['COUNTY'] || 'Property Details';
            document.getElementById('propertyDetailsLegal').textContent = `S${f.SEC} T${f.TWN} R${f.RNG}`;
            document.getElementById('propertyDetailsCounty').textContent = f['COUNTY'] || '‚Äî';
            document.getElementById('propertyDetailsSection').textContent = f['SEC'] || '‚Äî';
            document.getElementById('propertyDetailsTownship').textContent = f['TWN'] || '‚Äî';
            document.getElementById('propertyDetailsRange').textContent = f['RNG'] || '‚Äî';
            document.getElementById('propertyDetailsMeridian').value = f['MERIDIAN'] || 'IM';
            document.getElementById('propertyDetailsAdjacent').textContent = f['Monitor Adjacent'] ? 'Yes' : 'No';
            document.getElementById('propertyDetailsNotes').value = f['Notes'] || '';
            
            document.getElementById('propertyDetailsModal').style.display = 'flex';
        }
        
        async function savePropertyDetails() {
            const propId = document.getElementById('propertyDetailsId').value;
            const notes = document.getElementById('propertyDetailsNotes').value;
            const meridian = document.getElementById('propertyDetailsMeridian').value;
            
            try {
                const res = await fetch('/api/properties/' + propId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes, meridian })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const prop = loadedProperties.find(p => p.id === propId);
                if (prop) {
                    prop.fields['Notes'] = notes;
                    prop.fields['MERIDIAN'] = meridian;
                }
                
                alert('Changes saved!');
                closePropertyDetailsModal();
                await loadProperties();
            } catch (err) {
                alert('Error saving changes.');
            }
        }
        
        function closePropertyDetailsModal() {
            document.getElementById('propertyDetailsModal').style.display = 'none';
        }
        
        document.getElementById('propertyDetailsModal').addEventListener('click', e => {
            if (e.target.id === 'propertyDetailsModal') closePropertyDetailsModal();
        });
        
        // CSV Export Functions (Professional tier)
        function exportWellsCSV() {
            if (!loadedWells.length) {
                alert('No wells to export.');
                return;
            }
            
            const headers = ['API Number', 'Well Name', 'Operator', 'County', 'Section', 'Township', 'Range', 'Well Type', 'Well Status', 'OCC Map Link', 'Notes'];
            const rows = loadedWells.map(w => {
                const f = w.fields;
                return [
                    f['API Number'] || '',
                    (f['Well Name'] || '').replace(/,/g, ';'),
                    (f['Operator'] || '').replace(/,/g, ';'),
                    f['County'] || '',
                    f['Section'] || '',
                    f['Township'] || '',
                    f['Range'] || '',
                    f['Well Type'] || '',
                    f['Well Status'] || '',
                    f['OCC Map Link'] || '',
                    (f['Notes'] || '').replace(/,/g, ';').replace(/\\n/g, ' ')
                ].join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\\n');
            downloadCSV(csv, 'mineral-watch-wells.csv');
        }
        
        function exportPropertiesCSV() {
            if (!loadedProperties.length) {
                alert('No properties to export.');
                return;
            }
            
            const headers = ['County', 'Section', 'Township', 'Range', 'Meridian', 'Notes'];
            const rows = loadedProperties.map(p => {
                const f = p.fields;
                return [
                    f['COUNTY'] || '',
                    f['SEC'] || '',
                    f['TWN'] || '',
                    f['RNG'] || '',
                    f['MERIDIAN'] || 'IM',
                    (f['Notes'] || '').replace(/,/g, ';').replace(/\\n/g, ' ')
                ].join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\\n');
            downloadCSV(csv, 'mineral-watch-properties.csv');
        }
        
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }
        
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/portal/login';
        });
        
        // Toast notification system
        function showToast(message, type = 'success', duration = 3000) {
            // Remove any existing toasts
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = `toast toast-${type}`;
            
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${escapeHtml(message)}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('toast-show'), 10);
            
            // Auto dismiss
            setTimeout(() => {
                toast.classList.remove('toast-show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
    </script>

<!-- BULK UPLOAD MODAL - REDESIGNED -->
<div class="modal-overlay" id="bulk-upload-modal">
    <div class="modal bulk-modal">
        <!-- Header -->
        <div class="bulk-header">
            <h2>Bulk Upload Properties</h2>
            <button class="bulk-close" onclick="closeBulkUploadModal()">&times;</button>
        </div>
        
        <!-- Step 1: File Upload -->
        <div id="upload-step" style="display:block;">
            <!-- Instructions -->
            <div class="bulk-section">
                <p class="bulk-intro">Upload a CSV or Excel file with your properties. We'll automatically detect columns and format your data.</p>
                <p class="bulk-text" style="margin-top: 8px;">üí° <strong>Tip:</strong> Include a Notes column to add context like well names, ownership details, or reminders for each property.</p>
            </div>
            
            <!-- File Formats -->
            <div class="bulk-section bulk-section-gray">
                <div class="bulk-label">Supported File Formats</div>
                <div class="bulk-text">CSV (.csv), Excel (.xlsx, .xls), Tab-delimited (.txt, .tsv)</div>
            </div>
            
            <!-- Two Column: Column Names + Format Examples -->
            <div class="bulk-section">
                <div class="bulk-two-col">
                    <!-- Column Names -->
                    <div>
                        <div class="bulk-label">Column Names (Flexible)</div>
                        <div class="bulk-columns">
                            <div><strong>Section:</strong> <code>SEC</code> <code>Section</code> <code>Sec</code> <code>S</code></div>
                            <div><strong>Township:</strong> <code>TWN</code> <code>Township</code> <code>Town</code> <code>T</code></div>
                            <div><strong>Range:</strong> <code>RNG</code> <code>Range</code> <code>R</code></div>
                            <div><strong>Notes:</strong> <code>Notes</code> <code>Note</code> <code>Comments</code></div>
                            <div><strong>Optional:</strong> County, Meridian</div>
                        </div>
                    </div>
                    
                    <!-- Format Examples -->
                    <div>
                        <div class="bulk-label">We Auto-Format These</div>
                        <div class="bulk-formats">
                            <div class="bulk-format"><code>3</code> <span class="arrow">‚Üí</span> <code>03</code></div>
                            <div class="bulk-format"><code>S3</code> <span class="arrow">‚Üí</span> <code>03</code></div>
                            <div class="bulk-format"><code>12 N</code> <span class="arrow">‚Üí</span> <code>12N</code></div>
                            <div class="bulk-format"><code>T12N</code> <span class="arrow">‚Üí</span> <code>12N</code></div>
                            <div class="bulk-format"><code>8W</code> <span class="arrow">‚Üí</span> <code>8W</code></div>
                            <div class="bulk-format"><code>R08W</code> <span class="arrow">‚Üí</span> <code>8W</code></div>
                        </div>
                        <p class="bulk-note">Missing meridian defaults to IM (Indian Meridian)</p>
                    </div>
                </div>
            </div>
            
            <!-- Upload Area -->
            <div class="bulk-section">
                <div class="bulk-dropzone" id="dropzone" 
                     ondrop="handleFileDrop(event)" 
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     onclick="document.getElementById('fileInput').click()">
                    <div class="dropzone-icon">üìÑ</div>
                    <div class="dropzone-text">Drop your file here or click to browse</div>
                    <div class="dropzone-subtext">Maximum file size: 5MB</div>
                </div>
                
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.txt,.tsv" style="display:none;" onchange="handleFileSelect(event)">
                
                <div id="file-info" class="bulk-file-info" style="display: none;">
                    <span class="file-name" id="filename"></span>
                    <span class="file-size" id="filesize"></span>
                </div>
                
                <div id="parse-error" class="bulk-error" style="display: none;">
                    <strong>Error parsing file:</strong> <span id="error-message"></span>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bulk-footer">
                <button class="btn-secondary" onclick="closeBulkUploadModal()">Cancel</button>
            </div>
        </div>
        
        <!-- Step 2: Preview & Validate -->
        <div id="preview-step" style="display:none;">
            <div class="bulk-section">
                <h3 style="margin-bottom: 8px; font-family: 'Merriweather', serif;">Preview & Validate</h3>
                <p class="bulk-text">Review the detected properties before importing:</p>
            </div>
            
            <div class="bulk-section">
                <!-- Validation Badges -->
                <div id="validation-summary" class="bulk-badges"></div>
                
                <!-- Plan Check -->
                <div id="plan-check"></div>
                
                <!-- Preview Table -->
                <div class="bulk-table-container">
                    <table class="bulk-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>SEC</th>
                                <th>TWN</th>
                                <th>RNG</th>
                                <th>MER</th>
                                <th>County</th>
                                <th>Notes</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bulk-footer">
                <button class="btn-secondary" onclick="resetBulkUpload()">Start Over</button>
                <button id="import-btn" class="btn-primary" onclick="startImport()">Import Properties</button>
            </div>
        </div>
        
        <!-- Step 3: Importing Progress -->
        <div id="import-step" style="display:none;">
            <div class="bulk-progress">
                <div class="progress-icon">‚ö°</div>
                <h3>Importing Properties...</h3>
                <p class="bulk-text">Please wait while we create your properties.</p>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" id="progress-bar"></div>
                </div>
                <div class="progress-percent" id="progress-percent">0%</div>
                <div class="progress-count" id="import-progress">0 of 0 properties created</div>
            </div>
        </div>
        
        <!-- Step 4: Results -->
        <div id="results-step" style="display:none;">
            <div class="bulk-results">
                <div class="results-icon" id="results-icon">‚úÖ</div>
                <h3 class="results-title" id="results-title">Import Complete!</h3>
                <div class="results-stats">
                    <div class="stat-box">
                        <div class="stat-number stat-success" id="result-created">0</div>
                        <div class="stat-label">Created</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number stat-warning" id="result-skipped">0</div>
                        <div class="stat-label">Skipped</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number stat-error" id="result-failed">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                </div>
                <p class="bulk-text" id="results-details">Your properties are now being monitored for OCC activity.</p>
                <button class="btn-primary" onclick="finishBulkUpload()">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- BULK UPLOAD WELLS MODAL -->
<div class="modal-overlay" id="bulk-upload-wells-modal">
    <div class="modal bulk-modal">
        <!-- Header -->
        <div class="bulk-header">
            <h2>Bulk Upload Wells</h2>
            <button class="bulk-close" onclick="closeBulkUploadWellsModal()">&times;</button>
        </div>
        
        <!-- Step 1: File Upload -->
        <div id="wells-upload-step" style="display:block;">
            <div class="bulk-section">
                <p class="bulk-intro">Upload a CSV or Excel file with API numbers. We'll validate each one and add them to your monitored wells.</p>
                <p class="bulk-text" style="margin-top: 8px;">üí° <strong>Tip:</strong> Include a Notes column to add your own context or reminders for each well.</p>
            </div>
            
            <div class="bulk-section bulk-section-gray">
                <div class="bulk-label">Required Column</div>
                <div class="bulk-text">
                    <strong>API Number</strong> ‚Äî Oklahoma 10-digit format (e.g., 3501520001)
                </div>
                <div class="bulk-columns" style="margin-top: 12px;">
                    <div>Accepted headers: <code>API</code> <code>API Number</code> <code>apiNumber</code> <code>api</code></div>
                </div>
            </div>
            
            <div class="bulk-section">
                <div class="bulk-two-col">
                    <div>
                        <div class="bulk-label">Optional Columns</div>
                        <div class="bulk-columns">
                            <div><strong>Well Name:</strong> <code>Well Name</code> <code>WELL_NAME</code> <code>wellName</code></div>
                            <div><strong>Notes:</strong> <code>Notes</code> <code>Note</code> <code>Comments</code></div>
                        </div>
                    </div>
                    <div>
                        <div class="bulk-label">Format Flexibility</div>
                        <div class="bulk-formats">
                            <div class="bulk-format"><code>35-015-20001</code> <span class="arrow">‚Üí</span> <code>3501520001</code></div>
                            <div class="bulk-format"><code>35 015 20001</code> <span class="arrow">‚Üí</span> <code>3501520001</code></div>
                        </div>
                        <p class="bulk-note">Dashes, spaces, dots are automatically removed</p>
                    </div>
                </div>
            </div>
            
            <div class="bulk-section">
                <div class="bulk-dropzone" id="wells-dropzone" 
                     ondrop="handleWellsFileDrop(event)" 
                     ondragover="handleWellsDragOver(event)"
                     ondragleave="handleWellsDragLeave(event)"
                     onclick="document.getElementById('wellsFileInput').click()">
                    <div class="dropzone-icon">üõ¢Ô∏è</div>
                    <div class="dropzone-text">Drop your file here or click to browse</div>
                    <div class="dropzone-subtext">CSV or Excel files accepted</div>
                </div>
                
                <input type="file" id="wellsFileInput" accept=".csv,.xlsx,.xls,.txt,.tsv" style="display:none;" onchange="handleWellsFileSelect(event)">
                
                <div id="wells-file-info" class="bulk-file-info" style="display: none;">
                    <span class="file-name" id="wells-filename"></span>
                    <span class="file-size" id="wells-filesize"></span>
                </div>
                
                <div id="wells-parse-error" class="bulk-error" style="display: none;">
                    <strong>Error parsing file:</strong> <span id="wells-error-message"></span>
                </div>
            </div>
            
            <div class="bulk-footer">
                <button class="btn-secondary" onclick="closeBulkUploadWellsModal()">Cancel</button>
            </div>
        </div>
        
        <!-- Step 2: Preview -->
        <div id="wells-preview-step" style="display:none;">
            <div class="bulk-section">
                <h3 style="margin-bottom: 8px; font-family: 'Merriweather', serif;">Preview & Validate</h3>
                <p class="bulk-text">Review the API numbers before importing:</p>
            </div>
            
            <div class="bulk-section">
                <div id="wells-validation-summary" class="bulk-badges"></div>
                <div id="wells-plan-check"></div>
                
                <div class="bulk-table-container">
                    <table class="bulk-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>API Number</th>
                                <th>Well Name</th>
                                <th>Notes</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="wells-preview-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="bulk-footer">
                <button class="btn-secondary" onclick="resetBulkUploadWells()">Start Over</button>
                <button id="wells-import-btn" class="btn-primary" onclick="startWellsImport()">Import Wells</button>
            </div>
        </div>
        
        <!-- Step 3: Importing -->
        <div id="wells-import-step" style="display:none;">
            <div class="bulk-progress">
                <div class="progress-icon">‚ö°</div>
                <h3>Importing Wells...</h3>
                <p class="bulk-text">Please wait while we add your wells.</p>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill indeterminate" id="wells-progress-bar"></div>
                </div>
                <div class="progress-count" id="wells-import-progress">Processing...</div>
            </div>
        </div>
        
        <!-- Step 4: Results -->
        <div id="wells-results-step" style="display:none;">
            <div class="bulk-results">
                <div class="results-icon" id="wells-results-icon">‚úÖ</div>
                <h3 class="results-title" id="wells-results-title">Import Complete!</h3>
                <div class="results-stats">
                    <div class="stat-box">
                        <div class="stat-number stat-success" id="wells-result-created">0</div>
                        <div class="stat-label">Created</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number stat-warning" id="wells-result-skipped">0</div>
                        <div class="stat-label">Skipped</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number stat-error" id="wells-result-failed">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                </div>
                <p class="bulk-text" id="wells-results-details">Your wells are now being monitored for OCC activity.</p>
                <button class="btn-primary" onclick="finishBulkUploadWells()">Done</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Bulk Upload Modal - Redesigned Styles */

/* Modal specific overrides */
#bulk-upload-modal .modal.bulk-modal,
#bulk-upload-wells-modal .modal.bulk-modal {
    padding: 0;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
}

/* Header */
.bulk-header {
    background: linear-gradient(135deg, var(--oil-navy) 0%, var(--slate-blue) 100%);
    color: white;
    padding: 24px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.bulk-header h2 {
    font-size: 22px;
    font-weight: 700;
    margin: 0;
    font-family: 'Merriweather', serif;
}

.bulk-close {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 4px;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.bulk-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* Sections */
.bulk-section {
    padding: 24px 30px;
    border-bottom: 1px solid var(--border);
}

.bulk-section:last-child {
    border-bottom: none;
}

.bulk-section-gray {
    background: var(--paper);
}

.bulk-label {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--slate-blue);
    margin-bottom: 10px;
}

.bulk-intro {
    color: var(--slate-blue);
    font-size: 15px;
    line-height: 1.6;
    margin: 0;
}

.bulk-text {
    color: var(--oil-navy);
    font-size: 14px;
    line-height: 1.6;
}

.bulk-note {
    font-size: 12px;
    color: var(--slate-blue);
    margin-top: 12px;
}

/* Two Column Layout */
.bulk-two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
}

@media (max-width: 600px) {
    .bulk-two-col {
        grid-template-columns: 1fr;
    }
}

/* Column Names */
.bulk-columns {
    font-size: 13px;
    line-height: 2;
}

.bulk-columns code {
    background: var(--paper);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 12px;
    font-family: 'SF Mono', Monaco, monospace;
    margin-right: 4px;
}

/* Format Examples */
.bulk-formats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.bulk-format {
    font-size: 13px;
    color: var(--slate-blue);
    display: flex;
    align-items: center;
    gap: 6px;
}

.bulk-format code {
    background: white;
    border: 1px solid var(--border);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 12px;
    font-family: 'SF Mono', Monaco, monospace;
}

.bulk-format .arrow {
    color: var(--success);
    font-weight: 600;
}

/* Dropzone */
.bulk-dropzone {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 50px 30px;
    text-align: center;
    background: var(--paper);
    cursor: pointer;
    transition: all 0.3s;
}

.bulk-dropzone:hover, .bulk-dropzone.drag-over {
    border-color: var(--red-dirt);
    background: #FFF5F0;
}

.dropzone-icon {
    font-size: 40px;
    margin-bottom: 12px;
}

.dropzone-text {
    font-size: 15px;
    color: var(--oil-navy);
    font-weight: 500;
    margin-bottom: 6px;
}

.dropzone-subtext {
    font-size: 13px;
    color: var(--slate-blue);
}

/* File Info */
.bulk-file-info {
    background: var(--success-bg);
    border: 1px solid rgba(3, 84, 63, 0.2);
    border-radius: 6px;
    padding: 14px 18px;
    margin-top: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.bulk-file-info .file-name {
    font-weight: 600;
    color: var(--success);
    font-size: 14px;
}

.bulk-file-info .file-size {
    color: var(--success);
    font-size: 13px;
}

/* Error */
.bulk-error {
    background: #FEE2E2;
    border: 1px solid rgba(220, 38, 38, 0.2);
    border-radius: 6px;
    padding: 14px 18px;
    margin-top: 16px;
    color: #DC2626;
    font-size: 14px;
}

/* Footer */
.bulk-footer {
    padding: 20px 30px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: white;
}

/* Badges */
.bulk-badges {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.validation-badge {
    padding: 10px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.badge-valid { background: var(--success-bg); color: var(--success); }
.badge-invalid { background: #FEE2E2; color: #DC2626; }
.badge-warning { background: #FEF3C7; color: #92400E; }
.badge-duplicate { background: #E0E7FF; color: #3730A3; }

/* Plan Check */
.plan-check-box {
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.plan-check-box.ok {
    background: var(--success-bg);
    border-left: 4px solid var(--success);
}

.plan-check-box.exceeded {
    background: #FEE2E2;
    border-left: 4px solid #DC2626;
}

.plan-check-header {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 4px;
}

.plan-check-box.ok .plan-check-header { color: var(--success); }
.plan-check-box.exceeded .plan-check-header { color: #DC2626; }

.plan-check-details {
    font-size: 13px;
    color: var(--slate-blue);
}

/* Preview Table */
.bulk-table-container {
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    max-height: 350px;
    overflow-y: auto;
}

.bulk-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.bulk-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
}

.bulk-table th {
    background: var(--oil-navy);
    color: white;
    padding: 12px 14px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.bulk-table td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
}

.bulk-table tbody tr:hover {
    background: var(--paper);
}

.preview-row-valid { background: white; }
.preview-row-warning { background: #FEF3C7; }
.preview-row-error { background: #FEE2E2; }
.preview-row-duplicate { background: #E0E7FF; opacity: 0.7; }

.status-cell-valid { color: var(--success); }
.status-cell-warning { color: #92400E; }
.status-cell-error { color: #DC2626; }
.status-cell-duplicate { color: #3730A3; }

/* Progress */
.bulk-progress {
    text-align: center;
    padding: 50px 30px;
}

.bulk-progress .progress-icon {
    font-size: 48px;
    margin-bottom: 20px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.progress-bar-track {
    width: 100%;
    max-width: 400px;
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    margin: 20px auto;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--red-dirt), var(--red-dirt-dark));
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
}

.progress-bar-fill.indeterminate {
    width: 100%;
    animation: indeterminate 1.5s infinite;
    background: linear-gradient(90deg, var(--red-dirt) 0%, var(--red-dirt-dark) 50%, var(--red-dirt) 100%);
    background-size: 200% 100%;
}

@keyframes indeterminate {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.progress-percent {
    font-size: 24px;
    font-weight: 700;
    color: var(--red-dirt);
    margin-top: 15px;
}

.progress-count {
    font-size: 14px;
    color: var(--slate-blue);
    margin-top: 8px;
}

/* Results */
.bulk-results {
    text-align: center;
    padding: 40px 30px;
}

.bulk-results .results-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

.bulk-results .results-title {
    font-size: 24px;
    margin-bottom: 25px;
    font-family: 'Merriweather', serif;
}

.results-stats {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 30px;
}

.stat-box {
    text-align: center;
}

.stat-number {
    font-size: 36px;
    font-weight: 700;
    font-family: 'Merriweather', serif;
}

.stat-success { color: var(--success); }
.stat-warning { color: #92400E; }
.stat-error { color: #DC2626; }

.stat-label {
    font-size: 13px;
    color: var(--slate-blue);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 4px;
}
</style>

<script>
// Global state for bulk upload
let parsedData = [];
let validationResults = null;

// Security: escape HTML to prevent XSS (also defined in main script, but needed here for bulk upload)
function escapeHtmlBulk(text) {
    if (!text) return '';
    const str = String(text);
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

// Open bulk upload modal
function openBulkUploadModal() {
    document.getElementById('bulk-upload-modal').style.display = 'flex';
    resetBulkUpload();
}

// Open bulk upload wells modal
function openBulkUploadWellsModal() {
    document.getElementById('bulk-upload-wells-modal').style.display = 'flex';
    resetBulkUploadWells();
}

// Close bulk upload modal
function closeBulkUploadModal() {
    document.getElementById('bulk-upload-modal').style.display = 'none';
    resetBulkUpload();
}

// Reset to initial state
function resetBulkUpload() {
    document.getElementById('upload-step').style.display = 'block';
    document.getElementById('preview-step').style.display = 'none';
    document.getElementById('import-step').style.display = 'none';
    document.getElementById('results-step').style.display = 'none';
    document.getElementById('file-info').style.display = 'none';
    document.getElementById('parse-error').style.display = 'none';
    document.getElementById('fileInput').value = '';
    parsedData = [];
    validationResults = null;
}

// Handle file drop
function handleFileDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('dropzone').classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        processFile(files[0]);
    }
}

// Handle drag over
function handleDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('dropzone').classList.add('drag-over');
}

// Handle drag leave
function handleDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('dropzone').classList.remove('drag-over');
}

// Handle file select
function handleFileSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
        processFile(files[0]);
    }
}

// Process uploaded file
async function processFile(file) {
    document.getElementById('filename').textContent = file.name;
    document.getElementById('filesize').textContent = `${(file.size / 1024).toFixed(1)} KB`;
    document.getElementById('file-info').style.display = 'block';
    document.getElementById('parse-error').style.display = 'none';
    
    try {
        // Detect file type
        const extension = file.name.split('.').pop().toLowerCase();
        
        if (extension === 'csv' || extension === 'txt' || extension === 'tsv') {
            // Parse CSV/TSV
            await parseCSV(file);
        } else if (extension === 'xlsx' || extension === 'xls') {
            // Parse Excel
            await parseExcel(file);
        } else {
            throw new Error('Unsupported file type. Please upload CSV or Excel file.');
        }
        
        // If we got here, parsing succeeded
        if (parsedData.length === 0) {
            throw new Error('No data found in file');
        }
        
        // Validate and show preview
        await validateAndPreview();
        
    } catch (error) {
        console.error('File processing error:', error);
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('parse-error').style.display = 'block';
    }
}

// Parse CSV file
async function parseCSV(file) {
    return new Promise((resolve, reject) => {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                if (results.errors.length > 0) {
                    reject(new Error(`CSV parsing error: ${results.errors[0].message}`));
                    return;
                }
                parsedData = results.data;
                resolve();
            },
            error: (error) => {
                reject(new Error(`CSV parsing failed: ${error.message}`));
            }
        });
    });
}

// Parse Excel file
async function parseExcel(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get first sheet
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (jsonData.length === 0) {
                    reject(new Error('Excel file contains no data'));
                    return;
                }
                
                parsedData = jsonData;
                resolve();
            } catch (error) {
                reject(new Error(`Excel parsing failed: ${error.message}`));
            }
        };
        
        reader.onerror = () => {
            reject(new Error('Failed to read file'));
        };
        
        reader.readAsArrayBuffer(file);
    });
}

// Validate and show preview
async function validateAndPreview() {
    try {
        const response = await fetch('/api/bulk-validate-properties', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ properties: parsedData })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Validation failed');
        }
        
        validationResults = await response.json();
        
        // Show preview step
        document.getElementById('upload-step').style.display = 'none';
        document.getElementById('preview-step').style.display = 'block';
        
        // Render summary badges
        renderSummary();
        
        // Render plan check
        renderPlanCheck();
        
        // Render preview table
        renderPreviewTable();
        
    } catch (error) {
        console.error('Validation error:', error);
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('parse-error').style.display = 'block';
    }
}

// Render summary badges
function renderSummary() {
    const summary = validationResults.summary;
    const html = `
        <div class="validation-badge badge-valid">
            ‚úì ${summary.valid} Valid
        </div>
        ${summary.invalid > 0 ? `
        <div class="validation-badge badge-invalid">
            ‚ùå ${summary.invalid} Invalid
        </div>
        ` : ''}
        ${summary.warnings > 0 ? `
        <div class="validation-badge badge-warning">
            ‚ö†Ô∏è ${summary.warnings} Warnings
        </div>
        ` : ''}
        ${summary.duplicates > 0 ? `
        <div class="validation-badge badge-duplicate">
            üîÑ ${summary.duplicates} Duplicates
        </div>
        ` : ''}
    `;
    document.getElementById('validation-summary').innerHTML = html;
}

// Render plan check
function renderPlanCheck() {
    const plan = validationResults.planCheck;
    const wouldExceed = plan.wouldExceedLimit;
    
    const html = `
        <div class="plan-check-box ${wouldExceed ? 'exceeded' : 'ok'}">
            <div class="plan-check-header">
                ${wouldExceed ? '‚ùå Would Exceed Plan Limit' : '‚úì Within Plan Limit'}
            </div>
            <div class="plan-check-details">
                Current: ${plan.current} properties ¬∑ 
                Adding: ${validationResults.summary.willImport} ¬∑ 
                Total: ${plan.afterUpload} of ${plan.limit} (${plan.plan} plan)
            </div>
        </div>
    `;
    document.getElementById('plan-check').innerHTML = html;
    
    // Disable import button if would exceed
    document.getElementById('import-btn').disabled = wouldExceed;
}

// Render preview table
function renderPreviewTable() {
    const tbody = document.getElementById('preview-table-body');
    let html = '';
    
    validationResults.results.forEach((result, index) => {
        const prop = result.normalized;
        const rowClass = result.isDuplicate ? 'preview-row-duplicate' : 
                        (result.errors.length > 0 ? 'preview-row-error' :
                        (result.warnings.length > 0 ? 'preview-row-warning' : 'preview-row-valid'));
        
        const statusClass = result.isDuplicate ? 'status-cell-duplicate' :
                           (result.errors.length > 0 ? 'status-cell-error' :
                           (result.warnings.length > 0 ? 'status-cell-warning' : 'status-cell-valid'));
        
        const statusText = result.isDuplicate ? 'üîÑ Duplicate' :
                          (result.errors.length > 0 ? `‚ùå ${result.errors[0]}` :
                          (result.warnings.length > 0 ? `‚ö†Ô∏è ${result.warnings[0]}` : '‚úì Valid'));
        
        // Truncate notes for preview (max 25 chars) and escape
        const notesRaw = prop.NOTES ? (prop.NOTES.length > 25 ? prop.NOTES.substring(0, 25) + '...' : prop.NOTES) : '-';
        const notesPreview = escapeHtmlBulk(notesRaw);
        
        html += `
            <tr class="${rowClass}">
                <td>${index + 1}</td>
                <td>${escapeHtmlBulk(prop.SEC) || '-'}</td>
                <td>${escapeHtmlBulk(prop.TWN) || '-'}</td>
                <td>${escapeHtmlBulk(prop.RNG) || '-'}</td>
                <td>${escapeHtmlBulk(prop.MERIDIAN) || '-'}</td>
                <td>${escapeHtmlBulk(prop.COUNTY) || '-'}</td>
                <td style="font-size: 12px; color: var(--slate-blue);">${notesPreview}</td>
                <td class="status-cell ${statusClass}">
                    ${statusText}
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Start import
async function startImport() {
    // Show import step
    document.getElementById('preview-step').style.display = 'none';
    document.getElementById('import-step').style.display = 'block';
    
    // Start indeterminate progress animation
    const progressBar = document.getElementById('progress-bar');
    progressBar.classList.add('indeterminate');
    document.getElementById('progress-percent').textContent = '';
    
    // Prepare valid properties for upload
    const toImport = validationResults.results
        .filter(r => r.isValid && !r.isDuplicate)
        .map(r => r.normalized);
    
    document.getElementById('import-progress').textContent = `Importing ${toImport.length} properties...`;
    
    try {
        const response = await fetch('/api/bulk-upload-properties', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ properties: toImport })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Upload failed');
        }
        
        const results = await response.json();
        
        // Show completion briefly
        progressBar.classList.remove('indeterminate');
        progressBar.style.width = '100%';
        document.getElementById('progress-percent').textContent = '100%';
        document.getElementById('import-progress').textContent = `${results.results.successful} of ${toImport.length} properties created`;
        
        // Brief delay to show completion
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Show results
        showResults(results);
        
    } catch (error) {
        console.error('Upload error:', error);
        showError(error.message);
    }
}

// Show results
function showResults(results) {
    document.getElementById('import-step').style.display = 'none';
    document.getElementById('results-step').style.display = 'block';
    
    const success = results.results.successful;
    const failed = results.results.failed;
    const skipped = results.results.skipped;
    
    // Update stat boxes
    document.getElementById('result-created').textContent = success;
    document.getElementById('result-skipped').textContent = skipped;
    document.getElementById('result-failed').textContent = failed;
    
    if (failed === 0) {
        document.getElementById('results-icon').textContent = '‚úÖ';
        document.getElementById('results-title').textContent = 'Import Complete!';
        document.getElementById('results-details').textContent = 'Your properties are now being monitored for OCC activity.';
    } else {
        document.getElementById('results-icon').textContent = '‚ö†Ô∏è';
        document.getElementById('results-title').textContent = 'Import Completed with Errors';
        document.getElementById('results-details').textContent = 'Some properties could not be imported. Check your file and try again.';
    }
}

// Show error
function showError(message) {
    document.getElementById('import-step').style.display = 'none';
    document.getElementById('results-step').style.display = 'block';
    document.getElementById('results-icon').textContent = '‚ùå';
    document.getElementById('results-title').textContent = 'Import Failed';
    
    // Clear stat boxes
    document.getElementById('result-created').textContent = '0';
    document.getElementById('result-skipped').textContent = '0';
    document.getElementById('result-failed').textContent = '‚Äì';
    
    document.getElementById('results-details').textContent = message;
}

// Finish and close
function finishBulkUpload() {
    closeBulkUploadModal();
    // Reload properties
    loadProperties();
}

// ==========================================
// WELLS BULK UPLOAD FUNCTIONS
// ==========================================

let wellsParsedData = [];
let wellsValidationResults = null;

// Close wells modal
function closeBulkUploadWellsModal() {
    document.getElementById('bulk-upload-wells-modal').style.display = 'none';
    resetBulkUploadWells();
}

// Reset wells modal
function resetBulkUploadWells() {
    document.getElementById('wells-upload-step').style.display = 'block';
    document.getElementById('wells-preview-step').style.display = 'none';
    document.getElementById('wells-import-step').style.display = 'none';
    document.getElementById('wells-results-step').style.display = 'none';
    document.getElementById('wells-file-info').style.display = 'none';
    document.getElementById('wells-parse-error').style.display = 'none';
    document.getElementById('wellsFileInput').value = '';
    wellsParsedData = [];
    wellsValidationResults = null;
}

// Handle wells file drop
function handleWellsFileDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('wells-dropzone').classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        processWellsFile(files[0]);
    }
}

function handleWellsDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('wells-dropzone').classList.add('drag-over');
}

function handleWellsDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('wells-dropzone').classList.remove('drag-over');
}

function handleWellsFileSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
        processWellsFile(files[0]);
    }
}

// Process wells file
async function processWellsFile(file) {
    document.getElementById('wells-filename').textContent = file.name;
    document.getElementById('wells-filesize').textContent = `${(file.size / 1024).toFixed(1)} KB`;
    document.getElementById('wells-file-info').style.display = 'flex';
    document.getElementById('wells-parse-error').style.display = 'none';
    
    try {
        const extension = file.name.split('.').pop().toLowerCase();
        
        if (extension === 'csv' || extension === 'txt' || extension === 'tsv') {
            await parseWellsCSV(file);
        } else if (extension === 'xlsx' || extension === 'xls') {
            await parseWellsExcel(file);
        } else {
            throw new Error('Unsupported file type');
        }
        
        if (wellsParsedData.length === 0) {
            throw new Error('No data found in file');
        }
        
        await validateAndPreviewWells();
        
    } catch (error) {
        console.error('Wells file processing error:', error);
        document.getElementById('wells-error-message').textContent = error.message;
        document.getElementById('wells-parse-error').style.display = 'block';
    }
}

// Parse CSV for wells
async function parseWellsCSV(file) {
    return new Promise((resolve, reject) => {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                wellsParsedData = results.data;
                resolve();
            },
            error: (error) => reject(error)
        });
    });
}

// Parse Excel for wells
async function parseWellsExcel(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                wellsParsedData = XLSX.utils.sheet_to_json(firstSheet);
                resolve();
            } catch (err) {
                reject(err);
            }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
    });
}

// Validate and preview wells
async function validateAndPreviewWells() {
    try {
        const response = await fetch('/api/bulk-validate-wells', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ wells: wellsParsedData })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Validation failed');
        }
        
        wellsValidationResults = await response.json();
        
        document.getElementById('wells-upload-step').style.display = 'none';
        document.getElementById('wells-preview-step').style.display = 'block';
        
        renderWellsSummary();
        renderWellsPlanCheck();
        renderWellsPreviewTable();
        
    } catch (error) {
        console.error('Wells validation error:', error);
        document.getElementById('wells-error-message').textContent = error.message;
        document.getElementById('wells-parse-error').style.display = 'block';
    }
}

// Render wells summary badges
function renderWellsSummary() {
    const summary = wellsValidationResults.summary;
    const html = `
        <div class="validation-badge badge-valid">‚úì ${summary.valid} Valid</div>
        ${summary.invalid > 0 ? `<div class="validation-badge badge-invalid">‚ùå ${summary.invalid} Invalid</div>` : ''}
        ${summary.duplicates > 0 ? `<div class="validation-badge badge-duplicate">‚Ü∫ ${summary.duplicates} Duplicates</div>` : ''}
    `;
    document.getElementById('wells-validation-summary').innerHTML = html;
}

// Render wells plan check
function renderWellsPlanCheck() {
    const plan = wellsValidationResults.planCheck;
    const wouldExceed = plan.wouldExceedLimit;
    
    const html = `
        <div class="plan-check-box ${wouldExceed ? 'exceeded' : 'ok'}">
            <div class="plan-check-header">
                ${wouldExceed ? '‚ùå Would Exceed Plan Limit' : '‚úì Within Plan Limit'}
            </div>
            <div class="plan-check-details">
                Current: ${plan.current} wells ¬∑ 
                Adding: ${wellsValidationResults.summary.willImport} ¬∑ 
                Total: ${plan.afterUpload} of ${plan.limit} (${plan.plan} plan)
            </div>
        </div>
    `;
    document.getElementById('wells-plan-check').innerHTML = html;
    document.getElementById('wells-import-btn').disabled = wouldExceed;
}

// Render wells preview table
function renderWellsPreviewTable() {
    const tbody = document.getElementById('wells-preview-table-body');
    let html = '';
    
    wellsValidationResults.results.forEach((result, index) => {
        const rowClass = result.isDuplicate ? 'preview-row-duplicate' :
                        (result.errors.length > 0 ? 'preview-row-error' :
                        (result.warnings.length > 0 ? 'preview-row-warning' : 'preview-row-valid'));
        
        const statusClass = result.isDuplicate ? 'status-cell-duplicate' :
                           (result.errors.length > 0 ? 'status-cell-error' :
                           (result.warnings.length > 0 ? 'status-cell-warning' : 'status-cell-valid'));
        
        const statusText = result.isDuplicate ? '‚Ü∫ Duplicate' :
                          (result.errors.length > 0 ? `‚ùå ${result.errors[0]}` :
                          (result.warnings.length > 0 ? `‚ö†Ô∏è ${result.warnings[0]}` : '‚úì Valid'));
        
        // Truncate notes for preview and escape
        const notesRaw = result.normalized.notes ? 
            (result.normalized.notes.length > 25 ? result.normalized.notes.substring(0, 25) + '...' : result.normalized.notes) : '-';
        const notesPreview = escapeHtmlBulk(notesRaw);
        
        html += `
            <tr class="${rowClass}">
                <td>${index + 1}</td>
                <td>${escapeHtmlBulk(result.normalized.apiNumber) || '-'}</td>
                <td>${escapeHtmlBulk(result.normalized.wellName) || '-'}</td>
                <td style="font-size: 12px; color: var(--slate-blue);">${notesPreview}</td>
                <td class="status-cell ${statusClass}">${statusText}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Start wells import
async function startWellsImport() {
    document.getElementById('wells-preview-step').style.display = 'none';
    document.getElementById('wells-import-step').style.display = 'block';
    
    const toImport = wellsValidationResults.results
        .filter(r => r.isValid && !r.isDuplicate)
        .map(r => r.normalized);
    
    document.getElementById('wells-import-progress').textContent = `Importing ${toImport.length} wells...`;
    
    try {
        const response = await fetch('/api/bulk-upload-wells', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ wells: toImport })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Upload failed');
        }
        
        const results = await response.json();
        
        // Brief delay to show progress
        await new Promise(resolve => setTimeout(resolve, 500));
        
        showWellsResults(results);
        
    } catch (error) {
        console.error('Wells upload error:', error);
        showWellsError(error.message);
    }
}

// Show wells results
function showWellsResults(results) {
    document.getElementById('wells-import-step').style.display = 'none';
    document.getElementById('wells-results-step').style.display = 'block';
    
    const success = results.results.successful;
    const failed = results.results.failed;
    const skipped = results.results.skipped;
    
    document.getElementById('wells-result-created').textContent = success;
    document.getElementById('wells-result-skipped').textContent = skipped;
    document.getElementById('wells-result-failed').textContent = failed;
    
    if (failed === 0) {
        document.getElementById('wells-results-icon').textContent = '‚úÖ';
        document.getElementById('wells-results-title').textContent = 'Import Complete!';
        document.getElementById('wells-results-details').textContent = 'Your wells are now being monitored for OCC activity.';
    } else {
        document.getElementById('wells-results-icon').textContent = '‚ö†Ô∏è';
        document.getElementById('wells-results-title').textContent = 'Import Completed with Errors';
        document.getElementById('wells-results-details').textContent = 'Some wells could not be imported.';
    }
}

// Show wells error
function showWellsError(message) {
    document.getElementById('wells-import-step').style.display = 'none';
    document.getElementById('wells-results-step').style.display = 'block';
    document.getElementById('wells-results-icon').textContent = '‚ùå';
    document.getElementById('wells-results-title').textContent = 'Import Failed';
    document.getElementById('wells-result-created').textContent = '0';
    document.getElementById('wells-result-skipped').textContent = '0';
    document.getElementById('wells-result-failed').textContent = '‚Äì';
    document.getElementById('wells-results-details').textContent = message;
}

// Finish wells upload
function finishBulkUploadWells() {
    closeBulkUploadWellsModal();
    loadWells();
}
</script>

<!-- Add Papa Parse library (CSV parsing) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<!-- Add SheetJS library (Excel parsing) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    </body>
</html>
