<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mineral Watch</title>
    <!-- v2024.12.13.10 - Fixed Import buttons with onclick handlers and added wells modal CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --oil-navy: #1C2B36; --slate-blue: #334E68; --red-dirt: #C05621; --red-dirt-dark: #9C4215; --paper: #F8F9FA; --border: #E2E8F0; --success: #03543F; --success-bg: #DEF7EC; --error: #DC2626; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: var(--oil-navy); background: #F7FAFC; min-height: 100vh; }
        h1, h2, .logo { font-family: 'Merriweather', serif; }
        header { background: var(--oil-navy); padding: 15px 0; color: white; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 25px; }
        .header-inner { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: 900; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 25px; }
        .nav-links a { color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; font-size: 14px; }
        .nav-links a:hover, .nav-links a.active { color: white; }
        .user-menu { display: flex; align-items: center; gap: 15px; }
        .user-name { font-size: 14px; color: rgba(255,255,255,0.8); }
        .btn-logout { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer; }
        main { padding: 40px 0; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .page-header h1 { font-size: 28px; margin: 0; line-height: 1.2; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        /* Action Groups with Dividers */
        .action-group { display: flex; gap: 8px; align-items: center; }
        .action-divider { width: 1px; height: 24px; background: var(--border); margin: 0 8px; }
        .btn-add { background: var(--red-dirt); color: white; padding: 10px 16px; border: 1px solid var(--red-dirt); border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; text-decoration: none; transition: all 0.2s; min-width: 100px; }
        .btn-add:hover { background: var(--red-dirt-dark); border-color: var(--red-dirt-dark); }
        
        .btn-secondary-action { background: white; color: var(--slate-blue); border: 1px solid var(--border); padding: 10px 16px; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; min-width: 80px; }
        .btn-secondary-action:hover { border-color: var(--slate-blue); color: var(--oil-navy); background: #f8fafc; }
        .plan-info { background: white; border-radius: 8px; padding: 16px 20px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-wrap: wrap; }
        .plan-badge { background: var(--success-bg); color: var(--success); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .plan-usage { font-size: 14px; color: var(--slate-blue); display: flex; gap: 20px; flex-wrap: wrap; }
        .usage-item { display: flex; align-items: center; gap: 6px; }
        .upgrade-link { margin-left: auto; color: var(--red-dirt); text-decoration: none; font-size: 14px; font-weight: 600; }
        .stats-card { background: white; border-radius: 8px; padding: 20px 30px; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 40px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-item { text-align: center; }
        .stat-label { display: block; font-size: 12px; color: var(--slate-blue); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .stat-value { display: block; font-size: 24px; font-weight: 700; color: var(--oil-navy); font-family: 'Merriweather', serif; }
        .stat-divider { width: 1px; height: 40px; background: var(--border); }
        .activity-list { padding: 0; }
        .activity-item { display: flex; gap: 16px; padding: 20px; border-bottom: 1px solid var(--border); }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .activity-icon.permit { background: #DBEAFE; }
        .activity-icon.drilling { background: #FEF3C7; }
        .activity-icon.completed { background: #DEF7EC; }
        .activity-icon.transfer { background: #EDE9FE; }
        .activity-icon.status { background: #E0F2FE; }
        .activity-icon.abandoned { background: #F3F4F6; }
        .activity-details { flex: 1; }
        .activity-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        .activity-type { font-weight: 600; font-size: 14px; color: var(--oil-navy); }
        .activity-level { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; }
        .activity-level.property { background: #FEE2E2; color: #991B1B; }
        .activity-level.adjacent { background: #FEF3C7; color: #92400E; }
        .activity-level.tracked { background: #CCFBF1; color: #115E59; }
        .activity-well { font-size: 15px; font-weight: 500; margin-bottom: 4px; }
        .activity-meta { font-size: 13px; color: var(--slate-blue); }
        .activity-change { background: var(--paper); padding: 8px 12px; border-radius: 4px; font-size: 13px; margin-top: 8px; display: inline-block; }
        .activity-actions { display: flex; gap: 8px; margin-top: 10px; }
        .activity-btn { display: inline-block; padding: 6px 12px; font-size: 12px; font-weight: 600; text-decoration: none; border-radius: 4px; background: var(--paper); color: var(--slate-blue); border: 1px solid var(--border); transition: all 0.2s; cursor: pointer; }
        .activity-btn:hover { background: #E2E8F0; color: var(--oil-navy); }
        .activity-btn.track-btn { background: white; border-color: var(--red-dirt); color: var(--red-dirt); }
        .activity-btn.track-btn:hover { background: var(--red-dirt); color: white; }
        .activity-date { font-size: 12px; color: #718096; white-space: nowrap; }
        .activity-checkbox { padding: 8px; margin-right: 8px; }
        .activity-checkbox-input { cursor: pointer; width: 16px; height: 16px; }
        .activity-limit-notice { background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 12px 16px; margin: 16px 20px; border-radius: 0 4px 4px 0; font-size: 13px; color: #92400E; }
        .activity-limit-notice a { color: #92400E; font-weight: 600; }
        .tabs { display: flex; gap: 4px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; position: relative; border: 1px solid transparent; display: flex; align-items: center; gap: 8px; }
        
        .tab-icon { width: 16px; height: 16px; opacity: 0.7; }
        .tab.active .tab-icon { opacity: 1; color: var(--red-dirt); }
        .tab.active { background: white; color: var(--oil-navy); border-bottom: 3px solid #3B82F6; border-left: 1px solid var(--border); border-right: 1px solid var(--border); border-top: 1px solid var(--border); box-shadow: none; }
        .tab:not(.active) { background: #f8f9fa; color: #94A3B8; border: 1px solid #e9ecef; opacity: 0.9; }
        .tab:not(.active):hover { background: #f1f3f4; color: #64748B; opacity: 1; border-color: #d6d9dc; }
        .content-card { background: white; border-radius: 0 8px 8px 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .data-table { width: 100%; border-collapse: collapse; }
        #propertiesContent .data-table { table-layout: auto; }
        
        /* Properties Table - Fixed widths for better alignment */
        .col-select { width: 40px; }
        .col-prop-county { width: 120px; }
        .col-prop-legal { width: 160px; }
        .col-prop-group { width: 0; padding: 0 !important; overflow: hidden; visibility: collapse; } /* Hidden by default */
        .col-prop-acres { width: 130px; }
        .col-prop-notes { 
            width: auto;
            min-width: 300px;
            padding-left: 20px !important;
        }
        .col-actions { width: 90px; }
        
        /* When groups are visible, show the column */
        .has-groups .col-prop-group { width: 80px; padding: 16px 16px !important; visibility: visible; }
        
        /* Properties table specific alignments */
        #propertiesContent .data-table th:nth-child(5) { text-align: right; white-space: nowrap; } /* Total Acres header */
        .has-groups #propertiesContent .data-table th:nth-child(5) { text-align: right; white-space: nowrap; } /* Total Acres with groups */
        #propertiesContent .data-table th:last-child { text-align: right; } /* Actions header */
        #propertiesContent .data-table td:last-child { text-align: right; } /* Actions cells */
        
        /* Notes column spacing - using class to avoid nth-child issues */
        .col-prop-notes-cell { padding-left: 50px !important; }
        
        /* Notes cell styling with 2-line clamp */
        .notes-cell {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
            word-break: break-word;
        }
        
        /* Map link button */
        .btn-map-link { 
            background: var(--paper); 
            border: 1px solid var(--border); 
            color: var(--slate-blue); 
            padding: 4px 10px; 
            border-radius: 4px; 
            font-size: 12px; 
            cursor: pointer; 
            transition: all 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .btn-map-link:hover { 
            background: #E2E8F0; 
            border-color: var(--slate-blue); 
            color: var(--oil-navy);
        }
        
        /* Wells table specific column widths - desktop */
        #wellsContent .data-table { table-layout: fixed; }
        .col-well-info { width: 50%; }
        .col-well-operator { width: calc(100% - 50% - 40px - 40px); }
        
        /* Expandable well table styles */
        .wells-expandable .well-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .wells-expandable .well-row:hover {
            background-color: #F8FAFC;
        }
        .wells-expandable .well-row.expanded {
            background-color: #F0F9FF;
        }
        .well-name-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .well-details-line {
            font-size: 13px;
            color: #6B7280;
        }
        .well-details-line .well-api {
            font-family: monospace;
            color: #64748B;
        }
        .well-details-line .well-status {
            font-weight: 600;
            color: var(--slate-blue);
        }
        .well-details-line .well-status.status-active {
            color: var(--success);
        }
        .well-details-line .well-formation {
            color: #8B5CF6;
        }
        .well-details-line .well-firstprod {
            color: #0891B2;
        }
        .expand-icon {
            color: #94A3B8;
            font-size: 10px;
            transition: transform 0.2s;
        }
        .well-row.expanded .expand-icon {
            transform: rotate(180deg);
        }
        .well-expanded-row td {
            padding: 0 !important;
            background: #F8FAFC;
        }
        .well-expanded-card {
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        
        /* Add extra left padding to Notes column for visual separation */
        /* Notes is 5th column: checkbox(1), county(2), legal(3), acres(4), notes(5), actions(6) */
        #propertiesContent .data-table td:nth-child(5),
        #propertiesContent .data-table th:nth-child(5) {
            padding-left: 45px;
        }
        
        /* Right-align Total Acres header to match the values */
        #propertiesContent .data-table th:nth-child(4) {
            text-align: right;
        }
        
        /* Wells Table - just adjust Well Name spacing to match Properties */
        #wellsContent .data-table td:nth-child(2),
        #wellsContent .data-table th:nth-child(2) {
            padding-left: 15px;
        }
        
        .col-location { width: 15%; }
        .data-table th { background: var(--paper); text-align: left; padding: 14px 16px; font-size: 12px; font-weight: 600; color: var(--slate-blue); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
        .data-table td { padding: 16px 16px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: top; }
        
        /* Reduce padding on specific columns to minimize gaps */
        .has-groups .col-prop-group { padding-right: 12px !important; }
        .has-groups td.col-prop-group { padding-right: 12px !important; }
        .data-table td[style*="text-align: right"] { padding-left: 12px; }
        
        /* Accordion row - ensure it spans properly and has height */
        .accordion-row {
            height: auto !important;
        }
        
        .accordion-row td {
            width: 100% !important;
            min-width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            min-height: 300px !important;
            vertical-align: top !important;
            line-height: normal !important;
        }
        
        .production-accordion {
            width: 100% !important;
            display: block !important;
            min-height: 300px !important;
            height: auto !important;
        }
        
        /* Desktop: maintain two-column layout */
        .production-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        /* Desktop: maintain grid layouts */
        .prod-stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .timeline-stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        /* Desktop: Clean row layout */
        .production-term {
            display: block;
        }
        
        .production-term > div:first-child {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            width: 100%;
        }
        
        /* Hide inline explanations on desktop */
        .production-explanation {
            display: none;
        }
        
        /* Mobile responsive styling */
        @media (max-width: 768px) {
            .production-sections {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }
            
            /* Stack the grid items vertically on mobile with aligned values */
            .prod-stats, .timeline-stats {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            
            /* Mobile click-to-expand for production terms */
            .production-accordion-floating .hover-helper {
                cursor: pointer;
                position: relative;
            }
            
            .production-term-expanded {
                background: #E0F2FE !important;
                margin: 4px 0;
                padding: 8px;
                border-radius: 4px;
                border-left: 3px solid var(--red-dirt);
            }
            
            /* Show explanations on mobile */
            .production-explanation {
                display: none;
                font-size: 12px;
                color: var(--slate-blue);
                margin-top: 4px;
                padding-top: 4px;
                border-top: 1px solid #E5E7EB;
                line-height: 1.3;
            }
            
            .production-explanation.expanded {
                display: block;
            }
            
            /* Fix production header layout on mobile */
            .production-accordion-floating .production-header {
                flex-wrap: wrap !important;
            }
            
            .production-accordion-floating .production-header > div:last-child {
                width: 100%;
                justify-content: center;
                margin-top: 8px;
            }
        }
        .data-table tr:last-child td { border-bottom: none; }
        .status-active { color: var(--success); font-weight: 600; }
        .btn-link { background: none; border: none; color: var(--red-dirt); cursor: pointer; font-size: 13px; text-decoration: underline; margin-right: 12px; }
        .btn-link:hover { color: var(--red-dirt-dark); }
        .btn-delete { background: none; border: none; color: #94A3B8; cursor: pointer; font-size: 13px; padding: 4px; border-radius: 4px; transition: all 0.2s; }
        .btn-delete:hover { color: #DC2626; background: #FEE2E2; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--slate-blue); }
        .empty-state p { margin-bottom: 20px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        
        /* Ensure detail modals appear above sticky filter bars - diagnostic test */
        #wellDetailsModal,
        #propertyDetailsModal {
            position: fixed !important;
            z-index: 999999 !important;
            isolation: isolate !important;
        }
        
        /* Remove position relative to prevent stacking context conflicts */
        #wellDetailsModal .well-card,
        #propertyDetailsModal .property-card {
            /* Remove position: relative to prevent stacking context issues */
            position: static !important;
            z-index: auto !important;
        }
        /* Ensure bulk upload modal overlay displays correctly when opened */
        #bulk-upload-modal { 
            display: none; 
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 9999 !important;
            background: rgba(0,0,0,0.7) !important;
        }
        #bulk-upload-modal[style*="flex"] { 
            display: flex !important; 
            align-items: center !important;
            justify-content: center !important;
        }
        #bulk-upload-wells-modal { 
            display: none; 
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 9999 !important;
            background: rgba(0,0,0,0.7) !important;
        }
        #bulk-upload-wells-modal[style*="flex"] { 
            display: flex !important; 
            align-items: center !important;
            justify-content: center !important;
        }
        .modal { background: white; border-radius: 8px; padding: 30px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal h2 { margin-bottom: 20px; }
        
        /* Tab Navigation */
        .tab-nav { display: flex; margin-bottom: 24px; border-bottom: 1px solid #e2e8f0; }
        .tab-btn { background: none; border: none; padding: 12px 16px; cursor: pointer; color: #64748b; font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn:hover { color: var(--oil-navy); }
        .tab-btn.active { color: var(--oil-navy); border-bottom-color: var(--oil-navy); font-weight: 600; }
        
        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Search Form */
        .search-form { }
        .form-row { display: flex; gap: 12px; margin-bottom: 16px; }
        .form-row .form-group { flex: 1; }
        .form-group.full { width: 100%; }
        
        /* Search Buttons */
        .search-buttons { display: flex; gap: 12px; margin-top: 20px; }
        .btn-search { background: var(--oil-navy); color: white; padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-search:hover { background: var(--oil-navy-dark, #1a365d); }
        .btn-clear { background: #e2e8f0; color: #475569; padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-clear:hover { background: #cbd5e1; }
        
        /* Search Results */
        .search-results { margin-top: 24px; border-top: 1px solid #e2e8f0; padding-top: 20px; }
        .results-header { display: flex; justify-content: between; align-items: center; margin-bottom: 16px; }
        .results-header h3 { margin: 0; color: var(--oil-navy); font-size: 16px; }
        .results-info { color: #64748b; font-size: 13px; }
        .results-list { max-height: 300px; overflow-y: auto; }
        
        /* Result Item */
        .result-item { border: 1px solid #e2e8f0; border-radius: 6px; padding: 16px; margin-bottom: 12px; transition: all 0.2s; }
        .result-item:hover { border-color: var(--oil-navy); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .result-well-name { font-weight: 600; color: var(--oil-navy); font-size: 14px; margin: 0; }
        .result-status { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .result-status.active { background: #dcfce7; color: #166534; }
        .result-status.plugged { background: #fef3c7; color: #92400e; }
        .result-status.other { background: #e2e8f0; color: #475569; }
        .result-details { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; color: #64748b; font-size: 13px; margin-bottom: 12px; }
        .result-detail { }
        .result-detail strong { color: #374151; }
        .btn-select { background: var(--red-dirt); color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-select:hover { background: var(--red-dirt-dark); }
        
        /* Search Loading */
        .search-loading { text-align: center; padding: 40px; color: #64748b; }
        .search-loading .spinner { width: 24px; height: 24px; border: 2px solid #e2e8f0; border-top: 2px solid var(--oil-navy); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Well Card Modal Styles */
        .well-card { background: white; border-radius: 12px; overflow: hidden; max-width: 520px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: calc(100vh - 40px); overflow-y: auto; }
        
        /* Property Card Modal Styles - Orange Theme */
        .property-card { background: white; border-radius: 12px; overflow: hidden; max-width: 520px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: calc(100vh - 40px); overflow-y: auto; }
        
        /* Card Header - Blue for Wells */
        .card-header { background: linear-gradient(135deg, var(--oil-navy) 0%, var(--slate-blue) 100%); color: white; padding: 20px 24px; position: relative; }
        
        /* Property Card Header - Orange for Land */
        .property-card-header { background: linear-gradient(135deg, var(--red-dirt) 0%, var(--red-dirt-dark) 100%); color: white; padding: 20px 24px; position: relative; }
        .card-header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; margin-top: 8px; }
        .well-name { font-family: 'Merriweather', serif; font-size: 20px; font-weight: 700; margin: 0; }
        .property-name { font-family: 'Merriweather', serif; font-size: 20px; font-weight: 700; margin: 0; }
        .date-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-top: 4px; }
        .api-number { font-size: 13px; opacity: 0.8; }
        .property-location { font-size: 13px; opacity: 0.8; }
        .acreage-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-top: 4px; }
        .close-btn { position: absolute; top: 12px; right: 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 32px; height: 32px; border-radius: 6px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .close-btn:hover { background: rgba(255,255,255,0.2); }
        
        /* Card Content */
        .card-content { padding: 20px 24px; }
        
        /* Status Row */
        .status-row { display: flex; gap: 24px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .status-item { display: flex; flex-direction: column; gap: 6px; }
        .status-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--slate-blue); }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 700; background: var(--success-bg); color: var(--success); }
        .status-badge.horizontal { background: #DBEAFE; color: #1E40AF; }
        .status-value { font-size: 14px; font-weight: 600; color: var(--oil-navy); }
        
        /* Info Sections */
        .info-section { margin-bottom: 16px; }
        .info-section:last-child { margin-bottom: 0; }
        .section-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--slate-blue); margin-bottom: 6px; }
        .section-value { font-size: 15px; font-weight: 500; color: var(--oil-navy); }
        .section-value a { color: var(--red-dirt); text-decoration: none; }
        .section-value a:hover { text-decoration: underline; }
        .contact-line { font-size: 14px; color: var(--slate-blue); margin-top: 2px; }
        
        /* Two Column Grid */
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        
        /* Production Section */
        .production-section { background: var(--paper); border-radius: 8px; padding: 16px; margin-top: 16px; }
        .production-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .production-title { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--oil-navy); }
        .formation-badge { background: white; border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; color: var(--slate-blue); }
        .production-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .production-item { text-align: center; }
        .production-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: var(--slate-blue); margin-bottom: 4px; }
        .production-value { font-size: 16px; font-weight: 700; color: var(--oil-navy); }
        .production-unit { font-size: 11px; font-weight: 500; color: var(--slate-blue); }
        
        /* Dates Row */
        .dates-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
        .date-item { text-align: center; }
        .date-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: var(--slate-blue); margin-bottom: 2px; }
        .date-value { font-size: 12px; font-weight: 600; color: var(--oil-navy); }
        
        /* Card Footer Actions */
        .card-footer { padding: 16px 24px 24px; display: flex; gap: 12px; }
        .action-btn { flex: 1; padding: 12px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; text-decoration: none; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; border: none; }
        .action-btn.primary { background: var(--red-dirt); color: white; }
        .action-btn.primary:hover { background: var(--red-dirt-dark); }
        .action-btn.primary.well-blue { background: var(--slate-blue); }
        .action-btn.primary.well-blue:hover { background: var(--oil-navy); }
        .action-btn.secondary { background: white; color: var(--red-dirt); border: 1px solid var(--red-dirt); }
        .action-btn.secondary:hover { background: #FFF5F0; }
        .action-btn.outline { background: white; color: var(--slate-blue); border: 1px solid var(--border); }
        .action-btn.outline:hover { border-color: var(--slate-blue); color: var(--oil-navy); }
        
        /* Mobile Responsive */
        @media (max-width: 480px) {
            .modal-overlay { padding: 10px; align-items: flex-start; padding-top: 20px; }
            .well-card { max-width: 100%; max-height: calc(100vh - 40px); margin: 0; }
            .two-col { grid-template-columns: 1fr; gap: 12px; }
            .production-grid { grid-template-columns: repeat(2, 1fr); }
            .dates-row { grid-template-columns: 1fr; }
            .card-footer { flex-direction: column; }
            .status-row { flex-wrap: wrap; gap: 16px; }
            .close-btn { top: 12px; right: 12px; width: 36px; height: 36px; font-size: 18px; }
        }
        
        /* Delete Modal Specifics */
        .delete-icon-wrapper { width: 48px; height: 48px; border-radius: 50%; background: #FEE2E2; color: #DC2626; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
        .delete-warning-text { text-align: center; color: var(--slate-blue); font-size: 15px; margin-bottom: 24px; line-height: 1.5; }
        
        /* Custom Confirm Dialog */
        .confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .confirm-overlay.show {
            display: flex;
        }
        
        .confirm-modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: confirmSlideIn 0.2s ease-out;
        }
        
        @keyframes confirmSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .confirm-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .confirm-icon {
            width: 40px;
            height: 40px;
            background: #FEE2E2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .confirm-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--oil-navy);
            margin: 0;
        }
        
        .confirm-body {
            margin-bottom: 24px;
        }
        
        .confirm-message {
            color: var(--slate-blue);
            font-size: 15px;
            line-height: 1.5;
            margin: 0;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .confirm-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .confirm-btn-cancel {
            background: #F3F4F6;
            color: var(--slate-blue);
        }
        
        .confirm-btn-cancel:hover {
            background: #E5E7EB;
        }
        
        .confirm-btn-confirm {
            background: #DC2626;
            color: white;
        }
        
        .confirm-btn-confirm:hover {
            background: #B91C1C;
        }
        
        /* Bulk Selection Styles */
        .bulk-checkbox-column { width: 50px; text-align: center; }
        .bulk-checkbox { cursor: pointer; width: 16px; height: 16px; }
        .bulk-action-bar {
            display: none;
            background: linear-gradient(135deg, #FEF3C7 0%, #FED7AA 100%);
            border: 2px solid #F59E0B;
            border-radius: 8px;
            padding: 16px 24px;
            margin-bottom: 20px;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            position: sticky;
            top: 10px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .bulk-action-bar.active { display: flex; }
        
        .bulk-count {
            color: var(--oil-navy);
            font-size: 15px;
            font-weight: 700;
        }
        
        .bulk-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .bulk-btn {
            background: var(--red-dirt);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bulk-btn:hover:not(:disabled) {
            background: var(--red-dirt-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(192, 86, 33, 0.3);
        }
        
        .bulk-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Add loading state */
        .bulk-btn.loading {
            position: relative;
            color: transparent;
        }
        
        .bulk-btn.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spinner 0.6s linear infinite;
        }
        
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        
        .bulk-clear { color: var(--slate-blue); text-decoration: underline; cursor: pointer; font-size: 13px; }
        .bulk-clear:hover { color: var(--oil-navy); }
        
        /* OCC Warning Tooltip */
        .occ-warning {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        
        .occ-warning-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            margin-left: 6px;
            background: #F59E0B;
            color: white;
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
        }
        
        .occ-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1F2937;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
            width: 280px;
            margin-bottom: 8px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .occ-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1F2937;
        }
        
        .occ-warning:hover .occ-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            min-width: 300px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .toast-show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .toast-success {
            border-left: 4px solid var(--success);
        }
        
        .toast-success .toast-icon {
            background: var(--success-bg);
            color: var(--success);
        }
        
        .toast-error {
            border-left: 4px solid #DC2626;
        }
        
        .toast-error .toast-icon {
            background: #FEE2E2;
            color: #DC2626;
        }
        
        .toast-info {
            border-left: 4px solid #3B82F6;
        }
        
        .toast-info .toast-icon {
            background: #DBEAFE;
            color: #3B82F6;
        }
        
        .toast-message {
            color: var(--oil-navy);
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
        }

        /* Custom Confirm Modal */
        .confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(28, 43, 54, 0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .confirm-overlay.show {
            display: flex;
        }

        .confirm-modal {
            background: white;
            border-radius: 12px;
            padding: 0;
            width: 90%;
            max-width: 440px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                transform: translateY(20px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .confirm-header {
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid var(--border);
        }

        .confirm-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #FEE2E2;
            color: #DC2626;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 24px;
        }

        .confirm-title {
            font-family: 'Merriweather', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--oil-navy);
            text-align: center;
            margin: 0;
        }

        .confirm-body {
            padding: 20px 24px;
        }

        .confirm-message {
            color: var(--slate-blue);
            font-size: 15px;
            line-height: 1.6;
            text-align: center;
            margin: 0;
        }

        .confirm-count {
            display: inline-block;
            background: var(--paper);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 700;
            color: var(--oil-navy);
        }

        .confirm-buttons {
            padding: 16px 24px 24px 24px;
            display: flex;
            gap: 12px;
        }

        .confirm-btn {
            flex: 1;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: inherit;
        }

        .confirm-btn-cancel {
            background: white;
            color: var(--slate-blue);
            border: 1px solid var(--border);
        }

        .confirm-btn-cancel:hover {
            background: var(--paper);
            border-color: var(--slate-blue);
        }

        .confirm-btn-confirm {
            background: #DC2626;
            color: white;
        }

        .confirm-btn-confirm:hover {
            background: #B91C1C;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        .data-table tr.selected { background-color: #F0F9FF; }
        .data-table tr.selected td { border-color: #BFDBFE; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group.full { grid-column: span 2; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; }
        .form-group textarea { resize: vertical; min-height: 60px; }
        .form-hint { font-size: 12px; color: var(--slate-blue); margin-top: 4px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; }
        .btn-cancel { padding: 10px 20px; border: 1px solid var(--border); background: white; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-submit { padding: 10px 20px; background: var(--red-dirt); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .details-grid { display: flex; flex-direction: column; gap: 12px; }
        .details-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .details-row:last-child { border-bottom: none; }
        .details-label { font-size: 13px; color: var(--slate-blue); font-weight: 500; }
        .details-value { font-size: 14px; color: var(--oil-navy); font-weight: 500; text-align: right; max-width: 60%; }
        .details-actions { display: flex; gap: 10px; margin-top: 20px; }
        .details-btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; font-size: 13px; font-weight: 600; text-decoration: none; border-radius: 4px; background: var(--paper); color: var(--slate-blue); border: 1px solid var(--border); flex: 1; text-align: center; }
        .details-btn:hover { background: #E2E8F0; }
        .details-btn.primary { background: var(--red-dirt); color: white; border-color: var(--red-dirt); }
        .details-btn.primary:hover { background: var(--red-dirt-dark); }
        
        /* Modal close button (X) */
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--slate-blue);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .modal-close:hover {
            background: #E2E8F0;
            color: var(--oil-navy);
        }
        
        
        /* Text links for Details and Prod */
        .text-link { 
            color: var(--sky-blue); 
            text-decoration: none; 
            font-size: 13px; 
            font-weight: 600;
            padding: 0 4px;
        }
        .text-link:hover { 
            color: var(--red-dirt); 
            text-decoration: underline; 
        }
        
        /* Hover Helpers */
        .hover-helper { 
            border-bottom: 1px dashed var(--slate-blue); 
            cursor: help; 
            position: relative;
        }
        
        .hover-helper::after {
            content: attr(title);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--oil-navy);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            max-width: 250px;
            white-space: normal;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .hover-helper::before {
            content: '';
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--oil-navy);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        
        .hover-helper:hover::after,
        .hover-helper:hover::before {
            opacity: 1;
            visibility: visible;
        }
        
        /* Disable CSS pseudo-element tooltips for production accordion - we use JS tooltips on desktop and click expansion on mobile */
        .production-accordion-floating .hover-helper::after,
        .production-accordion-floating .hover-helper::before {
            display: none !important;
        }
        
        /* Fix formation badge spacing */
        .formation-badge {
            white-space: nowrap;
        }
        
        footer { background: var(--oil-navy); color: #A0AEC0; padding: 20px 0; font-size: 13px; text-align: center; margin-top: auto; }
        @media (max-width: 768px) { 
            .form-row { grid-template-columns: 1fr; } 
            .form-group.full { grid-column: span 1; } 
            
            /* Mobile navigation - match Learn page style */
            .header-inner {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                gap: 20px;
            }
            
            /* Reset table layout for mobile */
            #propertiesContent .data-table, 
            #wellsContent .data-table { 
                table-layout: auto !important; 
            }
            
            /* Remove fixed widths on mobile - let content flow naturally */
            .col-select,
            .col-prop-county,
            .col-prop-legal,
            .col-prop-acres,
            .col-prop-notes,
            .col-well-name-wide,
            .col-well-operator,
            .col-well-county,
            .col-well-location,
            .col-actions { 
                width: auto !important; 
            }
            
            /* Ensure minimum widths for readability */
            #propertiesContent .data-table td:nth-child(2) { min-width: 80px; } /* County */
            #propertiesContent .data-table td:nth-child(3) { 
                min-width: 100px; /* Legal - increased to prevent wrapping */
                white-space: nowrap; /* Prevent section number from wrapping */
            }
            #propertiesContent .data-table td:nth-child(4) { min-width: 50px; } /* Acres */
            #propertiesContent .data-table td:nth-child(5) { min-width: 100px; } /* Notes */
            
            /* Adjust padding for mobile */
            #propertiesContent .data-table td:nth-child(5) {
                padding-left: 8px !important;
            }
            
            /* Make action buttons smaller on mobile */
            #propertiesContent .data-table td:nth-child(6) {
                white-space: nowrap;
                font-size: 13px;
            }
            
            /* Mobile navigation */
            .nav-links {
                gap: 15px;
            }
            .nav-links a {
                font-size: 13px;
            } 
            
            /* Hide checkboxes and bulk actions completely on mobile */
            .bulk-only,
            .bulk-action-bar,
            th.bulk-only,
            td.bulk-only,
            .bulk-checkbox,
            .bulk-checkbox-column,
            .activity-checkbox,
            .activity-checkbox-input,
            #activityBulkBar { 
                display: none !important; 
            }
            
            /* Adjust activity item layout without checkbox */
            .activity-item {
                padding-left: 20px;
            }
            
            /* Mobile table optimization */
            .data-table { 
                font-size: 12px;
            } 
            .data-table th, .data-table td { 
                padding: 8px 6px;
                vertical-align: top;
            }
            
            /* Mobile expandable cards */
            .well-cards-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            .well-details-content {
                padding: 15px !important;
            }
            
            .well-card {
                padding: 12px !important;
            }
            
            .well-card-title {
                font-size: 12px !important;
                margin-bottom: 8px !important;
            }
            
            .well-card-content {
                font-size: 12px !important;
            }
            
            .well-card-row {
                margin-bottom: 4px !important;
            }
            
            /* Mobile hover helpers */
            .hover-helper::after {
                position: fixed;
                bottom: auto;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 280px;
                white-space: normal;
                text-align: left;
                z-index: 9999;
            }
            
            .hover-helper::before {
                display: none;
            }
            
            /* Hide bulk selection on mobile */
            .bulk-only { display: none !important; }
            .col-well-name { width: 30%; }
            .col-well-name-wide { width: 37%; } /* Even more space on mobile for readability */
            .col-well-operator { width: 28%; } /* Well-specific operator mobile styling */
            .col-well-county { width: 15%; } /* Well-specific county mobile styling */
            .col-well-location { width: 15%; } /* Well-specific location mobile styling */
            .col-operator { width: 25%; } /* Legacy operator mobile styling */
            .col-api { display: none; } /* Hide API column on mobile */
            .col-county { width: 20%; }
            .col-location { width: 15%; }
            .col-actions { width: 20%; } /* More space for buttons on mobile */
            
            /* Hide API column headers and cells specifically on mobile */
            .data-table th:nth-child(4),
            .data-table td:nth-child(4) {
                display: none; /* Hide 4th column (API) on mobile */
            }
            
            /* Hide delete button on mobile - too cramped */
            .btn-delete { display: none; }
            
            /* Properties table mobile adjustments */
            #propertiesContent .data-table th:nth-child(5) { 
                white-space: normal !important; /* Allow "Total Acres" to wrap on mobile */
                line-height: 1.2;
                text-align: center !important; /* Center align on mobile */
                padding-left: 0 !important;
            }
            
            /* Adjust Actions header alignment on mobile */
            #propertiesContent .data-table th:last-child {
                text-align: center !important;
            }
            
            /* Properties table column adjustments on mobile */
            #propertiesContent .col-prop-county { width: 23%; }
            #propertiesContent .col-prop-legal { width: 32%; }
            #propertiesContent .col-prop-acres { width: 20%; padding-left: 5px !important; }
            #propertiesContent .col-prop-group { display: none; } /* Hide group on mobile */
            #propertiesContent .col-prop-notes { display: none; } /* Hide notes on mobile */
            #propertiesContent .col-actions { width: 25%; }
            
            /* Center the acres values on mobile */
            #propertiesContent .data-table td:nth-child(5) {
                text-align: center !important;
                padding-left: 5px !important;
            }
            
            /* Hide notes and group columns on mobile for properties */
            #propertiesContent .col-prop-notes-cell,
            #propertiesContent .col-prop-group {
                display: none;
            }
            
            /* Ensure map button is visible on mobile */
            #propertiesContent .btn-map-link {
                display: inline-flex !important;
                padding: 6px 10px;
                font-size: 12px;
            }
            
            /* Mobile header improvements */
            .page-header { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 15px; 
            }
            .page-header h1 { 
                font-size: 24px; 
                margin-bottom: 5px; 
            }
            .header-actions { 
                flex-direction: column; 
                width: 100%; 
                gap: 8px;
            }
            .action-group {
                width: 100%;
            }
            .btn-add { 
                width: 100%; 
                justify-content: center; 
                padding: 12px 16px;
            }
            .btn-secondary-action {
                width: 100%;
                justify-content: center;
            }
            .action-divider { display: none; }
            
            /* Plan info mobile */
            .plan-info { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 10px; 
            }
            .plan-usage { 
                gap: 15px; 
                width: 100%;
            }
            .upgrade-link { 
                margin-left: 0; 
                align-self: flex-start;
            }
            
            /* Stats card mobile */
            .stats-card { 
                flex-direction: column; 
                gap: 15px; 
                padding: 15px 20px; 
            }
            .stat-divider { 
                width: 60px; 
                height: 1px; 
            }
            .stat-value { 
                font-size: 20px; 
            }
            
            /* Activity mobile */
            .activity-item { 
                flex-direction: column; 
                gap: 12px; 
                padding: 15px;
            }
            .activity-header { 
                flex-direction: column; 
                gap: 8px; 
            }
            .activity-date { 
                align-self: flex-start; 
            }
            .activity-actions {
                flex-wrap: wrap;
                gap: 6px;
            }
            .activity-btn {
                font-size: 11px;
                padding: 4px 8px;
            }
            
            /* Tabs mobile */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 2px;
            }
            .tab {
                flex-shrink: 0;
                padding: 10px 16px;
                font-size: 13px;
            }
            .tab-icon {
                width: 14px;
                height: 14px;
            }
            
            /* Modal mobile */
            .modal {
                margin: 10px;
                width: calc(100vw - 20px);
                max-width: none;
            }
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Toast mobile */
            .toast {
                left: 20px;
                right: 20px;
                min-width: auto;
            }
        }
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        /* Skeleton styling */
        .skeleton {
            background: linear-gradient(90deg, #F3F4F6 25%, #E5E7EB 50%, #F3F4F6 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
        }
        /* Skeleton loading states - Updated 2024-12-13 */
        .skeleton-table { padding: 20px; }
        .skeleton-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .skeleton-cell {
            height: 16px;
        }
        .skeleton-cell.narrow { width: 80px; }
        .skeleton-cell.medium { width: 150px; }
        .skeleton-header { display: flex; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .skeleton-header .skeleton-cell { height: 14px; opacity: 0.5; }
        .skeleton-activity { padding: 20px; display: flex; gap: 16px; border-bottom: 1px solid var(--border); }
        .skeleton-activity:last-child { border-bottom: none; }
        .skeleton-avatar { width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; }
        .skeleton-activity-content { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .skeleton-line { height: 16px; }
        .skeleton-line.short { width: 40%; }
        .skeleton-line.medium { width: 60%; }
        .skeleton-line.long { width: 85%; }
        
        /* Search and Sort Controls */
        .table-controls {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            background: var(--paper);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--red-dirt);
        }
        .search-input::placeholder {
            color: #94a3b8;
        }
        .sort-select {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            cursor: pointer;
            min-width: 160px;
        }
        .sort-select:focus {
            outline: none;
            border-color: var(--red-dirt);
        }
        .results-count {
            font-size: 13px;
            color: var(--slate-blue);
            margin-left: auto;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-inner">
                <a href="/" class="logo">Mineral Watch</a>
                <nav class="nav-links">
                    <a href="/portal" class="active">Dashboard</a>
                    <a href="/portal/oklahoma-map">My Map</a>
                    <a href="/portal/account">Account</a>
                    <a href="/portal/learn">Learn</a>
                </nav>
                <div class="user-menu">
                    <span class="user-name" id="userName">Loading...</span>
                    <button class="btn-logout" id="logoutBtn">Log Out</button>
                </div>
            </div>
        </div>
    </header>
    <main>
        <div class="container">
            <div class="page-header">
                <h1 style="margin: 0;">My Monitoring</h1>
                <div class="header-actions">
                    <div class="action-group">
                        <button class="btn-add" id="addPropertyBtn">
                            <span></span> Property
                        </button>
                        <button class="btn-secondary-action" id="bulkUploadBtn" title="Import Properties" onclick="openBulkUploadModal()">
                            Import
                        </button>
                        <button class="btn-secondary-action" id="exportPropertiesBtn" style="display: none;" onclick="exportPropertiesCSV()" title="Export Properties">
                            Export
                        </button>
                    </div>
                    <div class="action-divider"></div>
                    <div class="action-group">
                        <button class="btn-add" id="addWellBtn">
                            <span></span> Well
                        </button>
                        <button class="btn-secondary-action" id="bulkUploadWellsBtn" title="Import Wells" onclick="openBulkUploadWellsModal()">
                            Import
                        </button>
                        <button class="btn-secondary-action" id="exportWellsBtn" style="display: none;" onclick="exportWellsCSV()" title="Export Wells">
                            Export
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="plan-info">
                <span class="plan-badge" id="planBadge">FREE</span>
                <div class="plan-usage">
                    <div class="usage-item">
                        <span><strong id="propCount">0</strong> / <strong id="propLimit">1</strong> Properties</span>
                    </div>
                    <div class="usage-item">
                        <span>|</span>
                    </div>
                    <div class="usage-item">
                        <span><strong id="wellCount">0</strong> / <strong id="wellLimit">0</strong> Wells</span>
                    </div>
                </div>
                <a href="/portal/upgrade" class="upgrade-link" id="upgradeLink">Upgrade </a>
            </div>
            
            <div class="stats-card" id="statsCard">
                <div class="stat-item">
                    <span class="stat-label">Last Alert</span>
                    <span class="stat-value" id="statLastAlert"></span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">This Month</span>
                    <span class="stat-value" id="statThisMonth">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">This Year</span>
                    <span class="stat-value" id="statThisYear">0</span>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="properties">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    Properties
                </button>
                <button class="tab" data-tab="wells">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    Wells
                </button>
                <button class="tab" data-tab="activity">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    Activity Log
                </button>
            </div>

            <div class="content-card">
                <div id="properties-tab" class="tab-content active">
                    <div id="propertiesControls" class="table-controls" style="display: none;">
                        <input type="text" id="propertiesSearch" class="search-input" placeholder="Search properties by county, section, township, or range...">
                        <select id="propertiesSort" class="sort-select">
                            <option value="legal-asc" selected>Legal Description</option>
                            <option value="acres-desc">Total Acres (High to Low)</option>
                            <option value="acres-asc">Total Acres (Low to High)</option>
                            <option value="date-desc">Date Added</option>
                        </select>
                        <span id="propertiesResultsCount" class="results-count"></span>
                    </div>
                   <div id="propertiesBulkActionBar" class="bulk-action-bar">
                        <div class="bulk-count"><span class="selected-count">0</span> selected</div>
                        <div class="bulk-actions">
                            <button class="bulk-btn" onclick="bulkDeleteSelected('properties')">
                                Delete Selected
                            </button>
                        </div>
                        <span class="bulk-clear" onclick="clearSelection('properties')">Clear selection</span>
                    </div>
                   <div id="propertiesContent">
    <div class="skeleton-table">
        <div class="skeleton-header">
            <div class="skeleton skeleton-cell medium"></div>
            <div class="skeleton skeleton-cell narrow"></div>
            <div class="skeleton skeleton-cell narrow"></div>
            <div class="skeleton skeleton-cell narrow"></div>
            <div class="skeleton skeleton-cell narrow"></div>
            <div class="skeleton skeleton-cell narrow"></div>
        </div>
        <div class="skeleton-row"><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div></div>
        <div class="skeleton-row"><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div></div>
        <div class="skeleton-row"><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div></div>
    </div>
</div>
                </div>
                
                <div id="wells-tab" class="tab-content">
                    <div id="wellsControls" class="table-controls" style="display: none;">
                        <input type="text" id="wellsSearch" class="search-input" placeholder="Search wells by name, operator, API, or county...">
                        <select id="wellsSort" class="sort-select">
                            <option value="legal-asc" selected>Legal Description</option>
                            <option value="date-desc">Date Added</option>
                            <option value="name-asc">Well Name</option>
                            <option value="operator-asc">Operator</option>
                        </select>
                        <span id="wellsResultsCount" class="results-count"></span>
                    </div>
                   <div id="wellsBulkActionBar" class="bulk-action-bar">
                        <div class="bulk-count"><span class="selected-count">0</span> selected</div>
                        <div class="bulk-actions">
                            <button class="bulk-btn" onclick="bulkDeleteSelected('wells')">
                                Delete Selected
                            </button>
                        </div>
                        <span class="bulk-clear" onclick="clearSelection('wells')">Clear selection</span>
                    </div>
                   <div id="wellsContent">
    <table class="data-table">
        <thead>
            <tr>
                <th class="bulk-only skeleton skeleton-cell"></th>
                <th class="skeleton skeleton-cell">Well Name</th>
                <th class="skeleton skeleton-cell">Operator</th>
                <th class="skeleton skeleton-cell">County</th>
                <th class="skeleton skeleton-cell">Legal</th>
                <th class="skeleton skeleton-cell"></th>
            </tr>
        </thead>
        <tbody>
            <tr><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td></tr>
            <tr><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td></tr>
            <tr><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td></tr>
        </tbody>
    </table>
</div>
                </div>

                <div id="activity-tab" class="tab-content">
                    <!-- Activity Bulk Action Bar -->
                    <div class="bulk-action-bar" id="activityBulkBar">
                        <div class="bulk-info">
                            <span id="activitySelectedCount">0</span> activities selected
                        </div>
                        <div class="bulk-actions">
                            <button class="bulk-btn" onclick="bulkDeleteSelected('activity')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <path stroke="currentColor" stroke-width="2" d="M3 6h18M8 6V4a1 1 0 011-1h6a1 1 0 011 1v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14zM10 11v6M14 11v6"/>
                                </svg>
                                Delete Selected
                            </button>
                        </div>
                    </div>

                    <div id="activityContent">
                    <div class="skeleton-activity"><div class="skeleton skeleton-avatar"></div><div class="skeleton-activity-content"><div class="skeleton skeleton-line short"></div><div class="skeleton skeleton-line long"></div><div class="skeleton skeleton-line medium"></div></div></div>
                    <div class="skeleton-activity"><div class="skeleton skeleton-avatar"></div><div class="skeleton-activity-content"><div class="skeleton skeleton-line short"></div><div class="skeleton skeleton-line long"></div><div class="skeleton skeleton-line medium"></div></div></div>
                    <div class="skeleton-activity"><div class="skeleton skeleton-avatar"></div><div class="skeleton-activity-content"><div class="skeleton skeleton-line short"></div><div class="skeleton skeleton-line long"></div><div class="skeleton skeleton-line medium"></div></div></div>
                </div>
                </div>
            </div>
        </div>
    </main>
    <footer><div class="container">&copy; 2025 Mineral Watch</div></footer>
    
    <!-- Add Property Modal - Styled Like Property Details -->
    <div class="modal-overlay" id="addPropertyModal">
        <div class="property-card" style="max-width: 520px; width: 100%;">
            <!-- Header with Orange Gradient -->
            <div class="property-card-header">
                <button class="close-btn" onclick="closePropertyModal()" aria-label="Close"></button>
                <div class="card-header-top">
                    <h2 class="property-name">Add Property</h2>
                    <span class="acreage-badge" id="addPropertyAcreageBadge" style="display: none;">0 acres</span>
                </div>
                <div class="property-location" id="addPropertyLocation" style="opacity: 0;">Location</div>
            </div>
            
            <!-- Content -->
            <div class="card-content">
                <form id="addPropertyForm">
                    <div class="details-grid">
                        <!-- County -->
                        <div class="details-row">
                            <span class="details-label">County</span>
                            <select id="county" required onchange="autoSetMeridian(this.value); updateLocationDisplay();" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white; width: 200px;">
                                <option value="">Select County</option>
                                <option>Alfalfa</option><option>Atoka</option><option>Beaver</option><option>Beckham</option><option>Blaine</option><option>Bryan</option><option>Caddo</option><option>Canadian</option><option>Carter</option><option>Cherokee</option><option>Choctaw</option><option>Cimarron</option><option>Cleveland</option><option>Coal</option><option>Comanche</option><option>Cotton</option><option>Craig</option><option>Creek</option><option>Custer</option><option>Delaware</option><option>Dewey</option><option>Ellis</option><option>Garfield</option><option>Garvin</option><option>Grady</option><option>Grant</option><option>Greer</option><option>Harmon</option><option>Harper</option><option>Haskell</option><option>Hughes</option><option>Jackson</option><option>Jefferson</option><option>Johnston</option><option>Kay</option><option>Kingfisher</option><option>Kiowa</option><option>Latimer</option><option>Le Flore</option><option>Lincoln</option><option>Logan</option><option>Love</option><option>Major</option><option>Marshall</option><option>Mayes</option><option>McClain</option><option>McCurtain</option><option>McIntosh</option><option>Murray</option><option>Muskogee</option><option>Noble</option><option>Nowata</option><option>Okfuskee</option><option>Oklahoma</option><option>Okmulgee</option><option>Osage</option><option>Ottawa</option><option>Pawnee</option><option>Payne</option><option>Pittsburg</option><option>Pontotoc</option><option>Pottawatomie</option><option>Pushmataha</option><option>Roger Mills</option><option>Rogers</option><option>Seminole</option><option>Sequoyah</option><option>Stephens</option><option>Texas</option><option>Tillman</option><option>Tulsa</option><option>Wagoner</option><option>Washington</option><option>Washita</option><option>Woods</option><option>Woodward</option>
                            </select>
                        </div>
                        
                        <!-- Legal Description -->
                        <div class="details-row" style="align-items: center;">
                            <span class="details-label">Legal</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="text" id="section" placeholder="Sec" pattern="^[0-9]{1,2}$" title="Section number (1-36)" required 
                                       style="padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; width: 50px; text-align: center;"
                                       oninput="updateLocationDisplay()">
                                <span>-</span>
                                <input type="text" id="township" placeholder="Twn" pattern="^[0-9]{1,2}[NS]$" title="e.g., 12N" required
                                       style="padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; width: 60px; text-align: center; text-transform: uppercase;"
                                       oninput="updateLocationDisplay()">
                                <span>-</span>
                                <input type="text" id="range" placeholder="Rng" pattern="^[0-9]{1,2}[WE]$" title="e.g., 4W" required
                                       style="padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; width: 60px; text-align: center; text-transform: uppercase;"
                                       oninput="updateLocationDisplay()">
                                <select id="meridian" style="padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; font-family: inherit; background: white;">
                                    <option value="IM">IM</option>
                                    <option value="CM">CM</option>
                                </select>
                            </div>
                        </div>
                        <div class="details-row" style="margin-top: -10px;">
                            <span class="details-label"></span>
                            <div class="form-hint" style="font-size: 11px; color: #64748B;">Section number only. Ownership details go in notes.</div>
                        </div>
                        
                        <!-- RI Acres -->
                        <div class="details-row">
                            <span class="details-label">RI Acres</span>
                            <input type="number" id="addPropertyRIAcres" step="0.01" min="0" 
                                   style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white; width: 120px;" 
                                   placeholder="0" oninput="updateAddPropertyTotalAcres()">
                        </div>
                        
                        <!-- WI Acres -->
                        <div class="details-row">
                            <span class="details-label">WI Acres</span>
                            <input type="number" id="addPropertyWIAcres" step="0.01" min="0" 
                                   style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white; width: 120px;" 
                                   placeholder="0" oninput="updateAddPropertyTotalAcres()">
                        </div>
                        
                        <!-- Total Acres (calculated) -->
                        <div class="details-row">
                            <span class="details-label">Total Acres</span>
                            <span class="details-value" id="addPropertyTotalAcres" style="font-weight: 600;">0</span>
                        </div>
                        
                        <!-- Group -->
                        <div class="details-row">
                            <span class="details-label">Group</span>
                            <input type="text" id="addPropertyGroup" 
                                   style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white; width: 200px;" 
                                   placeholder="e.g., Family Trust, Personal">
                        </div>
                        
                        <!-- Notes -->
                        <div class="details-row" style="flex-direction: column; align-items: flex-start;">
                            <span class="details-label" style="margin-bottom: 8px;">Notes</span>
                            <textarea id="propertyNotes" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical;" 
                                      placeholder="Add legal descriptions, lease info, or other details..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Footer Actions -->
                    <div class="card-footer" style="margin-top: 20px;">
                        <button type="button" class="action-btn secondary" onclick="closePropertyModal()">Cancel</button>
                        <button type="submit" class="action-btn primary" style="flex: 2;">Save & Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Well Modal -->
    <div class="modal-overlay" id="addWellModal">
        <div class="modal" style="max-width: 600px; width: 100%; position: relative;">
            <button class="modal-close" onclick="closeWellModal()" aria-label="Close"></button>
            <h2>Add Well</h2>
            
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="api-tab">Search by API</button>
                <button class="tab-btn" data-tab="location-tab">Search by Name/Location</button>
            </div>
            
            <!-- API Search Tab -->
            <div class="tab-content active" id="api-tab">
                <form id="addWellForm">
                    <div class="form-group full">
                        <label for="apiNumber">API Number *</label>
                        <input type="text" id="apiNumber" placeholder="3515322352" required>
                        <div class="form-hint">10-digit Oklahoma well API (starts with 35)</div>
                    </div>
                    <div class="form-group full">
                        <label for="wellNotes">Notes (Optional)</label>
                        <textarea id="wellNotes" placeholder="Any notes about this well"></textarea>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn-cancel" onclick="closeWellModal()">Cancel</button>
                        <button type="submit" class="btn-submit">Add Well</button>
                    </div>
                </form>
            </div>
            
            <!-- Name/Location Search Tab -->
            <div class="tab-content" id="location-tab">
                <div class="search-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="searchWellName">Well Name</label>
                            <input type="text" id="searchWellName" placeholder="e.g., Collins">
                        </div>
                        <div class="form-group">
                            <label for="searchOperator">Operator</label>
                            <input type="text" id="searchOperator" placeholder="e.g., Devon">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="searchSection">Section</label>
                            <input type="number" id="searchSection" placeholder="1-36" min="1" max="36">
                        </div>
                        <div class="form-group">
                            <label for="searchTownship">Township</label>
                            <input type="text" id="searchTownship" placeholder="e.g., 12N or 12">
                        </div>
                        <div class="form-group">
                            <label for="searchRange">Range</label>
                            <input type="text" id="searchRange" placeholder="e.g., 5W or 5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full">
                            <label for="searchCounty">County</label>
                            <input type="text" id="searchCounty" placeholder="e.g., Grady">
                        </div>
                    </div>
                    
                    <div class="search-buttons">
                        <button type="button" class="btn-search" onclick="searchWells()">Search Wells</button>
                        <button type="button" class="btn-clear" onclick="clearWellSearch()">Clear</button>
                    </div>
                </div>
                
                <!-- Search Results -->
                <div id="searchResults" class="search-results" style="display: none;">
                    <div class="results-header">
                        <h3>Search Results</h3>
                        <div class="results-info" id="resultsInfo"></div>
                    </div>
                    <div class="results-list" id="resultsList">
                        <!-- Results will be populated here -->
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="searchLoading" class="search-loading" style="display: none;">
                    <div class="spinner"></div>
                    <div>Searching wells...</div>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeWellModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Well Details Modal - New Card Design -->
    <div class="modal-overlay" id="wellDetailsModal">
        <div class="well-card" style="max-width: 520px; width: 100%;">
            <!-- Header -->
            <div class="card-header">
                <button class="close-btn" onclick="closeWellDetailsModal()" aria-label="Close"></button>
                <div class="card-header-top">
                    <h2 class="well-name" id="wellDetailsTitle">Well Details</h2>
                    <span class="date-badge" id="wellDetailsDateBadge">2018-08-05</span>
                </div>
                <div class="api-number" id="wellDetailsApi">API: </div>
            </div>
            
            <!-- Content -->
            <div class="card-content">
                <!-- Status Row -->
                <div class="status-row">
                    <div class="status-item">
                        <span class="status-label">Status</span>
                        <span class="status-badge" id="wellDetailsStatusBadge">AC</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Well Type</span>
                        <span class="status-value" id="wellDetailsType">GAS</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Direction</span>
                        <span class="status-badge horizontal" id="wellDetailsDirection">Horizontal</span>
                    </div>
                </div>
                
                <!-- Operator -->
                <div class="info-section">
                    <div class="section-label">Operator</div>
                    <div class="section-value" id="wellDetailsOperator">Validus Energy II Midcon LLC</div>
                    <div class="contact-line" id="wellDetailsContact">
                        <a href="tel:7209742084" id="wellDetailsPhoneLink">(720) 974-2084</a>  <span id="wellDetailsContactPerson">Michelle Pettifor</span>
                    </div>
                </div>
                
                <!-- Location / County -->
                <div class="two-col">
                    <div class="info-section">
                        <div class="section-label">Location</div>
                        <div class="section-value" id="wellDetailsLocation">T03N R03W 25</div>
                    </div>
                    <div class="info-section">
                        <div class="section-label">County</div>
                        <div class="section-value" id="wellDetailsCounty">Garvin County</div>
                    </div>
                </div>
                
                <!-- Production Section (conditionally shown) -->
                <div class="production-section" id="wellDetailsProduction" style="display: none;">
                    <div class="production-header">
                        <span class="production-title">Production Data</span>
                        <span class="formation-badge" id="wellDetailsFormationBadge">Woodford</span>
                    </div>
                    
                    <div class="production-grid">
                        <div class="production-item">
                            <div class="production-label">IP Gas</div>
                            <div class="production-value" id="wellDetailsIPGas">2,847</div>
                            <div class="production-unit">MCF/day</div>
                        </div>
                        <div class="production-item">
                            <div class="production-label">IP Oil</div>
                            <div class="production-value" id="wellDetailsIPOil">156</div>
                            <div class="production-unit">BBL/day</div>
                        </div>
                        <div class="production-item">
                            <div class="production-label">Depth</div>
                            <div class="production-value" id="wellDetailsDepth">15,004</div>
                            <div class="production-unit">ft</div>
                        </div>
                    </div>
                    
                    <div class="dates-row">
                        <div class="date-item">
                            <div class="date-label">Completed</div>
                            <div class="date-value" id="wellDetailsCompleted">2018-07-28</div>
                        </div>
                        <div class="date-item">
                            <div class="date-label">First Prod</div>
                            <div class="date-value" id="wellDetailsFirstProd">2018-08-05</div>
                        </div>
                    </div>
                </div>
                
                <!-- Notes Section -->
                <div class="info-section" style="margin-top: 16px;">
                    <div class="section-label">Notes</div>
                    <textarea id="wellDetailsNotes" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical; margin-top: 6px;" placeholder="Add notes about this well..."></textarea>
                </div>
            </div>
            
            <!-- Footer Actions -->
            <div class="card-footer">
                <a href="#" target="_blank" class="action-btn primary well-blue" id="wellDetailsMapLink">OCC Map </a>
                <div class="occ-warning" style="flex: 1;">
                    <a href="#" target="_blank" class="action-btn secondary" id="wellDetailsRecordsLink" style="width: 100%;">Well Records </a>
                    <span class="occ-warning-icon">!</span>
                    <div class="occ-tooltip">
                        <strong>OCC Website Note:</strong> If you see a cookie error on OCC's site, try signing out of OCC first or open this link in an incognito/private window.
                    </div>
                </div>
                <button class="action-btn outline" id="saveWellBtn" onclick="saveWellNotesAndClose()">Save & Close</button>
            </div>
            
            <input type="hidden" id="wellDetailsId">
        </div>
    </div>
    
    <!-- Property Details Modal - Orange Card Design -->
    <div class="modal-overlay" id="propertyDetailsModal">
        <div class="property-card" style="max-width: 520px; width: 100%;">
            <!-- Header with Orange Gradient -->
            <div class="property-card-header">
                <button class="close-btn" onclick="closePropertyDetailsModal()" aria-label="Close"></button>
                <div class="card-header-top">
                    <h2 class="property-name" id="propertyDetailsTitle">Property Details</h2>
                    <span class="acreage-badge" id="propertyDetailsAcreageBadge">47.5 acres</span>
                </div>
                <div class="property-location" id="propertyDetailsLocation">Garvin County  T03N R03W 25</div>
            </div>
            
            <!-- Content -->
            <div class="card-content">
            
            <div class="details-grid">
                <div class="details-row">
                    <span class="details-label">Legal</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="details-value" id="propertyDetailsLegal" style="font-family: monospace;"></span>
                        <select id="propertyDetailsMeridian" style="padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; font-family: inherit; background: white;">
                            <option value="IM">IM</option>
                            <option value="CM">CM</option>
                        </select>
                    </div>
                </div>
                <div class="details-row" id="propertyDetailsGroupRow" style="display: none;">
                    <span class="details-label">Group</span>
                    <span class="details-value" id="propertyDetailsGroup"></span>
                </div>
                <div class="details-row">
                    <span class="details-label">Total Acres</span>
                    <span class="details-value" id="propertyDetailsTotalAcres" style="font-weight: 500;"></span>
                </div>
                <div class="details-row">
                    <span class="details-label">RI Acres</span>
                    <input type="number" id="propertyDetailsRIAcres" step="0.01" min="0" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white; width: 120px;" placeholder="0" oninput="updateTotalAcres()">
                </div>
                <div class="details-row">
                    <span class="details-label">WI Acres</span>
                    <input type="number" id="propertyDetailsWIAcres" step="0.01" min="0" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white; width: 120px;" placeholder="0" oninput="updateTotalAcres()">
                </div>
                <div class="details-row">
                    <span class="details-label">Monitor Adjacent</span>
                    <span class="details-value" id="propertyDetailsAdjacent"></span>
                </div>
                <div class="details-row" style="flex-direction: column; align-items: flex-start;">
                    <span class="details-label" style="margin-bottom: 8px;">Notes</span>
                    <textarea id="propertyDetailsNotes" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical;" placeholder="Add notes about this property..."></textarea>
                </div>
            </div>
            
            <input type="hidden" id="propertyDetailsId">
            
            <!-- Footer Actions -->
            <div class="card-footer">
                <a href="#" target="_blank" class="action-btn primary" id="propertyDetailsMapLink">OCC Map </a>
                <button class="action-btn secondary" onclick="closePropertyDetailsModal()">Close</button>
                <button class="action-btn outline" id="savePropertyBtn" onclick="savePropertyAndClose()">Save & Close</button>
            </div>
        </div>
    </div>
    
    <script>
        // Security: escape HTML to prevent XSS from user-generated content
        function escapeHtml(text) {
            if (!text) return '';
            const str = String(text);
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        // Clean county display - remove numeric prefix like "011-" from "011-BLAINE"
        function cleanCountyDisplay(county) {
            if (!county) return '';
            // Remove any leading digits followed by a hyphen
            return county.replace(/^\d+-/, '');
        }
        
        // Format activity location from S15-T12N-R5W to T12N R5W 15
        function formatActivityLocation(location) {
            if (!location) return '';
            
            // Try to parse S15-T12N-R5W format
            const match = location.match(/S(\d+)-T([^-]+)-R(.+)/i);
            if (match) {
                const [_, section, township, range] = match;
                return `T${township} R${range} ${section}`;
            }
            
            // Return original if can't parse
            return escapeHtml(location);
        }

        // OCC Status Code Definitions for Hover Tooltips
        const occStatusHelp = {
            'AC': 'Well is open and not plugged (could still be used or revived).',
            'ND': 'New drill - well recently drilled, completion info pending.',
            'SP': 'Drilling has started (spudded), but the well is not finished yet.',
            'TA': 'Well is shut in but not plugged; could be brought back or later plugged.',
            'PA': 'Well has been fully plugged and abandoned (no future production).',
            'OR': 'Orphan well with no responsible operator on record.',
            'STFD': 'On the state\'s list to be plugged with Oklahoma funds.',
            'PASF': 'Well plugged using Oklahoma state funds.',
            'PASUR': 'Well plugged using bond/surety money from the operator.',
            'PASURSF': 'Well plugged using a mix of surety and state funds.',
            'PAFF': 'Well plugged using federal funds.'
        };

        // Well Type Code Definitions for Hover Tooltips
        const wellTypeHelp = {
            'NULL': 'Well type unknown; records incomplete.',
            '2D': 'Older disposal/injection well type.',
            '2DCm': 'Commercial disposal well taking fluid from others.',
            '2DNC': 'Non-commercial disposal well for one operator/lease.',
            '2R': 'Enhanced recovery injection well (helps push oil to producers).',
            '2RIn': 'Enhanced recovery injection well  UIC type.',
            '2RSi': 'Enhanced recovery injection well that can also produce some oil or gas.',
            'DRY': 'Dry hole; no commercial oil or gas found.',
            'GAS': 'Gas production well.',
            'GSW': 'Storage well used for gas.',
            'IEPA': 'Federal injection well regulated under EPA.',
            'INJ': 'General injection/disposal well.',
            'LPSW': 'Storage well for LPG.',
            'ND': 'Well type unknown; documents missing.',
            'NT': 'No type assigned; likely missing completion info.',
            'OBW': 'Observation/monitoring well for gas storage.',
            'OG': 'Oil and gas production well.',
            'OIL': 'Oil-only production well.',
            'OPRH': 'Legacy orphaned production well type.',
            'P&A': 'Legacy plugged and abandoned well type.',
            'PA': 'Plugged and abandoned well type.',
            'STFD': 'State-funds well type; used for state plugging records.',
            'SW': 'Service well (testing, maintenance, etc.).',
            'SWD': 'Saltwater disposal well.',
            'TA': 'Temporarily abandoned well type (legacy).',
            'TM': 'Terminated UIC well type (authorization revoked or ended).',
            'TWW': 'Legacy water-related UIC well type.',
            'WSW': 'Water supply well used for various purposes.'
        };

        // Production Terms Help for Hover Tooltips
        const productionHelp = {
            "ipGas": "Initial Production Gas - 24-hour flow test rate when well first came online",
            "ipOil": "Initial Production Oil - 24-hour flow test rate when well first came online", 
            "ipWater": "Initial Production Water - 24-hour flow test rate when well first came online",
            "lateral": "Lateral Length - horizontal portion of wellbore drilled through the formation",
            "formation": "Geological Formation - the specific rock layer being produced for oil/gas",
            "spudDate": "Spud Date - when drilling operations began at this well location",
            "completedDate": "Completion Date - when well construction finished and production equipment was installed",
            "firstProdDate": "First Production Date - when commercial oil/gas production began",
            "multiSection": "Multi-Section Horizontal - wellbore crosses multiple land sections for maximum formation contact"
        };
        
        // Format phone number for display (e.g., 4051234567 -> (405) 123-4567)
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            // Remove all non-digits
            const digits = phone.replace(/\D/g, '');
            
            if (digits.length === 10) {
                return `(${digits.substr(0,3)}) ${digits.substr(3,3)}-${digits.substr(6,4)}`;
            } else if (digits.length === 11 && digits.startsWith('1')) {
                return `+1 (${digits.substr(1,3)}) ${digits.substr(4,3)}-${digits.substr(7,4)}`;
            } else {
                return phone; // Return original if format doesn't match
            }
        }
        
        // View property on My Map
        function viewOnMap(propertyId) {
            const property = loadedProperties.find(p => p.id === propertyId);
            if (property) {
                const f = property.fields;
                // Pass property ID and location info for centering
                const params = new URLSearchParams({
                    property: propertyId,
                    county: f.COUNTY,
                    section: f.SEC,
                    township: f.TWN,
                    range: f.RNG
                });
                window.open(`/portal/oklahoma-map?${params.toString()}`, '_blank');
            }
        }
        
        const planConfigs = { 
            'Free': { properties: 1, wells: 1 }, 
            'Starter': { properties: 10, wells: 10 }, 
            'Standard': { properties: 50, wells: 50 }, 
            'Professional': { properties: 250, wells: 250 }, 
            'Enterprise 500': { properties: 500, wells: 500 },
            'Enterprise': { properties: Infinity, wells: Infinity } 
        };
        let currentTab = 'properties';
        let currentUser = null; // Store user data globally
        
        // Bulk Selection State
        let selectedProperties = new Set();
        let selectedWells = new Set();
        let selectedActivity = new Set();
        
        // Bulk Selection Functions
        function updateBulkActionVisibility() {
            // Show/hide bulk action bars based on selection state
            const propBar = document.getElementById('propertiesBulkActionBar');
            const wellBar = document.getElementById('wellsBulkActionBar');
            const activityBar = document.getElementById('activityBulkBar');
            
            if (propBar) {
                propBar.style.display = selectedProperties.size > 0 ? 'flex' : 'none';
                const count = document.querySelector('#propertiesBulkActionBar .selected-count');
                if (count) count.textContent = selectedProperties.size;
            }
            
            if (wellBar) {
                wellBar.style.display = selectedWells.size > 0 ? 'flex' : 'none';
                const count = document.querySelector('#wellsBulkActionBar .selected-count');
                if (count) count.textContent = selectedWells.size;
            }
            
            if (activityBar) {
                activityBar.classList.toggle('active', selectedActivity.size > 0);
                const count = document.getElementById('activitySelectedCount');
                if (count) count.textContent = selectedActivity.size;
            }
        }
        
        function togglePropertySelection(propertyId, checked) {
            if (checked) {
                selectedProperties.add(propertyId);
            } else {
                selectedProperties.delete(propertyId);
            }
            updateBulkActionVisibility();
            updateSelectAllState('properties');
        }
        
        function toggleWellSelection(wellId, checked) {
            if (checked) {
                selectedWells.add(wellId);
            } else {
                selectedWells.delete(wellId);
            }
            updateBulkActionVisibility();
            updateSelectAllState('wells');
        }
        
        function selectAllItems(type, checked) {
            if (type === 'properties') {
                const checkboxes = document.querySelectorAll('.property-checkbox');
                selectedProperties.clear();
                checkboxes.forEach(cb => {
                    cb.checked = checked;
                    if (checked) selectedProperties.add(cb.dataset.id);
                });
            } else if (type === 'wells') {
                const checkboxes = document.querySelectorAll('.well-checkbox');
                selectedWells.clear();
                checkboxes.forEach(cb => {
                    cb.checked = checked;
                    if (checked) selectedWells.add(cb.dataset.id);
                });
            }
            updateBulkActionVisibility();
        }
        
        function updateSelectAllState(type) {
            const selectAllId = type === 'properties' ? 'selectAllProperties' : 'selectAllWells';
            const checkboxes = document.querySelectorAll(type === 'properties' ? '.property-checkbox' : '.well-checkbox');
            const selectedSet = type === 'properties' ? selectedProperties : selectedWells;
            const selectAllCheckbox = document.getElementById(selectAllId);
            
            if (!selectAllCheckbox) return;
            
            if (selectedSet.size === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedSet.size === checkboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }
        }
        
        let deleteInProgress = false;
        
        async function bulkDeleteSelected(type) {
            if (deleteInProgress) return;
            deleteInProgress = true;
            
            const selectedSet = type === 'properties' ? selectedProperties : 
                               type === 'wells' ? selectedWells : selectedActivity;
            const itemName = type === 'properties' ? 'properties' : 
                           type === 'wells' ? 'wells' : 'activities';
            
            if (selectedSet.size === 0) {
                deleteInProgress = false;
                return;
            }
            
            // Use custom confirm dialog instead of system confirm
            const confirmed = await showConfirm(
                `Delete ${selectedSet.size} ${itemName}?<br><br>This action cannot be undone.`,
                {
                    title: `Delete ${selectedSet.size} ${itemName}?`,
                    confirmText: 'Delete',
                    cancelText: 'Cancel'
                }
            );
            
            if (!confirmed) {
                deleteInProgress = false;
                return;
            }
            
            // Get the delete button and add loading state
            const deleteBtn = document.querySelector(`[onclick*="bulkDeleteSelected('${type}')"]`);
            if (deleteBtn) {
                deleteBtn.classList.add('loading');
                deleteBtn.disabled = true;
            }
            
            // Show immediate feedback
            const totalItems = selectedSet.size;
            showToast(`Deleting ${totalItems} ${itemName}...`, 'info', 0); // 0 = persistent until manually dismissed
            
            try {
                const itemsToDelete = Array.from(selectedSet);
                let successCount = 0;
                let failCount = 0;
                
                // Batch deletes in groups of 5 (Airtable rate limit)
                for (let i = 0; i < itemsToDelete.length; i += 5) {
                    const batch = itemsToDelete.slice(i, i + 5);
                    const deletePromises = batch.map(async id => {
                        const endpoint = type === 'properties' ? `/api/properties/${id}` : 
                                       type === 'wells' ? `/api/wells/${id}` : `/api/activity/${id}`;
                        try {
                            const res = await fetch(endpoint, { method: 'DELETE' });
                            if (res.ok) {
                                successCount++;
                            } else {
                                const error = await res.text();
                                console.error(`Failed to delete ${type} ${id}:`, res.status, error);
                                failCount++;
                            }
                        } catch (err) {
                            console.error(`Error deleting ${type} ${id}:`, err);
                            failCount++;
                        }
                    });
                    
                    await Promise.all(deletePromises);
                    
                    // Update progress in toast
                    const processed = Math.min(i + 5, totalItems);
                    if (processed < totalItems) {
                        // Dismiss previous toast and show updated progress
                        dismissToast();
                        showToast(`Deleting ${itemName}... ${processed}/${totalItems}`, 'info', 0);
                    }
                    
                    // Wait 1 second between batches for rate limiting
                    if (i + 5 < itemsToDelete.length) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                // Dismiss progress toast before showing final result
                dismissToast();
                
                // Clear selection
                selectedSet.clear();
                updateBulkActionVisibility();
                
                // Reload data
                await loadAllData();
                
                // Show success toast
                if (failCount === 0) {
                    showToast(`Successfully deleted ${successCount} ${itemName}`, 'success', 4000);
                } else {
                    showToast(`Deleted ${successCount} ${itemName}. ${failCount} failed.`, 'error', 6000);
                }
                
            } catch (err) {
                console.error(`Bulk delete ${itemName} error:`, err);
                showToast(`Failed to delete ${itemName}. Please try again.`, 'error');
            } finally {
                // Remove loading state
                if (deleteBtn) {
                    deleteBtn.classList.remove('loading');
                    deleteBtn.disabled = false;
                }
                deleteInProgress = false;
            }
        }
        
        function clearSelection(type) {
            if (type === 'properties') {
                selectedProperties.clear();
                document.querySelectorAll('.property-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('selectAllProperties').checked = false;
                document.getElementById('selectAllProperties').indeterminate = false;
            } else if (type === 'wells') {
                selectedWells.clear();
                document.querySelectorAll('.well-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('selectAllWells').checked = false;
                document.getElementById('selectAllWells').indeterminate = false;
            } else if (type === 'activity') {
                selectedActivity.clear();
                document.querySelectorAll('.activity-checkbox-input').forEach(cb => cb.checked = false);
            }
            updateBulkActionVisibility();
        }
        
        async function bulkAddToWells() {
            if (selectedProperties.size === 0) return;
            
            // Get selected property data
            const selectedPropData = loadedProperties.filter(p => selectedProperties.has(p.id));
            
            try {
                const addPromises = selectedPropData.map(async (prop) => {
                    const fields = prop.fields;
                    
                    // Check if well already exists for this property
                    const existingWell = loadedWells.find(w => 
                        w.fields.Section === fields.SEC &&
                        w.fields.Township === fields.TWN &&
                        w.fields.Range === fields.RNG &&
                        w.fields.County === fields.COUNTY
                    );
                    
                    if (existingWell) {
                        console.log(`Well already exists for ${fields.COUNTY} S${fields.SEC} T${fields.TWN} R${fields.RNG}`);
                        return null;
                    }
                    
                    // Create well data from property
                    const wellData = {
                        'Well Name': `${fields.COUNTY} S${fields.SEC} T${fields.TWN} R${fields.RNG}`,
                        'County': fields.COUNTY,
                        'Section': fields.SEC,
                        'Township': fields.TWN,
                        'Range': fields.RNG,
                        'API Number': '', // Will be filled when user adds it
                        'Email': currentUser.email
                    };
                    
                    const res = await fetch('/api/wells', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(wellData)
                    });
                    
                    if (!res.ok) throw new Error(`Failed to create well for ${wellData['Well Name']}`);
                    return await res.json();
                });
                
                const results = await Promise.all(addPromises);
                const created = results.filter(r => r !== null).length;
                const skipped = results.length - created;
                
                // Clear selection and reload data
                clearSelection('properties');
                await loadWells();
                
                let message = `Successfully created ${created} wells`;
                if (skipped > 0) message += ` (${skipped} already existed)`;
                showToast(message);
                
            } catch (err) {
                console.error('Bulk add to wells error:', err);
                showToast('Failed to add some properties as wells. Please try again.', 'error');
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/auth/me');
                if (!res.ok) { window.location.href = '/portal/login'; return; }
                currentUser = await res.json();
                document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                document.getElementById('planBadge').textContent = currentUser.plan || 'FREE';
                const limits = planConfigs[currentUser.plan] || { properties: 1, wells: 0 };
                document.getElementById('propLimit').textContent = limits.properties === Infinity ? '' : limits.properties;
                document.getElementById('wellLimit').textContent = limits.wells === Infinity ? '' : limits.wells;
                
                // Hide upgrade link for Enterprise users
                if (currentUser.plan === 'Enterprise' || currentUser.plan === 'Enterprise 500') {
                    document.getElementById('upgradeLink').style.display = 'none';
                }
                
                // Show export buttons for Professional and Enterprise users
                if (currentUser.plan === 'Professional' || currentUser.plan === 'Enterprise' || currentUser.plan === 'Enterprise 500') {
                    document.getElementById('exportPropertiesBtn').style.display = 'inline-flex';
                    document.getElementById('exportWellsBtn').style.display = 'inline-flex';
                }
                
                // Hide add/edit/delete buttons for Viewers
                if (currentUser.role === 'Viewer') {
                    // Hide property add/import buttons
                    document.getElementById('addPropertyBtn').style.display = 'none';
                    document.getElementById('bulkUploadBtn').style.display = 'none';
                    
                    // Hide well add/import buttons
                    document.getElementById('addWellBtn').style.display = 'none';
                    document.getElementById('bulkUploadWellsBtn').style.display = 'none';
                    
                    // Hide bulk action bars (delete buttons)
                    document.getElementById('propertiesBulkActionBar').style.display = 'none';
                    document.getElementById('wellsBulkActionBar').style.display = 'none';
                    document.getElementById('activityBulkActionBar').style.display = 'none';
                    
                    // Hide the dividers between action groups when buttons are hidden
                    document.querySelectorAll('.action-divider').forEach(d => d.style.display = 'none');
                }
                
                await loadAllData();

                // Initialize search/sort controls
                initWellsControls();
                initPropertiesControls();
            } catch { window.location.href = '/portal/login'; }

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentTab = tab.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(currentTab + '-tab').classList.add('active');
                    
                    // Load activity data when tab is selected (lazy load)
                    if (currentTab === 'activity') {
                        loadActivity();
                    }
                });
            });
            
            // Bulk selection event listeners
            document.addEventListener('change', (e) => {
                // Handle select all checkboxes
                if (e.target.id === 'selectAllProperties') {
                    selectAllItems('properties', e.target.checked);
                } else if (e.target.id === 'selectAllWells') {
                    selectAllItems('wells', e.target.checked);
                }
                // Handle individual checkboxes
                else if (e.target.classList.contains('property-checkbox')) {
                    togglePropertySelection(e.target.dataset.id, e.target.checked);
                } else if (e.target.classList.contains('well-checkbox')) {
                    toggleWellSelection(e.target.dataset.id, e.target.checked);
                }
            });
            
            // Add button event listeners inside DOMContentLoaded
            // Well Modal
            document.getElementById('addWellBtn').addEventListener('click', () => { 
                document.getElementById('addWellModal').style.display = 'flex'; 
            });
            
            // Bulk Upload Properties Modal
            const bulkUploadBtn = document.getElementById('bulkUploadBtn');
            console.log('Bulk upload button:', bulkUploadBtn);
            if (bulkUploadBtn) {
                bulkUploadBtn.addEventListener('click', () => {
                    console.log('Import button clicked');
                    openBulkUploadModal();
                });
            } else {
                console.error('Bulk upload button not found!');
            }
            
            // Bulk Upload Wells Modal
            document.getElementById('bulkUploadWellsBtn').addEventListener('click', () => {
                openBulkUploadWellsModal();
            });
            
            // Add Well Modal event listeners
            document.getElementById('addWellModal').addEventListener('click', e => { 
                if (e.target.id === 'addWellModal') closeWellModal(); 
            });
            
            document.getElementById('addWellForm').addEventListener('submit', async e => {
                e.preventDefault();
                const data = { 
                    apiNumber: document.getElementById('apiNumber').value.trim(),
                    notes: document.getElementById('wellNotes').value.trim()
                };
                
                try {
                    document.querySelector('.btn-submit').disabled = true;
                    const res = await fetch('/api/wells/track', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || 'Failed to add well');
                    }
                    
                    const result = await res.json();
                    closeWellModal();
                    showToast('Well added successfully');
                    loadWells();
                    loadActivityStats();
                } catch (err) {
                    showToast('Error: ' + err.message, 'error');
                } finally {
                    document.querySelector('.btn-submit').disabled = false;
                }
            });
        });
        
        async function loadAllData() {
        await Promise.all([loadProperties(), loadWells(), loadActivity(), loadActivityStats()]);
}

        async function loadProperties() {
            try {
                const res = await fetch('/api/properties');
                if (!res.ok) throw new Error('Failed to load');
                const properties = await res.json();
                loadedProperties = properties; // Store for filtering/sorting
                document.getElementById('propCount').textContent = properties.length;
                updateTotalCount();
                
                
                // Render the table (handles empty state internally)
                renderPropertiesTable();
            } catch { document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p style="color: var(--error);">Error loading. Refresh page.</p></div>'; }
        }
        
        // Generate a map link for a property section (centers on general area)
        function generateSectionMapLink(sec, twn, rng, county) {
            // Link to OCC GIS with a search query - this will show the general area
            // We can't pin-drop without coordinates, but we can search
            const searchTerm = encodeURIComponent(`${county || ''} ${sec} ${twn} ${rng}`.trim());
            return `https://gis.occ.ok.gov/portal/apps/webappviewer/index.html?id=ba9b8612132f4106be6e3553dc0b827b`;
        }

        async function loadWells() {
            try {
                const res = await fetch('/api/wells');
                if (!res.ok) throw new Error('Failed to load');
                const wells = await res.json();
                loadedWells = wells; // Store for filtering/sorting
                document.getElementById('wellCount').textContent = wells.length;
                updateTotalCount();
                
                
                // Render the table (handles empty state internally)
                renderWellsTable();
            } catch { document.getElementById('wellsContent').innerHTML = '<div class="empty-state"><p style="color: var(--error);">Error loading. Refresh page.</p></div>'; }
        }

        // Properties Search & Sort State
        let propertiesSearchTerm = '';
        let propertiesSortBy = 'legal-asc';

        // Initialize Properties Controls (call this after user loads)
        function initPropertiesControls() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Show/hide controls based on plan
            document.getElementById('propertiesControls').style.display = hasSearch ? 'flex' : 'none';
            
            if (!hasSearch) return;
            
            // Search input handler
            document.getElementById('propertiesSearch').addEventListener('input', (e) => {
                propertiesSearchTerm = e.target.value.toLowerCase().trim();
                renderPropertiesTable();
            });
            
            // Sort select handler
            document.getElementById('propertiesSort').addEventListener('change', (e) => {
                propertiesSortBy = e.target.value;
                renderPropertiesTable();
            });
        }

        // Filter properties based on search term
        function filterProperties(properties) {
            if (!propertiesSearchTerm) return properties;
            
            return properties.filter(p => {
                const f = p.fields;
                const searchable = [
                    f.COUNTY || '',
                    f.SEC || '',
                    f.TWN || '',
                    f.RNG || '',
                    f.MERIDIAN || '',
                    f.Notes || ''
                ].join(' ').toLowerCase();
                
                return searchable.includes(propertiesSearchTerm);
            });
        }

        // Sort properties based on selected option
        function sortProperties(properties) {
            const [field, direction] = propertiesSortBy.split('-');
            const multiplier = direction === 'asc' ? 1 : -1;
            
            return [...properties].sort((a, b) => {
                if (field === 'legal') {
                    // Legal Description: County  Township  Range  Section
                    const aCounty = (a.fields.COUNTY || '').toLowerCase();
                    const bCounty = (b.fields.COUNTY || '').toLowerCase();
                    if (aCounty !== bCounty) {
                        return aCounty < bCounty ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse township (e.g., "T24N" -> { num: 24, dir: "N" })
                    const parseTownship = (twp) => {
                        const match = (twp || '').match(/T?(\d+)([NS])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aTwp = parseTownship(a.fields.TWN);
                    const bTwp = parseTownship(b.fields.TWN);
                    if (aTwp.num !== bTwp.num) {
                        return aTwp.num < bTwp.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aTwp.dir !== bTwp.dir) {
                        return aTwp.dir < bTwp.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse range (e.g., "R10W" -> { num: 10, dir: "W" })
                    const parseRange = (rng) => {
                        const match = (rng || '').match(/R?(\d+)([EW])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aRng = parseRange(a.fields.RNG);
                    const bRng = parseRange(b.fields.RNG);
                    if (aRng.num !== bRng.num) {
                        return aRng.num < bRng.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aRng.dir !== bRng.dir) {
                        return aRng.dir < bRng.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Section (numeric)
                    const aSection = parseInt(a.fields.SEC) || 0;
                    const bSection = parseInt(b.fields.SEC) || 0;
                    return aSection < bSection ? -1 * multiplier : (aSection > bSection ? 1 * multiplier : 0);
                    
                } else if (field === 'date') {
                    // Date Added - use createdTime from Airtable
                    const aDate = new Date(a.createdTime || 0);
                    const bDate = new Date(b.createdTime || 0);
                    return aDate < bDate ? -1 * multiplier : (aDate > bDate ? 1 * multiplier : 0);
                    
                } else if (field === 'acres') {
                    // Total Acres - sum of RI and WI acres
                    const aTotal = (parseFloat(a.fields['RI Acres'] || 0) + parseFloat(a.fields['WI Acres'] || 0));
                    const bTotal = (parseFloat(b.fields['RI Acres'] || 0) + parseFloat(b.fields['WI Acres'] || 0));
                    return aTotal < bTotal ? -1 * multiplier : (aTotal > bTotal ? 1 * multiplier : 0);
                }
                
                return 0;
            });
        }

        // Render the properties table (extracted from loadProperties)
        function renderPropertiesTable() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Apply filter and sort
            let displayProperties = loadedProperties;
            if (hasSearch) {
                displayProperties = filterProperties(loadedProperties);
                displayProperties = sortProperties(displayProperties);
                
                // Update results count
                const countEl = document.getElementById('propertiesResultsCount');
                if (propertiesSearchTerm) {
                    countEl.textContent = `${displayProperties.length} of ${loadedProperties.length} properties`;
                } else {
                    countEl.textContent = `${loadedProperties.length} properties`;
                }
            }
            
            if (displayProperties.length === 0 && loadedProperties.length > 0) {
                // No search results
                document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p>No properties match your search.</p></div>';
                return;
            }
            
            if (displayProperties.length === 0) {
                document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p>No properties yet. Add your first property to start monitoring.</p></div>';
                return;
            }
            
            // Build table with conditional checkbox column for non-Viewers
            const isViewer = currentUser?.role === 'Viewer';
            let html = '<table class="data-table"><colgroup>';
            if (!isViewer) html += '<col class="col-select">';
            html += '<col class="col-prop-county"><col class="col-prop-legal"><col class="col-prop-group"><col class="col-prop-acres"><col class="col-prop-notes"><col class="col-actions"></colgroup><thead><tr>';
            if (!isViewer) html += '<th class="bulk-only"><input type="checkbox" id="selectAllProperties" title="Select all"></th>';
            html += '<th>County</th><th>Legal</th><th class="col-prop-group">Group</th><th style="text-align: right;">Total Acres</th><th class="col-prop-notes-cell">Notes</th><th style="text-align: right;">Actions</th></tr></thead><tbody>';
            
            displayProperties.forEach(p => {
                const f = p.fields;
                const str = `T${f.TWN} R${f.RNG} ${f.SEC}`;
                const riAcres = parseFloat(f['RI Acres'] || 0);
                const wiAcres = parseFloat(f['WI Acres'] || 0);
                const totalAcres = riAcres + wiAcres;
                const acresDisplay = totalAcres > 0 ? totalAcres.toFixed(2) : '';
                const notesText = f.Notes ? escapeHtml(f.Notes.substring(0, 80)) + (f.Notes.length > 80 ? '...' : '') : '';
                const notes = notesText ? `<span style="color: var(--slate-blue); font-size: 13px;">${notesText}</span>` : '<em style="color: #A0AEC0;"></em>';
                const group = f.Group ? `<span style="color: var(--oil-navy); font-size: 12px; background: #F1F5F9; padding: 2px 8px; border-radius: 12px;">${escapeHtml(f.Group)}</span>` : '<em style="color: #A0AEC0;"></em>';
                
                html += `<tr onclick="openPropertyDetails('${p.id}')" style="cursor: pointer;">`;
                if (!isViewer) {
                    html += `<td class="bulk-only" onclick="event.stopPropagation()"><input type="checkbox" class="property-checkbox" data-id="${p.id}"></td>`;
                }
                html += `<td>${escapeHtml(cleanCountyDisplay(f.COUNTY)) || ''}</td>
                    <td><strong>${str}</strong></td>
                    <td class="col-prop-group">${group}</td>
                    <td style="text-align: right;">${acresDisplay}</td>
                    <td title="${f.Notes ? escapeHtml(f.Notes) : ''}" class="col-prop-notes-cell">${notes}</td>
                    <td onclick="event.stopPropagation()">
                        <button class="btn-map-link" onclick="viewOnMap('${p.id}')" title="View on Map"> Map</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('propertiesContent').innerHTML = html;
            
            // Check if any properties have groups and show/hide Group column
            const hasGroups = displayProperties.some(p => p.fields.Group);
            const propertiesTable = document.querySelector('#propertiesContent .data-table');
            if (hasGroups) {
                propertiesTable.classList.add('has-groups');
            } else {
                propertiesTable.classList.remove('has-groups');
            }
            
            // Update bulk selection state after table render
            updateSelectAllState('properties');
            updateBulkActionVisibility();
        }

        // Wells Search & Sort State
        let wellsSearchTerm = '';
        let wellsSortBy = 'legal-asc';

        // Initialize Wells Controls (call this after user loads)
        function initWellsControls() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Show/hide controls based on plan
            document.getElementById('wellsControls').style.display = hasSearch ? 'flex' : 'none';
            
            if (!hasSearch) return;
            
            // Search input handler
            document.getElementById('wellsSearch').addEventListener('input', (e) => {
                wellsSearchTerm = e.target.value.toLowerCase().trim();
                renderWellsTable();
            });
            
            // Sort select handler
            document.getElementById('wellsSort').addEventListener('change', (e) => {
                wellsSortBy = e.target.value;
                renderWellsTable();
            });
        }

        // Filter wells based on search term
        function filterWells(wells) {
            if (!wellsSearchTerm) return wells;
            
            return wells.filter(w => {
                const f = w.fields;
                const searchable = [
                    f['Well Name'] || '',
                    f['Operator'] || '',
                    f['API Number'] || '',
                    f['County'] || ''
                ].join(' ').toLowerCase();
                
                return searchable.includes(wellsSearchTerm);
            });
        }

        // Sort wells based on selected option
        function sortWells(wells) {
            const [field, direction] = wellsSortBy.split('-');
            const multiplier = direction === 'asc' ? 1 : -1;
            
            return [...wells].sort((a, b) => {
                if (field === 'legal') {
                    // Legal Description: County  Township  Range  Section
                    const aCounty = (a.fields['County'] || '').toLowerCase();
                    const bCounty = (b.fields['County'] || '').toLowerCase();
                    if (aCounty !== bCounty) {
                        return aCounty < bCounty ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse township (e.g., "T24N" -> { num: 24, dir: "N" })
                    const parseTownship = (twp) => {
                        const match = (twp || '').match(/T?(\d+)([NS])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aTwp = parseTownship(a.fields['Township']);
                    const bTwp = parseTownship(b.fields['Township']);
                    if (aTwp.num !== bTwp.num) {
                        return aTwp.num < bTwp.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aTwp.dir !== bTwp.dir) {
                        return aTwp.dir < bTwp.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse range (e.g., "R10W" -> { num: 10, dir: "W" })
                    const parseRange = (rng) => {
                        const match = (rng || '').match(/R?(\d+)([EW])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aRng = parseRange(a.fields['Range']);
                    const bRng = parseRange(b.fields['Range']);
                    if (aRng.num !== bRng.num) {
                        return aRng.num < bRng.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aRng.dir !== bRng.dir) {
                        return aRng.dir < bRng.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Section (numeric)
                    const aSection = parseInt(a.fields['Section']) || 0;
                    const bSection = parseInt(b.fields['Section']) || 0;
                    return aSection < bSection ? -1 * multiplier : (aSection > bSection ? 1 * multiplier : 0);
                    
                } else if (field === 'date') {
                    // Date Added - use createdTime from Airtable
                    const aDate = new Date(a.createdTime || 0);
                    const bDate = new Date(b.createdTime || 0);
                    return aDate < bDate ? -1 * multiplier : (aDate > bDate ? 1 * multiplier : 0);
                    
                } else if (field === 'name') {
                    // Well Name
                    const aVal = (a.fields['Well Name'] || '').toLowerCase();
                    const bVal = (b.fields['Well Name'] || '').toLowerCase();
                    return aVal < bVal ? -1 * multiplier : (aVal > bVal ? 1 * multiplier : 0);
                    
                } else if (field === 'operator') {
                    // Operator
                    const aVal = (a.fields['Operator'] || '').toLowerCase();
                    const bVal = (b.fields['Operator'] || '').toLowerCase();
                    return aVal < bVal ? -1 * multiplier : (aVal > bVal ? 1 * multiplier : 0);
                }
                
                return 0;
            });
        }

        // Setup event delegation for production hover helpers
        function setupProductionHoverHelpers() {
            // Remove any existing event listeners to prevent duplicates
            document.querySelectorAll('.production-accordion-floating .hover-helper').forEach(el => {
                el.removeEventListener('mouseenter', handleProductionHover);
                el.removeEventListener('mouseleave', handleProductionHoverOut);
                el.removeEventListener('click', handleProductionClick);
            });
            
            // Add event listeners to all current hover helper elements
            document.querySelectorAll('.production-accordion-floating .hover-helper').forEach(el => {
                // Only add hover events on desktop
                if (window.innerWidth > 768) {
                    el.addEventListener('mouseenter', handleProductionHover);
                    el.addEventListener('mouseleave', handleProductionHoverOut);
                }
                // Always add click for mobile (but handler checks screen size)
                el.addEventListener('click', handleProductionClick);
            });
        }
        
        // Handle production hover helper mouseenter
        function handleProductionHover(e) {
            // Don't show desktop tooltip on mobile
            if (window.innerWidth <= 768) {
                return;
            }
            
            const helpKey = e.target.getAttribute('data-help');
            const helpText = getProductionHelpText(helpKey);
            
            // Debug logging
            console.log('Production hover - helpKey:', helpKey);
            console.log('Production hover - helpText:', helpText);
            console.log('Production hover - title:', getProductionTermTitle(helpKey));
            
            if (helpKey && helpText) {
                // Create and show tooltip
                const tooltip = document.createElement('div');
                tooltip.id = 'production-tooltip';
                tooltip.innerHTML = `<strong>${getProductionTermTitle(helpKey)}</strong><br>${helpText}`;
                tooltip.style.cssText = `
                    position: absolute;
                    background: var(--oil-navy);
                    color: white;
                    padding: 12px;
                    border-radius: 6px;
                    font-size: 13px;
                    line-height: 1.4;
                    max-width: 280px;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    pointer-events: none;
                `;
                
                // Position tooltip
                document.body.appendChild(tooltip);
                const rect = e.target.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                
                // Position above the element, centered
                let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                let top = rect.top - tooltipRect.height - 8;
                
                // Adjust if tooltip would go off screen
                if (left < 8) left = 8;
                if (left + tooltipRect.width > window.innerWidth - 8) {
                    left = window.innerWidth - tooltipRect.width - 8;
                }
                if (top < 8) {
                    top = rect.bottom + 8; // Show below instead
                }
                
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
                
                // Add highlight to the element
                e.target.style.backgroundColor = '#E0F2FE';
            }
        }
        
        // Handle production hover helper mouseleave
        function handleProductionHoverOut(e) {
            // Don't process hover events on mobile
            if (window.innerWidth <= 768) {
                return;
            }
            
            // Remove tooltip
            const tooltip = document.getElementById('production-tooltip');
            if (tooltip) {
                tooltip.remove();
            }
            // Remove highlight
            e.target.style.backgroundColor = '';
        }
        
        // Handle production helper click (mobile)
        function handleProductionClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Aggressive cleanup of any desktop tooltips
            setTimeout(() => {
                const tooltips = document.querySelectorAll('#production-tooltip, [id*="tooltip"]');
                tooltips.forEach(tooltip => tooltip.remove());
            }, 10);
            
            // Find the parent production-term container
            const productionTerm = e.target.closest('.production-term');
            if (!productionTerm) return;
            
            const explanation = productionTerm.querySelector('.production-explanation');
            if (!explanation) return;
            
            // Check if we're on mobile (screen width check)
            if (window.innerWidth > 768) {
                return; // Don't handle clicks on desktop
            }
            
            // Toggle expanded state
            const isExpanded = explanation.classList.contains('expanded');
            
            // Close any other open explanations first
            document.querySelectorAll('.production-explanation.expanded').forEach(exp => {
                exp.classList.remove('expanded');
                exp.closest('.production-term').classList.remove('production-term-expanded');
            });
            
            if (!isExpanded) {
                explanation.classList.add('expanded');
                productionTerm.classList.add('production-term-expanded');
            }
        }
        
        // Get help text for production terms
        function getProductionHelpText(helpKey) {
            const helpTexts = {
                "ipGas": "Initial Production Gas - 24-hour flow test rate when well first came online",
                "ipOil": "Initial Production Oil - 24-hour flow test rate when well first came online", 
                "ipWater": "Initial Production Water - 24-hour flow test rate when well first came online",
                "lateral": "Lateral Length - horizontal portion of wellbore drilled through the formation",
                "formation": "Geological Formation - the specific rock layer being produced for oil/gas",
                "formationDepth": "Formation Depth - vertical depth to the producing geological formation",
                "spudDate": "Spud Date - when drilling operations began at this well location",
                "completedDate": "Completion Date - when well construction finished and production equipment was installed",
                "firstProdDate": "First Production Date - when commercial oil/gas production began",
                "multiSection": "Multi-Section Horizontal - wellbore crosses multiple land sections for maximum formation contact"
            };
            return helpTexts[helpKey] || null;
        }

        // Get friendly title for production terms
        function getProductionTermTitle(helpKey) {
            const titles = {
                "ipGas": "Initial Production Gas",
                "ipOil": "Initial Production Oil", 
                "ipWater": "Initial Production Water",
                "lateral": "Lateral Length",
                "formation": "Geological Formation",
                "formationDepth": "Formation Depth",
                "spudDate": "Spud Date",
                "completedDate": "Completion Date",
                "firstProdDate": "First Production Date",
                "multiSection": "Multi-Section Horizontal"
            };
            return titles[helpKey] || helpKey;
        }

        // Generate expanded well card HTML
        function generateExpandedWellCard(w) {
            const f = w.fields;
            
            // Helper functions for formatting
            const formatDate = (dateStr) => {
                if (!dateStr || dateStr === '') return null;
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' });
                } catch {
                    return null;
                }
            };
            
            const formatNumber = (num) => {
                if (!num) return null;
                return Number(num).toLocaleString();
            };
            
            // Prepare data
            const wellName = f['Well Name'] || 'Unknown Well';
            const apiNumber = f['API Number'] || '';
            const operator = f['Operator'] || '';
            const operatorPhone = f['Operator Phone'] || '';
            const contactPerson = f['Contact Name'] || f['Contact Person'] || '';
            const county = cleanCountyDisplay(f['County']) || '';
            const section = f['Section'] || '';
            const township = f['Township'] || '';
            const range = f['Range'] || '';
            const location = (section && township && range) ? `T${township} R${range} ${section}` : '';
            
            const completionDate = formatDate(f['Completion Date']);
            const firstProdDate = formatDate(f['First Production Date']);
            
            const status = f['Well Status'] || f['OCC Status'] || '';
            const wellType = f['Well Type'] || '';
            const formationName = f['Formation Name'] || '';
            const formationDepth = f['Formation Depth'];
            const formationDisplay = formationName && formationDepth 
                ? `${formationName} @ ${formatNumber(formationDepth)} ft`
                : formationName || '';
            
            const ipGas = f['IP Gas (MCF/day)'] ? formatNumber(f['IP Gas (MCF/day)']) : null;
            const ipOil = f['IP Oil (BBL/day)'] ? formatNumber(f['IP Oil (BBL/day)']) : null;
            
            const notes = f['Notes'] || '';
            
            return `
                <div class="well-expanded-card" style="padding: 20px; background: #fff; border: 1px solid #E5E7EB; border-radius: 8px; margin: 10px;">
                    <!-- Header (no well name repetition) -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="color: #6B7280; font-size: 12px; font-weight: 600; letter-spacing: 0.5px;">WELL DETAILS</div>
                        ${completionDate ? `<span style="background: var(--red-dirt); color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">Completed: ${completionDate}</span>` : ''}
                    </div>
                    
                    <!-- Formation & Production Info -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 0 0 16px 0;">
                    
                    <!-- Info Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0;">
                        <div>
                            <div style="color: #6B7280; font-size: 12px; margin-bottom: 4px;">STATUS</div>
                            <div style="font-size: 14px; font-weight: 600; color: ${status === 'Active' || status === 'AC' ? '#059669' : 'var(--oil-navy)'};">${status}</div>
                        </div>
                        <div>
                            <div style="color: #6B7280; font-size: 12px; margin-bottom: 4px;">FORMATION</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--oil-navy);">${formationDisplay}</div>
                        </div>
                        <div>
                            <div style="color: #6B7280; font-size: 12px; margin-bottom: 4px;">WELL TYPE</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--oil-navy);">${wellType}</div>
                        </div>
                        <div>
                            <div style="color: #6B7280; font-size: 12px; margin-bottom: 4px;">FIRST PRODUCTION</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--oil-navy);">${firstProdDate || ''}</div>
                        </div>
                    </div>
                    
                    <!-- Initial Production -->
                    ${(ipGas || ipOil) ? `
                    <div style="padding: 16px 0; border-bottom: 1px solid #E5E7EB;">
                        <div style="color: #6B7280; font-size: 12px; margin-bottom: 8px;">INITIAL PRODUCTION</div>
                        <div style="font-size: 14px; color: var(--oil-navy);">
                            ${ipGas ? `Gas: <strong>${ipGas} MCF/day</strong>` : ''}
                            ${ipGas && ipOil ? '  ' : ''}
                            ${ipOil ? `Oil: <strong>${ipOil} BBL/day</strong>` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Notes Section -->
                    <div style="padding: 16px 0; border-bottom: 1px solid #E5E7EB;">
                        <div style="color: #6B7280; font-size: 12px; margin-bottom: 8px;">NOTES</div>
                        <textarea 
                            id="well-notes-${w.id}" 
                            style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #E5E7EB; border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical;" 
                            placeholder="Add notes about this well..."
                            onchange="updateWellNotes('${w.id}')"
                        >${escapeHtml(notes)}</textarea>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            ${f['OCC Map Link'] && f['OCC Map Link'] !== '#' ? `<a href="${f['OCC Map Link']}" target="_blank" class="details-btn primary"> OCC Map</a>` : ''}
                            ${apiNumber ? `
                                <div class="occ-warning" style="display: inline-flex; align-items: center;">
                                    <a href="https://public.occ.ok.gov/OGCDWellRecords/Search.aspx?searchcommand=${encodeURIComponent(`{[OG Well Records]:[API Number]="${apiNumber}*"}`)}&cr=1" target="_blank" class="details-btn"> Well Records</a>
                                    <span class="occ-warning-icon">!</span>
                                    <div class="occ-tooltip">
                                        <strong>OCC Website Note:</strong> If you see a cookie error on OCC's site, try signing out of OCC first or open this link in an incognito/private window.
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <button type="button" class="btn-submit" onclick="saveWellNotes('${w.id}')" style="padding: 8px 20px;">Save Note</button>
                    </div>
                </div>`;
        }

        // Render the wells table (extracted from loadWells)
        function renderWellsTable() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Apply filter and sort
            let displayWells = loadedWells;
            if (hasSearch) {
                displayWells = filterWells(loadedWells);
                displayWells = sortWells(displayWells);
                
                // Update results count
                const countEl = document.getElementById('wellsResultsCount');
                if (wellsSearchTerm) {
                    countEl.textContent = `${displayWells.length} of ${loadedWells.length} wells`;
                } else {
                    countEl.textContent = `${loadedWells.length} wells`;
                }
            }
            
            if (displayWells.length === 0 && loadedWells.length > 0) {
                // No search results
                document.getElementById('wellsContent').innerHTML = '<div class="empty-state"><p>No wells match your search.</p></div>';
                return;
            }
            
            if (displayWells.length === 0) {
                document.getElementById('wellsContent').innerHTML = '<div class="empty-state"><p>No wells yet. Add your first well API to start monitoring.</p></div>';
                return;
            }
            
            // Clean table that opens modal on row click
            const isViewer = currentUser?.role === 'Viewer';
            let html = '<table class="data-table wells-table"><colgroup>';
            if (!isViewer) html += '<col class="col-select">';
            html += '<col class="col-well-info"><col class="col-well-operator"></colgroup><thead><tr>';
            if (!isViewer) html += '<th class="bulk-only"><input type="checkbox" id="selectAllWells" title="Select all"></th>';
            html += '<th>Well Information</th><th>Operator Contact</th></tr></thead><tbody>';
            
            displayWells.forEach(w => {
                const f = w.fields;
                const wellName = f['Well Name'] ? escapeHtml(f['Well Name']) : '<em style="color: #A0AEC0;">Unknown</em>';
                const operator = f['Operator'] ? escapeHtml(f['Operator']) : '<em style="color: #A0AEC0;"></em>';
                const operatorPhone = f['Operator Phone'] || '';
                const contactPerson = f['Contact Name'] || f['Contact Person'] || '';
                const apiNumber = f['API Number'] || '';
                const status = f['Well Status'] || f['OCC Status'] || '';
                const wellType = f['Well Type'] || '';
                
                // Format location (county + legal)
                const county = cleanCountyDisplay(f['County']) || '';
                const section = f['Section'] || '';
                const township = f['Township'] || '';
                const range = f['Range'] || '';
                let locationDisplay = '';
                if (county) {
                    locationDisplay = county;
                    if (section && township && range) {
                        locationDisplay += `  ${section}-${township}-${range}`;
                    }
                }
                
                // Format operator contact for compact view (with bold operator name)
                let operatorContactDisplay = `<strong>${operator}</strong>`;
                if (operatorPhone || contactPerson) {
                    const contactParts = [];
                    if (operatorPhone) {
                        // Strip existing formatting before re-formatting to avoid double parentheses
                        const cleanPhone = operatorPhone.replace(/[^0-9]/g, '');
                        contactParts.push(`${formatPhoneNumber(cleanPhone)}`);
                    }
                    if (contactPerson) contactParts.push(`${contactPerson}`);
                    if (contactParts.length > 0) {
                        // Don't wrap in parentheses since phone already has them
                        operatorContactDisplay += ` ${contactParts.join('  ')}`;
                    }
                }
                
                        // All wells now open modal on click
                
                // Clean row that opens modal on click
                html += `<tr class="well-row" onclick="openWellDetailsModal('${w.id}')" style="cursor: pointer;">`;
                if (!isViewer) {
                    html += `<td class="bulk-only" onclick="event.stopPropagation()"><input type="checkbox" class="well-checkbox" data-id="${w.id}"></td>`;
                }
                html += `<td class="well-info-cell">
                        <div class="well-name-line">
                            <strong>${wellName}</strong>
                        </div>
                        <div class="well-details-line">
                            ${apiNumber ? `<span class="well-api">${apiNumber}</span>  ` : ''}
                            <span class="well-status ${status === 'Active' || status === 'AC' ? 'status-active' : ''}">${status}</span>
                            ${locationDisplay ? `  <span class="well-location">${locationDisplay}</span>` : ''}
                        </div>
                    </td>
                    <td class="operator-contact-cell">${operatorContactDisplay}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // Insert table with embedded accordions
            document.getElementById('wellsContent').innerHTML = html;
            
            // Add event delegation for production hover helpers (dynamically created elements)
            setupProductionHoverHelpers();
            
            // Update bulk selection state after table render
            updateSelectAllState('wells');
            updateBulkActionVisibility();
        }

        function updateTotalCount() {
            // No longer needed - separate limits shown
        }
        
        async function loadActivityStats() {
            try {
                const res = await fetch('/api/activity/stats');
                if (!res.ok) return;
                const stats = await res.json();
                
                // Format last alert date
                if (stats.lastAlert) {
                    const date = new Date(stats.lastAlert);
                    const now = new Date();
                    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                    
                    let lastAlertText;
                    if (diffDays === 0) lastAlertText = 'Today';
                    else if (diffDays === 1) lastAlertText = 'Yesterday';
                    else if (diffDays < 7) lastAlertText = diffDays + ' days ago';
                    else if (diffDays < 30) lastAlertText = Math.floor(diffDays / 7) + ' weeks ago';
                    else lastAlertText = date.toLocaleDateString();
                    
                    document.getElementById('statLastAlert').textContent = lastAlertText;
                } else {
                    document.getElementById('statLastAlert').textContent = 'No alerts yet';
                }
                
                document.getElementById('statThisMonth').textContent = stats.thisMonth;
                document.getElementById('statThisYear').textContent = stats.thisYear;
            } catch (err) {
                console.error('Failed to load activity stats:', err);
            }
        }
        
        async function loadActivity() {
            try {
                const res = await fetch('/api/activity');
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();
                const records = data.records || [];
                const recordLimit = data.recordLimit || 5;
                const plan = data.plan || 'Free';
                
                if (records.length === 0) {
                    let msg = `<div class="empty-state"><p>No activity recorded yet.</p><p style="font-size: 13px; color: var(--slate-blue);">When wells on your properties have status changes, they'll appear here.</p></div>`;
                    document.getElementById('activityContent').innerHTML = msg;
                    return;
                }
                
                let html = '<div class="activity-list">';
                
                // Show limit notice for lower tiers
                if (recordLimit < 100 && plan !== 'Professional' && plan !== 'Enterprise') {
                    html += `<div class="activity-limit-notice">Showing last ${recordLimit} alerts. <a href="/portal/upgrade">Upgrade</a> for more history.</div>`;
                }
                
                records.forEach(r => {
                    const f = r.fields;
                    let activityType = f['Activity Type'] || 'Status Change';
                    // Make "New Permit" more specific
                    if (activityType === 'New Permit') {
                        activityType = 'New Drilling Permit';
                    }
                    const alertLevel = f['Alert Level'] || 'YOUR PROPERTY';
                    
                    // Icon and class based on activity type
                    let icon = '';
                    let iconClass = 'status';
                    if (activityType.includes('Permit')) { icon = ''; iconClass = 'permit'; }
                    else if (activityType.includes('Drilling')) { icon = ''; iconClass = 'drilling'; }
                    else if (activityType.includes('Completed')) { icon = ''; iconClass = 'completed'; }
                    else if (activityType.includes('Transfer')) { icon = ''; iconClass = 'transfer'; }
                    else if (activityType.includes('Abandoned') || activityType.includes('Plugged')) { icon = ''; iconClass = 'abandoned'; }
                    
                    // Alert level class
                    let levelClass = 'property';
                    if (alertLevel.includes('ADJACENT')) levelClass = 'adjacent';
                    else if (alertLevel.includes('TRACKED')) levelClass = 'tracked';
                    
                    // Format date
                    const date = new Date(f['Detected At']);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    
                    // Build change text
                    let changeText = '';
                    if (f['Previous Value'] && f['New Value']) {
                        if (activityType.includes('Transfer')) {
                            changeText = `${f['Previous Value']}  ${f['New Value']}`;
                        } else {
                            changeText = `Status: ${f['Previous Value']}  ${f['New Value']}`;
                        }
                    }
                    
                    // Build action buttons
                    const occLink = f['OCC Link'];
                    const mapLink = f['OCC Map Link'] || f['Map Link']; // Support both field names
                    const apiNumber = f['API Number'];
                    
                    // Check if this activity type should have a Track Well button
                    const shouldShowTrackButton = apiNumber && (
                        activityType === 'New Permit' ||
                        activityType === 'New Drilling Permit' ||
                        activityType === 'Well Completed' ||
                        activityType.toLowerCase().includes('rework')
                    );
                    
                    // Debug logging
                    if (apiNumber && activityType === 'Well Completed') {
                        console.log('Well Completed activity:', {
                            activityType,
                            apiNumber,
                            shouldShowTrackButton,
                            occLink,
                            mapLink
                        });
                    }
                    
                    let actionsHtml = '<div class="activity-actions">';
                    // OCC Filing first
                    if (occLink) {
                        // Remove &cr=1 from URLs to fix Laserfiche cookie error
                        const fixedOccLink = occLink.replace(/&cr=1/g, '');
                        actionsHtml += `<a href="${escapeHtml(fixedOccLink)}" target="_blank" class="activity-btn">OCC Filing</a>`;
                    }
                    // OCC Map second  
                    if (mapLink) {
                        actionsHtml += `<a href="${escapeHtml(mapLink)}" target="_blank" class="activity-btn">OCC Map</a>`;
                    }
                    // Track Well last
                    if (shouldShowTrackButton) {
                        // Check if well is already tracked
                        const isTracked = loadedWells.some(w => w.fields['API Number'] === apiNumber);
                        if (isTracked) {
                            actionsHtml += `<button class="activity-btn track-btn" disabled style="background: #22C55E; color: white; border-color: #22C55E; cursor: default;">Added </button>`;
                        } else {
                            actionsHtml += `<button class="activity-btn track-btn" onclick="trackWellFromActivity('${escapeHtml(apiNumber)}', '${escapeHtml(f['Well Name'] || '')}', '${escapeHtml(occLink || '')}', this)">+ Track Well</button>`;
                        }
                    }
                    actionsHtml += '</div>';
                    
                    html += `
                        <div class="activity-item">
                            <div class="activity-checkbox" onclick="event.stopPropagation()">
                                <input type="checkbox" class="activity-checkbox-input" data-id="${r.id}">
                            </div>
                            <div class="activity-icon ${iconClass}">${icon}</div>
                            <div class="activity-details">
                                <div class="activity-header">
                                    <span class="activity-type">${escapeHtml(activityType)}</span>
                                    <span class="activity-level ${levelClass}">${escapeHtml(alertLevel.replace('_', ' '))}</span>
                                </div>
                                <div class="activity-well">${escapeHtml(f['Well Name']) || 'Unknown Well'}</div>
                                <div class="activity-meta">${escapeHtml(f['Operator']) || ''}  ${formatActivityLocation(f['Section-Township-Range'])}  ${escapeHtml(cleanCountyDisplay(f['County'])) || ''}</div>
                                ${changeText ? `<div class="activity-change">${escapeHtml(changeText)}</div>` : ''}
                                ${(occLink || mapLink) ? actionsHtml : ''}
                            </div>
                            <div class="activity-date">${dateStr}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('activityContent').innerHTML = html;
                
                // Add event listeners for activity checkboxes
                document.querySelectorAll('.activity-checkbox-input').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const activityId = this.getAttribute('data-id');
                        if (this.checked) {
                            selectedActivity.add(activityId);
                        } else {
                            selectedActivity.delete(activityId);
                        }
                        updateBulkActionVisibility();
                    });
                });
                
            } catch (err) {
                document.getElementById('activityContent').innerHTML = '<div class="empty-state"><p style="color: var(--error);">Error loading activity. Refresh page.</p></div>';
            }
        }
        
        // Property Modal
        document.getElementById('addPropertyBtn').addEventListener('click', () => { 
            document.getElementById('addPropertyModal').style.display = 'flex'; 
        });
        
        function closePropertyModal() { 
            document.getElementById('addPropertyModal').style.display = 'none'; 
            document.getElementById('addPropertyForm').reset(); 
            document.getElementById('propertyNotes').value = ''; // Clear notes field
            document.getElementById('addPropertyRIAcres').value = '';
            document.getElementById('addPropertyWIAcres').value = '';
            document.getElementById('addPropertyTotalAcres').textContent = '0';
            document.getElementById('addPropertyAcreageBadge').style.display = 'none';
            document.getElementById('addPropertyLocation').style.opacity = '0';
        }
        
        // Auto-set meridian based on county
        function autoSetMeridian(county) {
            const panhandleCounties = ['Cimarron', 'Texas', 'Beaver'];
            const meridianSelect = document.getElementById('meridian');
            
            if (panhandleCounties.includes(county)) {
                meridianSelect.value = 'CM';
            } else if (county) { // Only set IM if a county is selected
                meridianSelect.value = 'IM';
            }
        }
        window.autoSetMeridian = autoSetMeridian; // Make available globally
        
        // Update location display in Add Property header
        function updateLocationDisplay() {
            const county = document.getElementById('county').value;
            const section = document.getElementById('section').value;
            const township = document.getElementById('township').value.toUpperCase();
            const range = document.getElementById('range').value.toUpperCase();
            const locationDiv = document.getElementById('addPropertyLocation');
            
            if (county && section && township && range) {
                locationDiv.textContent = `${county} County  S${section} T${township} R${range}`;
                locationDiv.style.opacity = '1';
            } else if (county) {
                locationDiv.textContent = `${county} County`;
                locationDiv.style.opacity = '0.8';
            } else {
                locationDiv.style.opacity = '0';
            }
        }
        window.updateLocationDisplay = updateLocationDisplay;
        
        // Update total acres for Add Property
        function updateAddPropertyTotalAcres() {
            const riAcres = parseFloat(document.getElementById('addPropertyRIAcres').value) || 0;
            const wiAcres = parseFloat(document.getElementById('addPropertyWIAcres').value) || 0;
            const total = riAcres + wiAcres;
            
            document.getElementById('addPropertyTotalAcres').textContent = total.toFixed(2);
            
            // Update the badge in header
            const badge = document.getElementById('addPropertyAcreageBadge');
            if (total > 0) {
                badge.textContent = `${total.toFixed(2)} acres`;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        window.updateAddPropertyTotalAcres = updateAddPropertyTotalAcres;
        
        document.getElementById('addPropertyModal').addEventListener('click', e => { 
            if (e.target.id === 'addPropertyModal') closePropertyModal(); 
        });
        
        document.getElementById('addPropertyForm').addEventListener('submit', async e => {
            e.preventDefault();
            
            // Get form values
            const section = document.getElementById('section').value.trim();
            const township = document.getElementById('township').value.trim().toUpperCase();
            const range = document.getElementById('range').value.trim().toUpperCase();
            const notes = document.getElementById('propertyNotes').value.trim();
            
            // Additional validation
            if (!/^[0-9]{1,2}$/.test(section) || parseInt(section) < 1 || parseInt(section) > 36) {
                showToast('Section must be a number between 1 and 36', 'error');
                return;
            }
            
            if (!/^[0-9]{1,2}[NS]$/.test(township)) {
                showToast('Township format: number + N or S (e.g., 12N)', 'error');
                return;
            }
            
            if (!/^[0-9]{1,2}[WE]$/.test(range)) {
                showToast('Range format: number + W or E (e.g., 4W)', 'error');
                return;
            }
            
            const data = { 
                COUNTY: document.getElementById('county').value, 
                SEC: section, 
                TWN: township, 
                RNG: range, 
                MERIDIAN: document.getElementById('meridian').value,
                Notes: notes,
                Group: document.getElementById('addPropertyGroup').value.trim(),
                'RI Acres': parseFloat(document.getElementById('addPropertyRIAcres').value) || 0,
                'WI Acres': parseFloat(document.getElementById('addPropertyWIAcres').value) || 0
            };
            try {
                const res = await fetch('/api/properties', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(data) 
                });
                if (!res.ok) { 
                    const err = await res.json(); 
                    if (err.error && err.error.includes('already monitoring')) {
                        showToast('Already tracking this property', 'info');
                    } else {
                        showToast(err.error || 'Failed to add property', 'error');
                    }
                    return;
                }
                showToast('Success, Property Added', 'success');
                closePropertyModal();
                await loadProperties();
            } catch (err) { 
                showToast('Error adding property: ' + err.message, 'error');
            }
        });

        // Event listeners moved to DOMContentLoaded above
        
        function closeWellModal() { 
            document.getElementById('addWellModal').style.display = 'none'; 
            document.getElementById('addWellForm').reset();
            // Reset search tab
            clearWellSearch();
            // Switch back to API tab
            switchTab('api-tab');
        }
        
        // Tab switching functionality
        function switchTab(targetTabId) {
            // Remove active class from all tab buttons and content
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab button and corresponding content
            document.querySelector(`[data-tab="${targetTabId}"]`).classList.add('active');
            document.getElementById(targetTabId).classList.add('active');
        }
        
        // Initialize tab listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Tab button event listeners
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.getAttribute('data-tab');
                    switchTab(targetTab);
                });
            });
        });
        
        // Search functionality
        let searchDebounceTimer;
        const SEARCH_DEBOUNCE_MS = 300;
        
        function debounceSearch(searchFunction, delay = SEARCH_DEBOUNCE_MS) {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(searchFunction, delay);
        }
        
        async function searchWells() {
            const searchParams = {
                well_name: document.getElementById('searchWellName').value.trim(),
                operator: document.getElementById('searchOperator').value.trim(),
                section: document.getElementById('searchSection').value.trim(),
                township: document.getElementById('searchTownship').value.trim(),
                range: document.getElementById('searchRange').value.trim(),
                county: document.getElementById('searchCounty').value.trim()
            };
            
            // Check if at least one search field is filled
            const hasSearchCriteria = Object.values(searchParams).some(value => value !== '');
            if (!hasSearchCriteria) {
                showToast('Please enter at least one search criteria', 'error');
                return;
            }
            
            // Show loading state
            document.getElementById('searchLoading').style.display = 'block';
            document.getElementById('searchResults').style.display = 'none';
            
            try {
                // Build query parameters
                const queryParams = new URLSearchParams();
                Object.entries(searchParams).forEach(([key, value]) => {
                    if (value) queryParams.append(key, value);
                });
                
                const response = await fetch(`/api/wells/search?${queryParams.toString()}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Search failed');
                }
                
                const data = await response.json();
                displaySearchResults(data.data);
                
            } catch (error) {
                console.error('Search error:', error);
                showToast(`Search error: ${error.message}`, 'error');
                document.getElementById('searchResults').style.display = 'none';
            } finally {
                document.getElementById('searchLoading').style.display = 'none';
            }
        }
        
        function displaySearchResults(data) {
            const { wells, total, truncated, search_criteria } = data;
            
            // Update results info
            const resultsInfo = document.getElementById('resultsInfo');
            let infoText = `Found ${total} well${total !== 1 ? 's' : ''}`;
            if (truncated) {
                infoText += ` (showing first 25)`;
            }
            resultsInfo.textContent = infoText;
            
            // Clear previous results
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            
            if (wells.length === 0) {
                resultsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <h3 style="margin: 0 0 8px 0;">No wells found</h3>
                        <p style="margin: 0;">Try adjusting your search criteria</p>
                    </div>
                `;
            } else {
                wells.forEach(well => {
                    const resultItem = createResultItem(well);
                    resultsList.appendChild(resultItem);
                });
            }
            
            // Show results
            document.getElementById('searchResults').style.display = 'block';
        }
        
        function createResultItem(well) {
            const div = document.createElement('div');
            div.className = 'result-item';
            
            // Determine status class
            let statusClass = 'other';
            let statusText = well.well_status || 'Unknown';
            if (well.well_status === 'AC') {
                statusClass = 'active';
                statusText = 'Active';
            } else if (well.well_status === 'PA') {
                statusClass = 'plugged';
                statusText = 'Plugged';
            }
            
            const location = well.location;
            const production = well.production;
            
            div.innerHTML = `
                <div class="result-header">
                    <h4 class="result-well-name">${escapeHtml(well.well_name || 'Unnamed Well')}</h4>
                    <span class="result-status ${statusClass}">${statusText}</span>
                </div>
                <div class="result-details">
                    <div class="result-detail">
                        <strong>API:</strong> ${escapeHtml(well.api_number)}
                    </div>
                    <div class="result-detail">
                        <strong>Operator:</strong> ${escapeHtml(well.operator || 'Unknown')}
                    </div>
                    <div class="result-detail">
                        <strong>Location:</strong> S${location.section}-${location.township}-${location.range}-${location.meridian}
                    </div>
                    <div class="result-detail">
                        <strong>County:</strong> ${escapeHtml(location.county || 'Unknown')}
                    </div>
                    ${production.formation_name ? `
                        <div class="result-detail">
                            <strong>Formation:</strong> ${escapeHtml(production.formation_name)}
                        </div>
                    ` : ''}
                    ${production.ip_oil_bbl || production.ip_gas_mcf ? `
                        <div class="result-detail">
                            <strong>IP:</strong> ${production.ip_oil_bbl || 0} bbl/d, ${production.ip_gas_mcf || 0} mcf/d
                        </div>
                    ` : ''}
                </div>
                <button class="btn-select" onclick="selectWellFromSearch('${escapeHtml(well.api_number)}', '${escapeHtml(well.well_name || '')}')">
                    Select This Well
                </button>
            `;
            
            return div;
        }
        
        function selectWellFromSearch(apiNumber, wellName) {
            // Switch to API tab and populate the form
            switchTab('api-tab');
            
            // Fill in the API number
            document.getElementById('apiNumber').value = apiNumber;
            
            // Focus on the notes field for user convenience
            const notesField = document.getElementById('wellNotes');
            notesField.focus();
            
            // Clear search results
            clearWellSearch();
            
            showToast(`Selected well: ${wellName} (${apiNumber})`);
        }
        
        function clearWellSearch() {
            // Clear all search form fields
            document.getElementById('searchWellName').value = '';
            document.getElementById('searchOperator').value = '';
            document.getElementById('searchSection').value = '';
            document.getElementById('searchTownship').value = '';
            document.getElementById('searchRange').value = '';
            document.getElementById('searchCounty').value = '';
            
            // Hide search results and loading
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchLoading').style.display = 'none';
        }
        
        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Auto-search on input with debouncing
        document.addEventListener('DOMContentLoaded', function() {
            const searchInputs = [
                'searchWellName', 'searchOperator', 'searchSection', 
                'searchTownship', 'searchRange', 'searchCounty'
            ];
            
            searchInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', () => {
                        // Only auto-search if we have at least 2 characters or it's a section/location search
                        const value = input.value.trim();
                        const isLocationField = ['searchSection', 'searchTownship', 'searchRange'].includes(inputId);
                        
                        if (value.length >= 2 || (isLocationField && value.length >= 1)) {
                            debounceSearch(searchWells);
                        } else if (value.length === 0) {
                            // Clear results if input is cleared
                            document.getElementById('searchResults').style.display = 'none';
                        }
                    });
                }
            });
        });
        
        // Event listeners for wells have been moved to DOMContentLoaded
        

        async function trackWellFromActivity(apiNumber, wellName, occLink, buttonElement) {
            try {
                // Disable the button while processing
                buttonElement.disabled = true;
                buttonElement.textContent = 'Adding...';
                
                // Check if well is already tracked by checking current wells
                const isAlreadyTracked = loadedWells.some(w => w.fields['API Number'] === apiNumber);
                
                if (isAlreadyTracked) {
                    showToast('Already tracking this well', 'info');
                    buttonElement.textContent = 'Already Tracking';
                    return;
                }
                
                // Add the well with OCC Link
                const response = await fetch('/api/wells', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiNumber: apiNumber,
                        occLink: occLink // Pass the permit PDF URL
                    })
                });
                
                if (response.ok) {
                    showToast('Success, Well Added', 'success');
                    buttonElement.textContent = 'Added ';
                    buttonElement.style.background = '#22C55E';
                    buttonElement.style.color = 'white';
                    buttonElement.style.borderColor = '#22C55E';
                    
                    // Refresh wells list to include the new well
                    await loadWells();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to add well', 'error');
                    buttonElement.disabled = false;
                    buttonElement.textContent = '+ Track Well';
                }
            } catch (error) {
                console.error('Error tracking well:', error);
                showToast('Error adding well', 'error');
                buttonElement.disabled = false;
                buttonElement.textContent = '+ Track Well';
            }
        }
        
        // Store loaded data for details modals
        let loadedProperties = [];
        let loadedWells = [];
        
        // Expandable Row Functions
        function openWellDetailsModal(wellId) {
            const well = loadedWells.find(w => w.id === wellId);
            if (!well) return;
            
            const f = well.fields;
            
            // Helper function to format dates
            const formatDate = (dateStr) => {
                if (!dateStr) return null;
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
                } catch {
                    return null;
                }
            };
            
            // Helper function to detect horizontal wells
            const isHorizontal = (wellName) => {
                if (!wellName) return false;
                const name = wellName.toLowerCase();
                return name.includes('h') && (name.endsWith('h') || name.endsWith('xh') || name.includes('wx'));
            };
            
            // Helper function to strip existing phone formatting
            const stripPhoneFormat = (phone) => {
                if (!phone) return '';
                return phone.replace(/[^0-9]/g, '');
            };
            
            // Populate header
            document.getElementById('wellDetailsTitle').textContent = f['Well Name'] || 'Unknown Well';
            document.getElementById('wellDetailsApi').textContent = `API: ${f['API Number'] || ''}`;
            
            // Date badge - prefer completion date, fallback to first production
            const completionDate = formatDate(f['Completion Date']);
            const firstProdDate = formatDate(f['First Production Date']);
            const badgeDate = completionDate || firstProdDate;
            const dateBadge = document.getElementById('wellDetailsDateBadge');
            if (badgeDate) {
                dateBadge.textContent = badgeDate;
                dateBadge.style.display = 'inline-block';
            } else {
                dateBadge.style.display = 'none';
            }
            
            // Status badge
            const status = f['Well Status'] || f['OCC Status'] || '';
            const statusBadge = document.getElementById('wellDetailsStatusBadge');
            statusBadge.textContent = status;
            statusBadge.className = status === 'Active' || status === 'AC' ? 'status-badge' : 'status-badge';
            
            // Well Type
            document.getElementById('wellDetailsType').textContent = f['Well Type'] || '';
            
            // Direction (Horizontal/Vertical)
            const direction = isHorizontal(f['Well Name']) ? 'Horizontal' : 'Vertical';
            const directionEl = document.getElementById('wellDetailsDirection');
            directionEl.textContent = direction;
            directionEl.className = direction === 'Horizontal' ? 'status-badge horizontal' : 'status-badge';
            
            // Operator
            document.getElementById('wellDetailsOperator').textContent = f['Operator'] || '';
            
            // Contact line - phone + contact person
            const rawPhone = f['Operator Phone'] || '';
            const contactPerson = f['Contact Name'] || f['Contact Person'] || '';
            const contactLine = document.getElementById('wellDetailsContact');
            const phoneLink = document.getElementById('wellDetailsPhoneLink');
            const contactPersonSpan = document.getElementById('wellDetailsContactPerson');
            
            if (rawPhone || contactPerson) {
                let contactHtml = '';
                
                if (rawPhone) {
                    const cleanPhone = stripPhoneFormat(rawPhone);
                    const formattedPhone = formatPhoneNumber(cleanPhone);
                    phoneLink.href = `tel:${cleanPhone}`;
                    phoneLink.textContent = formattedPhone;
                    phoneLink.style.display = 'inline';
                } else {
                    phoneLink.style.display = 'none';
                }
                
                if (contactPerson) {
                    contactPersonSpan.textContent = contactPerson;
                    contactPersonSpan.style.display = 'inline';
                } else {
                    contactPersonSpan.style.display = 'none';
                }
                
                // Show bullet separator if both exist
                if (rawPhone && contactPerson) {
                    contactLine.style.display = 'block';
                } else if (rawPhone || contactPerson) {
                    contactLine.style.display = 'block';
                } else {
                    contactLine.style.display = 'none';
                }
            } else {
                contactLine.style.display = 'none';
            }
            
            // Location
            const section = f['Section'] || '';
            const township = f['Township'] || '';
            const range = f['Range'] || '';
            const location = (section && township && range) ? `T${township} R${range} ${section}` : '';
            document.getElementById('wellDetailsLocation').textContent = location;
            
            // County
            document.getElementById('wellDetailsCounty').textContent = cleanCountyDisplay(f['County']) || '';
            
            // Production section - only show if any production data exists
            const ipGas = f['IP Gas (MCF/day)'];
            const ipOil = f['IP Oil (BBL/day)'];
            const formationName = f['Formation Name'];
            const formationDepth = f['Formation Depth'];
            
            const productionSection = document.getElementById('wellDetailsProduction');
            if (ipGas || ipOil || formationName || formationDepth) {
                // Show production section
                productionSection.style.display = 'block';
                
                // Formation badge
                document.getElementById('wellDetailsFormationBadge').textContent = formationName || 'Unknown';
                
                // IP Gas
                document.getElementById('wellDetailsIPGas').textContent = ipGas ? Number(ipGas).toLocaleString() : '';
                
                // IP Oil
                document.getElementById('wellDetailsIPOil').textContent = ipOil ? Number(ipOil).toLocaleString() : '';
                
                // Depth
                document.getElementById('wellDetailsDepth').textContent = formationDepth ? Number(formationDepth).toLocaleString() : '';
                
                // Dates
                document.getElementById('wellDetailsCompleted').textContent = completionDate || '';
                document.getElementById('wellDetailsFirstProd').textContent = firstProdDate || '';
            } else {
                productionSection.style.display = 'none';
            }
            
            // Notes
            document.getElementById('wellDetailsNotes').value = f['Notes'] || '';
            
            // Links
            const mapLink = document.getElementById('wellDetailsMapLink');
            if (f['OCC Map Link'] && f['OCC Map Link'] !== '#') {
                mapLink.href = f['OCC Map Link'];
                mapLink.style.display = 'inline-flex';
            } else {
                mapLink.style.display = 'none';
            }
            
            // Well Records link - remove &cr=1 if present
            const recordsLink = document.getElementById('wellDetailsRecordsLink');
            if (f['API Number']) {
                const apiNumber = f['API Number'];
                const searchCommand = encodeURIComponent(`{[OG Well Records]:[API Number]="${apiNumber}*"}`);
                const recordsUrl = `https://public.occ.ok.gov/OGCDWellRecords/Search.aspx?searchcommand=${searchCommand}`;
                
                recordsLink.href = recordsUrl;
                recordsLink.style.display = 'inline-flex';
            } else {
                recordsLink.style.display = 'none';
            }
            
            // Store well ID for saving
            document.getElementById('wellDetailsId').value = wellId;
            
            // Show modal with forced high z-index like bulk modals
            const wellModal = document.getElementById('wellDetailsModal');
            
            // Nuclear option - move modal to end of body to escape any stacking context
            if (wellModal.parentNode !== document.body) {
                document.body.appendChild(wellModal);
            }
            
            wellModal.style.cssText = 'display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 999999 !important; background: rgba(0,0,0,0.5) !important; align-items: center !important; justify-content: center !important; padding: 20px !important;';
            
            // Handle viewer permissions
            const isViewer = currentUser?.role === 'Viewer';
            if (isViewer) {
                document.getElementById('saveWellBtn').style.display = 'none';
                document.getElementById('wellDetailsNotes').readOnly = true;
                document.getElementById('wellDetailsNotes').style.backgroundColor = '#f5f5f5';
            } else {
                document.getElementById('saveWellBtn').style.display = 'inline-block';
                document.getElementById('wellDetailsNotes').readOnly = false;
                document.getElementById('wellDetailsNotes').style.backgroundColor = 'white';
            }
        }
        
        // Placeholder for Phase 2
        // Modal functionality replaces expandable rows
        
        // Update well notes in memory (for immediate feedback)
        function updateWellNotes(wellId) {
            const textarea = document.getElementById(`well-notes-${wellId}`);
            const well = loadedWells.find(w => w.id === wellId);
            if (well && textarea) {
                well.fields['Notes'] = textarea.value;
            }
        }

        async function saveWellNotes(wellId) {
            const textarea = document.getElementById(`well-notes-${wellId}`);
            const notes = textarea ? textarea.value : '';
            
            try {
                const res = await fetch('/api/wells/' + wellId + '/notes', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const well = loadedWells.find(w => w.id === wellId);
                if (well) well.fields['Notes'] = notes;
                
                showToast('Note saved!', 'success');
            } catch (err) {
                showToast('Error saving notes', 'error');
            }
        }
        
        async function saveWellNotesFromModal() {
            const wellId = document.getElementById('wellDetailsId').value;
            const notes = document.getElementById('wellDetailsNotes').value;
            
            if (!wellId) {
                showToast('Error: Well ID not found', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/wells/' + wellId + '/notes', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const well = loadedWells.find(w => w.id === wellId);
                if (well) well.fields['Notes'] = notes;
                
                showToast('Note saved!', 'success');
            } catch (err) {
                console.error('Save notes error:', err);
                showToast('Error saving notes', 'error');
            }
        }
        
        async function saveWellNotesAndClose() {
            const wellId = document.getElementById('wellDetailsId').value;
            const notes = document.getElementById('wellDetailsNotes').value;
            
            if (!wellId) {
                showToast('Error: Well ID not found', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/wells/' + wellId + '/notes', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const well = loadedWells.find(w => w.id === wellId);
                if (well) well.fields['Notes'] = notes;
                
                // Close modal immediately after successful save
                closeWellDetailsModal();
                
                // Show success toast after modal closes
                setTimeout(() => showToast('Note saved!', 'success'), 100);
            } catch (err) {
                console.error('Save notes error:', err);
                showToast('Error saving notes', 'error');
                // Don't close modal if there was an error
            }
        }
        
        function closeWellDetailsModal() {
            document.getElementById('wellDetailsModal').style = '';
        }
        
        document.getElementById('wellDetailsModal').addEventListener('click', e => {
            if (e.target.id === 'wellDetailsModal') closeWellDetailsModal();
        });
        
        // Add hover handlers for Well Type and OCC Status
        // Removed obsolete hover handlers for old modal structure
        
        // Property Details Modal Functions
        function openPropertyDetails(propId) {
            const prop = loadedProperties.find(p => p.id === propId);
            if (!prop) return;
            
            const f = prop.fields;
            document.getElementById('propertyDetailsId').value = propId;
            
            // Calculate total acres for header badge
            const riAcres = parseFloat(f['RI Acres'] || 0);
            const wiAcres = parseFloat(f['WI Acres'] || 0);
            const totalAcres = riAcres + wiAcres;
            
            // Set header information
            const propertyName = f['Name'] || f['Property Name'] || 'Mineral Property';
            document.getElementById('propertyDetailsTitle').textContent = propertyName;
            
            // Set acreage badge
            const acreageBadge = document.getElementById('propertyDetailsAcreageBadge');
            if (totalAcres > 0) {
                acreageBadge.textContent = `${totalAcres.toFixed(2)} acres`;
                acreageBadge.style.display = 'inline-block';
            } else {
                acreageBadge.style.display = 'none';
            }
            
            // Set location info (county + legal)
            const county = cleanCountyDisplay(f['COUNTY']) || 'Unknown County';
            const legal = `T${f.TWN} R${f.RNG} ${f.SEC}`;
            document.getElementById('propertyDetailsLocation').textContent = `${county}  ${legal}`;
            
            // Set form fields
            document.getElementById('propertyDetailsLegal').textContent = legal;
            document.getElementById('propertyDetailsMeridian').value = f['MERIDIAN'] || 'IM';
            
            // Show/hide Group row based on whether it has a value
            const groupRow = document.getElementById('propertyDetailsGroupRow');
            if (f['Group']) {
                document.getElementById('propertyDetailsGroup').textContent = f['Group'];
                groupRow.style.display = 'flex';
            } else {
                groupRow.style.display = 'none';
            }
            
            // Set other fields
            document.getElementById('propertyDetailsAdjacent').textContent = (f['Monitor Adjacent'] === false) ? 'No' : 'Yes';
            document.getElementById('propertyDetailsRIAcres').value = riAcres;
            document.getElementById('propertyDetailsWIAcres').value = wiAcres;
            document.getElementById('propertyDetailsNotes').value = f['Notes'] || '';
            
            // Update total acres display in form
            updateTotalAcres();
            
            // Show modal with forced high z-index like bulk modals
            const propModal = document.getElementById('propertyDetailsModal');
            
            // Nuclear option - move modal to end of body to escape any stacking context
            if (propModal.parentNode !== document.body) {
                document.body.appendChild(propModal);
            }
            
            propModal.style.cssText = 'display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 999999 !important; background: rgba(0,0,0,0.5) !important; align-items: center !important; justify-content: center !important; padding: 20px !important;';
            
            // Handle viewer permissions
            const isViewer = currentUser?.role === 'Viewer';
            if (isViewer) {
                document.getElementById('savePropertyBtn').style.display = 'none';
                document.getElementById('propertyDetailsNotes').readOnly = true;
                document.getElementById('propertyDetailsNotes').style.backgroundColor = '#f5f5f5';
                document.getElementById('propertyDetailsRIAcres').readOnly = true;
                document.getElementById('propertyDetailsRIAcres').style.backgroundColor = '#f5f5f5';
                document.getElementById('propertyDetailsWIAcres').readOnly = true;
                document.getElementById('propertyDetailsWIAcres').style.backgroundColor = '#f5f5f5';
            } else {
                document.getElementById('savePropertyBtn').style.display = 'inline-block';
                document.getElementById('propertyDetailsNotes').readOnly = false;
                document.getElementById('propertyDetailsNotes').style.backgroundColor = 'white';
                document.getElementById('propertyDetailsRIAcres').readOnly = false;
                document.getElementById('propertyDetailsRIAcres').style.backgroundColor = 'white';
                document.getElementById('propertyDetailsWIAcres').readOnly = false;
                document.getElementById('propertyDetailsWIAcres').style.backgroundColor = 'white';
            }
        }
        
        function updateTotalAcres() {
            const riAcres = parseFloat(document.getElementById('propertyDetailsRIAcres').value) || 0;
            const wiAcres = parseFloat(document.getElementById('propertyDetailsWIAcres').value) || 0;
            const totalAcres = riAcres + wiAcres;
            
            // Update total in form
            document.getElementById('propertyDetailsTotalAcres').textContent = totalAcres > 0 ? totalAcres.toFixed(2) : '';
            
            // Update badge in header
            const acreageBadge = document.getElementById('propertyDetailsAcreageBadge');
            if (totalAcres > 0) {
                acreageBadge.textContent = `${totalAcres.toFixed(2)} acres`;
                acreageBadge.style.display = 'inline-block';
            } else {
                acreageBadge.style.display = 'none';
            }
        }
        
        async function savePropertyDetails() {
            const propId = document.getElementById('propertyDetailsId').value;
            const notes = document.getElementById('propertyDetailsNotes').value;
            const meridian = document.getElementById('propertyDetailsMeridian').value;
            const riAcres = parseFloat(document.getElementById('propertyDetailsRIAcres').value) || 0;
            const wiAcres = parseFloat(document.getElementById('propertyDetailsWIAcres').value) || 0;
            
            try {
                const res = await fetch('/api/properties/' + propId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes, meridian, riAcres, wiAcres })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const prop = loadedProperties.find(p => p.id === propId);
                if (prop) {
                    prop.fields['Notes'] = notes;
                    prop.fields['MERIDIAN'] = meridian;
                    prop.fields['RI Acres'] = riAcres;
                    prop.fields['WI Acres'] = wiAcres;
                }
                
                showToast('Changes saved!', 'success');
                closePropertyDetailsModal();
                await loadProperties();
            } catch (err) {
                showToast('Error saving changes', 'error');
            }
        }
        
        async function savePropertyAndClose() {
            const propId = document.getElementById('propertyDetailsId').value;
            const notes = document.getElementById('propertyDetailsNotes').value;
            const meridian = document.getElementById('propertyDetailsMeridian').value;
            const riAcres = parseFloat(document.getElementById('propertyDetailsRIAcres').value) || 0;
            const wiAcres = parseFloat(document.getElementById('propertyDetailsWIAcres').value) || 0;
            
            if (!propId) {
                showToast('Error: Property ID not found', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/properties/' + propId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes, meridian, riAcres, wiAcres })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const prop = loadedProperties.find(p => p.id === propId);
                if (prop) {
                    prop.fields['Notes'] = notes;
                    prop.fields['MERIDIAN'] = meridian;
                    prop.fields['RI Acres'] = riAcres;
                    prop.fields['WI Acres'] = wiAcres;
                }
                
                // Close modal immediately after successful save
                closePropertyDetailsModal();
                
                // Show success toast after modal closes and reload properties
                setTimeout(() => {
                    showToast('Changes saved!', 'success');
                    loadProperties();
                }, 100);
            } catch (err) {
                console.error('Save property error:', err);
                showToast('Error saving changes', 'error');
                // Don't close modal if there was an error
            }
        }
        
        function closePropertyDetailsModal() {
            document.getElementById('propertyDetailsModal').style = '';
        }
        
        document.getElementById('propertyDetailsModal').addEventListener('click', e => {
            if (e.target.id === 'propertyDetailsModal') closePropertyDetailsModal();
        });
        
        // CSV Export Functions (Professional tier)
        function exportWellsCSV() {
            if (!loadedWells.length) {
                showToast('No wells to export', 'info');
                return;
            }
            
            // Helper function to escape CSV values
            function escapeCSV(value) {
                if (value === null || value === undefined) return '';
                value = value.toString();
                // If contains comma, quote, or newline, wrap in quotes and escape quotes
                if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            }
            
            const headers = ['API Number', 'Well Name', 'Operator', 'County', 'Section', 'Township', 'Range', 'Well Type', 'Well Status', 'Notes', 'OCC Map Link'];
            const rows = loadedWells.map(w => {
                const f = w.fields;
                return [
                    escapeCSV(f['API Number'] || ''),
                    escapeCSV(f['Well Name'] || ''),
                    escapeCSV(f['Operator'] || ''),
                    escapeCSV(f['County'] || ''),
                    escapeCSV(f['Section'] || ''),
                    escapeCSV(f['Township'] || ''),
                    escapeCSV(f['Range'] || ''),
                    escapeCSV(f['Well Type'] || ''),
                    escapeCSV(f['Well Status'] || ''),
                    escapeCSV(f['Notes'] || ''),
                    escapeCSV(f['OCC Map Link'] || '')
                ].join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\n');
            downloadCSV(csv, 'mineral-watch-wells.csv');
        }
        
        function exportPropertiesCSV() {
            if (!loadedProperties.length) {
                showToast('No properties to export', 'info');
                return;
            }
            
            // Helper function to escape CSV values
            function escapeCSV(value) {
                if (value === null || value === undefined) return '';
                value = value.toString();
                // If contains comma, quote, or newline, wrap in quotes and escape quotes
                if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            }
            
            const headers = ['County', 'Section', 'Township', 'Range', 'Meridian', 'Group', 'RI Acres', 'WI Acres', 'Notes'];
            const rows = loadedProperties.map(p => {
                const f = p.fields;
                return [
                    escapeCSV(f['COUNTY'] || ''),
                    escapeCSV(f['SEC'] || ''),
                    escapeCSV(f['TWN'] || ''),
                    escapeCSV(f['RNG'] || ''),
                    escapeCSV(f['MERIDIAN'] || 'IM'),
                    escapeCSV(f['Group'] || ''),
                    escapeCSV(f['RI Acres'] || '0'),
                    escapeCSV(f['WI Acres'] || '0'),
                    escapeCSV(f['Notes'] || '')
                ].join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\n');
            downloadCSV(csv, 'mineral-watch-properties.csv');
        }
        
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }
        
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/auth/logout', { 
                    method: 'POST',
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    // Clear any client-side session data
                    document.cookie = 'mw_session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                    window.location.href = '/portal/login';
                } else {
                    console.error('Logout failed:', response.status);
                    // Still redirect to login
                    window.location.href = '/portal/login';
                }
            } catch (error) {
                console.error('Logout error:', error);
                // Still redirect to login
                window.location.href = '/portal/login';
            }
        });
        
        // Toast notification system
        function showToast(message, type = 'success', duration = 3000) {
            // Remove any existing toasts
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = `toast toast-${type}`;
            
            const icon = type === 'success' ? '' : type === 'error' ? '' : '';
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${escapeHtml(message)}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('toast-show'), 10);
            
            // Auto dismiss if duration > 0, otherwise keep persistent
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.remove('toast-show');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }
        
        function dismissToast() {
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) {
                existingToast.classList.remove('toast-show');
                setTimeout(() => existingToast.remove(), 300);
            }
        }

        // Custom confirm dialog
        function showConfirm(message, options = {}) {
            return new Promise((resolve) => {
                const dialog = document.getElementById('confirmDialog');
                console.log('Confirm dialog element:', dialog);
                
                if (!dialog) {
                    console.error('Confirm dialog not found!');
                    resolve(false);
                    return;
                }
                
                const title = document.getElementById('confirmTitle');
                const messageEl = document.getElementById('confirmMessage');
                const cancelBtn = document.getElementById('confirmCancel');
                const okBtn = document.getElementById('confirmOk');
                
                title.textContent = options.title || 'Confirm Action';
                messageEl.innerHTML = message;
                okBtn.textContent = options.confirmText || 'Delete';
                cancelBtn.textContent = options.cancelText || 'Cancel';
                
                dialog.classList.add('show');
                console.log('Dialog should be visible now');
                
                const handleCancel = () => {
                    dialog.classList.remove('show');
                    resolve(false);
                    cleanup();
                };
                
                const handleConfirm = () => {
                    dialog.classList.remove('show');
                    resolve(true);
                    cleanup();
                };
                
                const cleanup = () => {
                    cancelBtn.removeEventListener('click', handleCancel);
                    okBtn.removeEventListener('click', handleConfirm);
                    dialog.removeEventListener('click', handleOverlayClick);
                };
                
                const handleOverlayClick = (e) => {
                    if (e.target === dialog) handleCancel();
                };
                
                cancelBtn.addEventListener('click', handleCancel);
                okBtn.addEventListener('click', handleConfirm);
                dialog.addEventListener('click', handleOverlayClick);
            });
        }
    </script>
    </div>
</div>
<!-- End of propertyDetailsModal -->

<!-- BULK UPLOAD MODAL - REDESIGNED -->
<div class="modal-overlay" id="bulk-upload-modal">
    <div class="modal bulk-modal">
        <!-- Header -->
        <div class="bulk-header">
            <h2>Bulk Upload Properties</h2>
            <button class="bulk-close" onclick="closeBulkUploadModal()">&times;</button>
        </div>
        
        <!-- Step 1: File Upload -->
        <div id="upload-step" style="display:block;">
            <!-- Instructions -->
            <div class="bulk-section">
                <p class="bulk-intro">Upload a CSV or Excel file with your properties. We'll automatically detect columns and format your data.</p>
                <p class="bulk-text" style="margin-top: 8px;"> <strong>Tip:</strong> Include a Notes column to add context like well names, ownership details, or reminders for each property.</p>
            </div>
            
            <!-- File Formats -->
            <div class="bulk-section bulk-section-gray">
                <div class="bulk-label">Supported File Formats</div>
                <div class="bulk-text">CSV (.csv), Excel (.xlsx, .xls), Tab-delimited (.txt, .tsv)</div>
            </div>
            
            <!-- Two Column: Column Names + Format Examples -->
            <div class="bulk-section">
                <div class="bulk-two-col">
                    <!-- Column Names -->
                    <div>
                        <div class="bulk-label">Column Names (Flexible)</div>
                        <div class="bulk-columns">
                            <div><strong>Section:</strong> <code>SEC</code> <code>Section</code> <code>Sec</code> <code>S</code></div>
                            <div><strong>Township:</strong> <code>TWN</code> <code>Township</code> <code>Town</code> <code>T</code></div>
                            <div><strong>Range:</strong> <code>RNG</code> <code>Range</code> <code>R</code></div>
                            <div><strong>Notes:</strong> <code>Notes</code> <code>Note</code> <code>Comments</code></div>
                            <div><strong>Acres:</strong> <code>RI Acres</code> <code>RI</code> <code>WI Acres</code> <code>WI</code> <code>Total Acres</code> <code>Acres</code></div>
                            <div><strong>Group:</strong> <code>Group</code> <code>Entity</code></div>
                            <div><strong>County:</strong> <code>County</code> <code>Co</code> <code>C</code></div>
                            <div><strong>Optional:</strong> County, Meridian, Group, RI Acres, WI Acres, Total Acres</div>
                            <div style="font-size: 12px; color: var(--slate-blue); margin-top: 8px;"> If only "Total Acres" is provided, it defaults to RI interest</div>
                        </div>
                    </div>
                    
                    <!-- Format Examples -->
                    <div>
                        <div class="bulk-label">We Auto-Format These</div>
                        <div class="bulk-formats">
                            <div class="bulk-format"><code>3</code> <span class="arrow"></span> <code>03</code></div>
                            <div class="bulk-format"><code>S3</code> <span class="arrow"></span> <code>03</code></div>
                            <div class="bulk-format"><code>12 N</code> <span class="arrow"></span> <code>12N</code></div>
                            <div class="bulk-format"><code>T12N</code> <span class="arrow"></span> <code>12N</code></div>
                            <div class="bulk-format"><code>8w</code> <span class="arrow"></span> <code>8W</code></div>
                            <div class="bulk-format"><code>R08W</code> <span class="arrow"></span> <code>8W</code></div>
                        </div>
                        <p class="bulk-note">Missing meridian: Panhandle counties (Cimarron, Texas, Beaver) default to CM, all others to IM</p>
                    </div>
                </div>
            </div>
            
            <!-- Upload Area -->
            <div class="bulk-section">
                <div class="bulk-dropzone" id="dropzone" 
                     ondrop="handleFileDrop(event)" 
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     onclick="document.getElementById('fileInput').click()">
                    <div class="dropzone-icon"></div>
                    <div class="dropzone-text">Drop your file here or click to browse</div>
                    <div class="dropzone-subtext">Maximum file size: 5MB</div>
                </div>
                
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.txt,.tsv" style="display:none;" onchange="handleFileSelect(event)">
                
                <div id="file-info" class="bulk-file-info" style="display: none;">
                    <span class="file-name" id="filename"></span>
                    <span class="file-size" id="filesize"></span>
                </div>
                
                <div id="parse-error" class="bulk-error" style="display: none;">
                    <strong>Error parsing file:</strong> <span id="error-message"></span>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bulk-footer">
                <button class="btn-secondary" onclick="closeBulkUploadModal()">Cancel</button>
            </div>
        </div>
        
        <!-- Step 2: Preview & Validate -->
        <div id="preview-step" style="display:none;">
            <div class="bulk-section">
                <h3 style="margin-bottom: 8px; font-family: 'Merriweather', serif;">Preview & Validate</h3>
                <p class="bulk-text">Review the detected properties before importing:</p>
            </div>
            
            <div class="bulk-section">
                <!-- Validation Badges -->
                <div id="validation-summary" class="bulk-badges"></div>
                
                <!-- Plan Check -->
                <div id="plan-check"></div>
                
                <!-- Preview Table -->
                <div class="bulk-table-container">
                    <table class="bulk-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>SEC</th>
                                <th>TWN</th>
                                <th>RNG</th>
                                <th>MER</th>
                                <th>County</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bulk-footer">
                <button class="btn-secondary" onclick="resetBulkUpload()">Start Over</button>
                <button id="import-btn" class="btn-primary" onclick="startImport()">Import Properties</button>
            </div>
        </div>
        
        <!-- Step 3: Importing Progress -->
        <div id="import-step" style="display:none;">
            <div class="bulk-progress">
                <div class="progress-icon"></div>
                <h3>Importing Properties...</h3>
                <p class="bulk-text">Please wait while we create your properties.</p>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" id="progress-bar"></div>
                </div>
                <div class="progress-percent" id="progress-percent">0%</div>
                <div class="progress-count" id="import-progress">0 of 0 properties created</div>
            </div>
        </div>
        
        <!-- Step 4: Results -->
        <div id="results-step" style="display:none;">
            <div class="bulk-results">
                <div class="results-icon" id="results-icon"></div>
                <h3 class="results-title" id="results-title">Import Complete!</h3>
                <div class="results-stats">
                    <div class="stat-box">
                        <div class="stat-number stat-success" id="result-created">0</div>
                        <div class="stat-label">Created</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number stat-warning" id="result-skipped">0</div>
                        <div class="stat-label">Skipped</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number stat-error" id="result-failed">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                </div>
                <p class="bulk-text" id="results-details">Your properties are now being monitored for OCC activity.</p>
                <button class="btn-primary" onclick="finishBulkUpload()">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- BULK UPLOAD WELLS MODAL -->
<div class="modal-overlay" id="bulk-upload-wells-modal">
    <div class="modal bulk-modal">
        <!-- Header -->
        <div class="bulk-header">
            <h2>Bulk Upload Wells</h2>
            <button class="bulk-close" onclick="closeBulkUploadWellsModal()">&times;</button>
        </div>
        
        <!-- Step 1: File Upload -->
        <div id="wells-upload-step" style="display:block;">
            <div class="bulk-section">
                <p class="bulk-intro">Upload a CSV or Excel file to add wells. You can use API numbers or search by well name, operator, and location.</p>
                <p class="bulk-text" style="margin-top: 8px;"> <strong>New:</strong> No API numbers? We'll search our database of 453k Oklahoma wells using your CSV data!</p>
            </div>
            
            <div class="bulk-section bulk-section-gray">
                <div class="bulk-label">Column Options</div>
                <div class="bulk-text" style="margin-bottom: 12px;">
                    <strong>Option 1: Direct API</strong>  Provide 10-digit API numbers
                </div>
                <div class="bulk-columns">
                    <div>Headers: <code>API</code> <code>API Number</code> <code>apiNumber</code></div>
                </div>
                <div class="bulk-text" style="margin-top: 16px; margin-bottom: 12px;">
                    <strong>Option 2: Search by Details</strong>  We'll find matching wells
                </div>
                <div class="bulk-columns">
                    <div><code>Well Name</code> <code>Operator</code> <code>Section</code> <code>Township</code> <code>Range</code> <code>County</code></div>
                </div>
            </div>
            
            <div class="bulk-section">
                <div class="bulk-two-col">
                    <div>
                        <div class="bulk-label">Optional Columns</div>
                        <div class="bulk-columns">
                            <div><strong>Notes:</strong> <code>Notes</code> <code>Note</code> <code>Comments</code></div>
                        </div>
                    </div>
                    <div>
                        <div class="bulk-label">Format Flexibility</div>
                        <div class="bulk-formats">
                            <div class="bulk-format"><code>35-015-20001</code> <span class="arrow"></span> <code>3501520001</code></div>
                            <div class="bulk-format"><code>35 015 20001</code> <span class="arrow"></span> <code>3501520001</code></div>
                        </div>
                        <p class="bulk-note">Dashes, spaces, dots are automatically removed</p>
                    </div>
                </div>
            </div>
            
            <div class="bulk-section">
                <div class="bulk-dropzone" id="wells-dropzone" 
                     ondrop="handleWellsFileDrop(event)" 
                     ondragover="handleWellsDragOver(event)"
                     ondragleave="handleWellsDragLeave(event)"
                     onclick="document.getElementById('wellsFileInput').click()">
                    <div class="dropzone-icon"></div>
                    <div class="dropzone-text">Drop your file here or click to browse</div>
                    <div class="dropzone-subtext">CSV or Excel files accepted</div>
                </div>
                
                <input type="file" id="wellsFileInput" accept=".csv,.xlsx,.xls,.txt,.tsv" style="display:none;" onchange="handleWellsFileSelect(event)">
                
                <div id="wells-file-info" class="bulk-file-info" style="display: none;">
                    <span class="file-name" id="wells-filename"></span>
                    <span class="file-size" id="wells-filesize"></span>
                </div>
                
                <div id="wells-parse-error" class="bulk-error" style="display: none;">
                    <strong>Error parsing file:</strong> <span id="wells-error-message"></span>
                </div>
            </div>
            
            <div class="bulk-footer">
                <button class="btn-secondary" onclick="closeBulkUploadWellsModal()">Cancel</button>
            </div>
        </div>
        
        <!-- Step 2: Preview -->
        <div id="wells-preview-step" style="display:none;">
            <div class="bulk-section">
                <h3 style="margin-bottom: 8px; font-family: 'Merriweather', serif;">Preview & Validate</h3>
                <p class="bulk-text">Review the API numbers before importing:</p>
            </div>
            
            <div class="bulk-section">
                <div id="wells-validation-summary" class="bulk-badges"></div>
                <div id="wells-plan-check"></div>
                
                <!-- Quick Actions for large files -->
                <div id="wells-quick-actions" style="display: none; margin-top: 16px; margin-bottom: 16px;">
                    <button class="btn-secondary" onclick="selectAllExactMatches()">
                        Select All Exact Matches
                    </button>
                    <span style="margin-left: 12px; color: #64748b; font-size: 14px;">
                        For ambiguous matches, select the correct well from the dropdown
                    </span>
                </div>
                
                <div class="bulk-table-container">
                    <table class="bulk-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 60px;">Status</th>
                                <th>CSV Data</th>
                                <th>Matched Well</th>
                                <th style="width: 120px;">API Number</th>
                                <th style="width: 100px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="wells-preview-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="bulk-footer">
                <button class="btn-secondary" onclick="resetBulkUploadWells()">Start Over</button>
                <button id="wells-import-btn" class="btn-primary" onclick="startWellsImport()">Import Wells</button>
            </div>
        </div>
        
        <!-- Step 3: Importing -->
        <div id="wells-import-step" style="display:none;">
            <div class="bulk-progress">
                <div class="progress-icon"></div>
                <h3>Importing Wells...</h3>
                <p class="bulk-text">Please wait while we add your wells.</p>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill indeterminate" id="wells-progress-bar"></div>
                </div>
                <div class="progress-count" id="wells-import-progress">Processing...</div>
            </div>
        </div>
        
        <!-- Step 4: Results -->
        <div id="wells-results-step" style="display:none;">
            <div class="bulk-results">
                <div class="results-icon" id="wells-results-icon"></div>
                <h3 class="results-title" id="wells-results-title">Import Complete!</h3>
                <div class="results-stats">
                    <div class="stat-box">
                        <div class="stat-number stat-success" id="wells-result-created">0</div>
                        <div class="stat-label">Created</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number stat-warning" id="wells-result-skipped">0</div>
                        <div class="stat-label">Skipped</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number stat-error" id="wells-result-failed">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                </div>
                <p class="bulk-text" id="wells-results-details">Your wells are now being monitored for OCC activity.</p>
                <button class="btn-primary" onclick="finishBulkUploadWells()">Done</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Bulk Upload Modal - Redesigned Styles */

/* Modal specific overrides */
#bulk-upload-modal .modal.bulk-modal,
#bulk-upload-wells-modal .modal.bulk-modal {
    padding: 0;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
}

/* Header */
.bulk-header {
    background: linear-gradient(135deg, var(--oil-navy) 0%, var(--slate-blue) 100%);
    color: white;
    padding: 24px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.bulk-header h2 {
    font-size: 22px;
    font-weight: 700;
    margin: 0;
    font-family: 'Merriweather', serif;
}

.bulk-close {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 4px;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.bulk-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* Sections */
.bulk-section {
    padding: 24px 30px;
    border-bottom: 1px solid var(--border);
}

.bulk-section:last-child {
    border-bottom: none;
}

.bulk-section-gray {
    background: var(--paper);
}

.bulk-label {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--slate-blue);
    margin-bottom: 10px;
}

.bulk-intro {
    color: var(--slate-blue);
    font-size: 15px;
    line-height: 1.6;
    margin: 0;
}

.bulk-text {
    color: var(--oil-navy);
    font-size: 14px;
    line-height: 1.6;
}

.bulk-note {
    font-size: 12px;
    color: var(--slate-blue);
    margin-top: 12px;
}

/* Two Column Layout */
.bulk-two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
}

@media (max-width: 600px) {
    .bulk-two-col {
        grid-template-columns: 1fr;
    }
    
    /* Extra small screens */
    .container { padding: 0 15px; }
    main { padding: 20px 0; }
    
    
    .page-header h1 { font-size: 22px; }
    
    /* More compact tables on small screens */
    .data-table th, .data-table td { 
        padding: 6px 4px;
        font-size: 11px;
    }
    
    /* Stack table action buttons vertically on tiny screens */
    .col-actions { width: 20%; }
    .details-actions { flex-direction: column; }
    .details-btn { margin-bottom: 8px; }
    
    /* Compact plan info */
    .plan-info { padding: 12px 16px; }
    .plan-usage { flex-direction: column; gap: 8px; }
    
    /* Smaller stats */
    .stats-card { padding: 12px 15px; }
    .stat-value { font-size: 18px; }
}

/* Column Names */
.bulk-columns {
    font-size: 13px;
    line-height: 2;
}

.bulk-columns code {
    background: var(--paper);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 12px;
    font-family: 'SF Mono', Monaco, monospace;
    margin-right: 4px;
}

/* Format Examples */
.bulk-formats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.bulk-format {
    font-size: 13px;
    color: var(--slate-blue);
    display: flex;
    align-items: center;
    gap: 6px;
}

.bulk-format code {
    background: white;
    border: 1px solid var(--border);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 12px;
    font-family: 'SF Mono', Monaco, monospace;
}

.bulk-format .arrow {
    color: var(--success);
    font-weight: 600;
}

/* Dropzone */
.bulk-dropzone {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 50px 30px;
    text-align: center;
    background: var(--paper);
    cursor: pointer;
    transition: all 0.3s;
}

.bulk-dropzone:hover, .bulk-dropzone.drag-over {
    border-color: var(--red-dirt);
    background: #FFF5F0;
}

.dropzone-icon {
    font-size: 40px;
    margin-bottom: 12px;
}

.dropzone-text {
    font-size: 15px;
    color: var(--oil-navy);
    font-weight: 500;
    margin-bottom: 6px;
}

.dropzone-subtext {
    font-size: 13px;
    color: var(--slate-blue);
}

/* File Info */
.bulk-file-info {
    background: var(--success-bg);
    border: 1px solid rgba(3, 84, 63, 0.2);
    border-radius: 6px;
    padding: 14px 18px;
    margin-top: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.bulk-file-info .file-name {
    font-weight: 600;
    color: var(--success);
    font-size: 14px;
}

.bulk-file-info .file-size {
    color: var(--success);
    font-size: 13px;
}

/* Error */
.bulk-error {
    background: #FEE2E2;
    border: 1px solid rgba(220, 38, 38, 0.2);
    border-radius: 6px;
    padding: 14px 18px;
    margin-top: 16px;
    color: #DC2626;
    font-size: 14px;
}

/* Footer */
.bulk-footer {
    padding: 20px 30px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: white;
}

/* Badges */
.bulk-badges {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.validation-badge {
    padding: 10px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.badge-valid { background: var(--success-bg); color: var(--success); }
.badge-invalid { background: #FEE2E2; color: #DC2626; }
.badge-warning { background: #FEF3C7; color: #92400E; }
.badge-duplicate { background: #E0E7FF; color: #3730A3; }

/* Bulk well select dropdown */
.bulk-well-select {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 13px;
    background: white;
    cursor: pointer;
}

.bulk-well-select:hover {
    border-color: #cbd5e1;
}

.bulk-well-select:focus {
    outline: none;
    border-color: var(--oil-orange);
    box-shadow: 0 0 0 3px rgba(192, 86, 33, 0.1);
}

/* Plan Check */
.plan-check-box {
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.plan-check-box.ok {
    background: var(--success-bg);
    border-left: 4px solid var(--success);
}

.plan-check-box.exceeded {
    background: #FEE2E2;
    border-left: 4px solid #DC2626;
}

.plan-check-header {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 4px;
}

.plan-check-box.ok .plan-check-header { color: var(--success); }
.plan-check-box.exceeded .plan-check-header { color: #DC2626; }

.plan-check-details {
    font-size: 13px;
    color: var(--slate-blue);
}

/* Preview Table */
.bulk-table-container {
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    max-height: 350px;
    overflow-y: auto;
}

.bulk-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.bulk-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
}

.bulk-table th {
    background: var(--oil-navy);
    color: white;
    padding: 12px 14px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.bulk-table td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
}

.bulk-table tbody tr:hover {
    background: var(--paper);
}

.preview-row-valid { background: white; }
.preview-row-warning { background: #FEF3C7; }
.preview-row-error { background: #FEE2E2; }
.preview-row-duplicate { background: #E0E7FF; opacity: 0.7; }

.status-cell-valid { color: var(--success); }
.status-cell-warning { color: #92400E; }
.status-cell-error { color: #DC2626; }
.status-cell-duplicate { color: #3730A3; }

/* Progress */
.bulk-progress {
    text-align: center;
    padding: 50px 30px;
}

.bulk-progress .progress-icon {
    font-size: 48px;
    margin-bottom: 20px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.progress-bar-track {
    width: 100%;
    max-width: 400px;
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    margin: 20px auto;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--red-dirt), var(--red-dirt-dark));
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
}

.progress-bar-fill.indeterminate {
    width: 100%;
    animation: indeterminate 1.5s infinite;
    background: linear-gradient(90deg, var(--red-dirt) 0%, var(--red-dirt-dark) 50%, var(--red-dirt) 100%);
    background-size: 200% 100%;
}

@keyframes indeterminate {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.progress-percent {
    font-size: 24px;
    font-weight: 700;
    color: var(--red-dirt);
    margin-top: 15px;
}

.progress-count {
    font-size: 14px;
    color: var(--slate-blue);
    margin-top: 8px;
}

/* Results */
.bulk-results {
    text-align: center;
    padding: 40px 30px;
}

.bulk-results .results-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

.bulk-results .results-title {
    font-size: 24px;
    margin-bottom: 25px;
    font-family: 'Merriweather', serif;
}

.results-stats {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 30px;
}

.stat-box {
    text-align: center;
}

.stat-number {
    font-size: 36px;
    font-weight: 700;
    font-family: 'Merriweather', serif;
}

.stat-success { color: var(--success); }
.stat-warning { color: #92400E; }
.stat-error { color: #DC2626; }

.stat-label {
    font-size: 13px;
    color: var(--slate-blue);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 4px;
}
</style>

<script>
// Global state for bulk upload
let parsedData = [];
let validationResults = null;

// Security: escape HTML to prevent XSS (also defined in main script, but needed here for bulk upload)
function escapeHtmlBulk(text) {
    if (!text) return '';
    const str = String(text);
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

// Open bulk upload modal
function openBulkUploadModal() {
    console.log('openBulkUploadModal called');
    const modal = document.getElementById('bulk-upload-modal');
    console.log('Bulk upload modal element:', modal);
    if (modal) {
        // Force the modal to be visible with inline styles
        modal.style.cssText = 'display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; width: 100% !important; height: 100% !important; z-index: 99999 !important; background-color: rgba(0, 0, 0, 0.8) !important; align-items: center !important; justify-content: center !important;';
        
        // Force body overflow hidden to prevent scrolling
        document.body.style.overflow = 'hidden';
        
        resetBulkUpload();
        
        // Also check if the modal content is visible
        const modalContent = modal.querySelector('.modal.bulk-modal');
        console.log('Modal content element:', modalContent);
        if (modalContent) {
            modalContent.style.cssText = 'display: block !important; position: relative !important; z-index: 100000 !important; background: white !important; max-width: 900px !important; width: 90% !important; max-height: 90vh !important; overflow: auto !important;';
            console.log('Modal content styles applied');
        }
        
        // Debug: Check computed styles
        const computedStyle = window.getComputedStyle(modal);
        console.log('Modal computed display:', computedStyle.display);
        console.log('Modal computed z-index:', computedStyle.zIndex);
        console.log('Modal computed position:', computedStyle.position);
        
        // Check if modal is in viewport
        const rect = modal.getBoundingClientRect();
        console.log('Modal position:', rect);
    } else {
        console.error('Bulk upload modal not found!');
    }
}

// Make function available globally
window.openBulkUploadModal = openBulkUploadModal;

// Open bulk upload wells modal
function openBulkUploadWellsModal() {
    const modal = document.getElementById('bulk-upload-wells-modal');
    if (modal) {
        // Force the modal to be visible with inline styles
        modal.style.cssText = 'display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; width: 100% !important; height: 100% !important; z-index: 99999 !important; background-color: rgba(0, 0, 0, 0.8) !important; align-items: center !important; justify-content: center !important;';
        resetBulkUploadWells();
        
        // Also check if the modal content is visible
        const modalContent = modal.querySelector('.modal.bulk-modal');
        if (modalContent) {
            modalContent.style.cssText = 'display: block !important; position: relative !important; z-index: 100000 !important; background: white !important;';
        }
    }
}

// Make function available globally
window.openBulkUploadWellsModal = openBulkUploadWellsModal;

// Close bulk upload modal
function closeBulkUploadModal() {
    document.getElementById('bulk-upload-modal').style.display = 'none';
    document.body.style.overflow = ''; // Restore body scrolling
    resetBulkUpload();
}

// Reset to initial state
function resetBulkUpload() {
    document.getElementById('upload-step').style.display = 'block';
    document.getElementById('preview-step').style.display = 'none';
    document.getElementById('import-step').style.display = 'none';
    document.getElementById('results-step').style.display = 'none';
    document.getElementById('file-info').style.display = 'none';
    document.getElementById('parse-error').style.display = 'none';
    document.getElementById('fileInput').value = '';
    parsedData = [];
    validationResults = null;
}

// Handle file drop
function handleFileDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('dropzone').classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        processFile(files[0]);
    }
}

// Handle drag over
function handleDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('dropzone').classList.add('drag-over');
}

// Handle drag leave
function handleDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('dropzone').classList.remove('drag-over');
}

// Handle file select
function handleFileSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
        processFile(files[0]);
    }
}

// Process uploaded file
async function processFile(file) {
    document.getElementById('filename').textContent = file.name;
    document.getElementById('filesize').textContent = `${(file.size / 1024).toFixed(1)} KB`;
    document.getElementById('file-info').style.display = 'block';
    document.getElementById('parse-error').style.display = 'none';
    
    try {
        // Detect file type
        const extension = file.name.split('.').pop().toLowerCase();
        
        if (extension === 'csv' || extension === 'txt' || extension === 'tsv') {
            // Parse CSV/TSV
            await parseCSV(file);
        } else if (extension === 'xlsx' || extension === 'xls') {
            // Parse Excel
            await parseExcel(file);
        } else {
            throw new Error('Unsupported file type. Please upload CSV or Excel file.');
        }
        
        // If we got here, parsing succeeded
        if (parsedData.length === 0) {
            throw new Error('No data found in file');
        }
        
        // Validate and show preview
        await validateAndPreview();
        
    } catch (error) {
        console.error('File processing error:', error);
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('parse-error').style.display = 'block';
    }
}

// Parse CSV file
async function parseCSV(file) {
    return new Promise((resolve, reject) => {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                if (results.errors.length > 0) {
                    reject(new Error(`CSV parsing error: ${results.errors[0].message}`));
                    return;
                }
                parsedData = results.data;
                resolve();
            },
            error: (error) => {
                reject(new Error(`CSV parsing failed: ${error.message}`));
            }
        });
    });
}

// Parse Excel file
async function parseExcel(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get first sheet
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (jsonData.length === 0) {
                    reject(new Error('Excel file contains no data'));
                    return;
                }
                
                parsedData = jsonData;
                resolve();
            } catch (error) {
                reject(new Error(`Excel parsing failed: ${error.message}`));
            }
        };
        
        reader.onerror = () => {
            reject(new Error('Failed to read file'));
        };
        
        reader.readAsArrayBuffer(file);
    });
}

// Validate and show preview
async function validateAndPreview() {
    try {
        const response = await fetch('/api/bulk-validate-properties', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ properties: parsedData })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Validation failed');
        }
        
        validationResults = await response.json();
        
        // Show preview step
        document.getElementById('upload-step').style.display = 'none';
        document.getElementById('preview-step').style.display = 'block';
        
        // Render summary badges
        renderSummary();
        
        // Render plan check
        renderPlanCheck();
        
        // Render preview table
        renderPreviewTable();
        
    } catch (error) {
        console.error('Validation error:', error);
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('parse-error').style.display = 'block';
    }
}

// Render summary badges
function renderSummary() {
    const summary = validationResults.summary;
    const html = `
        <div class="validation-badge badge-valid">
             ${summary.valid} Valid
        </div>
        ${summary.invalid > 0 ? `
        <div class="validation-badge badge-invalid">
             ${summary.invalid} Invalid
        </div>
        ` : ''}
        ${summary.warnings > 0 ? `
        <div class="validation-badge badge-warning">
             ${summary.warnings} Warnings
        </div>
        ` : ''}
        ${summary.duplicates > 0 ? `
        <div class="validation-badge badge-duplicate">
             ${summary.duplicates} Duplicates
        </div>
        ` : ''}
    `;
    document.getElementById('validation-summary').innerHTML = html;
}

// Render plan check
function renderPlanCheck() {
    const plan = validationResults.planCheck;
    const wouldExceed = plan.wouldExceedLimit;
    
    const html = `
        <div class="plan-check-box ${wouldExceed ? 'exceeded' : 'ok'}">
            <div class="plan-check-header">
                ${wouldExceed ? ' Would Exceed Plan Limit' : ' Within Plan Limit'}
            </div>
            <div class="plan-check-details">
                Current: ${plan.current} properties  
                Adding: ${validationResults.summary.willImport}  
                Total: ${plan.afterUpload} of ${plan.limit} (${plan.plan} plan)
            </div>
        </div>
    `;
    document.getElementById('plan-check').innerHTML = html;
    
    // Disable import button if would exceed
    document.getElementById('import-btn').disabled = wouldExceed;
}

// Render preview table
function renderPreviewTable() {
    const tbody = document.getElementById('preview-table-body');
    let html = '';
    
    validationResults.results.forEach((result, index) => {
        const prop = result.normalized;
        const rowClass = result.isDuplicate ? 'preview-row-duplicate' : 
                        (result.errors.length > 0 ? 'preview-row-error' :
                        (result.warnings.length > 0 ? 'preview-row-warning' : 'preview-row-valid'));
        
        const statusClass = result.isDuplicate ? 'status-cell-duplicate' :
                           (result.errors.length > 0 ? 'status-cell-error' :
                           (result.warnings.length > 0 ? 'status-cell-warning' : 'status-cell-valid'));
        
        const statusText = result.isDuplicate ? ' Duplicate' :
                          (result.errors.length > 0 ? ` ${result.errors[0]}` :
                          (result.warnings.length > 0 ? ` ${result.warnings[0]}` : ' Valid'));
        
        html += `
            <tr class="${rowClass}">
                <td>${index + 1}</td>
                <td>${escapeHtmlBulk(prop.SEC) || '-'}</td>
                <td>${escapeHtmlBulk(prop.TWN) || '-'}</td>
                <td>${escapeHtmlBulk(prop.RNG) || '-'}</td>
                <td>${escapeHtmlBulk(prop.MERIDIAN) || '-'}</td>
                <td>${escapeHtmlBulk(cleanCountyDisplay(prop.COUNTY)) || '-'}</td>
                <td class="status-cell ${statusClass}">
                    ${statusText}
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Start import - with chunking to avoid Worker timeouts
async function startImport() {
    // Show import step
    document.getElementById('preview-step').style.display = 'none';
    document.getElementById('import-step').style.display = 'block';
    
    // Progress tracking
    const progressBar = document.getElementById('progress-bar');
    progressBar.classList.remove('indeterminate');
    
    // Prepare valid properties for upload
    const toImport = validationResults.results
        .filter(r => r.isValid && !r.isDuplicate)
        .map(r => r.normalized);
    
    const CHUNK_SIZE = 50; // Upload 50 at a time to avoid timeouts
    const totalChunks = Math.ceil(toImport.length / CHUNK_SIZE);
    let totalSuccessful = 0;
    let totalFailed = 0;
    let totalErrors = [];
    
    document.getElementById('import-progress').textContent = `Importing ${toImport.length} properties...`;
    
    try {
        // Process chunks sequentially
        for (let i = 0; i < toImport.length; i += CHUNK_SIZE) {
            const chunk = toImport.slice(i, i + CHUNK_SIZE);
            const chunkNumber = Math.floor(i / CHUNK_SIZE) + 1;
            
            // Update progress
            const progress = Math.round((i / toImport.length) * 100);
            progressBar.style.width = `${progress}%`;
            document.getElementById('progress-percent').textContent = `${progress}%`;
            document.getElementById('import-progress').textContent = 
                `Importing batch ${chunkNumber}/${totalChunks} (${i + chunk.length}/${toImport.length} properties)...`;
            
            // Upload chunk
            const response = await fetch('/api/bulk-upload-properties', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ properties: chunk })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || `Batch ${chunkNumber} failed`);
            }
            
            const chunkResults = await response.json();
            totalSuccessful += chunkResults.results.successful;
            totalFailed += chunkResults.results.failed;
            if (chunkResults.results.errors) {
                totalErrors = totalErrors.concat(chunkResults.results.errors);
            }
            
            // Small delay between chunks to avoid overwhelming the server
            if (i + CHUNK_SIZE < toImport.length) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        
        // Show completion
        progressBar.style.width = '100%';
        document.getElementById('progress-percent').textContent = '100%';
        document.getElementById('import-progress').textContent = `${totalSuccessful} of ${toImport.length} properties created`;
        
        // Brief delay to show completion
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Show results
        showResults({
            results: {
                successful: totalSuccessful,
                failed: totalFailed,
                skipped: 0,
                errors: totalErrors
            }
        });
        
    } catch (error) {
        console.error('Upload error:', error);
        showError(error.message);
    }
}

// Show results
function showResults(results) {
    document.getElementById('import-step').style.display = 'none';
    document.getElementById('results-step').style.display = 'block';
    
    const success = results.results.successful;
    const failed = results.results.failed;
    const skipped = results.results.skipped;
    
    // Update stat boxes
    document.getElementById('result-created').textContent = success;
    document.getElementById('result-skipped').textContent = skipped;
    document.getElementById('result-failed').textContent = failed;
    
    if (failed === 0) {
        document.getElementById('results-icon').textContent = '';
        document.getElementById('results-title').textContent = 'Import Complete!';
        document.getElementById('results-details').textContent = 'Your properties are now being monitored for OCC activity.';
    } else {
        document.getElementById('results-icon').textContent = '';
        document.getElementById('results-title').textContent = 'Import Completed with Errors';
        document.getElementById('results-details').textContent = 'Some properties could not be imported. Check your file and try again.';
    }
}

// Show error
function showError(message) {
    document.getElementById('import-step').style.display = 'none';
    document.getElementById('results-step').style.display = 'block';
    document.getElementById('results-icon').textContent = '';
    document.getElementById('results-title').textContent = 'Import Failed';
    
    // Clear stat boxes
    document.getElementById('result-created').textContent = '0';
    document.getElementById('result-skipped').textContent = '0';
    document.getElementById('result-failed').textContent = '';
    
    document.getElementById('results-details').textContent = message;
}

// Finish and close
function finishBulkUpload() {
    closeBulkUploadModal();
    // Reload properties
    loadProperties();
}

// ==========================================
// WELLS BULK UPLOAD FUNCTIONS
// ==========================================

let wellsParsedData = [];
let wellsValidationResults = null;

// Close wells modal
function closeBulkUploadWellsModal() {
    document.getElementById('bulk-upload-wells-modal').style.display = 'none';
    resetBulkUploadWells();
}

// Reset wells modal
function resetBulkUploadWells() {
    document.getElementById('wells-upload-step').style.display = 'block';
    document.getElementById('wells-preview-step').style.display = 'none';
    document.getElementById('wells-import-step').style.display = 'none';
    document.getElementById('wells-results-step').style.display = 'none';
    document.getElementById('wells-file-info').style.display = 'none';
    document.getElementById('wells-parse-error').style.display = 'none';
    document.getElementById('wellsFileInput').value = '';
    wellsParsedData = [];
    wellsValidationResults = null;
}

// Handle wells file drop
function handleWellsFileDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('wells-dropzone').classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        processWellsFile(files[0]);
    }
}

function handleWellsDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('wells-dropzone').classList.add('drag-over');
}

function handleWellsDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('wells-dropzone').classList.remove('drag-over');
}

function handleWellsFileSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
        processWellsFile(files[0]);
    }
}

// Process wells file
async function processWellsFile(file) {
    document.getElementById('wells-filename').textContent = file.name;
    document.getElementById('wells-filesize').textContent = `${(file.size / 1024).toFixed(1)} KB`;
    document.getElementById('wells-file-info').style.display = 'flex';
    document.getElementById('wells-parse-error').style.display = 'none';
    
    try {
        const extension = file.name.split('.').pop().toLowerCase();
        
        if (extension === 'csv' || extension === 'txt' || extension === 'tsv') {
            await parseWellsCSV(file);
        } else if (extension === 'xlsx' || extension === 'xls') {
            await parseWellsExcel(file);
        } else {
            throw new Error('Unsupported file type');
        }
        
        if (wellsParsedData.length === 0) {
            throw new Error('No data found in file');
        }
        
        // Check if file is very large
        if (wellsParsedData.length > 2000) {
            throw new Error('File too large. Please limit to 2000 wells per import.');
        }
        
        // Show info about batch processing for large files
        if (wellsParsedData.length > 200) {
            const batchCount = Math.ceil(wellsParsedData.length / 25);
            document.getElementById('wells-file-info').innerHTML += 
                `<span style="color: #f59e0b; font-size: 12px; margin-left: 10px;">
                    Large file: Will process in ${batchCount} batches of 25
                </span>`;
        }
        
        await validateAndPreviewWells();
        
    } catch (error) {
        console.error('Wells file processing error:', error);
        document.getElementById('wells-error-message').textContent = error.message;
        document.getElementById('wells-parse-error').style.display = 'block';
    }
}

// Parse CSV for wells
async function parseWellsCSV(file) {
    return new Promise((resolve, reject) => {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                wellsParsedData = results.data;
                resolve();
            },
            error: (error) => reject(error)
        });
    });
}

// Parse Excel for wells
async function parseWellsExcel(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                wellsParsedData = XLSX.utils.sheet_to_json(firstSheet);
                resolve();
            } catch (err) {
                reject(err);
            }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
    });
}

// Store batch processing state
let cancelBatchProcessing = false;
let batchProgressInterval = null;

// Validate and preview wells with batch processing for large files
async function validateAndPreviewWells() {
    try {
        const totalRows = wellsParsedData.length;
        const BATCH_SIZE = 25; // Reduced from 50 to avoid timeouts
        
        // Show progress UI for large files
        if (totalRows > 200) {
            showBatchProgress(totalRows);
        }
        
        // For files <= 200 rows, process normally
        if (totalRows <= 200) {
            const response = await fetch('/api/bulk-validate-wells', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ wells: wellsParsedData })
            });
            
            if (!response.ok) {
                let errorMessage = 'Validation failed';
                try {
                    const error = await response.json();
                    errorMessage = error.error || errorMessage;
                } catch (e) {
                    // Response wasn't JSON (probably HTML error page)
                    errorMessage = `Server error (${response.status}). The file may be too large or complex. Try a smaller batch.`;
                }
                throw new Error(errorMessage);
            }
            
            wellsValidationResults = await response.json();
        } else {
            // Process in batches for large files
            wellsValidationResults = {
                results: [],
                summary: {
                    total: 0,
                    exactMatches: 0,
                    needsReview: 0,
                    notFound: 0,
                    hasApi: 0,
                    duplicates: 0,
                    willImport: 0,
                    canImport: false
                },
                planCheck: null
            };
            
            for (let i = 0; i < totalRows; i += BATCH_SIZE) {
                if (cancelBatchProcessing) {
                    throw new Error('Validation cancelled by user');
                }
                
                const batch = wellsParsedData.slice(i, Math.min(i + BATCH_SIZE, totalRows));
                const batchNum = Math.floor(i / BATCH_SIZE) + 1;
                const totalBatches = Math.ceil(totalRows / BATCH_SIZE);
                
                updateBatchProgress(i, totalRows, `Processing batch ${batchNum}/${totalBatches}...`);
                
                console.log(`[BulkValidate] Sending batch ${batchNum} with ${batch.length} wells`);
                console.log('[BulkValidate] First well in batch:', batch[0]);
                
                const response = await fetch('/api/bulk-validate-wells', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wells: batch })
                });
                
                if (!response.ok) {
                    let errorMessage = `Batch ${batchNum} failed`;
                    try {
                        const error = await response.json();
                        errorMessage = error.error || errorMessage;
                    } catch (e) {
                        errorMessage = `Batch ${batchNum} failed (${response.status}). Try reducing file size.`;
                    }
                    throw new Error(errorMessage);
                }
                
                const batchResult = await response.json();
                
                // Merge batch results
                wellsValidationResults.results = wellsValidationResults.results.concat(batchResult.results);
                wellsValidationResults.summary.total += batchResult.summary.total;
                wellsValidationResults.summary.exactMatches += batchResult.summary.exactMatches;
                wellsValidationResults.summary.needsReview += batchResult.summary.needsReview;
                wellsValidationResults.summary.notFound += batchResult.summary.notFound;
                wellsValidationResults.summary.hasApi += batchResult.summary.hasApi;
                wellsValidationResults.summary.duplicates += batchResult.summary.duplicates;
                wellsValidationResults.summary.willImport += batchResult.summary.willImport;
                
                // Use last batch's plan check (most accurate)
                wellsValidationResults.planCheck = batchResult.planCheck;
                
                // Longer pause between batches to avoid rate limiting
                if (i + BATCH_SIZE < totalRows) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            wellsValidationResults.summary.canImport = wellsValidationResults.summary.willImport > 0 && 
                                                       !wellsValidationResults.planCheck.wouldExceedLimit;
        }
        
        hideBatchProgress();
        
        document.getElementById('wells-upload-step').style.display = 'none';
        document.getElementById('wells-preview-step').style.display = 'block';
        
        renderWellsSummary();
        renderWellsPlanCheck();
        renderWellsPreviewTable();
        updateImportButtonState();
        
    } catch (error) {
        console.error('Wells validation error:', error);
        hideBatchProgress();
        document.getElementById('wells-error-message').textContent = error.message;
        document.getElementById('wells-parse-error').style.display = 'block';
    }
}

// Show batch processing progress
function showBatchProgress(totalRows) {
    cancelBatchProcessing = false;
    
    const html = `
        <div class="bulk-section" id="batch-progress-section">
            <h3 style="margin-bottom: 16px;">Processing ${totalRows} wells in batches...</h3>
            <div class="progress-bar-track" style="margin-bottom: 12px;">
                <div class="progress-bar-fill" id="batch-progress-bar" style="width: 0%;"></div>
            </div>
            <div class="progress-count" id="batch-progress-text">Starting...</div>
            <button class="btn-secondary" style="margin-top: 16px;" onclick="cancelBatchValidation()">Cancel</button>
        </div>
    `;
    
    // Insert progress UI at the top of upload step
    const uploadStep = document.getElementById('wells-upload-step');
    const firstSection = uploadStep.querySelector('.bulk-section');
    firstSection.insertAdjacentHTML('beforebegin', html);
}

// Update batch progress
function updateBatchProgress(current, total, message) {
    const percent = Math.round((current / total) * 100);
    document.getElementById('batch-progress-bar').style.width = `${percent}%`;
    document.getElementById('batch-progress-text').textContent = `${message} (${current}/${total} wells - ${percent}%)`;
}

// Hide batch progress
function hideBatchProgress() {
    const progressSection = document.getElementById('batch-progress-section');
    if (progressSection) {
        progressSection.remove();
    }
}

// Cancel batch validation
function cancelBatchValidation() {
    cancelBatchProcessing = true;
    hideBatchProgress();
}

// Render wells summary badges with enhanced status
function renderWellsSummary() {
    const summary = wellsValidationResults.summary;
    let badges = [];
    
    // Show different badges based on match types
    if (summary.hasApi > 0) badges.push(`<div class="validation-badge badge-valid"> ${summary.hasApi} Direct API</div>`);
    if (summary.exactMatches > 0) badges.push(`<div class="validation-badge badge-valid"> ${summary.exactMatches} Exact Match</div>`);
    if (summary.needsReview > 0) badges.push(`<div class="validation-badge badge-warning"> ${summary.needsReview} Need Review</div>`);
    if (summary.notFound > 0) badges.push(`<div class="validation-badge badge-invalid"> ${summary.notFound} Not Found</div>`);
    if (summary.duplicates > 0) badges.push(`<div class="validation-badge badge-duplicate"> ${summary.duplicates} Already Tracked</div>`);
    
    document.getElementById('wells-validation-summary').innerHTML = badges.join(' ');
}

// Render wells plan check
function renderWellsPlanCheck() {
    const plan = wellsValidationResults.planCheck;
    const wouldExceed = plan.wouldExceedLimit;
    
    const html = `
        <div class="plan-check-box ${wouldExceed ? 'exceeded' : 'ok'}">
            <div class="plan-check-header">
                ${wouldExceed ? ' Would Exceed Plan Limit' : ' Within Plan Limit'}
            </div>
            <div class="plan-check-details">
                Current: ${plan.current} wells  
                Adding: ${wellsValidationResults.summary.willImport}  
                Total: ${plan.afterUpload} of ${plan.limit} (${plan.plan} plan)
            </div>
        </div>
    `;
    document.getElementById('wells-plan-check').innerHTML = html;
    document.getElementById('wells-import-btn').disabled = wouldExceed;
}

// Render enhanced wells preview table with search results
function renderWellsPreviewTable() {
    const tbody = document.getElementById('wells-preview-table-body');
    let html = '';
    wellsSelections = {}; // Reset selections
    
    wellsValidationResults.results.forEach((result, index) => {
        // Determine row styling based on match status
        let rowClass = 'preview-row-valid';
        let statusIcon = '';
        let statusText = 'Ready';
        
        if (result.matchStatus === 'not_found' || result.errors.length > 0) {
            rowClass = 'preview-row-error';
            statusIcon = '';
            statusText = result.errors[0] || 'Not found';
        } else if (result.matchStatus === 'ambiguous') {
            rowClass = 'preview-row-warning';
            statusIcon = '';
            statusText = 'Select';
        } else if (result.isDuplicate) {
            rowClass = 'preview-row-duplicate';
            statusIcon = '';
            statusText = 'Tracked';
        } else if (result.matchStatus === 'exact') {
            statusIcon = '';
            statusText = 'Matched';
        }
        
        // Build CSV data display
        const csvData = [];
        const orig = result.original;
        
        // Extract well name and number with same priority as search function
        // Priority 1: Use WELL_NAME + WELL_NUM (separate fields to combine)
        const wellName = orig.WELL_NAME || orig['Well_Name'] || orig['Well Name'] || 
                        orig.well_name || orig.WellName || orig.wellName || '';
        const wellNumber = orig.WELL_NUM || orig['Well_Num'] || orig['WELL_NUMBER'] || 
                          orig['Well Number'] || orig['well_number'] || orig.WellNumber || 
                          orig.wellNumber || orig.well_num || '';
        
        // Priority logic for well name:
        // 1. If we have separate name and number, combine them
        // 2. Otherwise use 'WELL Name & Number' if available  
        // 3. Do NOT use 'WELL NAME COMBINED' as it includes operator
        let fullWellName = '';
        if (wellName && wellNumber) {
            fullWellName = `${wellName.trim()} ${wellNumber.trim()}`.trim();
        } else {
            fullWellName = orig['WELL Name & Number'] || orig['Well Name & Number'] || wellName || '';
        }
        
        if (fullWellName) csvData.push(`Well: ${fullWellName}`);
        if (orig.Operator || orig.operator || orig.OPERATOR) csvData.push(`Op: ${orig.Operator || orig.operator || orig.OPERATOR}`);
        
        const county = orig.County || orig.county || orig.COUNTY || '';
        if (county) csvData.push(`County: ${county}`);
        
        // Add location with meridian
        if ((orig.Section || orig.SECTION) && (orig.Township || orig.TOWNSHIP) && (orig.Range || orig.RANGE)) {
            // Determine meridian based on county
            const panhandleCounties = ['CIMARRON', 'TEXAS', 'BEAVER'];
            const meridian = county && panhandleCounties.includes(county.toUpperCase()) ? 'CM' : 'IM';
            csvData.push(`Loc: S${orig.Section || orig.SECTION}-T${orig.Township || orig.TOWNSHIP}-R${orig.Range || orig.RANGE}-${meridian}`);
        }
        const csvDisplay = csvData.join(', ') || 'No search data';
        
        // Build matched well display
        let matchedWellHtml = '-';
        let apiNumberHtml = '-';
        let actionHtml = '';
        
        if (result.matchStatus === 'has_api' && result.normalized) {
            matchedWellHtml = escapeHtmlBulk(result.normalized.wellName || 'API provided');
            apiNumberHtml = escapeHtmlBulk(result.normalized.apiNumber);
            actionHtml = result.isDuplicate ? '<span style="color: #6b7280;">Already tracked</span>' : '<span style="color: #22c55e;"> Will add</span>';
        } else if (result.matchStatus === 'exact' && result.searchResults) {
            const match = result.searchResults.matches[0];
            matchedWellHtml = escapeHtmlBulk(match.well_name || '-') + (match.well_number ? ' ' + escapeHtmlBulk(match.well_number) : '');
            apiNumberHtml = escapeHtmlBulk(match.api_number);
            actionHtml = result.isDuplicate ? '<span style="color: #6b7280;">Already tracked</span>' : '<span style="color: #22c55e;"> Will add</span>';
        } else if (result.matchStatus === 'ambiguous' && result.searchResults) {
            // Create dropdown for ambiguous matches
            const selectId = `well-select-${index}`;
            matchedWellHtml = `
                <select id="${selectId}" class="bulk-well-select" onchange="updateWellSelection(${index}, this.value)" style="max-width: 300px;">
                    <option value=""> Select well (${result.searchResults.total} matches) </option>
                    <option value="SKIP"> Skip this well </option>
                    ${result.searchResults.matches.map(m => 
                        `<option value="${m.api_number}">${escapeHtmlBulk(m.well_name)}${m.well_number ? ' ' + escapeHtmlBulk(m.well_number) : ''} - ${m.api_number} - ${m.operator || 'Unknown Op'} - S${m.section}-T${m.township}-R${m.range} - ${m.county} - ${m.well_status || 'UNK'}</option>`
                    ).join('')}
                </select>
            `;
            apiNumberHtml = '<span id="api-' + index + '">-</span>';
            actionHtml = '<span id="action-' + index + '" style="color: #f59e0b;">Select well</span>';
        } else if (result.matchStatus === 'not_found') {
            actionHtml = '<span style="color: #ef4444;">Skip</span>';
        }
        
        html += `
            <tr class="${rowClass}">
                <td>${result.row}</td>
                <td class="status-cell"><span style="font-size: 16px;">${statusIcon}</span></td>
                <td style="font-size: 12px; color: #64748b;">${escapeHtmlBulk(csvDisplay)}</td>
                <td>${matchedWellHtml}</td>
                <td style="font-family: monospace; font-size: 12px;">${apiNumberHtml}</td>
                <td>${actionHtml}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // Show quick actions for files with ambiguous matches
    const hasAmbiguous = wellsValidationResults.results.some(r => r.matchStatus === 'ambiguous');
    if (hasAmbiguous) {
        document.getElementById('wells-quick-actions').style.display = 'block';
    }
}

// Track well selections for ambiguous matches
let wellsSelections = {};

// Update well selection
function updateWellSelection(index, apiNumber) {
    if (apiNumber === 'SKIP') {
        wellsSelections[index] = 'SKIP';
        // Update the display for skipped wells
        document.getElementById(`api-${index}`).textContent = '';
        document.getElementById(`action-${index}`).innerHTML = '<span style="color: #6b7280;">Skip</span>';
    } else if (apiNumber) {
        wellsSelections[index] = apiNumber;
        // Update the API and action display
        document.getElementById(`api-${index}`).textContent = apiNumber;
        document.getElementById(`action-${index}`).innerHTML = '<span style="color: #22c55e;"> Will add</span>';
    } else {
        delete wellsSelections[index];
        document.getElementById(`api-${index}`).textContent = '-';
        document.getElementById(`action-${index}`).innerHTML = '<span style="color: #f59e0b;">Select well</span>';
    }
    
    // Update import button state
    updateImportButtonState();
}

// Select all exact matches for quick import
function selectAllExactMatches() {
    wellsValidationResults.results.forEach((result, index) => {
        if (result.matchStatus === 'ambiguous' && result.searchResults && result.searchResults.matches.length > 0) {
            // Auto-select the first match
            const firstMatch = result.searchResults.matches[0];
            const selectEl = document.getElementById(`well-select-${index}`);
            if (selectEl && selectEl.value === '') {
                selectEl.value = firstMatch.api_number;
                updateWellSelection(index, firstMatch.api_number);
            }
        }
    });
}

// Update import button based on selections
function updateImportButtonState() {
    const summary = wellsValidationResults.summary;
    const needsReview = wellsValidationResults.results.filter(r => r.matchStatus === 'ambiguous' && !r.isDuplicate);
    const selectedCount = Object.keys(wellsSelections).length;
    const allSelected = selectedCount >= needsReview.length;
    
    // Only allow import if all ambiguous wells have selections
    const canImport = summary.canImport && (needsReview.length === 0 || allSelected);
    const btn = document.getElementById('wells-import-btn');
    
    // Update button text to show pending selections
    const pendingSelections = needsReview.length - selectedCount;
    if (pendingSelections > 0) {
        btn.textContent = `Select ${pendingSelections} wells to continue`;
    } else {
        btn.textContent = 'Import Wells';
    }
    
    if (canImport) {
        btn.disabled = false;
        const totalToImport = summary.exactMatches + summary.hasApi + selectedCount;
        btn.textContent = `Import ${totalToImport} Wells`;
    } else if (needsReview.length > selectedCount) {
        btn.disabled = true;
        btn.textContent = `Select ${needsReview.length - selectedCount} more wells`;
    } else {
        btn.disabled = true;
        btn.textContent = 'Import Wells';
    }
}

// Start wells import
async function startWellsImport() {
    document.getElementById('wells-preview-step').style.display = 'none';
    document.getElementById('wells-import-step').style.display = 'block';
    
    // Progress tracking
    const progressBar = document.getElementById('wells-progress-bar');
    progressBar.classList.remove('indeterminate');
    
    // Count total wells to import (excluding skipped)
    const summary = wellsValidationResults.summary;
    const skippedSelections = Object.values(wellsSelections).filter(v => v === 'SKIP').length;
    const totalToImport = summary.exactMatches + summary.hasApi + Object.keys(wellsSelections).length - skippedSelections;
    
    document.getElementById('wells-import-progress').textContent = `Processing ${totalToImport} wells...`;
    
    // Simulate progress since we can't get real-time updates from backend
    let simulatedProgress = 0;
    const progressInterval = setInterval(() => {
        simulatedProgress = Math.min(simulatedProgress + Math.random() * 15, 90);
        progressBar.style.width = simulatedProgress + '%';
        
        // Update message based on progress
        if (simulatedProgress < 30) {
            document.getElementById('wells-import-progress').textContent = `Validating ${totalToImport} wells...`;
        } else if (simulatedProgress < 60) {
            document.getElementById('wells-import-progress').textContent = `Fetching well data from OCC...`;
        } else {
            document.getElementById('wells-import-progress').textContent = `Creating well records...`;
        }
    }, 500);
    
    try {
        // Send all validation results with selections
        const response = await fetch('/api/bulk-upload-wells', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                wells: wellsValidationResults.results,
                selections: wellsSelections 
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Upload failed');
        }
        
        const results = await response.json();
        
        // Clear the progress simulation
        clearInterval(progressInterval);
        
        // Update progress to 100%
        progressBar.style.width = '100%';
        document.getElementById('wells-import-progress').textContent = 'Processing complete!';
        
        // Brief delay to show completion
        await new Promise(resolve => setTimeout(resolve, 500));
        
        showWellsResults(results);
        
    } catch (error) {
        // Clear the progress simulation on error too
        clearInterval(progressInterval);
        console.error('Wells upload error:', error);
        showWellsError(error.message);
    }
}

// Show wells results
function showWellsResults(results) {
    document.getElementById('wells-import-step').style.display = 'none';
    document.getElementById('wells-results-step').style.display = 'block';
    
    const success = results.results.successful;
    const failed = results.results.failed;
    const skipped = results.results.skipped;
    
    document.getElementById('wells-result-created').textContent = success;
    document.getElementById('wells-result-skipped').textContent = skipped;
    document.getElementById('wells-result-failed').textContent = failed;
    
    if (failed === 0 && skipped === 0) {
        document.getElementById('wells-results-icon').textContent = '';
        document.getElementById('wells-results-title').textContent = 'Import Complete!';
        document.getElementById('wells-results-details').textContent = 'Your wells are now being monitored for OCC activity.';
    } else if (failed === 0 && skipped > 0) {
        document.getElementById('wells-results-icon').textContent = '';
        document.getElementById('wells-results-title').textContent = 'Import Completed';
        document.getElementById('wells-results-details').textContent = `${success} wells added successfully. ${skipped} wells were skipped (duplicates, invalid, or no selection made for ambiguous matches).`;
    } else {
        document.getElementById('wells-results-icon').textContent = '';
        document.getElementById('wells-results-title').textContent = 'Import Completed with Errors';
        document.getElementById('wells-results-details').textContent = 'Some wells could not be imported.';
    }
}

// Show wells error
function showWellsError(message) {
    document.getElementById('wells-import-step').style.display = 'none';
    document.getElementById('wells-results-step').style.display = 'block';
    document.getElementById('wells-results-icon').textContent = '';
    document.getElementById('wells-results-title').textContent = 'Import Failed';
    document.getElementById('wells-result-created').textContent = '0';
    document.getElementById('wells-result-skipped').textContent = '0';
    document.getElementById('wells-result-failed').textContent = '';
    document.getElementById('wells-results-details').textContent = message;
}

// Finish wells upload
function finishBulkUploadWells() {
    closeBulkUploadWellsModal();
    loadWells();
}
</script>

<!-- Add Papa Parse library (CSV parsing) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<!-- SheetJS library removed - now using server-side JSON processing -->

<!-- Custom Confirm Dialog -->
<div class="confirm-overlay" id="confirmDialog">
    <div class="confirm-modal">
        <div class="confirm-header">
            <div class="confirm-icon"></div>
            <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
        </div>
        <div class="confirm-body">
            <p class="confirm-message" id="confirmMessage"></p>
        </div>
        <div class="confirm-buttons">
            <button class="confirm-btn confirm-btn-cancel" id="confirmCancel">Cancel</button>
            <button class="confirm-btn confirm-btn-confirm" id="confirmOk">Delete</button>
        </div>
    </div>
</div>

    <script>
// Ensure bulk upload functions are globally accessible
console.log('Dashboard loaded. Checking bulk upload functions...');
console.log('openBulkUploadModal available:', typeof openBulkUploadModal);
console.log('openBulkUploadWellsModal available:', typeof openBulkUploadWellsModal);

// If functions exist but not on window, add them
if (typeof openBulkUploadModal === 'function' && !window.openBulkUploadModal) {
    window.openBulkUploadModal = openBulkUploadModal;
    console.log('Added openBulkUploadModal to window');
}
if (typeof openBulkUploadWellsModal === 'function' && !window.openBulkUploadWellsModal) {
    window.openBulkUploadWellsModal = openBulkUploadWellsModal;
    console.log('Added openBulkUploadWellsModal to window');
}
</script>

</body>
</html>
