<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mineral Watch</title>
    <!-- v2024.12.13.10 - Fixed Import buttons with onclick handlers and added wells modal CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --oil-navy: #1C2B36; --slate-blue: #334E68; --red-dirt: #C05621; --red-dirt-dark: #9C4215; --paper: #F8F9FA; --border: #E2E8F0; --success: #03543F; --success-bg: #DEF7EC; --error: #DC2626; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: var(--oil-navy); background: #F7FAFC; min-height: 100vh; }
        h1, h2, .logo { font-family: 'Merriweather', serif; }
        header { background: var(--oil-navy); padding: 15px 0; color: white; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 25px; }
        .header-inner { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: 900; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 25px; }
        .nav-links a { color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 500; font-size: 14px; }
        .nav-links a:hover, .nav-links a.active { color: white; }
        .user-menu { display: flex; align-items: center; gap: 15px; }
        .user-name { font-size: 14px; color: rgba(255,255,255,0.8); }
        .btn-logout { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer; }
        main { padding: 40px 0; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .page-header h1 { font-size: 28px; margin: 0; line-height: 1.2; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        /* Action Groups with Dividers */
        .action-group { display: flex; gap: 8px; align-items: center; }
        .action-divider { width: 1px; height: 24px; background: var(--border); margin: 0 8px; }
        .btn-add { background: var(--red-dirt); color: white; padding: 10px 16px; border: 1px solid var(--red-dirt); border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; text-decoration: none; transition: all 0.2s; min-width: 100px; }
        .btn-add:hover { background: var(--red-dirt-dark); border-color: var(--red-dirt-dark); }
        
        .btn-secondary-action { background: white; color: var(--slate-blue); border: 1px solid var(--border); padding: 10px 16px; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; min-width: 80px; }
        .btn-secondary-action:hover { border-color: var(--slate-blue); color: var(--oil-navy); background: #f8fafc; }
        .plan-info { background: white; border-radius: 8px; padding: 16px 20px; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-wrap: wrap; }
        .plan-badge { background: var(--success-bg); color: var(--success); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .plan-usage { font-size: 14px; color: var(--slate-blue); display: flex; gap: 20px; flex-wrap: wrap; }
        .usage-item { display: flex; align-items: center; gap: 6px; }
        .upgrade-link { margin-left: auto; color: var(--red-dirt); text-decoration: none; font-size: 14px; font-weight: 600; }
        .stats-card { background: white; border-radius: 8px; padding: 20px 30px; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 40px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-item { text-align: center; }
        .stat-label { display: block; font-size: 12px; color: var(--slate-blue); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .stat-value { display: block; font-size: 24px; font-weight: 700; color: var(--oil-navy); font-family: 'Merriweather', serif; }
        .stat-divider { width: 1px; height: 40px; background: var(--border); }
        .activity-list { padding: 0; }
        .activity-item { display: flex; gap: 16px; padding: 20px; border-bottom: 1px solid var(--border); }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .activity-icon.permit { background: #DBEAFE; }
        .activity-icon.drilling { background: #FEF3C7; }
        .activity-icon.completed { background: #DEF7EC; }
        .activity-icon.transfer { background: #EDE9FE; }
        .activity-icon.status { background: #E0F2FE; }
        .activity-icon.abandoned { background: #F3F4F6; }
        .activity-icon.occ-filing { background: #FEF3C7; }
        .activity-details { flex: 1; }
        .activity-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        .activity-type { font-weight: 600; font-size: 14px; color: var(--oil-navy); }
        .activity-level { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; }
        .activity-level.property { background: #FEE2E2; color: #991B1B; }
        .activity-level.adjacent { background: #FEF3C7; color: #92400E; }
        .activity-level.tracked { background: #CCFBF1; color: #115E59; }
        .activity-well { font-size: 15px; font-weight: 500; margin-bottom: 4px; }
        .activity-meta { font-size: 13px; color: var(--slate-blue); }
        .activity-change { background: var(--paper); padding: 8px 12px; border-radius: 4px; font-size: 13px; margin-top: 8px; display: inline-block; }
        .activity-actions { display: flex; gap: 8px; margin-top: 10px; }
        .activity-btn { display: inline-block; padding: 6px 12px; font-size: 12px; font-weight: 600; text-decoration: none; border-radius: 4px; background: var(--paper); color: var(--slate-blue); border: 1px solid var(--border); transition: all 0.2s; cursor: pointer; }
        .activity-btn:hover { background: #E2E8F0; color: var(--oil-navy); }
        .activity-btn.track-btn { background: white; border-color: var(--red-dirt); color: var(--red-dirt); }
        .activity-btn.track-btn:hover { background: var(--red-dirt); color: white; }
        .activity-date { font-size: 12px; color: #718096; white-space: nowrap; }
        .activity-checkbox { padding: 8px; margin-right: 8px; }
        .activity-checkbox-input { cursor: pointer; width: 16px; height: 16px; }
        .activity-limit-notice { background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 12px 16px; margin: 16px 20px; border-radius: 0 4px 4px 0; font-size: 13px; color: #92400E; }
        .activity-limit-notice a { color: #92400E; font-weight: 600; }
        .tabs { display: flex; gap: 4px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; position: relative; border: 1px solid transparent; display: flex; align-items: center; gap: 8px; }
        
        .tab-icon { width: 16px; height: 16px; opacity: 0.7; }
        .tab.active .tab-icon { opacity: 1; color: var(--red-dirt); }
        .tab.active { background: white; color: var(--oil-navy); border-bottom: 3px solid #3B82F6; border-left: 1px solid var(--border); border-right: 1px solid var(--border); border-top: 1px solid var(--border); box-shadow: none; }
        .tab:not(.active) { background: #f8f9fa; color: #94A3B8; border: 1px solid #e9ecef; opacity: 0.9; }
        .tab:not(.active):hover { background: #f1f3f4; color: #64748B; opacity: 1; border-color: #d6d9dc; }
        .content-card { background: white; border-radius: 0 8px 8px 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .data-table { width: 100%; border-collapse: collapse; }
        #propertiesContent .data-table { table-layout: auto; }
        
        /* Properties Table - Fixed widths for better alignment */
        .col-select { width: 40px; }
        .col-prop-county { width: 120px; }
        .col-prop-legal { width: 160px; }
        .col-prop-group { width: 0; padding: 0 !important; overflow: hidden; visibility: collapse; } /* Hidden by default */
        .col-prop-acres { width: 130px; }
        .col-prop-notes { 
            width: auto;
            min-width: 300px;
            padding-left: 20px !important;
        }
        .col-actions { width: 90px; }
        .col-links { width: 140px; }

        /* Links column styling */
        .links-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            justify-content: flex-end;
        }
        .link-count {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            color: var(--oil-navy);
        }
        .link-count.zero {
            color: #CBD5E1;
        }
        .link-count svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }
        .link-separator {
            color: #E2E8F0;
            font-weight: 300;
        }
        /* Mobile vs Desktop link display */
        .link-breakdown {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .link-total {
            display: none;
            align-items: center;
            gap: 4px;
            color: var(--oil-navy);
            font-weight: 500;
        }
        .link-total.zero {
            color: #CBD5E1;
        }
        .link-total svg {
            width: 16px;
            height: 16px;
        }

        /* When groups are visible, show the column */
        .has-groups .col-prop-group { width: 80px; padding: 16px 16px !important; visibility: visible; }
        
        /* Properties table specific alignments */
        #propertiesContent .data-table th:nth-child(5) { text-align: right; white-space: nowrap; } /* Total Acres header */
        .has-groups #propertiesContent .data-table th:nth-child(5) { text-align: right; white-space: nowrap; } /* Total Acres with groups */
        #propertiesContent .data-table th:last-child { text-align: right; } /* Actions header */
        #propertiesContent .data-table td:last-child { text-align: right; } /* Actions cells */
        
        /* Notes column spacing - using class to avoid nth-child issues */
        .col-prop-notes-cell { padding-left: 50px !important; }
        
        /* Desktop styles for "Total Acres" header */
        span.mobile-only-acres {
            display: none;
        }
        span.desktop-only-total {
            display: inline;
        }
        
        /* Notes cell styling with 2-line clamp */
        .notes-cell {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
            word-break: break-word;
        }
        
        /* Map link button */
        .btn-map-link { 
            background: var(--paper); 
            border: 1px solid var(--border); 
            color: var(--slate-blue); 
            padding: 4px 10px; 
            border-radius: 4px; 
            font-size: 12px; 
            cursor: pointer; 
            transition: all 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .btn-map-link:hover { 
            background: #E2E8F0; 
            border-color: var(--slate-blue); 
            color: var(--oil-navy);
        }
        
        /* Wells table specific column widths - desktop */
        #wellsContent .data-table { table-layout: fixed; }
        .col-well-info { width: 45%; }
        .col-well-operator { width: calc(100% - 45% - 80px - 40px - 40px); }
        .col-well-map { width: 80px; }
        
        /* Expandable well table styles */
        .wells-expandable .well-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .wells-expandable .well-row:hover {
            background-color: #F8FAFC;
        }
        .wells-expandable .well-row.expanded {
            background-color: #F0F9FF;
        }
        .well-name-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .well-details-line {
            font-size: 13px;
            color: #6B7280;
        }
        .well-details-line .well-api {
            font-family: monospace;
            color: #64748B;
        }
        .well-details-line .well-status {
            font-weight: 600;
            color: var(--slate-blue);
        }
        .well-details-line .well-status.status-active {
            color: var(--success);
        }
        .well-details-line .well-formation {
            color: #8B5CF6;
        }
        .well-details-line .well-firstprod {
            color: #0891B2;
        }
        .expand-icon {
            color: #94A3B8;
            font-size: 10px;
            transition: transform 0.2s;
        }
        .well-row.expanded .expand-icon {
            transform: rotate(180deg);
        }
        .well-expanded-row td {
            padding: 0 !important;
            background: #F8FAFC;
        }
        .well-expanded-card {
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        
        /* Add extra left padding to Notes column for visual separation */
        /* Notes is 5th column: checkbox(1), county(2), legal(3), acres(4), notes(5), actions(6) */
        #propertiesContent .data-table td:nth-child(5),
        #propertiesContent .data-table th:nth-child(5) {
            padding-left: 45px;
        }
        
        /* Right-align Total Acres header to match the values */
        #propertiesContent .data-table th:nth-child(4) {
            text-align: right;
        }
        
        /* Wells Table - just adjust Well Name spacing to match Properties */
        #wellsContent .data-table td:nth-child(2),
        #wellsContent .data-table th:nth-child(2) {
            padding-left: 15px;
        }
        
        .col-location { width: 15%; }
        .data-table th { background: var(--paper); text-align: left; padding: 14px 16px; font-size: 12px; font-weight: 600; color: var(--slate-blue); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
        .data-table td { padding: 16px 16px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: top; }
        
        /* Reduce padding on specific columns to minimize gaps */
        .has-groups .col-prop-group { padding-right: 12px !important; }
        .has-groups td.col-prop-group { padding-right: 12px !important; }
        .data-table td[style*="text-align: right"] { padding-left: 12px; }
        
        /* Accordion row - ensure it spans properly and has height */
        .accordion-row {
            height: auto !important;
        }
        
        .accordion-row td {
            width: 100% !important;
            min-width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            min-height: 300px !important;
            vertical-align: top !important;
            line-height: normal !important;
        }
        
        .production-accordion {
            width: 100% !important;
            display: block !important;
            min-height: 300px !important;
            height: auto !important;
        }
        
        /* Desktop: maintain two-column layout */
        .production-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        /* Desktop: maintain grid layouts */
        .prod-stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .timeline-stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        /* Desktop: Clean row layout */
        .production-term {
            display: block;
        }
        
        .production-term > div:first-child {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            width: 100%;
        }
        
        /* Hide inline explanations on desktop */
        .production-explanation {
            display: none;
        }
        
        /* Mobile responsive styling */
        @media (max-width: 768px) {
            .production-sections {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }
            
            /* Stack the grid items vertically on mobile with aligned values */
            .prod-stats, .timeline-stats {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            
            /* Mobile click-to-expand for production terms */
            .production-accordion-floating .hover-helper {
                cursor: pointer;
                position: relative;
            }
            
            .production-term-expanded {
                background: #E0F2FE !important;
                margin: 4px 0;
                padding: 8px;
                border-radius: 4px;
                border-left: 3px solid var(--red-dirt);
            }
            
            /* Show explanations on mobile */
            .production-explanation {
                display: none;
                font-size: 12px;
                color: var(--slate-blue);
                margin-top: 4px;
                padding-top: 4px;
                border-top: 1px solid #E5E7EB;
                line-height: 1.3;
            }
            
            .production-explanation.expanded {
                display: block;
            }
            
            /* Fix production header layout on mobile */
            .production-accordion-floating .production-header {
                flex-wrap: wrap !important;
            }
            
            .production-accordion-floating .production-header > div:last-child {
                width: 100%;
                justify-content: center;
                margin-top: 8px;
            }
        }
        .data-table tr:last-child td { border-bottom: none; }
        .status-active { color: var(--success); font-weight: 600; }
        .btn-link { background: none; border: none; color: var(--red-dirt); cursor: pointer; font-size: 13px; text-decoration: underline; margin-right: 12px; }
        .btn-link:hover { color: var(--red-dirt-dark); }
        .btn-delete { background: none; border: none; color: #94A3B8; cursor: pointer; font-size: 13px; padding: 4px; border-radius: 4px; transition: all 0.2s; }
        .btn-delete:hover { color: #DC2626; background: #FEE2E2; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--slate-blue); }
        .empty-state p { margin-bottom: 20px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        
        /* Ensure detail modals appear above sticky filter bars - diagnostic test */
        #wellDetailsModal,
        #propertyDetailsModal {
            position: fixed !important;
            z-index: 999999 !important;
            isolation: isolate !important;
        }
        
        /* Remove position relative to prevent stacking context conflicts */
        #wellDetailsModal .well-card,
        #propertyDetailsModal .property-card {
            /* Remove position: relative to prevent stacking context issues */
            position: static !important;
            z-index: auto !important;
        }
        /* Ensure bulk upload modal overlay displays correctly when opened */
        #bulk-upload-modal { 
            display: none; 
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 9999 !important;
            background: rgba(0,0,0,0.7) !important;
        }
        #bulk-upload-modal[style*="flex"] { 
            display: flex !important; 
            align-items: center !important;
            justify-content: center !important;
        }
        #bulk-upload-wells-modal { 
            display: none; 
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 9999 !important;
            background: rgba(0,0,0,0.7) !important;
        }
        #bulk-upload-wells-modal[style*="flex"] { 
            display: flex !important; 
            align-items: center !important;
            justify-content: center !important;
        }
        .modal { background: white; border-radius: 8px; padding: 30px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal h2 { margin-bottom: 20px; }
        
        /* Tab Navigation */
        .tab-nav { display: flex; margin-bottom: 24px; border-bottom: 1px solid #e2e8f0; }
        .tab-btn { background: none; border: none; padding: 12px 16px; cursor: pointer; color: #64748b; font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn:hover { color: var(--oil-navy); }
        .tab-btn.active { color: var(--oil-navy); border-bottom-color: var(--oil-navy); font-weight: 600; }
        
        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Search Form */
        .search-form { }
        .form-row { display: flex; gap: 12px; margin-bottom: 16px; }
        .form-row .form-group { flex: 1; }
        .form-group.full { width: 100%; }
        
        /* Search Buttons */
        .search-buttons { display: flex; gap: 12px; margin-top: 20px; }
        .btn-search { background: var(--oil-navy); color: white; padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-search:hover { background: var(--oil-navy-dark, #1a365d); }
        .btn-clear { background: #e2e8f0; color: #475569; padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-clear:hover { background: #cbd5e1; }
        
        /* Search Results */
        .search-results { margin-top: 24px; border-top: 1px solid #e2e8f0; padding-top: 20px; }
        .results-header { display: flex; justify-content: between; align-items: center; margin-bottom: 16px; }
        .results-header h3 { margin: 0; color: var(--oil-navy); font-size: 16px; }
        .results-info { color: #64748b; font-size: 13px; }
        .results-list { max-height: 300px; overflow-y: auto; }
        
        /* Result Item */
        .result-item { border: 1px solid #e2e8f0; border-radius: 6px; padding: 16px; margin-bottom: 12px; transition: all 0.2s; }
        .result-item:hover { border-color: var(--oil-navy); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .result-well-name { font-weight: 600; color: var(--oil-navy); font-size: 14px; margin: 0; }
        .result-status { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .result-status.active { background: #dcfce7; color: #166534; }
        .result-status.plugged { background: #fef3c7; color: #92400e; }
        .result-status.other { background: #e2e8f0; color: #475569; }

        /* OCC Filings Styles */
        .occ-filing-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 12px 0; border-bottom: 1px solid #eee; }
        .occ-filing-item:last-child { border-bottom: none; }
        .occ-filing-main { flex: 1; }
        .occ-filing-type { font-weight: 600; color: #1a1a2e; font-size: 13px; }
        .occ-filing-applicant { color: #666; font-size: 13px; margin-top: 2px; }
        .occ-filing-details { display: flex; gap: 12px; margin-top: 4px; font-size: 12px; color: #888; flex-wrap: wrap; }
        .occ-filing-case { font-family: monospace; }
        .occ-filing-status { padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 500; }
        .occ-filing-status.heard { background: #d4edda; color: #155724; }
        .occ-filing-status.continued { background: #fff3cd; color: #856404; }
        .occ-filing-status.scheduled { background: #cce5ff; color: #004085; }
        .occ-filing-status.dismissed { background: #f8d7da; color: #721c24; }
        .occ-filing-status.filed { background: #e2e3e5; color: #383d41; }
        .occ-filing-date { text-align: right; font-size: 12px; color: #888; min-width: 70px; }
        .occ-filing-link { color: #2563eb; text-decoration: none; font-size: 14px; margin-left: 8px; }
        .occ-filing-link:hover { text-decoration: underline; }
        .occ-hearing-warning { color: #dc3545; margin-right: 4px; }
        .occ-adjacent-note { font-size: 11px; color: #888; font-style: italic; margin-left: 4px; }

        /* Process & Extract Button */
        .occ-filing-actions { display: flex; align-items: center; gap: 8px; margin-left: 12px; }
        .occ-process-btn {
            background: #2563eb;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .occ-process-btn:hover { background: #1d4ed8; }
        .occ-process-btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .occ-process-btn.fetching { background: #8b5cf6; } /* purple - fetching from OCC */
        .occ-process-btn.queued { background: #f59e0b; } /* amber - waiting in queue */
        .occ-process-btn.processing { background: #6366f1; } /* indigo - processing */
        .occ-process-btn.complete { background: #10b981; } /* green - complete */
        .occ-process-btn.error { background: #ef4444; } /* red - error */
        .occ-process-btn .spinner-sm {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 4px;
            vertical-align: middle;
        }
        .occ-view-doc-link {
            color: #10b981;
            font-size: 12px;
            text-decoration: none;
            font-weight: 500;
        }
        .occ-view-doc-link:hover { text-decoration: underline; }
        .occ-pending-text {
            color: #9ca3af;
            font-size: 12px;
            font-style: italic;
            cursor: help;
        }
        .occ-process-btn.complete {
            background: #10b981;
            cursor: pointer;
        }
        .occ-process-btn.complete:hover { background: #059669; }

        .result-details { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; color: #64748b; font-size: 13px; margin-bottom: 12px; }
        .result-detail { }
        .result-detail strong { color: #374151; }
        .btn-select { background: var(--red-dirt); color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-select:hover { background: var(--red-dirt-dark); }
        
        /* Search Loading */
        .search-loading { text-align: center; padding: 40px; color: #64748b; }
        .search-loading .spinner { width: 24px; height: 24px; border: 2px solid #e2e8f0; border-top: 2px solid var(--oil-navy); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Well Card Modal Styles */
        .well-card { background: white; border-radius: 12px; overflow: hidden; max-width: 520px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: calc(100vh - 40px); overflow-y: auto; }
        
        /* Property Card Modal Styles - Orange Theme */
        .property-card { background: white; border-radius: 12px; overflow: hidden; max-width: 520px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: calc(100vh - 40px); overflow-y: auto; }
        
        /* Card Header - Blue for Wells */
        .card-header { background: linear-gradient(135deg, var(--oil-navy) 0%, var(--slate-blue) 100%); color: white; padding: 20px 24px; position: relative; }
        
        /* Property Card Header - Orange for Land */
        .property-card-header { background: linear-gradient(135deg, var(--red-dirt) 0%, var(--red-dirt-dark) 100%); color: white; padding: 20px 24px; position: relative; }
        .card-header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; margin-top: 8px; }
        .well-name { font-family: 'Merriweather', serif; font-size: 20px; font-weight: 700; margin: 0; }
        .property-name { font-family: 'Merriweather', serif; font-size: 20px; font-weight: 700; margin: 0; }
        .date-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-top: 4px; }
        .api-number { font-size: 13px; opacity: 0.8; }
        .property-location { font-size: 13px; opacity: 0.8; }
        .acreage-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-top: 4px; }
        .close-btn { position: absolute; top: 12px; right: 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 32px; height: 32px; border-radius: 6px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .close-btn:hover { background: rgba(255,255,255,0.2); }
        
        /* Card Content */
        .card-content { padding: 20px 24px; }
        
        /* Status Row */
        .status-row { display: flex; gap: 24px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .status-item { display: flex; flex-direction: column; gap: 6px; }
        .status-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--slate-blue); }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 700; background: var(--success-bg); color: var(--success); }
        .status-badge.horizontal { background: #DBEAFE; color: #1E40AF; }
        .status-value { font-size: 14px; font-weight: 600; color: var(--oil-navy); }
        
        /* Info Sections */
        .info-section { margin-bottom: 16px; }
        .info-section:last-child { margin-bottom: 0; }
        .section-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--slate-blue); margin-bottom: 6px; }
        .section-value { font-size: 15px; font-weight: 500; color: var(--oil-navy); }
        .section-value a { color: var(--red-dirt); text-decoration: none; }
        .section-value a:hover { text-decoration: underline; }
        .contact-line { font-size: 14px; color: var(--slate-blue); margin-top: 2px; }
        
        /* Two Column Grid */
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        
        /* Production Section */
        .production-section { background: var(--paper); border-radius: 8px; padding: 16px; margin-top: 16px; }
        .production-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .production-title { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--oil-navy); }
        .formation-badge { background: white; border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; color: var(--slate-blue); }
        .production-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .production-item { text-align: center; }
        .production-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: var(--slate-blue); margin-bottom: 4px; }
        .production-value { font-size: 16px; font-weight: 700; color: var(--oil-navy); }
        .production-unit { font-size: 11px; font-weight: 500; color: var(--slate-blue); }
        
        /* Dates Row */
        .dates-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
        .date-item { text-align: center; }
        .date-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: var(--slate-blue); margin-bottom: 2px; }
        .date-value { font-size: 12px; font-weight: 600; color: var(--oil-navy); }
        
        /* Card Footer Actions */
        .card-footer { padding: 16px 24px 24px; display: flex; gap: 12px; }
        .action-btn { flex: 1; padding: 12px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; text-decoration: none; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; border: none; }
        .action-btn.primary { background: var(--red-dirt); color: white; }
        .action-btn.primary:hover { background: var(--red-dirt-dark); }
        .action-btn.primary.well-blue { background: var(--slate-blue); }
        .action-btn.primary.well-blue:hover { background: var(--oil-navy); }
        .action-btn.secondary { background: white; color: var(--red-dirt); border: 1px solid var(--red-dirt); }
        .action-btn.secondary:hover { background: #FFF5F0; }
        .action-btn.outline { background: white; color: var(--slate-blue); border: 1px solid var(--border); }
        .action-btn.outline:hover { border-color: var(--slate-blue); color: var(--oil-navy); }
        
        /* Mobile Responsive */
        @media (max-width: 480px) {
            .modal-overlay { padding: 10px; align-items: flex-start; padding-top: 20px; }
            .well-card { max-width: 100%; max-height: calc(100vh - 40px); margin: 0; }
            .two-col { grid-template-columns: 1fr; gap: 12px; }
            .production-grid { grid-template-columns: repeat(2, 1fr); }
            .dates-row { grid-template-columns: 1fr; }
            .card-footer { flex-direction: column; }
            .status-row { flex-wrap: wrap; gap: 16px; }
            .close-btn { top: 12px; right: 12px; width: 36px; height: 36px; font-size: 18px; }
        }
        
        /* Delete Modal Specifics */
        .delete-icon-wrapper { width: 48px; height: 48px; border-radius: 50%; background: #FEE2E2; color: #DC2626; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
        .delete-warning-text { text-align: center; color: var(--slate-blue); font-size: 15px; margin-bottom: 24px; line-height: 1.5; }
        
        /* Custom Confirm Dialog */
        .confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .confirm-overlay.show {
            display: flex;
        }
        
        .confirm-modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: confirmSlideIn 0.2s ease-out;
        }
        
        @keyframes confirmSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .confirm-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .confirm-icon {
            width: 40px;
            height: 40px;
            background: #FEE2E2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .confirm-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--oil-navy);
            margin: 0;
        }
        
        .confirm-body {
            margin-bottom: 24px;
        }
        
        .confirm-message {
            color: var(--slate-blue);
            font-size: 15px;
            line-height: 1.5;
            margin: 0;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .confirm-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .confirm-btn-cancel {
            background: #F3F4F6;
            color: var(--slate-blue);
        }
        
        .confirm-btn-cancel:hover {
            background: #E5E7EB;
        }
        
        .confirm-btn-confirm {
            background: #DC2626;
            color: white;
        }
        
        .confirm-btn-confirm:hover {
            background: #B91C1C;
        }
        
        /* Bulk Selection Styles */
        .bulk-checkbox-column { width: 50px; text-align: center; }
        .bulk-checkbox { cursor: pointer; width: 16px; height: 16px; }
        .bulk-action-bar {
            display: none;
            background: linear-gradient(135deg, #FEF3C7 0%, #FED7AA 100%);
            border: 2px solid #F59E0B;
            border-radius: 8px;
            padding: 16px 24px;
            margin-bottom: 20px;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            position: sticky;
            top: 10px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .bulk-action-bar.active { display: flex; }
        
        .bulk-count {
            color: var(--oil-navy);
            font-size: 15px;
            font-weight: 700;
        }
        
        .bulk-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .bulk-btn {
            background: var(--red-dirt);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bulk-btn:hover:not(:disabled) {
            background: var(--red-dirt-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(192, 86, 33, 0.3);
        }
        
        .bulk-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Add loading state */
        .bulk-btn.loading {
            position: relative;
            color: transparent;
        }
        
        .bulk-btn.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spinner 0.6s linear infinite;
        }
        
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        
        .bulk-clear { color: var(--slate-blue); text-decoration: underline; cursor: pointer; font-size: 13px; }
        .bulk-clear:hover { color: var(--oil-navy); }
        
        /* OCC Warning Tooltip */
        .occ-warning {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        
        .occ-warning-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            margin-left: 6px;
            background: #F59E0B;
            color: white;
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
        }
        
        .occ-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1F2937;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
            width: 280px;
            margin-bottom: 8px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .occ-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1F2937;
        }
        
        .occ-warning:hover .occ-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            min-width: 300px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .toast-show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .toast-success {
            border-left: 4px solid var(--success);
        }
        
        .toast-success .toast-icon {
            background: var(--success-bg);
            color: var(--success);
        }
        
        .toast-error {
            border-left: 4px solid #DC2626;
        }
        
        .toast-error .toast-icon {
            background: #FEE2E2;
            color: #DC2626;
        }
        
        .toast-info {
            border-left: 4px solid #3B82F6;
        }
        
        .toast-info .toast-icon {
            background: #DBEAFE;
            color: #3B82F6;
        }
        
        .toast-message {
            color: var(--oil-navy);
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
        }

        /* Custom Confirm Modal */
        .confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(28, 43, 54, 0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .confirm-overlay.show {
            display: flex;
        }

        .confirm-modal {
            background: white;
            border-radius: 12px;
            padding: 0;
            width: 90%;
            max-width: 440px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                transform: translateY(20px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .confirm-header {
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid var(--border);
        }

        .confirm-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #FEE2E2;
            color: #DC2626;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 24px;
        }

        .confirm-title {
            font-family: 'Merriweather', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--oil-navy);
            text-align: center;
            margin: 0;
        }

        .confirm-body {
            padding: 20px 24px;
        }

        .confirm-message {
            color: var(--slate-blue);
            font-size: 15px;
            line-height: 1.6;
            text-align: center;
            margin: 0;
        }

        .confirm-count {
            display: inline-block;
            background: var(--paper);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 700;
            color: var(--oil-navy);
        }

        .confirm-buttons {
            padding: 16px 24px 24px 24px;
            display: flex;
            gap: 12px;
        }

        .confirm-btn {
            flex: 1;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: inherit;
        }

        .confirm-btn-cancel {
            background: white;
            color: var(--slate-blue);
            border: 1px solid var(--border);
        }

        .confirm-btn-cancel:hover {
            background: var(--paper);
            border-color: var(--slate-blue);
        }

        .confirm-btn-confirm {
            background: #DC2626;
            color: white;
        }

        .confirm-btn-confirm:hover {
            background: #B91C1C;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        .data-table tr.selected { background-color: #F0F9FF; }
        .data-table tr.selected td { border-color: #BFDBFE; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group.full { grid-column: span 2; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; }
        .form-group textarea { resize: vertical; min-height: 60px; }
        .form-hint { font-size: 12px; color: var(--slate-blue); margin-top: 4px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; }
        .btn-cancel { padding: 10px 20px; border: 1px solid var(--border); background: white; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-submit { padding: 10px 20px; background: var(--red-dirt); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .details-grid { display: flex; flex-direction: column; gap: 12px; }
        .details-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .details-row:last-child { border-bottom: none; }
        .details-label { font-size: 13px; color: var(--slate-blue); font-weight: 500; }
        .details-value { font-size: 14px; color: var(--oil-navy); font-weight: 500; text-align: right; max-width: 60%; }
        .details-actions { display: flex; gap: 10px; margin-top: 20px; }
        .details-btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; font-size: 13px; font-weight: 600; text-decoration: none; border-radius: 4px; background: var(--paper); color: var(--slate-blue); border: 1px solid var(--border); flex: 1; text-align: center; }
        .details-btn:hover { background: #E2E8F0; }
        .details-btn.primary { background: var(--red-dirt); color: white; border-color: var(--red-dirt); }
        .details-btn.primary:hover { background: var(--red-dirt-dark); }
        
        /* Modal close button (X) */
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--slate-blue);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .modal-close:hover {
            background: #E2E8F0;
            color: var(--oil-navy);
        }

        /* Manual document link item hover */
        .manual-link-doc-item:hover {
            background: #F0F9FF !important;
        }
        .manual-link-doc-item:last-child {
            border-bottom: none !important;
        }

        /* Text links for Details and Prod */
        .text-link { 
            color: var(--sky-blue); 
            text-decoration: none; 
            font-size: 13px; 
            font-weight: 600;
            padding: 0 4px;
        }
        .text-link:hover { 
            color: var(--red-dirt); 
            text-decoration: underline; 
        }
        
        /* Hover Helpers */
        .hover-helper { 
            border-bottom: 1px dashed var(--slate-blue); 
            cursor: help; 
            position: relative;
        }
        
        .hover-helper::after {
            content: attr(title);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--oil-navy);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            max-width: 250px;
            white-space: normal;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .hover-helper::before {
            content: '';
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--oil-navy);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        
        .hover-helper:hover::after,
        .hover-helper:hover::before {
            opacity: 1;
            visibility: visible;
        }
        
        /* Disable CSS pseudo-element tooltips for production accordion - we use JS tooltips on desktop and click expansion on mobile */
        .production-accordion-floating .hover-helper::after,
        .production-accordion-floating .hover-helper::before {
            display: none !important;
        }
        
        /* Fix formation badge spacing */
        .formation-badge {
            white-space: nowrap;
        }
        
        footer { background: var(--oil-navy); color: #A0AEC0; padding: 20px 0; font-size: 13px; text-align: center; margin-top: auto; }
        @media (max-width: 768px) { 
            .form-row { grid-template-columns: 1fr; } 
            .form-group.full { grid-column: span 1; } 
            
            /* Mobile navigation - match Learn page style */
            .header-inner {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                gap: 20px;
            }
            
            /* Reset table layout for mobile */
            #propertiesContent .data-table, 
            #wellsContent .data-table { 
                table-layout: auto !important; 
            }
            
            /* Remove fixed widths on mobile - let content flow naturally */
            .col-select,
            .col-prop-county,
            .col-prop-legal,
            .col-prop-acres,
            .col-prop-notes,
            .col-well-info,
            .col-well-operator,
            .col-well-map,
            .col-well-name-wide,
            .col-well-county,
            .col-well-location,
            .col-actions,
            .col-links {
                width: auto !important;
            }

            /* Mobile: Show total count, hide breakdown */
            .link-breakdown {
                display: none !important;
            }
            .link-total {
                display: flex !important;
            }
            
            /* Ensure minimum widths for readability */
            #propertiesContent .data-table td:nth-child(2) { min-width: 80px; } /* County */
            #propertiesContent .data-table td:nth-child(3) { 
                min-width: 100px; /* Legal - increased to prevent wrapping */
                white-space: nowrap; /* Prevent section number from wrapping */
            }
            #propertiesContent .data-table td:nth-child(4) { min-width: 50px; } /* Acres */
            #propertiesContent .data-table td:nth-child(5) { min-width: 100px; } /* Notes */
            
            /* Wells table specific mobile adjustments */
            #wellsContent .col-well-map { 
                min-width: 80px !important; /* Ensure map button has space */
                text-align: right !important;
            }
            #wellsContent .col-well-info {
                max-width: 50%; /* Prevent well info from taking too much space */
            }
            
            /* Hide "Total" from "Total Acres" header on mobile to save space */
            span.mobile-only-acres {
                display: inline;
            }
            span.desktop-only-total {
                display: none;
            }
            
            /* Adjust padding for mobile */
            #propertiesContent .data-table td:nth-child(5) {
                padding-left: 8px !important;
            }
            
            /* Make action buttons smaller on mobile */
            #propertiesContent .data-table td:nth-child(6) {
                white-space: nowrap;
                font-size: 13px;
            }
            
            /* Mobile navigation */
            .nav-links {
                gap: 15px;
            }
            .nav-links a {
                font-size: 13px;
            } 
            
            /* Hide checkboxes and bulk actions completely on mobile */
            .bulk-only,
            .bulk-action-bar,
            th.bulk-only,
            td.bulk-only,
            .bulk-checkbox,
            .bulk-checkbox-column,
            .activity-checkbox,
            .activity-checkbox-input,
            #activityBulkBar {
                display: none !important;
            }

            /* Documents tab mobile optimizations */
            /* Hide Upload button - will add back as camera capture later */
            #documents-tab > div:first-child .btn-add,
            #documents-tab > div:first-child #relinkDocumentsBtn {
                display: none !important;
            }

            /* Hide Actions column in documents table - tap row to open detail */
            #documentsContent .data-table th:last-child,
            #documentsContent .data-table td:last-child {
                display: none !important;
            }

            /* Tighten credit display area on mobile */
            #documents-tab > div:first-child {
                padding: 12px 16px !important;
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px;
            }
            #documents-tab .credit-display-container {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            #documents-tab .credit-display-container .credit-separator:first-child {
                display: none;
            }
            #documents-tab .credit-info {
                font-size: 12px;
            }
            #documents-tab .credit-progress {
                width: 100%;
                max-width: 200px;
            }
            #documents-tab .credit-details {
                font-size: 11px;
            }
            #documents-tab h3 {
                font-size: 16px !important;
            }
            
            /* Adjust activity item layout without checkbox */
            .activity-item {
                padding-left: 20px;
            }
            
            /* Mobile table optimization */
            .data-table { 
                font-size: 12px;
            } 
            .data-table th, .data-table td { 
                padding: 8px 6px;
                vertical-align: top;
            }
            
            /* Mobile expandable cards */
            .well-cards-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            .well-details-content {
                padding: 15px !important;
            }
            
            .well-card {
                padding: 12px !important;
            }
            
            .well-card-title {
                font-size: 12px !important;
                margin-bottom: 8px !important;
            }
            
            .well-card-content {
                font-size: 12px !important;
            }
            
            .well-card-row {
                margin-bottom: 4px !important;
            }
            
            /* Mobile hover helpers */
            .hover-helper::after {
                position: fixed;
                bottom: auto;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 280px;
                white-space: normal;
                text-align: left;
                z-index: 9999;
            }
            
            .hover-helper::before {
                display: none;
            }
            
            /* Hide bulk selection on mobile */
            .bulk-only { display: none !important; }
            .col-well-name { width: 30%; }
            .col-well-name-wide { width: 37%; } /* Even more space on mobile for readability */
            .col-well-operator { width: 28%; } /* Well-specific operator mobile styling */
            .col-well-county { width: 15%; } /* Well-specific county mobile styling */
            .col-well-location { width: 15%; } /* Well-specific location mobile styling */
            .col-operator { width: 25%; } /* Legacy operator mobile styling */
            .col-api { display: none; } /* Hide API column on mobile */
            .col-county { width: 20%; }
            .col-location { width: 15%; }
            .col-actions { width: 20%; } /* More space for buttons on mobile */
            
            /* Hide API column headers and cells specifically on mobile */
            .data-table th:nth-child(4),
            .data-table td:nth-child(4) {
                display: none; /* Hide 4th column (API) on mobile */
            }
            
            /* Hide delete button on mobile - too cramped */
            .btn-delete { display: none; }
            
            /* Properties table mobile adjustments */
            #propertiesContent .data-table th:nth-child(5) { 
                white-space: normal !important; /* Allow "Total Acres" to wrap on mobile */
                line-height: 1.2;
                text-align: center !important; /* Center align on mobile */
                padding-left: 0 !important;
            }
            
            /* Adjust Actions header alignment on mobile */
            #propertiesContent .data-table th:last-child {
                text-align: center !important;
            }
            
            /* Properties table column adjustments on mobile */
            #propertiesContent .col-prop-county { width: 23%; }
            #propertiesContent .col-prop-legal { width: 32%; }
            #propertiesContent .col-prop-acres { width: 20%; padding-left: 5px !important; }
            #propertiesContent .col-prop-group { display: none; } /* Hide group on mobile */
            #propertiesContent .col-prop-notes { display: none; } /* Hide notes on mobile */
            #propertiesContent .col-actions { width: 25%; }
            
            /* Center the acres values on mobile */
            #propertiesContent .data-table td:nth-child(5) {
                text-align: center !important;
                padding-left: 5px !important;
            }
            
            /* Hide notes and group columns on mobile for properties */
            #propertiesContent .col-prop-notes-cell,
            #propertiesContent .col-prop-group {
                display: none;
            }
            
            /* Ensure map button is visible on mobile */
            #propertiesContent .btn-map-link {
                display: inline-flex !important;
                padding: 6px 10px;
                font-size: 12px;
            }
            
            /* Mobile header improvements */
            .page-header { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 15px; 
            }
            .page-header h1 { 
                font-size: 24px; 
                margin-bottom: 5px; 
            }
            .header-actions { 
                flex-direction: column; 
                width: 100%; 
                gap: 8px;
            }
            .action-group {
                width: 100%;
            }
            .btn-add { 
                width: 100%; 
                justify-content: center; 
                padding: 12px 16px;
            }
            .btn-secondary-action {
                width: 100%;
                justify-content: center;
            }
            .action-divider { display: none; }
            
            /* Plan info mobile */
            .plan-info { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 10px; 
            }
            .plan-usage { 
                gap: 15px; 
                width: 100%;
            }
            .upgrade-link { 
                margin-left: 0; 
                align-self: flex-start;
            }
            
            /* Stats card mobile */
            .stats-card { 
                flex-direction: column; 
                gap: 15px; 
                padding: 15px 20px; 
            }
            .stat-divider { 
                width: 60px; 
                height: 1px; 
            }
            .stat-value { 
                font-size: 20px; 
            }
            
            /* Activity mobile */
            .activity-item { 
                flex-direction: column; 
                gap: 12px; 
                padding: 15px;
            }
            .activity-header { 
                flex-direction: column; 
                gap: 8px; 
            }
            .activity-date { 
                align-self: flex-start; 
            }
            .activity-actions {
                flex-wrap: wrap;
                gap: 6px;
            }
            .activity-btn {
                font-size: 11px;
                padding: 4px 8px;
            }
            
            /* Tabs mobile */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 2px;
            }
            .tab {
                flex-shrink: 0;
                padding: 10px 16px;
                font-size: 13px;
            }
            .tab-icon {
                width: 14px;
                height: 14px;
            }
            
            /* Modal mobile */
            .modal {
                margin: 10px;
                width: calc(100vw - 20px);
                max-width: none;
            }
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Toast mobile */
            .toast {
                left: 20px;
                right: 20px;
                min-width: auto;
            }
        }
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        /* Skeleton styling */
        .skeleton {
            background: linear-gradient(90deg, #F3F4F6 25%, #E5E7EB 50%, #F3F4F6 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
        }
        /* Skeleton loading states - Updated 2024-12-13 */
        .skeleton-table { padding: 20px; }
        .skeleton-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .skeleton-cell {
            height: 16px;
        }
        .skeleton-cell.narrow { width: 80px; }
        .skeleton-cell.medium { width: 150px; }
        .skeleton-header { display: flex; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .skeleton-header .skeleton-cell { height: 14px; opacity: 0.5; }
        .skeleton-activity { padding: 20px; display: flex; gap: 16px; border-bottom: 1px solid var(--border); }
        .skeleton-activity:last-child { border-bottom: none; }
        .skeleton-avatar { width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; }
        .skeleton-activity-content { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .skeleton-line { height: 16px; }
        .skeleton-line.short { width: 40%; }
        .skeleton-line.medium { width: 60%; }
        .skeleton-line.long { width: 85%; }
        
        /* Search and Sort Controls */
        .table-controls {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            background: var(--paper);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--red-dirt);
        }
        .search-input::placeholder {
            color: #94a3b8;
        }
        .sort-select {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            cursor: pointer;
            min-width: 160px;
        }
        .sort-select:focus {
            outline: none;
            border-color: var(--red-dirt);
        }

        /* Searchable Dropdown Styles */
        .searchable-dropdown {
            position: relative;
            display: inline-block;
        }
        .searchable-dropdown-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            cursor: pointer;
            min-width: 180px;
            text-align: left;
            color: inherit;
        }
        .searchable-dropdown-trigger:hover {
            border-color: #9CA3AF;
        }
        .searchable-dropdown-trigger:focus {
            outline: none;
            border-color: var(--red-dirt);
        }
        .searchable-dropdown-trigger .dropdown-label {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .searchable-dropdown-trigger svg {
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .searchable-dropdown.open .searchable-dropdown-trigger svg {
            transform: rotate(180deg);
        }
        .searchable-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 240px;
            max-height: 320px;
            overflow: hidden;
            flex-direction: column;
        }
        .searchable-dropdown.open .searchable-dropdown-menu {
            display: flex;
        }
        .dropdown-search-wrapper {
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        .dropdown-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
        }
        .dropdown-search:focus {
            outline: none;
            border-color: var(--red-dirt);
        }
        .dropdown-options {
            overflow-y: auto;
            max-height: 260px;
            padding: 4px 0;
        }
        .dropdown-option {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dropdown-option:hover {
            background: #F3F4F6;
        }
        .dropdown-option.selected {
            background: #EEF2FF;
            color: var(--red-dirt);
            font-weight: 500;
        }
        .dropdown-option.hidden {
            display: none;
        }
        .dropdown-no-results {
            padding: 16px;
            text-align: center;
            color: #6B7280;
            font-size: 13px;
        }

        .results-count {
            font-size: 13px;
            color: var(--slate-blue);
            margin-left: auto;
        }
        
        /* Document Usage Tracker Styles */
        .usage-tracker {
            background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%);
            border: 1px solid #D8B4FE;
            border-radius: 12px;
            padding: 16px 20px;
            margin: 0 0 20px 0;
            display: none;
        }
        
        .usage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .usage-title {
            font-size: 14px;
            font-weight: 600;
            color: #6B21A8;
        }
        
        .usage-count {
            font-size: 24px;
            font-weight: 700;
            color: #581C87;
        }
        
        .usage-limit {
            font-size: 14px;
            color: #7C3AED;
            font-weight: 500;
        }
        
        .usage-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .usage-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #7C3AED 0%, #A855F7 100%);
            transition: width 0.3s ease;
            min-width: 1%;
        }
        
        .usage-bar-fill.high-usage {
            background: linear-gradient(90deg, #F59E0B 0%, #EF4444 100%);
        }
        
        .usage-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #6B21A8;
        }
        
        .usage-refresh {
            background: none;
            border: none;
            color: #7C3AED;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .usage-refresh:hover {
            background: rgba(124, 58, 237, 0.1);
        }
        
        /* New Credit Display Styles */
        .credit-display-container {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            font-size: 14px;
            color: #4B5563;
        }
        
        .credit-separator {
            color: #E5E7EB;
            font-size: 18px;
        }
        
        .credit-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .credit-label {
            font-weight: 500;
            color: #6B7280;
        }
        
        .credit-available {
            font-weight: 700;
            color: #059669;
            font-size: 16px;
        }
        
        .credit-usage {
            color: #6B7280;
            font-size: 13px;
        }
        
        .credit-progress {
            display: flex;
            align-items: center;
        }
        
        .credit-progress-bar {
            width: 120px;
            height: 8px;
            background: #F3F4F6;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .credit-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #059669 0%, #10B981 100%);
            transition: width 0.3s ease;
        }
        
        .credit-progress-fill.warning {
            background: linear-gradient(90deg, #F59E0B 0%, #FBBF24 100%);
        }
        
        .credit-progress-fill.danger {
            background: linear-gradient(90deg, #DC2626 0%, #EF4444 100%);
        }
        
        .credit-details {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #6B7280;
        }
        
        .credit-reset {
            white-space: nowrap;
        }
        
        .credit-view-details {
            color: #2563EB;
            text-decoration: none;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .credit-view-details:hover {
            text-decoration: underline;
        }

        .credit-buy-more {
            color: #C05621;
            text-decoration: none;
            font-weight: 600;
            white-space: nowrap;
        }

        .credit-buy-more:hover {
            text-decoration: underline;
        }

        /* Credit Tooltip (Desktop only) */
        .credit-tooltip {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 12px 16px;
            z-index: 100;
            min-width: 250px;
        }
        
        .credit-display-container:hover .credit-tooltip {
            display: block;
        }
        
        .tooltip-content {
            font-size: 13px;
        }
        
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            color: #4B5563;
        }
        
        .tooltip-divider {
            height: 1px;
            background: #E5E7EB;
            margin: 8px 0;
        }
        
        .tooltip-footer {
            text-align: center;
            color: #9CA3AF;
            font-size: 12px;
            margin-top: 8px;
            font-style: italic;
        }
        
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .credit-display-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .credit-separator:first-child {
                display: none;
            }
            
            .credit-progress-bar {
                width: 100%;
                max-width: 200px;
            }
            
            .credit-tooltip {
                display: none !important; /* No hover on mobile */
            }
        }

        /* Credit Warning Banner */
        .credit-warning-banner {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .credit-warning-banner.warning {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            color: #92400E;
        }

        .credit-warning-banner.danger {
            background: #FEE2E2;
            border: 1px solid #EF4444;
            color: #991B1B;
        }

        .credit-warning-banner .warning-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .credit-warning-banner .warning-text {
            flex: 1;
        }

        .credit-warning-banner .warning-action {
            flex-shrink: 0;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
            text-decoration: none;
            white-space: nowrap;
        }

        .credit-warning-banner.warning .warning-action {
            background: #F59E0B;
            color: white;
        }

        .credit-warning-banner.danger .warning-action {
            background: #EF4444;
            color: white;
        }

        .credit-warning-banner .warning-action:hover {
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .credit-warning-banner {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-inner">
                <a href="/" class="logo">Mineral Watch</a>
                <nav class="nav-links">
                    <a href="/portal" class="active">Dashboard</a>
                    <a href="/portal/map">Map</a>
                    <a href="/portal/account">Account</a>
                    <a href="/portal/learn">Learn</a>
                </nav>
                <div class="user-menu">
                    <span class="user-name" id="userName">Loading...</span>
                    <button class="btn-logout" id="logoutBtn">Log Out</button>
                </div>
            </div>
        </div>
    </header>
    <main>
        <div class="container">
            <div class="page-header">
                <h1 style="margin: 0;">My Monitoring</h1>
                <div class="header-actions">
                    <div class="action-group">
                        <button class="btn-add" id="addPropertyBtn">
                            <span></span> Property
                        </button>
                        <button class="btn-secondary-action" id="bulkUploadBtn" title="Import Properties" onclick="openBulkUploadModal()">
                            Import
                        </button>
                        <button class="btn-secondary-action" id="exportPropertiesBtn" style="display: none;" onclick="exportPropertiesCSV()" title="Export Properties">
                            Export
                        </button>
                    </div>
                    <div class="action-divider"></div>
                    <div class="action-group">
                        <button class="btn-add" id="addWellBtn">
                            <span></span> Well
                        </button>
                        <button class="btn-secondary-action" id="bulkUploadWellsBtn" title="Import Wells" onclick="openBulkUploadWellsModal()">
                            Import
                        </button>
                        <button class="btn-secondary-action" id="exportWellsBtn" style="display: none;" onclick="exportWellsCSV()" title="Export Wells">
                            Export
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="plan-info">
                <span class="plan-badge" id="planBadge">FREE</span>
                <div class="plan-usage">
                    <div class="usage-item">
                        <span><strong id="propCount">0</strong> / <strong id="propLimit">1</strong> Properties</span>
                    </div>
                    <div class="usage-item">
                        <span>|</span>
                    </div>
                    <div class="usage-item">
                        <span><strong id="wellCount">0</strong> / <strong id="wellLimit">0</strong> Wells</span>
                    </div>
                    <div class="usage-item" id="docCountItem" style="display: none;">
                        <span>|</span>
                    </div>
                    <div class="usage-item" id="docCountDisplay" style="display: none;">
                        <span><strong id="docCount">0</strong> Documents</span>
                    </div>
                </div>
                <a href="/portal/upgrade" class="upgrade-link" id="upgradeLink">Upgrade </a>
            </div>
            
            <div class="stats-card" id="statsCard">
                <div class="stat-item">
                    <span class="stat-label">Last Alert</span>
                    <span class="stat-value" id="statLastAlert"></span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">This Month</span>
                    <span class="stat-value" id="statThisMonth">0</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-label">This Year</span>
                    <span class="stat-value" id="statThisYear">0</span>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="properties">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    Properties
                </button>
                <button class="tab" data-tab="wells">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    Wells
                </button>
                <button class="tab" data-tab="activity">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    Activity Log
                </button>
                <button class="tab" data-tab="documents" id="documentsTab" style="display: none;">
                    <svg class="tab-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Documents
                </button>
            </div>

            <div class="content-card">
                <div id="properties-tab" class="tab-content active">
                    <div id="propertiesControls" class="table-controls" style="display: none;">
                        <input type="text" id="propertiesSearch" class="search-input" placeholder="Search properties by county, section, township, or range...">
                        <select id="propertiesSort" class="sort-select">
                            <option value="legal-asc" selected>Legal Description</option>
                            <option value="acres-desc">Total Acres</option>
                            <option value="wells-desc">Wells</option>
                            <option value="documents-desc">Documents</option>
                            <option value="filings-desc">OCC Filings</option>
                        </select>
                        <span id="propertiesResultsCount" class="results-count"></span>
                    </div>
                   <div id="propertiesBulkActionBar" class="bulk-action-bar">
                        <div class="bulk-count"><span class="selected-count">0</span> selected</div>
                        <div class="bulk-actions">
                            <button class="bulk-btn" onclick="bulkDeleteSelected('properties')">
                                Delete Selected
                            </button>
                        </div>
                        <span class="bulk-clear" onclick="clearSelection('properties')">Clear selection</span>
                    </div>
                   <div id="propertiesContent">
    <div class="skeleton-table">
        <div class="skeleton-header">
            <div class="skeleton skeleton-cell medium"></div>
            <div class="skeleton skeleton-cell narrow"></div>
            <div class="skeleton skeleton-cell narrow"></div>
            <div class="skeleton skeleton-cell narrow"></div>
            <div class="skeleton skeleton-cell narrow"></div>
            <div class="skeleton skeleton-cell narrow"></div>
        </div>
        <div class="skeleton-row"><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div></div>
        <div class="skeleton-row"><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div></div>
        <div class="skeleton-row"><div class="skeleton skeleton-cell medium"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div><div class="skeleton skeleton-cell narrow"></div></div>
    </div>
</div>
                </div>
                
                <div id="wells-tab" class="tab-content">
                    <div id="wellsControls" class="table-controls" style="display: none;">
                        <input type="text" id="wellsSearch" class="search-input" placeholder="Search wells by name, operator, API, or county...">
                        <select id="wellsSort" class="sort-select">
                            <option value="name-asc" selected>Well Name</option>
                            <option value="legal-asc">Legal Description</option>
                            <option value="operator-asc">Operator</option>
                            <option value="properties-desc">Properties</option>
                            <option value="documents-desc">Documents</option>
                            <option value="filings-desc">OCC Filings</option>
                        </select>
                        <span id="wellsResultsCount" class="results-count"></span>
                    </div>
                   <div id="wellsBulkActionBar" class="bulk-action-bar">
                        <div class="bulk-count"><span class="selected-count">0</span> selected</div>
                        <div class="bulk-actions">
                            <button class="bulk-btn" onclick="bulkDeleteSelected('wells')">
                                Delete Selected
                            </button>
                        </div>
                        <span class="bulk-clear" onclick="clearSelection('wells')">Clear selection</span>
                    </div>
                   <div id="wellsContent">
    <table class="data-table">
        <thead>
            <tr>
                <th class="bulk-only skeleton skeleton-cell"></th>
                <th class="skeleton skeleton-cell">Well Information</th>
                <th class="skeleton skeleton-cell">Operator Contact</th>
                <th class="skeleton skeleton-cell"></th>
            </tr>
        </thead>
        <tbody>
            <tr><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td></tr>
            <tr><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td></tr>
            <tr><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td><td class="skeleton skeleton-cell"></td></tr>
        </tbody>
    </table>
</div>
                </div>

                <div id="activity-tab" class="tab-content">
                    <!-- Activity Bulk Action Bar -->
                    <div class="bulk-action-bar" id="activityBulkBar">
                        <div class="bulk-info">
                            <span id="activitySelectedCount">0</span> activities selected
                        </div>
                        <div class="bulk-actions">
                            <button class="bulk-btn" onclick="bulkDeleteSelected('activity')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <path stroke="currentColor" stroke-width="2" d="M3 6h18M8 6V4a1 1 0 011-1h6a1 1 0 011 1v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14zM10 11v6M14 11v6"/>
                                </svg>
                                Delete Selected
                            </button>
                        </div>
                    </div>

                    <div id="activityContent">
                    <div class="skeleton-activity"><div class="skeleton skeleton-avatar"></div><div class="skeleton-activity-content"><div class="skeleton skeleton-line short"></div><div class="skeleton skeleton-line long"></div><div class="skeleton skeleton-line medium"></div></div></div>
                    <div class="skeleton-activity"><div class="skeleton skeleton-avatar"></div><div class="skeleton-activity-content"><div class="skeleton skeleton-line short"></div><div class="skeleton skeleton-line long"></div><div class="skeleton skeleton-line medium"></div></div></div>
                    <div class="skeleton-activity"><div class="skeleton skeleton-avatar"></div><div class="skeleton-activity-content"><div class="skeleton skeleton-line short"></div><div class="skeleton skeleton-line long"></div><div class="skeleton skeleton-line medium"></div></div></div>
                </div>
                </div>
                
                <div id="documents-tab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--oil-navy);">Digital Documents</h3>
                                <div class="credit-display-container">
                                    <span class="credit-separator">|</span>
                                    <div class="credit-info">
                                        <span class="credit-label">Credits:</span>
                                        <span class="credit-available" id="creditsAvailable">0</span> available
                                        <span class="credit-usage">(<span id="creditsUsedThisMonth">0</span> used this month)</span>
                                    </div>
                                    <div class="credit-progress">
                                        <div class="credit-progress-bar">
                                            <div class="credit-progress-fill" id="creditProgressFill"></div>
                                        </div>
                                    </div>
                                    <div class="credit-details">
                                        <span class="credit-reset">Resets <span id="creditResetDate">--</span></span>
                                        <span class="credit-separator"></span>
                                        <a href="/portal/account#credits" class="credit-view-details">View details</a>
                                        <span class="credit-separator"></span>
                                        <a href="#" onclick="openCreditPackModal(); return false;" class="credit-buy-more">Buy More</a>
                                    </div>
                                    <div class="credit-tooltip" id="creditTooltip">
                                        <div class="tooltip-content">
                                            <div class="tooltip-row">
                                                <span>Monthly:</span>
                                                <span><span id="tooltipMonthlyUsed">0</span>/<span id="tooltipMonthlyLimit">0</span> (resets <span id="tooltipResetDate">--</span>)</span>
                                            </div>
                                            <div class="tooltip-row" id="tooltipPurchasedRow" style="display: none;">
                                                <span>Purchased:</span>
                                                <span id="tooltipPurchasedRemaining">0</span>
                                            </div>
                                            <div class="tooltip-row" id="tooltipBonusRow" style="display: none;">
                                                <span>Bonus:</span>
                                                <span id="tooltipBonusRemaining">0</span>
                                            </div>
                                            <div class="tooltip-divider"></div>
                                            <div class="tooltip-row">
                                                <span><strong>Total:</strong></span>
                                                <span><strong id="tooltipTotalAvailable">0</strong></span>
                                            </div>
                                            <div class="tooltip-footer">
                                                Click for full history
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn-add" onclick="openUploadModal()" style="font-size: 14px;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            Upload Documents
                        </button>
                        <button id="relinkDocumentsBtn" class="btn-secondary" onclick="relinkDocuments()" style="font-size: 14px; display: none;" title="Re-scan unlinked documents for property/well matches">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Re-scan for Links
                        </button>
                    </div>
                    
                    <!-- Low Credit Warning Banner -->
                    <div id="lowCreditWarning" class="credit-warning-banner" style="display: none;"></div>

                    <div id="documentsControls" class="table-controls" style="display: none;">
                        <input type="text" id="documentsSearch" class="search-input" placeholder="Search documents by name, type, county, or content...">
                        <div class="searchable-dropdown" id="documentsCategoryDropdown">
                            <button type="button" class="searchable-dropdown-trigger" id="documentsCategoryTrigger">
                                <span class="dropdown-label">All Categories</span>
                                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 4.5L6 7.5L9 4.5"/>
                                </svg>
                            </button>
                            <div class="searchable-dropdown-menu" id="documentsCategoryMenu">
                                <div class="dropdown-search-wrapper">
                                    <input type="text" class="dropdown-search" id="documentsCategorySearch" placeholder="Search categories...">
                                </div>
                                <div class="dropdown-options" id="documentsCategoryOptions">
                                    <!-- Options populated by JS -->
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="documentsCategory" value="all">
                        <select id="documentsSort" class="sort-select">
                            <!-- Options will be dynamically populated -->
                        </select>
                        <span id="documentsResultsCount" class="results-count"></span>
                    </div>
                    
                    <div id="documentsBulkActionBar" class="bulk-action-bar" style="display: none;"></div>
                    
                    <div id="documentsContent" style="padding: 0 20px;">
                        <!-- Loading skeleton will be here initially -->
                        <div class="skeleton-activity">
                            <div class="skeleton skeleton-avatar"></div>
                            <div class="skeleton-activity-content">
                                <div class="skeleton skeleton-line short"></div>
                                <div class="skeleton skeleton-line long"></div>
                            </div>
                        </div>
                        <div class="skeleton-activity">
                            <div class="skeleton skeleton-avatar"></div>
                            <div class="skeleton-activity-content">
                                <div class="skeleton skeleton-line short"></div>
                                <div class="skeleton skeleton-line long"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer><div class="container">&copy; 2025 Mineral Watch</div></footer>
    
    <!-- Add Property Modal - Styled Like Property Details -->
    <div class="modal-overlay" id="addPropertyModal">
        <div class="property-card" style="max-width: 520px; width: 100%;">
            <!-- Header with Orange Gradient -->
            <div class="property-card-header">
                <button class="close-btn" onclick="closePropertyModal()" aria-label="Close"></button>
                <div class="card-header-top">
                    <h2 class="property-name">Add Property</h2>
                    <span class="acreage-badge" id="addPropertyAcreageBadge" style="display: none;">0 acres</span>
                </div>
                <div class="property-location" id="addPropertyLocation" style="opacity: 0;">Location</div>
            </div>
            
            <!-- Content -->
            <div class="card-content">
                <form id="addPropertyForm">
                    <div class="details-grid">
                        <!-- County -->
                        <div class="details-row">
                            <span class="details-label">County</span>
                            <select id="county" required onchange="autoSetMeridian(this.value); updateLocationDisplay();" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white; width: 200px;">
                                <option value="">Select County</option>
                                <option>Alfalfa</option><option>Atoka</option><option>Beaver</option><option>Beckham</option><option>Blaine</option><option>Bryan</option><option>Caddo</option><option>Canadian</option><option>Carter</option><option>Cherokee</option><option>Choctaw</option><option>Cimarron</option><option>Cleveland</option><option>Coal</option><option>Comanche</option><option>Cotton</option><option>Craig</option><option>Creek</option><option>Custer</option><option>Delaware</option><option>Dewey</option><option>Ellis</option><option>Garfield</option><option>Garvin</option><option>Grady</option><option>Grant</option><option>Greer</option><option>Harmon</option><option>Harper</option><option>Haskell</option><option>Hughes</option><option>Jackson</option><option>Jefferson</option><option>Johnston</option><option>Kay</option><option>Kingfisher</option><option>Kiowa</option><option>Latimer</option><option>Le Flore</option><option>Lincoln</option><option>Logan</option><option>Love</option><option>Major</option><option>Marshall</option><option>Mayes</option><option>McClain</option><option>McCurtain</option><option>McIntosh</option><option>Murray</option><option>Muskogee</option><option>Noble</option><option>Nowata</option><option>Okfuskee</option><option>Oklahoma</option><option>Okmulgee</option><option>Osage</option><option>Ottawa</option><option>Pawnee</option><option>Payne</option><option>Pittsburg</option><option>Pontotoc</option><option>Pottawatomie</option><option>Pushmataha</option><option>Roger Mills</option><option>Rogers</option><option>Seminole</option><option>Sequoyah</option><option>Stephens</option><option>Texas</option><option>Tillman</option><option>Tulsa</option><option>Wagoner</option><option>Washington</option><option>Washita</option><option>Woods</option><option>Woodward</option>
                            </select>
                        </div>
                        
                        <!-- Legal Description -->
                        <div class="details-row" style="align-items: center;">
                            <span class="details-label">Legal</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="text" id="section" placeholder="Sec" pattern="^[0-9]{1,2}$" title="Section number (1-36)" required 
                                       style="padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; width: 50px; text-align: center;"
                                       oninput="updateLocationDisplay()">
                                <span>-</span>
                                <input type="text" id="township" placeholder="Twn" pattern="^[0-9]{1,2}[NS]$" title="e.g., 12N" required
                                       style="padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; width: 60px; text-align: center; text-transform: uppercase;"
                                       oninput="updateLocationDisplay()">
                                <span>-</span>
                                <input type="text" id="range" placeholder="Rng" pattern="^[0-9]{1,2}[WE]$" title="e.g., 4W" required
                                       style="padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; width: 60px; text-align: center; text-transform: uppercase;"
                                       oninput="updateLocationDisplay()">
                                <select id="meridian" style="padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; font-family: inherit; background: white;">
                                    <option value="IM">IM</option>
                                    <option value="CM">CM</option>
                                </select>
                            </div>
                        </div>
                        <div class="details-row" style="margin-top: -10px;">
                            <span class="details-label"></span>
                            <div class="form-hint" style="font-size: 11px; color: #64748B;">Section number only. Ownership details go in notes.</div>
                        </div>
                        
                        <!-- RI Acres -->
                        <div class="details-row">
                            <span class="details-label">RI Acres</span>
                            <input type="number" id="addPropertyRIAcres" step="0.01" min="0" 
                                   style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white; width: 120px;" 
                                   placeholder="0" oninput="updateAddPropertyTotalAcres()">
                        </div>
                        
                        <!-- WI Acres -->
                        <div class="details-row">
                            <span class="details-label">WI Acres</span>
                            <input type="number" id="addPropertyWIAcres" step="0.01" min="0" 
                                   style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white; width: 120px;" 
                                   placeholder="0" oninput="updateAddPropertyTotalAcres()">
                        </div>
                        
                        <!-- Total Acres (calculated) -->
                        <div class="details-row">
                            <span class="details-label">Total Acres</span>
                            <span class="details-value" id="addPropertyTotalAcres" style="font-weight: 600;">0</span>
                        </div>
                        
                        <!-- Group -->
                        <div class="details-row">
                            <span class="details-label">Group</span>
                            <input type="text" id="addPropertyGroup" 
                                   style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white; width: 200px;" 
                                   placeholder="e.g., Family Trust, Personal">
                        </div>
                        
                        <!-- Notes -->
                        <div class="details-row" style="flex-direction: column; align-items: flex-start;">
                            <span class="details-label" style="margin-bottom: 8px;">Notes</span>
                            <textarea id="propertyNotes" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical;" 
                                      placeholder="Add legal descriptions, lease info, or other details..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Footer Actions -->
                    <div class="card-footer" style="margin-top: 20px;">
                        <button type="button" class="action-btn secondary" onclick="closePropertyModal()">Cancel</button>
                        <button type="submit" class="action-btn primary" style="flex: 2;">Save & Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Well Modal -->
    <div class="modal-overlay" id="addWellModal">
        <div class="modal" style="max-width: 600px; width: 100%; position: relative;">
            <button class="modal-close" onclick="closeWellModal()" aria-label="Close"></button>
            <h2>Add Well</h2>
            
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="api-tab">Search by API</button>
                <button class="tab-btn" data-tab="location-tab">Search by Name/Location</button>
            </div>
            
            <!-- API Search Tab -->
            <div class="tab-content active" id="api-tab">
                <form id="addWellForm">
                    <div class="form-group full">
                        <label for="apiNumber">API Number *</label>
                        <input type="text" id="apiNumber" placeholder="3515322352" required>
                        <div class="form-hint">10-digit Oklahoma well API (starts with 35)</div>
                    </div>
                    <div class="form-group full">
                        <label for="wellNotes">Notes (Optional)</label>
                        <textarea id="wellNotes" placeholder="Any notes about this well"></textarea>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn-cancel" onclick="closeWellModal()">Cancel</button>
                        <button type="submit" class="btn-submit">Add Well</button>
                    </div>
                </form>
            </div>
            
            <!-- Name/Location Search Tab -->
            <div class="tab-content" id="location-tab">
                <div class="search-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="searchWellName">Well Name</label>
                            <input type="text" id="searchWellName" placeholder="e.g., Collins">
                        </div>
                        <div class="form-group">
                            <label for="searchOperator">Operator</label>
                            <input type="text" id="searchOperator" placeholder="e.g., Devon">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="searchSection">Section</label>
                            <input type="number" id="searchSection" placeholder="1-36" min="1" max="36">
                        </div>
                        <div class="form-group">
                            <label for="searchTownship">Township</label>
                            <input type="text" id="searchTownship" placeholder="e.g., 12N or 12">
                        </div>
                        <div class="form-group">
                            <label for="searchRange">Range</label>
                            <input type="text" id="searchRange" placeholder="e.g., 5W or 5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full">
                            <label for="searchCounty">County</label>
                            <input type="text" id="searchCounty" placeholder="e.g., Grady">
                        </div>
                    </div>
                    
                    <div class="search-buttons">
                        <button type="button" class="btn-search" onclick="searchWells()">Search Wells</button>
                        <button type="button" class="btn-clear" onclick="clearWellSearch()">Clear</button>
                    </div>
                </div>
                
                <!-- Search Results -->
                <div id="searchResults" class="search-results" style="display: none;">
                    <div class="results-header">
                        <h3>Search Results</h3>
                        <div class="results-info" id="resultsInfo"></div>
                    </div>
                    <div class="results-list" id="resultsList">
                        <!-- Results will be populated here -->
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="searchLoading" class="search-loading" style="display: none;">
                    <div class="spinner"></div>
                    <div>Searching wells...</div>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeWellModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Well Details Modal - New Card Design -->
    <div class="modal-overlay" id="wellDetailsModal">
        <div class="well-card detail-modal" style="max-width: 700px; max-height: calc(100vh - 20px); margin: 10px auto; background: #FFFFFF; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; padding: 0;">
            <!-- Header with Blue Gradient (full bleed) -->
            <div class="card-header detail-modal-header" style="background: linear-gradient(135deg, var(--oil-navy) 0%, var(--slate-blue) 100%); color: white; padding: 20px 24px; position: relative; flex-shrink: 0;">
                <button class="close-btn" onclick="closeWellDetailsModal()" aria-label="Close" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 32px; height: 32px; border-radius: 6px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;"></button>
                <h2 class="well-name" id="wellDetailsTitle" style="margin: 0; font-family: 'Merriweather', serif; font-size: 22px; font-weight: 700;">Well Details</h2>
                <div class="api-number" id="wellDetailsApi" style="margin-top: 2px; font-size: 15px; opacity: 0.9;">API: </div>
            </div>
            
            <!-- Content Body (scrollable) -->
            <div class="card-content detail-modal-body" style="padding: 20px 24px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; min-height: 0;">
                <!-- Status Row -->
                <div class="status-row">
                    <div class="status-item">
                        <span class="status-label">Status</span>
                        <span class="status-badge" id="wellDetailsStatusBadge">AC</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Well Type</span>
                        <span class="status-value" id="wellDetailsType">GAS</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Direction</span>
                        <span class="status-badge horizontal" id="wellDetailsDirection">Horizontal</span>
                    </div>
                </div>
                
                <!-- Operator -->
                <div class="info-section">
                    <div class="section-label">Operator</div>
                    <div class="section-value" id="wellDetailsOperator">Validus Energy II Midcon LLC</div>
                    <div class="contact-line" id="wellDetailsContact">
                        <a href="tel:7209742084" id="wellDetailsPhoneLink">(720) 974-2084</a>  <span id="wellDetailsContactPerson">Michelle Pettifor</span>
                    </div>
                </div>
                
                <!-- Location / County -->
                <div class="two-col">
                    <div class="info-section">
                        <div class="section-label">Location</div>
                        <div class="section-value" id="wellDetailsLocation">T03N R03W 25</div>
                    </div>
                    <div class="info-section">
                        <div class="section-label">County</div>
                        <div class="section-value" id="wellDetailsCounty">Garvin County</div>
                    </div>
                </div>
                
                <!-- Production Section (conditionally shown) -->
                <div class="production-section" id="wellDetailsProduction" style="display: none;">
                    <div class="production-header">
                        <span class="production-title">Production Data</span>
                        <span class="formation-badge" id="wellDetailsFormationBadge">Woodford</span>
                    </div>
                    
                    <div class="production-grid">
                        <div class="production-item">
                            <div class="production-label">IP Gas</div>
                            <div class="production-value" id="wellDetailsIPGas">2,847</div>
                            <div class="production-unit">MCF/day</div>
                        </div>
                        <div class="production-item">
                            <div class="production-label">IP Oil</div>
                            <div class="production-value" id="wellDetailsIPOil">156</div>
                            <div class="production-unit">BBL/day</div>
                        </div>
                        <div class="production-item">
                            <div class="production-label">Depth</div>
                            <div class="production-value" id="wellDetailsDepth">15,004</div>
                            <div class="production-unit">ft</div>
                        </div>
                    </div>
                    
                    <div class="dates-row">
                        <div class="date-item">
                            <div class="date-label">Completed</div>
                            <div class="date-value" id="wellDetailsCompleted">2018-07-28</div>
                        </div>
                        <div class="date-item">
                            <div class="date-label">First Prod</div>
                            <div class="date-value" id="wellDetailsFirstProd">2018-08-05</div>
                        </div>
                    </div>
                </div>
                
                <!-- Linked Properties Accordion -->
                <div class="linked-properties-section" style="margin: 16px 0; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <div class="linked-properties-header" onclick="toggleLinkedProperties()" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; cursor: pointer; background: #f9fafb; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="linked-properties-arrow" style="transition: transform 0.2s;"></span>
                            <span style="font-weight: 500;">Linked Properties</span>
                            <span id="well-linked-properties-count" style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 12px;">0</span>
                        </div>
                    </div>

                    <div id="linked-properties-content" style="display: none; padding: 0 16px 16px;">
                        <div id="linked-properties-list" style="max-height: 250px; overflow-y: auto;">
                            <!-- Populated dynamically -->
                        </div>
                        <div id="linked-properties-empty" style="color: #6b7280; font-size: 14px; padding: 12px 0;">
                            No properties linked to this well
                        </div>
                    </div>
                </div>
                
                <!-- Linked Documents Section (Well) -->
                <div class="linked-documents-section-well" style="margin: 16px 0; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <div class="linked-documents-header-well" onclick="toggleLinkedDocuments('well')" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; cursor: pointer; background: #f9fafb; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="linked-documents-arrow-well" style="transition: transform 0.2s;"></span>
                            <span style="font-weight: 500;">Linked Documents</span>
                            <span id="well-linked-documents-count" style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 12px;"></span>
                        </div>
                    </div>

                    <div id="linked-documents-content-well" style="display: none; padding: 0 16px 16px;">
                        <div id="linked-documents-list-well" style="max-height: 300px; overflow-y: auto;">
                            <!-- Populated dynamically -->
                        </div>
                        <div id="linked-documents-empty-well" style="color: #6b7280; font-size: 14px; padding: 12px 0;">
                            No documents linked to this well
                        </div>
                    </div>
                </div>

                <!-- OCC Filings Section (Well) -->
                <div class="occ-filings-section-well" style="margin: 16px 0; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <div class="occ-filings-header-well" onclick="toggleOccFilings('well')" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; cursor: pointer; background: #f9fafb; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="well-occ-arrow" style="transition: transform 0.2s;"></span>
                            <span style="font-weight: 500;">OCC Filings</span>
                            <span id="well-occ-count" style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 12px;"></span>
                        </div>
                    </div>

                    <div id="well-occ-content" style="display: none; padding: 0 16px 16px;">
                        <div id="well-occ-direct" style="max-height: 300px; overflow-y: auto;">
                            <!-- Populated dynamically -->
                        </div>
                        <div id="well-occ-adjacent-wrapper" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 8px; margin: 16px 0 8px 0; padding-top: 12px; border-top: 2px dashed #ddd; font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">
                                <span>Adjacent Activity</span>
                                <span id="well-occ-adjacent-count" style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 11px;">0</span>
                            </div>
                            <div id="well-occ-adjacent" style="max-height: 200px; overflow-y: auto;">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                        <div id="well-occ-empty" style="display: none; color: #6b7280; font-size: 14px; padding: 12px 0; font-style: italic;">
                            No OCC filings found for this section
                        </div>
                    </div>
                </div>

                <!-- Completion Date -->
                <div class="info-section">
                    <div class="section-label">Completion Date</div>
                    <div class="section-value" id="wellDetailsCompletionDate"></div>
                </div>
                
                <!-- Notes Section -->
                <div class="info-section" style="margin-top: 16px;">
                    <div class="section-label">Notes</div>
                    <textarea id="wellDetailsNotes" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical; margin-top: 6px;" placeholder="Add notes about this well..." onkeyup="toggleSaveButton('well')"></textarea>
                </div>
            </div>
            
            <!-- Footer Actions (fixed at bottom) -->
            <div class="card-footer detail-modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; gap: 10px; flex-shrink: 0; flex-wrap: wrap; background: white;">
                <div style="display: flex; gap: 10px; flex: 1;">
                    <button class="action-btn primary well-blue" id="wellDetailsMWMapBtn" onclick="viewWellOnMapFromModal()" style="background: var(--slate-blue);">MW Map </button>
                    <a href="#" target="_blank" class="action-btn primary well-blue" id="wellDetailsMapLink" style="flex: 1;">OCC Map </a>
                    <div class="occ-warning" style="position: relative;">
                        <a href="#" target="_blank" class="action-btn secondary" id="wellDetailsRecordsLink">Well Records </a>
                        <span class="occ-warning-icon">!</span>
                        <div class="occ-tooltip">
                            <strong>OCC Website Note:</strong> If you see a cookie error on OCC's site, try signing out of OCC first or open this link in an incognito/private window.
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn outline" onclick="closeWellDetailsModal()">Close</button>
                    <button class="action-btn primary well-blue" id="saveWellBtn" onclick="saveWellNotesAndClose()" style="display: none;">Save & Close</button>
                </div>
            </div>
            
            <input type="hidden" id="wellDetailsId">
            <input type="hidden" id="wellDetailsOriginalNotes">
        </div>
    </div>
    
    <!-- Property Details Modal - Orange Card Design -->
    <div class="modal-overlay" id="propertyDetailsModal">
        <div class="property-card detail-modal" style="max-width: 700px; max-height: calc(100vh - 20px); margin: 10px auto; background: #FFFFFF; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; padding: 0;">
            <!-- Header with Orange Gradient (full bleed) -->
            <div class="property-card-header detail-modal-header" style="background: linear-gradient(135deg, var(--red-dirt) 0%, var(--red-dirt-dark) 100%); color: white; padding: 20px 24px; position: relative; flex-shrink: 0;">
                <button class="close-btn" onclick="closePropertyDetailsModal()" aria-label="Close" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 32px; height: 32px; border-radius: 6px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;"></button>
                <div>
                    <h2 class="property-name" id="propertyDetailsTitle" style="margin: 0; font-family: 'Merriweather', serif; font-size: 22px; font-weight: 700;">Property Details</h2>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2px;">
                        <div class="property-location" id="propertyDetailsLocation" style="font-size: 15px; opacity: 0.9;">Garvin County  T03N R03W 25</div>
                        <span class="acreage-badge" id="propertyDetailsAcreageBadge" style="background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">47.5 acres</span>
                    </div>
                </div>
            </div>
            
            <!-- Content Body (scrollable) -->
            <div class="card-content detail-modal-body" style="padding: 20px 24px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; min-height: 0;">
            
            <div class="details-grid">
                <div class="details-row">
                    <span class="details-label">Legal</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="details-value" id="propertyDetailsLegal" style="font-family: monospace;"></span>
                        <select id="propertyDetailsMeridian" style="padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; font-family: inherit; background: white;">
                            <option value="IM">IM</option>
                            <option value="CM">CM</option>
                        </select>
                    </div>
                </div>
                <div class="details-row" id="propertyDetailsGroupRow" style="display: none;">
                    <span class="details-label">Group</span>
                    <span class="details-value" id="propertyDetailsGroup"></span>
                </div>
                <div class="details-row">
                    <span class="details-label">Total Acres</span>
                    <span class="details-value" id="propertyDetailsTotalAcres" style="font-weight: 500;"></span>
                </div>
                <div class="details-row">
                    <span class="details-label">RI Acres</span>
                    <input type="number" id="propertyDetailsRIAcres" step="0.01" min="0" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white; width: 120px;" placeholder="0" oninput="updateTotalAcres(); toggleSaveButton('property');">
                </div>
                <div class="details-row">
                    <span class="details-label">WI Acres</span>
                    <input type="number" id="propertyDetailsWIAcres" step="0.01" min="0" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; font-family: inherit; background: white; width: 120px;" placeholder="0" oninput="updateTotalAcres(); toggleSaveButton('property');">
                </div>
                <!-- Linked Wells Accordion -->
                <div class="linked-wells-section" style="margin: 16px 0; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <div class="linked-wells-header" onclick="toggleLinkedWells()" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; cursor: pointer; background: #f9fafb; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="linked-wells-arrow" style="transition: transform 0.2s;"></span>
                            <span style="font-weight: 500;">Linked Wells</span>
                            <span id="property-linked-wells-count" style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 12px;">0</span>
                        </div>
                    </div>

                    <div id="linked-wells-content" style="display: none; padding: 0 16px 16px;">
                        <div id="linked-wells-list" style="max-height: 300px; overflow-y: auto;">
                            <!-- Populated dynamically -->
                        </div>
                        <div id="linked-wells-empty" style="color: #6b7280; font-size: 14px; padding: 12px 0;">
                            No wells linked to this property
                        </div>
                    </div>
                </div>
                
                <!-- Linked Documents Section -->
                <div class="linked-documents-section" style="margin: 16px 0; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <div class="linked-documents-header" onclick="toggleLinkedDocuments('property')" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; cursor: pointer; background: #f9fafb; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="linked-documents-arrow" style="transition: transform 0.2s;"></span>
                            <span style="font-weight: 500;">Linked Documents</span>
                            <span id="property-linked-documents-count" style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 12px;"></span>
                        </div>
                    </div>

                    <div id="linked-documents-content" style="display: none; padding: 0 16px 16px;">
                        <div id="linked-documents-list" style="max-height: 300px; overflow-y: auto;">
                            <!-- Populated dynamically -->
                        </div>
                        <div id="linked-documents-empty" style="color: #6b7280; font-size: 14px; padding: 12px 0;">
                            No documents linked to this property
                        </div>
                    </div>
                </div>

                <!-- OCC Filings Section -->
                <div class="occ-filings-section" style="margin: 16px 0; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <div class="occ-filings-header" onclick="toggleOccFilings('property')" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; cursor: pointer; background: #f9fafb; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="property-occ-arrow" style="transition: transform 0.2s;"></span>
                            <span style="font-weight: 500;">OCC Filings</span>
                            <span id="property-occ-count" style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 12px;"></span>
                        </div>
                    </div>

                    <div id="property-occ-content" style="display: none; padding: 0 16px 16px;">
                        <div id="property-occ-direct" style="max-height: 300px; overflow-y: auto;">
                            <!-- Populated dynamically -->
                        </div>
                        <div id="property-occ-adjacent-wrapper" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 8px; margin: 16px 0 8px 0; padding-top: 12px; border-top: 2px dashed #ddd; font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">
                                <span>Adjacent Activity</span>
                                <span id="property-occ-adjacent-count" style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 11px;">0</span>
                            </div>
                            <div id="property-occ-adjacent" style="max-height: 200px; overflow-y: auto;">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                        <div id="property-occ-empty" style="display: none; color: #6b7280; font-size: 14px; padding: 12px 0; font-style: italic;">
                            No OCC filings found for this section
                        </div>
                    </div>
                </div>

                <div class="details-row" style="flex-direction: column; align-items: flex-start;">
                    <span class="details-label" style="margin-bottom: 8px;">Notes</span>
                    <textarea id="propertyDetailsNotes" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical;" placeholder="Add notes about this property..." onkeyup="toggleSaveButton('property')"></textarea>
                </div>
            </div>
            
            <input type="hidden" id="propertyDetailsId">
            <input type="hidden" id="propertyDetailsOriginalNotes">
            <input type="hidden" id="propertyDetailsOriginalRIAcres">
            <input type="hidden" id="propertyDetailsOriginalWIAcres">
            </div>
            
            <!-- Footer Actions (fixed at bottom) -->
            <div class="card-footer detail-modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; gap: 10px; flex-shrink: 0; flex-wrap: wrap; background: white;">
                <div style="display: flex; gap: 10px; flex: 1;">
                    <button class="action-btn primary" id="propertyDetailsMWMapBtn" onclick="viewPropertyOnMapFromModal()" style="background: var(--red-dirt);">MW Map </button>
                    <a href="#" target="_blank" class="action-btn primary" id="propertyDetailsMapLink" style="background: var(--red-dirt);">OCC Map </a>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn outline" onclick="closePropertyDetailsModal()">Close</button>
                    <button class="action-btn primary" id="savePropertyBtn" onclick="savePropertyAndClose()" style="background: var(--red-dirt); display: none;">Save & Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Security: escape HTML to prevent XSS from user-generated content
        function escapeHtml(text) {
            if (!text) return '';
            const str = String(text);
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        // Toggle save button visibility when content changes
        function toggleSaveButton(modalType) {
            if (modalType === 'well') {
                const notes = document.getElementById('wellDetailsNotes').value;
                const originalNotes = document.getElementById('wellDetailsOriginalNotes').value || '';
                const saveBtn = document.getElementById('saveWellBtn');
                
                if (notes !== originalNotes) {
                    saveBtn.style.display = 'inline-block';
                } else {
                    saveBtn.style.display = 'none';
                }
            } else if (modalType === 'property') {
                const notes = document.getElementById('propertyDetailsNotes').value;
                const originalNotes = document.getElementById('propertyDetailsOriginalNotes').value || '';
                const riAcres = document.getElementById('propertyDetailsRIAcres').value;
                const originalRIAcres = document.getElementById('propertyDetailsOriginalRIAcres').value || '';
                const wiAcres = document.getElementById('propertyDetailsWIAcres').value;
                const originalWIAcres = document.getElementById('propertyDetailsOriginalWIAcres').value || '';
                const saveBtn = document.getElementById('savePropertyBtn');
                
                if (notes !== originalNotes || riAcres !== originalRIAcres || wiAcres !== originalWIAcres) {
                    saveBtn.style.display = 'inline-block';
                } else {
                    saveBtn.style.display = 'none';
                }
            }
        }
        
        // Clean county display - remove numeric prefix like "011-" from "011-BLAINE"
        function cleanCountyDisplay(county) {
            if (!county) return '';
            // Remove any leading digits followed by a hyphen
            return county.replace(/^\d+-/, '');
        }
        
        // Format activity location from S15-T12N-R5W to T12N R5W 15
        function formatActivityLocation(location) {
            if (!location) return '';
            
            // Try to parse S15-T12N-R5W format
            const match = location.match(/S(\d+)-T([^-]+)-R(.+)/i);
            if (match) {
                const [_, section, township, range] = match;
                return `T${township} R${range} ${section}`;
            }
            
            // Return original if can't parse
            return escapeHtml(location);
        }

        // OCC Status Code Definitions for Hover Tooltips
        const occStatusHelp = {
            'AC': 'Well is open and not plugged (could still be used or revived).',
            'ND': 'New drill - well recently drilled, completion info pending.',
            'SP': 'Drilling has started (spudded), but the well is not finished yet.',
            'TA': 'Well is shut in but not plugged; could be brought back or later plugged.',
            'PA': 'Well has been fully plugged and abandoned (no future production).',
            'OR': 'Orphan well with no responsible operator on record.',
            'STFD': 'On the state\'s list to be plugged with Oklahoma funds.',
            'PASF': 'Well plugged using Oklahoma state funds.',
            'PASUR': 'Well plugged using bond/surety money from the operator.',
            'PASURSF': 'Well plugged using a mix of surety and state funds.',
            'PAFF': 'Well plugged using federal funds.'
        };

        // Well Type Code Definitions for Hover Tooltips
        const wellTypeHelp = {
            'NULL': 'Well type unknown; records incomplete.',
            '2D': 'Older disposal/injection well type.',
            '2DCm': 'Commercial disposal well taking fluid from others.',
            '2DNC': 'Non-commercial disposal well for one operator/lease.',
            '2R': 'Enhanced recovery injection well (helps push oil to producers).',
            '2RIn': 'Enhanced recovery injection well  UIC type.',
            '2RSi': 'Enhanced recovery injection well that can also produce some oil or gas.',
            'DRY': 'Dry hole; no commercial oil or gas found.',
            'GAS': 'Gas production well.',
            'GSW': 'Storage well used for gas.',
            'IEPA': 'Federal injection well regulated under EPA.',
            'INJ': 'General injection/disposal well.',
            'LPSW': 'Storage well for LPG.',
            'ND': 'Well type unknown; documents missing.',
            'NT': 'No type assigned; likely missing completion info.',
            'OBW': 'Observation/monitoring well for gas storage.',
            'OG': 'Oil and gas production well.',
            'OIL': 'Oil-only production well.',
            'OPRH': 'Legacy orphaned production well type.',
            'P&A': 'Legacy plugged and abandoned well type.',
            'PA': 'Plugged and abandoned well type.',
            'STFD': 'State-funds well type; used for state plugging records.',
            'SW': 'Service well (testing, maintenance, etc.).',
            'SWD': 'Saltwater disposal well.',
            'TA': 'Temporarily abandoned well type (legacy).',
            'TM': 'Terminated UIC well type (authorization revoked or ended).',
            'TWW': 'Legacy water-related UIC well type.',
            'WSW': 'Water supply well used for various purposes.'
        };

        // Production Terms Help for Hover Tooltips
        const productionHelp = {
            "ipGas": "Initial Production Gas - 24-hour flow test rate when well first came online",
            "ipOil": "Initial Production Oil - 24-hour flow test rate when well first came online", 
            "ipWater": "Initial Production Water - 24-hour flow test rate when well first came online",
            "lateral": "Lateral Length - horizontal portion of wellbore drilled through the formation",
            "formation": "Geological Formation - the specific rock layer being produced for oil/gas",
            "spudDate": "Spud Date - when drilling operations began at this well location",
            "completedDate": "Completion Date - when well construction finished and production equipment was installed",
            "firstProdDate": "First Production Date - when commercial oil/gas production began",
            "multiSection": "Multi-Section Horizontal - wellbore crosses multiple land sections for maximum formation contact"
        };
        
        // Format phone number for display (e.g., 4051234567 -> (405) 123-4567)
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            // Remove all non-digits
            const digits = phone.replace(/\D/g, '');
            
            if (digits.length === 10) {
                return `(${digits.substr(0,3)}) ${digits.substr(3,3)}-${digits.substr(6,4)}`;
            } else if (digits.length === 11 && digits.startsWith('1')) {
                return `+1 (${digits.substr(1,3)}) ${digits.substr(4,3)}-${digits.substr(7,4)}`;
            } else {
                return phone; // Return original if format doesn't match
            }
        }
        
        // View property on Map
        function viewOnMap(propertyId) {
            const property = loadedProperties.find(p => p.id === propertyId);
            if (property) {
                const f = property.fields;
                // Pass property ID and location info for centering
                const params = new URLSearchParams({
                    property: propertyId,
                    county: f.COUNTY,
                    section: f.SEC,
                    township: f.TWN,
                    range: f.RNG
                });
                window.open(`/portal/oklahoma-map?${params.toString()}`, '_blank');
            }
        }
        
        // View well on Map
        function viewWellOnMap(wellId) {
            const well = loadedWells.find(w => w.id === wellId);
            if (well) {
                const f = well.fields;
                // Pass well ID and location info for centering
                const params = new URLSearchParams({
                    well: wellId,
                    county: f.County,
                    section: f.Section,
                    township: f.Township,
                    range: f.Range
                });
                window.open(`/portal/oklahoma-map?${params.toString()}`, '_blank');
            }
        }
        
        // View well on Map from modal
        function viewWellOnMapFromModal() {
            const wellId = document.getElementById('wellDetailsId').value;
            if (wellId) {
                viewWellOnMap(wellId);
            }
        }
        
        // View property on Map from modal
        function viewPropertyOnMapFromModal() {
            const propertyId = document.getElementById('propertyDetailsId').value;
            if (propertyId) {
                viewOnMap(propertyId);
            }
        }
        
        const planConfigs = {
            'Free': { properties: 1, wells: 1 },
            'Starter': { properties: 10, wells: 10 },
            'Standard': { properties: 50, wells: 50 },
            'Professional': { properties: 250, wells: 250 },
            'Business': { properties: 500, wells: 500 },
            'Enterprise': { properties: Infinity, wells: Infinity }
        };
        let currentTab = 'properties';
        let currentUser = null; // Store user data globally
        
        // Modal stacking management
        const modalStack = [];
        const MAX_MODAL_DEPTH = 4; // Maximum number of stacked modals
        
        // Bulk Selection State
        let selectedProperties = new Set();
        let selectedWells = new Set();
        let selectedActivity = new Set();
        let selectedDocuments = new Set();
        
        // Bulk Selection Functions
        function updateBulkActionVisibility() {
            // Show/hide bulk action bars based on selection state
            const propBar = document.getElementById('propertiesBulkActionBar');
            const wellBar = document.getElementById('wellsBulkActionBar');
            const activityBar = document.getElementById('activityBulkBar');
            const docBar = document.getElementById('documentsBulkActionBar');
            
            if (propBar) {
                propBar.style.display = selectedProperties.size > 0 ? 'flex' : 'none';
                const count = document.querySelector('#propertiesBulkActionBar .selected-count');
                if (count) count.textContent = selectedProperties.size;
            }
            
            if (wellBar) {
                wellBar.style.display = selectedWells.size > 0 ? 'flex' : 'none';
                const count = document.querySelector('#wellsBulkActionBar .selected-count');
                if (count) count.textContent = selectedWells.size;
            }
            
            if (activityBar) {
                activityBar.classList.toggle('active', selectedActivity.size > 0);
                const count = document.getElementById('activitySelectedCount');
                if (count) count.textContent = selectedActivity.size;
            }
            
            if (docBar) {
                docBar.style.display = selectedDocuments.size > 0 ? 'flex' : 'none';
                docBar.className = 'bulk-action-bar active';
                docBar.innerHTML = `
                    <div class="bulk-count"><span class="selected-count">${selectedDocuments.size}</span> selected</div>
                    <div class="bulk-actions">
                        <button class="bulk-btn" onclick="bulkDeleteSelected('documents')">
                            Delete Selected
                        </button>
                    </div>
                    <span class="bulk-clear" onclick="clearSelection('documents')">Clear selection</span>
                `;
            }
        }
        
        function togglePropertySelection(propertyId, checked) {
            if (checked) {
                selectedProperties.add(propertyId);
            } else {
                selectedProperties.delete(propertyId);
            }
            updateBulkActionVisibility();
            updateSelectAllState('properties');
        }
        
        function toggleWellSelection(wellId, checked) {
            if (checked) {
                selectedWells.add(wellId);
            } else {
                selectedWells.delete(wellId);
            }
            updateBulkActionVisibility();
            updateSelectAllState('wells');
        }
        
        function toggleDocumentSelection(docId, checked) {
            if (checked) {
                selectedDocuments.add(docId);
            } else {
                selectedDocuments.delete(docId);
            }
            updateBulkActionVisibility();
        }
        
        function selectAllItems(type, checked) {
            if (type === 'properties') {
                const checkboxes = document.querySelectorAll('.property-checkbox');
                selectedProperties.clear();
                checkboxes.forEach(cb => {
                    cb.checked = checked;
                    if (checked) selectedProperties.add(cb.dataset.id);
                });
            } else if (type === 'wells') {
                const checkboxes = document.querySelectorAll('.well-checkbox');
                selectedWells.clear();
                checkboxes.forEach(cb => {
                    cb.checked = checked;
                    if (checked) selectedWells.add(cb.dataset.id);
                });
            } else if (type === 'documents') {
                const checkboxes = document.querySelectorAll('.document-checkbox');
                selectedDocuments.clear();
                checkboxes.forEach(cb => {
                    cb.checked = checked;
                    if (checked) selectedDocuments.add(cb.dataset.id);
                });
            }
            updateBulkActionVisibility();
        }
        
        function updateSelectAllState(type) {
            const selectAllId = type === 'properties' ? 'selectAllProperties' : 'selectAllWells';
            const checkboxes = document.querySelectorAll(type === 'properties' ? '.property-checkbox' : '.well-checkbox');
            const selectedSet = type === 'properties' ? selectedProperties : selectedWells;
            const selectAllCheckbox = document.getElementById(selectAllId);
            
            if (!selectAllCheckbox) return;
            
            if (selectedSet.size === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedSet.size === checkboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }
        }
        
        let deleteInProgress = false;
        
        async function bulkDeleteSelected(type) {
            if (deleteInProgress) return;
            deleteInProgress = true;
            
            const selectedSet = type === 'properties' ? selectedProperties : 
                               type === 'wells' ? selectedWells : 
                               type === 'documents' ? selectedDocuments : selectedActivity;
            const itemName = type === 'properties' ? 'properties' : 
                           type === 'wells' ? 'wells' : 
                           type === 'documents' ? 'documents' : 'activities';
            
            if (selectedSet.size === 0) {
                deleteInProgress = false;
                return;
            }
            
            // Use custom confirm dialog instead of system confirm
            const confirmed = await showConfirm(
                `Delete ${selectedSet.size} ${itemName}?<br><br>This action cannot be undone.`,
                {
                    title: `Delete ${selectedSet.size} ${itemName}?`,
                    confirmText: 'Delete',
                    cancelText: 'Cancel'
                }
            );
            
            if (!confirmed) {
                deleteInProgress = false;
                return;
            }
            
            // Get the delete button and add loading state
            const deleteBtn = document.querySelector(`[onclick*="bulkDeleteSelected('${type}')"]`);
            if (deleteBtn) {
                deleteBtn.classList.add('loading');
                deleteBtn.disabled = true;
            }
            
            // Show immediate feedback
            const totalItems = selectedSet.size;
            showToast(`Deleting ${totalItems} ${itemName}...`, 'info', 0); // 0 = persistent until manually dismissed
            
            try {
                const itemsToDelete = Array.from(selectedSet);
                let successCount = 0;
                let failCount = 0;
                
                // Batch deletes in groups of 5 (Airtable rate limit)
                for (let i = 0; i < itemsToDelete.length; i += 5) {
                    const batch = itemsToDelete.slice(i, i + 5);
                    const deletePromises = batch.map(async id => {
                        const endpoint = type === 'properties' ? `/api/properties/${id}` : 
                                       type === 'wells' ? `/api/wells/${id}` : 
                                       type === 'documents' ? `/api/documents/${id}` : `/api/activity/${id}`;
                        try {
                            const res = await fetch(endpoint, { method: 'DELETE' });
                            if (res.ok) {
                                successCount++;
                            } else {
                                const error = await res.text();
                                console.error(`Failed to delete ${type} ${id}:`, res.status, error);
                                failCount++;
                            }
                        } catch (err) {
                            console.error(`Error deleting ${type} ${id}:`, err);
                            failCount++;
                        }
                    });
                    
                    await Promise.all(deletePromises);
                    
                    // Update progress in toast
                    const processed = Math.min(i + 5, totalItems);
                    if (processed < totalItems) {
                        // Dismiss previous toast and show updated progress
                        dismissToast();
                        showToast(`Deleting ${itemName}... ${processed}/${totalItems}`, 'info', 0);
                    }
                    
                    // Wait 1 second between batches for rate limiting
                    if (i + 5 < itemsToDelete.length) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                // Dismiss progress toast before showing final result
                dismissToast();
                
                // Clear selection
                selectedSet.clear();
                updateBulkActionVisibility();
                
                // Reload data
                await loadAllData();
                
                // Show success toast
                if (failCount === 0) {
                    showToast(`Successfully deleted ${successCount} ${itemName}`, 'success', 4000);
                } else {
                    showToast(`Deleted ${successCount} ${itemName}. ${failCount} failed.`, 'error', 6000);
                }
                
            } catch (err) {
                console.error(`Bulk delete ${itemName} error:`, err);
                showToast(`Failed to delete ${itemName}. Please try again.`, 'error');
            } finally {
                // Remove loading state
                if (deleteBtn) {
                    deleteBtn.classList.remove('loading');
                    deleteBtn.disabled = false;
                }
                deleteInProgress = false;
            }
        }
        
        function clearSelection(type) {
            if (type === 'properties') {
                selectedProperties.clear();
                document.querySelectorAll('.property-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('selectAllProperties').checked = false;
                document.getElementById('selectAllProperties').indeterminate = false;
            } else if (type === 'wells') {
                selectedWells.clear();
                document.querySelectorAll('.well-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('selectAllWells').checked = false;
                document.getElementById('selectAllWells').indeterminate = false;
            } else if (type === 'activity') {
                selectedActivity.clear();
                document.querySelectorAll('.activity-checkbox-input').forEach(cb => cb.checked = false);
            } else if (type === 'documents') {
                selectedDocuments.clear();
                document.querySelectorAll('.document-checkbox').forEach(cb => cb.checked = false);
            }
            updateBulkActionVisibility();
        }
        
        async function bulkAddToWells() {
            if (selectedProperties.size === 0) return;
            
            // Get selected property data
            const selectedPropData = loadedProperties.filter(p => selectedProperties.has(p.id));
            
            try {
                const addPromises = selectedPropData.map(async (prop) => {
                    const fields = prop.fields;
                    
                    // Check if well already exists for this property
                    const existingWell = loadedWells.find(w => 
                        w.fields.Section === fields.SEC &&
                        w.fields.Township === fields.TWN &&
                        w.fields.Range === fields.RNG &&
                        w.fields.County === fields.COUNTY
                    );
                    
                    if (existingWell) {
                        console.log(`Well already exists for ${fields.COUNTY} S${fields.SEC} T${fields.TWN} R${fields.RNG}`);
                        return null;
                    }
                    
                    // Create well data from property
                    const wellData = {
                        'Well Name': `${fields.COUNTY} S${fields.SEC} T${fields.TWN} R${fields.RNG}`,
                        'County': fields.COUNTY,
                        'Section': fields.SEC,
                        'Township': fields.TWN,
                        'Range': fields.RNG,
                        'API Number': '', // Will be filled when user adds it
                        'Email': currentUser.email
                    };
                    
                    const res = await fetch('/api/wells', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(wellData)
                    });
                    
                    if (!res.ok) throw new Error(`Failed to create well for ${wellData['Well Name']}`);
                    return await res.json();
                });
                
                const results = await Promise.all(addPromises);
                const created = results.filter(r => r !== null).length;
                const skipped = results.length - created;
                
                // Clear selection and reload data
                clearSelection('properties');
                await loadWells();
                
                let message = `Successfully created ${created} wells`;
                if (skipped > 0) message += ` (${skipped} already existed)`;
                showToast(message);
                
            } catch (err) {
                console.error('Bulk add to wells error:', err);
                showToast('Failed to add some properties as wells. Please try again.', 'error');
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Check for credit pack purchase success
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('purchase') === 'success') {
                    // Remove the query parameter from URL without reload
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, '', newUrl);
                    // Show success toast after a brief delay to ensure DOM is ready
                    setTimeout(() => {
                        showToast('Credit pack purchased successfully! Credits have been added to your account.', 'success', 6000);
                    }, 500);
                }

                const res = await fetch('/api/auth/me');
                if (!res.ok) { window.location.href = '/portal/login'; return; }
                currentUser = await res.json();
                document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                document.getElementById('planBadge').textContent = currentUser.plan || 'FREE';
                const limits = planConfigs[currentUser.plan] || { properties: 1, wells: 0 };
                document.getElementById('propLimit').textContent = limits.properties === Infinity ? '' : limits.properties;
                document.getElementById('wellLimit').textContent = limits.wells === Infinity ? '' : limits.wells;
                
                // Hide upgrade link for Business/Enterprise users
                if (currentUser.plan === 'Enterprise' || currentUser.plan === 'Business') {
                    document.getElementById('upgradeLink').style.display = 'none';
                }

                // Show export buttons for Professional+ users
                if (currentUser.plan === 'Professional' || currentUser.plan === 'Business' || currentUser.plan === 'Enterprise') {
                    document.getElementById('exportPropertiesBtn').style.display = 'inline-flex';
                    document.getElementById('exportWellsBtn').style.display = 'inline-flex';
                }

                // Show Documents tab for all users
                console.log('Showing documents tab for all users');
                document.getElementById('documentsTab').style.display = 'flex';
                // Also show document count in plan info
                if (document.getElementById('docCountItem')) {
                    document.getElementById('docCountItem').style.display = 'flex';
                    document.getElementById('docCountDisplay').style.display = 'flex';
                }
                
                // Hide add/edit/delete buttons for Viewers
                if (currentUser.role === 'Viewer') {
                    // Hide property add/import buttons
                    const addPropertyBtn = document.getElementById('addPropertyBtn');
                    const bulkUploadBtn = document.getElementById('bulkUploadBtn');
                    if (addPropertyBtn) addPropertyBtn.style.display = 'none';
                    if (bulkUploadBtn) bulkUploadBtn.style.display = 'none';

                    // Hide well add/import buttons
                    const addWellBtn = document.getElementById('addWellBtn');
                    const bulkUploadWellsBtn = document.getElementById('bulkUploadWellsBtn');
                    if (addWellBtn) addWellBtn.style.display = 'none';
                    if (bulkUploadWellsBtn) bulkUploadWellsBtn.style.display = 'none';

                    // Hide bulk action bars (delete buttons)
                    const propertiesBulkActionBar = document.getElementById('propertiesBulkActionBar');
                    const wellsBulkActionBar = document.getElementById('wellsBulkActionBar');
                    const activityBulkActionBar = document.getElementById('activityBulkActionBar');
                    if (propertiesBulkActionBar) propertiesBulkActionBar.style.display = 'none';
                    if (wellsBulkActionBar) wellsBulkActionBar.style.display = 'none';
                    if (activityBulkActionBar) activityBulkActionBar.style.display = 'none';

                    // Hide the dividers between action groups when buttons are hidden
                    document.querySelectorAll('.action-divider').forEach(d => d.style.display = 'none');
                }
                
                await loadAllData();

                // Initialize search/sort controls
                initWellsControls();
                initPropertiesControls();
                initDocumentsControls();
            } catch (err) { console.error('Dashboard init error:', err); window.location.href = '/portal/login'; }

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentTab = tab.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(currentTab + '-tab').classList.add('active');
                    
                    // Load activity data when tab is selected (lazy load)
                    if (currentTab === 'activity') {
                        loadActivity();
                    }
                    // Load documents data when tab is selected (lazy load)
                    if (currentTab === 'documents') {
                        loadDocuments();
                    } else {
                        // Stop polling when leaving documents tab
                        stopDocumentPolling();
                    }
                });
            });
            
            // Tab Visibility API - Auto-refresh when returning to tab
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden && currentTab === 'documents') {
                    // User returned to tab while on documents
                    const hasProcessing = loadedDocuments.some(doc => 
                        doc.status === 'processing' || doc.status === 'pending'
                    );
                    if (hasProcessing) {
                        console.log('[Documents] Tab became visible with processing documents, refreshing...');
                        await loadDocuments();
                    }
                }
            });
            
            // Bulk selection event listeners
            document.addEventListener('change', (e) => {
                // Handle select all checkboxes
                if (e.target.id === 'selectAllProperties') {
                    selectAllItems('properties', e.target.checked);
                } else if (e.target.id === 'selectAllWells') {
                    selectAllItems('wells', e.target.checked);
                }
                // Handle individual checkboxes
                else if (e.target.classList.contains('property-checkbox')) {
                    togglePropertySelection(e.target.dataset.id, e.target.checked);
                } else if (e.target.classList.contains('well-checkbox')) {
                    toggleWellSelection(e.target.dataset.id, e.target.checked);
                } else if (e.target.classList.contains('document-checkbox')) {
                    toggleDocumentSelection(e.target.dataset.id, e.target.checked);
                }
            });
            
            // Add button event listeners inside DOMContentLoaded
            // Well Modal
            document.getElementById('addWellBtn').addEventListener('click', () => { 
                document.getElementById('addWellModal').style.display = 'flex'; 
            });
            
            // Bulk Upload Properties Modal
            const bulkUploadBtn = document.getElementById('bulkUploadBtn');
            console.log('Bulk upload button:', bulkUploadBtn);
            if (bulkUploadBtn) {
                bulkUploadBtn.addEventListener('click', () => {
                    console.log('Import button clicked');
                    openBulkUploadModal();
                });
            } else {
                console.error('Bulk upload button not found!');
            }
            
            // Bulk Upload Wells Modal
            document.getElementById('bulkUploadWellsBtn').addEventListener('click', () => {
                openBulkUploadWellsModal();
            });
            
            // Add Well Modal event listeners
            document.getElementById('addWellModal').addEventListener('click', e => { 
                if (e.target.id === 'addWellModal') closeWellModal(); 
            });
            
            document.getElementById('addWellForm').addEventListener('submit', async e => {
                e.preventDefault();
                const data = { 
                    apiNumber: document.getElementById('apiNumber').value.trim(),
                    notes: document.getElementById('wellNotes').value.trim()
                };
                
                try {
                    document.querySelector('.btn-submit').disabled = true;
                    const res = await fetch('/api/wells/track', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || 'Failed to add well');
                    }
                    
                    const result = await res.json();
                    closeWellModal();
                    showToast('Well added successfully');
                    loadWells();
                    loadActivityStats();
                } catch (err) {
                    showToast('Error: ' + err.message, 'error');
                } finally {
                    document.querySelector('.btn-submit').disabled = false;
                }
            });
        });
        
        async function loadAllData() {
            const promises = [loadProperties(), loadWells(), loadActivity(), loadActivityStats()];
            
            // Only load documents if the tab is visible (user has access)
            if (document.getElementById('documentsTab') && document.getElementById('documentsTab').style.display !== 'none') {
                promises.push(loadDocuments());
                promises.push(loadUsageStats());
            }
            
            await Promise.all(promises);
        }

        async function loadProperties() {
            try {
                const res = await fetch('/api/properties');
                if (!res.ok) throw new Error('Failed to load');
                const properties = await res.json();
                loadedProperties = properties; // Store for filtering/sorting
                document.getElementById('propCount').textContent = properties.length;
                updateTotalCount();

                // Render table immediately (with zero counts)
                renderPropertiesTable();

                // Fetch link counts in background and re-render when ready
                if (properties.length > 0) {
                    fetchPropertyLinkCounts();
                }
            } catch { document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p style="color: var(--error);">Error loading. Refresh page.</p></div>'; }
        }

        // Fetch link counts and merge into loadedProperties
        async function fetchPropertyLinkCounts() {
            try {
                const res = await fetch('/api/properties/link-counts');
                if (!res.ok) return;
                const counts = await res.json();

                // Merge counts into loadedProperties
                for (const prop of loadedProperties) {
                    if (counts[prop.id]) {
                        prop._linkCounts = counts[prop.id];
                    }
                }

                // Re-render with updated counts
                renderPropertiesTable();
            } catch (err) {
                console.error('Failed to load link counts:', err);
            }
        }
        
        // Generate a map link for a property section (centers on general area)
        function generateSectionMapLink(sec, twn, rng, county) {
            // Link to OCC GIS with a search query - this will show the general area
            // We can't pin-drop without coordinates, but we can search
            const searchTerm = encodeURIComponent(`${county || ''} ${sec} ${twn} ${rng}`.trim());
            return `https://gis.occ.ok.gov/portal/apps/webappviewer/index.html?id=ba9b8612132f4106be6e3553dc0b827b`;
        }

        async function loadWells() {
            try {
                const res = await fetch('/api/wells');
                if (!res.ok) throw new Error('Failed to load');
                const wells = await res.json();
                loadedWells = wells; // Store for filtering/sorting
                document.getElementById('wellCount').textContent = wells.length;
                updateTotalCount();


                // Render the table (handles empty state internally)
                renderWellsTable();

                // Fetch link counts in background (non-blocking)
                fetchWellLinkCounts();
            } catch { document.getElementById('wellsContent').innerHTML = '<div class="empty-state"><p style="color: var(--error);">Error loading. Refresh page.</p></div>'; }
        }

        // Fetch link counts and merge into loadedWells
        async function fetchWellLinkCounts() {
            try {
                const res = await fetch('/api/wells/link-counts');
                if (!res.ok) return;
                const counts = await res.json();

                // Merge counts into loadedWells
                for (const well of loadedWells) {
                    if (counts[well.id]) {
                        well._linkCounts = counts[well.id];
                    }
                }

                // Re-render with updated counts
                renderWellsTable();
            } catch (err) {
                console.error('Failed to load well link counts:', err);
            }
        }

        // Properties Search & Sort State
        let propertiesSearchTerm = '';
        let propertiesSortBy = 'legal-asc';

        // Initialize Properties Controls (call this after user loads)
        function initPropertiesControls() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Show/hide controls based on plan
            document.getElementById('propertiesControls').style.display = hasSearch ? 'flex' : 'none';
            
            if (!hasSearch) return;
            
            // Search input handler
            document.getElementById('propertiesSearch').addEventListener('input', (e) => {
                propertiesSearchTerm = e.target.value.toLowerCase().trim();
                renderPropertiesTable();
            });
            
            // Sort select handler
            document.getElementById('propertiesSort').addEventListener('change', (e) => {
                propertiesSortBy = e.target.value;
                renderPropertiesTable();
            });
        }

        // Filter properties based on search term
        function filterProperties(properties) {
            if (!propertiesSearchTerm) return properties;
            
            return properties.filter(p => {
                const f = p.fields;
                const searchable = [
                    f.COUNTY || '',
                    f.SEC || '',
                    f.TWN || '',
                    f.RNG || '',
                    f.MERIDIAN || '',
                    f.Notes || ''
                ].join(' ').toLowerCase();
                
                return searchable.includes(propertiesSearchTerm);
            });
        }

        // Sort properties based on selected option
        function sortProperties(properties) {
            const [field, direction] = propertiesSortBy.split('-');
            const multiplier = direction === 'asc' ? 1 : -1;
            
            return [...properties].sort((a, b) => {
                if (field === 'legal') {
                    // Legal Description: County  Township  Range  Section
                    const aCounty = (a.fields.COUNTY || '').toLowerCase();
                    const bCounty = (b.fields.COUNTY || '').toLowerCase();
                    if (aCounty !== bCounty) {
                        return aCounty < bCounty ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse township (e.g., "T24N" -> { num: 24, dir: "N" })
                    const parseTownship = (twp) => {
                        const match = (twp || '').match(/T?(\d+)([NS])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aTwp = parseTownship(a.fields.TWN);
                    const bTwp = parseTownship(b.fields.TWN);
                    if (aTwp.num !== bTwp.num) {
                        return aTwp.num < bTwp.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aTwp.dir !== bTwp.dir) {
                        return aTwp.dir < bTwp.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse range (e.g., "R10W" -> { num: 10, dir: "W" })
                    const parseRange = (rng) => {
                        const match = (rng || '').match(/R?(\d+)([EW])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aRng = parseRange(a.fields.RNG);
                    const bRng = parseRange(b.fields.RNG);
                    if (aRng.num !== bRng.num) {
                        return aRng.num < bRng.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aRng.dir !== bRng.dir) {
                        return aRng.dir < bRng.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Section (numeric)
                    const aSection = parseInt(a.fields.SEC) || 0;
                    const bSection = parseInt(b.fields.SEC) || 0;
                    return aSection < bSection ? -1 * multiplier : (aSection > bSection ? 1 * multiplier : 0);
                    
                } else if (field === 'date') {
                    // Date Added - use createdTime from Airtable
                    const aDate = new Date(a.createdTime || 0);
                    const bDate = new Date(b.createdTime || 0);
                    return aDate < bDate ? -1 * multiplier : (aDate > bDate ? 1 * multiplier : 0);
                    
                } else if (field === 'acres') {
                    // Total Acres - sum of RI and WI acres
                    const aTotal = (parseFloat(a.fields['RI Acres'] || 0) + parseFloat(a.fields['WI Acres'] || 0));
                    const bTotal = (parseFloat(b.fields['RI Acres'] || 0) + parseFloat(b.fields['WI Acres'] || 0));
                    return aTotal < bTotal ? -1 * multiplier : (aTotal > bTotal ? 1 * multiplier : 0);

                } else if (field === 'wells') {
                    // Linked Wells count
                    const aCount = a._linkCounts?.wells || 0;
                    const bCount = b._linkCounts?.wells || 0;
                    return aCount < bCount ? -1 * multiplier : (aCount > bCount ? 1 * multiplier : 0);

                } else if (field === 'documents') {
                    // Linked Documents count
                    const aCount = a._linkCounts?.documents || 0;
                    const bCount = b._linkCounts?.documents || 0;
                    return aCount < bCount ? -1 * multiplier : (aCount > bCount ? 1 * multiplier : 0);

                } else if (field === 'filings') {
                    // OCC Filings count
                    const aCount = a._linkCounts?.filings || 0;
                    const bCount = b._linkCounts?.filings || 0;
                    return aCount < bCount ? -1 * multiplier : (aCount > bCount ? 1 * multiplier : 0);
                }

                return 0;
            });
        }

        // Render the properties table (extracted from loadProperties)
        function renderPropertiesTable() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Apply filter and sort
            let displayProperties = loadedProperties;
            if (hasSearch) {
                displayProperties = filterProperties(loadedProperties);
                displayProperties = sortProperties(displayProperties);
                
                // Update results count
                const countEl = document.getElementById('propertiesResultsCount');
                if (propertiesSearchTerm) {
                    countEl.textContent = `${displayProperties.length} of ${loadedProperties.length} properties`;
                } else {
                    countEl.textContent = `${loadedProperties.length} properties`;
                }
            }
            
            if (displayProperties.length === 0 && loadedProperties.length > 0) {
                // No search results
                document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p>No properties match your search.</p></div>';
                return;
            }
            
            if (displayProperties.length === 0) {
                document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p>No properties yet. Add your first property to start monitoring.</p></div>';
                return;
            }
            
            // Build table with conditional checkbox column for non-Viewers
            const isViewer = currentUser?.role === 'Viewer';
            let html = '<table class="data-table"><colgroup>';
            if (!isViewer) html += '<col class="col-select">';
            html += '<col class="col-prop-county"><col class="col-prop-legal"><col class="col-prop-group"><col class="col-prop-acres"><col class="col-prop-notes"><col class="col-links"></colgroup><thead><tr>';
            if (!isViewer) html += '<th class="bulk-only"><input type="checkbox" id="selectAllProperties" title="Select all"></th>';
            html += '<th>County</th><th>Legal</th><th class="col-prop-group">Group</th><th style="text-align: right;"><span class="desktop-only-total">Total </span><span class="mobile-only-acres"></span>Acres</th><th class="col-prop-notes-cell">Notes</th><th style="text-align: right;">Links</th></tr></thead><tbody>';
            
            // SVG icons for links column
            const wellsIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>';
            const docsIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>';
            const filingsIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>';
            // Link/chain icon for mobile total (Heroicons)
            const linkIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>';

            displayProperties.forEach(p => {
                const f = p.fields;
                const str = `T${f.TWN} R${f.RNG} ${f.SEC}`;
                const riAcres = parseFloat(f['RI Acres'] || 0);
                const wiAcres = parseFloat(f['WI Acres'] || 0);
                const totalAcres = riAcres + wiAcres;
                const acresDisplay = totalAcres > 0 ? totalAcres.toFixed(2) : '';
                const notesText = f.Notes ? escapeHtml(f.Notes.substring(0, 80)) + (f.Notes.length > 80 ? '...' : '') : '';
                const notes = notesText ? `<span style="color: var(--slate-blue); font-size: 13px;">${notesText}</span>` : '<em style="color: #A0AEC0;"></em>';
                const group = f.Group ? `<span style="color: var(--oil-navy); font-size: 12px; background: #F1F5F9; padding: 2px 8px; border-radius: 12px;">${escapeHtml(f.Group)}</span>` : '<em style="color: #A0AEC0;"></em>';

                // Get link counts (populated from API or default to 0)
                const linkCounts = p._linkCounts || { wells: 0, documents: 0, filings: 0 };
                const wellsClass = linkCounts.wells === 0 ? 'link-count zero' : 'link-count';
                const docsClass = linkCounts.documents === 0 ? 'link-count zero' : 'link-count';
                const filingsClass = linkCounts.filings === 0 ? 'link-count zero' : 'link-count';
                const totalLinks = linkCounts.wells + linkCounts.documents + linkCounts.filings;
                const totalClass = totalLinks === 0 ? 'link-total zero' : 'link-total';

                html += `<tr onclick="openPropertyDetails('${p.id}')" style="cursor: pointer;">`;
                if (!isViewer) {
                    html += `<td class="bulk-only" onclick="event.stopPropagation()"><input type="checkbox" class="property-checkbox" data-id="${p.id}"></td>`;
                }
                html += `<td>${escapeHtml(cleanCountyDisplay(f.COUNTY)) || ''}</td>
                    <td><strong>${str}</strong></td>
                    <td class="col-prop-group">${group}</td>
                    <td style="text-align: right;">${acresDisplay}</td>
                    <td title="${f.Notes ? escapeHtml(f.Notes) : ''}" class="col-prop-notes-cell">${notes}</td>
                    <td>
                        <div class="links-cell">
                            <div class="link-breakdown">
                                <span class="${wellsClass}" title="Linked Wells">${wellsIcon}${linkCounts.wells}</span>
                                <span class="link-separator"></span>
                                <span class="${docsClass}" title="Documents">${docsIcon}${linkCounts.documents}</span>
                                <span class="link-separator"></span>
                                <span class="${filingsClass}" title="OCC Filings">${filingsIcon}${linkCounts.filings}</span>
                            </div>
                            <span class="${totalClass}" title="Total Links (Wells: ${linkCounts.wells}, Docs: ${linkCounts.documents}, OCC: ${linkCounts.filings})">${linkIcon}${totalLinks}</span>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('propertiesContent').innerHTML = html;
            
            // Check if any properties have groups and show/hide Group column
            const hasGroups = displayProperties.some(p => p.fields.Group);
            const propertiesTable = document.querySelector('#propertiesContent .data-table');
            if (hasGroups) {
                propertiesTable.classList.add('has-groups');
            } else {
                propertiesTable.classList.remove('has-groups');
            }
            
            // Update bulk selection state after table render
            updateSelectAllState('properties');
            updateBulkActionVisibility();
        }

        // Wells Search & Sort State
        let wellsSearchTerm = '';
        let wellsSortBy = 'name-asc';

        // Initialize Wells Controls (call this after user loads)
        function initWellsControls() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Show/hide controls based on plan
            document.getElementById('wellsControls').style.display = hasSearch ? 'flex' : 'none';
            
            if (!hasSearch) return;
            
            // Search input handler
            document.getElementById('wellsSearch').addEventListener('input', (e) => {
                wellsSearchTerm = e.target.value.toLowerCase().trim();
                renderWellsTable();
            });
            
            // Sort select handler
            document.getElementById('wellsSort').addEventListener('change', (e) => {
                wellsSortBy = e.target.value;
                renderWellsTable();
            });
        }

        // Filter wells based on search term
        function filterWells(wells) {
            if (!wellsSearchTerm) return wells;
            
            return wells.filter(w => {
                const f = w.fields;
                const searchable = [
                    f['Well Name'] || '',
                    f['Operator'] || '',
                    f['API Number'] || '',
                    f['County'] || ''
                ].join(' ').toLowerCase();
                
                return searchable.includes(wellsSearchTerm);
            });
        }

        // Sort wells based on selected option
        function sortWells(wells) {
            const [field, direction] = wellsSortBy.split('-');
            const multiplier = direction === 'asc' ? 1 : -1;
            
            return [...wells].sort((a, b) => {
                if (field === 'legal') {
                    // Legal Description: County  Township  Range  Section
                    const aCounty = (a.fields['County'] || '').toLowerCase();
                    const bCounty = (b.fields['County'] || '').toLowerCase();
                    if (aCounty !== bCounty) {
                        return aCounty < bCounty ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse township (e.g., "T24N" -> { num: 24, dir: "N" })
                    const parseTownship = (twp) => {
                        const match = (twp || '').match(/T?(\d+)([NS])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aTwp = parseTownship(a.fields['Township']);
                    const bTwp = parseTownship(b.fields['Township']);
                    if (aTwp.num !== bTwp.num) {
                        return aTwp.num < bTwp.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aTwp.dir !== bTwp.dir) {
                        return aTwp.dir < bTwp.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Parse range (e.g., "R10W" -> { num: 10, dir: "W" })
                    const parseRange = (rng) => {
                        const match = (rng || '').match(/R?(\d+)([EW])?/i);
                        return match ? { num: parseInt(match[1]), dir: (match[2] || '').toLowerCase() } : { num: 0, dir: '' };
                    };
                    
                    const aRng = parseRange(a.fields['Range']);
                    const bRng = parseRange(b.fields['Range']);
                    if (aRng.num !== bRng.num) {
                        return aRng.num < bRng.num ? -1 * multiplier : 1 * multiplier;
                    }
                    if (aRng.dir !== bRng.dir) {
                        return aRng.dir < bRng.dir ? -1 * multiplier : 1 * multiplier;
                    }
                    
                    // Section (numeric)
                    const aSection = parseInt(a.fields['Section']) || 0;
                    const bSection = parseInt(b.fields['Section']) || 0;
                    return aSection < bSection ? -1 * multiplier : (aSection > bSection ? 1 * multiplier : 0);
                    
                } else if (field === 'date') {
                    // Date Added - use createdTime from Airtable
                    const aDate = new Date(a.createdTime || 0);
                    const bDate = new Date(b.createdTime || 0);
                    return aDate < bDate ? -1 * multiplier : (aDate > bDate ? 1 * multiplier : 0);
                    
                } else if (field === 'name') {
                    // Well Name
                    const aVal = (a.fields['Well Name'] || '').toLowerCase();
                    const bVal = (b.fields['Well Name'] || '').toLowerCase();
                    return aVal < bVal ? -1 * multiplier : (aVal > bVal ? 1 * multiplier : 0);
                    
                } else if (field === 'operator') {
                    // Operator
                    const aVal = (a.fields['Operator'] || '').toLowerCase();
                    const bVal = (b.fields['Operator'] || '').toLowerCase();
                    return aVal < bVal ? -1 * multiplier : (aVal > bVal ? 1 * multiplier : 0);

                } else if (field === 'properties') {
                    // Linked Properties count
                    const aCount = a._linkCounts?.properties || 0;
                    const bCount = b._linkCounts?.properties || 0;
                    return aCount < bCount ? -1 * multiplier : (aCount > bCount ? 1 * multiplier : 0);

                } else if (field === 'documents') {
                    // Linked Documents count
                    const aCount = a._linkCounts?.documents || 0;
                    const bCount = b._linkCounts?.documents || 0;
                    return aCount < bCount ? -1 * multiplier : (aCount > bCount ? 1 * multiplier : 0);

                } else if (field === 'filings') {
                    // OCC Filings count
                    const aCount = a._linkCounts?.filings || 0;
                    const bCount = b._linkCounts?.filings || 0;
                    return aCount < bCount ? -1 * multiplier : (aCount > bCount ? 1 * multiplier : 0);
                }

                return 0;
            });
        }

        // Setup event delegation for production hover helpers
        function setupProductionHoverHelpers() {
            // Remove any existing event listeners to prevent duplicates
            document.querySelectorAll('.production-accordion-floating .hover-helper').forEach(el => {
                el.removeEventListener('mouseenter', handleProductionHover);
                el.removeEventListener('mouseleave', handleProductionHoverOut);
                el.removeEventListener('click', handleProductionClick);
            });
            
            // Add event listeners to all current hover helper elements
            document.querySelectorAll('.production-accordion-floating .hover-helper').forEach(el => {
                // Only add hover events on desktop
                if (window.innerWidth > 768) {
                    el.addEventListener('mouseenter', handleProductionHover);
                    el.addEventListener('mouseleave', handleProductionHoverOut);
                }
                // Always add click for mobile (but handler checks screen size)
                el.addEventListener('click', handleProductionClick);
            });
        }
        
        // Handle production hover helper mouseenter
        function handleProductionHover(e) {
            // Don't show desktop tooltip on mobile
            if (window.innerWidth <= 768) {
                return;
            }
            
            const helpKey = e.target.getAttribute('data-help');
            const helpText = getProductionHelpText(helpKey);
            
            // Debug logging
            console.log('Production hover - helpKey:', helpKey);
            console.log('Production hover - helpText:', helpText);
            console.log('Production hover - title:', getProductionTermTitle(helpKey));
            
            if (helpKey && helpText) {
                // Create and show tooltip
                const tooltip = document.createElement('div');
                tooltip.id = 'production-tooltip';
                tooltip.innerHTML = `<strong>${getProductionTermTitle(helpKey)}</strong><br>${helpText}`;
                tooltip.style.cssText = `
                    position: absolute;
                    background: var(--oil-navy);
                    color: white;
                    padding: 12px;
                    border-radius: 6px;
                    font-size: 13px;
                    line-height: 1.4;
                    max-width: 280px;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    pointer-events: none;
                `;
                
                // Position tooltip
                document.body.appendChild(tooltip);
                const rect = e.target.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                
                // Position above the element, centered
                let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                let top = rect.top - tooltipRect.height - 8;
                
                // Adjust if tooltip would go off screen
                if (left < 8) left = 8;
                if (left + tooltipRect.width > window.innerWidth - 8) {
                    left = window.innerWidth - tooltipRect.width - 8;
                }
                if (top < 8) {
                    top = rect.bottom + 8; // Show below instead
                }
                
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
                
                // Add highlight to the element
                e.target.style.backgroundColor = '#E0F2FE';
            }
        }
        
        // Handle production hover helper mouseleave
        function handleProductionHoverOut(e) {
            // Don't process hover events on mobile
            if (window.innerWidth <= 768) {
                return;
            }
            
            // Remove tooltip
            const tooltip = document.getElementById('production-tooltip');
            if (tooltip) {
                tooltip.remove();
            }
            // Remove highlight
            e.target.style.backgroundColor = '';
        }
        
        // Handle production helper click (mobile)
        function handleProductionClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Aggressive cleanup of any desktop tooltips
            setTimeout(() => {
                const tooltips = document.querySelectorAll('#production-tooltip, [id*="tooltip"]');
                tooltips.forEach(tooltip => tooltip.remove());
            }, 10);
            
            // Find the parent production-term container
            const productionTerm = e.target.closest('.production-term');
            if (!productionTerm) return;
            
            const explanation = productionTerm.querySelector('.production-explanation');
            if (!explanation) return;
            
            // Check if we're on mobile (screen width check)
            if (window.innerWidth > 768) {
                return; // Don't handle clicks on desktop
            }
            
            // Toggle expanded state
            const isExpanded = explanation.classList.contains('expanded');
            
            // Close any other open explanations first
            document.querySelectorAll('.production-explanation.expanded').forEach(exp => {
                exp.classList.remove('expanded');
                exp.closest('.production-term').classList.remove('production-term-expanded');
            });
            
            if (!isExpanded) {
                explanation.classList.add('expanded');
                productionTerm.classList.add('production-term-expanded');
            }
        }
        
        // Get help text for production terms
        function getProductionHelpText(helpKey) {
            const helpTexts = {
                "ipGas": "Initial Production Gas - 24-hour flow test rate when well first came online",
                "ipOil": "Initial Production Oil - 24-hour flow test rate when well first came online", 
                "ipWater": "Initial Production Water - 24-hour flow test rate when well first came online",
                "lateral": "Lateral Length - horizontal portion of wellbore drilled through the formation",
                "formation": "Geological Formation - the specific rock layer being produced for oil/gas",
                "formationDepth": "Formation Depth - vertical depth to the producing geological formation",
                "spudDate": "Spud Date - when drilling operations began at this well location",
                "completedDate": "Completion Date - when well construction finished and production equipment was installed",
                "firstProdDate": "First Production Date - when commercial oil/gas production began",
                "multiSection": "Multi-Section Horizontal - wellbore crosses multiple land sections for maximum formation contact"
            };
            return helpTexts[helpKey] || null;
        }

        // Get friendly title for production terms
        function getProductionTermTitle(helpKey) {
            const titles = {
                "ipGas": "Initial Production Gas",
                "ipOil": "Initial Production Oil", 
                "ipWater": "Initial Production Water",
                "lateral": "Lateral Length",
                "formation": "Geological Formation",
                "formationDepth": "Formation Depth",
                "spudDate": "Spud Date",
                "completedDate": "Completion Date",
                "firstProdDate": "First Production Date",
                "multiSection": "Multi-Section Horizontal"
            };
            return titles[helpKey] || helpKey;
        }

        // Generate expanded well card HTML
        function generateExpandedWellCard(w) {
            const f = w.fields;
            
            // Helper functions for formatting
            const formatDate = (dateStr) => {
                if (!dateStr || dateStr === '') return null;
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit', timeZone: 'America/Chicago' });
                } catch {
                    return null;
                }
            };
            
            const formatNumber = (num) => {
                if (!num) return null;
                return Number(num).toLocaleString();
            };
            
            // Prepare data
            const wellBaseName = f['Well Name'] || '';
            const wellNumber = f['Well Number'] || '';
            const wellFullName = wellNumber ? `${wellBaseName} ${wellNumber}` : wellBaseName;
            const wellName = wellFullName || 'Unknown Well';
            const apiNumber = f['API Number'] || '';
            const operator = f['Operator'] || '';
            const operatorPhone = f['Operator Phone'] || '';
            const contactPerson = f['Contact Name'] || f['Contact Person'] || '';
            const county = cleanCountyDisplay(f['County']) || '';
            const section = f['Section'] || '';
            const township = f['Township'] || '';
            const range = f['Range'] || '';
            const location = (section && township && range) ? `T${township} R${range} ${section}` : '';
            
            const completionDate = formatDate(f['Completion Date']);
            const firstProdDate = formatDate(f['First Production Date']);
            
            const status = f['Well Status'] || f['OCC Status'] || '';
            const wellType = f['Well Type'] || '';
            const formationName = f['Formation Name'] || '';
            const formationDepth = f['Formation Depth'];
            const formationDisplay = formationName && formationDepth 
                ? `${formationName} @ ${formatNumber(formationDepth)} ft`
                : formationName || '';
            
            const ipGas = f['IP Gas (MCF/day)'] ? formatNumber(f['IP Gas (MCF/day)']) : null;
            const ipOil = f['IP Oil (BBL/day)'] ? formatNumber(f['IP Oil (BBL/day)']) : null;
            
            const notes = f['Notes'] || '';
            
            return `
                <div class="well-expanded-card" style="padding: 20px; background: #fff; border: 1px solid #E5E7EB; border-radius: 8px; margin: 10px;">
                    <!-- Header (no well name repetition) -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div style="color: #6B7280; font-size: 12px; font-weight: 600; letter-spacing: 0.5px;">WELL DETAILS</div>
                        ${completionDate ? `<span style="background: var(--red-dirt); color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">Completed: ${completionDate}</span>` : ''}
                    </div>
                    
                    <!-- Formation & Production Info -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 0 0 16px 0;">
                    
                    <!-- Info Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0;">
                        <div>
                            <div style="color: #6B7280; font-size: 12px; margin-bottom: 4px;">STATUS</div>
                            <div style="font-size: 14px; font-weight: 600; color: ${status === 'Active' || status === 'AC' ? '#059669' : 'var(--oil-navy)'};">${status}</div>
                        </div>
                        <div>
                            <div style="color: #6B7280; font-size: 12px; margin-bottom: 4px;">FORMATION</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--oil-navy);">${formationDisplay}</div>
                        </div>
                        <div>
                            <div style="color: #6B7280; font-size: 12px; margin-bottom: 4px;">WELL TYPE</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--oil-navy);">${wellType}</div>
                        </div>
                        <div>
                            <div style="color: #6B7280; font-size: 12px; margin-bottom: 4px;">FIRST PRODUCTION</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--oil-navy);">${firstProdDate || ''}</div>
                        </div>
                    </div>
                    
                    <!-- Initial Production -->
                    ${(ipGas || ipOil) ? `
                    <div style="padding: 16px 0; border-bottom: 1px solid #E5E7EB;">
                        <div style="color: #6B7280; font-size: 12px; margin-bottom: 8px;">INITIAL PRODUCTION</div>
                        <div style="font-size: 14px; color: var(--oil-navy);">
                            ${ipGas ? `Gas: <strong>${ipGas} MCF/day</strong>` : ''}
                            ${ipGas && ipOil ? '  ' : ''}
                            ${ipOil ? `Oil: <strong>${ipOil} BBL/day</strong>` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Notes Section -->
                    <div style="padding: 16px 0; border-bottom: 1px solid #E5E7EB;">
                        <div style="color: #6B7280; font-size: 12px; margin-bottom: 8px;">NOTES</div>
                        <textarea 
                            id="well-notes-${w.id}" 
                            style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #E5E7EB; border-radius: 6px; font-family: inherit; font-size: 14px; resize: vertical;" 
                            placeholder="Add notes about this well..."
                            onchange="updateWellNotes('${w.id}')"
                        >${escapeHtml(notes)}</textarea>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            ${f['OCC Map Link'] && f['OCC Map Link'] !== '#' ? `<a href="${f['OCC Map Link']}" target="_blank" class="details-btn primary"> OCC Map</a>` : ''}
                            ${apiNumber ? `
                                <div class="occ-warning" style="display: inline-flex; align-items: center;">
                                    <a href="https://public.occ.ok.gov/OGCDWellRecords/Search.aspx?searchcommand=${encodeURIComponent(`{[OG Well Records]:[API Number]="${apiNumber}*"}`)}&cr=1" target="_blank" class="details-btn"> Well Records</a>
                                    <span class="occ-warning-icon">!</span>
                                    <div class="occ-tooltip">
                                        <strong>OCC Website Note:</strong> If you see a cookie error on OCC's site, try signing out of OCC first or open this link in an incognito/private window.
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <button type="button" class="btn-submit" onclick="saveWellNotes('${w.id}')" style="padding: 8px 20px;">Save Note</button>
                    </div>
                </div>`;
        }

        // Render the wells table (extracted from loadWells)
        function renderWellsTable() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Apply filter and sort
            let displayWells = loadedWells;
            if (hasSearch) {
                displayWells = filterWells(loadedWells);
                displayWells = sortWells(displayWells);
                
                // Update results count
                const countEl = document.getElementById('wellsResultsCount');
                if (wellsSearchTerm) {
                    countEl.textContent = `${displayWells.length} of ${loadedWells.length} wells`;
                } else {
                    countEl.textContent = `${loadedWells.length} wells`;
                }
            }
            
            if (displayWells.length === 0 && loadedWells.length > 0) {
                // No search results
                document.getElementById('wellsContent').innerHTML = '<div class="empty-state"><p>No wells match your search.</p></div>';
                return;
            }
            
            if (displayWells.length === 0) {
                document.getElementById('wellsContent').innerHTML = '<div class="empty-state"><p>No wells yet. Add your first well API to start monitoring.</p></div>';
                return;
            }
            
            // Clean table that opens modal on row click
            const isViewer = currentUser?.role === 'Viewer';
            let html = '<table class="data-table wells-table"><colgroup>';
            if (!isViewer) html += '<col class="col-select">';
            html += '<col class="col-well-info"><col class="col-well-operator"><col class="col-links"></colgroup><thead><tr>';
            if (!isViewer) html += '<th class="bulk-only"><input type="checkbox" id="selectAllWells" title="Select all"></th>';
            html += '<th>Well Information</th><th>Operator Contact</th><th style="text-align: right;">Links</th></tr></thead><tbody>';

            displayWells.forEach(w => {
                const f = w.fields;
                const wellBaseName = f['Well Name'] || '';
                const wellNumber = f['Well Number'] || '';
                const wellFullName = wellNumber ? `${wellBaseName} ${wellNumber}` : wellBaseName;
                const wellName = wellFullName ? escapeHtml(wellFullName) : '<em style="color: #A0AEC0;">Unknown</em>';
                const operator = f['Operator'] ? escapeHtml(f['Operator']) : '<em style="color: #A0AEC0;"></em>';
                const operatorPhone = f['Operator Phone'] || '';
                const contactPerson = f['Contact Name'] || f['Contact Person'] || '';
                const apiNumber = f['API Number'] || '';
                const status = f['Well Status'] || f['OCC Status'] || '';
                const wellType = f['Well Type'] || '';

                // Format location (county + legal)
                const county = cleanCountyDisplay(f['County']) || '';
                const section = f['Section'] || '';
                const township = f['Township'] || '';
                const range = f['Range'] || '';
                let locationDisplay = '';
                if (county) {
                    locationDisplay = county;
                    if (section && township && range) {
                        locationDisplay += `  ${section}-${township}-${range}`;
                    }
                }

                // Format operator contact for compact view (with bold operator name)
                let operatorContactDisplay = `<strong>${operator}</strong>`;
                if (operatorPhone || contactPerson) {
                    const contactParts = [];
                    if (operatorPhone) {
                        // Strip existing formatting before re-formatting to avoid double parentheses
                        const cleanPhone = operatorPhone.replace(/[^0-9]/g, '');
                        contactParts.push(`${formatPhoneNumber(cleanPhone)}`);
                    }
                    if (contactPerson) contactParts.push(`${contactPerson}`);
                    if (contactParts.length > 0) {
                        // Don't wrap in parentheses since phone already has them
                        operatorContactDisplay += ` ${contactParts.join('  ')}`;
                    }
                }

                // Build Links column - show properties, documents, OCC filings (same structure as Properties grid)
                const linkCounts = w._linkCounts || { properties: 0, documents: 0, filings: 0 };
                const propsClass = linkCounts.properties === 0 ? 'link-count zero' : 'link-count';
                const docsClass = linkCounts.documents === 0 ? 'link-count zero' : 'link-count';
                const filingsClass = linkCounts.filings === 0 ? 'link-count zero' : 'link-count';
                const totalLinks = linkCounts.properties + linkCounts.documents + linkCounts.filings;
                const totalClass = totalLinks === 0 ? 'link-total zero' : 'link-total';

                // Icons - same Heroicons as Properties grid
                const propsIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>';
                const docsIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>';
                const filingsIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>';
                const linkIcon = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>';

                // Clean row that opens modal on click
                html += `<tr class="well-row" onclick="openWellDetailsModal('${w.id}')" style="cursor: pointer;">`;
                if (!isViewer) {
                    html += `<td class="bulk-only" onclick="event.stopPropagation()"><input type="checkbox" class="well-checkbox" data-id="${w.id}"></td>`;
                }
                html += `<td class="well-info-cell">
                        <div class="well-name-line">
                            <strong>${wellName}</strong>
                        </div>
                        <div class="well-details-line">
                            ${apiNumber ? `<span class="well-api">${apiNumber}</span>  ` : ''}
                            <span class="well-status ${status === 'Active' || status === 'AC' ? 'status-active' : ''}">${status}</span>
                            ${locationDisplay ? `  <span class="well-location">${locationDisplay}</span>` : ''}
                        </div>
                    </td>
                    <td class="operator-contact-cell">${operatorContactDisplay}</td>
                    <td>
                        <div class="links-cell">
                            <div class="link-breakdown">
                                <span class="${propsClass}" title="Linked Properties">${propsIcon}${linkCounts.properties}</span>
                                <span class="link-separator"></span>
                                <span class="${docsClass}" title="Documents">${docsIcon}${linkCounts.documents}</span>
                                <span class="link-separator"></span>
                                <span class="${filingsClass}" title="OCC Filings">${filingsIcon}${linkCounts.filings}</span>
                            </div>
                            <span class="${totalClass}" title="Total Links (Properties: ${linkCounts.properties}, Docs: ${linkCounts.documents}, OCC: ${linkCounts.filings})">${linkIcon}${totalLinks}</span>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // Insert table with embedded accordions
            document.getElementById('wellsContent').innerHTML = html;
            
            // Add event delegation for production hover helpers (dynamically created elements)
            setupProductionHoverHelpers();
            
            // Update bulk selection state after table render
            updateSelectAllState('wells');
            updateBulkActionVisibility();
        }

        function updateTotalCount() {
            // No longer needed - separate limits shown
        }
        
        async function loadActivityStats() {
            try {
                const res = await fetch('/api/activity/stats');
                if (!res.ok) return;
                const stats = await res.json();
                
                // Format last alert date
                if (stats.lastAlert) {
                    const date = new Date(stats.lastAlert);
                    const now = new Date();
                    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                    
                    let lastAlertText;
                    if (diffDays === 0) lastAlertText = 'Today';
                    else if (diffDays === 1) lastAlertText = 'Yesterday';
                    else if (diffDays < 7) lastAlertText = diffDays + ' days ago';
                    else if (diffDays < 30) lastAlertText = Math.floor(diffDays / 7) + ' weeks ago';
                    else lastAlertText = date.toLocaleDateString('en-US', { timeZone: 'America/Chicago' });
                    
                    document.getElementById('statLastAlert').textContent = lastAlertText;
                } else {
                    document.getElementById('statLastAlert').textContent = 'No alerts yet';
                }
                
                document.getElementById('statThisMonth').textContent = stats.thisMonth;
                document.getElementById('statThisYear').textContent = stats.thisYear;
            } catch (err) {
                console.error('Failed to load activity stats:', err);
            }
        }
        
        async function loadActivity() {
            try {
                const res = await fetch('/api/activity');
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();
                const records = data.records || [];
                const recordLimit = data.recordLimit || 5;
                const plan = data.plan || 'Free';
                
                if (records.length === 0) {
                    let msg = `<div class="empty-state"><p>No activity recorded yet.</p><p style="font-size: 13px; color: var(--slate-blue);">When wells on your properties have status changes, they'll appear here.</p></div>`;
                    document.getElementById('activityContent').innerHTML = msg;
                    return;
                }
                
                let html = '<div class="activity-list">';
                
                // Show limit notice for lower tiers
                if (recordLimit < 100 && plan !== 'Professional' && plan !== 'Enterprise') {
                    html += `<div class="activity-limit-notice">Showing last ${recordLimit} alerts. <a href="/portal/upgrade">Upgrade</a> for more history.</div>`;
                }
                
                records.forEach(r => {
                    const f = r.fields;
                    let activityType = f['Activity Type'] || 'Status Change';
                    // Make "New Permit" more specific
                    if (activityType === 'New Permit') {
                        activityType = 'New Drilling Permit';
                    }
                    const alertLevel = f['Alert Level'] || 'YOUR PROPERTY';
                    
                    // Icon and class based on activity type
                    let icon = '';
                    let iconClass = 'status';
                    if (activityType.includes('Permit')) { icon = ''; iconClass = 'permit'; }
                    else if (activityType.includes('Drilling')) { icon = ''; iconClass = 'drilling'; }
                    else if (activityType.includes('Completed')) { icon = ''; iconClass = 'completed'; }
                    else if (activityType.includes('Transfer')) { icon = ''; iconClass = 'transfer'; }
                    else if (activityType.includes('Abandoned') || activityType.includes('Plugged')) { icon = ''; iconClass = 'abandoned'; }
                    else if (activityType.includes('Application') || activityType.includes('Exception') ||
                             activityType === 'OCC Filing' || activityType === 'Order Modification' ||
                             activityType === 'Operator Change' || activityType === 'Well Transfer') { icon = ''; iconClass = 'occ-filing'; }
                    
                    // Alert level class
                    let levelClass = 'property';
                    if (alertLevel.includes('ADJACENT')) levelClass = 'adjacent';
                    else if (alertLevel.includes('TRACKED')) levelClass = 'tracked';
                    
                    // Format date
                    const date = new Date(f['Detected At']);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    
                    // Build change text
                    let changeText = '';
                    if (f['Previous Value'] && f['New Value']) {
                        if (activityType.includes('Transfer')) {
                            changeText = `${f['Previous Value']}  ${f['New Value']}`;
                        } else {
                            changeText = `Status: ${f['Previous Value']}  ${f['New Value']}`;
                        }
                    }
                    
                    // Build action buttons
                    const occLink = f['OCC Link'];
                    const mapLink = f['OCC Map Link'] || f['Map Link']; // Support both field names
                    const apiNumber = f['API Number'];
                    
                    // Check if this activity type should have a Track Well button
                    const shouldShowTrackButton = apiNumber && (
                        activityType === 'New Permit' ||
                        activityType === 'New Drilling Permit' ||
                        activityType === 'Well Completed' ||
                        activityType.toLowerCase().includes('rework')
                    );
                    
                    // Debug logging
                    if (apiNumber && activityType === 'Well Completed') {
                        console.log('Well Completed activity:', {
                            activityType,
                            apiNumber,
                            shouldShowTrackButton,
                            occLink,
                            mapLink
                        });
                    }
                    
                    let actionsHtml = '<div class="activity-actions">';
                    // OCC Filing first
                    if (occLink) {
                        // Remove &cr=1 from URLs to fix Laserfiche cookie error
                        const fixedOccLink = occLink.replace(/&cr=1/g, '');
                        actionsHtml += `<a href="${escapeHtml(fixedOccLink)}" target="_blank" class="activity-btn">OCC Filing</a>`;
                    }
                    // OCC Map second  
                    if (mapLink) {
                        actionsHtml += `<a href="${escapeHtml(mapLink)}" target="_blank" class="activity-btn">OCC Map</a>`;
                    }
                    // Track Well last
                    if (shouldShowTrackButton) {
                        // Check if well is already tracked
                        const isTracked = loadedWells.some(w => w.fields['API Number'] === apiNumber);
                        if (isTracked) {
                            actionsHtml += `<button class="activity-btn track-btn" disabled style="background: #22C55E; color: white; border-color: #22C55E; cursor: default;">Added </button>`;
                        } else {
                            actionsHtml += `<button class="activity-btn track-btn" onclick="trackWellFromActivity('${escapeHtml(apiNumber)}', '${escapeHtml(f['Well Name'] || '')}', '${escapeHtml(occLink || '')}', this)">+ Track Well</button>`;
                        }
                    }

                    // Analyze Order button for OCC filing types
                    const caseNumber = f['Case Number'];
                    const occFilingTypes = [
                        'Pooling Application', 'Increased Density Application',
                        'Spacing Unit Application', 'Location Exception',
                        'Horizontal Well Application', 'OCC Filing', 'Order Modification'
                    ];
                    if (occFilingTypes.includes(activityType) && caseNumber) {
                        actionsHtml += `<button class="activity-btn occ-analyze-btn" onclick="processOccFilingFromActivity('${escapeHtml(caseNumber)}', this)">Analyze Order</button>`;
                    }

                    actionsHtml += '</div>';
                    
                    html += `
                        <div class="activity-item">
                            <div class="activity-checkbox" onclick="event.stopPropagation()">
                                <input type="checkbox" class="activity-checkbox-input" data-id="${r.id}">
                            </div>
                            <div class="activity-icon ${iconClass}">${icon}</div>
                            <div class="activity-details">
                                <div class="activity-header">
                                    <span class="activity-type">${escapeHtml(activityType)}</span>
                                    <span class="activity-level ${levelClass}">${escapeHtml(alertLevel.replace('_', ' '))}</span>
                                </div>
                                <div class="activity-well">${escapeHtml(f['Well Name']) || 'Unknown Well'}</div>
                                <div class="activity-meta">${escapeHtml(f['Operator']) || ''}  ${formatActivityLocation(f['Section-Township-Range'])}  ${escapeHtml(cleanCountyDisplay(f['County'])) || ''}</div>
                                ${changeText ? `<div class="activity-change">${escapeHtml(changeText)}</div>` : ''}
                                ${(occLink || mapLink) ? actionsHtml : ''}
                            </div>
                            <div class="activity-date">${dateStr}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('activityContent').innerHTML = html;
                
                // Add event listeners for activity checkboxes
                document.querySelectorAll('.activity-checkbox-input').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const activityId = this.getAttribute('data-id');
                        if (this.checked) {
                            selectedActivity.add(activityId);
                        } else {
                            selectedActivity.delete(activityId);
                        }
                        updateBulkActionVisibility();
                    });
                });
                
            } catch (err) {
                document.getElementById('activityContent').innerHTML = '<div class="empty-state"><p style="color: var(--error);">Error loading activity. Refresh page.</p></div>';
            }
        }
        
        // Property Modal
        document.getElementById('addPropertyBtn').addEventListener('click', () => { 
            document.getElementById('addPropertyModal').style.display = 'flex'; 
        });
        
        function closePropertyModal() { 
            document.getElementById('addPropertyModal').style.display = 'none'; 
            document.getElementById('addPropertyForm').reset(); 
            document.getElementById('propertyNotes').value = ''; // Clear notes field
            document.getElementById('addPropertyRIAcres').value = '';
            document.getElementById('addPropertyWIAcres').value = '';
            document.getElementById('addPropertyTotalAcres').textContent = '0';
            document.getElementById('addPropertyAcreageBadge').style.display = 'none';
            document.getElementById('addPropertyLocation').style.opacity = '0';
        }
        
        // Auto-set meridian based on county
        function autoSetMeridian(county) {
            const panhandleCounties = ['Cimarron', 'Texas', 'Beaver'];
            const meridianSelect = document.getElementById('meridian');
            
            if (panhandleCounties.includes(county)) {
                meridianSelect.value = 'CM';
            } else if (county) { // Only set IM if a county is selected
                meridianSelect.value = 'IM';
            }
        }
        window.autoSetMeridian = autoSetMeridian; // Make available globally
        
        // Update location display in Add Property header
        function updateLocationDisplay() {
            const county = document.getElementById('county').value;
            const section = document.getElementById('section').value;
            const township = document.getElementById('township').value.toUpperCase();
            const range = document.getElementById('range').value.toUpperCase();
            const locationDiv = document.getElementById('addPropertyLocation');
            
            if (county && section && township && range) {
                locationDiv.textContent = `${county} County  S${section} T${township} R${range}`;
                locationDiv.style.opacity = '1';
            } else if (county) {
                locationDiv.textContent = `${county} County`;
                locationDiv.style.opacity = '0.8';
            } else {
                locationDiv.style.opacity = '0';
            }
        }
        window.updateLocationDisplay = updateLocationDisplay;
        
        // Update total acres for Add Property
        function updateAddPropertyTotalAcres() {
            const riAcres = parseFloat(document.getElementById('addPropertyRIAcres').value) || 0;
            const wiAcres = parseFloat(document.getElementById('addPropertyWIAcres').value) || 0;
            const total = riAcres + wiAcres;
            
            document.getElementById('addPropertyTotalAcres').textContent = total.toFixed(2);
            
            // Update the badge in header
            const badge = document.getElementById('addPropertyAcreageBadge');
            if (total > 0) {
                badge.textContent = `${total.toFixed(2)} acres`;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        window.updateAddPropertyTotalAcres = updateAddPropertyTotalAcres;
        
        document.getElementById('addPropertyModal').addEventListener('click', e => { 
            if (e.target.id === 'addPropertyModal') closePropertyModal(); 
        });
        
        document.getElementById('addPropertyForm').addEventListener('submit', async e => {
            e.preventDefault();
            
            // Get form values
            const section = document.getElementById('section').value.trim();
            const township = document.getElementById('township').value.trim().toUpperCase();
            const range = document.getElementById('range').value.trim().toUpperCase();
            const notes = document.getElementById('propertyNotes').value.trim();
            
            // Additional validation
            if (!/^[0-9]{1,2}$/.test(section) || parseInt(section) < 1 || parseInt(section) > 36) {
                showToast('Section must be a number between 1 and 36', 'error');
                return;
            }
            
            if (!/^[0-9]{1,2}[NS]$/.test(township)) {
                showToast('Township format: number + N or S (e.g., 12N)', 'error');
                return;
            }
            
            if (!/^[0-9]{1,2}[WE]$/.test(range)) {
                showToast('Range format: number + W or E (e.g., 4W)', 'error');
                return;
            }
            
            const data = { 
                COUNTY: document.getElementById('county').value, 
                SEC: section, 
                TWN: township, 
                RNG: range, 
                MERIDIAN: document.getElementById('meridian').value,
                Notes: notes,
                Group: document.getElementById('addPropertyGroup').value.trim(),
                'RI Acres': parseFloat(document.getElementById('addPropertyRIAcres').value) || 0,
                'WI Acres': parseFloat(document.getElementById('addPropertyWIAcres').value) || 0
            };
            try {
                const res = await fetch('/api/properties', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(data) 
                });
                if (!res.ok) { 
                    const err = await res.json(); 
                    if (err.error && err.error.includes('already monitoring')) {
                        showToast('Already tracking this property', 'info');
                    } else {
                        showToast(err.error || 'Failed to add property', 'error');
                    }
                    return;
                }
                showToast('Success, Property Added', 'success');
                closePropertyModal();
                await loadProperties();
            } catch (err) { 
                showToast('Error adding property: ' + err.message, 'error');
            }
        });

        // Event listeners moved to DOMContentLoaded above
        
        function closeWellModal() { 
            document.getElementById('addWellModal').style.display = 'none'; 
            document.getElementById('addWellForm').reset();
            // Reset search tab
            clearWellSearch();
            // Switch back to API tab
            switchTab('api-tab');
        }
        
        // Tab switching functionality
        function switchTab(targetTabId) {
            // Remove active class from all tab buttons and content
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab button and corresponding content
            document.querySelector(`[data-tab="${targetTabId}"]`).classList.add('active');
            document.getElementById(targetTabId).classList.add('active');
        }
        
        // Initialize tab listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Tab button event listeners
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.getAttribute('data-tab');
                    switchTab(targetTab);
                });
            });
        });
        
        // Search functionality
        let searchDebounceTimer;
        const SEARCH_DEBOUNCE_MS = 300;
        
        function debounceSearch(searchFunction, delay = SEARCH_DEBOUNCE_MS) {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(searchFunction, delay);
        }
        
        // Document functions
        let currentDocumentId = null;
        let currentDocumentContentType = null;
        let currentDocumentRotation = 0;
        let currentDocumentFilename = null;
        let loadedDocuments = [];
        
        // Documents Search, Filter & Sort State
        let documentsSearchTerm = '';
        let documentsCategory = 'all';
        let documentsSortBy = 'date-desc';
        
        // Initialize Documents Controls (call this after user loads)
        function initDocumentsControls() {
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Show/hide controls based on plan
            document.getElementById('documentsControls').style.display = hasSearch ? 'flex' : 'none';
            
            if (!hasSearch) return;
            
            // Initialize sort options
            updateDocumentsSortOptions();
            
            // Search input with debounce
            const searchInput = document.getElementById('documentsSearch');
            searchInput.addEventListener('input', (e) => {
                documentsSearchTerm = e.target.value.toLowerCase();
                debounceSearch(() => renderDocumentsList(loadedDocuments), 300);
            });
            
            // Category filter - Searchable dropdown
            initDocumentsCategoryDropdown();
            
            // Sort select
            const sortSelect = document.getElementById('documentsSort');
            sortSelect.addEventListener('change', (e) => {
                documentsSortBy = e.target.value;
                renderDocumentsList(loadedDocuments);
            });
        }
        
        // Update sort options based on selected category
        function updateDocumentsSortOptions() {
            const sortSelect = document.getElementById('documentsSort');
            const currentSort = sortSelect.value;
            
            // Clear existing options
            sortSelect.innerHTML = '';
            
            // Base sort options (always available)
            const baseOptions = [
                { value: 'date-desc', text: 'Upload Date (Newest)' },
                { value: 'date-asc', text: 'Upload Date (Oldest)' }
            ];
            
            // Category-specific sort options
            const categoryOptions = {
                // Deeds
                'mineral_deeds': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' },
                    { value: 'recording-date', text: 'Recording Date' },
                    { value: 'grantor', text: 'Grantor Name' },
                    { value: 'grantee', text: 'Grantee Name' }
                ],
                'royalty_deed': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' },
                    { value: 'grantor', text: 'Grantor Name' },
                    { value: 'grantee', text: 'Grantee Name' }
                ],
                'assignment': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' },
                    { value: 'assignor', text: 'Assignor Name' },
                    { value: 'assignee', text: 'Assignee Name' }
                ],
                'ratification': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' }
                ],
                'right_of_way': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' },
                    { value: 'grantee', text: 'Grantee Name' }
                ],

                // Leases
                'leases': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'lease-date', text: 'Lease Date' },
                    { value: 'lessor', text: 'Lessor Name' },
                    { value: 'lessee', text: 'Lessee Name' }
                ],
                'release_of_lease': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' },
                    { value: 'operator', text: 'Operator' }
                ],
                'lease_amendment': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' }
                ],
                'lease_extension': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'execution-date', text: 'Execution Date' }
                ],

                // OCC Orders - granular
                'pooling_orders': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county', text: 'County' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'formation', text: 'Formation' }
                ],
                'drilling_and_spacing': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'unit-size', text: 'Unit Size (Acres)' },
                    { value: 'formation', text: 'Formation' }
                ],
                'horizontal_drilling_and_spacing': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'unit-size', text: 'Unit Size (Acres)' },
                    { value: 'formation', text: 'Formation' },
                    { value: 'operator', text: 'Operator' }
                ],
                'location_exception': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'well-name', text: 'Well Name' },
                    { value: 'operator', text: 'Operator' }
                ],
                'increased_density': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county', text: 'County' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'wells-authorized', text: 'Wells Authorized' }
                ],
                'change_of_operator': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county', text: 'County' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'new-operator', text: 'New Operator' },
                    { value: 'wells-transferred', text: 'Wells Transferred' }
                ],
                'multi_unit_horizontal': [
                    { value: 'cause-number', text: 'Cause Number' },
                    { value: 'county', text: 'County' },
                    { value: 'order-date', text: 'Order Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'formation', text: 'Formation' },
                    { value: 'sections', text: 'Sections' }
                ],

                // Well documents
                'drilling_permits': [
                    { value: 'permit-date', text: 'Permit Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'well-name', text: 'Well Name' }
                ],
                'well_completion_reports': [
                    { value: 'completion-date', text: 'Completion Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'well-name', text: 'Well Name' }
                ],
                'production_reports': [
                    { value: 'production-date', text: 'Production Date' },
                    { value: 'oil-volume', text: 'Oil Volume' },
                    { value: 'gas-volume', text: 'Gas Volume' }
                ],
                'division_orders': [
                    { value: 'effective-date', text: 'Effective Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'interest-decimal', text: 'Interest Decimal' }
                ],
                'title_opinions': [
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'opinion-date', text: 'Opinion Date' },
                    { value: 'attorney', text: 'Attorney/Firm' }
                ],
                'joa': [
                    { value: 'effective-date', text: 'Effective Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'unit-name', text: 'Unit Name' }
                ],

                // Financial
                'check_stubs': [
                    { value: 'payment-date', text: 'Payment Date' },
                    { value: 'amount', text: 'Payment Amount' },
                    { value: 'well', text: 'Well Name' }
                ],
                'suspense_notices': [
                    { value: 'notice-date', text: 'Notice Date' },
                    { value: 'operator', text: 'Operator' },
                    { value: 'amount', text: 'Suspense Amount' }
                ],
                'tax_records': [
                    { value: 'tax-year', text: 'Tax Year' },
                    { value: 'assessed-value', text: 'Assessed Value' }
                ],

                // Estate/Ownership - granular
                'affidavit_of_heirship': [
                    { value: 'county', text: 'County' },
                    { value: 'decedent', text: 'Decedent Name' },
                    { value: 'execution-date', text: 'Execution Date' }
                ],
                'probate': [
                    { value: 'county', text: 'County' },
                    { value: 'decedent', text: 'Decedent Name' },
                    { value: 'case-number', text: 'Case Number' }
                ],
                'trust': [
                    { value: 'entity-name', text: 'Entity Name' },
                    { value: 'document-date', text: 'Document Date' }
                ],

                // Legal - granular
                'legal_documents': [
                    { value: 'document-date', text: 'Document Date' },
                    { value: 'document-type', text: 'Document Type' }
                ],
                'divorce_decree': [
                    { value: 'decree-date', text: 'Decree Date' },
                    { value: 'petitioner', text: 'Petitioner Name' }
                ],
                'death_certificate': [
                    { value: 'death-date', text: 'Date of Death' },
                    { value: 'decedent', text: 'Decedent Name' }
                ],
                'power_of_attorney': [
                    { value: 'execution-date', text: 'Execution Date' },
                    { value: 'principal', text: 'Principal Name' }
                ],

                // Other
                'correspondence': [
                    { value: 'letter-date', text: 'Letter Date' },
                    { value: 'sender', text: 'From' },
                    { value: 'recipient', text: 'To' }
                ],
                'maps_plats': [
                    { value: 'map-date', text: 'Map Date' },
                    { value: 'county-trs', text: 'County & TRS' },
                    { value: 'map-type', text: 'Map Type' }
                ]
            };
            
            // Add base options
            baseOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                sortSelect.appendChild(option);
            });
            
            // Add category-specific options if applicable
            if (documentsCategory !== 'all' && categoryOptions[documentsCategory]) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '';
                sortSelect.appendChild(separator);
                
                categoryOptions[documentsCategory].forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    sortSelect.appendChild(option);
                });
            }
            
            // Restore previous selection if still valid
            if (Array.from(sortSelect.options).find(opt => opt.value === currentSort)) {
                sortSelect.value = currentSort;
            } else {
                // Reset to default if previous selection is no longer valid
                sortSelect.value = 'date-desc';
                documentsSortBy = 'date-desc';
            }
        }

        // Document categories - alphabetized with granular types
        const DOCUMENT_CATEGORIES = [
            { value: 'all', label: 'All Categories' },
            { value: 'affidavit_of_heirship', label: 'Affidavit of Heirship' },
            { value: 'assignment', label: 'Assignments' },
            { value: 'change_of_operator', label: 'Change of Operator' },
            { value: 'check_stubs', label: 'Check Stubs / Royalty Statements' },
            { value: 'correspondence', label: 'Correspondence' },
            { value: 'death_certificate', label: 'Death Certificates' },
            { value: 'divorce_decree', label: 'Divorce Decrees' },
            { value: 'division_orders', label: 'Division Orders' },
            { value: 'drilling_and_spacing', label: 'Drilling & Spacing Orders (Vertical)' },
            { value: 'drilling_permits', label: 'Drilling Permits' },
            { value: 'horizontal_drilling_and_spacing', label: 'Horizontal Drilling & Spacing Orders' },
            { value: 'increased_density', label: 'Increased Density Orders' },
            { value: 'joa', label: 'Joint Operating Agreements' },
            { value: 'leases', label: 'Leases' },
            { value: 'lease_amendment', label: 'Lease Amendments' },
            { value: 'lease_extension', label: 'Lease Extensions' },
            { value: 'legal_documents', label: 'Legal Documents' },
            { value: 'location_exception', label: 'Location Exception Orders' },
            { value: 'maps_plats', label: 'Maps / Plats' },
            { value: 'mineral_deeds', label: 'Mineral Deeds' },
            { value: 'multi_document', label: 'Multi-Document PDFs' },
            { value: 'multi_unit_horizontal', label: 'Multi-Unit Horizontal Orders' },
            { value: 'pooling_orders', label: 'Pooling Orders' },
            { value: 'power_of_attorney', label: 'Power of Attorney' },
            { value: 'probate', label: 'Probate Documents' },
            { value: 'production_reports', label: 'Production Reports' },
            { value: 'ratification', label: 'Ratifications' },
            { value: 'release_of_lease', label: 'Release of Lease' },
            { value: 'right_of_way', label: 'Right of Way' },
            { value: 'royalty_deed', label: 'Royalty Deeds' },
            { value: 'suspense_notices', label: 'Suspense Notices' },
            { value: 'tax_records', label: 'Tax Records' },
            { value: 'title_opinions', label: 'Title Opinions' },
            { value: 'trust', label: 'Trust Documents' },
            { value: 'well_completion_reports', label: 'Well Completion Reports' },
            { value: 'other', label: 'Other' }
        ];

        // Initialize searchable category dropdown
        function initDocumentsCategoryDropdown() {
            const dropdown = document.getElementById('documentsCategoryDropdown');
            const trigger = document.getElementById('documentsCategoryTrigger');
            const menu = document.getElementById('documentsCategoryMenu');
            const searchInput = document.getElementById('documentsCategorySearch');
            const optionsContainer = document.getElementById('documentsCategoryOptions');
            const hiddenInput = document.getElementById('documentsCategory');
            const label = trigger.querySelector('.dropdown-label');

            // Populate options
            function renderOptions(filter = '') {
                const filterLower = filter.toLowerCase();
                let hasVisible = false;

                optionsContainer.innerHTML = '';

                DOCUMENT_CATEGORIES.forEach(cat => {
                    const matchesFilter = !filter || cat.label.toLowerCase().includes(filterLower);
                    if (!matchesFilter) return;

                    hasVisible = true;
                    const option = document.createElement('div');
                    option.className = 'dropdown-option' + (cat.value === documentsCategory ? ' selected' : '');
                    option.dataset.value = cat.value;
                    option.textContent = cat.label;
                    option.addEventListener('click', () => selectCategory(cat.value, cat.label));
                    optionsContainer.appendChild(option);
                });

                if (!hasVisible) {
                    optionsContainer.innerHTML = '<div class="dropdown-no-results">No categories found</div>';
                }
            }

            // Select a category
            function selectCategory(value, labelText) {
                documentsCategory = value;
                hiddenInput.value = value;
                label.textContent = labelText;
                closeDropdown();
                updateDocumentsSortOptions();
                renderDocumentsList(loadedDocuments);
            }

            // Open/close dropdown
            function toggleDropdown() {
                const isOpen = dropdown.classList.contains('open');
                if (isOpen) {
                    closeDropdown();
                } else {
                    openDropdown();
                }
            }

            function openDropdown() {
                dropdown.classList.add('open');
                searchInput.value = '';
                renderOptions();
                setTimeout(() => searchInput.focus(), 50);
            }

            function closeDropdown() {
                dropdown.classList.remove('open');
                searchInput.value = '';
            }

            // Event listeners
            trigger.addEventListener('click', toggleDropdown);

            searchInput.addEventListener('input', (e) => {
                renderOptions(e.target.value);
            });

            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeDropdown();
                    trigger.focus();
                }
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Initial render
            renderOptions();
        }

        // Filter documents based on search and category
        function filterDocuments(documents) {
            return documents.filter(doc => {
                // Category filter
                if (documentsCategory !== 'all') {
                    // Use category field if available, fall back to doc_type mapping
                    let docCategory;
                    
                    // Map database category/doc_type to filter value (granular categories)
                    const categoryOrDocType = doc.category || doc.doc_type || 'other';
                    const docTypeToFilterValue = {
                        // Deeds
                        'mineral_deed': 'mineral_deeds',
                        'royalty_deed': 'royalty_deed',
                        'assignment': 'assignment',
                        'ratification': 'ratification',
                        'right_of_way': 'right_of_way',

                        // Leases
                        'lease': 'leases',
                        'release_of_lease': 'release_of_lease',
                        'lease_amendment': 'lease_amendment',
                        'lease_extension': 'lease_extension',

                        // OCC Orders - now granular
                        'pooling_order': 'pooling_orders',
                        'drilling_and_spacing_order': 'drilling_and_spacing',
                        'horizontal_drilling_and_spacing_order': 'horizontal_drilling_and_spacing',
                        'location_exception_order': 'location_exception',
                        'increased_density_order': 'increased_density',
                        'change_of_operator_order': 'change_of_operator',
                        'multi_unit_horizontal_order': 'multi_unit_horizontal',
                        'occ_order': 'other',  // Generic OCC orders go to other

                        // Well documents
                        'division_order': 'division_orders',
                        'drilling_permit': 'drilling_permits',
                        'title_opinion': 'title_opinions',
                        'joa': 'joa',
                        'joint_operating_agreement': 'joa',

                        // Financial
                        'check_stub': 'check_stubs',
                        'royalty_statement': 'check_stubs',
                        'suspense_notice': 'suspense_notices',
                        'tax_record': 'tax_records',

                        // Estate/Ownership - now granular
                        'affidavit_of_heirship': 'affidavit_of_heirship',
                        'heirship': 'affidavit_of_heirship',
                        'probate': 'probate',
                        'probate_document': 'probate',
                        'trust': 'trust',
                        'ownership_entity': 'trust',
                        'llc_docs': 'trust',
                        'estate': 'probate',

                        // Legal - now granular
                        'legal_document': 'legal_documents',
                        'divorce_decree': 'divorce_decree',
                        'death_certificate': 'death_certificate',
                        'power_of_attorney': 'power_of_attorney',

                        // Other
                        'correspondence': 'correspondence',
                        'map': 'maps_plats',
                        'plat': 'maps_plats',
                        'multi_document': 'multi_document',
                        'production_report': 'production_reports',
                        'well_completion_report': 'well_completion_reports',
                        'other': 'other'
                    };
                    docCategory = docTypeToFilterValue[categoryOrDocType.toLowerCase()] || 'other';
                    
                    if (docCategory !== documentsCategory) return false;
                }
                
                // Search filter
                if (!documentsSearchTerm) return true;
                
                const searchStr = documentsSearchTerm;  // Already lowercase from input handler
                
                // Basic field search
                const basicMatch = (
                    (doc.filename || '').toLowerCase().includes(searchStr) ||
                    (doc.display_name || '').toLowerCase().includes(searchStr) ||
                    (doc.category || '').toLowerCase().includes(searchStr) ||
                    (doc.doc_type || '').toLowerCase().includes(searchStr) ||
                    (doc.county || '').toLowerCase().includes(searchStr) ||
                    (doc.description || '').toLowerCase().includes(searchStr)
                );
                
                if (basicMatch) return true;
                
                // Search in extracted data if available
                if (doc.parsedExtractedData) {
                    const extractedStr = JSON.stringify(doc.parsedExtractedData).toLowerCase();
                    return extractedStr.includes(searchStr);
                }
                
                return false;
            });
        }
        
        // Sort documents
        function sortDocuments(documents) {
            const sorted = [...documents];
            
            sorted.sort((a, b) => {
                switch (documentsSortBy) {
                    case 'date-desc':
                        return new Date(b.upload_date) - new Date(a.upload_date);
                    case 'date-asc':
                        return new Date(a.upload_date) - new Date(b.upload_date);
                    case 'county-trs':
                        // Sort by county, then township, range, section
                        const countyCompare = (a.county || '').localeCompare(b.county || '');
                        if (countyCompare !== 0) return countyCompare;
                        const aTRS = `${a.township || ''}${a.range || ''}${a.section || ''}`;
                        const bTRS = `${b.township || ''}${b.range || ''}${b.section || ''}`;
                        return aTRS.localeCompare(bTRS);
                    
                    // Category-specific sorts using extracted data
                    case 'execution-date':
                    case 'recording-date':
                    case 'lease-date':
                    case 'permit-date':
                    case 'production-date':
                    case 'effective-date':
                        const aDate = getExtractedDate(a, documentsSortBy);
                        const bDate = getExtractedDate(b, documentsSortBy);
                        return compareDates(aDate, bDate);
                    
                    case 'grantor':
                    case 'grantee':
                    case 'lessor':
                    case 'lessee':
                    case 'operator':
                    case 'well-name':
                        const aValue = getExtractedString(a, documentsSortBy);
                        const bValue = getExtractedString(b, documentsSortBy);
                        return aValue.localeCompare(bValue);
                    
                    case 'oil-volume':
                    case 'gas-volume':
                    case 'interest-decimal':
                        const aNum = getExtractedNumber(a, documentsSortBy);
                        const bNum = getExtractedNumber(b, documentsSortBy);
                        return bNum - aNum; // Descending for volumes
                    
                    default:
                        return 0;
                }
            });
            
            return sorted;
        }
        
        // Helper functions for extracting data from parsed extracted_data
        function getExtractedDate(doc, sortType) {
            if (!doc.parsedExtractedData) return '';
            
            const fieldMap = {
                'execution-date': ['execution_date', 'executionDate'],
                'recording-date': ['recording_date', 'recordingDate', 'recorded_date'],
                'lease-date': ['lease_date', 'leaseDate', 'dated'],
                'permit-date': ['permit_date', 'permitDate', 'date_issued'],
                'production-date': ['production_date', 'productionDate', 'reporting_date'],
                'effective-date': ['effective_date', 'effectiveDate']
            };
            
            const possibleFields = fieldMap[sortType] || [];
            for (const field of possibleFields) {
                if (doc.parsedExtractedData[field]) {
                    return doc.parsedExtractedData[field];
                }
            }
            return '';
        }
        
        function getExtractedString(doc, sortType) {
            if (!doc.parsedExtractedData) return '';
            
            const fieldMap = {
                'grantor': ['grantor', 'grantors', 'grantor_name'],
                'grantee': ['grantee', 'grantees', 'grantee_name'],
                'lessor': ['lessor', 'lessors', 'lessor_name'],
                'lessee': ['lessee', 'lessees', 'lessee_name'],
                'operator': ['operator', 'operator_name', 'company'],
                'well-name': ['well_name', 'wellName', 'well']
            };
            
            const possibleFields = fieldMap[sortType] || [];
            for (const field of possibleFields) {
                const value = doc.parsedExtractedData[field];
                if (value) {
                    // Handle arrays (multiple grantors, etc.)
                    if (Array.isArray(value)) {
                        return value.join(', ');
                    }
                    return String(value);
                }
            }
            return '';
        }
        
        function getExtractedNumber(doc, sortType) {
            if (!doc.parsedExtractedData) return 0;
            
            const fieldMap = {
                'oil-volume': ['oil_volume', 'oil_production', 'oil_bbls'],
                'gas-volume': ['gas_volume', 'gas_production', 'gas_mcf'],
                'interest-decimal': ['interest_decimal', 'decimal_interest', 'interest']
            };
            
            const possibleFields = fieldMap[sortType] || [];
            for (const field of possibleFields) {
                const value = doc.parsedExtractedData[field];
                if (value !== undefined && value !== null) {
                    return parseFloat(value) || 0;
                }
            }
            return 0;
        }
        
        function compareDates(a, b) {
            // Handle various date formats
            const dateA = a ? new Date(a) : new Date(0);
            const dateB = b ? new Date(b) : new Date(0);
            return dateB.getTime() - dateA.getTime(); // Descending (newest first)
        }
        
        async function viewDocumentInModal(docId, filename, fromDetailModal = false, contentType = 'application/pdf', rotationApplied = 0) {
            console.log('Opening document in modal:', docId, filename, 'type:', contentType, 'rotation:', rotationApplied);
            currentDocumentId = docId;
            window.viewingFromDetailModal = fromDetailModal;
            window.currentDocumentRotation = rotationApplied || 0;

            // Update modal title
            document.getElementById('documentViewTitle').textContent = filename || 'Document Viewer';

            // Show modal
            const pdfModal = document.getElementById('documentViewModal');
            pdfModal.style.display = 'flex';

            // If opened from detail modal, ensure viewer is on top
            if (fromDetailModal) {
                pdfModal.style.zIndex = '9999999';
            } else {
                pdfModal.style.zIndex = '2000';
            }
            const viewerContainer = document.getElementById('pdfViewerContainer');

            // Determine file type
            const isImage = contentType && (contentType.startsWith('image/jpeg') || contentType.startsWith('image/png'));
            const isTiff = contentType && contentType.startsWith('image/tiff');
            const isPdf = !contentType || contentType === 'application/pdf';

            // TIFF files can't be displayed inline - show download only
            if (isTiff) {
                viewerContainer.innerHTML = `
                    <div style="color: white; text-align: center; padding: 50px;">
                        <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 20px; opacity: 0.6;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <p style="font-size: 16px; margin-bottom: 8px;">TIFF files cannot be previewed in browser</p>
                        <p style="opacity: 0.7; margin-bottom: 20px;">Download to view in an image editor</p>
                        <button onclick="downloadCurrentDocument()" style="background: #3B82F6; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px;">
                            Download TIFF
                        </button>
                    </div>
                `;
                return;
            }

            // Show loading state
            viewerContainer.innerHTML = `<div style="color: white; text-align: center; padding: 50px;">Loading ${isImage ? 'image' : 'document'}...</div>`;

            try {
                // Fetch the file as blob
                const response = await fetch(`/api/documents/${docId}/download?view=true`);
                if (!response.ok) throw new Error('Failed to load file');

                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);

                if (isImage) {
                    // Display image with zoom/pan capability
                    // Apply rotation if the document was rotated during processing
                    const rotation = window.currentDocumentRotation || 0;
                    const rotationStyle = rotation ? `transform: rotate(${rotation}deg);` : '';
                    viewerContainer.innerHTML = `
                        <div style="width: 100%; height: 100%; overflow: auto; display: flex; align-items: center; justify-content: center; padding: 20px;">
                            <img src="${objectUrl}" alt="${escapeHtml(filename || 'Document')}" style="max-width: 100%; max-height: 100%; object-fit: contain; ${rotationStyle}"/>
                        </div>
                    `;
                } else {
                    // Use iframe for PDFs
                    viewerContainer.innerHTML = `
                        <iframe
                            src="${objectUrl}"
                            style="width: 100%; height: 100%; border: none;"
                            title="${escapeHtml(filename || 'Document')}"
                        ></iframe>
                    `;
                }

                // Clean up blob URL when modal is closed
                window.currentBlobUrl = objectUrl;
            } catch (error) {
                console.error('Error loading file:', error);
                viewerContainer.innerHTML = `
                    <div style="color: white; text-align: center; padding: 50px;">
                        <p>Unable to display file in browser</p>
                        <p style="margin-top: 20px;">
                            <button onclick="downloadCurrentDocument()" class="btn-secondary" style="background: #3B82F6; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer;">
                                Download File
                            </button>
                        </p>
                    </div>
                `;
            }
        }
        
        function closeDocumentViewer() {
            const pdfModal = document.getElementById('documentViewModal');
            pdfModal.style.display = 'none';
            pdfModal.style.zIndex = '2000'; // Reset to default
            
            // Clean up blob URL if exists
            if (window.currentBlobUrl) {
                URL.revokeObjectURL(window.currentBlobUrl);
                window.currentBlobUrl = null;
            }
            
            // Clear the container
            document.getElementById('pdfViewerContainer').innerHTML = '';
            
            // Don't clear currentDocumentId if we're returning to detail modal
            if (!window.viewingFromDetailModal) {
                currentDocumentId = null;
            }
            window.viewingFromDetailModal = false;
        }
        
        function downloadCurrentDocument() {
            if (currentDocumentId) {
                downloadDocument(currentDocumentId);
            }
        }
        
        function downloadDocument(docId) {
            console.log('Download document clicked:', docId);
            window.location.href = `/api/documents/${docId}/download`;
        }
        
        // Document detail functions
        function formatDocType(docType) {
            if (!docType) return 'Unknown';
            
            // First check for special cases that need specific formatting
            const typeMap = {
                'oil_gas_lease': 'Oil & Gas Lease',
                'multi_document': 'Multi-Document PDF',
                'other': 'Other Document'
            };
            
            // If it's in the special map, return that
            if (typeMap[docType]) {
                return typeMap[docType];
            }
            
            // Otherwise, convert snake_case to Title Case
            return docType.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
        }
        
        function getConfidenceIndicator(fieldName, fieldScores) {
            const score = fieldScores?.[fieldName];
            if (score === null || score === undefined) return '';
            
            const percentage = Math.round(score * 100);
            const symbol = score >= 0.9 ? '' : score >= 0.6 ? '' : '';
            const className = score >= 0.9 ? 'confidence-high' : score >= 0.6 ? 'confidence-medium' : 'confidence-low';
            const title = score >= 0.9 ? 'High confidence' : score >= 0.6 ? 'Medium confidence - may need review' : 'Low confidence - needs review';
            
            // Always include both symbol and percentage, use CSS to control visibility
            let html = `<span class="confidence-indicator ${className}" title="${title}">${symbol}`;
            html += ` <span class="confidence-percentage" style="font-style: italic; font-size: 0.85em;">(${percentage}%)</span>`;
            html += `</span>`;
            
            return html;
        }
        
        // Helper function to format field names for display
        function formatFieldName(fieldName) {
            // Special cases
            const nameMap = {
                'cd_number': 'CD Number',
                'api_number': 'API Number',
                'nri': 'Net Revenue Interest',
                'orri': 'Overriding Royalty Interest',
                'poa_type': 'Power of Attorney Type'
            };
            
            if (nameMap[fieldName]) return nameMap[fieldName];
            
            // Convert snake_case to Title Case
            return fieldName.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
        }
        
        // Helper to group fields into logical sections
        function groupFieldsBySection(data) {
            const groups = {
                'Detailed Analysis': ['ai_observations'],
                'Operator/Payor': ['operator_name', 'operator_address', 'return_instructions'],
                'Property/Well': ['property_name', 'property_number', 'billing_code', 'well_name', 'api_number', 'well_location'],
                'Owner': ['owner_name', 'owner_address', 'trustee_name'],
                'Interests': ['working_interest', 'royalty_interest', 'decimal_interest', 'ownership_type', 'net_revenue_interest',
                            'is_multi_section_unit', 'unit_sections'],
                'Payment Terms': ['effective_date', 'payment_minimum'],
                'Recording Information': ['recording_book', 'recording_page', 'document_number', 'recording_date', 'recording_county', 'instrument_number'],
                'Execution Details': ['execution_date', 'prepared_by', 'notary_date', 'notary_county', 'notary_state', 'deed_type',
                                    'notary_expiration', 'commission_expiration', 'corporate_acknowledgment', 'acknowledgment_date'],
                'Legal Description': ['legal_description', 'section', 'township', 'range', 'county', 'state', 'quarter', 'quarter_section', 'lot_block', 'acres', 'acreage'],
                'Parties': ['grantors', 'grantees', 'grantor', 'grantee', 'grantor_name', 'grantee_name', 'grantor_names', 'grantee_names',
                          'grantor_address', 'grantee_address',
                          'grantor_marital_status', 'lessor_name', 'lessee_name', 'lessor_address', 'lessee_address',
                          'assignor_name', 'assignee_name', 'assignor_address', 'assignee_address',
                          'releasor', 'ratifying_party', 'original_party', 'principal_name', 'agent_name',
                          'petitioner_name', 'respondent_name', 'decedent_name', 'executor_name', 'affiant_name',
                          'decedent', 'affiant', 'heirs_summary', 'children_living', 'children_predeceased', 'spouses',
                          'president', 'vice_president', 'secretary', 'assistant_secretary', 'treasurer', 'corporate_officer'],
                'Interest & Consideration': ['interest_conveyed', 'interest_type', 'interest_assigned', 'consideration',
                                           'consideration_amount', 'consideration_description', 'bonus_amount',
                                           'net_mineral_acres', 'reservation', 'minerals_covered', 'mineral_types_conveyed'],
                'Lease Terms': ['primary_term', 'royalty_rate', 'delay_rental', 'shut_in_royalty', 'extension_provisions'],
                'Well Information': ['operator', 'purchaser', 'owner_number', 'unit_name'],
                'Order Details': ['cd_number', 'order_number', 'cause_number', 'case_number', 'order_sub_type',
                               'order_date', 'hearing_date', 'reopen_date', 'reopen_purpose',
                               'applicant', 'well_cost', 'unit_size_acres', 'unit_description', 'relief_granted',
                               'unit_shape', 'formations', 'election_options', 'election_deadline_days',
                               'additional_wells_authorized', 'existing_wells', 'expiration_date', 'expiration_period',
                               'amends_order', 'engineering_data', 'allowable_type', 'allowable_notes',
                               'unit_sections', 'total_unit_acres', 'total_completion_interval_feet',
                               'allocation_method', 'well_type', 'target_reservoir', 'adjacent_common_source',
                               'completion_interval', 'referenced_spacing_orders', 'referenced_pooling_orders',
                               'companion_cases', 'special_provisions', 'cost_savings',
                               'proposed_well_name', 'previous_operator', 'new_operator', 'transfer_date', 'affected_wells'],
                'Hearing Details': ['hearing_location', 'administrative_law_judge', 'applicant_attorney',
                                  'protestant', 'protestant_attorney', 'protest_status'],
                'Document References': ['related_documents', 'exhibits', 'prior_instruments', 'original_lease_reference',
                                      'original_document_reference', 'original_lease_date', 'original_document_date'],
                'Title & Warranties': ['warranty_type', 'source_of_title', 'warranty_of_title', 'warranty_scope', 'warranty_language', 'has_warranty'],
                'Restrictions & Provisions': ['reservations', 'exceptions', 'subject_to', 'depth_limitations', 
                                            'formation_limitations', 'mineral_types', 'pooling_authorization', 
                                            'surface_restrictions', 'no_surface_clause', 'pugh_clause', 'vertical_pugh_clause'],
                'Other Information': []  // Catch-all for fields not in other groups
            };
            
            const grouped = {};
            const processedFields = new Set();

            // Build a lowercase map of group fields for case-insensitive matching
            // Handle both snake_case and space-separated formats
            const fieldToSection = {};
            for (const [section, fields] of Object.entries(groups)) {
                for (const field of fields) {
                    // Add snake_case version
                    fieldToSection[field.toLowerCase()] = section;
                    // Add space-separated version (deed_type -> deed type)
                    fieldToSection[field.toLowerCase().replace(/_/g, ' ')] = section;
                    // Add title case version (deed_type -> Deed Type)
                    const titleCase = field.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()).toLowerCase();
                    fieldToSection[titleCase] = section;
                }
            }

            // First pass: assign data fields to their designated groups (case-insensitive)
            for (const [dataField, value] of Object.entries(data)) {
                // Normalize to lowercase, try both snake_case and space formats
                const dataFieldLower = dataField.toLowerCase();
                const dataFieldNormalized = dataFieldLower.replace(/\s+/g, '_');

                // Skip confidence fields
                if (dataFieldNormalized.endsWith('_confidence') ||
                    dataFieldLower.endsWith(' confidence') ||
                    dataFieldNormalized.includes('confidence_')) {
                    processedFields.add(dataField);
                    continue;
                }

                // Check if this field belongs to a group (try multiple formats)
                const section = fieldToSection[dataFieldLower] ||
                               fieldToSection[dataFieldNormalized] ||
                               fieldToSection[dataFieldLower.replace(/_/g, ' ')];

                if (section && value !== null && value !== undefined && value !== '') {
                    if (!grouped[section]) {
                        grouped[section] = {};
                    }
                    grouped[section][dataField] = value;
                    processedFields.add(dataField);
                }
            }
            
            // Add Observations if notes exist
            if (data.notes) {
                grouped['Observations'] = { observations: data.notes };
                processedFields.add('notes');
            }
            
            // Second pass: add any remaining fields to "Other Information"
            const otherFields = {};
            for (const [field, value] of Object.entries(data)) {
                // Skip if already processed
                if (processedFields.has(field)) continue;

                // Normalize field name for comparison (handle both snake_case and spaces)
                const fieldLower = field.toLowerCase().replace(/\s+/g, '_');
                const fieldWithSpaces = field.toLowerCase();

                // Skip confidence-related fields (various patterns)
                if (fieldLower.endsWith('_confidence') ||
                    fieldWithSpaces.endsWith(' confidence') ||
                    fieldLower.includes('confidence_') ||
                    fieldLower === 'field_scores' ||
                    fieldLower === 'document_confidence' ||
                    fieldLower === 'fields_needing_review' ||
                    fieldLower === 'notes' ||
                    fieldLower === 'doc_type' ||
                    // Skip chain_of_title and all its sub-fields (internal data for Phase 2)
                    fieldLower.startsWith('chain_of_title') ||
                    fieldWithSpaces.startsWith('chain of title') ||
                    fieldLower.includes('chain_of_title') ||
                    fieldWithSpaces.includes('chain of title') ||
                    // Skip reservation sub-fields (handled specially in Interest section)
                    (fieldLower.startsWith('reservation_') && fieldLower !== 'reservation') ||
                    (fieldWithSpaces.startsWith('reservation ') && fieldWithSpaces !== 'reservation') ||
                    // Skip internal metadata (page info from multi-document splitting)
                    fieldLower === 'start_page' ||
                    fieldWithSpaces === 'start page' ||
                    fieldLower.includes('start_page') ||
                    fieldLower === '_split_metadata' ||
                    fieldLower === 'split_metadata' ||
                    fieldLower.includes('split_metadata') ||
                    fieldWithSpaces.includes('start page') ||
                    fieldLower === 'end_page' ||
                    fieldWithSpaces === 'end page' ||
                    fieldLower.includes('end_page') ||
                    fieldWithSpaces.includes('end page') ||
                    fieldLower === 'page_count' ||
                    fieldLower === 'page_number' ||
                    fieldLower === 'prior_instruments' ||
                    fieldLower === 'property_acquisition' ||
                    fieldLower === 'will_and_probate' ||
                    fieldLower === 'unpaid_debts' ||
                    fieldLower === 'inheritance_tax_status' ||
                    fieldLower === 'notary' ||
                    fieldLower === 'recording_info' ||
                    fieldLower === 'adopted_stepchildren' ||
                    fieldLower === 'grandchildren_of_predeceased') {
                    continue;
                }
                
                // Skip null/undefined/empty values
                if (value === null || value === undefined || value === '') {
                    continue;
                }
                
                otherFields[field] = value;
            }
            
            if (Object.keys(otherFields).length > 0) {
                grouped['Other Information'] = otherFields;
            }
            
            return grouped;
        }
        
        // Render all fields dynamically
        function renderExtractedData(data, fieldScores) {
            let content = '';

            // Key Takeaway - render prominently at the very top, outside sections
            if (data.key_takeaway) {
                // Clean up formatting issues - remove random # and excessive whitespace
                let cleanedTakeaway = String(data.key_takeaway)
                    .trim()
                    .replace(/^#\s*/gm, '') // Remove leading # from lines
                    .replace(/^\s+/gm, '') // Remove leading spaces from each line
                    .replace(/\t/g, ' ') // Replace tabs with spaces
                    .replace(/\n{3,}/g, '\n\n'); // Collapse multiple newlines

                content += `<div style="margin-bottom: 16px;">
                    <details class="key-takeaway-block" open>
                        <summary class="key-takeaway-trigger">
                            <span class="details-chevron">&#9654;</span>
                            <span class="key-takeaway-label">Key Takeaway</span>
                        </summary>
                        <div class="key-takeaway-content">${escapeHtml(cleanedTakeaway)}</div>
                    </details>
                </div>`;
            }

            // Detailed Analysis - render right after Key Takeaway, full width, not nested
            if (data.ai_observations) {
                const cleanedAnalysis = String(data.ai_observations)
                    .trim()
                    .replace(/^\s+/gm, '')
                    .replace(/\t/g, ' ');

                content += `<div style="margin-bottom: 20px;">
                    <details class="detailed-analysis-block">
                        <summary class="detailed-analysis-trigger">
                            <span class="details-chevron">&#9654;</span>
                            <span class="detailed-analysis-label">View Detailed Analysis</span>
                            <span class="detailed-analysis-hint">Click to expand</span>
                        </summary>
                        <div class="detailed-analysis-content">${escapeHtml(cleanedAnalysis)}</div>
                    </details>
                </div>`;
            }

            const groupedFields = groupFieldsBySection(data);

            // Define section order (Key Takeaway and Detailed Analysis rendered above, not in sections)
            const sectionOrder = [
                'Operator/Payor',
                'Property/Well',
                'Owner',
                'Interests',
                'Payment Terms',
                'Legal Description',
                'Parties',
                'Interest & Consideration',
                'Recording Information',
                'Execution Details',
                'Title & Warranties',
                'Restrictions & Provisions',
                'Lease Terms',
                'Well Information',
                'Order Details',
                'Hearing Details',
                'Document References',
                'Other Information'
            ];
            
            // Render sections in defined order
            for (const sectionName of sectionOrder) {
                const fields = groupedFields[sectionName];
                if (!fields) continue;
                // Build section content first to check if it's empty
                let sectionContent = '';
                let hasVisibleFields = false;
                
                for (const [fieldName, value] of Object.entries(fields)) {
                    // Special handling for observations
                    if (fieldName === 'observations' && sectionName.includes('Observations')) {
                        const observations = escapeHtml(String(value));
                        const isLong = observations.length > 200;
                        
                        sectionContent += '<div id="observationsContainer" style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 12px; font-size: 13px; line-height: 1.5; color: #6B7280; width: 100%; grid-column: 1 / -1;">';
                        
                        if (isLong) {
                            const truncated = observations.substring(0, 200) + '...';
                            sectionContent += `<div id="observationsText" data-full="${observations.replace(/"/g, '&quot;')}" data-truncated="${truncated.replace(/"/g, '&quot;')}">${truncated}</div>`;
                            sectionContent += `<button type="button" onclick="toggleObservations()" id="observationsToggle" style="background: none; border: none; color: #1D6F5C; cursor: pointer; font-size: 13px; margin-top: 8px; padding: 0;">Show more </button>`;
                        } else {
                            sectionContent += observations;
                        }
                        
                        sectionContent += '</div>';
                        hasVisibleFields = true;
                        continue;
                    }
                    // Special handling for nested objects
                    if (fieldName === 'legal_description' && typeof value === 'object') {
                        // Handle legal description object
                        for (const [subField, subValue] of Object.entries(value)) {
                            // Skip confidence fields within legal description
                            const subFieldLower = subField.toLowerCase();
                            if (subFieldLower.endsWith('_confidence') ||
                                subFieldLower.endsWith(' confidence') ||
                                subFieldLower.includes('confidence_')) {
                                continue;
                            }

                            if (subValue !== null && subValue !== undefined && subValue !== '') {
                                // Special handling for sections array in legal_description
                                if (subField === 'sections' && Array.isArray(subValue)) {
                                    sectionContent += `<div class="doc-field" style="grid-column: 1 / -1;">`;
                                    sectionContent += `<label>Locations</label>`;
                                    sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                                    subValue.forEach(loc => {
                                        if (typeof loc === 'object') {
                                            const section = loc.section || '';
                                            const township = loc.township || '';
                                            const range = loc.range || '';
                                            const locStr = section ? `Section ${section}` + (township ? ` - ${township}` : '') + (range ? `-${range}` : '') : '';
                                            if (locStr) {
                                                sectionContent += `
                                                    <div style="background: #F0F9FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 6px 10px;">
                                                        <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(locStr)}</span>
                                                    </div>`;
                                            }
                                        }
                                    });
                                    sectionContent += `</div></div>`;
                                    hasVisibleFields = true;
                                } else {
                                    sectionContent += `
                                        <div class="doc-field">
                                            <label>${formatFieldName(subField)}</label>
                                            <div class="doc-value">${escapeHtml(String(subValue))}${getConfidenceIndicator(`legal_${subField}`, fieldScores)}</div>
                                        </div>`;
                                    hasVisibleFields = true;
                                }
                            }
                        }
                    } else if (Array.isArray(value)) {
                        // Handle arrays
                        if (value.length > 0) {
                            hasVisibleFields = true;
                            sectionContent += `<div class="doc-field" style="grid-column: 1 / -1;">`;
                            sectionContent += `<label>${formatFieldName(fieldName)}</label>`;

                            if (fieldName === 'grantors' || fieldName === 'grantees') {
                                // Special handling for grantors/grantees arrays with detailed info
                                const partyType = fieldName === 'grantors' ? 'Grantor' : 'Grantee';
                                const bgColor = fieldName === 'grantors' ? '#FEF3C7' : '#F0FDF4';
                                const borderColor = fieldName === 'grantors' ? '#F59E0B' : '#22C55E';
                                const textColor = fieldName === 'grantors' ? '#92400E' : '#166534';

                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach((party, index) => {
                                    if (typeof party === 'object') {
                                        const name = party.name || 'Unknown';
                                        const address = party.address || '';
                                        const maritalStatus = party.marital_status || '';

                                        sectionContent += `
                                            <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 6px; padding: 10px 12px;">
                                                <div style="font-weight: 600; color: ${textColor};">${escapeHtml(name)}</div>
                                                ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(address)}</div>` : ''}
                                                ${maritalStatus ? `<div style="font-size: 11px; color: #9CA3AF; margin-top: 2px; text-transform: capitalize;">${escapeHtml(maritalStatus)}</div>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 6px; padding: 10px 12px;">
                                                <span style="font-weight: 600; color: ${textColor};">${escapeHtml(String(party))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'heirs_summary') {
                                // Special handling for heirs summary with shares
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(heir => {
                                    if (typeof heir === 'object') {
                                        const name = heir.name || 'Unknown';
                                        const relationship = heir.relationship || '';
                                        const share = heir.estimated_share || heir.share || '';
                                        const shareDecimal = heir.share_decimal;

                                        sectionContent += `
                                            <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <span style="font-weight: 600; color: #1E40AF;">${escapeHtml(name)}</span>
                                                    ${relationship ? `<span style="color: #6B7280; font-size: 12px; margin-left: 8px;">(${escapeHtml(relationship)})</span>` : ''}
                                                </div>
                                                ${share ? `<span style="background: #DBEAFE; color: #1E40AF; padding: 4px 10px; border-radius: 4px; font-weight: 500;">${escapeHtml(share)}</span>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `<div style="padding: 8px; background: #EFF6FF; border-radius: 4px;">${escapeHtml(String(heir))}</div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'children_living' || fieldName === 'spouses') {
                                // Special handling for children and spouses arrays
                                const bgColor = fieldName === 'children_living' ? '#F0FDF4' : '#FAF5FF';
                                const borderColor = fieldName === 'children_living' ? '#22C55E' : '#A855F7';
                                const textColor = fieldName === 'children_living' ? '#166534' : '#7C3AED';

                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(person => {
                                    if (typeof person === 'object') {
                                        const name = person.name || 'Unknown';
                                        const address = person.address || '';
                                        const spouseName = person.spouse_name || '';
                                        const status = person.status || '';
                                        const marriageDate = person.marriage_date || '';

                                        sectionContent += `
                                            <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 6px; padding: 10px 12px;">
                                                <div style="font-weight: 600; color: ${textColor};">${escapeHtml(name)}</div>
                                                ${status ? `<div style="font-size: 11px; color: #9CA3AF; text-transform: capitalize;">${escapeHtml(status)}</div>` : ''}
                                                ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(address)}</div>` : ''}
                                                ${spouseName ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Spouse: ${escapeHtml(spouseName)}</div>` : ''}
                                                ${marriageDate ? `<div style="font-size: 11px; color: #9CA3AF;">Married: ${escapeHtml(marriageDate)}</div>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `<div style="padding: 8px; background: ${bgColor}; border-radius: 4px;">${escapeHtml(String(person))}</div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'election_options') {
                                // Special handling for election options
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach((option, index) => {
                                    // Support both option.type and option.option_type
                                    const optType = (option.option_type || option.type || '').toLowerCase();

                                    // Color coding by option type
                                    let optionBgColor, optionBorderColor;
                                    if (optType === 'participate') {
                                        optionBgColor = '#F0F9FF'; optionBorderColor = '#3B82F6'; // Blue
                                    } else if (optType === 'cash_bonus' || optType === 'cash_plus_royalty') {
                                        optionBgColor = '#FEF3C7'; optionBorderColor = '#F59E0B'; // Yellow/Amber
                                    } else if (optType === 'overburdened') {
                                        optionBgColor = '#F0FDF4'; optionBorderColor = '#22C55E'; // Green
                                    } else if (optType === 'royalty_conversion') {
                                        optionBgColor = '#FAF5FF'; optionBorderColor = '#A855F7'; // Purple
                                    } else if (optType === 'non_consent') {
                                        optionBgColor = '#FEE2E2'; optionBorderColor = '#EF4444'; // Red
                                    } else {
                                        optionBgColor = '#F3F4F6'; optionBorderColor = '#6B7280'; // Gray for unknown
                                    }

                                    sectionContent += `
                                        <div style="background: ${optionBgColor}; border: 1px solid ${optionBorderColor}; border-radius: 8px; padding: 12px;">
                                            <div style="font-weight: 600; color: ${optionBorderColor};">Option ${option.option_number || index + 1}${optType ? ` - ${formatFieldName(optType)}` : ''}</div>
                                            ${option.bonus_per_acre ? `<div>Cash Bonus: $${option.bonus_per_acre}/acre</div>` : ''}
                                            ${option.cash_bonus_per_acre ? `<div>Cash Bonus: $${option.cash_bonus_per_acre}/acre</div>` : ''}
                                            ${option.royalty_fraction ? `<div>Royalty: ${option.royalty_fraction}</div>` : ''}
                                            ${option.royalty_rate ? `<div>Royalty: ${option.royalty_rate}</div>` : ''}
                                            ${option.cost_per_nma ? `<div>Est. Cost: $${option.cost_per_nma.toLocaleString()}/NMA</div>` : ''}
                                            ${option.penalty_percentage ? `<div>Penalty: ${option.penalty_percentage}%</div>` : ''}
                                            ${option.working_interest_retained ? `<div style="color: #059669;"> Working Interest Retained</div>` : ''}
                                            ${option.net_revenue_interest ? `<div>NRI: ${option.net_revenue_interest}</div>` : ''}
                                            ${option.description ? `<div style="margin-top: 4px; font-size: 13px; color: #4B5563;">${escapeHtml(option.description)}</div>` : ''}
                                            ${option.notes ? `<div style="margin-top: 4px; font-size: 12px; color: #6B7280; font-style: italic;">${escapeHtml(option.notes)}</div>` : ''}
                                        </div>`;
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'formations') {
                                // Special handling for formations array
                                sectionContent += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                                value.forEach(formation => {
                                    if (typeof formation === 'object') {
                                        const name = formation.name || formation.formation || 'Unknown';
                                        const depthInfo = formation.depth_from && formation.depth_to
                                            ? ` (${formation.depth_from.toLocaleString()}' - ${formation.depth_to.toLocaleString()}')`
                                            : '';
                                        sectionContent += `
                                            <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 8px 12px;">
                                                <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(name)}</span>
                                                ${depthInfo ? `<span style="color: #6B7280; font-size: 12px;">${depthInfo}</span>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 8px 12px;">
                                                <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(String(formation))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'existing_wells') {
                                // Special handling for existing wells array (from increased density orders)
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(well => {
                                    if (typeof well === 'object') {
                                        const wellName = well.well_name || well.name || 'Unknown Well';
                                        const apiNumber = well.api_number || well.api || '';
                                        const classification = well.classification || well.type || '';
                                        sectionContent += `
                                            <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 6px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <span style="font-weight: 500; color: #166534;">${escapeHtml(wellName)}</span>
                                                    ${apiNumber ? `<span style="color: #6B7280; font-size: 12px; margin-left: 8px;">API: ${escapeHtml(apiNumber)}</span>` : ''}
                                                </div>
                                                ${classification ? `<span style="background: #DCFCE7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">${escapeHtml(classification)}</span>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 6px; padding: 10px 12px;">
                                                <span style="font-weight: 500; color: #166534;">${escapeHtml(String(well))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'heirs' && value.some(h => typeof h === 'object')) {
                                // Special handling for heirs array
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(heir => {
                                    if (typeof heir === 'object') {
                                        sectionContent += `<div style="padding: 8px; background: #F9FAFB; border-radius: 4px;">`;
                                        sectionContent += `<strong>${escapeHtml(heir.name || 'Unknown')}</strong>`;
                                        if (heir.relationship) sectionContent += ` - ${escapeHtml(heir.relationship)}`;
                                        if (heir.share) sectionContent += ` (${escapeHtml(heir.share)})`;
                                        sectionContent += `</div>`;
                                    } else {
                                        sectionContent += `<div>${escapeHtml(String(heir))}</div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'unit_sections') {
                                // Special handling for multi-unit horizontal well sections and Division Order allocations
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(unit => {
                                    if (typeof unit === 'object') {
                                        const section = unit.section || '';
                                        const township = unit.township || '';
                                        const range = unit.range || '';
                                        // Support both allocation_percentage (OCC orders) and allocation_factor (Division Orders)
                                        let allocation = unit.allocation_percentage;
                                        if (allocation === undefined && unit.allocation_factor !== undefined) {
                                            allocation = (unit.allocation_factor * 100).toFixed(2);
                                        }
                                        const acres = unit.acres;
                                        const spacingOrder = unit.spacing_order;

                                        const locationStr = section ? `Section ${section}` + (township ? ` - ${township}` : '') + (range ? `-${range}` : '') : 'Unknown Section';

                                        sectionContent += `
                                            <div style="background: #F0F9FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 10px 12px;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(locationStr)}</span>
                                                    ${allocation !== undefined ? `<span style="background: #DBEAFE; color: #1E40AF; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${allocation}% Allocation</span>` : ''}
                                                </div>
                                                ${acres || spacingOrder ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">
                                                    ${acres ? `${acres} acres` : ''}
                                                    ${acres && spacingOrder ? '  ' : ''}
                                                    ${spacingOrder ? `Spacing Order: ${spacingOrder}` : ''}
                                                </div>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: #F0F9FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 10px 12px;">
                                                <span style="font-weight: 500; color: #1E40AF;">${escapeHtml(String(unit))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else if (fieldName === 'affected_wells') {
                                // Special handling for change of operator affected wells
                                sectionContent += `<div style="display: flex; flex-direction: column; gap: 8px;">`;
                                value.forEach(well => {
                                    if (typeof well === 'object') {
                                        const wellName = well.well_name || well.name || '';
                                        const apiNumber = well.api_number || '';
                                        const legalLoc = well.legal_location || '';

                                        sectionContent += `
                                            <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 6px; padding: 10px 12px;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-weight: 500; color: #92400E;">${escapeHtml(wellName || 'Unknown Well')}</span>
                                                    ${apiNumber ? `<span style="color: #6B7280; font-size: 12px;">API: ${escapeHtml(apiNumber)}</span>` : ''}
                                                </div>
                                                ${legalLoc ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(legalLoc)}</div>` : ''}
                                            </div>`;
                                    } else {
                                        sectionContent += `
                                            <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 6px; padding: 10px 12px;">
                                                <span style="font-weight: 500; color: #92400E;">${escapeHtml(String(well))}</span>
                                            </div>`;
                                    }
                                });
                                sectionContent += `</div>`;
                            } else {
                                // Regular array
                                sectionContent += `<ul style="margin: 8px 0; padding-left: 20px;">`;
                                value.forEach(item => {
                                    sectionContent += `<li style="margin-bottom: 4px;">${escapeHtml(String(item))}</li>`;
                                });
                                sectionContent += `</ul>`;
                            }
                            sectionContent += getConfidenceIndicator(fieldName, fieldScores);
                            sectionContent += `</div>`;
                        }
                    } else if (typeof value === 'boolean') {
                        // Handle boolean values
                        hasVisibleFields = true;
                        sectionContent += `
                            <div class="doc-field">
                                <label>${formatFieldName(fieldName)}</label>
                                <div class="doc-value">${value ? 'Yes' : 'No'}${getConfidenceIndicator(fieldName, fieldScores)}</div>
                            </div>`;
                    } else if (typeof value === 'object' && value !== null) {
                        // Special handling for completion_interval
                        if (fieldName === 'completion_interval') {
                            hasVisibleFields = true;
                            const topDepth = value.top_depth;
                            const bottomDepth = value.bottom_depth;
                            const length = value.length || value.lateral_length;

                            sectionContent += `
                                <div class="doc-field">
                                    <label>Completion Interval</label>
                                    <div style="background: #F3E8FF; border: 1px solid #A855F7; border-radius: 6px; padding: 10px 12px;">
                                        ${topDepth != null && bottomDepth != null ?
                                            `<div style="font-weight: 500; color: #7C3AED;">${Number(topDepth).toLocaleString()}' - ${Number(bottomDepth).toLocaleString()}'</div>` : ''}
                                        ${length != null ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Length: ${Number(length).toLocaleString()}'</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'interest_conveyed') {
                            // Special handling for interest_conveyed object
                            hasVisibleFields = true;
                            const interestType = value.type || '';
                            const fractionText = value.fraction_text || '';
                            const fractionDecimal = value.fraction_decimal;
                            const netMineralAcres = value.net_mineral_acres;
                            const depthLimit = value.depth_limitation;
                            const formationLimit = value.formation_limitation;

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Interest Conveyed</label>
                                    <div style="background: #EFF6FF; border: 1px solid #3B82F6; border-radius: 6px; padding: 12px;">
                                        ${interestType ? `<div style="font-weight: 600; color: #1E40AF; text-transform: capitalize; margin-bottom: 4px;">${escapeHtml(interestType)} Interest</div>` : ''}
                                        ${fractionText ? `<div style="color: #374151;">${escapeHtml(fractionText)}</div>` : ''}
                                        ${fractionDecimal != null ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Decimal: ${fractionDecimal}</div>` : ''}
                                        ${netMineralAcres != null ? `<div style="font-size: 13px; color: #059669; font-weight: 500; margin-top: 6px;">${netMineralAcres} Net Mineral Acres</div>` : ''}
                                        ${depthLimit ? `<div style="font-size: 12px; color: #92400E; margin-top: 4px;">Depth: ${escapeHtml(depthLimit)}</div>` : ''}
                                        ${formationLimit ? `<div style="font-size: 12px; color: #92400E; margin-top: 2px;">Formation: ${escapeHtml(formationLimit)}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'reservation') {
                            // Special handling for reservation object
                            if (value.has_reservation) {
                                hasVisibleFields = true;
                                const reservationText = value.reservation_text || '';
                                const reservedType = value.reserved_interest_type || '';
                                const reservedFraction = value.reserved_fraction || '';

                                sectionContent += `
                                    <div class="doc-field" style="grid-column: 1 / -1;">
                                        <label>Reservation</label>
                                        <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 6px; padding: 12px;">
                                            <div style="font-weight: 600; color: #92400E; margin-bottom: 4px;">Grantor Reserved Interest</div>
                                            ${reservedType ? `<div style="color: #374151; text-transform: capitalize;">${escapeHtml(reservedType)}</div>` : ''}
                                            ${reservedFraction ? `<div style="font-size: 13px; color: #92400E; margin-top: 4px;">Reserved: ${escapeHtml(reservedFraction)}</div>` : ''}
                                            ${reservationText ? `<div style="font-size: 12px; color: #6B7280; margin-top: 6px; font-style: italic;">"${escapeHtml(reservationText)}"</div>` : ''}
                                        </div>
                                    </div>`;
                            }
                        } else if (fieldName === 'decedent') {
                            // Special handling for decedent object
                            hasVisibleFields = true;
                            const name = value.name || 'Unknown';
                            const deathDate = value.date_of_death || '';
                            const birthDate = value.date_of_birth || '';
                            const age = value.age_at_death;
                            const placeOfDeath = value.place_of_death;

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Decedent</label>
                                    <div style="background: #F3F4F6; border: 1px solid #6B7280; border-radius: 6px; padding: 12px;">
                                        <div style="font-weight: 600; color: #1F2937; font-size: 15px;">${escapeHtml(name)}</div>
                                        ${deathDate ? `<div style="font-size: 13px; color: #4B5563; margin-top: 4px;">Date of Death: ${escapeHtml(deathDate)}${age ? ` (Age ${age})` : ''}</div>` : ''}
                                        ${birthDate ? `<div style="font-size: 12px; color: #6B7280;">Born: ${escapeHtml(birthDate)}</div>` : ''}
                                        ${placeOfDeath && placeOfDeath.county ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Place of Death: ${escapeHtml(placeOfDeath.county)} County, ${escapeHtml(placeOfDeath.state || 'OK')}</div>` : ''}
                                    </div>
                                </div>`;
                        } else if (fieldName === 'affiant') {
                            // Special handling for affiant object
                            hasVisibleFields = true;
                            const name = value.name || 'Unknown';
                            const relationship = value.relationship_to_decedent || '';
                            const address = value.address || '';
                            const yearsKnown = value.years_known_decedent;

                            sectionContent += `
                                <div class="doc-field" style="grid-column: 1 / -1;">
                                    <label>Affiant</label>
                                    <div style="background: #F0FDF4; border: 1px solid #22C55E; border-radius: 6px; padding: 12px;">
                                        <div style="font-weight: 600; color: #166534;">${escapeHtml(name)}</div>
                                        ${relationship ? `<div style="font-size: 13px; color: #4B5563; margin-top: 4px; text-transform: capitalize;">Relationship: ${escapeHtml(relationship)}</div>` : ''}
                                        ${yearsKnown ? `<div style="font-size: 12px; color: #6B7280;">Knew decedent for ${yearsKnown} years</div>` : ''}
                                        ${address ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${escapeHtml(address)}</div>` : ''}
                                    </div>
                                </div>`;
                        } else {
                            // Handle other nested objects (like grantor/grantee)
                            for (const [subField, subValue] of Object.entries(value)) {
                                if (subValue !== null && subValue !== undefined && subValue !== '') {
                                    hasVisibleFields = true;
                                    // Handle nested objects/arrays properly
                                    let displayValue;
                                    if (typeof subValue === 'object') {
                                        displayValue = JSON.stringify(subValue, null, 2);
                                    } else {
                                        displayValue = String(subValue);
                                    }
                                    sectionContent += `
                                        <div class="doc-field">
                                            <label>${formatFieldName(fieldName)} ${formatFieldName(subField)}</label>
                                            <div class="doc-value">${escapeHtml(displayValue)}${getConfidenceIndicator(`${fieldName}_${subField}`, fieldScores)}</div>
                                        </div>`;
                                }
                            }
                        }
                    } else {
                        // Regular field
                        hasVisibleFields = true;
                        
                        // Skip key_takeaway and ai_observations - rendered at the top
                        if (fieldName === 'key_takeaway' || fieldName === 'ai_observations') {
                            // Already rendered at top of content
                            hasVisibleFields = false; // Don't count these as visible in sections
                        } else {
                            sectionContent += `
                                <div class="doc-field">
                                    <label>${formatFieldName(fieldName)}</label>
                                    <div class="doc-value">${escapeHtml(String(value))}${getConfidenceIndicator(fieldName, fieldScores)}</div>
                                </div>`;
                        }
                    }
                }
                
                // Only add section if it has visible fields
                if (hasVisibleFields) {
                    // Make Observations expanded by default, all others collapsed
                    const isObservations = sectionName === 'Observations' || sectionName === 'Observations';
                    const isExpanded = isObservations;
                    const sectionId = sectionName.toLowerCase().replace(/[^a-z0-9]/g, '-');
                    
                    content += `<div class="detail-section">`;
                    content += `<h4 class="detail-section-title collapsible ${isExpanded ? 'expanded' : ''}" onclick="toggleSection('${sectionId}')" data-section="${sectionId}">`;
                    content += `<span class="section-chevron">&#9654;</span> ${sectionName}`;
                    content += `</h4>`;
                    content += `<div class="doc-detail-grid" id="${sectionId}" style="display: ${isExpanded ? 'grid' : 'none'};">`;
                    content += sectionContent;
                    content += `</div></div>`;
                }
            }
            
            return content;
        }
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const header = document.querySelector(`[data-section="${sectionId}"]`);

            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'grid';
                header.classList.add('expanded');
            } else {
                section.style.display = 'none';
                header.classList.remove('expanded');
            }
        }
        
        function toggleConfidenceDetails(btn) {
            const details = btn.closest('.confidence-section').querySelector('.confidence-details');
            const modal = btn.closest('.modal');
            const isHidden = details.style.display === 'none';
            
            details.style.display = isHidden ? 'block' : 'none';
            btn.textContent = isHidden ? 'Hide Details ' : 'Show Details ';
            
            // Toggle confidence-visible class on modal to show/hide inline indicators
            if (isHidden) {
                modal.classList.add('confidence-visible');
            } else {
                modal.classList.remove('confidence-visible');
            }
        }
        
        function calculateOverallScore(fieldScores) {
            if (!fieldScores || Object.keys(fieldScores).length === 0) return null;
            
            // Only include fields that actually exist in the document
            // (score > 0 means the field was found and extracted)
            const scores = [];
            
            for (const [field, score] of Object.entries(fieldScores)) {
                if (typeof score === 'number' && score > 0) {
                    scores.push(score);
                }
            }
            
            if (scores.length === 0) return null;
            
            // Calculate average of only the fields that exist
            const avg = scores.reduce((sum, score) => sum + score, 0) / scores.length;
            return avg;
        }

        async function openDocumentDetail(docId) {
            console.log('=== OPENING DOCUMENT DETAILS ===');
            console.log('Document ID:', docId);
            
            // Fetch fresh document data to get children if any
            try {
                console.log('Fetching document from API...');
                const response = await fetch(`/api/documents/${docId}`);
                if (!response.ok) throw new Error('Failed to fetch document details');
                
                const data = await response.json();
                const doc = data.document;
                
                if (!doc) {
                    console.error('Document not found:', docId);
                    return;
                }
                
                // Debug: Log document data
                console.log('Document data received:', {
                    id: doc.id,
                    filename: doc.display_name || doc.filename,
                    has_children: !!doc.children,
                    child_count: doc.child_count,
                    children: doc.children,
                    property_id: doc.property_id,
                    property_name: doc.property_name,
                    well_id: doc.well_id,
                    well_name: doc.well_name,
                    well_api_number: doc.well_api_number
                });
                console.log('Full document object:', doc);
                
                currentDocumentId = docId;
                currentDocumentContentType = doc.content_type || 'application/pdf';
                currentDocumentRotation = doc.rotation_applied || 0;
                currentDocumentFilename = doc.display_name || doc.filename;

            // Update modal header
            document.getElementById('documentModalTitle').textContent = formatDocType(doc.category || doc.doc_type) || 'Document Details';
            
            // Update subtitle with filename and status
            let subtitleText = doc.display_name || doc.filename;
            if (doc.status === 'complete' && doc.confidence) {
                subtitleText += `  ${doc.confidence} confidence`;
            }
            document.getElementById('documentModalSubtitle').textContent = subtitleText;
            
            // Format the content based on what data is available
            let content = '';
            
            // Debug: Log which display path we're taking
            console.log('Display logic:', {
                has_children: !!doc.children,
                children_length: doc.children ? doc.children.length : 0,
                has_extracted_data: !!doc.extracted_data,
                status: doc.status
            });
            
            // Check if this is a parent document with children
            if (doc.children && doc.children.length > 0) {
                console.log('PARENT DOCUMENT DETECTED with', doc.children.length, 'children');
                // Parent document - show split info
                content += '<div class="doc-detail-grid">';
                
                // Status field
                const statusColor = doc.status === 'complete' ? '#1D6F5C' :
                                   doc.status === 'failed' ? 'var(--error)' :
                                   doc.status === 'manual_review' ? '#D97706' : '#F59E0B';
                const statusText = doc.status === 'complete' ? 'Complete' :
                                  doc.status === 'failed' ? 'Failed' :
                                  doc.status === 'manual_review' ? 'Needs Review' : 'Processing';
                content += `
                    <div class="doc-field">
                        <label>Status</label>
                        <div class="doc-value" style="color: ${statusColor}; font-weight: 600;">${statusText}</div>
                    </div>`;
                
                content += '</div>';
                
                // Split document info
                content += '<div class="detail-section" style="background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 8px; padding: 16px; margin: 20px 0;">';
                content += '<h4 style="margin: 0 0 12px 0; color: #1E40AF; font-size: 16px; font-weight: 600;">This PDF contained multiple documents</h4>';
                content += `<p style="margin: 0; color: #1E40AF; font-size: 14px;">The uploaded PDF has been split into ${doc.children.length} separate documents for easier management.</p>`;
                content += '</div>';
                
                // List of child documents
                content += '<div class="detail-section">';
                content += '<h4 class="detail-section-title">Individual Documents</h4>';
                content += '<div style="display: flex; flex-direction: column; gap: 8px;">';
                
                doc.children.forEach((child, index) => {
                    const childDocType = formatDocType(child.doc_type) || 'Document';
                    const pageInfo = child.page_range_start && child.page_range_end ? 
                        ` (Pages ${child.page_range_start}-${child.page_range_end})` : '';
                    
                    content += `
                        <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 12px; display: flex; justify-content: between; align-items: center; cursor: pointer; transition: all 0.2s;"
                             onmouseover="this.style.backgroundColor='#F3F4F6'" 
                             onmouseout="this.style.backgroundColor='#F9FAFB'"
                             onclick="openDocumentDetail('${child.id}')">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--oil-navy); margin-bottom: 4px;">
                                    ${index + 1}. ${escapeHtml(child.display_name || child.filename)}
                                </div>
                                <div style="font-size: 13px; color: #6B7280;">
                                    ${childDocType}${pageInfo}
                                    ${child.county ? `  ${escapeHtml(child.county)} County` : ''}
                                    ${child.confidence ? `  ${child.confidence} confidence` : ''}
                                </div>
                            </div>
                            <div style="color: #1D6F5C; font-weight: 500; font-size: 14px; margin-left: 16px;">
                                View 
                            </div>
                        </div>
                    `;
                });
                
                content += '</div></div>';
                
                // User Notes - always show
                content += '<div class="detail-section">';
                content += '<h4 class="detail-section-title">Notes</h4>';
                content += `<textarea id="userNotesTextarea" onchange="enableSaveButton()" oninput="enableSaveButton()" style="width: 100%; min-height: 100px; padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 14px; line-height: 1.5; resize: vertical; font-family: inherit;" placeholder="Add your notes here...">${escapeHtml(doc.user_notes || '')}</textarea>`;
                content += '</div>';
                
            } else if (doc.extracted_data) {
                try {
                    const data = JSON.parse(doc.extracted_data);
                    const fieldScores = data.field_scores || {};
                    
                    // Check if this is an "other" document with skip_extraction
                    if (data.skip_extraction) {
                        // Simplified display for "other" documents
                        content += '<div class="doc-detail-grid">';
                        
                        // Status field
                        const statusColor = doc.status === 'complete' ? '#1D6F5C' :
                                           doc.status === 'failed' ? 'var(--error)' :
                                           doc.status === 'manual_review' ? '#D97706' : '#F59E0B';
                        const statusText = doc.status === 'complete' ? 'Complete' :
                                          doc.status === 'failed' ? 'Failed' :
                                          doc.status === 'manual_review' ? 'Needs Review' : 'Processing';
                        content += `
                            <div class="doc-field">
                                <label>Status</label>
                                <div class="doc-value" style="color: ${statusColor}; font-weight: 600;">${statusText}</div>
                            </div>`;
                        
                        // Document Type
                        content += `
                            <div class="doc-field">
                                <label>Document Type</label>
                                <div class="doc-value">Other</div>
                            </div>`;
                        
                        // Upload date
                        const uploadDate = new Date(doc.upload_date).toLocaleDateString('en-US', { 
                            timeZone: 'America/Chicago',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        content += `
                            <div class="doc-field">
                                <label>Uploaded</label>
                                <div class="doc-value">${uploadDate}</div>
                            </div>`;
                        
                        // Page count if available
                        if (doc.page_count) {
                            content += `
                                <div class="doc-field">
                                    <label>Page Count</label>
                                    <div class="doc-value">${doc.page_count} page${doc.page_count > 1 ? 's' : ''}</div>
                                </div>`;
                        }
                        
                        content += '</div>';

                        // Key Takeaway if available (always visible, prominent at top)
                        if (data.key_takeaway) {
                            const cleanedTakeaway = data.key_takeaway.trim().replace(/^#\s*/gm, '').replace(/^\s+/gm, '').replace(/\t/g, ' ').replace(/\n{3,}/g, '\n\n');
                            content += `<div style="margin-bottom: 16px;">
                                <details class="key-takeaway-block" open>
                                    <summary class="key-takeaway-trigger">
                                        <span class="details-chevron">&#9654;</span>
                                        <span class="key-takeaway-label">Key Takeaway</span>
                                    </summary>
                                    <div class="key-takeaway-content">${escapeHtml(cleanedTakeaway)}</div>
                                </details>
                            </div>`;
                        }

                        // AI Observations if available (prominent expandable detailed analysis)
                        if (data.ai_observations) {
                            content += '<div class="detail-section">';
                            const cleanedObs = data.ai_observations.trim().replace(/^\s+/gm, '').replace(/\t/g, ' ');
                            content += `<details class="detailed-analysis-block">
                                <summary class="detailed-analysis-trigger">
                                    <span class="details-chevron">&#9654;</span>
                                    <span class="detailed-analysis-label">View Detailed Analysis</span>
                                    <span class="detailed-analysis-hint">Click to expand</span>
                                </summary>
                                <div class="detailed-analysis-content">${escapeHtml(cleanedObs)}</div>
                            </details>`;
                            content += '</div>';
                        }

                        // Message about no extraction
                        content += '<div class="detail-section" style="background: #F3F4F6; border: 1px solid #E5E7EB; border-radius: 8px; padding: 16px; margin-top: 20px;">';
                        content += '<p style="margin: 0; color: #4B5563; font-size: 14px; line-height: 1.5;">This document was classified as "Other" and detailed field extraction was skipped. You can view the original PDF using the button below.</p>';
                        content += '</div>';
                        
                        // User Notes - always show
                        content += '<div class="detail-section">';
                        content += '<h4 class="detail-section-title">Notes</h4>';
                        content += `<textarea id="userNotesTextarea" onchange="enableSaveButton()" oninput="enableSaveButton()" style="width: 100%; min-height: 100px; padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 14px; line-height: 1.5; resize: vertical; font-family: inherit;" placeholder="Add your notes here...">${escapeHtml(doc.user_notes || '')}</textarea>`;
                        content += '</div>';
                        
                    } else {
                        // Normal extraction flow
                        // Add status info at the top
                        content += '<div class="doc-detail-grid">';
                        
                        // Status field
                        const statusColor = doc.status === 'complete' ? '#1D6F5C' :
                                           doc.status === 'failed' ? 'var(--error)' :
                                           doc.status === 'manual_review' ? '#D97706' : '#F59E0B';
                        const statusText = doc.status === 'complete' ? 'Complete' :
                                          doc.status === 'failed' ? 'Failed' :
                                          doc.status === 'manual_review' ? 'Needs Review' : 'Processing';
                        content += `
                            <div class="doc-field">
                                <label>Status</label>
                                <div class="doc-value" style="color: ${statusColor}; font-weight: 600;">${statusText}</div>
                            </div>`;
                        
                        // Document Type
                        if (data.doc_type || doc.doc_type) {
                            content += `
                                <div class="doc-field">
                                    <label>Document Type</label>
                                    <div class="doc-value">${formatDocType(data.category || data.doc_type || doc.category || doc.doc_type)}</div>
                                </div>`;
                        }
                        
                        content += '</div>';
                    
                    // Add linked property/well section as collapsible
                    if (doc.property_id || doc.well_id) {
                        const sectionId = 'linked-items';
                        const isExpanded = true; // Show expanded by default for linked items
                        
                        content += '<div class="detail-section">';
                        content += `<h4 class="detail-section-title collapsible ${isExpanded ? 'expanded' : ''}" onclick="toggleSection('${sectionId}')" data-section="${sectionId}">`;
                        content += `<span class="section-chevron">&#9654;</span> Linked Items`;
                        content += '</h4>';
                        content += `<div class="doc-detail-grid" id="${sectionId}" style="display: ${isExpanded ? 'grid' : 'none'};">`;
                        
                        if (doc.property_name && doc.property_id) {
                            content += `
                                <div class="doc-field">
                                    <label>Property</label>
                                    <div class="doc-value" style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: #1E40AF; font-weight: 500;">${escapeHtml(doc.property_name)}</span>
                                        <button onclick="console.log('Button clicked for property:', '${doc.property_id}'); openPropertyFromDocument('${doc.property_id}')" 
                                                style="background: #1D6F5C; color: white; border: none; padding: 4px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap;">
                                            View 
                                        </button>
                                    </div>
                                </div>`;
                        }
                        
                        if (doc.well_name && doc.well_id) {
                            content += `
                                <div class="doc-field">
                                    <label>Well</label>
                                    <div class="doc-value" style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span style="color: #1E40AF; font-weight: 500;">${escapeHtml(doc.well_name)}</span>
                                            ${doc.well_api_number ? `<span style="color: #6B7280; font-size: 13px; margin-left: 8px;">(${escapeHtml(doc.well_api_number)})</span>` : ''}
                                        </div>
                                        <button onclick="console.log('Button clicked for well:', '${doc.well_id}'); openWellFromDocument('${doc.well_id}')" 
                                                style="background: #1D6F5C; color: white; border: none; padding: 4px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap;">
                                            View 
                                        </button>
                                    </div>
                                </div>`;
                        }
                        
                        content += '</div></div>';
                    }
                    
                    // Confidence Section with collapsible details
                    if (fieldScores && Object.keys(fieldScores).length > 0) {
                        const overallScore = calculateOverallScore(fieldScores);
                        const confidenceLevel = doc.confidence || 'medium';
                        const confidenceText = confidenceLevel.charAt(0).toUpperCase() + confidenceLevel.slice(1);
                        
                        content += '<div class="confidence-section">';
                        content += '<div class="confidence-header">';
                        content += '<span class="confidence-label">Confidence</span>';
                        content += `<span class="confidence-badge confidence-${confidenceLevel}">`;
                        content += ` ${confidenceText}`;
                        if (overallScore) {
                            content += ` (${Math.round(overallScore * 100)}%)`;
                        }
                        content += '</span>';
                        content += '<button class="confidence-toggle" onclick="toggleConfidenceDetails(this)">Show Details </button>';
                        content += '</div>';
                        
                        // Collapsible details section
                        content += '<div class="confidence-details" style="display: none;">';
                        content += '<div class="confidence-details-grid">';
                        
                        // Field mapping for display
                        const fieldMapping = {
                            'grantor_name': 'Grantor Name',
                            'grantor_address': 'Grantor Address',
                            'grantee_name': 'Grantee Name',
                            'grantee_address': 'Grantee Address',
                            'interest_conveyed': 'Interest Conveyed',
                            'legal_section': 'Section',
                            'legal_township': 'Township',
                            'legal_range': 'Range',
                            'legal_county': 'County',
                            'legal_quarter': 'Quarter/Description',
                            'legal_acres': 'Total Acres',
                            'execution_date': 'Execution Date',
                            'recording_book': 'Recording Book',
                            'recording_page': 'Recording Page',
                            'recording_date': 'Recording Date',
                            'consideration': 'Consideration',
                            // Division Order fields
                            'well_name': 'Well Name',
                            'api_number': 'API Number',
                            'owner_number': 'Owner Number',
                            'decimal_interest': 'Decimal Interest',
                            'interest_type': 'Interest Type',
                            'operator': 'Operator',
                            'effective_date': 'Effective Date',
                            'product_type': 'Product Type',
                            // Pooling Order fields
                            'cd_number': 'CD Number',
                            'order_number': 'Order Number',
                            'applicant': 'Applicant',
                            'well_cost': 'Well Cost',
                            'unit_size_acres': 'Unit Size',
                            'formations': 'Formations',
                            'election_deadline_days': 'Election Deadline',
                            'election_options': 'Election Options',
                            'order_date': 'Order Date',
                            'election_mailing_address': 'Election Address'
                        };
                        
                        // Sort fields by score (lowest first) for easier review
                        const sortedFields = Object.entries(fieldScores)
                            .filter(([field, score]) => score !== null && score !== undefined)
                            .sort((a, b) => a[1] - b[1]);
                        
                        sortedFields.forEach(([field, score]) => {
                            const displayName = fieldMapping[field] || field;
                            const percentage = Math.round(score * 100);
                            const indicator = score >= 0.9 ? '' : score >= 0.6 ? '' : '';
                            const indicatorClass = score >= 0.9 ? 'confidence-high' : score >= 0.6 ? 'confidence-medium' : 'confidence-low';
                            
                            content += `
                                <div class="confidence-detail-item">
                                    <span class="field-name">${displayName}</span>
                                    <span class="field-score">
                                        <span class="${indicatorClass}">${indicator}</span>
                                        ${percentage}%
                                    </span>
                                </div>
                            `;
                        });
                        
                        content += '</div>';
                        content += '</div>';
                        content += '</div>';
                    }
                    
                    // Render all extracted fields dynamically (includes Observations at top)
                    content += renderExtractedData(data, fieldScores);
                    
                    // User Notes
                    content += '<div class="detail-section">';
                    content += '<h4 class="detail-section-title">Notes</h4>';
                    content += `<textarea id="userNotesTextarea" onchange="enableSaveButton()" oninput="enableSaveButton()" style="width: 100%; min-height: 100px; padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 14px; line-height: 1.5; resize: vertical; font-family: inherit;" placeholder="Add your notes here...">${escapeHtml(doc.user_notes || '')}</textarea>`;
                    content += '</div>';
                    }
                    
                } catch (e) {
                    console.error('Error parsing extracted data:', e);
                    content += '<div class="detail-section">';
                    content += '<p style="color: var(--error);">Error displaying extracted data</p>';
                    content += '</div>';
                }
            } else {
                // No extracted data yet - show status and user notes
                content += '<div class="doc-detail-grid">';
                
                // Status field
                const statusColor = doc.status === 'complete' ? '#1D6F5C' :
                                   doc.status === 'failed' ? 'var(--error)' :
                                   doc.status === 'manual_review' ? '#D97706' : '#F59E0B';
                const statusText = doc.status === 'complete' ? 'Complete' :
                                  doc.status === 'failed' ? 'Failed' :
                                  doc.status === 'manual_review' ? 'Needs Review' : 'Processing';
                content += `
                    <div class="doc-field">
                        <label>Status</label>
                        <div class="doc-value" style="color: ${statusColor}; font-weight: 600;">${statusText}</div>
                    </div>`;
                
                content += '</div>';
                
                // Add linked property/well section as collapsible (same as above)
                if (doc.property_id || doc.well_id) {
                    const sectionId = 'linked-items-no-data';
                    const isExpanded = true; // Show expanded by default for linked items
                    
                    content += '<div class="detail-section">';
                    content += `<h4 class="detail-section-title collapsible ${isExpanded ? 'expanded' : ''}" onclick="toggleSection('${sectionId}')" data-section="${sectionId}">`;
                    content += `<span class="section-chevron">&#9654;</span> Linked Items`;
                    content += '</h4>';
                    content += `<div class="doc-detail-grid" id="${sectionId}" style="display: ${isExpanded ? 'grid' : 'none'};">`;
                    
                    if (doc.property_name && doc.property_id) {
                        content += `
                            <div class="doc-field">
                                <label>Property</label>
                                <div class="doc-value" style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #1E40AF; font-weight: 500;">${escapeHtml(doc.property_name)}</span>
                                    <button onclick="console.log('Button clicked for property:', '${doc.property_id}'); openPropertyFromDocument('${doc.property_id}')" 
                                            style="background: #1D6F5C; color: white; border: none; padding: 4px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap;">
                                        View 
                                    </button>
                                </div>
                            </div>`;
                    }
                    
                    if (doc.well_name && doc.well_id) {
                        content += `
                            <div class="doc-field">
                                <label>Well</label>
                                <div class="doc-value" style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span style="color: #1E40AF; font-weight: 500;">${escapeHtml(doc.well_name)}</span>
                                        ${doc.well_api_number ? `<span style="color: #6B7280; font-size: 13px; margin-left: 8px;">(${escapeHtml(doc.well_api_number)})</span>` : ''}
                                    </div>
                                    <button onclick="openWellFromDocument('${doc.well_id}')" 
                                            style="background: #1D6F5C; color: white; border: none; padding: 4px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap;">
                                        View 
                                    </button>
                                </div>
                            </div>`;
                    }
                    
                    content += '</div></div>';
                }
                
                content += '<div class="detail-section" style="text-align: center; padding: 40px 20px; background: #F9FAFB; border-radius: 8px; margin: 20px 0;">';
                content += '<svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 16px; opacity: 0.3;">';
                content += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>';
                content += '</svg>';
                content += '<p style="color: var(--slate-blue); font-weight: 500;">Document is being processed</p>';
                content += '<p style="color: var(--slate-blue); font-size: 13px;">Data extraction will be available soon</p>';
                content += '</div>';
                
                // User Notes - always show
                content += '<div class="detail-section">';
                content += '<h4 class="detail-section-title">Notes</h4>';
                content += `<textarea id="userNotesTextarea" onchange="enableSaveButton()" oninput="enableSaveButton()" style="width: 100%; min-height: 100px; padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 6px; font-size: 14px; line-height: 1.5; resize: vertical; font-family: inherit;" placeholder="Add your notes here...">${escapeHtml(doc.user_notes || '')}</textarea>`;
                content += '</div>';
            }
            
            // Add some CSS for the detail sections
            if (!document.getElementById('documentDetailStyles')) {
                const style = document.createElement('style');
                style.id = 'documentDetailStyles';
                style.textContent = `
                    /* Document details styles v2 */
                    .doc-detail-grid {
                        display: grid;
                        gap: 16px;
                        margin-bottom: 24px;
                    }
                    .doc-field {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 0;
                        border-bottom: 1px solid #E5E7EB;
                    }
                    .doc-field:last-child {
                        border-bottom: none;
                    }
                    .doc-field label {
                        font-size: 14px;
                        font-weight: 500;
                        color: #6B7280;
                        flex: 0 0 140px;
                    }
                    .doc-value {
                        font-size: 14px;
                        color: #111827;
                        text-align: right;
                        flex: 1;
                    }
                    .detail-section {
                        margin-bottom: 24px;
                    }
                    .detail-section:last-child {
                        margin-bottom: 0;
                    }
                    .detail-section-title {
                        margin: 0 0 16px;
                        font-size: 16px;
                        font-weight: 600;
                        color: #111827;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .detail-section-title.collapsible {
                        cursor: pointer;
                        user-select: none;
                        transition: color 0.2s;
                    }
                    .detail-section-title.collapsible:hover {
                        color: #1D6F5C;
                    }
                    .section-chevron {
                        font-size: 12px;
                        color: #6B7280;
                        transition: transform 0.2s;
                    }
                    .detail-section-title.expanded .section-chevron {
                        transform: rotate(90deg);
                    }
                    /* Hide default details marker across browsers */
                    summary::-webkit-details-marker {
                        display: none;
                    }
                    summary::marker {
                        display: none;
                        content: '';
                    }
                    details summary {
                        list-style: none;
                    }

                    /* Custom chevron rotation */
                    .details-chevron {
                        display: inline-block;
                        font-size: 10px;
                        transition: transform 0.2s ease;
                    }
                    details[open] .details-chevron {
                        transform: rotate(90deg);
                    }

                    /* Key Takeaway styling (green, matches Detailed Analysis structure) */
                    .key-takeaway-block {
                        background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
                        border: 2px solid #22C55E;
                        border-radius: 10px;
                        overflow: hidden;
                        transition: all 0.2s ease;
                    }
                    .key-takeaway-block:hover {
                        border-color: #16A34A;
                        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
                    }
                    .key-takeaway-trigger {
                        padding: 14px 18px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        background: transparent;
                        user-select: none;
                    }
                    .key-takeaway-trigger:hover {
                        background: rgba(34, 197, 94, 0.1);
                    }
                    .key-takeaway-trigger .details-chevron {
                        font-size: 12px;
                        color: #22C55E;
                        transition: transform 0.2s ease;
                    }
                    .key-takeaway-label {
                        font-weight: 600;
                        color: #166534;
                        font-size: 14px;
                    }
                    .key-takeaway-content {
                        white-space: pre-wrap;
                        line-height: 1.7;
                        padding: 16px 18px;
                        border-top: 1px solid #BBF7D0;
                        background: white;
                        color: #166534;
                        font-size: 14px;
                    }

                    /* Detailed Analysis prominent styling */
                    .detailed-analysis-block {
                        background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
                        border: 2px solid #3B82F6;
                        border-radius: 10px;
                        overflow: hidden;
                        transition: all 0.2s ease;
                    }
                    .detailed-analysis-block:hover {
                        border-color: #2563EB;
                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
                    }
                    .detailed-analysis-trigger {
                        padding: 14px 18px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        background: transparent;
                        user-select: none;
                    }
                    .detailed-analysis-trigger:hover {
                        background: rgba(59, 130, 246, 0.1);
                    }
                    .detailed-analysis-trigger .details-chevron {
                        font-size: 12px;
                        color: #3B82F6;
                        transition: transform 0.2s ease;
                    }
                    .detailed-analysis-label {
                        font-weight: 600;
                        color: #1E40AF;
                        font-size: 14px;
                    }
                    .detailed-analysis-hint {
                        font-size: 12px;
                        color: #6B7280;
                        margin-left: auto;
                        opacity: 0.8;
                    }
                    .detailed-analysis-block[open] .detailed-analysis-hint {
                        display: none;
                    }
                    .detailed-analysis-content {
                        white-space: pre-wrap;
                        line-height: 1.7;
                        padding: 16px 18px;
                        border-top: 1px solid #BFDBFE;
                        background: white;
                        color: #334155;
                        font-size: 14px;
                    }
                    .detail-row {
                        margin-bottom: 8px;
                        font-size: 14px;
                        line-height: 1.5;
                    }
                    .detail-row:last-child {
                        margin-bottom: 0;
                    }
                    .detail-row strong {
                        display: inline-block;
                        min-width: 120px;
                        color: #6B7280;
                    }
                    .detail-row span {
                        color: #111827;
                    }
                    
                    /* Confidence indicator styles */
                    .document-detail-modal .confidence-indicator {
                        margin-left: 0.5rem;
                        font-size: 1rem;
                        display: none; /* Hidden by default */
                    }
                    .confidence-indicator.confidence-high { color: #10b981; }
                    .confidence-indicator.confidence-medium { color: #f59e0b; }
                    .confidence-indicator.confidence-low { color: #ef4444; }
                    
                    /* Hide percentages by default */
                    .confidence-percentage {
                        display: none;
                    }
                    
                    /* Show confidence indicators when details are expanded */
                    .document-detail-modal.confidence-visible .confidence-indicator {
                        display: inline;
                    }
                    
                    /* Show percentages when details are expanded */
                    .document-detail-modal.confidence-visible .confidence-percentage {
                        display: inline;
                    }
                    
                    /* Confidence section styles */
                    .confidence-section {
                        background-color: #f9fafb;
                        padding: 1rem;
                        border-radius: 0.5rem;
                        margin-top: 1.5rem;
                        margin-bottom: 1.5rem;
                    }
                    
                    .confidence-summary {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    }
                    
                    .confidence-info {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    }
                    
                    .confidence-badge {
                        display: inline-flex;
                        align-items: center;
                        gap: 0.25rem;
                        font-weight: 500;
                    }
                    
                    .confidence-badge.high { color: #10b981; }
                    .confidence-badge.medium { color: #f59e0b; }
                    .confidence-badge.low { color: #ef4444; }
                    
                    .confidence-toggle {
                        background: none;
                        border: none;
                        color: #3b82f6;
                        cursor: pointer;
                        font-size: 0.875rem;
                        padding: 0.25rem 0.5rem;
                        text-decoration: underline;
                        transition: color 0.2s;
                    }
                    
                    .confidence-toggle:hover {
                        color: #2563eb;
                    }
                    
                    .confidence-details {
                        margin-top: 1rem;
                        padding-top: 1rem;
                        border-top: 1px solid #e5e7eb;
                    }
                    
                    .confidence-details.hidden {
                        display: none;
                    }
                    
                    .confidence-details-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 0.75rem;
                    }
                    
                    .confidence-field-item {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 0.5rem;
                        background-color: white;
                        border-radius: 0.25rem;
                        border: 1px solid #e5e7eb;
                        font-size: 0.875rem;
                    }
                    
                    .confidence-field-name {
                        font-weight: 500;
                        color: #4b5563;
                        text-transform: capitalize;
                    }
                    
                    .confidence-field-score {
                        display: flex;
                        align-items: center;
                        gap: 0.25rem;
                        font-weight: 600;
                    }
                    
                    .confidence-field-score.high { color: #10b981; }
                    .confidence-field-score.medium { color: #f59e0b; }
                    .confidence-field-score.low { color: #ef4444; }
                    
                    #documentDetailModal .modal {
                        border: none;
                    }
                    #viewOriginalBtn:hover {
                        background: #155347 !important;
                    }
                    
                    /* 
                     * Full-bleed modal pattern (edge-to-edge header, scrollable body, fixed footer)
                     * Currently used on: Document details
                     * TODO: Apply to Properties and Wells detail modals for consistency
                     * 
                     * Usage: Apply these classes to any detail modal:
                     * - .detail-modal on the modal container (with padding: 0)
                     * - .detail-modal-header on the header section
                     * - .detail-modal-body on the scrollable content area
                     * - .detail-modal-footer on the fixed footer section
                     */
                    .detail-modal {
                        padding: 0 !important;
                        display: flex !important;
                        flex-direction: column !important;
                        overflow: hidden !important;
                    }
                    
                    .detail-modal-header {
                        flex-shrink: 0 !important;
                        /* Header styling should be applied inline for different colors */
                    }
                    
                    .detail-modal-body {
                        flex: 1 !important;
                        overflow-y: auto !important;
                        -webkit-overflow-scrolling: touch !important;
                        min-height: 0 !important;
                    }
                    
                    .detail-modal-footer {
                        flex-shrink: 0 !important;
                        background: white !important;
                        border-top: 1px solid #e5e7eb !important;
                    }
                    
                    /* Mobile-specific fixes for document detail modal */
                    @media (max-width: 768px) {
                        #documentDetailModal {
                            align-items: center !important;
                            justify-content: center !important;
                            padding: 0 !important;
                        }
                        #documentDetailModal .modal {
                            max-height: calc(100vh - 16px) !important;
                            max-height: calc(100dvh - 16px) !important; /* Use dvh for better mobile support */
                            margin: 8px !important;
                            width: calc(100vw - 16px) !important;
                            position: relative !important;
                        }
                        /* Tighter padding on mobile */
                        #documentDetailModal .modal-header {
                            padding: 16px 20px !important;
                        }
                        #documentDetailModal .modal-body {
                            padding: 16px 20px !important;
                        }
                        #documentDetailModal .modal-footer {
                            padding: 12px 16px !important;
                        }
                        #documentDetailModal button {
                            padding: 8px 12px;
                            font-size: 14px;
                        }
                        /* Make header text smaller on mobile */
                        #documentModalTitle {
                            font-size: 18px !important;
                        }
                        #documentModalSubtitle {
                            font-size: 13px !important;
                        }
                        /* Stack footer buttons on very small screens */
                        @media (max-width: 480px) {
                            #documentDetailModal .modal-footer {
                                flex-direction: column;
                                align-items: stretch;
                                gap: 8px !important;
                            }
                            #documentDetailModal .modal-footer > * {
                                width: 100%;
                            }
                            #documentDetailModal .modal-footer button {
                                justify-content: center;
                            }
                        }
                    }
                    
                    /* Confidence indicators */
                    .confidence-high {
                        color: #22c55e;
                        margin-left: 8px;
                        font-weight: 600;
                    }
                    .confidence-medium {
                        color: #f59e0b;
                        margin-left: 8px;
                        font-weight: 600;
                    }
                    .confidence-low {
                        color: #ef4444;
                        margin-left: 8px;
                        font-weight: 600;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Update modal content and show
            document.getElementById('documentDetailContent').innerHTML = content;
            const detailModal = document.getElementById('documentDetailModal');
            
            // Calculate z-index based on stack depth BEFORE adding to stack
            const baseZIndex = 999999;
            const newZIndex = baseZIndex + (modalStack.length * 10);
            
            detailModal.style.display = 'flex';
            detailModal.style.zIndex = String(newZIndex);
            
            // Add to modal stack if not already there
            if (!modalStack.find(m => m.element === detailModal)) {
                modalStack.push({ type: 'document', id: docId, element: detailModal });
            }
            
            // Initialize notes tracking after modal is shown
            originalNotes = doc.user_notes || '';
            hasNotesChanged = false;
            const saveBtn = document.getElementById('saveDocNotesBtn');
            if (saveBtn) {
                saveBtn.style.display = 'none';
            }
            } catch (error) {
                console.error('Error loading document details:', error);
                alert('Failed to load document details');
            }
        }

        function closeDocumentDetailModal() {
            const modal = document.getElementById('documentDetailModal');
            modal.style.display = 'none';
            modal.style.zIndex = '';  // Reset z-index
            currentDocumentId = null;
            
            // Remove from modal stack
            const index = modalStack.findIndex(m => m.element === modal);
            if (index > -1) {
                modalStack.splice(index, 1);
            }
        }

        function viewDocumentPDF() {
            if (currentDocumentId) {
                viewDocumentInModal(currentDocumentId, currentDocumentFilename || '', true, currentDocumentContentType || 'application/pdf', currentDocumentRotation || 0);
                // Don't close the detail modal - keep it in the background
            }
        }

        function calculateMineralAcres(interest, acres) {
            // Parse interest fraction
            const interestLower = interest.toLowerCase();
            let fraction = null;
            
            // Try to extract fraction
            if (interestLower.includes('1/8') || interestLower.includes('one-eighth')) {
                fraction = 1/8;
            } else if (interestLower.includes('1/4') || interestLower.includes('one-fourth')) {
                fraction = 1/4;
            } else if (interestLower.includes('1/2') || interestLower.includes('one-half')) {
                fraction = 1/2;
            } else if (interestLower.includes('3/4') || interestLower.includes('three-fourths')) {
                fraction = 3/4;
            } else if (interestLower.includes('1/16')) {
                fraction = 1/16;
            } else if (interestLower.includes('1/32')) {
                fraction = 1/32;
            } else if (interestLower.includes('1/64')) {
                fraction = 1/64;
            }
            
            if (fraction && acres) {
                const acresNum = parseFloat(acres);
                if (!isNaN(acresNum)) {
                    return (acresNum * fraction).toFixed(2);
                }
            }
            
            return null;
        }

        // Document notes tracking
        let originalNotes = '';
        let hasNotesChanged = false;

        function enableSaveButton() {
            const textarea = document.getElementById('userNotesTextarea');
            const saveBtn = document.getElementById('saveDocNotesBtn');
            if (textarea && saveBtn) {
                hasNotesChanged = textarea.value !== originalNotes;
                saveBtn.style.display = hasNotesChanged ? 'block' : 'none';
                console.log('Notes changed:', hasNotesChanged, 'Original:', originalNotes, 'Current:', textarea.value);
            } else {
                console.log('Could not find textarea or save button');
            }
        }

        function toggleObservations() {
            const textDiv = document.getElementById('observationsText');
            const toggleBtn = document.getElementById('observationsToggle');
            
            if (textDiv && toggleBtn) {
                const isExpanded = toggleBtn.textContent.includes('less');
                
                if (isExpanded) {
                    textDiv.textContent = textDiv.getAttribute('data-truncated');
                    toggleBtn.innerHTML = 'Show more ';
                } else {
                    textDiv.textContent = textDiv.getAttribute('data-full');
                    toggleBtn.innerHTML = 'Show less ';
                }
            }
        }

        async function saveAndCloseDocumentNotes() {
            if (!currentDocumentId || !hasNotesChanged) {
                closeDocumentDetailModal();
                return;
            }
            
            const textarea = document.getElementById('userNotesTextarea');
            const notes = textarea.value;
            
            try {
                const response = await fetch(`/api/documents/${currentDocumentId}/notes`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notes }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    // Update the document in our loaded array
                    const doc = loadedDocuments.find(d => d.id === currentDocumentId);
                    if (doc) {
                        doc.user_notes = notes;
                    }
                    
                    closeDocumentDetailModal();
                    // Optionally show a success message
                } else {
                    const error = await response.json();
                    alert('Failed to save notes: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving notes:', error);
                alert('Failed to save notes. Please try again.');
            }
        }


        // Open property from document modal - stack on top
        function openPropertyFromDocument(propertyId) {
            console.log('[openPropertyFromDocument] Called with propertyId:', propertyId);
            console.log('[openPropertyFromDocument] Current modal stack length:', modalStack.length);
            console.log('[openPropertyFromDocument] Modal stack:', modalStack.map(m => ({ type: m.type, id: m.id })));
            
            // Check if we've hit max depth
            if (modalStack.length >= MAX_MODAL_DEPTH) {
                console.log('[openPropertyFromDocument] Max depth reached, closing document modal first');
                // Close the document modal to make room
                closeDocumentDetailModal();
                // Give it time to close before opening property
                setTimeout(async () => {
                    await openPropertyDetails(propertyId);
                }, 100);
                return;
            }
            
            // Don't close the document modal - open property on top
            console.log('[openPropertyFromDocument] Opening property modal on top of document modal');
            setTimeout(async () => {
                await openPropertyDetails(propertyId);
            }, 50);
        }
        
        // Open well from document modal - stack on top
        function openWellFromDocument(wellId) {
            console.log('[openWellFromDocument] Called with wellId:', wellId);
            console.log('[openWellFromDocument] Current modal stack length:', modalStack.length);
            console.log('[openWellFromDocument] Modal stack:', modalStack.map(m => ({ type: m.type, id: m.id })));
            
            // Check if we've hit max depth
            if (modalStack.length >= MAX_MODAL_DEPTH) {
                console.log('[openWellFromDocument] Max depth reached, closing document modal first');
                // Close the document modal to make room
                closeDocumentDetailModal();
                // Give it time to close before opening well
                setTimeout(async () => {
                    await openWellDetailsModal(wellId);
                }, 100);
                return;
            }
            
            // Don't close the document modal - open well on top
            console.log('[openWellFromDocument] Opening well modal on top of document modal');
            setTimeout(async () => {
                await openWellDetailsModal(wellId);
            }, 50);
        }
        
        // Make functions available globally
        window.viewDocumentInModal = viewDocumentInModal;
        window.closeDocumentViewer = closeDocumentViewer;
        window.downloadCurrentDocument = downloadCurrentDocument;
        window.downloadDocument = downloadDocument;
        window.openDocumentDetail = openDocumentDetail;
        window.closeDocumentDetailModal = closeDocumentDetailModal;
        window.viewDocumentPDF = viewDocumentPDF;
        window.formatDocType = formatDocType;
        window.getConfidenceIndicator = getConfidenceIndicator;
        window.enableSaveButton = enableSaveButton;
        window.toggleObservations = toggleObservations;
        window.saveAndCloseDocumentNotes = saveAndCloseDocumentNotes;
        window.toggleSection = toggleSection;
        window.toggleConfidenceDetails = toggleConfidenceDetails;
        window.openPropertyFromDocument = openPropertyFromDocument;
        window.openWellFromDocument = openWellFromDocument;
        window.openWellFromProperty = openWellFromProperty;
        window.openPropertyFromWell = openPropertyFromWell;
        
        // Load Documents
        let documentPollInterval;
        let documentPollStartTime;
        let uploadBatchTimer;
        const POLL_INTERVAL = 15000; // 15 seconds
        const MAX_POLL_DURATION = 5 * 60 * 1000; // 5 minutes
        
        // Document Usage Tracking
        let currentUsageStats = null;
        
        async function loadUsageStats() {
            try {
                const response = await fetch('/api/documents/usage');
                if (!response.ok) throw new Error('Failed to load usage stats');
                
                const data = await response.json();
                displayUsageStats(data);
            } catch (error) {
                console.error('Error loading usage stats:', error);
                // Don't show the tracker if we can't load stats
                document.getElementById('documentUsageTracker').style.display = 'none';
            }
        }
        
        function displayUsageStats(data) {
            currentUsageStats = data;
            const { usage, plan, credits } = data;
            const isLifetimeTier = usage.is_lifetime_tier;

            // Update the main credit display
            document.getElementById('creditsAvailable').textContent = usage.total_available || 0;

            // Update usage text based on tier type
            const usageText = document.getElementById('creditsUsedThisMonth');
            if (isLifetimeTier) {
                // Free tier: show lifetime usage
                usageText.parentElement.innerHTML = `(<span id="creditsUsedThisMonth">${usage.credits_used || 0}</span> of ${(usage.credits_used || 0) + (usage.total_available || 0)} lifetime)`;
            } else {
                // Paid tier: show monthly usage
                usageText.textContent = usage.credits_used || 0;
            }

            // Update progress bar
            let percentage;
            if (isLifetimeTier) {
                // Free tier: show lifetime usage percentage
                const totalLifetime = (usage.credits_used || 0) + (usage.total_available || 0);
                percentage = totalLifetime > 0 ? Math.min(100, ((usage.credits_used || 0) / totalLifetime) * 100) : 0;
            } else {
                // Paid tier: show monthly usage percentage
                percentage = usage.monthly_limit > 0 ? Math.min(100, (usage.credits_used / usage.monthly_limit) * 100) : 0;
            }
            const progressFill = document.getElementById('creditProgressFill');
            progressFill.style.width = percentage + '%';

            // Update progress bar color based on remaining credits
            progressFill.classList.remove('warning', 'danger');
            const totalAvailable = usage.total_available || 0;
            const monthlyLimit = usage.monthly_limit || 1;
            const remainingPct = isLifetimeTier ? (totalAvailable / 10 * 100) : (totalAvailable / monthlyLimit * 100);

            if (remainingPct <= 10 || totalAvailable === 0) {
                progressFill.classList.add('danger');
            } else if (remainingPct <= 20) {
                progressFill.classList.add('warning');
            }

            // Format reset date
            const resetDate = new Date(usage.reset_date);
            const resetDateStr = resetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            // Update reset date display (hide for lifetime tier)
            const resetElement = document.getElementById('creditResetDate');
            if (isLifetimeTier) {
                resetElement.parentElement.innerHTML = 'Lifetime credits';
            } else {
                document.getElementById('creditResetDate').textContent = resetDateStr;
            }

            // Update tooltip content
            if (isLifetimeTier) {
                // Free tier tooltip
                document.getElementById('tooltipMonthlyUsed').textContent = usage.credits_used || 0;
                document.getElementById('tooltipMonthlyLimit').textContent = (usage.credits_used || 0) + (usage.total_available || 0);
                document.getElementById('tooltipResetDate').textContent = 'never';
                document.getElementById('tooltipBonusRow').style.display = 'none';
                document.getElementById('tooltipPurchasedRow').style.display = 'none';

                // Free tier can still have purchased credits
                const purchasedCreditsFree = usage.purchased_credits || 0;
                if (purchasedCreditsFree > 0) {
                    document.getElementById('tooltipPurchasedRow').style.display = 'flex';
                    document.getElementById('tooltipPurchasedRemaining').textContent = purchasedCreditsFree;
                }
            } else {
                // Paid tier tooltip
                document.getElementById('tooltipMonthlyUsed').textContent = usage.monthly_remaining || 0;
                document.getElementById('tooltipMonthlyLimit').textContent = usage.monthly_limit || 0;
                document.getElementById('tooltipResetDate').textContent = resetDateStr;

                // Show purchased credits row
                const purchasedCredits = usage.purchased_credits || 0;
                if (purchasedCredits > 0) {
                    document.getElementById('tooltipPurchasedRow').style.display = 'flex';
                    document.getElementById('tooltipPurchasedRemaining').textContent = purchasedCredits;
                } else {
                    document.getElementById('tooltipPurchasedRow').style.display = 'none';
                }

                // Show bonus/permanent credits row
                const permanentCredits = usage.permanent_credits || 0;
                if (permanentCredits > 0) {
                    document.getElementById('tooltipBonusRow').style.display = 'flex';
                    document.getElementById('tooltipBonusRemaining').textContent = permanentCredits;
                } else {
                    document.getElementById('tooltipBonusRow').style.display = 'none';
                }
            }

            // Update total in tooltip
            document.getElementById('tooltipTotalAvailable').textContent = usage.total_available || 0;

            // Show low credit warning if below 20% or out of credits
            showLowCreditWarning(usage, isLifetimeTier);

            // Document count will be updated by loadDocuments() to show actual inventory
        }

        function showLowCreditWarning(usage, isLifetimeTier) {
            const warningBanner = document.getElementById('lowCreditWarning');
            if (!warningBanner) return;

            const totalAvailable = usage.total_available || 0;
            const monthlyLimit = usage.monthly_limit || 1;

            // Calculate remaining percentage
            let remainingPct;
            if (isLifetimeTier) {
                const totalLifetime = (usage.credits_used || 0) + totalAvailable;
                remainingPct = totalLifetime > 0 ? (totalAvailable / totalLifetime * 100) : 0;
            } else {
                remainingPct = (totalAvailable / monthlyLimit * 100);
            }

            // Show warning if out of credits
            if (totalAvailable === 0) {
                warningBanner.style.display = 'block';
                warningBanner.className = 'credit-warning-banner danger';
                warningBanner.innerHTML = `
                    <span class="warning-icon"></span>
                    <span class="warning-text">You're out of credits. Documents won't be processed until you have credits available.</span>
                    <a href="#" onclick="openCreditPackModal(); return false;" class="warning-action">Buy More Credits</a>
                `;
            } else if (remainingPct <= 20) {
                // Show warning if below 20%
                warningBanner.style.display = 'block';
                warningBanner.className = 'credit-warning-banner warning';
                warningBanner.innerHTML = `
                    <span class="warning-icon"></span>
                    <span class="warning-text">Low credits: ${totalAvailable} remaining${isLifetimeTier ? '' : ' this month'}.</span>
                    <a href="#" onclick="openCreditPackModal(); return false;" class="warning-action">Buy More</a>
                `;
            } else {
                warningBanner.style.display = 'none';
            }
        }
        
        function refreshUsageStats() {
            loadUsageStats();
        }
        
        // Auto-update usage after document processing
        function incrementLocalUsageCount() {
            if (currentUsageStats) {
                currentUsageStats.usage.docs_processed++;
                displayUsageStats(currentUsageStats);
            }
        }
        
        async function loadDocuments() {
            try {
                const res = await fetch('/api/documents');
                if (!res.ok) throw new Error('Failed to load documents');
                
                const data = await res.json();
                
                // Update total document count in the header
                const totalDocs = data.documents.filter(doc => !doc.deleted_at).length;
                if (document.getElementById('docCount')) {
                    document.getElementById('docCount').textContent = totalDocs;
                }
                
                // Check if any documents changed status
                const prevProcessing = loadedDocuments.filter(doc => 
                    doc.status === 'processing' || doc.status === 'pending'
                );
                
                const nowComplete = data.documents.filter(doc => {
                    const wasProcessing = prevProcessing.find(p => p.id === doc.id);
                    return wasProcessing && doc.status === 'complete';
                });
                
                // Show toast if documents completed
                if (nowComplete.length > 0) {
                    const message = nowComplete.length === 1
                        ? '1 document finished processing'
                        : `${nowComplete.length} documents finished processing`;
                    showToast(message, 'success');

                    // Refresh credit display after processing completes
                    loadUsageStats();
                }

                renderDocumentsList(data.documents);
                
                // Start or stop polling based on document status
                updateDocumentPolling();
                
            } catch (error) {
                console.error('Error loading documents:', error);
                document.getElementById('documentsContent').innerHTML = `
                    <div class="empty-state">
                        <p>Error loading documents</p>
                        <p style="font-size: 13px; color: var(--slate-blue);">${error.message}</p>
                    </div>
                `;
            }
        }

        // Re-link unlinked documents to properties/wells
        async function relinkDocuments() {
            const btn = document.getElementById('relinkDocumentsBtn');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = `
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="spin">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Scanning...
                `;

                const res = await fetch('/api/documents/relink', { method: 'POST' });
                if (!res.ok) throw new Error('Failed to re-link documents');

                const result = await res.json();
                console.log('[Documents] Re-link result:', result);

                if (result.linked > 0) {
                    showToast(`Linked ${result.linked} document${result.linked > 1 ? 's' : ''} to properties/wells`, 'success');
                    // Reload documents to show updated links
                    await loadDocuments();
                } else if (result.total === 0) {
                    showToast('All documents are already linked', 'info');
                } else {
                    showToast('No new links found - documents may not match any properties', 'info');
                }

                // Update button visibility
                updateRelinkButtonVisibility();

            } catch (error) {
                console.error('Error re-linking documents:', error);
                showToast('Failed to re-link documents', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Show/hide re-link button based on unlinked document count
        function updateRelinkButtonVisibility() {
            const btn = document.getElementById('relinkDocumentsBtn');
            if (!btn) return;

            const unlinkedCount = loadedDocuments.filter(doc =>
                !doc.deleted_at &&
                doc.status === 'completed' &&
                !doc.property_id &&
                !doc.well_id
            ).length;

            btn.style.display = unlinkedCount > 0 ? 'inline-flex' : 'none';
            if (unlinkedCount > 0) {
                btn.title = `Re-scan ${unlinkedCount} unlinked document${unlinkedCount > 1 ? 's' : ''} for property/well matches`;
            }
        }

        // Make relinkDocuments available globally
        window.relinkDocuments = relinkDocuments;

        // Manual document linking modal functions
        function openManualDocLinkModal(targetType, targetId) {
            console.log('[ManualLink] Opening modal for', targetType, targetId);

            // Store target info
            document.getElementById('manualDocLinkTargetType').value = targetType;
            document.getElementById('manualDocLinkTargetId').value = targetId;

            // Update subtitle
            const subtitle = document.getElementById('manualDocLinkSubtitle');
            subtitle.textContent = `Select a document to link to this ${targetType}`;

            // Get unlinked documents from loadedDocuments
            const unlinkedDocs = loadedDocuments.filter(doc =>
                !doc.deleted_at &&
                doc.status === 'completed' &&
                !doc.property_id &&
                !doc.well_id
            );

            const listEl = document.getElementById('manualDocLinkList');
            const emptyEl = document.getElementById('manualDocLinkEmpty');

            if (unlinkedDocs.length === 0) {
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
            } else {
                listEl.style.display = 'block';
                emptyEl.style.display = 'none';

                // Build list of documents
                let html = '';
                unlinkedDocs.forEach(doc => {
                    const category = doc.parsedExtractedData?.documentCategory || doc.category || 'Unknown';
                    const uploadDate = new Date(doc.upload_date).toLocaleDateString('en-US', { timeZone: 'America/Chicago' });

                    html += `
                        <div class="manual-link-doc-item" onclick="linkDocumentToTarget('${doc.id}')" style="padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 500; color: var(--oil-navy); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${doc.filename}</div>
                                    <div style="font-size: 12px; color: var(--slate-blue); margin-top: 2px;">
                                        ${category} &bull; ${uploadDate}
                                    </div>
                                </div>
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0; margin-left: 12px; color: var(--slate-blue);">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                </svg>
                            </div>
                        </div>
                    `;
                });
                listEl.innerHTML = html;
            }

            // Show modal
            const modal = document.getElementById('manualDocLinkModal');
            modal.style.cssText = 'display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 1000001 !important; background: rgba(0,0,0,0.5) !important; align-items: center !important; justify-content: center !important;';
        }

        function closeManualDocLinkModal() {
            document.getElementById('manualDocLinkModal').style.display = 'none';
        }

        async function linkDocumentToTarget(documentId) {
            const targetType = document.getElementById('manualDocLinkTargetType').value;
            const targetId = document.getElementById('manualDocLinkTargetId').value;

            console.log('[ManualLink] Linking document', documentId, 'to', targetType, targetId);

            try {
                const body = {};
                if (targetType === 'property') {
                    body.property_id = targetId;
                } else if (targetType === 'well') {
                    body.well_id = targetId;
                }

                const res = await fetch(`/api/documents/${documentId}/link`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Failed to link document');
                }

                showToast('Document linked successfully', 'success');
                closeManualDocLinkModal();

                // Refresh documents and the linked documents list
                await loadDocuments();

                // Refresh the linked documents section in the modal
                if (targetType === 'property') {
                    loadLinkedDocuments(targetId, 'property');
                } else if (targetType === 'well') {
                    loadLinkedDocuments(targetId, 'well');
                }

            } catch (error) {
                console.error('[ManualLink] Error:', error);
                showToast(error.message || 'Failed to link document', 'error');
            }
        }

        // Make manual link functions globally available
        window.openManualDocLinkModal = openManualDocLinkModal;
        window.closeManualDocLinkModal = closeManualDocLinkModal;
        window.linkDocumentToTarget = linkDocumentToTarget;

        // Close manual doc link modal when clicking outside (deferred until DOM ready)
        document.addEventListener('DOMContentLoaded', () => {
            const manualDocModal = document.getElementById('manualDocLinkModal');
            if (manualDocModal) {
                manualDocModal.addEventListener('click', e => {
                    if (e.target.id === 'manualDocLinkModal') closeManualDocLinkModal();
                });
            }
        });

        function startDocumentPolling() {
            if (documentPollInterval) return; // Already polling
            
            console.log('[Documents] Starting polling for processing documents');
            documentPollStartTime = Date.now();
            
            documentPollInterval = setInterval(async () => {
                // Check guardrails
                const isDocumentsTabActive = currentTab === 'documents';
                const isTabVisible = !document.hidden;
                const hasProcessing = loadedDocuments.some(doc => 
                    doc.status === 'processing' || doc.status === 'pending'
                );
                const notExpired = (Date.now() - documentPollStartTime) < MAX_POLL_DURATION;
                
                if (isDocumentsTabActive && isTabVisible && hasProcessing && notExpired) {
                    console.log('[Documents] Polling for updates...');
                    await loadDocuments();
                } else {
                    console.log('[Documents] Stopping poll:', {
                        isDocumentsTabActive,
                        isTabVisible,
                        hasProcessing,
                        notExpired
                    });
                    stopDocumentPolling();
                }
            }, POLL_INTERVAL);
        }
        
        function stopDocumentPolling() {
            if (documentPollInterval) {
                console.log('[Documents] Stopping document polling');
                clearInterval(documentPollInterval);
                documentPollInterval = null;
                documentPollStartTime = null;
            }
        }
        
        function updateDocumentPolling() {
            const hasProcessing = loadedDocuments.some(doc => 
                doc.status === 'processing' || doc.status === 'pending'
            );
            
            if (hasProcessing && currentTab === 'documents' && !document.hidden) {
                startDocumentPolling();
            } else {
                stopDocumentPolling();
            }
        }
        
        // Debounced polling start for bulk uploads
        function onDocumentUploaded() {
            // Reset timer with each upload
            clearTimeout(uploadBatchTimer);
            
            // Start polling 3 seconds after the LAST upload completes
            uploadBatchTimer = setTimeout(() => {
                if (currentTab === 'documents') {
                    updateDocumentPolling();
                }
            }, 3000);
        }
        
        function renderDocumentsList(documents) {
            // Parse extracted_data JSON for each document if it exists
            if (documents && documents.length > 0) {
                documents = documents.map(doc => {
                    if (doc.extracted_data && typeof doc.extracted_data === 'string') {
                        try {
                            doc.parsedExtractedData = JSON.parse(doc.extracted_data);
                        } catch (e) {
                            console.log('Failed to parse extracted_data for doc', doc.id);
                            doc.parsedExtractedData = {};
                        }
                    } else {
                        doc.parsedExtractedData = doc.extracted_data || {};
                    }
                    return doc;
                });
            }
            
            loadedDocuments = documents;
            const container = document.getElementById('documentsContent');
            
            const hasSearch = currentUser?.plan !== 'Free';
            
            // Apply filter and sort
            let displayDocuments = documents;
            if (hasSearch && documents && documents.length > 0) {
                displayDocuments = filterDocuments(documents);
                displayDocuments = sortDocuments(displayDocuments);
                
                // Update results count
                const countEl = document.getElementById('documentsResultsCount');
                if (documentsSearchTerm || documentsCategory !== 'all') {
                    countEl.textContent = `${displayDocuments.length} of ${documents.length} documents`;
                } else {
                    countEl.textContent = `${documents.length} documents`;
                }
            }
            
            // Handle empty states
            if (!documents || documents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 60px 20px;">
                        <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 16px; opacity: 0.3;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p style="font-size: 18px; font-weight: 600; color: var(--oil-navy); margin-bottom: 8px;">No documents yet</p>
                        <p style="font-size: 14px; color: var(--slate-blue);">Click the "Upload Documents" button above to get started</p>
                    </div>
                `;
                return;
            }
            
            if (displayDocuments.length === 0 && documents.length > 0) {
                // No search results
                container.innerHTML = '<div class="empty-state"><p>No documents match your search or filter.</p></div>';
                return;
            }
            
            // Build table like properties/wells
            let html = '<table class="data-table"><thead><tr>';
            html += '<th class="bulk-only"><input type="checkbox" id="selectAllDocuments" title="Select all"></th>';
            html += '<th>Filename</th><th>Category</th><th>County</th><th>Status</th><th>Uploaded</th><th style="text-align: right;">Actions</th>';
            html += '</tr></thead><tbody>';
            
            displayDocuments.forEach(doc => {
                const uploadDate = new Date(doc.upload_date).toLocaleDateString('en-US', { timeZone: 'America/Chicago' });
                const statusColor = doc.status === 'complete' ? 'var(--success)' :
                                   doc.status === 'failed' ? 'var(--error)' :
                                   doc.status === 'manual_review' ? '#D97706' :
                                   '#F59E0B';
                const statusText = doc.status === 'complete' ? 'Complete' :
                                  doc.status === 'failed' ? 'Failed' :
                                  doc.status === 'manual_review' ? 'Needs Review' :
                                  doc.status === 'pending' ? 'Queued' :
                                  'Processing';
                
                // Add pulsing animation for processing documents
                const statusStyle = (doc.status === 'processing' || doc.status === 'pending') 
                    ? 'animation: pulse 1.5s ease-in-out infinite;' 
                    : '';
                
                html += `<tr onclick="openDocumentDetail('${doc.id}')" style="cursor: pointer;">`;
                html += `<td class="bulk-only" onclick="event.stopPropagation()"><input type="checkbox" class="document-checkbox" data-id="${doc.id}"></td>`;
                html += `<td><strong>${escapeHtml(doc.display_name || doc.filename)}</strong></td>`;
                html += `<td>${(doc.category || doc.doc_type) ? formatDocType(doc.category || doc.doc_type) : '<em style="color: #A0AEC0;"></em>'}</td>`;
                // Check doc.county first, then fall back to extracted_data.county
                const displayCounty = doc.county || doc.parsedExtractedData?.county;
                html += `<td>${displayCounty ? escapeHtml(displayCounty) : '<em style="color: #A0AEC0;"></em>'}</td>`;
                html += `<td><span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${statusColor}20; color: ${statusColor}; ${statusStyle}">${statusText}</span></td>`;
                html += `<td>${uploadDate}</td>`;
                html += `<td style="text-align: right;" onclick="event.stopPropagation()">
                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button onclick="viewDocumentInModal('${doc.id}', '${escapeHtml(doc.display_name || doc.filename)}', false, '${doc.content_type || 'application/pdf'}', ${doc.rotation_applied || 0})" title="View" class="btn-action-icon" style="background: #E0F2FE; color: #1E40AF;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                        <button onclick="downloadDocument('${doc.id}')" title="Download" class="btn-action-icon">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </button>
                    </div>
                </td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Add select all checkbox handler
            const selectAllCheckbox = document.getElementById('selectAllDocuments');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', (e) => {
                    selectAllItems('documents', e.target.checked);
                });
            }

            // Update re-link button visibility based on unlinked documents
            updateRelinkButtonVisibility();
        }

        async function searchWells() {
            const searchParams = {
                well_name: document.getElementById('searchWellName').value.trim(),
                operator: document.getElementById('searchOperator').value.trim(),
                section: document.getElementById('searchSection').value.trim(),
                township: document.getElementById('searchTownship').value.trim(),
                range: document.getElementById('searchRange').value.trim(),
                county: document.getElementById('searchCounty').value.trim()
            };
            
            // Check if at least one search field is filled
            const hasSearchCriteria = Object.values(searchParams).some(value => value !== '');
            if (!hasSearchCriteria) {
                showToast('Please enter at least one search criteria', 'error');
                return;
            }
            
            // Show loading state
            document.getElementById('searchLoading').style.display = 'block';
            document.getElementById('searchResults').style.display = 'none';
            
            try {
                // Build query parameters
                const queryParams = new URLSearchParams();
                Object.entries(searchParams).forEach(([key, value]) => {
                    if (value) queryParams.append(key, value);
                });
                
                const response = await fetch(`/api/wells/search?${queryParams.toString()}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Search failed');
                }
                
                const data = await response.json();
                displaySearchResults(data.data);
                
            } catch (error) {
                console.error('Search error:', error);
                showToast(`Search error: ${error.message}`, 'error');
                document.getElementById('searchResults').style.display = 'none';
            } finally {
                document.getElementById('searchLoading').style.display = 'none';
            }
        }
        
        function displaySearchResults(data) {
            const { wells, total, truncated, search_criteria } = data;
            
            // Update results info
            const resultsInfo = document.getElementById('resultsInfo');
            let infoText = `Found ${total} well${total !== 1 ? 's' : ''}`;
            if (truncated) {
                infoText += ` (showing first 25)`;
            }
            resultsInfo.textContent = infoText;
            
            // Clear previous results
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            
            if (wells.length === 0) {
                resultsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <h3 style="margin: 0 0 8px 0;">No wells found</h3>
                        <p style="margin: 0;">Try adjusting your search criteria</p>
                    </div>
                `;
            } else {
                wells.forEach(well => {
                    const resultItem = createResultItem(well);
                    resultsList.appendChild(resultItem);
                });
            }
            
            // Show results
            document.getElementById('searchResults').style.display = 'block';
        }
        
        function createResultItem(well) {
            const div = document.createElement('div');
            div.className = 'result-item';
            
            // Determine status class
            let statusClass = 'other';
            let statusText = well.well_status || 'Unknown';
            if (well.well_status === 'AC') {
                statusClass = 'active';
                statusText = 'Active';
            } else if (well.well_status === 'PA') {
                statusClass = 'plugged';
                statusText = 'Plugged';
            }
            
            const location = well.location;
            const production = well.production;
            
            div.innerHTML = `
                <div class="result-header">
                    <h4 class="result-well-name">${escapeHtml(well.well_name || 'Unnamed Well')}</h4>
                    <span class="result-status ${statusClass}">${statusText}</span>
                </div>
                <div class="result-details">
                    <div class="result-detail">
                        <strong>API:</strong> ${escapeHtml(well.api_number)}
                    </div>
                    <div class="result-detail">
                        <strong>Operator:</strong> ${escapeHtml(well.operator || 'Unknown')}
                    </div>
                    <div class="result-detail">
                        <strong>Location:</strong> S${location.section}-${location.township}-${location.range}-${location.meridian}
                    </div>
                    <div class="result-detail">
                        <strong>County:</strong> ${escapeHtml(location.county || 'Unknown')}
                    </div>
                    ${production.formation_name ? `
                        <div class="result-detail">
                            <strong>Formation:</strong> ${escapeHtml(production.formation_name)}
                        </div>
                    ` : ''}
                    ${production.ip_oil_bbl || production.ip_gas_mcf ? `
                        <div class="result-detail">
                            <strong>IP:</strong> ${production.ip_oil_bbl || 0} bbl/d, ${production.ip_gas_mcf || 0} mcf/d
                        </div>
                    ` : ''}
                </div>
                <button class="btn-select" onclick="selectWellFromSearch('${escapeHtml(well.api_number)}', '${escapeHtml(well.well_name || '')}')">
                    Select This Well
                </button>
            `;
            
            return div;
        }
        
        function selectWellFromSearch(apiNumber, wellName) {
            // Switch to API tab and populate the form
            switchTab('api-tab');
            
            // Fill in the API number
            document.getElementById('apiNumber').value = apiNumber;
            
            // Focus on the notes field for user convenience
            const notesField = document.getElementById('wellNotes');
            notesField.focus();
            
            // Clear search results
            clearWellSearch();
            
            showToast(`Selected well: ${wellName} (${apiNumber})`);
        }
        
        function clearWellSearch() {
            // Clear all search form fields
            document.getElementById('searchWellName').value = '';
            document.getElementById('searchOperator').value = '';
            document.getElementById('searchSection').value = '';
            document.getElementById('searchTownship').value = '';
            document.getElementById('searchRange').value = '';
            document.getElementById('searchCounty').value = '';
            
            // Hide search results and loading
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchLoading').style.display = 'none';
        }
        
        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Auto-search on input with debouncing
        document.addEventListener('DOMContentLoaded', function() {
            const searchInputs = [
                'searchWellName', 'searchOperator', 'searchSection', 
                'searchTownship', 'searchRange', 'searchCounty'
            ];
            
            searchInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', () => {
                        // Only auto-search if we have at least 2 characters or it's a section/location search
                        const value = input.value.trim();
                        const isLocationField = ['searchSection', 'searchTownship', 'searchRange'].includes(inputId);
                        
                        if (value.length >= 2 || (isLocationField && value.length >= 1)) {
                            debounceSearch(searchWells);
                        } else if (value.length === 0) {
                            // Clear results if input is cleared
                            document.getElementById('searchResults').style.display = 'none';
                        }
                    });
                }
            });
        });
        
        // Event listeners for wells have been moved to DOMContentLoaded
        

        async function trackWellFromActivity(apiNumber, wellName, occLink, buttonElement) {
            try {
                // Disable the button while processing
                buttonElement.disabled = true;
                buttonElement.textContent = 'Adding...';
                
                // Check if well is already tracked by checking current wells
                const isAlreadyTracked = loadedWells.some(w => w.fields['API Number'] === apiNumber);
                
                if (isAlreadyTracked) {
                    showToast('Already tracking this well', 'info');
                    buttonElement.textContent = 'Already Tracking';
                    return;
                }
                
                // Add the well with OCC Link
                const response = await fetch('/api/wells', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiNumber: apiNumber,
                        occLink: occLink // Pass the permit PDF URL
                    })
                });
                
                if (response.ok) {
                    showToast('Success, Well Added', 'success');
                    buttonElement.textContent = 'Added ';
                    buttonElement.style.background = '#22C55E';
                    buttonElement.style.color = 'white';
                    buttonElement.style.borderColor = '#22C55E';
                    
                    // Refresh wells list to include the new well
                    await loadWells();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to add well', 'error');
                    buttonElement.disabled = false;
                    buttonElement.textContent = '+ Track Well';
                }
            } catch (error) {
                console.error('Error tracking well:', error);
                showToast('Error adding well', 'error');
                buttonElement.disabled = false;
                buttonElement.textContent = '+ Track Well';
            }
        }
        
        // Store loaded data for details modals
        let loadedProperties = [];
        let loadedWells = [];
        
        // Expandable Row Functions
        async function openWellDetailsModal(wellId) {
            console.log('[openWellDetailsModal] Called with wellId:', wellId);
            
            // Reset linked counts and lists immediately to prevent concatenation issues
            const propsCountEl = document.getElementById('well-linked-properties-count');
            if (propsCountEl) {
                propsCountEl.textContent = '';
            }
            
            // Also clear the list content to show fresh loading state
            const propsListEl = document.getElementById('linked-properties-list');
            if (propsListEl) {
                propsListEl.innerHTML = '';
                propsListEl.style.display = 'none';
            }
            
            let well = loadedWells.find(w => w.id === wellId);
            
            // If not in loaded wells, fetch from API
            if (!well) {
                console.log('[openWellDetailsModal] Well not found in loadedWells:', wellId);
                console.log('[openWellDetailsModal] Fetching from API...');
                
                try {
                    // Fetch all wells and find the one we need
                    const res = await fetch('/api/wells');
                    if (!res.ok) throw new Error('Failed to fetch wells');
                    
                    const allWells = await res.json();
                    well = allWells.find(w => w.id === wellId);
                    
                    if (!well) {
                        console.error('[openWellDetailsModal] Well not found in API response');
                        alert('Well not found');
                        return;
                    }
                    
                    // Add to loaded wells for future use
                    loadedWells.push(well);
                    console.log('[openWellDetailsModal] Well fetched and added to cache');
                } catch (error) {
                    console.error('[openWellDetailsModal] Error fetching well:', error);
                    alert('Error loading well details');
                    return;
                }
            }
            
            const f = well.fields;
            
            // Helper function to format dates
            const formatDate = (dateStr) => {
                if (!dateStr) return null;
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'America/Chicago' });
                } catch {
                    return null;
                }
            };
            
            // Helper function to detect horizontal wells
            const isHorizontal = (wellName) => {
                if (!wellName) return false;
                const name = wellName.toLowerCase();
                return name.includes('h') && (name.endsWith('h') || name.endsWith('xh') || name.includes('wx'));
            };
            
            // Helper function to strip existing phone formatting
            const stripPhoneFormat = (phone) => {
                if (!phone) return '';
                return phone.replace(/[^0-9]/g, '');
            };
            
            // Populate header
            document.getElementById('wellDetailsTitle').textContent = f['Well Name'] || 'Unknown Well';
            document.getElementById('wellDetailsApi').textContent = `API: ${f['API Number'] || ''}`;
            
            // Store well ID
            document.getElementById('wellDetailsId').value = wellId;
            
            // Populate completion date in the body
            const completionDate = formatDate(f['Completion Date']);
            const firstProdDate = formatDate(f['First Production Date']);
            document.getElementById('wellDetailsCompletionDate').textContent = completionDate || '';
            
            // Status badge
            const status = f['Well Status'] || f['OCC Status'] || '';
            const statusBadge = document.getElementById('wellDetailsStatusBadge');
            statusBadge.textContent = status;
            statusBadge.className = status === 'Active' || status === 'AC' ? 'status-badge' : 'status-badge';
            
            // Well Type
            document.getElementById('wellDetailsType').textContent = f['Well Type'] || '';
            
            // Direction (Horizontal/Vertical)
            const direction = isHorizontal(f['Well Name']) ? 'Horizontal' : 'Vertical';
            const directionEl = document.getElementById('wellDetailsDirection');
            directionEl.textContent = direction;
            directionEl.className = direction === 'Horizontal' ? 'status-badge horizontal' : 'status-badge';
            
            // Operator
            document.getElementById('wellDetailsOperator').textContent = f['Operator'] || '';
            
            // Contact line - phone + contact person
            const rawPhone = f['Operator Phone'] || '';
            const contactPerson = f['Contact Name'] || f['Contact Person'] || '';
            const contactLine = document.getElementById('wellDetailsContact');
            const phoneLink = document.getElementById('wellDetailsPhoneLink');
            const contactPersonSpan = document.getElementById('wellDetailsContactPerson');
            
            if (rawPhone || contactPerson) {
                let contactHtml = '';
                
                if (rawPhone) {
                    const cleanPhone = stripPhoneFormat(rawPhone);
                    const formattedPhone = formatPhoneNumber(cleanPhone);
                    phoneLink.href = `tel:${cleanPhone}`;
                    phoneLink.textContent = formattedPhone;
                    phoneLink.style.display = 'inline';
                } else {
                    phoneLink.style.display = 'none';
                }
                
                if (contactPerson) {
                    contactPersonSpan.textContent = contactPerson;
                    contactPersonSpan.style.display = 'inline';
                } else {
                    contactPersonSpan.style.display = 'none';
                }
                
                // Show bullet separator if both exist
                if (rawPhone && contactPerson) {
                    contactLine.style.display = 'block';
                } else if (rawPhone || contactPerson) {
                    contactLine.style.display = 'block';
                } else {
                    contactLine.style.display = 'none';
                }
            } else {
                contactLine.style.display = 'none';
            }
            
            // Location
            const section = f['Section'] || '';
            const township = f['Township'] || '';
            const range = f['Range'] || '';
            const location = (section && township && range) ? `T${township} R${range} ${section}` : '';
            document.getElementById('wellDetailsLocation').textContent = location;
            
            // County
            document.getElementById('wellDetailsCounty').textContent = cleanCountyDisplay(f['County']) || '';
            
            // Production section - only show if any production data exists
            const ipGas = f['IP Gas (MCF/day)'];
            const ipOil = f['IP Oil (BBL/day)'];
            const formationName = f['Formation Name'];
            const formationDepth = f['Formation Depth'];
            
            const productionSection = document.getElementById('wellDetailsProduction');
            if (ipGas || ipOil || formationName || formationDepth) {
                // Show production section
                productionSection.style.display = 'block';
                
                // Formation badge
                document.getElementById('wellDetailsFormationBadge').textContent = formationName || 'Unknown';
                
                // IP Gas
                document.getElementById('wellDetailsIPGas').textContent = ipGas ? Number(ipGas).toLocaleString() : '';
                
                // IP Oil
                document.getElementById('wellDetailsIPOil').textContent = ipOil ? Number(ipOil).toLocaleString() : '';
                
                // Depth
                document.getElementById('wellDetailsDepth').textContent = formationDepth ? Number(formationDepth).toLocaleString() : '';
                
                // Dates
                document.getElementById('wellDetailsCompleted').textContent = completionDate || '';
                document.getElementById('wellDetailsFirstProd').textContent = firstProdDate || '';
            } else {
                productionSection.style.display = 'none';
            }
            
            // Notes
            document.getElementById('wellDetailsNotes').value = f['Notes'] || '';
            document.getElementById('wellDetailsOriginalNotes').value = f['Notes'] || '';
            
            // Links
            const mapLink = document.getElementById('wellDetailsMapLink');
            if (f['OCC Map Link'] && f['OCC Map Link'] !== '#') {
                mapLink.href = f['OCC Map Link'];
                mapLink.style.display = 'inline-flex';
            } else {
                mapLink.style.display = 'none';
            }
            
            // Well Records link - remove &cr=1 if present
            const recordsLink = document.getElementById('wellDetailsRecordsLink');
            if (f['API Number']) {
                const apiNumber = f['API Number'];
                const searchCommand = encodeURIComponent(`{[OG Well Records]:[API Number]="${apiNumber}*"}`);
                const recordsUrl = `https://public.occ.ok.gov/OGCDWellRecords/Search.aspx?searchcommand=${searchCommand}`;
                
                recordsLink.href = recordsUrl;
                recordsLink.style.display = 'inline-flex';
            } else {
                recordsLink.style.display = 'none';
            }
            
            // Store well ID for saving
            document.getElementById('wellDetailsId').value = wellId;
            
            // Don't try to show count from well data - just show loading state
            const propsCountElement = document.getElementById('well-linked-properties-count');
            // Already reset to '' at the start of this function
            
            // Always show loading state initially - the API will update with real data
            document.getElementById('linked-properties-list').innerHTML = '<div style="padding: 12px; color: #6b7280;">Loading properties...</div>';
            document.getElementById('linked-properties-list').style.display = 'block';
            document.getElementById('linked-properties-empty').style.display = 'none';
            
            // Show modal with forced high z-index like bulk modals
            const wellModal = document.getElementById('wellDetailsModal');
            
            // Nuclear option - move modal to end of body to escape any stacking context
            if (wellModal.parentNode !== document.body) {
                document.body.appendChild(wellModal);
            }
            
            // Calculate z-index based on stack depth BEFORE adding to stack
            const baseZIndex = 999999;
            const newZIndex = baseZIndex + (modalStack.length * 10);
            
            wellModal.style.cssText = `display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: ${newZIndex} !important; background: rgba(0,0,0,0.5) !important; align-items: center !important; justify-content: center !important; padding: 20px !important;`;
            
            // Add to modal stack if not already there (initial opening)
            if (!modalStack.find(m => m.element === wellModal)) {
                modalStack.push({ type: 'well', id: wellId, element: wellModal });
            }
            
            // Load linked properties and OCC filings after modal is shown
            setTimeout(() => {
                loadLinkedProperties(wellId);
                loadLinkedDocuments(wellId, 'well', f['API Number']);
                // Load OCC filings using section/township/range/meridian
                const wellSection = f['Section'];
                const wellTownship = f['Township'];
                const wellRange = f['Range'];
                const wellMeridian = f['Meridian'] || 'IM'; // Default to Indian Meridian
                if (wellSection && wellTownship && wellRange) {
                    loadOccFilings(wellSection, wellTownship, wellRange, 'well', wellMeridian);
                }
            }, 100);
            
            // Handle viewer permissions
            const isViewer = currentUser?.role === 'Viewer';
            if (isViewer) {
                document.getElementById('saveWellBtn').style.display = 'none';
                document.getElementById('wellDetailsNotes').readOnly = true;
                document.getElementById('wellDetailsNotes').style.backgroundColor = '#f5f5f5';
            } else {
                document.getElementById('wellDetailsNotes').readOnly = false;
                document.getElementById('wellDetailsNotes').style.backgroundColor = 'white';
                // Save button will be shown by toggleSaveButton when notes change
                toggleSaveButton('well');
            }
        }
        
        // Placeholder for Phase 2
        // Modal functionality replaces expandable rows
        
        // Update well notes in memory (for immediate feedback)
        function updateWellNotes(wellId) {
            const textarea = document.getElementById(`well-notes-${wellId}`);
            const well = loadedWells.find(w => w.id === wellId);
            if (well && textarea) {
                well.fields['Notes'] = textarea.value;
            }
        }

        async function saveWellNotes(wellId) {
            const textarea = document.getElementById(`well-notes-${wellId}`);
            const notes = textarea ? textarea.value : '';
            
            try {
                const res = await fetch('/api/wells/' + wellId + '/notes', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const well = loadedWells.find(w => w.id === wellId);
                if (well) well.fields['Notes'] = notes;
                
                showToast('Note saved!', 'success');
            } catch (err) {
                showToast('Error saving notes', 'error');
            }
        }
        
        async function saveWellNotesFromModal() {
            const wellId = document.getElementById('wellDetailsId').value;
            const notes = document.getElementById('wellDetailsNotes').value;
            
            if (!wellId) {
                showToast('Error: Well ID not found', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/wells/' + wellId + '/notes', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const well = loadedWells.find(w => w.id === wellId);
                if (well) well.fields['Notes'] = notes;
                
                showToast('Note saved!', 'success');
            } catch (err) {
                console.error('Save notes error:', err);
                showToast('Error saving notes', 'error');
            }
        }
        
        async function saveWellNotesAndClose() {
            const wellId = document.getElementById('wellDetailsId').value;
            const notes = document.getElementById('wellDetailsNotes').value;
            
            if (!wellId) {
                showToast('Error: Well ID not found', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/wells/' + wellId + '/notes', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const well = loadedWells.find(w => w.id === wellId);
                if (well) well.fields['Notes'] = notes;
                
                // Close modal immediately after successful save
                closeWellDetailsModal();
                
                // Show success toast after modal closes
                setTimeout(() => showToast('Note saved!', 'success'), 100);
            } catch (err) {
                console.error('Save notes error:', err);
                showToast('Error saving notes', 'error');
                // Don't close modal if there was an error
            }
        }
        
        function closeWellDetailsModal() {
            const modal = document.getElementById('wellDetailsModal');
            modal.style = '';
            // Reset z-index for next time
            modal.style.zIndex = '';
            
            // Remove from modal stack
            const index = modalStack.findIndex(m => m.element === modal);
            if (index > -1) {
                modalStack.splice(index, 1);
            }
        }
        
        document.getElementById('wellDetailsModal').addEventListener('click', e => {
            if (e.target.id === 'wellDetailsModal') closeWellDetailsModal();
        });
        
        // Add hover handlers for Well Type and OCC Status
        // Removed obsolete hover handlers for old modal structure
        
        // Property Details Modal Functions
        async function openPropertyDetails(propId) {
            console.log('[openPropertyDetails] Called with propId:', propId);
            
            // Reset linked counts and lists immediately to prevent concatenation issues
            const wellsCountEl = document.getElementById('property-linked-wells-count');
            if (wellsCountEl) {
                wellsCountEl.textContent = '';
            }
            
            // Also clear the list content to show fresh loading state
            const wellsListEl = document.getElementById('linked-wells-list');
            if (wellsListEl) {
                wellsListEl.innerHTML = '';
                wellsListEl.style.display = 'none';
            }
            
            let prop = loadedProperties.find(p => p.id === propId);
            
            // If not in loaded properties, fetch from API
            if (!prop) {
                console.log('[openPropertyDetails] Property not found in loadedProperties:', propId);
                console.log('[openPropertyDetails] Fetching from API...');
                
                try {
                    // Fetch all properties and find the one we need
                    const res = await fetch('/api/properties');
                    if (!res.ok) throw new Error('Failed to fetch properties');
                    
                    const allProperties = await res.json();
                    prop = allProperties.find(p => p.id === propId);
                    
                    if (!prop) {
                        console.error('[openPropertyDetails] Property not found in API response');
                        alert('Property not found');
                        return;
                    }
                    
                    // Add to loaded properties for future use
                    loadedProperties.push(prop);
                    console.log('[openPropertyDetails] Property fetched and added to cache');
                } catch (error) {
                    console.error('[openPropertyDetails] Error fetching property:', error);
                    alert('Error loading property details');
                    return;
                }
            }
            
            const f = prop.fields;
            document.getElementById('propertyDetailsId').value = propId;
            
            // Calculate total acres for header badge
            const riAcres = parseFloat(f['RI Acres'] || 0);
            const wiAcres = parseFloat(f['WI Acres'] || 0);
            const totalAcres = riAcres + wiAcres;
            
            // Set header information
            const propertyName = f['Name'] || f['Property Name'] || 'Mineral Property';
            document.getElementById('propertyDetailsTitle').textContent = propertyName;
            
            // Set acreage badge
            const acreageBadge = document.getElementById('propertyDetailsAcreageBadge');
            if (totalAcres > 0) {
                acreageBadge.textContent = `${totalAcres.toFixed(2)} acres`;
                acreageBadge.style.display = 'inline-block';
            } else {
                acreageBadge.style.display = 'none';
            }
            
            // Set location info (county + legal)
            const county = cleanCountyDisplay(f['COUNTY']) || 'Unknown County';
            const legal = `T${f.TWN} R${f.RNG} ${f.SEC}`;
            document.getElementById('propertyDetailsLocation').textContent = `${county}  ${legal}`;
            
            // Set form fields
            document.getElementById('propertyDetailsLegal').textContent = legal;
            document.getElementById('propertyDetailsMeridian').value = f['MERIDIAN'] || 'IM';
            
            // Show/hide Group row based on whether it has a value
            const groupRow = document.getElementById('propertyDetailsGroupRow');
            if (f['Group']) {
                document.getElementById('propertyDetailsGroup').textContent = f['Group'];
                groupRow.style.display = 'flex';
            } else {
                groupRow.style.display = 'none';
            }
            
            // Set other fields
            document.getElementById('propertyDetailsRIAcres').value = riAcres;
            document.getElementById('propertyDetailsWIAcres').value = wiAcres;
            document.getElementById('propertyDetailsNotes').value = f['Notes'] || '';
            
            // Store original values for change detection
            document.getElementById('propertyDetailsOriginalNotes').value = f['Notes'] || '';
            document.getElementById('propertyDetailsOriginalRIAcres').value = riAcres;
            document.getElementById('propertyDetailsOriginalWIAcres').value = wiAcres;
            
            // Update total acres display in form
            updateTotalAcres();
            
            // Don't try to show count from property data - just show loading state
            const wellsCountElement = document.getElementById('property-linked-wells-count');
            // Already reset to '' at the start of this function
            console.log('[PropertyDetails] Initial count placeholder set to loading state');
            
            // Always show loading state initially - the API will update with real data
            document.getElementById('linked-wells-list').innerHTML = '<div style="padding: 12px; color: #6b7280;">Loading wells...</div>';
            document.getElementById('linked-wells-list').style.display = 'block';
            document.getElementById('linked-wells-empty').style.display = 'none';
            
            // Show modal with forced high z-index like bulk modals
            const propModal = document.getElementById('propertyDetailsModal');
            
            // Nuclear option - move modal to end of body to escape any stacking context
            if (propModal.parentNode !== document.body) {
                document.body.appendChild(propModal);
            }
            
            // Calculate z-index based on stack depth BEFORE adding to stack
            const baseZIndex = 999999;
            const newZIndex = baseZIndex + (modalStack.length * 10);
            
            propModal.style.cssText = `display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: ${newZIndex} !important; background: rgba(0,0,0,0.5) !important; align-items: center !important; justify-content: center !important; padding: 20px !important;`;
            
            // Add to modal stack if not already there (initial opening)
            if (!modalStack.find(m => m.element === propModal)) {
                modalStack.push({ type: 'property', id: propId, element: propModal });
            }
            
            // Load linked wells and OCC filings after modal is shown to avoid race condition
            console.log('[PropertyDetails] Opening property:', propId);
            setTimeout(() => {
                loadLinkedWells(propId);
                loadLinkedDocuments(propId, 'property');
                // Load OCC filings using section/township/range/meridian
                if (f.SEC && f.TWN && f.RNG) {
                    const meridian = f['MERIDIAN'] || 'IM';
                    loadOccFilings(f.SEC, f.TWN, f.RNG, 'property', meridian);
                }
            }, 100);
            
            // Handle viewer permissions
            const isViewer = currentUser?.role === 'Viewer';
            if (isViewer) {
                document.getElementById('savePropertyBtn').style.display = 'none';
                document.getElementById('propertyDetailsNotes').readOnly = true;
                document.getElementById('propertyDetailsNotes').style.backgroundColor = '#f5f5f5';
                document.getElementById('propertyDetailsRIAcres').readOnly = true;
                document.getElementById('propertyDetailsRIAcres').style.backgroundColor = '#f5f5f5';
                document.getElementById('propertyDetailsWIAcres').readOnly = true;
                document.getElementById('propertyDetailsWIAcres').style.backgroundColor = '#f5f5f5';
            } else {
                document.getElementById('propertyDetailsNotes').readOnly = false;
                document.getElementById('propertyDetailsNotes').style.backgroundColor = 'white';
                document.getElementById('propertyDetailsRIAcres').readOnly = false;
                document.getElementById('propertyDetailsRIAcres').style.backgroundColor = 'white';
                document.getElementById('propertyDetailsWIAcres').readOnly = false;
                document.getElementById('propertyDetailsWIAcres').style.backgroundColor = 'white';
                // Save button will be shown by toggleSaveButton when values change
                toggleSaveButton('property');
            }
        }
        
        function updateTotalAcres() {
            const riAcres = parseFloat(document.getElementById('propertyDetailsRIAcres').value) || 0;
            const wiAcres = parseFloat(document.getElementById('propertyDetailsWIAcres').value) || 0;
            const totalAcres = riAcres + wiAcres;
            
            // Update total in form
            document.getElementById('propertyDetailsTotalAcres').textContent = totalAcres > 0 ? totalAcres.toFixed(2) : '';
            
            // Update badge in header
            const acreageBadge = document.getElementById('propertyDetailsAcreageBadge');
            if (totalAcres > 0) {
                acreageBadge.textContent = `${totalAcres.toFixed(2)} acres`;
                acreageBadge.style.display = 'inline-block';
            } else {
                acreageBadge.style.display = 'none';
            }
        }
        
        // Linked Wells Functions
        function toggleLinkedWells() {
            const content = document.getElementById('linked-wells-content');
            const arrow = document.getElementById('linked-wells-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        async function loadLinkedWells(propertyId) {
            console.log('[LinkedWells] Loading linked wells for property:', propertyId);
            
            const countEl = document.getElementById('property-linked-wells-count');
            const listEl = document.getElementById('linked-wells-list');
            const emptyEl = document.getElementById('linked-wells-empty');
            
            console.log('[LinkedWells] Count element before update:', countEl, 'textContent:', countEl?.textContent);
            
            // Don't reset count - it's already set from property data
            // Just ensure loading state is shown if count > 0
            const currentCount = parseInt(countEl.textContent) || 0;
            if (currentCount > 0 && !listEl.innerHTML.includes('linked-well-row')) {
                listEl.innerHTML = '<div style="padding: 12px; color: #6b7280;">Loading wells...</div>';
                listEl.style.display = 'block';
                emptyEl.style.display = 'none';
            }
            
            try {
                const response = await fetch(`/api/property/${propertyId}/linked-wells`);
                console.log('[LinkedWells] API Response status:', response.status);
                const data = await response.json();
                console.log('[LinkedWells] API Response data:', data);
                
                const wellCount = data.wells ? data.wells.length : 0;
                console.log('[LinkedWells] Setting API count to:', wellCount, 'type:', typeof wellCount);
                countEl.textContent = String(wellCount);
                
                if (!data.wells || data.wells.length === 0) {
                    console.log('[LinkedWells] No wells found, showing empty state');
                    listEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                } else {
                    console.log('[LinkedWells] Found', data.wells.length, 'wells, updating DOM');
                    listEl.innerHTML = data.wells.map(w => `
                        <div class="linked-well-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6;">
                            <div style="flex: 1; cursor: pointer;" onclick="openWellFromProperty('${w.wellId}')">
                                <div style="font-weight: 500; color: #2563eb;">${escapeHtml(w.wellName)}</div>
                                <div style="font-size: 12px; color: #6b7280;">${escapeHtml(w.operator)}  ${escapeHtml(w.county)}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; ${getMatchReasonStyle(w.matchReason)}">${getMatchReasonLabel(w.matchReason)}</span>
                                <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; ${getStatusStyle(w.wellStatus)}">${w.wellStatus || 'AC'}</span>
                            </div>
                        </div>
                    `).join('');
                    listEl.style.display = 'block';
                    emptyEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load linked wells:', error);
                document.getElementById('property-linked-wells-count').textContent = '0';
                document.getElementById('linked-wells-list').style.display = 'none';
                document.getElementById('linked-wells-empty').style.display = 'block';
            }
        }
        
        function getMatchReasonStyle(reason) {
            switch(reason) {
                case 'Surface Location': return 'background: #dbeafe; color: #1d4ed8;';
                case 'Bottom Hole': return 'background: #cffafe; color: #0e7490;';
                case 'Lateral Path': return 'background: #f3e8ff; color: #7c3aed;';
                default: return 'background: #e5e7eb; color: #374151;';
            }
        }
        
        function getMatchReasonLabel(reason) {
            switch(reason) {
                case 'Surface Location': return 'Surface';
                case 'Bottom Hole': return 'Bottom Hole';
                case 'Lateral Path': return 'Lateral';
                default: return reason;
            }
        }
        
        function getStatusStyle(status) {
            switch(status) {
                case 'AC': return 'background: #dcfce7; color: #166534;';
                case 'TA': return 'background: #fef9c3; color: #854d0e;';
                case 'PA': return 'background: #f3f4f6; color: #6b7280;';
                default: return 'background: #e5e7eb; color: #374151;';
            }
        }
        
        function openManualLinkWell() {
            // Manual well linking to properties - feature coming soon
            showToast('Manual well linking coming soon', 'info');
        }
        
        // Alias for openWellDetailsModal for consistency
        function openWellDetail(wellId) {
            openWellDetailsModal(wellId);
        }
        
        // Open well from property modal - stack on top
        function openWellFromProperty(wellId) {
            // Check if we've hit max depth
            if (modalStack.length >= MAX_MODAL_DEPTH) {
                alert(`Maximum of ${MAX_MODAL_DEPTH} modals can be opened at once.`);
                return;
            }
            
            // Don't close the property modal - open well on top
            setTimeout(async () => {
                await openWellDetailsModal(wellId);
            }, 50);
        }
        
        async function unlinkWell(linkId) {
            if (!confirm('Remove this well link?')) return;
            
            try {
                const response = await fetch(`/api/property-well-link/${linkId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Reload the linked wells list
                    const propertyId = document.getElementById('propertyDetailsId').value;
                    loadLinkedWells(propertyId);
                } else {
                    console.error('Failed to unlink well');
                }
            } catch (error) {
                console.error('Error unlinking well:', error);
            }
        }
        
        // Linked Properties Functions (for well modal)
        function toggleLinkedProperties() {
            const content = document.getElementById('linked-properties-content');
            const arrow = document.getElementById('linked-properties-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        async function loadLinkedProperties(wellId) {
            console.log('[LinkedProperties] Loading linked properties for well:', wellId);
            
            // Clear and show loading state
            const countEl = document.getElementById('well-linked-properties-count');
            const listEl = document.getElementById('linked-properties-list');
            const emptyEl = document.getElementById('linked-properties-empty');
            
            // Don't reset count if it's already set from well data
            const currentCount = parseInt(countEl.textContent) || 0;
            if (currentCount > 0) {
                listEl.innerHTML = '<div style="padding: 12px; color: #6b7280;">Loading properties...</div>';
                listEl.style.display = 'block';
                emptyEl.style.display = 'none';
            } else {
                listEl.innerHTML = '';
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
            }
            
            try {
                const response = await fetch(`/api/well/${wellId}/linked-properties`, { credentials: 'include' });
                const data = await response.json();
                
                const propCount = data.properties?.length || 0;
                console.log('[LinkedProperties] Setting API count to:', propCount);
                countEl.textContent = String(propCount);
                
                if (!data.properties || data.properties.length === 0) {
                    listEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                } else {
                    listEl.innerHTML = data.properties.map(p => `
                        <div class="linked-property-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6;">
                            <div style="flex: 1; cursor: pointer;" onclick="openPropertyFromWell('${p.propertyId}')">
                                <div style="font-weight: 500; color: #2563eb;">${escapeHtml(p.location)}</div>
                                <div style="font-size: 12px; color: #6b7280;">${escapeHtml(p.county)}${p.acres ? '  ' + p.acres + ' acres' : ''}${p.group ? '  ' + escapeHtml(p.group) : ''}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; ${getMatchReasonStyle(p.matchReason)}">${getMatchReasonLabel(p.matchReason)}</span>
                            </div>
                        </div>
                    `).join('');
                    listEl.style.display = 'block';
                    emptyEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load linked properties:', error);
                countEl.textContent = '0';
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
            }
        }
        
        function openPropertyFromWell(propertyId) {
            // Check if we've hit max depth
            if (modalStack.length >= MAX_MODAL_DEPTH) {
                alert(`Maximum of ${MAX_MODAL_DEPTH} modals can be opened at once.`);
                return;
            }
            
            // Don't close the well modal - open property on top
            setTimeout(async () => {
                await openPropertyDetails(propertyId);
            }, 50);
        }
        
        async function unlinkProperty(linkId) {
            if (!confirm('Remove this property link?')) return;
            
            try {
                const response = await fetch(`/api/property-well-link/${linkId}`, { 
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    // Reload the linked properties list
                    const wellId = document.getElementById('wellDetailsId').value;
                    loadLinkedProperties(wellId);
                } else {
                    console.error('Failed to unlink property');
                }
            } catch (error) {
                console.error('Error unlinking property:', error);
            }
        }
        
        function openManualLinkProperty() {
            // Manual property linking to wells - feature coming soon
            showToast('Manual property linking coming soon', 'info');
        }
        
        // Linked Documents Functions
        function toggleLinkedDocuments(type) {
            const content = document.getElementById(type === 'property' ? 'linked-documents-content' : 'linked-documents-content-well');
            const arrow = document.getElementById(type === 'property' ? 'linked-documents-arrow' : 'linked-documents-arrow-well');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        async function loadLinkedDocuments(id, type, apiNumber = null) {
            console.log(`[LinkedDocuments] Loading linked documents for ${type}:`, id, apiNumber ? `(API: ${apiNumber})` : '');
            
            const countEl = document.getElementById(type === 'property' ? 'property-linked-documents-count' : 'well-linked-documents-count');
            const listEl = document.getElementById(type === 'property' ? 'linked-documents-list' : 'linked-documents-list-well');
            const emptyEl = document.getElementById(type === 'property' ? 'linked-documents-empty' : 'linked-documents-empty-well');
            
            // Show loading state
            countEl.textContent = '';
            listEl.innerHTML = '<div style="padding: 12px; color: #6b7280;">Loading documents...</div>';
            listEl.style.display = 'block';
            emptyEl.style.display = 'none';
            
            try {
                // Build URL with api_number parameter for wells
                let url = `/api/${type}/${id}/linked-documents`;
                if (type === 'well' && apiNumber) {
                    url += `?api_number=${encodeURIComponent(apiNumber)}`;
                }
                
                const response = await fetch(url, { credentials: 'include' });
                const data = await response.json();
                
                const docCount = data.documents?.length || 0;
                console.log(`[LinkedDocuments] Setting count to:`, docCount);
                countEl.textContent = String(docCount);
                
                if (!data.documents || data.documents.length === 0) {
                    listEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                } else {
                    listEl.innerHTML = data.documents.map(doc => {
                        const uploadDate = doc.uploadDate ? new Date(doc.uploadDate).toLocaleDateString('en-US', { timeZone: 'America/Chicago' }) : 'Unknown';
                        return `
                            <div class="linked-document-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6;">
                                <div style="flex: 1; cursor: pointer;" onclick="openDocumentDetail('${doc.id}')">
                                    <div style="font-weight: 500; color: #2563eb;">${escapeHtml(doc.displayName)}</div>
                                    <div style="font-size: 12px; color: #6b7280;">${escapeHtml(doc.docType)}  ${uploadDate}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    listEl.style.display = 'block';
                    emptyEl.style.display = 'none';
                }
            } catch (error) {
                console.error(`Failed to load linked documents for ${type}:`, error);
                countEl.textContent = '0';
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
            }
        }

        // OCC Filings Functions

        // State tracking for OCC filing processing
        const occProcessingStates = {}; // { stateKey: { status, documentId, buttonEl, pollInterval } }
        const OCC_POLL_INTERVAL = 5000; // 5 seconds
        const OCC_MAX_POLL_DURATION = 5 * 60 * 1000; // 5 minutes

        async function processOccFiling(caseNumber, orderNumber, buttonEl) {
            const stateKey = orderNumber || caseNumber;
            console.log(`[OCC Process] Processing ${caseNumber} (order: ${orderNumber})`);

            // Update button to fetching state
            occProcessingStates[stateKey] = { status: 'fetching', buttonEl };
            updateOccButtonState(buttonEl, 'fetching');

            try {
                const response = await fetch('/api/occ/fetch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ caseNumber, orderNumber })
                });

                const result = await response.json();

                if (result.alreadyProcessed) {
                    console.log(`[OCC Process] Already processed: ${result.documentId}`);
                    occProcessingStates[stateKey] = { status: 'complete', documentId: result.documentId, buttonEl };
                    updateOccButtonState(buttonEl, 'complete', result.documentId, result.displayName);
                } else if (result.success) {
                    const docId = result.document.id;
                    const docStatus = result.document.status || 'pending';
                    console.log(`[OCC Process] Successfully queued: ${docId}, status: ${docStatus}`);

                    // Update credits display
                    if (typeof updateCreditsDisplay === 'function') {
                        updateCreditsDisplay(result.creditsRemaining);
                    }

                    // Check initial status and start polling if not complete
                    if (docStatus === 'complete') {
                        occProcessingStates[stateKey] = { status: 'complete', documentId: docId, buttonEl };
                        updateOccButtonState(buttonEl, 'complete', docId);
                    } else {
                        // Start polling for document status
                        occProcessingStates[stateKey] = {
                            status: docStatus === 'processing' ? 'processing' : 'queued',
                            documentId: docId,
                            buttonEl,
                            pollStartTime: Date.now()
                        };
                        updateOccButtonState(buttonEl, docStatus === 'processing' ? 'processing' : 'queued');
                        startOccDocumentPolling(stateKey, docId, buttonEl);
                    }
                } else if (result.error === 'no_credits') {
                    console.log(`[OCC Process] No credits available`);
                    occProcessingStates[stateKey] = { status: 'idle', buttonEl };
                    updateOccButtonState(buttonEl, 'idle');
                    showOutOfCreditsModal();
                } else {
                    throw new Error(result.message || result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('[OCC Process] Error:', error);
                occProcessingStates[stateKey] = { status: 'error', buttonEl };
                updateOccButtonState(buttonEl, 'error');
                showToast('Failed to process filing: ' + error.message, 'error');
            }
        }
        window.processOccFiling = processOccFiling;

        // Wrapper for Activity Log - processes OCC filing by case number only
        async function processOccFilingFromActivity(caseNumber, buttonEl) {
            // Use empty order number - the OCC fetcher will find the latest order
            await processOccFiling(caseNumber, '', buttonEl);
        }
        window.processOccFilingFromActivity = processOccFilingFromActivity;

        function startOccDocumentPolling(stateKey, documentId, buttonEl) {
            const state = occProcessingStates[stateKey];
            if (!state || state.pollInterval) return; // Already polling

            console.log(`[OCC Poll] Starting polling for ${documentId}`);

            state.pollInterval = setInterval(async () => {
                const currentState = occProcessingStates[stateKey];
                if (!currentState) {
                    clearInterval(state.pollInterval);
                    return;
                }

                // Check if we've exceeded max poll duration
                if (Date.now() - currentState.pollStartTime > OCC_MAX_POLL_DURATION) {
                    console.log(`[OCC Poll] Max duration exceeded for ${documentId}`);
                    clearInterval(currentState.pollInterval);
                    currentState.pollInterval = null;
                    // Leave in current state - user can check documents tab
                    return;
                }

                try {
                    const response = await fetch(`/api/documents/${documentId}`, {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        console.log(`[OCC Poll] Error fetching status for ${documentId}`);
                        return;
                    }

                    const data = await response.json();
                    const doc = data.document;

                    if (!doc) return;

                    console.log(`[OCC Poll] Document ${documentId} status: ${doc.status}`);

                    if (doc.status === 'complete') {
                        // Document processing complete!
                        clearInterval(currentState.pollInterval);
                        currentState.pollInterval = null;
                        currentState.status = 'complete';
                        updateOccButtonState(buttonEl, 'complete', documentId, doc.display_name);
                        showToast('Document analysis complete!', 'success');
                    } else if (doc.status === 'processing' && currentState.status !== 'processing') {
                        // Transitioned to processing
                        currentState.status = 'processing';
                        updateOccButtonState(buttonEl, 'processing');
                    } else if (doc.status === 'error') {
                        // Processing failed
                        clearInterval(currentState.pollInterval);
                        currentState.pollInterval = null;
                        currentState.status = 'error';
                        updateOccButtonState(buttonEl, 'error');
                        showToast('Document processing failed', 'error');
                    }
                } catch (err) {
                    console.error(`[OCC Poll] Error polling ${documentId}:`, err);
                }
            }, OCC_POLL_INTERVAL);
        }

        function stopAllOccPolling() {
            for (const key in occProcessingStates) {
                const state = occProcessingStates[key];
                if (state.pollInterval) {
                    clearInterval(state.pollInterval);
                    state.pollInterval = null;
                }
            }
        }

        function updateOccButtonState(buttonEl, state, documentId = null, displayName = null) {
            if (!buttonEl) return;

            // Remove all state classes and reset onclick
            buttonEl.classList.remove('processing', 'complete', 'error', 'queued', 'fetching');
            buttonEl.onclick = null;

            switch (state) {
                case 'fetching':
                    buttonEl.classList.add('fetching');
                    buttonEl.disabled = true;
                    buttonEl.innerHTML = '<span class="spinner-sm"></span> Fetching...';
                    buttonEl.title = 'Downloading from OCC';
                    break;
                case 'queued':
                    buttonEl.classList.add('queued');
                    buttonEl.disabled = true;
                    buttonEl.innerHTML = '<span class="spinner-sm"></span> Queued...';
                    buttonEl.title = 'Waiting for processing';
                    break;
                case 'processing':
                    buttonEl.classList.add('processing');
                    buttonEl.disabled = true;
                    buttonEl.innerHTML = '<span class="spinner-sm"></span> Processing...';
                    buttonEl.title = 'Extracting document data';
                    break;
                case 'complete':
                    buttonEl.classList.add('complete');
                    buttonEl.disabled = false;
                    buttonEl.innerHTML = 'Analyzed ';
                    buttonEl.title = 'Click to view document';
                    // Store documentId and make clickable to open document detail modal
                    if (documentId) {
                        buttonEl.dataset.documentId = documentId;
                        buttonEl.onclick = function() {
                            // Open document detail modal
                            if (typeof openDocumentDetail === 'function') {
                                openDocumentDetail(documentId);
                            } else {
                                // Fallback: reload page with doc param to trigger document view
                                window.location.href = `/portal?doc=${documentId}`;
                            }
                        };
                    }
                    break;
                case 'error':
                    buttonEl.classList.add('error');
                    buttonEl.disabled = false;
                    buttonEl.innerHTML = 'Retry';
                    buttonEl.title = 'Click to retry';
                    break;
                default: // idle
                    buttonEl.disabled = false;
                    buttonEl.innerHTML = 'Analyze';
                    buttonEl.title = 'Uses 1 document credit';
            }
        }

        function toggleOccFilings(type) {
            const content = document.getElementById(type === 'property' ? 'property-occ-content' : 'well-occ-content');
            const arrow = document.getElementById(type === 'property' ? 'property-occ-arrow' : 'well-occ-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        window.toggleOccFilings = toggleOccFilings;

        async function loadOccFilings(section, township, range, type = 'property', meridian = 'IM') {
            console.log(`[OccFilings] Loading filings for S${section}-T${township}-R${range} ${meridian} (${type})`);

            const prefix = type === 'property' ? 'property' : 'well';
            const directContainer = document.getElementById(`${prefix}-occ-direct`);
            const adjacentContainer = document.getElementById(`${prefix}-occ-adjacent`);
            const adjacentWrapper = document.getElementById(`${prefix}-occ-adjacent-wrapper`);
            const emptyMessage = document.getElementById(`${prefix}-occ-empty`);
            const countBadge = document.getElementById(`${prefix}-occ-count`);
            const adjacentCountBadge = document.getElementById(`${prefix}-occ-adjacent-count`);

            // Reset
            directContainer.innerHTML = '<div style="padding: 12px; color: #6b7280;">Loading filings...</div>';
            adjacentContainer.innerHTML = '';
            adjacentWrapper.style.display = 'none';
            emptyMessage.style.display = 'none';
            countBadge.textContent = '';

            try {
                const response = await fetch(
                    `/api/docket-entries?section=${section}&township=${encodeURIComponent(township)}&range=${encodeURIComponent(range)}&meridian=${encodeURIComponent(meridian)}&includeAdjacent=true`,
                    { credentials: 'include' }
                );
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load filings');
                }

                const directFilings = data.direct || [];
                const adjacentFilings = data.adjacent || [];

                // Update count badge
                const totalCount = directFilings.length + adjacentFilings.length;
                countBadge.textContent = String(totalCount);

                if (directFilings.length === 0 && adjacentFilings.length === 0) {
                    directContainer.innerHTML = '';
                    emptyMessage.style.display = 'block';
                    return;
                }

                // Render direct filings
                if (directFilings.length > 0) {
                    directContainer.innerHTML = directFilings.map(filing => renderOccFiling(filing, false)).join('');
                } else {
                    directContainer.innerHTML = '<div style="color: #888; font-size: 13px; font-style: italic; padding: 8px 0;">No direct filings for this section</div>';
                }

                // Render adjacent filings
                if (adjacentFilings.length > 0) {
                    adjacentWrapper.style.display = 'block';
                    adjacentCountBadge.textContent = String(adjacentFilings.length);
                    adjacentContainer.innerHTML = adjacentFilings.map(filing => renderOccFiling(filing, true)).join('');
                }

                // Check which filings have already been analyzed
                const allFilings = [...directFilings, ...adjacentFilings];
                const analyzableFilings = allFilings.filter(f =>
                    (f.status === 'HEARD' || f.status === 'RECOMMENDED') && f.caseNumber
                );

                if (analyzableFilings.length > 0) {
                    const caseNumbers = analyzableFilings.map(f => f.caseNumber).join(',');
                    console.log('[OccFilings] Checking analyzed status for:', caseNumbers);
                    console.log('[OccFilings] Analyzable filings:', analyzableFilings.map(f => ({ caseNumber: f.caseNumber, orderNumber: f.orderNumber, status: f.status })));
                    try {
                        const analyzedResponse = await fetch(
                            `/api/documents/by-occ-cases?cases=${encodeURIComponent(caseNumbers)}`,
                            { credentials: 'include' }
                        );
                        console.log('[OccFilings] Response status:', analyzedResponse.status);
                        if (!analyzedResponse.ok) {
                            console.error('[OccFilings] API error:', analyzedResponse.status, analyzedResponse.statusText);
                            return;
                        }
                        const analyzedData = await analyzedResponse.json();
                        console.log('[OccFilings] Analyzed data:', JSON.stringify(analyzedData, null, 2));

                        // Update buttons for already-analyzed filings
                        for (const filing of analyzableFilings) {
                            // Try multiple matching strategies
                            const caseNum = filing.caseNumber;
                            const caseNumClean = caseNum?.replace(/^CD\s*/i, '');
                            const analyzed = analyzedData[caseNum] ||
                                           analyzedData[caseNumClean] ||
                                           analyzedData[`CD${caseNumClean}`];

                            console.log(`[OccFilings] Filing ${caseNum}: analyzed =`, analyzed);

                            if (analyzed) {
                                const buttonId = `occ-btn-${(filing.orderNumber || filing.caseNumber).replace(/[^a-zA-Z0-9]/g, '-')}`;
                                const button = document.getElementById(buttonId);
                                console.log(`[OccFilings] Button ${buttonId}:`, button ? 'found' : 'NOT FOUND');
                                if (button) {
                                    // Update in-memory state
                                    const stateKey = filing.orderNumber || filing.caseNumber;
                                    occProcessingStates[stateKey] = { status: 'complete', documentId: analyzed.documentId, buttonEl: button };
                                    // Update button to analyzed state
                                    updateOccButtonState(button, 'complete', analyzed.documentId, analyzed.displayName);
                                }
                            }
                        }
                    } catch (err) {
                        console.log('[OccFilings] Could not check analyzed status:', err);
                    }
                }

            } catch (error) {
                console.error('[OccFilings] Error loading filings:', error);
                directContainer.innerHTML = '<div style="color: #dc3545; font-size: 13px; padding: 8px 0;">Error loading filings</div>';
                countBadge.textContent = '0';
            }
        }
        window.loadOccFilings = loadOccFilings;

        function renderOccFiling(filing, isAdjacent = false) {
            const statusClass = getOccStatusClass(filing.status);
            const dateDisplay = formatOccDate(filing.hearingDate || filing.docketDate);
            const isUpcoming = isOccHearingUpcoming(filing.hearingDate, filing.status);

            let adjacentNote = '';
            if (isAdjacent && filing.section) {
                adjacentNote = `<span class="occ-adjacent-note">S${filing.section}-T${filing.township}-R${filing.range}</span>`;
            }

            // Show Analyze button for filings with final orders (HEARD/RECOMMENDED)
            // Show "Pending" text for Filed/Continued/Scheduled status
            const hasFinalOrder = filing.status === 'HEARD' || filing.status === 'RECOMMENDED';
            const isPending = filing.status === 'FILED' || filing.status === 'CONTINUED' || filing.status === 'SCHEDULED';
            const orderNumber = filing.orderNumber || '';
            const caseNumber = filing.caseNumber || '';

            // Generate unique ID for the button
            const buttonId = `occ-btn-${(orderNumber || caseNumber).replace(/[^a-zA-Z0-9]/g, '-')}`;

            let processButton = '';
            if (hasFinalOrder && caseNumber) {
                processButton = `
                    <div class="occ-filing-actions">
                        <button
                            id="${buttonId}"
                            class="occ-process-btn"
                            onclick="processOccFiling('${escapeHtml(caseNumber)}', '${escapeHtml(orderNumber)}', this)"
                            title="Uses 1 document credit"
                        >Analyze</button>
                    </div>
                `;
            } else if (isPending) {
                processButton = `
                    <div class="occ-filing-actions">
                        <span class="occ-pending-text" title="Final order not yet available">Pending</span>
                    </div>
                `;
            }

            return `
                <div class="occ-filing-item">
                    <div class="occ-filing-main">
                        <div class="occ-filing-type">
                            ${isUpcoming ? '<span class="occ-hearing-warning" title="Hearing within 30 days"></span>' : ''}
                            ${escapeHtml(filing.reliefTypeDisplay)}
                            ${adjacentNote}
                        </div>
                        <div class="occ-filing-applicant">${escapeHtml(filing.applicant) || 'Unknown Applicant'}</div>
                        <div class="occ-filing-details">
                            <span class="occ-filing-case">${escapeHtml(filing.caseNumber)}</span>
                            <span class="occ-filing-status ${statusClass}">${escapeHtml(filing.statusDisplay)}</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        ${processButton}
                        <div class="occ-filing-date">
                            ${dateDisplay}
                            ${filing.sourceUrl ? `<a href="${escapeHtml(filing.sourceUrl)}" target="_blank" class="occ-filing-link" title="View on OCC"></a>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function getOccStatusClass(status) {
            const statusMap = {
                'HEARD': 'heard',
                'RECOMMENDED': 'heard',
                'CONTINUED': 'continued',
                'SCHEDULED': 'scheduled',
                'DISMISSED': 'dismissed',
                'WITHDRAWN': 'dismissed'
            };
            return statusMap[status] || 'filed';
        }

        function formatOccDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        }

        function isOccHearingUpcoming(dateStr, status) {
            if (status !== 'SCHEDULED') return false;
            if (!dateStr) return false;
            try {
                const hearingDate = new Date(dateStr);
                const today = new Date();
                const daysUntil = (hearingDate - today) / (1000 * 60 * 60 * 24);
                return daysUntil > 0 && daysUntil <= 30;
            } catch (e) {
                return false;
            }
        }

        // Expose functions globally for onclick handlers
        window.toggleLinkedDocuments = toggleLinkedDocuments;

        async function savePropertyDetails() {
            const propId = document.getElementById('propertyDetailsId').value;
            const notes = document.getElementById('propertyDetailsNotes').value;
            const meridian = document.getElementById('propertyDetailsMeridian').value;
            const riAcres = parseFloat(document.getElementById('propertyDetailsRIAcres').value) || 0;
            const wiAcres = parseFloat(document.getElementById('propertyDetailsWIAcres').value) || 0;
            
            try {
                const res = await fetch('/api/properties/' + propId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes, meridian, riAcres, wiAcres })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const prop = loadedProperties.find(p => p.id === propId);
                if (prop) {
                    prop.fields['Notes'] = notes;
                    prop.fields['MERIDIAN'] = meridian;
                    prop.fields['RI Acres'] = riAcres;
                    prop.fields['WI Acres'] = wiAcres;
                }
                
                showToast('Changes saved!', 'success');
                closePropertyDetailsModal();
                await loadProperties();
            } catch (err) {
                showToast('Error saving changes', 'error');
            }
        }
        
        async function savePropertyAndClose() {
            const propId = document.getElementById('propertyDetailsId').value;
            const notes = document.getElementById('propertyDetailsNotes').value;
            const meridian = document.getElementById('propertyDetailsMeridian').value;
            const riAcres = parseFloat(document.getElementById('propertyDetailsRIAcres').value) || 0;
            const wiAcres = parseFloat(document.getElementById('propertyDetailsWIAcres').value) || 0;
            
            if (!propId) {
                showToast('Error: Property ID not found', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/properties/' + propId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes, meridian, riAcres, wiAcres })
                });
                
                if (!res.ok) throw new Error('Failed to save');
                
                // Update local data
                const prop = loadedProperties.find(p => p.id === propId);
                if (prop) {
                    prop.fields['Notes'] = notes;
                    prop.fields['MERIDIAN'] = meridian;
                    prop.fields['RI Acres'] = riAcres;
                    prop.fields['WI Acres'] = wiAcres;
                }
                
                // Close modal immediately after successful save
                closePropertyDetailsModal();
                
                // Show success toast after modal closes and reload properties
                setTimeout(() => {
                    showToast('Changes saved!', 'success');
                    loadProperties();
                }, 100);
            } catch (err) {
                console.error('Save property error:', err);
                showToast('Error saving changes', 'error');
                // Don't close modal if there was an error
            }
        }
        
        function closePropertyDetailsModal() {
            const modal = document.getElementById('propertyDetailsModal');
            modal.style = '';
            // Reset z-index for next time
            modal.style.zIndex = '';
            
            // Remove from modal stack
            const index = modalStack.findIndex(m => m.element === modal);
            if (index > -1) {
                modalStack.splice(index, 1);
            }
        }
        
        document.getElementById('propertyDetailsModal').addEventListener('click', e => {
            if (e.target.id === 'propertyDetailsModal') closePropertyDetailsModal();
        });
        
        // CSV Export Functions (Professional tier)
        function exportWellsCSV() {
            if (!loadedWells.length) {
                showToast('No wells to export', 'info');
                return;
            }
            
            // Helper function to escape CSV values
            function escapeCSV(value) {
                if (value === null || value === undefined) return '';
                value = value.toString();
                // If contains comma, quote, or newline, wrap in quotes and escape quotes
                if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            }
            
            const headers = ['API Number', 'Well Name', 'Operator', 'County', 'Section', 'Township', 'Range', 'Well Type', 'Well Status', 'Notes', 'OCC Map Link'];
            const rows = loadedWells.map(w => {
                const f = w.fields;
                return [
                    escapeCSV(f['API Number'] || ''),
                    escapeCSV(f['Well Name'] || ''),
                    escapeCSV(f['Operator'] || ''),
                    escapeCSV(f['County'] || ''),
                    escapeCSV(f['Section'] || ''),
                    escapeCSV(f['Township'] || ''),
                    escapeCSV(f['Range'] || ''),
                    escapeCSV(f['Well Type'] || ''),
                    escapeCSV(f['Well Status'] || ''),
                    escapeCSV(f['Notes'] || ''),
                    escapeCSV(f['OCC Map Link'] || '')
                ].join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\n');
            downloadCSV(csv, 'mineral-watch-wells.csv');
        }
        
        function exportPropertiesCSV() {
            if (!loadedProperties.length) {
                showToast('No properties to export', 'info');
                return;
            }
            
            // Helper function to escape CSV values
            function escapeCSV(value) {
                if (value === null || value === undefined) return '';
                value = value.toString();
                // If contains comma, quote, or newline, wrap in quotes and escape quotes
                if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            }
            
            const headers = ['County', 'Section', 'Township', 'Range', 'Meridian', 'Group', 'RI Acres', 'WI Acres', 'Notes'];
            const rows = loadedProperties.map(p => {
                const f = p.fields;
                return [
                    escapeCSV(f['COUNTY'] || ''),
                    escapeCSV(f['SEC'] || ''),
                    escapeCSV(f['TWN'] || ''),
                    escapeCSV(f['RNG'] || ''),
                    escapeCSV(f['MERIDIAN'] || 'IM'),
                    escapeCSV(f['Group'] || ''),
                    escapeCSV(f['RI Acres'] || '0'),
                    escapeCSV(f['WI Acres'] || '0'),
                    escapeCSV(f['Notes'] || '')
                ].join(',');
            });
            
            const csv = [headers.join(','), ...rows].join('\n');
            downloadCSV(csv, 'mineral-watch-properties.csv');
        }
        
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }
        
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/auth/logout', { 
                    method: 'POST',
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    // Clear any client-side session data
                    document.cookie = 'mw_session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                    window.location.href = '/portal/login';
                } else {
                    console.error('Logout failed:', response.status);
                    // Still redirect to login
                    window.location.href = '/portal/login';
                }
            } catch (error) {
                console.error('Logout error:', error);
                // Still redirect to login
                window.location.href = '/portal/login';
            }
        });
        
        // Toast notification system
        function showToast(message, type = 'success', duration = 3000) {
            // Remove any existing toasts
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = `toast toast-${type}`;
            
            const icon = type === 'success' ? '' : type === 'error' ? '' : '';
            
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${escapeHtml(message)}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('toast-show'), 10);
            
            // Auto dismiss if duration > 0, otherwise keep persistent
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.remove('toast-show');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }
        
        function dismissToast() {
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) {
                existingToast.classList.remove('toast-show');
                setTimeout(() => existingToast.remove(), 300);
            }
        }

        // Custom confirm dialog
        function showConfirm(message, options = {}) {
            return new Promise((resolve) => {
                const dialog = document.getElementById('confirmDialog');
                console.log('Confirm dialog element:', dialog);
                
                if (!dialog) {
                    console.error('Confirm dialog not found!');
                    resolve(false);
                    return;
                }
                
                const title = document.getElementById('confirmTitle');
                const messageEl = document.getElementById('confirmMessage');
                const cancelBtn = document.getElementById('confirmCancel');
                const okBtn = document.getElementById('confirmOk');
                
                title.textContent = options.title || 'Confirm Action';
                messageEl.innerHTML = message;
                okBtn.textContent = options.confirmText || 'Delete';
                cancelBtn.textContent = options.cancelText || 'Cancel';
                
                dialog.classList.add('show');
                console.log('Dialog should be visible now');
                
                const handleCancel = () => {
                    dialog.classList.remove('show');
                    resolve(false);
                    cleanup();
                };
                
                const handleConfirm = () => {
                    dialog.classList.remove('show');
                    resolve(true);
                    cleanup();
                };
                
                const cleanup = () => {
                    cancelBtn.removeEventListener('click', handleCancel);
                    okBtn.removeEventListener('click', handleConfirm);
                    dialog.removeEventListener('click', handleOverlayClick);
                };
                
                const handleOverlayClick = (e) => {
                    if (e.target === dialog) handleCancel();
                };
                
                cancelBtn.addEventListener('click', handleCancel);
                okBtn.addEventListener('click', handleConfirm);
                dialog.addEventListener('click', handleOverlayClick);
            });
        }
    </script>
    </div>
</div>
<!-- End of propertyDetailsModal -->

<!-- Manual Document Link Modal -->
<div class="modal-overlay" id="manualDocLinkModal" style="display: none;">
    <div class="modal" style="max-width: 500px; width: 100%; position: relative;">
        <button class="modal-close" onclick="closeManualDocLinkModal()" aria-label="Close">&times;</button>
        <div style="padding: 24px;">
            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600;">Link Document</h3>
            <p id="manualDocLinkSubtitle" style="margin: 0 0 20px 0; font-size: 14px; color: var(--slate-blue);">Select a document to link</p>

            <div id="manualDocLinkList" style="max-height: 350px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px;">
                <!-- Documents will be populated here -->
            </div>

            <div id="manualDocLinkEmpty" style="display: none; text-align: center; padding: 40px 20px; color: var(--slate-blue);">
                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 12px; opacity: 0.4;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p style="margin: 0; font-weight: 500;">No unlinked documents</p>
                <p style="margin: 8px 0 0 0; font-size: 13px;">All your documents are already linked to properties or wells.</p>
            </div>

            <div class="modal-buttons" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" class="btn-secondary" onclick="closeManualDocLinkModal()">Cancel</button>
            </div>
        </div>
        <input type="hidden" id="manualDocLinkTargetType">
        <input type="hidden" id="manualDocLinkTargetId">
    </div>
</div>

<!-- BULK UPLOAD MODAL - REDESIGNED -->
<div class="modal-overlay" id="bulk-upload-modal">
    <div class="modal bulk-modal">
        <!-- Header -->
        <div class="bulk-header">
            <h2>Bulk Upload Properties</h2>
            <button class="bulk-close" onclick="closeBulkUploadModal()">&times;</button>
        </div>
        
        <!-- Step 1: File Upload -->
        <div id="upload-step" style="display:block;">
            <!-- Instructions -->
            <div class="bulk-section">
                <p class="bulk-intro">Upload a CSV or Excel file with your properties. We'll automatically detect columns and format your data.</p>
                <p class="bulk-text" style="margin-top: 8px;"> <strong>Tip:</strong> Include a Notes column to add context like well names, ownership details, or reminders for each property.</p>
            </div>
            
            <!-- File Formats -->
            <div class="bulk-section bulk-section-gray">
                <div class="bulk-label">Supported File Formats</div>
                <div class="bulk-text">CSV (.csv), Excel (.xlsx, .xls), Tab-delimited (.txt, .tsv)</div>
            </div>
            
            <!-- Two Column: Column Names + Format Examples -->
            <div class="bulk-section">
                <div class="bulk-two-col">
                    <!-- Column Names -->
                    <div>
                        <div class="bulk-label">Column Names (Flexible)</div>
                        <div class="bulk-columns">
                            <div><strong>Section:</strong> <code>SEC</code> <code>Section</code> <code>Sec</code> <code>S</code></div>
                            <div><strong>Township:</strong> <code>TWN</code> <code>Township</code> <code>Town</code> <code>T</code></div>
                            <div><strong>Range:</strong> <code>RNG</code> <code>Range</code> <code>R</code></div>
                            <div><strong>Notes:</strong> <code>Notes</code> <code>Note</code> <code>Comments</code></div>
                            <div><strong>Acres:</strong> <code>RI Acres</code> <code>RI</code> <code>WI Acres</code> <code>WI</code> <code>Total Acres</code> <code>Acres</code></div>
                            <div><strong>Group:</strong> <code>Group</code> <code>Entity</code></div>
                            <div><strong>County:</strong> <code>County</code> <code>Co</code> <code>C</code></div>
                            <div><strong>Optional:</strong> County, Meridian, Group, RI Acres, WI Acres, Total Acres</div>
                            <div style="font-size: 12px; color: var(--slate-blue); margin-top: 8px;"> If only "Total Acres" is provided, it defaults to RI interest</div>
                        </div>
                    </div>
                    
                    <!-- Format Examples -->
                    <div>
                        <div class="bulk-label">We Auto-Format These</div>
                        <div class="bulk-formats">
                            <div class="bulk-format"><code>3</code> <span class="arrow"></span> <code>03</code></div>
                            <div class="bulk-format"><code>S3</code> <span class="arrow"></span> <code>03</code></div>
                            <div class="bulk-format"><code>12 N</code> <span class="arrow"></span> <code>12N</code></div>
                            <div class="bulk-format"><code>T12N</code> <span class="arrow"></span> <code>12N</code></div>
                            <div class="bulk-format"><code>8w</code> <span class="arrow"></span> <code>8W</code></div>
                            <div class="bulk-format"><code>R08W</code> <span class="arrow"></span> <code>8W</code></div>
                        </div>
                        <p class="bulk-note">Missing meridian: Panhandle counties (Cimarron, Texas, Beaver) default to CM, all others to IM</p>
                    </div>
                </div>
            </div>
            
            <!-- Upload Area -->
            <div class="bulk-section">
                <div class="bulk-dropzone" id="dropzone" 
                     ondrop="handleFileDrop(event)" 
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     onclick="document.getElementById('fileInput').click()">
                    <div class="dropzone-icon"></div>
                    <div class="dropzone-text">Drop your file here or click to browse</div>
                    <div class="dropzone-subtext">Maximum file size: 5MB</div>
                </div>
                
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.txt,.tsv" style="display:none;" onchange="handleFileSelect(event)">
                
                <div id="file-info" class="bulk-file-info" style="display: none;">
                    <span class="file-name" id="filename"></span>
                    <span class="file-size" id="filesize"></span>
                </div>
                
                <div id="parse-error" class="bulk-error" style="display: none;">
                    <strong>Error parsing file:</strong> <span id="error-message"></span>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bulk-footer">
                <button class="btn-secondary" onclick="closeBulkUploadModal()">Cancel</button>
            </div>
        </div>
        
        <!-- Step 2: Preview & Validate -->
        <div id="preview-step" style="display:none;">
            <div class="bulk-section">
                <h3 style="margin-bottom: 8px; font-family: 'Merriweather', serif;">Preview & Validate</h3>
                <p class="bulk-text">Review the detected properties before importing:</p>
            </div>
            
            <div class="bulk-section">
                <!-- Validation Badges -->
                <div id="validation-summary" class="bulk-badges"></div>
                
                <!-- Plan Check -->
                <div id="plan-check"></div>
                
                <!-- Preview Table -->
                <div class="bulk-table-container">
                    <table class="bulk-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>SEC</th>
                                <th>TWN</th>
                                <th>RNG</th>
                                <th>MER</th>
                                <th>County</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bulk-footer">
                <button class="btn-secondary" onclick="resetBulkUpload()">Start Over</button>
                <button id="import-btn" class="btn-primary" onclick="startImport()">Import Properties</button>
            </div>
        </div>
        
        <!-- Step 3: Importing Progress -->
        <div id="import-step" style="display:none;">
            <div class="bulk-progress">
                <div class="progress-icon"></div>
                <h3>Importing Properties...</h3>
                <p class="bulk-text">Please wait while we create your properties.</p>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" id="progress-bar"></div>
                </div>
                <div class="progress-percent" id="progress-percent">0%</div>
                <div class="progress-count" id="import-progress">0 of 0 properties created</div>
            </div>
        </div>
        
        <!-- Step 4: Results -->
        <div id="results-step" style="display:none;">
            <div class="bulk-results">
                <div class="results-icon" id="results-icon"></div>
                <h3 class="results-title" id="results-title">Import Complete!</h3>
                <div class="results-stats">
                    <div class="stat-box">
                        <div class="stat-number stat-success" id="result-created">0</div>
                        <div class="stat-label">Created</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number stat-warning" id="result-skipped">0</div>
                        <div class="stat-label">Skipped</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number stat-error" id="result-failed">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                </div>
                <p class="bulk-text" id="results-details">Your properties are now being monitored for OCC activity.</p>
                <button class="btn-primary" onclick="finishBulkUpload()">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- BULK UPLOAD WELLS MODAL -->
<div class="modal-overlay" id="bulk-upload-wells-modal">
    <div class="modal bulk-modal">
        <!-- Header -->
        <div class="bulk-header">
            <h2>Bulk Upload Wells</h2>
            <button class="bulk-close" onclick="closeBulkUploadWellsModal()">&times;</button>
        </div>
        
        <!-- Step 1: File Upload -->
        <div id="wells-upload-step" style="display:block;">
            <div class="bulk-section">
                <p class="bulk-intro">Upload a CSV or Excel file to add wells. You can use API numbers or search by well name, operator, and location.</p>
                <p class="bulk-text" style="margin-top: 8px;"> <strong>New:</strong> No API numbers? We'll search our database of 453k Oklahoma wells using your CSV data!</p>
            </div>
            
            <div class="bulk-section bulk-section-gray">
                <div class="bulk-label">Column Options</div>
                <div class="bulk-text" style="margin-bottom: 12px;">
                    <strong>Option 1: Direct API</strong>  Provide 10-digit API numbers
                </div>
                <div class="bulk-columns">
                    <div>Headers: <code>API</code> <code>API Number</code> <code>apiNumber</code></div>
                </div>
                <div class="bulk-text" style="margin-top: 16px; margin-bottom: 12px;">
                    <strong>Option 2: Search by Details</strong>  We'll find matching wells
                </div>
                <div class="bulk-columns">
                    <div><code>Well Name</code> <code>Operator</code> <code>Section</code> <code>Township</code> <code>Range</code> <code>County</code></div>
                </div>
            </div>
            
            <div class="bulk-section">
                <div class="bulk-two-col">
                    <div>
                        <div class="bulk-label">Optional Columns</div>
                        <div class="bulk-columns">
                            <div><strong>Notes:</strong> <code>Notes</code> <code>Note</code> <code>Comments</code></div>
                        </div>
                    </div>
                    <div>
                        <div class="bulk-label">Format Flexibility</div>
                        <div class="bulk-formats">
                            <div class="bulk-format"><code>35-015-20001</code> <span class="arrow"></span> <code>3501520001</code></div>
                            <div class="bulk-format"><code>35 015 20001</code> <span class="arrow"></span> <code>3501520001</code></div>
                        </div>
                        <p class="bulk-note">Dashes, spaces, dots are automatically removed</p>
                    </div>
                </div>
            </div>
            
            <div class="bulk-section">
                <div class="bulk-dropzone" id="wells-dropzone" 
                     ondrop="handleWellsFileDrop(event)" 
                     ondragover="handleWellsDragOver(event)"
                     ondragleave="handleWellsDragLeave(event)"
                     onclick="document.getElementById('wellsFileInput').click()">
                    <div class="dropzone-icon"></div>
                    <div class="dropzone-text">Drop your file here or click to browse</div>
                    <div class="dropzone-subtext">CSV or Excel files accepted</div>
                </div>
                
                <input type="file" id="wellsFileInput" accept=".csv,.xlsx,.xls,.txt,.tsv" style="display:none;" onchange="handleWellsFileSelect(event)">
                
                <div id="wells-file-info" class="bulk-file-info" style="display: none;">
                    <span class="file-name" id="wells-filename"></span>
                    <span class="file-size" id="wells-filesize"></span>
                </div>
                
                <div id="wells-parse-error" class="bulk-error" style="display: none;">
                    <strong>Error parsing file:</strong> <span id="wells-error-message"></span>
                </div>
            </div>
            
            <div class="bulk-footer">
                <button class="btn-secondary" onclick="closeBulkUploadWellsModal()">Cancel</button>
            </div>
        </div>
        
        <!-- Step 2: Preview -->
        <div id="wells-preview-step" style="display:none;">
            <div class="bulk-section">
                <h3 style="margin-bottom: 8px; font-family: 'Merriweather', serif;">Preview & Validate</h3>
                <p class="bulk-text">Review the API numbers before importing:</p>
            </div>
            
            <div class="bulk-section">
                <div id="wells-validation-summary" class="bulk-badges"></div>
                <div id="wells-plan-check"></div>
                
                <!-- Quick Actions for large files -->
                <div id="wells-quick-actions" style="display: none; margin-top: 16px; margin-bottom: 16px;">
                    <button class="btn-secondary" onclick="selectAllExactMatches()">
                        Select All Exact Matches
                    </button>
                    <span style="margin-left: 12px; color: #64748b; font-size: 14px;">
                        For ambiguous matches, select the correct well from the dropdown
                    </span>
                </div>
                
                <div class="bulk-table-container">
                    <table class="bulk-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 60px;">Status</th>
                                <th>CSV Data</th>
                                <th>Matched Well</th>
                                <th style="width: 120px;">API Number</th>
                                <th style="width: 100px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="wells-preview-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="bulk-footer">
                <button class="btn-secondary" onclick="resetBulkUploadWells()">Start Over</button>
                <button id="wells-import-btn" class="btn-primary" onclick="startWellsImport()">Import Wells</button>
            </div>
        </div>
        
        <!-- Step 3: Importing -->
        <div id="wells-import-step" style="display:none;">
            <div class="bulk-progress">
                <div class="progress-icon"></div>
                <h3>Importing Wells...</h3>
                <p class="bulk-text">Please wait while we add your wells.</p>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill indeterminate" id="wells-progress-bar"></div>
                </div>
                <div class="progress-count" id="wells-import-progress">Processing...</div>
            </div>
        </div>
        
        <!-- Step 4: Results -->
        <div id="wells-results-step" style="display:none;">
            <div class="bulk-results">
                <div class="results-icon" id="wells-results-icon"></div>
                <h3 class="results-title" id="wells-results-title">Import Complete!</h3>
                <div class="results-stats">
                    <div class="stat-box">
                        <div class="stat-number stat-success" id="wells-result-created">0</div>
                        <div class="stat-label">Created</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number stat-warning" id="wells-result-skipped">0</div>
                        <div class="stat-label">Skipped</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number stat-error" id="wells-result-failed">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                </div>
                <p class="bulk-text" id="wells-results-details">Your wells are now being monitored for OCC activity.</p>
                <button class="btn-primary" onclick="finishBulkUploadWells()">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- DOCUMENT VIEW MODAL -->
<div class="modal-overlay" id="documentViewModal" style="display: none; z-index: 1000001;">
    <div class="modal" style="max-width: 900px; height: 90vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--border);">
            <h2 id="documentViewTitle" style="margin: 0; font-size: 18px; font-weight: 600;">Document Viewer</h2>
            <div style="display: flex; gap: 12px; align-items: center;">
                <button onclick="downloadCurrentDocument()" class="btn-secondary-action" style="padding: 8px 16px;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Download
                </button>
                <button onclick="closeDocumentViewer()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 4px;"></button>
            </div>
        </div>
        <div id="pdfViewerContainer" style="flex: 1; overflow: hidden; background: #525659; position: relative;">
            <object id="pdfViewer" type="application/pdf" style="width: 100%; height: 100%; border: none;">
                <p style="color: white; text-align: center; padding: 20px;">PDF cannot be displayed. <a href="#" onclick="downloadCurrentDocument(); return false;" style="color: #60A5FA;">Download instead</a></p>
            </object>
        </div>
    </div>
</div>

<!-- DOCUMENT DETAIL MODAL -->
<div class="modal-overlay" id="documentDetailModal" style="display: none; overflow-y: auto; z-index: 1000000;">
    <div class="modal detail-modal document-detail-modal" style="max-width: 700px; max-height: calc(100vh - 20px); margin: 10px auto; background: #FFFFFF; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; padding: 0;">
        <!-- Modal Header with green background (full bleed) -->
        <div class="modal-header detail-modal-header" style="background: #1D6F5C; color: white; padding: 20px 24px; position: relative; flex-shrink: 0;">
            <button onclick="closeDocumentDetailModal()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: white; opacity: 0.9; hover: opacity: 1;"></button>
            <h2 id="documentModalTitle" style="margin: 0; font-family: 'Merriweather', serif; font-size: 22px; font-weight: 700;">Document Details</h2>
            <div id="documentModalSubtitle" style="margin-top: 2px; font-size: 15px; opacity: 0.9;"></div>
        </div>
        
        <!-- Modal Body (scrollable content) -->
        <div class="modal-body detail-modal-body" id="documentDetailContent" style="padding: 20px 24px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; min-height: 0;">
            <!-- Content will be populated dynamically -->
        </div>
        
        <!-- Modal Footer (fixed at bottom) -->
        <div class="modal-footer detail-modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; gap: 10px; flex-shrink: 0; flex-wrap: wrap; background: white;">
            <button onclick="viewDocumentPDF()" id="viewOriginalBtn" style="background: #1D6F5C; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s;">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
                <span id="viewOriginalBtnText">View Original</span>
            </button>
            <div style="display: flex; gap: 10px;">
                <button onclick="closeDocumentDetailModal()" style="background: transparent; color: var(--oil-navy); border: 1px solid var(--border); padding: 8px 16px; border-radius: 8px; font-weight: 500; cursor: pointer;">Close</button>
                <button onclick="saveAndCloseDocumentNotes()" id="saveDocNotesBtn" style="background: #1D6F5C; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 500; cursor: pointer; display: none;">Save & Close</button>
            </div>
        </div>
    </div>
</div>

<!-- OUT OF CREDITS MODAL -->
<div class="modal-overlay" id="outOfCreditsModal" style="display: none;">
    <div class="modal" style="max-width: 450px; text-align: center;">
        <div style="margin-bottom: 24px;">
            <div style="width: 64px; height: 64px; background: #FEE2E2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                <svg width="32" height="32" fill="none" stroke="#DC2626" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <h2 style="margin: 0 0 8px; font-family: 'Merriweather', serif; font-size: 20px; color: var(--oil-navy);">You're Out of Credits</h2>
            <p style="margin: 0; color: #6B7280; font-size: 14px; line-height: 1.5;" id="outOfCreditsMessage">
                You've used all your available credits. Documents won't be processed until you have credits available.
            </p>
        </div>

        <div style="background: #F9FAFB; border-radius: 8px; padding: 16px; margin-bottom: 24px; text-align: left;">
            <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: var(--oil-navy);">Get More Credits</h4>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <a href="#" onclick="closeOutOfCreditsModal(); openCreditPackModal(); return false;" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: white; border: 1px solid #E5E7EB; border-radius: 6px; text-decoration: none; color: var(--oil-navy); transition: border-color 0.2s;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div>
                        <div style="font-weight: 500;">Buy Credit Pack</div>
                        <div style="font-size: 12px; color: #6B7280;">One-time purchase, never expires</div>
                    </div>
                </a>
                <a href="/portal/account" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: white; border: 1px solid #E5E7EB; border-radius: 6px; text-decoration: none; color: var(--oil-navy); transition: border-color 0.2s;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                    </svg>
                    <div>
                        <div style="font-weight: 500;">Upgrade Plan</div>
                        <div style="font-size: 12px; color: #6B7280;">More monthly credits + bonus</div>
                    </div>
                </a>
            </div>
        </div>

        <div style="display: flex; gap: 12px; justify-content: center;">
            <button onclick="closeOutOfCreditsModal()" style="background: transparent; color: var(--oil-navy); border: 1px solid var(--border); padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer;">
                Close
            </button>
        </div>

        <p id="creditResetInfo" style="margin: 16px 0 0; font-size: 12px; color: #9CA3AF;"></p>
    </div>
</div>

<!-- CREDIT PACK PURCHASE MODAL -->
<div class="modal-overlay" id="creditPackModal" style="display: none;">
    <div class="modal" style="max-width: 700px; position: relative;">
        <button onclick="closeCreditPackModal()" style="position: absolute; top: 12px; right: 12px; background: #f3f4f6; border: 1px solid #e5e7eb; width: 32px; height: 32px; border-radius: 6px; font-size: 20px; cursor: pointer; color: #374151; display: flex; align-items: center; justify-content: center; z-index: 10;"></button>
        <div style="text-align: center; margin-bottom: 24px;">
            <h2 style="margin: 0 0 8px; font-family: 'Merriweather', serif; font-size: 22px; color: var(--oil-navy);">Buy Credit Pack</h2>
            <p style="margin: 0; color: #6B7280; font-size: 14px;">One-time purchase. Credits never expire.</p>
        </div>

        <div class="credit-pack-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
            <!-- Starter Pack -->
            <div class="credit-pack-card" onclick="purchaseCreditPack('price_1SpV6u9OfJmRCDOqmiQGFg2V')" style="border: 2px solid #E5E7EB; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--oil-navy);">Starter Pack</h3>
                </div>
                <div style="margin-bottom: 8px;">
                    <span style="font-size: 32px; font-weight: 700; color: var(--oil-navy);">100</span>
                    <span style="font-size: 14px; color: #6B7280;"> credits</span>
                </div>
                <div style="font-size: 20px; font-weight: 600; color: var(--oil-navy); margin-bottom: 4px;">$49</div>
                <div style="font-size: 12px; color: #6B7280;">$0.49 per credit</div>
            </div>

            <!-- Working Pack -->
            <div class="credit-pack-card" onclick="purchaseCreditPack('price_1SpVCK9OfJmRCDOq8r8NrrqJ')" style="border: 2px solid #E5E7EB; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--oil-navy);">Working Pack</h3>
                    <span style="background: #D1FAE5; color: #047857; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">POPULAR</span>
                </div>
                <div style="margin-bottom: 8px;">
                    <span style="font-size: 32px; font-weight: 700; color: var(--oil-navy);">500</span>
                    <span style="font-size: 14px; color: #6B7280;"> credits</span>
                </div>
                <div style="font-size: 20px; font-weight: 600; color: var(--oil-navy); margin-bottom: 4px;">$199</div>
                <div style="font-size: 12px; color: #6B7280;">$0.40 per credit</div>
            </div>

            <!-- Team Pack -->
            <div class="credit-pack-card" onclick="purchaseCreditPack('price_1SpVCK9OfJmRCDOqhjfa5Na1')" style="border: 2px solid #E5E7EB; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--oil-navy);">Team Pack</h3>
                </div>
                <div style="margin-bottom: 8px;">
                    <span style="font-size: 32px; font-weight: 700; color: var(--oil-navy);">2,000</span>
                    <span style="font-size: 14px; color: #6B7280;"> credits</span>
                </div>
                <div style="font-size: 20px; font-weight: 600; color: var(--oil-navy); margin-bottom: 4px;">$699</div>
                <div style="font-size: 12px; color: #6B7280;">$0.35 per credit</div>
            </div>

            <!-- Operations Pack -->
            <div class="credit-pack-card" onclick="purchaseCreditPack('price_1SpVCK9OfJmRCDOqNVkGVLVQ')" style="border: 2px solid #E5E7EB; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--oil-navy);">Operations Pack</h3>
                    <span style="background: #DBEAFE; color: #1D4ED8; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">BEST VALUE</span>
                </div>
                <div style="margin-bottom: 8px;">
                    <span style="font-size: 32px; font-weight: 700; color: var(--oil-navy);">10,000</span>
                    <span style="font-size: 14px; color: #6B7280;"> credits</span>
                </div>
                <div style="font-size: 20px; font-weight: 600; color: var(--oil-navy); margin-bottom: 4px;">$2,499</div>
                <div style="font-size: 12px; color: #6B7280;">$0.25 per credit</div>
            </div>
        </div>

        <div style="text-align: center; padding-top: 16px; border-top: 1px solid #E5E7EB;">
            <p style="margin: 0; font-size: 13px; color: #9CA3AF;">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Purchased credits are used after your monthly credits, before bonus credits.
            </p>
        </div>
    </div>
</div>

<style>
.credit-pack-card:hover {
    border-color: var(--copper-accent);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}
</style>

<!-- DOCUMENT UPLOAD MODAL -->
<div class="modal-overlay" id="documentUploadModal" style="display: none;">
    <div class="modal" style="max-width: 500px;">
        <button class="close-btn" onclick="closeUploadModal()" style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;"></button>
        <h2 style="margin-bottom: 24px; font-family: 'Merriweather', serif;">Upload Documents</h2>
        
        <form id="documentUploadForm" onsubmit="handleDocumentUpload(event)">
            <!-- File Drop Zone -->
            <div id="fileDropZone" style="border: 2px dashed var(--border); border-radius: 8px; padding: 40px; text-align: center; background: #f8f9fa; cursor: pointer; margin-bottom: 24px;" 
                 ondrop="handleDocumentFileDrop(event)" 
                 ondragover="handleDocumentDragOver(event)" 
                 ondragleave="handleDocumentDragLeave(event)"
                 onclick="document.getElementById('documentFileInput').click()">
                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 12px; opacity: 0.4;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                <p style="margin: 0 0 8px; font-size: 16px; font-weight: 600; color: var(--oil-navy);">Drop files here or click to browse</p>
                <p style="margin: 0; font-size: 13px; color: var(--slate-blue);">PDF, JPEG, PNG, TIFF  Max 50MB per file, up to 500 files</p>
                <input type="file" id="documentFileInput" accept=".pdf,.jpg,.jpeg,.png,.tiff,.tif" multiple style="display: none;" onchange="handleDocumentFileSelect(event)">
            </div>
            
            <!-- Selected Files Display -->
            <div id="selectedFilesDisplay" style="display: none; max-height: 200px; overflow-y: auto; margin-bottom: 24px;">
                <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--oil-navy);">Selected Files:</h4>
                <div id="selectedFilesList"></div>
            </div>
            
            <!-- Credit Estimation -->
            <div id="creditEstimation" style="display: none; background: #F3F4F6; border: 1px solid #E5E7EB; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 14px; font-weight: 500; color: var(--oil-navy);">Minimum credits:</span>
                    <span style="font-size: 16px; font-weight: 700; color: var(--oil-navy);" id="estimatedCredits">0</span>
                </div>
                <div style="font-size: 13px; color: #6B7280; margin-bottom: 4px;">
                    (<span id="totalPages">0</span> pages detected)
                </div>
                <div style="font-size: 12px; color: #9CA3AF; margin-bottom: 8px;">
                    Each document extracted uses 1 credit
                </div>
                <div style="font-size: 13px; color: #6B7280;">
                    You have <span style="font-weight: 600; color: #059669;" id="availableCreditsInModal">0</span> credits available
                </div>
                <div id="creditWarning" style="display: none; margin-top: 12px; padding: 12px; background: #FEF2F2; border: 1px solid #FECACA; border-radius: 6px;">
                    <svg width="16" height="16" fill="none" stroke="#DC2626" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <span style="color: #DC2626; font-weight: 500;">Estimated credits exceed your available balance</span>
                </div>
            </div>
            
            <!-- Upload Button -->
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" class="btn-secondary-action" onclick="closeUploadModal()">Cancel</button>
                <button type="submit" class="btn-add" id="uploadBtn" disabled>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Upload
                </button>
            </div>
        </form>
        
        <!-- Progress Display -->
        <div id="uploadProgress" style="display: none; margin-top: 24px;">
            <div style="background: #E0F2FE; border-radius: 6px; padding: 16px; text-align: center;">
                <div class="spinner" style="width: 24px; height: 24px; border: 2px solid #60A5FA; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px;"></div>
                <p style="margin: 0; color: #1E40AF; font-weight: 500;">Uploading document...</p>
            </div>
        </div>
    </div>
</div>

<style>
/* Bulk Upload Modal - Redesigned Styles */

/* Modal specific overrides */
#bulk-upload-modal .modal.bulk-modal,
#bulk-upload-wells-modal .modal.bulk-modal {
    padding: 0;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
}

/* Header */
.bulk-header {
    background: linear-gradient(135deg, var(--oil-navy) 0%, var(--slate-blue) 100%);
    color: white;
    padding: 24px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.bulk-header h2 {
    font-size: 22px;
    font-weight: 700;
    margin: 0;
    font-family: 'Merriweather', serif;
}

.bulk-close {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 4px;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.bulk-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* Sections */
.bulk-section {
    padding: 24px 30px;
    border-bottom: 1px solid var(--border);
}

.bulk-section:last-child {
    border-bottom: none;
}

.bulk-section-gray {
    background: var(--paper);
}

.bulk-label {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--slate-blue);
    margin-bottom: 10px;
}

.bulk-intro {
    color: var(--slate-blue);
    font-size: 15px;
    line-height: 1.6;
    margin: 0;
}

.bulk-text {
    color: var(--oil-navy);
    font-size: 14px;
    line-height: 1.6;
}

.bulk-note {
    font-size: 12px;
    color: var(--slate-blue);
    margin-top: 12px;
}

/* Two Column Layout */
.bulk-two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
}

@media (max-width: 600px) {
    .bulk-two-col {
        grid-template-columns: 1fr;
    }
    
    /* Extra small screens */
    .container { padding: 0 15px; }
    main { padding: 20px 0; }
    
    
    .page-header h1 { font-size: 22px; }
    
    /* More compact tables on small screens */
    .data-table th, .data-table td { 
        padding: 6px 4px;
        font-size: 11px;
    }
    
    /* Stack table action buttons vertically on tiny screens */
    .col-actions { width: 20%; }
    .details-actions { flex-direction: column; }
    .details-btn { margin-bottom: 8px; }
    
    /* Compact plan info */
    .plan-info { padding: 12px 16px; }
    .plan-usage { flex-direction: column; gap: 8px; }
    
    /* Smaller stats */
    .stats-card { padding: 12px 15px; }
    .stat-value { font-size: 18px; }
}

/* Column Names */
.bulk-columns {
    font-size: 13px;
    line-height: 2;
}

.bulk-columns code {
    background: var(--paper);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 12px;
    font-family: 'SF Mono', Monaco, monospace;
    margin-right: 4px;
}

/* Format Examples */
.bulk-formats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.bulk-format {
    font-size: 13px;
    color: var(--slate-blue);
    display: flex;
    align-items: center;
    gap: 6px;
}

.bulk-format code {
    background: white;
    border: 1px solid var(--border);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 12px;
    font-family: 'SF Mono', Monaco, monospace;
}

.bulk-format .arrow {
    color: var(--success);
    font-weight: 600;
}

/* Dropzone */
.bulk-dropzone {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 50px 30px;
    text-align: center;
    background: var(--paper);
    cursor: pointer;
    transition: all 0.3s;
}

.bulk-dropzone:hover, .bulk-dropzone.drag-over {
    border-color: var(--red-dirt);
    background: #FFF5F0;
}

.dropzone-icon {
    font-size: 40px;
    margin-bottom: 12px;
}

.dropzone-text {
    font-size: 15px;
    color: var(--oil-navy);
    font-weight: 500;
    margin-bottom: 6px;
}

.dropzone-subtext {
    font-size: 13px;
    color: var(--slate-blue);
}

/* File Info */
.bulk-file-info {
    background: var(--success-bg);
    border: 1px solid rgba(3, 84, 63, 0.2);
    border-radius: 6px;
    padding: 14px 18px;
    margin-top: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.bulk-file-info .file-name {
    font-weight: 600;
    color: var(--success);
    font-size: 14px;
}

.bulk-file-info .file-size {
    color: var(--success);
    font-size: 13px;
}

/* Error */
.bulk-error {
    background: #FEE2E2;
    border: 1px solid rgba(220, 38, 38, 0.2);
    border-radius: 6px;
    padding: 14px 18px;
    margin-top: 16px;
    color: #DC2626;
    font-size: 14px;
}

/* Footer */
.bulk-footer {
    padding: 20px 30px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: white;
}

/* Badges */
.bulk-badges {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.validation-badge {
    padding: 10px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.badge-valid { background: var(--success-bg); color: var(--success); }
.badge-invalid { background: #FEE2E2; color: #DC2626; }
.badge-warning { background: #FEF3C7; color: #92400E; }
.badge-duplicate { background: #E0E7FF; color: #3730A3; }

/* Bulk well select dropdown */
.bulk-well-select {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 13px;
    background: white;
    cursor: pointer;
}

.bulk-well-select:hover {
    border-color: #cbd5e1;
}

.bulk-well-select:focus {
    outline: none;
    border-color: var(--oil-orange);
    box-shadow: 0 0 0 3px rgba(192, 86, 33, 0.1);
}

/* Plan Check */
.plan-check-box {
    padding: 16px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.plan-check-box.ok {
    background: var(--success-bg);
    border-left: 4px solid var(--success);
}

.plan-check-box.exceeded {
    background: #FEE2E2;
    border-left: 4px solid #DC2626;
}

.plan-check-header {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 4px;
}

.plan-check-box.ok .plan-check-header { color: var(--success); }
.plan-check-box.exceeded .plan-check-header { color: #DC2626; }

.plan-check-details {
    font-size: 13px;
    color: var(--slate-blue);
}

/* Preview Table */
.bulk-table-container {
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    max-height: 350px;
    overflow-y: auto;
}

.bulk-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.bulk-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
}

.bulk-table th {
    background: var(--oil-navy);
    color: white;
    padding: 12px 14px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.bulk-table td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
}

.bulk-table tbody tr:hover {
    background: var(--paper);
}

.preview-row-valid { background: white; }
.preview-row-warning { background: #FEF3C7; }
.preview-row-error { background: #FEE2E2; }
.preview-row-duplicate { background: #E0E7FF; opacity: 0.7; }

.status-cell-valid { color: var(--success); }
.status-cell-warning { color: #92400E; }
.status-cell-error { color: #DC2626; }
.status-cell-duplicate { color: #3730A3; }

/* Progress */
.bulk-progress {
    text-align: center;
    padding: 50px 30px;
}

.bulk-progress .progress-icon {
    font-size: 48px;
    margin-bottom: 20px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.progress-bar-track {
    width: 100%;
    max-width: 400px;
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    margin: 20px auto;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--red-dirt), var(--red-dirt-dark));
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
}

.progress-bar-fill.indeterminate {
    width: 100%;
    animation: indeterminate 1.5s infinite;
    background: linear-gradient(90deg, var(--red-dirt) 0%, var(--red-dirt-dark) 50%, var(--red-dirt) 100%);
    background-size: 200% 100%;
}

@keyframes indeterminate {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.progress-percent {
    font-size: 24px;
    font-weight: 700;
    color: var(--red-dirt);
    margin-top: 15px;
}

.progress-count {
    font-size: 14px;
    color: var(--slate-blue);
    margin-top: 8px;
}

/* Results */
.bulk-results {
    text-align: center;
    padding: 40px 30px;
}

.bulk-results .results-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

.bulk-results .results-title {
    font-size: 24px;
    margin-bottom: 25px;
    font-family: 'Merriweather', serif;
}

.results-stats {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 30px;
}

.stat-box {
    text-align: center;
}

.stat-number {
    font-size: 36px;
    font-weight: 700;
    font-family: 'Merriweather', serif;
}

.stat-success { color: var(--success); }
.stat-warning { color: #92400E; }
.stat-error { color: #DC2626; }

.stat-label {
    font-size: 13px;
    color: var(--slate-blue);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 4px;
}
</style>

<script>
// Global state for bulk upload
let parsedData = [];
let validationResults = null;

// Security: escape HTML to prevent XSS (also defined in main script, but needed here for bulk upload)
function escapeHtmlBulk(text) {
    if (!text) return '';
    const str = String(text);
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

// Open bulk upload modal
function openBulkUploadModal() {
    console.log('openBulkUploadModal called');
    const modal = document.getElementById('bulk-upload-modal');
    console.log('Bulk upload modal element:', modal);
    if (modal) {
        // Force the modal to be visible with inline styles
        modal.style.cssText = 'display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; width: 100% !important; height: 100% !important; z-index: 99999 !important; background-color: rgba(0, 0, 0, 0.8) !important; align-items: center !important; justify-content: center !important;';
        
        // Force body overflow hidden to prevent scrolling
        document.body.style.overflow = 'hidden';
        
        resetBulkUpload();
        
        // Also check if the modal content is visible
        const modalContent = modal.querySelector('.modal.bulk-modal');
        console.log('Modal content element:', modalContent);
        if (modalContent) {
            modalContent.style.cssText = 'display: block !important; position: relative !important; z-index: 100000 !important; background: white !important; max-width: 900px !important; width: 90% !important; max-height: 90vh !important; overflow: auto !important;';
            console.log('Modal content styles applied');
        }
        
        // Debug: Check computed styles
        const computedStyle = window.getComputedStyle(modal);
        console.log('Modal computed display:', computedStyle.display);
        console.log('Modal computed z-index:', computedStyle.zIndex);
        console.log('Modal computed position:', computedStyle.position);
        
        // Check if modal is in viewport
        const rect = modal.getBoundingClientRect();
        console.log('Modal position:', rect);
    } else {
        console.error('Bulk upload modal not found!');
    }
}

// Make function available globally
window.openBulkUploadModal = openBulkUploadModal;

// Open bulk upload wells modal
function openBulkUploadWellsModal() {
    const modal = document.getElementById('bulk-upload-wells-modal');
    if (modal) {
        // Force the modal to be visible with inline styles
        modal.style.cssText = 'display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; width: 100% !important; height: 100% !important; z-index: 99999 !important; background-color: rgba(0, 0, 0, 0.8) !important; align-items: center !important; justify-content: center !important;';
        resetBulkUploadWells();
        
        // Also check if the modal content is visible
        const modalContent = modal.querySelector('.modal.bulk-modal');
        if (modalContent) {
            modalContent.style.cssText = 'display: block !important; position: relative !important; z-index: 100000 !important; background: white !important;';
        }
    }
}

// Make function available globally
window.openBulkUploadWellsModal = openBulkUploadWellsModal;

// Close bulk upload modal
function closeBulkUploadModal() {
    document.getElementById('bulk-upload-modal').style.display = 'none';
    document.body.style.overflow = ''; // Restore body scrolling
    resetBulkUpload();
}

// Reset to initial state
function resetBulkUpload() {
    document.getElementById('upload-step').style.display = 'block';
    document.getElementById('preview-step').style.display = 'none';
    document.getElementById('import-step').style.display = 'none';
    document.getElementById('results-step').style.display = 'none';
    document.getElementById('file-info').style.display = 'none';
    document.getElementById('parse-error').style.display = 'none';
    document.getElementById('fileInput').value = '';
    parsedData = [];
    validationResults = null;
}

// Handle file drop
function handleFileDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('dropzone').classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        processFile(files[0]);
    }
}

// Handle drag over
function handleDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('dropzone').classList.add('drag-over');
}

// Handle drag leave
function handleDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('dropzone').classList.remove('drag-over');
}

// Handle file select
function handleFileSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
        processFile(files[0]);
    }
}

// Process uploaded file
async function processFile(file) {
    document.getElementById('filename').textContent = file.name;
    document.getElementById('filesize').textContent = `${(file.size / 1024).toFixed(1)} KB`;
    document.getElementById('file-info').style.display = 'block';
    document.getElementById('parse-error').style.display = 'none';
    
    try {
        // Detect file type
        const extension = file.name.split('.').pop().toLowerCase();
        
        if (extension === 'csv' || extension === 'txt' || extension === 'tsv') {
            // Parse CSV/TSV
            await parseCSV(file);
        } else if (extension === 'xlsx' || extension === 'xls') {
            // Parse Excel
            await parseExcel(file);
        } else {
            throw new Error('Unsupported file type. Please upload CSV or Excel file.');
        }
        
        // If we got here, parsing succeeded
        if (parsedData.length === 0) {
            throw new Error('No data found in file');
        }
        
        // Validate and show preview
        await validateAndPreview();
        
    } catch (error) {
        console.error('File processing error:', error);
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('parse-error').style.display = 'block';
    }
}

// Parse CSV file
async function parseCSV(file) {
    return new Promise((resolve, reject) => {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                if (results.errors.length > 0) {
                    reject(new Error(`CSV parsing error: ${results.errors[0].message}`));
                    return;
                }
                parsedData = results.data;
                resolve();
            },
            error: (error) => {
                reject(new Error(`CSV parsing failed: ${error.message}`));
            }
        });
    });
}

// Parse Excel file
async function parseExcel(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get first sheet
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (jsonData.length === 0) {
                    reject(new Error('Excel file contains no data'));
                    return;
                }
                
                parsedData = jsonData;
                resolve();
            } catch (error) {
                reject(new Error(`Excel parsing failed: ${error.message}`));
            }
        };
        
        reader.onerror = () => {
            reject(new Error('Failed to read file'));
        };
        
        reader.readAsArrayBuffer(file);
    });
}

// Validate and show preview
async function validateAndPreview() {
    try {
        const response = await fetch('/api/bulk-validate-properties', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ properties: parsedData })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Validation failed');
        }
        
        validationResults = await response.json();
        
        // Show preview step
        document.getElementById('upload-step').style.display = 'none';
        document.getElementById('preview-step').style.display = 'block';
        
        // Render summary badges
        renderSummary();
        
        // Render plan check
        renderPlanCheck();
        
        // Render preview table
        renderPreviewTable();
        
    } catch (error) {
        console.error('Validation error:', error);
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('parse-error').style.display = 'block';
    }
}

// Render summary badges
function renderSummary() {
    const summary = validationResults.summary;
    const html = `
        <div class="validation-badge badge-valid">
             ${summary.valid} Valid
        </div>
        ${summary.invalid > 0 ? `
        <div class="validation-badge badge-invalid">
             ${summary.invalid} Invalid
        </div>
        ` : ''}
        ${summary.warnings > 0 ? `
        <div class="validation-badge badge-warning">
             ${summary.warnings} Warnings
        </div>
        ` : ''}
        ${summary.duplicates > 0 ? `
        <div class="validation-badge badge-duplicate">
             ${summary.duplicates} Duplicates
        </div>
        ` : ''}
    `;
    document.getElementById('validation-summary').innerHTML = html;
}

// Render plan check
function renderPlanCheck() {
    const plan = validationResults.planCheck;
    const wouldExceed = plan.wouldExceedLimit;
    
    const html = `
        <div class="plan-check-box ${wouldExceed ? 'exceeded' : 'ok'}">
            <div class="plan-check-header">
                ${wouldExceed ? ' Would Exceed Plan Limit' : ' Within Plan Limit'}
            </div>
            <div class="plan-check-details">
                Current: ${plan.current} properties  
                Adding: ${validationResults.summary.willImport}  
                Total: ${plan.afterUpload} of ${plan.limit} (${plan.plan} plan)
            </div>
        </div>
    `;
    document.getElementById('plan-check').innerHTML = html;
    
    // Disable import button if would exceed
    document.getElementById('import-btn').disabled = wouldExceed;
}

// Render preview table
function renderPreviewTable() {
    const tbody = document.getElementById('preview-table-body');
    let html = '';
    
    validationResults.results.forEach((result, index) => {
        const prop = result.normalized;
        const rowClass = result.isDuplicate ? 'preview-row-duplicate' : 
                        (result.errors.length > 0 ? 'preview-row-error' :
                        (result.warnings.length > 0 ? 'preview-row-warning' : 'preview-row-valid'));
        
        const statusClass = result.isDuplicate ? 'status-cell-duplicate' :
                           (result.errors.length > 0 ? 'status-cell-error' :
                           (result.warnings.length > 0 ? 'status-cell-warning' : 'status-cell-valid'));
        
        const statusText = result.isDuplicate ? ' Duplicate' :
                          (result.errors.length > 0 ? ` ${result.errors[0]}` :
                          (result.warnings.length > 0 ? ` ${result.warnings[0]}` : ' Valid'));
        
        html += `
            <tr class="${rowClass}">
                <td>${index + 1}</td>
                <td>${escapeHtmlBulk(prop.SEC) || '-'}</td>
                <td>${escapeHtmlBulk(prop.TWN) || '-'}</td>
                <td>${escapeHtmlBulk(prop.RNG) || '-'}</td>
                <td>${escapeHtmlBulk(prop.MERIDIAN) || '-'}</td>
                <td>${escapeHtmlBulk(cleanCountyDisplay(prop.COUNTY)) || '-'}</td>
                <td class="status-cell ${statusClass}">
                    ${statusText}
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Start import - with chunking to avoid Worker timeouts
async function startImport() {
    // Show import step
    document.getElementById('preview-step').style.display = 'none';
    document.getElementById('import-step').style.display = 'block';
    
    // Progress tracking
    const progressBar = document.getElementById('progress-bar');
    progressBar.classList.remove('indeterminate');
    
    // Prepare valid properties for upload
    const toImport = validationResults.results
        .filter(r => r.isValid && !r.isDuplicate)
        .map(r => r.normalized);
    
    const CHUNK_SIZE = 50; // Upload 50 at a time to avoid timeouts
    const totalChunks = Math.ceil(toImport.length / CHUNK_SIZE);
    let totalSuccessful = 0;
    let totalFailed = 0;
    let totalErrors = [];
    
    document.getElementById('import-progress').textContent = `Importing ${toImport.length} properties...`;
    
    try {
        // Process chunks sequentially
        for (let i = 0; i < toImport.length; i += CHUNK_SIZE) {
            const chunk = toImport.slice(i, i + CHUNK_SIZE);
            const chunkNumber = Math.floor(i / CHUNK_SIZE) + 1;
            
            // Update progress
            const progress = Math.round((i / toImport.length) * 100);
            progressBar.style.width = `${progress}%`;
            document.getElementById('progress-percent').textContent = `${progress}%`;
            document.getElementById('import-progress').textContent = 
                `Importing batch ${chunkNumber}/${totalChunks} (${i + chunk.length}/${toImport.length} properties)...`;
            
            // Upload chunk
            const response = await fetch('/api/bulk-upload-properties', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ properties: chunk })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || `Batch ${chunkNumber} failed`);
            }
            
            const chunkResults = await response.json();
            totalSuccessful += chunkResults.results.successful;
            totalFailed += chunkResults.results.failed;
            if (chunkResults.results.errors) {
                totalErrors = totalErrors.concat(chunkResults.results.errors);
            }
            
            // Small delay between chunks to avoid overwhelming the server
            if (i + CHUNK_SIZE < toImport.length) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        
        // Show completion
        progressBar.style.width = '100%';
        document.getElementById('progress-percent').textContent = '100%';
        document.getElementById('import-progress').textContent = `${totalSuccessful} of ${toImport.length} properties created`;
        
        // Brief delay to show completion
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Show results
        showResults({
            results: {
                successful: totalSuccessful,
                failed: totalFailed,
                skipped: 0,
                errors: totalErrors
            }
        });
        
    } catch (error) {
        console.error('Upload error:', error);
        showError(error.message);
    }
}

// Show results
function showResults(results) {
    document.getElementById('import-step').style.display = 'none';
    document.getElementById('results-step').style.display = 'block';
    
    const success = results.results.successful;
    const failed = results.results.failed;
    const skipped = results.results.skipped;
    
    // Update stat boxes
    document.getElementById('result-created').textContent = success;
    document.getElementById('result-skipped').textContent = skipped;
    document.getElementById('result-failed').textContent = failed;
    
    if (failed === 0) {
        document.getElementById('results-icon').textContent = '';
        document.getElementById('results-title').textContent = 'Import Complete!';
        document.getElementById('results-details').textContent = 'Your properties are now being monitored for OCC activity.';
    } else {
        document.getElementById('results-icon').textContent = '';
        document.getElementById('results-title').textContent = 'Import Completed with Errors';
        document.getElementById('results-details').textContent = 'Some properties could not be imported. Check your file and try again.';
    }
}

// Show error
function showError(message) {
    document.getElementById('import-step').style.display = 'none';
    document.getElementById('results-step').style.display = 'block';
    document.getElementById('results-icon').textContent = '';
    document.getElementById('results-title').textContent = 'Import Failed';
    
    // Clear stat boxes
    document.getElementById('result-created').textContent = '0';
    document.getElementById('result-skipped').textContent = '0';
    document.getElementById('result-failed').textContent = '';
    
    document.getElementById('results-details').textContent = message;
}

// Finish and close
async function finishBulkUpload() {
    closeBulkUploadModal();
    // Reload properties
    await loadProperties();

    // Auto re-link documents after property import
    // This links any documents that were uploaded before these properties existed
    try {
        const res = await fetch('/api/documents/relink', { method: 'POST' });
        if (res.ok) {
            const result = await res.json();
            if (result.linked > 0) {
                showToast(`Auto-linked ${result.linked} document${result.linked > 1 ? 's' : ''} to your new properties`, 'success');
            }
        }
    } catch (e) {
        console.log('Auto-relink after property import:', e);
    }
}

// ==========================================
// WELLS BULK UPLOAD FUNCTIONS
// ==========================================

let wellsParsedData = [];
let wellsValidationResults = null;

// Close wells modal
function closeBulkUploadWellsModal() {
    document.getElementById('bulk-upload-wells-modal').style.display = 'none';
    resetBulkUploadWells();
}

// Reset wells modal
function resetBulkUploadWells() {
    document.getElementById('wells-upload-step').style.display = 'block';
    document.getElementById('wells-preview-step').style.display = 'none';
    document.getElementById('wells-import-step').style.display = 'none';
    document.getElementById('wells-results-step').style.display = 'none';
    document.getElementById('wells-file-info').style.display = 'none';
    document.getElementById('wells-parse-error').style.display = 'none';
    document.getElementById('wellsFileInput').value = '';
    wellsParsedData = [];
    wellsValidationResults = null;
}

// Handle wells file drop
function handleWellsFileDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('wells-dropzone').classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        processWellsFile(files[0]);
    }
}

function handleWellsDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('wells-dropzone').classList.add('drag-over');
}

function handleWellsDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('wells-dropzone').classList.remove('drag-over');
}

function handleWellsFileSelect(e) {
    const files = e.target.files;
    if (files.length > 0) {
        processWellsFile(files[0]);
    }
}

// Process wells file
async function processWellsFile(file) {
    document.getElementById('wells-filename').textContent = file.name;
    document.getElementById('wells-filesize').textContent = `${(file.size / 1024).toFixed(1)} KB`;
    document.getElementById('wells-file-info').style.display = 'flex';
    document.getElementById('wells-parse-error').style.display = 'none';
    
    try {
        const extension = file.name.split('.').pop().toLowerCase();
        
        if (extension === 'csv' || extension === 'txt' || extension === 'tsv') {
            await parseWellsCSV(file);
        } else if (extension === 'xlsx' || extension === 'xls') {
            await parseWellsExcel(file);
        } else {
            throw new Error('Unsupported file type');
        }
        
        if (wellsParsedData.length === 0) {
            throw new Error('No data found in file');
        }
        
        // Check if file is very large
        if (wellsParsedData.length > 2000) {
            throw new Error('File too large. Please limit to 2000 wells per import.');
        }
        
        // Show info about batch processing for large files
        if (wellsParsedData.length > 200) {
            const batchCount = Math.ceil(wellsParsedData.length / 25);
            document.getElementById('wells-file-info').innerHTML += 
                `<span style="color: #f59e0b; font-size: 12px; margin-left: 10px;">
                    Large file: Will process in ${batchCount} batches of 25
                </span>`;
        }
        
        await validateAndPreviewWells();
        
    } catch (error) {
        console.error('Wells file processing error:', error);
        document.getElementById('wells-error-message').textContent = error.message;
        document.getElementById('wells-parse-error').style.display = 'block';
    }
}

// Parse CSV for wells
async function parseWellsCSV(file) {
    return new Promise((resolve, reject) => {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                wellsParsedData = results.data;
                resolve();
            },
            error: (error) => reject(error)
        });
    });
}

// Parse Excel for wells
async function parseWellsExcel(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                wellsParsedData = XLSX.utils.sheet_to_json(firstSheet);
                resolve();
            } catch (err) {
                reject(err);
            }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
    });
}

// Store batch processing state
let cancelBatchProcessing = false;
let batchProgressInterval = null;

// Validate and preview wells with batch processing for large files
async function validateAndPreviewWells() {
    try {
        const totalRows = wellsParsedData.length;
        const BATCH_SIZE = 25; // Reduced from 50 to avoid timeouts
        
        // Show progress UI for large files
        if (totalRows > 200) {
            showBatchProgress(totalRows);
        }
        
        // For files <= 200 rows, process normally
        if (totalRows <= 200) {
            const response = await fetch('/api/bulk-validate-wells', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ wells: wellsParsedData })
            });
            
            if (!response.ok) {
                let errorMessage = 'Validation failed';
                try {
                    const error = await response.json();
                    errorMessage = error.error || errorMessage;
                } catch (e) {
                    // Response wasn't JSON (probably HTML error page)
                    errorMessage = `Server error (${response.status}). The file may be too large or complex. Try a smaller batch.`;
                }
                throw new Error(errorMessage);
            }
            
            wellsValidationResults = await response.json();
        } else {
            // Process in batches for large files
            wellsValidationResults = {
                results: [],
                summary: {
                    total: 0,
                    exactMatches: 0,
                    needsReview: 0,
                    notFound: 0,
                    hasApi: 0,
                    duplicates: 0,
                    willImport: 0,
                    canImport: false
                },
                planCheck: null
            };
            
            for (let i = 0; i < totalRows; i += BATCH_SIZE) {
                if (cancelBatchProcessing) {
                    throw new Error('Validation cancelled by user');
                }
                
                const batch = wellsParsedData.slice(i, Math.min(i + BATCH_SIZE, totalRows));
                const batchNum = Math.floor(i / BATCH_SIZE) + 1;
                const totalBatches = Math.ceil(totalRows / BATCH_SIZE);
                
                updateBatchProgress(i, totalRows, `Processing batch ${batchNum}/${totalBatches}...`);
                
                console.log(`[BulkValidate] Sending batch ${batchNum} with ${batch.length} wells`);
                console.log('[BulkValidate] First well in batch:', batch[0]);
                
                const response = await fetch('/api/bulk-validate-wells', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wells: batch })
                });
                
                if (!response.ok) {
                    let errorMessage = `Batch ${batchNum} failed`;
                    try {
                        const error = await response.json();
                        errorMessage = error.error || errorMessage;
                    } catch (e) {
                        errorMessage = `Batch ${batchNum} failed (${response.status}). Try reducing file size.`;
                    }
                    throw new Error(errorMessage);
                }
                
                const batchResult = await response.json();
                
                // Merge batch results
                wellsValidationResults.results = wellsValidationResults.results.concat(batchResult.results);
                wellsValidationResults.summary.total += batchResult.summary.total;
                wellsValidationResults.summary.exactMatches += batchResult.summary.exactMatches;
                wellsValidationResults.summary.needsReview += batchResult.summary.needsReview;
                wellsValidationResults.summary.notFound += batchResult.summary.notFound;
                wellsValidationResults.summary.hasApi += batchResult.summary.hasApi;
                wellsValidationResults.summary.duplicates += batchResult.summary.duplicates;
                wellsValidationResults.summary.willImport += batchResult.summary.willImport;
                
                // Use last batch's plan check (most accurate)
                wellsValidationResults.planCheck = batchResult.planCheck;
                
                // Longer pause between batches to avoid rate limiting
                if (i + BATCH_SIZE < totalRows) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            wellsValidationResults.summary.canImport = wellsValidationResults.summary.willImport > 0 && 
                                                       !wellsValidationResults.planCheck.wouldExceedLimit;
        }
        
        hideBatchProgress();
        
        document.getElementById('wells-upload-step').style.display = 'none';
        document.getElementById('wells-preview-step').style.display = 'block';
        
        renderWellsSummary();
        renderWellsPlanCheck();
        renderWellsPreviewTable();
        updateImportButtonState();
        
    } catch (error) {
        console.error('Wells validation error:', error);
        hideBatchProgress();
        document.getElementById('wells-error-message').textContent = error.message;
        document.getElementById('wells-parse-error').style.display = 'block';
    }
}

// Show batch processing progress
function showBatchProgress(totalRows) {
    cancelBatchProcessing = false;
    
    const html = `
        <div class="bulk-section" id="batch-progress-section">
            <h3 style="margin-bottom: 16px;">Processing ${totalRows} wells in batches...</h3>
            <div class="progress-bar-track" style="margin-bottom: 12px;">
                <div class="progress-bar-fill" id="batch-progress-bar" style="width: 0%;"></div>
            </div>
            <div class="progress-count" id="batch-progress-text">Starting...</div>
            <button class="btn-secondary" style="margin-top: 16px;" onclick="cancelBatchValidation()">Cancel</button>
        </div>
    `;
    
    // Insert progress UI at the top of upload step
    const uploadStep = document.getElementById('wells-upload-step');
    const firstSection = uploadStep.querySelector('.bulk-section');
    firstSection.insertAdjacentHTML('beforebegin', html);
}

// Update batch progress
function updateBatchProgress(current, total, message) {
    const percent = Math.round((current / total) * 100);
    document.getElementById('batch-progress-bar').style.width = `${percent}%`;
    document.getElementById('batch-progress-text').textContent = `${message} (${current}/${total} wells - ${percent}%)`;
}

// Hide batch progress
function hideBatchProgress() {
    const progressSection = document.getElementById('batch-progress-section');
    if (progressSection) {
        progressSection.remove();
    }
}

// Cancel batch validation
function cancelBatchValidation() {
    cancelBatchProcessing = true;
    hideBatchProgress();
}

// Render wells summary badges with enhanced status
function renderWellsSummary() {
    const summary = wellsValidationResults.summary;
    let badges = [];
    
    // Show different badges based on match types
    if (summary.hasApi > 0) badges.push(`<div class="validation-badge badge-valid"> ${summary.hasApi} Direct API</div>`);
    if (summary.exactMatches > 0) badges.push(`<div class="validation-badge badge-valid"> ${summary.exactMatches} Exact Match</div>`);
    if (summary.needsReview > 0) badges.push(`<div class="validation-badge badge-warning"> ${summary.needsReview} Need Review</div>`);
    if (summary.notFound > 0) badges.push(`<div class="validation-badge badge-invalid"> ${summary.notFound} Not Found</div>`);
    if (summary.duplicates > 0) badges.push(`<div class="validation-badge badge-duplicate"> ${summary.duplicates} Already Tracked</div>`);
    
    document.getElementById('wells-validation-summary').innerHTML = badges.join(' ');
}

// Render wells plan check
function renderWellsPlanCheck() {
    const plan = wellsValidationResults.planCheck;
    const wouldExceed = plan.wouldExceedLimit;
    
    const html = `
        <div class="plan-check-box ${wouldExceed ? 'exceeded' : 'ok'}">
            <div class="plan-check-header">
                ${wouldExceed ? ' Would Exceed Plan Limit' : ' Within Plan Limit'}
            </div>
            <div class="plan-check-details">
                Current: ${plan.current} wells  
                Adding: ${wellsValidationResults.summary.willImport}  
                Total: ${plan.afterUpload} of ${plan.limit} (${plan.plan} plan)
            </div>
        </div>
    `;
    document.getElementById('wells-plan-check').innerHTML = html;
    document.getElementById('wells-import-btn').disabled = wouldExceed;
}

// Render enhanced wells preview table with search results
function renderWellsPreviewTable() {
    const tbody = document.getElementById('wells-preview-table-body');
    let html = '';
    wellsSelections = {}; // Reset selections
    
    wellsValidationResults.results.forEach((result, index) => {
        // Determine row styling based on match status
        let rowClass = 'preview-row-valid';
        let statusIcon = '';
        let statusText = 'Ready';
        
        if (result.matchStatus === 'not_found' || result.errors.length > 0) {
            rowClass = 'preview-row-error';
            statusIcon = '';
            statusText = result.errors[0] || 'Not found';
        } else if (result.matchStatus === 'ambiguous') {
            rowClass = 'preview-row-warning';
            statusIcon = '';
            statusText = 'Select';
        } else if (result.isDuplicate) {
            rowClass = 'preview-row-duplicate';
            statusIcon = '';
            statusText = 'Tracked';
        } else if (result.matchStatus === 'exact') {
            statusIcon = '';
            statusText = 'Matched';
        }
        
        // Build CSV data display
        const csvData = [];
        const orig = result.original;
        
        // Extract well name and number with same priority as search function
        // Priority 1: Use WELL_NAME + WELL_NUM (separate fields to combine)
        const wellName = orig.WELL_NAME || orig['Well_Name'] || orig['Well Name'] || 
                        orig.well_name || orig.WellName || orig.wellName || '';
        const wellNumber = orig.WELL_NUM || orig['Well_Num'] || orig['WELL_NUMBER'] || 
                          orig['Well Number'] || orig['well_number'] || orig.WellNumber || 
                          orig.wellNumber || orig.well_num || '';
        
        // Priority logic for well name:
        // 1. If we have separate name and number, combine them
        // 2. Otherwise use 'WELL Name & Number' if available  
        // 3. Do NOT use 'WELL NAME COMBINED' as it includes operator
        let fullWellName = '';
        if (wellName && wellNumber) {
            fullWellName = `${wellName.trim()} ${wellNumber.trim()}`.trim();
        } else {
            fullWellName = orig['WELL Name & Number'] || orig['Well Name & Number'] || wellName || '';
        }
        
        if (fullWellName) csvData.push(`Well: ${fullWellName}`);
        if (orig.Operator || orig.operator || orig.OPERATOR) csvData.push(`Op: ${orig.Operator || orig.operator || orig.OPERATOR}`);
        
        const county = orig.County || orig.county || orig.COUNTY || '';
        if (county) csvData.push(`County: ${county}`);
        
        // Add location with meridian
        if ((orig.Section || orig.SECTION) && (orig.Township || orig.TOWNSHIP) && (orig.Range || orig.RANGE)) {
            // Determine meridian based on county
            const panhandleCounties = ['CIMARRON', 'TEXAS', 'BEAVER'];
            const meridian = county && panhandleCounties.includes(county.toUpperCase()) ? 'CM' : 'IM';
            csvData.push(`Loc: S${orig.Section || orig.SECTION}-T${orig.Township || orig.TOWNSHIP}-R${orig.Range || orig.RANGE}-${meridian}`);
        }
        const csvDisplay = csvData.join(', ') || 'No search data';
        
        // Build matched well display
        let matchedWellHtml = '-';
        let apiNumberHtml = '-';
        let actionHtml = '';
        
        if (result.matchStatus === 'has_api' && result.normalized) {
            matchedWellHtml = escapeHtmlBulk(result.normalized.wellName || 'API provided');
            apiNumberHtml = escapeHtmlBulk(result.normalized.apiNumber);
            actionHtml = result.isDuplicate ? '<span style="color: #6b7280;">Already tracked</span>' : '<span style="color: #22c55e;"> Will add</span>';
        } else if (result.matchStatus === 'exact' && result.searchResults) {
            const match = result.searchResults.matches[0];
            matchedWellHtml = escapeHtmlBulk(match.well_name || '-') + (match.well_number ? ' ' + escapeHtmlBulk(match.well_number) : '');
            apiNumberHtml = escapeHtmlBulk(match.api_number);
            actionHtml = result.isDuplicate ? '<span style="color: #6b7280;">Already tracked</span>' : '<span style="color: #22c55e;"> Will add</span>';
        } else if (result.matchStatus === 'ambiguous' && result.searchResults) {
            // Create dropdown for ambiguous matches
            const selectId = `well-select-${index}`;
            matchedWellHtml = `
                <select id="${selectId}" class="bulk-well-select" onchange="updateWellSelection(${index}, this.value)" style="max-width: 300px;">
                    <option value=""> Select well (${result.searchResults.total} matches) </option>
                    <option value="SKIP"> Skip this well </option>
                    ${result.searchResults.matches.map(m => 
                        `<option value="${m.api_number}">${escapeHtmlBulk(m.well_name)}${m.well_number ? ' ' + escapeHtmlBulk(m.well_number) : ''} - ${m.api_number} - ${m.operator || 'Unknown Op'} - S${m.section}-T${m.township}-R${m.range} - ${m.county} - ${m.well_status || 'UNK'}</option>`
                    ).join('')}
                </select>
            `;
            apiNumberHtml = '<span id="api-' + index + '">-</span>';
            actionHtml = '<span id="action-' + index + '" style="color: #f59e0b;">Select well</span>';
        } else if (result.matchStatus === 'not_found') {
            actionHtml = '<span style="color: #ef4444;">Skip</span>';
        }
        
        html += `
            <tr class="${rowClass}">
                <td>${result.row}</td>
                <td class="status-cell"><span style="font-size: 16px;">${statusIcon}</span></td>
                <td style="font-size: 12px; color: #64748b;">${escapeHtmlBulk(csvDisplay)}</td>
                <td>${matchedWellHtml}</td>
                <td style="font-family: monospace; font-size: 12px;">${apiNumberHtml}</td>
                <td>${actionHtml}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // Show quick actions for files with ambiguous matches
    const hasAmbiguous = wellsValidationResults.results.some(r => r.matchStatus === 'ambiguous');
    if (hasAmbiguous) {
        document.getElementById('wells-quick-actions').style.display = 'block';
    }
}

// Track well selections for ambiguous matches
let wellsSelections = {};

// Update well selection
function updateWellSelection(index, apiNumber) {
    if (apiNumber === 'SKIP') {
        wellsSelections[index] = 'SKIP';
        // Update the display for skipped wells
        document.getElementById(`api-${index}`).textContent = '';
        document.getElementById(`action-${index}`).innerHTML = '<span style="color: #6b7280;">Skip</span>';
    } else if (apiNumber) {
        wellsSelections[index] = apiNumber;
        // Update the API and action display
        document.getElementById(`api-${index}`).textContent = apiNumber;
        document.getElementById(`action-${index}`).innerHTML = '<span style="color: #22c55e;"> Will add</span>';
    } else {
        delete wellsSelections[index];
        document.getElementById(`api-${index}`).textContent = '-';
        document.getElementById(`action-${index}`).innerHTML = '<span style="color: #f59e0b;">Select well</span>';
    }
    
    // Update import button state
    updateImportButtonState();
}

// Select all exact matches for quick import
function selectAllExactMatches() {
    wellsValidationResults.results.forEach((result, index) => {
        if (result.matchStatus === 'ambiguous' && result.searchResults && result.searchResults.matches.length > 0) {
            // Auto-select the first match
            const firstMatch = result.searchResults.matches[0];
            const selectEl = document.getElementById(`well-select-${index}`);
            if (selectEl && selectEl.value === '') {
                selectEl.value = firstMatch.api_number;
                updateWellSelection(index, firstMatch.api_number);
            }
        }
    });
}

// Update import button based on selections
function updateImportButtonState() {
    const summary = wellsValidationResults.summary;
    const needsReview = wellsValidationResults.results.filter(r => r.matchStatus === 'ambiguous' && !r.isDuplicate);
    const selectedCount = Object.keys(wellsSelections).length;
    const allSelected = selectedCount >= needsReview.length;
    
    // Only allow import if all ambiguous wells have selections
    const canImport = summary.canImport && (needsReview.length === 0 || allSelected);
    const btn = document.getElementById('wells-import-btn');
    
    // Update button text to show pending selections
    const pendingSelections = needsReview.length - selectedCount;
    if (pendingSelections > 0) {
        btn.textContent = `Select ${pendingSelections} wells to continue`;
    } else {
        btn.textContent = 'Import Wells';
    }
    
    if (canImport) {
        btn.disabled = false;
        const totalToImport = summary.exactMatches + summary.hasApi + selectedCount;
        btn.textContent = `Import ${totalToImport} Wells`;
    } else if (needsReview.length > selectedCount) {
        btn.disabled = true;
        btn.textContent = `Select ${needsReview.length - selectedCount} more wells`;
    } else {
        btn.disabled = true;
        btn.textContent = 'Import Wells';
    }
}

// Start wells import
async function startWellsImport() {
    document.getElementById('wells-preview-step').style.display = 'none';
    document.getElementById('wells-import-step').style.display = 'block';
    
    // Progress tracking
    const progressBar = document.getElementById('wells-progress-bar');
    progressBar.classList.remove('indeterminate');
    
    // Count total wells to import (excluding skipped)
    const summary = wellsValidationResults.summary;
    const skippedSelections = Object.values(wellsSelections).filter(v => v === 'SKIP').length;
    const totalToImport = summary.exactMatches + summary.hasApi + Object.keys(wellsSelections).length - skippedSelections;
    
    document.getElementById('wells-import-progress').textContent = `Processing ${totalToImport} wells...`;
    
    // Simulate progress since we can't get real-time updates from backend
    let simulatedProgress = 0;
    const progressInterval = setInterval(() => {
        simulatedProgress = Math.min(simulatedProgress + Math.random() * 15, 90);
        progressBar.style.width = simulatedProgress + '%';
        
        // Update message based on progress
        if (simulatedProgress < 30) {
            document.getElementById('wells-import-progress').textContent = `Validating ${totalToImport} wells...`;
        } else if (simulatedProgress < 60) {
            document.getElementById('wells-import-progress').textContent = `Fetching well data from OCC...`;
        } else {
            document.getElementById('wells-import-progress').textContent = `Creating well records...`;
        }
    }, 500);
    
    try {
        // Send all validation results with selections
        const response = await fetch('/api/bulk-upload-wells', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                wells: wellsValidationResults.results,
                selections: wellsSelections 
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Upload failed');
        }
        
        const results = await response.json();
        
        // Clear the progress simulation
        clearInterval(progressInterval);
        
        // Update progress to 100%
        progressBar.style.width = '100%';
        document.getElementById('wells-import-progress').textContent = 'Processing complete!';
        
        // Brief delay to show completion
        await new Promise(resolve => setTimeout(resolve, 500));
        
        showWellsResults(results);
        
        // Auto-refresh wells in the background if import was successful
        if (results.results.successful > 0) {
            console.log(`Auto-refreshing wells after importing ${results.results.successful} wells`);
            loadWells();
        }
        
    } catch (error) {
        // Clear the progress simulation on error too
        clearInterval(progressInterval);
        console.error('Wells upload error:', error);
        showWellsError(error.message);
    }
}

// Show wells results
function showWellsResults(results) {
    document.getElementById('wells-import-step').style.display = 'none';
    document.getElementById('wells-results-step').style.display = 'block';
    
    const success = results.results.successful;
    const failed = results.results.failed;
    const skipped = results.results.skipped;
    
    document.getElementById('wells-result-created').textContent = success;
    document.getElementById('wells-result-skipped').textContent = skipped;
    document.getElementById('wells-result-failed').textContent = failed;
    
    // Update the well count in the tab immediately
    if (success > 0) {
        const currentCount = parseInt(document.getElementById('wellCount').textContent) || 0;
        document.getElementById('wellCount').textContent = currentCount + success;
        updateTotalCount();
    }
    
    if (failed === 0 && skipped === 0) {
        document.getElementById('wells-results-icon').textContent = '';
        document.getElementById('wells-results-title').textContent = 'Import Complete!';
        document.getElementById('wells-results-details').textContent = 'Your wells are now being monitored for OCC activity.';
    } else if (failed === 0 && skipped > 0) {
        document.getElementById('wells-results-icon').textContent = '';
        document.getElementById('wells-results-title').textContent = 'Import Completed';
        document.getElementById('wells-results-details').textContent = `${success} wells added successfully. ${skipped} wells were skipped (duplicates, invalid, or no selection made for ambiguous matches).`;
    } else {
        document.getElementById('wells-results-icon').textContent = '';
        document.getElementById('wells-results-title').textContent = 'Import Completed with Errors';
        document.getElementById('wells-results-details').textContent = 'Some wells could not be imported.';
    }
}

// Show wells error
function showWellsError(message) {
    document.getElementById('wells-import-step').style.display = 'none';
    document.getElementById('wells-results-step').style.display = 'block';
    document.getElementById('wells-results-icon').textContent = '';
    document.getElementById('wells-results-title').textContent = 'Import Failed';
    document.getElementById('wells-result-created').textContent = '0';
    document.getElementById('wells-result-skipped').textContent = '0';
    document.getElementById('wells-result-failed').textContent = '';
    document.getElementById('wells-results-details').textContent = message;
}

// Finish wells upload
async function finishBulkUploadWells() {
    closeBulkUploadWellsModal();
    await loadWells();

    // Auto re-link documents after wells import
    try {
        const res = await fetch('/api/documents/relink', { method: 'POST' });
        if (res.ok) {
            const result = await res.json();
            if (result.linked > 0) {
                showToast(`Auto-linked ${result.linked} document${result.linked > 1 ? 's' : ''} to your new wells`, 'success');
            }
        }
    } catch (e) {
        console.log('Auto-relink after wells import:', e);
    }
}

// Document Upload Functions
let selectedFiles = [];

function openUploadModal() {
    console.log('openUploadModal called');
    console.log('Modal element exists?', !!document.getElementById('documentUploadModal'));
    console.log('selectedFilesList exists?', !!document.getElementById('selectedFilesList'));
    
    // Reset all modal state
    clearSelectedFile();
    
    // Check if user has credits available
    if (currentUsageStats) {
        const availableCredits = currentUsageStats.usage.total_available || 0;
        if (availableCredits === 0) {
            // Show out of credits modal instead
            showOutOfCreditsModal();
            return;
        }
    }

    // Reset form visibility (in case it was hidden during upload)
    document.getElementById('documentUploadForm').style.display = 'block';
    document.getElementById('uploadProgress').style.display = 'none';

    // Reset drop zone to default state
    const dropZone = document.getElementById('fileDropZone');
    dropZone.style.borderColor = 'var(--border)';
    dropZone.style.background = '#f8f9fa';

    // Update available credits display if we have usage stats
    if (currentUsageStats) {
        const availableCredits = currentUsageStats.usage.total_available || 0;
        document.getElementById('availableCreditsInModal').textContent = availableCredits;
    }

    // Reset file input
    document.getElementById('documentFileInput').value = '';

    // Reset selected files display
    document.getElementById('selectedFilesDisplay').style.display = 'none';
    // Clear only the list content, not the entire container
    const filesList = document.getElementById('selectedFilesList');
    if (filesList) {
        filesList.innerHTML = '';
    }

    // Make sure upload button is disabled
    const uploadBtn = document.getElementById('uploadBtn');
    if (uploadBtn) {
        uploadBtn.disabled = true;
    }

    // Show modal
    document.getElementById('documentUploadModal').style.display = 'flex';
}
window.openUploadModal = openUploadModal;

function showOutOfCreditsModal() {
    const usage = currentUsageStats?.usage;
    const isLifetimeTier = usage?.is_lifetime_tier;

    // Update message based on tier
    const messageEl = document.getElementById('outOfCreditsMessage');
    if (isLifetimeTier) {
        messageEl.textContent = "You've used all your free trial credits. Upgrade to a paid plan to continue processing documents.";
    } else {
        messageEl.textContent = "You've used all your available credits this month. Purchase a credit pack or wait for your monthly reset.";
    }

    // Update reset info for paid tiers
    const resetInfo = document.getElementById('creditResetInfo');
    if (!isLifetimeTier && usage?.reset_date) {
        const resetDate = new Date(usage.reset_date);
        const resetDateStr = resetDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
        resetInfo.textContent = `Your monthly credits reset on ${resetDateStr}`;
        resetInfo.style.display = 'block';
    } else {
        resetInfo.style.display = 'none';
    }

    document.getElementById('outOfCreditsModal').style.display = 'flex';
}
window.showOutOfCreditsModal = showOutOfCreditsModal;

function closeOutOfCreditsModal() {
    document.getElementById('outOfCreditsModal').style.display = 'none';
}
window.closeOutOfCreditsModal = closeOutOfCreditsModal;

function openCreditPackModal() {
    document.getElementById('creditPackModal').style.display = 'flex';
}
window.openCreditPackModal = openCreditPackModal;

function closeCreditPackModal() {
    document.getElementById('creditPackModal').style.display = 'none';
}
window.closeCreditPackModal = closeCreditPackModal;

async function purchaseCreditPack(priceId) {
    try {
        // Show loading state
        const cards = document.querySelectorAll('.credit-pack-card');
        cards.forEach(card => {
            card.style.pointerEvents = 'none';
            card.style.opacity = '0.6';
        });

        const response = await fetch('/api/documents/checkout/credit-pack', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ priceId })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create checkout session');
        }

        const { url } = await response.json();

        // Redirect to Stripe Checkout
        window.location.href = url;
    } catch (error) {
        console.error('Error purchasing credit pack:', error);
        showToast('Failed to start checkout: ' + error.message, 'error');

        // Reset loading state
        const cards = document.querySelectorAll('.credit-pack-card');
        cards.forEach(card => {
            card.style.pointerEvents = '';
            card.style.opacity = '';
        });
    }
}
window.purchaseCreditPack = purchaseCreditPack;

// Close credit pack modal when clicking outside
document.getElementById('creditPackModal')?.addEventListener('click', e => {
    if (e.target.id === 'creditPackModal') closeCreditPackModal();
});

function closeUploadModal() {
    document.getElementById('documentUploadModal').style.display = 'none';
    clearSelectedFile();
}
window.closeUploadModal = closeUploadModal;

function handleDocumentDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.style.borderColor = 'var(--red-dirt)';
    e.currentTarget.style.background = '#FEF3C7';
}

function handleDocumentDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.style.borderColor = 'var(--border)';
    e.currentTarget.style.background = '#f8f9fa';
}

function handleDocumentFileDrop(e) {
    console.log('handleDocumentFileDrop fired', e.dataTransfer.files.length, 'files');
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.style.borderColor = 'var(--border)';
    e.currentTarget.style.background = '#f8f9fa';
    
    const files = Array.from(e.dataTransfer.files);
    console.log('Files array:', files);
    processSelectedFiles(files);
}

function handleDocumentFileSelect(e) {
    const files = Array.from(e.target.files);
    processSelectedFiles(files);
}

function processSelectedFiles(files) {
    console.log('processSelectedFiles called with', files.length, 'files');
    // Filter and validate files
    const validFiles = [];
    const errors = [];
    
    // Allowed file types
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/tiff'];

    for (const file of files) {
        if (!allowedTypes.includes(file.type)) {
            errors.push(`${file.name}: Only PDF, JPEG, PNG, and TIFF files are allowed`);
            continue;
        }

        if (file.size > 50 * 1024 * 1024) {
            errors.push(`${file.name}: File size must be less than 50MB`);
            continue;
        }
        
        validFiles.push(file);
    }
    
    // Check total file limit
    if (validFiles.length > 500) {
        alert('Maximum 500 files can be uploaded at once');
        validFiles.splice(500);
    }
    
    // Check total size limit (500MB)
    const totalSize = validFiles.reduce((sum, file) => sum + file.size, 0);
    const maxTotalSize = 500 * 1024 * 1024; // 500MB
    
    if (totalSize > maxTotalSize) {
        alert(`Total file size exceeds 500MB limit. Current total: ${(totalSize / 1024 / 1024).toFixed(1)}MB`);
        // Remove files from the end until we're under the limit
        while (validFiles.length > 0 && validFiles.reduce((sum, file) => sum + file.size, 0) > maxTotalSize) {
            validFiles.pop();
        }
    }
    
    if (errors.length > 0) {
        alert('Some files were not added:\n' + errors.join('\n'));
    }
    
    if (validFiles.length > 0) {
        selectedFiles = validFiles;
        displaySelectedFiles();
    }
}

async function displaySelectedFiles() {
    console.log('displaySelectedFiles called with', selectedFiles.length, 'files');
    const listDiv = document.getElementById('selectedFilesList');
    console.log('selectedFilesList element:', listDiv);
    console.log('Document ready state:', document.readyState);
    console.log('Document body contains:', document.body.innerHTML.includes('selectedFilesList'));
    console.log('Modal visible?', document.getElementById('documentUploadModal').style.display);

    if (!listDiv) {
        console.warn('selectedFilesList element not found');
        console.log('Trying to find parent selectedFilesDisplay:', document.getElementById('selectedFilesDisplay'));
        return;
    }
    listDiv.innerHTML = '';

    // Show loading state for credit estimation
    document.getElementById('selectedFilesDisplay').style.display = 'block';
    document.getElementById('uploadBtn').disabled = selectedFiles.length === 0;

    if (selectedFiles.length > 0) {
        document.getElementById('creditEstimation').style.display = 'block';
        document.getElementById('totalPages').textContent = 'counting...';
        document.getElementById('estimatedCredits').textContent = '...';
    }

    // Calculate total pages using pdf.js for accurate page counts
    let totalPages = 0;
    const pageEstimates = [];

    // Process each file and get actual page count
    for (let index = 0; index < selectedFiles.length; index++) {
        const file = selectedFiles[index];
        let pageCount = 1; // Default fallback

        // Use pdf.js to get actual page count for PDFs, images are always 1 page
        if (file.type === 'application/pdf' && typeof pdfjsLib !== 'undefined') {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                pageCount = pdf.numPages;
                console.log(`PDF ${file.name}: ${pageCount} pages (actual)`);
            } catch (err) {
                console.warn(`Could not read PDF ${file.name}, using fallback estimate:`, err);
                // Fallback: rough estimate of 1 page per 100KB
                pageCount = Math.max(1, Math.ceil(file.size / (100 * 1024)));
            }
        } else if (file.type.startsWith('image/')) {
            // Images are always 1 page
            pageCount = 1;
            console.log(`Image ${file.name}: 1 page`);
        } else {
            // Unknown type: use rough estimate
            pageCount = Math.max(1, Math.ceil(file.size / (100 * 1024)));
        }

        pageEstimates.push(pageCount);
        totalPages += pageCount;

        // Build file display element
        const fileDiv = document.createElement('div');
        fileDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--success-bg); border: 1px solid var(--success); border-radius: 4px; margin-bottom: 8px;';

        const fileName = document.createElement('span');
        fileName.textContent = `${file.name} (${pageCount} pg, ${(file.size / 1024 / 1024).toFixed(1)}MB)`;
        fileName.style.cssText = 'font-size: 14px; color: var(--oil-navy);';

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.onclick = () => removeFile(index);
        removeBtn.style.cssText = 'background: none; border: none; color: var(--red-dirt); cursor: pointer;';
        removeBtn.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';

        fileDiv.appendChild(fileName);
        fileDiv.appendChild(removeBtn);
        listDiv.appendChild(fileDiv);
    }

    // Calculate and display credit estimation
    if (selectedFiles.length > 0) {
        // Calculate credits: Math.ceil(pages / 30)
        const estimatedCredits = Math.ceil(totalPages / 30);

        document.getElementById('estimatedCredits').textContent = estimatedCredits;
        document.getElementById('totalPages').textContent = totalPages;

        // Update available credits from current usage stats
        if (currentUsageStats) {
            const availableCredits = currentUsageStats.usage.total_available || 0;
            document.getElementById('availableCreditsInModal').textContent = availableCredits;

            // Show warning if estimated > available
            const warning = document.getElementById('creditWarning');
            if (estimatedCredits > availableCredits) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }
    } else {
        document.getElementById('creditEstimation').style.display = 'none';
    }
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    if (selectedFiles.length === 0) {
        clearSelectedFile();
    } else {
        displaySelectedFiles();
    }
}

function clearSelectedFile() {
    selectedFiles = [];
    const fileInput = document.getElementById('documentFileInput');
    if (fileInput) {
        fileInput.value = '';
    }
    document.getElementById('selectedFilesDisplay').style.display = 'none';
    document.getElementById('creditEstimation').style.display = 'none';
    const uploadBtn = document.getElementById('uploadBtn');
    if (uploadBtn) {
        uploadBtn.disabled = true;
    }
}

async function handleDocumentUpload(e) {
    e.preventDefault();
    
    if (!selectedFiles.length) return;
    
    // Show progress
    document.getElementById('documentUploadForm').style.display = 'none';
    document.getElementById('uploadProgress').style.display = 'block';
    
    const formData = new FormData();
    
    // Use multi-file endpoint if multiple files, otherwise single file endpoint
    if (selectedFiles.length === 1) {
        formData.append('file', selectedFiles[0]);
        
        try {
            const response = await fetch('/api/documents/upload', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Upload failed');
            }
            
            // Close modal and refresh documents list
            closeUploadModal();
            await loadDocuments();

            // Refresh credit display after upload
            loadUsageStats();

            // Trigger debounced polling
            onDocumentUploaded();
        } catch (error) {
            alert('Upload failed: ' + error.message);
            // Reset modal
            document.getElementById('documentUploadForm').style.display = 'block';
            document.getElementById('uploadProgress').style.display = 'none';
        }
    } else {
        // Multiple files
        for (const file of selectedFiles) {
            formData.append('files', file);
        }
        
        try {
            const response = await fetch('/api/documents/upload-multiple', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Upload failed');
            }
            
            const result = await response.json();
            
            // Show results
            let message = `Uploaded: ${result.uploaded} files`;
            if (result.failed > 0) {
                message += `\nFailed: ${result.failed} files`;
                if (result.errors && result.errors.length > 0) {
                    message += '\n\nErrors:\n' + result.errors.map(e => `- ${e.filename}: ${e.error}`).join('\n');
                }
            }
            
            if (result.failed > 0) {
                alert(message);
            }
            
            // Close modal and refresh documents list
            closeUploadModal();
            await loadDocuments();

            // Refresh credit display after upload
            loadUsageStats();

            // Show bulk processing modal for 10+ documents
            if (result.uploaded >= 10) {
                showBulkProcessingModal(result.uploaded);
            }

            // Trigger debounced polling
            onDocumentUploaded();
        } catch (error) {
            alert('Upload failed: ' + error.message);
            // Reset modal
            document.getElementById('documentUploadForm').style.display = 'block';
            document.getElementById('uploadProgress').style.display = 'none';
        }
    }
}

// Expose document functions to window
window.handleDocumentFileDrop = handleDocumentFileDrop;
window.handleDocumentDragOver = handleDocumentDragOver;
window.handleDocumentDragLeave = handleDocumentDragLeave;
window.handleDocumentFileSelect = handleDocumentFileSelect;
window.clearSelectedFile = clearSelectedFile;
window.handleDocumentUpload = handleDocumentUpload;

// Bulk processing modal functions
function showBulkProcessingModal(count) {
    // Check if user has opted out of seeing this message
    const preference = localStorage.getItem('hideBulkProcessingNotification');
    if (preference === 'true') {
        return;
    }
    
    // Update count in message
    document.getElementById('bulkProcessingCount').textContent = count;
    
    // Show modal
    document.getElementById('bulkProcessingModal').style.display = 'flex';
}

function closeBulkProcessingModal() {
    // Check if user wants to hide this in the future
    const dontShowAgain = document.getElementById('bulkNotificationPreference').checked;
    if (dontShowAgain) {
        localStorage.setItem('hideBulkProcessingNotification', 'true');
    }
    
    // Hide modal
    document.getElementById('bulkProcessingModal').style.display = 'none';
}

window.showBulkProcessingModal = showBulkProcessingModal;
window.closeBulkProcessingModal = closeBulkProcessingModal;
</script>

<!-- Add Papa Parse library (CSV parsing) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<!-- PDF.js library for accurate page count detection -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    // Set worker source for pdf.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<!-- SheetJS library removed - now using server-side JSON processing -->

<!-- Custom Confirm Dialog -->
<div class="confirm-overlay" id="confirmDialog">
    <div class="confirm-modal">
        <div class="confirm-header">
            <div class="confirm-icon"></div>
            <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
        </div>
        <div class="confirm-body">
            <p class="confirm-message" id="confirmMessage"></p>
        </div>
        <div class="confirm-buttons">
            <button class="confirm-btn confirm-btn-cancel" id="confirmCancel">Cancel</button>
            <button class="confirm-btn confirm-btn-confirm" id="confirmOk">Delete</button>
        </div>
    </div>
</div>

<!-- BULK PROCESSING NOTIFICATION MODAL -->
<div class="modal-overlay" id="bulkProcessingModal" style="display: none;">
    <div class="modal" style="max-width: 500px; background: linear-gradient(135deg, #FFFBF7 0%, #FFF9F3 100%); border: 2px solid var(--rust-orange); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
        <div style="text-align: center; margin-bottom: 24px;">
            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #F59E0B 0%, #DC2626 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <path d="M12 2v6m0 4v8m0-16c4.418 0 8 3.582 8 8s-3.582 8-8 8-8-3.582-8-8 3.582-8 8-8z" stroke-linecap="round"/>
                    <circle cx="12" cy="12" r="3" fill="white"/>
                </svg>
            </div>
            <h2 style="margin-bottom: 8px; font-family: 'Merriweather', serif; font-size: 24px; color: var(--oil-navy);">
                Documents Processing
            </h2>
            <div style="display: inline-flex; align-items: center; gap: 8px; background: #FED7AA; color: #92400E; padding: 4px 12px; border-radius: 16px; font-size: 14px; font-weight: 600;">
                <span id="bulkProcessingCount">10</span> documents queued
            </div>
        </div>
        
        <div style="background: linear-gradient(to right, #FFFBEB, #FEF3C7); border: 1px solid #FCD34D; padding: 16px 20px; margin-bottom: 24px; border-radius: 8px;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="flex-shrink: 0; width: 20px; height: 20px; background: #F59E0B; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 12px; font-weight: bold;"></span>
                </div>
                <div>
                    <p style="margin: 0 0 8px 0; font-weight: 600; color: var(--oil-navy);">
                        We'll email you when processing completes
                    </p>
                    <p style="margin: 0; font-size: 14px; color: #92400E; line-height: 1.5;">
                        Processing typically takes a few minutes. You can close this window - we'll send you an email when your documents are ready.
                    </p>
                </div>
            </div>
        </div>
        
        <div style="background: #F0F9FF; border: 1px solid #BAE6FD; padding: 14px 16px; margin-bottom: 20px; border-radius: 6px;">
            <p style="margin: 0; font-size: 14px; color: #075985; line-height: 1.5;">
                <strong style="color: #0369A1;">Pro tip:</strong> Keep this tab open and it will automatically refresh when documents finish processing.
            </p>
        </div>
        
        <div style="display: flex; gap: 8px; align-items: center; margin-top: 24px;">
            <input type="checkbox" id="bulkNotificationPreference" style="margin: 0; cursor: pointer;">
            <label for="bulkNotificationPreference" style="font-size: 14px; color: var(--slate-blue); cursor: pointer; user-select: none;">
                Don't show this notification again
            </label>
        </div>
        
        <div style="display: flex; justify-content: center; margin-top: 28px;">
            <button onclick="closeBulkProcessingModal()" class="btn btn-primary" style="background: linear-gradient(135deg, #F59E0B 0%, #DC2626 100%); border: none; padding: 12px 32px; font-size: 16px; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                Got it, thanks!
            </button>
        </div>
    </div>
</div>

    <script>
// Ensure bulk upload functions are globally accessible
console.log('Dashboard loaded. Checking bulk upload functions...');
console.log('openBulkUploadModal available:', typeof openBulkUploadModal);
console.log('openBulkUploadWellsModal available:', typeof openBulkUploadWellsModal);

// If functions exist but not on window, add them
if (typeof openBulkUploadModal === 'function' && !window.openBulkUploadModal) {
    window.openBulkUploadModal = openBulkUploadModal;
    console.log('Added openBulkUploadModal to window');
}
if (typeof openBulkUploadWellsModal === 'function' && !window.openBulkUploadWellsModal) {
    window.openBulkUploadWellsModal = openBulkUploadWellsModal;
    console.log('Added openBulkUploadWellsModal to window');
}
</script>

</body>
</html>
